name: Deploy to Production (DigitalOcean)

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger from GitHub UI

env:
  NODE_ENV: production
  PROJECT_DIR: /var/apps/NodeAngularFullStack

jobs:
  deploy:
    name: Deploy to DigitalOcean Droplet
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full git history for proper deployment

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci
        continue-on-error: false

      - name: Run TypeScript type checking
        run: npm run typecheck || true
        continue-on-error: true

      - name: Run linting
        run: npm run lint || true
        continue-on-error: true

      - name: Build shared packages
        run: npm run build:shared

      - name: Build frontend applications
        run: |
          npm --workspace=apps/web run build -- --configuration=production
          npm --workspace=apps/form-builder-ui run build -- --configuration=production

      - name: Build backend applications
        run: |
          npm --workspace=apps/dashboard-api run build
          npm --workspace=apps/forms-api run build

      - name: Configure SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          ssh -i ~/.ssh/deploy_key -p ${SSH_PORT:-22} ${SSH_USER}@${SSH_HOST} << 'EOF'
            set -e

            echo "ðŸš€ Starting deployment to DigitalOcean..."

            # Navigate to project directory
            cd ${{ env.PROJECT_DIR }}

            # Pull latest changes from main branch
            echo "ðŸ“¥ Pulling latest code..."
            git fetch origin main
            git reset --hard origin/main

            # Set production environment
            export NODE_ENV=production

            # Run deployment script
            echo "ðŸ”¨ Running deployment script..."
            chmod +x deploy.sh
            ./deploy.sh

            echo "âœ… Deployment completed successfully!"
          EOF

      - name: Verify deployment
        env:
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
          SSH_PORT: ${{ secrets.SSH_PORT }}
        run: |
          ssh -i ~/.ssh/deploy_key -p ${SSH_PORT:-22} ${SSH_USER}@${SSH_HOST} << 'EOF'
            set -e

            echo "ðŸ¥ Running health checks..."

            # Wait for services to stabilize
            sleep 10

            # Check dashboard-api health
            echo "Checking dashboard-api..."
            curl -f http://localhost:3000/health || echo "âš ï¸  Dashboard API health check failed"

            # Check forms-api health
            echo "Checking forms-api..."
            curl -f http://localhost:3001/health || echo "âš ï¸  Forms API health check failed"

            # Check PM2 status
            echo "PM2 Status:"
            pm2 list

            echo "âœ… Health checks completed"
          EOF

      - name: Cleanup SSH key
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

      - name: Notify deployment status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment to production completed successfully!"
          else
            echo "âŒ Deployment failed. Check logs for details."
            exit 1
          fi
