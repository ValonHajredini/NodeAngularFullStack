<div class="theme-management-container">
  <!-- Page Header -->
  <div class="flex justify-content-between align-items-start mb-4">
    <div>
      <h1 class="text-3xl font-bold text-gray-900 mb-2">Theme Management</h1>
      <p class="text-gray-600">
        Manage form themes, export configurations, and import custom designs
      </p>
    </div>
    <div class="flex gap-2">
      <p-button
        icon="pi pi-refresh"
        [outlined]="true"
        (onClick)="refreshThemes()"
        [loading]="isLoading()"
        pTooltip="Refresh themes list"
      ></p-button>
      <p-button label="New Theme" icon="pi pi-plus" (onClick)="createNewTheme()"></p-button>
    </div>
  </div>

  <!-- Filters and Search -->
  <div class="flex gap-3 mb-4">
    <span class="p-input-icon-left flex-1">
      <i class="pi pi-search"></i>
      <input
        pInputText
        type="text"
        placeholder="Search themes..."
        class="w-full"
        [value]="searchQuery()"
        (input)="searchQuery.set($any($event.target).value)"
      />
    </span>
    <p-select
      [options]="typeFilterOptions"
      optionLabel="label"
      optionValue="value"
      placeholder="Filter by type"
      [(ngModel)]="typeFilter"
      class="w-12rem"
    ></p-select>
    <p-button
      icon="pi pi-filter-slash"
      [outlined]="true"
      (onClick)="clearFilters()"
      pTooltip="Clear filters"
    ></p-button>
  </div>

  <!-- Bulk Actions Toolbar -->
  <p-toolbar class="mb-4" *ngIf="hasSelectedThemes()">
    <div class="p-toolbar-group-start">
      <span class="text-sm text-gray-600 mr-3">
        {{ selectedThemesList().length }} theme(s) selected
      </span>
      <p-button
        label="Export Selected"
        icon="pi pi-download"
        severity="secondary"
        (onClick)="showExportSelectedDialog()"
        class="mr-2"
      ></p-button>
      <p-button
        label="Import Themes"
        icon="pi pi-upload"
        severity="secondary"
        (onClick)="showImportThemesDialog()"
        class="mr-2"
      ></p-button>
    </div>
    <div class="p-toolbar-group-end">
      <p-button
        label="Delete Selected"
        icon="pi pi-trash"
        severity="danger"
        [disabled]="selectedCustomThemes().length === 0 || hasInUseThemes()"
        (onClick)="confirmDeleteSelected()"
      ></p-button>
    </div>
  </p-toolbar>

  <!-- Loading State -->
  <div class="flex justify-content-center py-8" *ngIf="isLoading()">
    <p-progressSpinner></p-progressSpinner>
  </div>

  <!-- Themes Data Table -->
  <p-table
    *ngIf="!isLoading()"
    [value]="filteredThemes()"
    [selection]="selectedThemesList()"
    (selectionChange)="selectedThemes.set($event)"
    selectionMode="multiple"
    [paginator]="true"
    [rows]="20"
    [rowsPerPageOptions]="[10, 20, 50]"
    [sortField]="'name'"
    [sortOrder]="1"
    styleClass="p-datatable-gridlines"
  >
    <ng-template pTemplate="header">
      <tr>
        <th style="width: 3rem">
          <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
        </th>
        <th pSortableColumn="name">Theme Name <p-sortIcon field="name"></p-sortIcon></th>
        <th pSortableColumn="isCustom">Type <p-sortIcon field="isCustom"></p-sortIcon></th>
        <th pSortableColumn="formsCount">
          Forms Using <p-sortIcon field="formsCount"></p-sortIcon>
        </th>
        <th pSortableColumn="createdAt">Created <p-sortIcon field="createdAt"></p-sortIcon></th>
        <th style="width: 12rem">Actions</th>
      </tr>
    </ng-template>

    <ng-template pTemplate="body" let-theme>
      <tr>
        <td>
          <p-tableCheckbox [value]="theme"></p-tableCheckbox>
        </td>
        <td>
          <div class="flex align-items-center gap-2">
            <div
              class="theme-color-preview w-2rem h-2rem border-round border-1 border-gray-300"
              [style.background]="getThemePreviewColor(theme)"
            ></div>
            <div>
              <div class="font-semibold">{{ theme.name }}</div>
              <div class="text-sm text-gray-500" *ngIf="theme.description">
                {{ theme.description }}
              </div>
            </div>
          </div>
        </td>
        <td>
          <p-tag
            [value]="theme.isCustom ? 'Custom' : 'Predefined'"
            [severity]="getThemeTypeSeverity(theme.isCustom)"
          ></p-tag>
        </td>
        <td>
          <div class="flex align-items-center gap-2">
            <span class="font-semibold">{{ theme.formsCount }}</span>
            <span class="text-sm text-gray-500">forms</span>
            <p-tag
              value="In Use"
              severity="warning"
              *ngIf="theme.formsCount > 0"
              class="ml-2"
            ></p-tag>
          </div>
        </td>
        <td>
          {{ theme.createdAt | date: 'short' }}
        </td>
        <td>
          <div class="flex gap-1">
            <p-button
              icon="pi pi-eye"
              [outlined]="true"
              size="small"
              (onClick)="previewTheme_handler(theme)"
              pTooltip="Preview theme"
            ></p-button>
            <p-button
              icon="pi pi-pencil"
              [outlined]="true"
              size="small"
              [disabled]="!theme.isCustom"
              (onClick)="editTheme(theme)"
              pTooltip="Edit theme (custom only)"
            ></p-button>
            <p-button
              icon="pi pi-download"
              [outlined]="true"
              size="small"
              (onClick)="exportTheme(theme)"
              pTooltip="Export theme"
            ></p-button>
            <p-button
              icon="pi pi-trash"
              [outlined]="true"
              severity="danger"
              size="small"
              [disabled]="!theme.isCustom || theme.formsCount > 0"
              [loading]="isDeletingTheme(theme.id)"
              pTooltip="Delete theme (custom only, not in use)"
            ></p-button>
          </div>
        </td>
      </tr>
    </ng-template>

    <ng-template pTemplate="emptymessage">
      <tr>
        <td colspan="6" class="text-center py-4">
          <div class="text-gray-500">
            <i class="pi pi-palette text-4xl mb-3"></i>
            <p class="text-lg mb-2">No themes found</p>
            <p class="text-sm">
              {{
                filteredThemes().length === 0 && themes().length > 0
                  ? 'Try adjusting your search or filter criteria'
                  : 'Create your first custom theme to get started'
              }}
            </p>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>

  <!-- Export Dialog -->
  <p-dialog
    header="Export Themes"
    [modal]="true"
    [visible]="showExportDialog()"
    (onHide)="showExportDialog.set(false)"
    [style]="{ width: '500px' }"
  >
    <div class="mb-4">
      <p>Export {{ selectedThemesList().length }} selected theme(s) as JSON file:</p>
      <ul class="list-none p-0 mt-3">
        <li *ngFor="let theme of selectedThemesList()" class="flex align-items-center gap-2 py-1">
          <div
            class="w-1rem h-1rem border-round"
            [style.background]="getThemePreviewColor(theme)"
          ></div>
          {{ theme.name }}
          <p-tag
            [value]="theme.isCustom ? 'Custom' : 'Predefined'"
            [severity]="getThemeTypeSeverity(theme.isCustom)"
            class="ml-auto"
          ></p-tag>
        </li>
      </ul>
    </div>

    <ng-template pTemplate="footer">
      <p-button
        label="Cancel"
        icon="pi pi-times"
        [outlined]="true"
        (onClick)="showExportDialog.set(false)"
        [disabled]="exportInProgress()"
      ></p-button>
      <p-button
        label="Export"
        icon="pi pi-download"
        (onClick)="exportSelectedThemes()"
        [loading]="exportInProgress()"
      ></p-button>
    </ng-template>
  </p-dialog>

  <!-- Import Dialog -->
  <p-dialog
    header="Import Themes"
    [modal]="true"
    [visible]="showImportDialog()"
    (onHide)="showImportDialog.set(false)"
    [style]="{ width: '600px' }"
  >
    <div class="mb-4">
      <p class="mb-3">Import themes from JSON files:</p>

      <p-fileUpload
        #fileUpload
        mode="basic"
        accept=".json"
        [multiple]="true"
        [auto]="false"
        chooseLabel="Select Files"
        class="mb-3"
        (onSelect)="onImportFilesSelect($event)"
      ></p-fileUpload>

      <div *ngIf="importFiles().length > 0" class="mt-3">
        <p class="text-sm text-gray-600 mb-2">Selected files:</p>
        <ul class="list-none p-0">
          <li *ngFor="let file of importFiles()" class="flex align-items-center gap-2 py-1">
            <i class="pi pi-file text-blue-500"></i>
            {{ file.name }}
            <span class="text-sm text-gray-500">({{ (file.size / 1024).toFixed(1) }} KB)</span>
          </li>
        </ul>
      </div>

      <div class="bg-blue-50 border-round p-3 mt-4">
        <p class="text-sm text-blue-800 mb-2">
          <i class="pi pi-info-circle mr-2"></i>
          Import Requirements:
        </p>
        <ul class="text-sm text-blue-700 list-disc list-inside ml-4">
          <li>JSON files exported from theme management</li>
          <li>Valid theme definition structure</li>
          <li>Theme names must be unique</li>
          <li>Maximum 50KB per file</li>
        </ul>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <p-button
        label="Cancel"
        icon="pi pi-times"
        [outlined]="true"
        (onClick)="showImportDialog.set(false)"
        [disabled]="importInProgress()"
      ></p-button>
      <p-button
        label="Import"
        icon="pi pi-upload"
        [disabled]="importFiles().length === 0"
        (onClick)="importThemes()"
        [loading]="importInProgress()"
      ></p-button>
    </ng-template>
  </p-dialog>

  <!-- Theme Preview Dialog -->
  <p-dialog
    header="Theme Preview"
    [modal]="true"
    [visible]="showPreviewDialog()"
    (onHide)="closePreviewDialog()"
    [style]="{ width: '800px', height: '600px' }"
    [maximizable]="true"
  >
    <div *ngIf="previewTheme()" class="theme-preview-content">
      <div class="mb-4">
        <h3 class="text-xl font-semibold mb-2">{{ previewTheme()?.name }}</h3>
        <p class="text-gray-600" *ngIf="previewTheme()?.description">
          {{ previewTheme()?.description }}
        </p>
      </div>

      <!-- Theme Properties Preview -->
      <div class="grid">
        <div class="col-12 md:col-6">
          <h4 class="text-lg font-medium mb-3">Colors</h4>
          <div class="grid gap-3">
            <div class="col-6">
              <label class="text-sm text-gray-600">Primary</label>
              <div class="flex align-items-center gap-2 mt-1">
                <div
                  class="w-3rem h-2rem border-round border-1 border-gray-300"
                  [style.background]="previewTheme()?.themeDefinition?.primaryColor"
                ></div>
                <span class="text-sm font-mono">{{
                  previewTheme()?.themeDefinition?.primaryColor
                }}</span>
              </div>
            </div>
            <div class="col-6">
              <label class="text-sm text-gray-600">Secondary</label>
              <div class="flex align-items-center gap-2 mt-1">
                <div
                  class="w-3rem h-2rem border-round border-1 border-gray-300"
                  [style.background]="previewTheme()?.themeDefinition?.secondaryColor"
                ></div>
                <span class="text-sm font-mono">{{
                  previewTheme()?.themeDefinition?.secondaryColor
                }}</span>
              </div>
            </div>
          </div>
        </div>

        <div class="col-12 md:col-6">
          <h4 class="text-lg font-medium mb-3">Typography</h4>
          <div class="text-sm">
            <p>
              <strong>Font:</strong> {{ previewTheme()?.themeDefinition?.fontFamily || 'Default' }}
            </p>
            <p>
              <strong>Size:</strong> {{ previewTheme()?.themeDefinition?.fontSize || 'Default' }}
            </p>
          </div>
        </div>
      </div>

      <!-- Sample Form Preview -->
      <div class="mt-4">
        <h4 class="text-lg font-medium mb-3">Form Preview</h4>
        <div class="border-1 border-gray-300 border-round p-4 bg-white">
          <form class="space-y-4">
            <div>
              <label class="block text-sm font-medium mb-1">Sample Text Input</label>
              <input
                type="text"
                class="w-full p-2 border-1 border-gray-300 border-round"
                placeholder="Enter text here..."
                readonly
              />
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Sample Email Input</label>
              <input
                type="email"
                class="w-full p-2 border-1 border-gray-300 border-round"
                placeholder="email@example.com"
                readonly
              />
            </div>
            <div>
              <button
                type="button"
                class="px-4 py-2 border-round font-medium"
                [style.background]="previewTheme()?.themeDefinition?.primaryColor"
                [style.color]="'white'"
              >
                Sample Button
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <p-button
        label="Close"
        icon="pi pi-times"
        [outlined]="true"
        (onClick)="closePreviewDialog()"
      ></p-button>
    </ng-template>
  </p-dialog>
</div>

<!-- Toast Messages -->
<p-toast></p-toast>

<!-- Confirmation Dialog -->
<p-confirmDialog></p-confirmDialog>
