<div class="step-form-sidebar p-4 flex flex-col gap-4">
  <!-- Confirmation Dialog -->
  <p-confirmDialog></p-confirmDialog>

  <!-- Header Section -->
  <div class="sidebar-header">
    <h3 class="text-lg font-semibold text-gray-800 mb-2">Step Form Configuration</h3>
    <p class="text-sm text-gray-600 mb-4">
      Create multi-step forms with custom step titles and descriptions.
      @if (rowLayoutEnabled()) {
        <span class="text-xs text-blue-600 block mt-1">
          Row layout is enabled. Rows are grouped by steps below.
        </span>
      }
    </p>
  </div>

  <!-- Toggle Step Form Mode -->
  <div class="toggle-section border-b border-gray-200 pb-4">
    <div class="flex items-center justify-between">
      <label class="font-medium text-gray-700">Enable Step Form</label>
      <p-toggleButton
        [(ngModel)]="stepFormToggleValue"
        (onChange)="onToggleStepForm($event)"
        onLabel="ON"
        offLabel="OFF"
        [style]="{ width: '80px' }"
      />
    </div>
    <p class="text-xs text-gray-500 mt-2">
      Convert your form into a multi-step wizard with progress indicators.
    </p>
  </div>

  <!-- Step List Section (shown only when enabled) -->
  @if (stepFormEnabled()) {
    <div class="steps-section flex-1 flex flex-col gap-3">
      <div class="flex items-center justify-between mb-2">
        <h4 class="font-medium text-gray-700">Steps: {{ steps().length }}</h4>
        <p-button
          label="Add Step"
          icon="pi pi-plus"
          [disabled]="!canAddStep()"
          (onClick)="onAddStep()"
          size="small"
          [pTooltip]="addStepTooltip()"
          tooltipPosition="left"
        />
      </div>

      <!-- Draggable Step List -->
      <div
        cdkDropList
        (cdkDropListDropped)="onStepDrop($event)"
        class="step-list flex flex-col gap-2"
      >
        @for (step of steps(); track step.id) {
          <div
            cdkDrag
            class="step-group-container border border-gray-300 rounded-md bg-white hover:border-primary-500 transition-colors"
          >
            <!-- Step Header -->
            <div class="step-item-header p-3 flex items-center gap-3">
              <!-- Drag Handle -->
              <div cdkDragHandle class="drag-handle cursor-move" aria-label="Drag to reorder">
                <i class="pi pi-bars text-gray-400 hover:text-gray-600"></i>
              </div>

              <!-- Expand/Collapse Icon (only shown when row layout enabled) -->
              @if (rowLayoutEnabled()) {
                <button
                  type="button"
                  class="expand-button p-1 rounded hover:bg-gray-100 transition-colors"
                  (click)="toggleStepExpansion(step.id)"
                  [attr.aria-label]="isStepExpanded(step.id) ? 'Collapse' : 'Expand'"
                >
                  <i
                    class="pi text-gray-600 text-sm"
                    [class.pi-chevron-down]="isStepExpanded(step.id)"
                    [class.pi-chevron-right]="!isStepExpanded(step.id)"
                  ></i>
                </button>
              }

              <!-- Step Badge -->
              <div
                class="step-badge flex-shrink-0 w-6 h-6 rounded-full bg-primary-500 text-white text-xs font-semibold flex items-center justify-center"
              >
                {{ step.order + 1 }}
              </div>

              <!-- Step Info -->
              <div
                class="step-info flex-1 min-w-0 cursor-pointer"
                (click)="onSetActiveStep(step.id)"
              >
                <div class="step-title font-medium text-gray-800 truncate">
                  {{ step.title }}
                </div>
                <div class="step-meta flex items-center gap-2 mt-1">
                  @if (step.description) {
                    <span class="step-description text-xs text-gray-500 truncate">
                      {{ step.description }}
                    </span>
                  }
                  @if (rowLayoutEnabled() && getRowCountForStep(step.id) > 0) {
                    <span
                      class="row-count-badge text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full"
                    >
                      {{ getRowCountForStep(step.id) }}
                      {{ getRowCountForStep(step.id) === 1 ? 'row' : 'rows' }}
                    </span>
                  }
                </div>
              </div>

              <!-- Actions -->
              <div class="step-actions flex items-center gap-2">
                <!-- Add Row Button (only when row layout enabled) -->
                @if (rowLayoutEnabled()) {
                  <button
                    type="button"
                    class="icon-button p-1 rounded hover:bg-green-50 transition-colors"
                    (click)="onAddRowToStep(step.id)"
                    aria-label="Add row to step"
                    pTooltip="Add row to this step"
                    tooltipPosition="top"
                  >
                    <i class="pi pi-plus text-green-600 text-sm"></i>
                  </button>
                }
                <button
                  type="button"
                  class="icon-button p-1 rounded hover:bg-gray-100 transition-colors"
                  (click)="onEditStep(step)"
                  aria-label="Edit step"
                  pTooltip="Edit step"
                  tooltipPosition="top"
                >
                  <i class="pi pi-pencil text-gray-600 text-sm"></i>
                </button>
                <button
                  type="button"
                  class="icon-button p-1 rounded hover:bg-red-50 transition-colors"
                  (click)="onDeleteStep(step)"
                  [disabled]="!canDeleteStep()"
                  aria-label="Delete step"
                  [pTooltip]="deleteStepTooltip()"
                  tooltipPosition="top"
                >
                  <i
                    class="pi pi-trash text-sm"
                    [class.text-red-600]="canDeleteStep()"
                    [class.text-gray-300]="!canDeleteStep()"
                  ></i>
                </button>
              </div>
            </div>

            <!-- Rows Section (shown when row layout enabled and step expanded) -->
            @if (rowLayoutEnabled() && isStepExpanded(step.id)) {
              <div class="step-rows-section border-t border-gray-200 bg-gray-50">
                @if (getRowsForStep(step.id).length > 0) {
                  <!-- Rows List -->
                  <div
                    class="rows-list p-3 space-y-2"
                    [class.scrollable]="getRowsForStep(step.id).length > 4"
                  >
                    @for (row of getRowsForStep(step.id); track row.rowId) {
                      <div
                        class="row-item bg-white border border-gray-200 rounded p-2 flex items-center gap-2"
                      >
                        <!-- Row Label -->
                        <div class="row-label flex-1 text-sm text-gray-700">
                          <span class="font-medium">Row {{ row.order + 1 }}</span>
                          <span class="text-gray-500 ml-2 columns-text">
                            {{ row.columnCount }}
                            {{ row.columnCount === 1 ? 'column' : 'columns' }}
                          </span>
                        </div>

                        <!-- Column Count Selector -->
                        <div class="column-selector flex gap-1">
                          @for (count of [1, 2, 3, 4]; track count) {
                            <button
                              type="button"
                              class="column-btn w-6 h-6 text-xs rounded transition-colors"
                              [class.bg-primary-500]="row.columnCount === count"
                              [class.text-white]="row.columnCount === count"
                              [class.bg-gray-200]="row.columnCount !== count"
                              [class.text-gray-600]="row.columnCount !== count"
                              [class.hover:bg-primary-400]="row.columnCount === count"
                              [class.hover:bg-gray-300]="row.columnCount !== count"
                              (click)="onUpdateRowColumns(row.rowId, $any(count))"
                              [attr.aria-label]="count + ' columns'"
                            >
                              {{ count }}
                            </button>
                          }
                        </div>

                        <!-- Delete Row Button -->
                        <button
                          type="button"
                          class="delete-row-btn p-1 rounded hover:bg-red-50 transition-colors"
                          (click)="onRemoveRowFromStep(row.rowId)"
                          aria-label="Remove row"
                          pTooltip="Remove row"
                          tooltipPosition="left"
                        >
                          <i class="pi pi-trash text-red-500 text-xs"></i>
                        </button>
                      </div>

                      <!-- Column Widths Section (appears when columnCount >= 2) -->
                      @if (row.columnCount >= 2) {
                        <div class="column-widths-section mt-3 pt-3 border-t border-gray-100 px-2">
                          <label
                            for="width-ratio-{{ row.rowId }}"
                            class="text-xs font-semibold text-gray-700 mb-2 block"
                          >
                            Width Ratio
                          </label>
                          <p-select
                            id="width-ratio-{{ row.rowId }}"
                            [options]="getWidthRatioOptions(row.columnCount)"
                            [(ngModel)]="selectedWidthRatios()[row.rowId]"
                            (onChange)="onWidthRatioChange(row.rowId, $event)"
                            placeholder="Select width ratio"
                            optionLabel="label"
                            optionValue="value"
                            [style]="{ width: '100%' }"
                            [styleClass]="'text-sm'"
                          />

                          @if (selectedWidthRatios()[row.rowId] === 'custom') {
                            <div class="mt-3">
                              <label
                                for="custom-widths-{{ row.rowId }}"
                                class="text-xs font-semibold text-gray-700 mb-2 block"
                              >
                                Custom Widths
                              </label>
                              <input
                                id="custom-widths-{{ row.rowId }}"
                                type="text"
                                pInputText
                                [(ngModel)]="customWidthInputs()[row.rowId]"
                                (ngModelChange)="onCustomWidthsChange(row.rowId, $event)"
                                [placeholder]="getCustomWidthsPlaceholder(row.columnCount)"
                                class="w-full text-sm"
                              />

                              @if (widthValidationErrors()[row.rowId]) {
                                <p-message
                                  severity="error"
                                  [text]="widthValidationErrors()[row.rowId]"
                                  [styleClass]="'mt-2 text-xs'"
                                />
                              }
                            </div>
                          }
                        </div>
                      }

                      <!-- Sub-Columns Section (appears when columnCount > 0) -->
                      @if (row.columnCount > 0) {
                        <div class="sub-columns-section mt-3 pt-3 border-t border-gray-100 px-2">
                          <h4
                            class="text-xs font-semibold text-gray-700 uppercase tracking-wide mb-3"
                          >
                            Sub-Columns
                          </h4>

                          <p-accordion [multiple]="true" [styleClass]="'text-sm'">
                            @for (
                              columnIndex of getColumnIndices(row.columnCount);
                              track columnIndex
                            ) {
                              <p-accordion-panel [value]="columnIndex">
                                <p-accordion-header>
                                  <div class="column-header flex items-center gap-2">
                                    <span class="text-sm font-medium"
                                      >Column {{ columnIndex + 1 }}</span
                                    >
                                    @if (hasSubColumns(row.rowId, columnIndex)) {
                                      <i class="pi pi-th text-primary text-xs"></i>
                                      <span
                                        class="badge bg-primary-500 text-white px-2 py-0.5 rounded-full text-xs"
                                      >
                                        {{ getSubColumnCount(row.rowId, columnIndex) }}
                                      </span>
                                    }
                                  </div>
                                </p-accordion-header>

                                <p-accordion-content>
                                  <!-- Enable Sub-Columns Toggle -->
                                  <div
                                    class="toggle-container flex items-center justify-between mb-4"
                                  >
                                    <label
                                      for="sub-columns-toggle-{{ row.rowId }}-{{ columnIndex }}"
                                      class="text-xs font-medium text-gray-700"
                                    >
                                      Enable Sub-Columns
                                    </label>
                                    <p-toggleButton
                                      id="sub-columns-toggle-{{ row.rowId }}-{{ columnIndex }}"
                                      [(ngModel)]="
                                        subColumnToggles()[row.rowId + '-' + columnIndex]
                                      "
                                      (onChange)="
                                        onToggleSubColumns(
                                          row.rowId,
                                          columnIndex,
                                          $event.checked ?? false
                                        )
                                      "
                                      onLabel="Enabled"
                                      offLabel="Disabled"
                                      [onIcon]="'pi pi-check'"
                                      [offIcon]="'pi pi-times'"
                                      [attr.aria-label]="
                                        'Enable or disable sub-columns for column ' +
                                        (columnIndex + 1)
                                      "
                                      [styleClass]="'text-sm'"
                                    />
                                  </div>

                                  <!-- Sub-column Configuration (appears when enabled) -->
                                  @if (hasSubColumns(row.rowId, columnIndex)) {
                                    <div class="sub-column-config space-y-3">
                                      <!-- Sub-Column Count Dropdown -->
                                      <div>
                                        <label
                                          for="sub-column-count-{{ row.rowId }}-{{ columnIndex }}"
                                          class="text-xs font-semibold text-gray-700 mb-2 block"
                                        >
                                          Number of Sub-Columns
                                        </label>
                                        <p-select
                                          id="sub-column-count-{{ row.rowId }}-{{ columnIndex }}"
                                          [options]="subColumnCountOptions"
                                          [(ngModel)]="
                                            subColumnCounts()[row.rowId + '-' + columnIndex]
                                          "
                                          (onChange)="
                                            onSubColumnCountChange(
                                              row.rowId,
                                              columnIndex,
                                              $event.value
                                            )
                                          "
                                          placeholder="Select count"
                                          optionLabel="label"
                                          optionValue="value"
                                          [style]="{ width: '100%' }"
                                          [styleClass]="'text-sm'"
                                        />
                                      </div>

                                      <!-- Sub-Column Width Ratio Dropdown -->
                                      <div>
                                        <label
                                          for="sub-column-width-{{ row.rowId }}-{{ columnIndex }}"
                                          class="text-xs font-semibold text-gray-700 mb-2 block"
                                        >
                                          Sub-Column Width Ratio
                                        </label>
                                        <p-select
                                          id="sub-column-width-{{ row.rowId }}-{{ columnIndex }}"
                                          [options]="
                                            getSubColumnWidthOptions(
                                              getSubColumnCount(row.rowId, columnIndex) || 2
                                            )
                                          "
                                          [(ngModel)]="
                                            subColumnWidthRatios()[row.rowId + '-' + columnIndex]
                                          "
                                          (onChange)="
                                            onSubColumnWidthRatioChange(
                                              row.rowId,
                                              columnIndex,
                                              $event.value
                                            )
                                          "
                                          placeholder="Select ratio"
                                          optionLabel="label"
                                          optionValue="value"
                                          [style]="{ width: '100%' }"
                                          [styleClass]="'text-sm'"
                                        />
                                      </div>

                                      <!-- Custom Sub-Column Width Input (appears when 'custom' selected) -->
                                      @if (
                                        subColumnWidthRatios()[row.rowId + '-' + columnIndex] ===
                                        'custom'
                                      ) {
                                        <div>
                                          <label
                                            for="custom-sub-widths-{{ row.rowId }}-{{
                                              columnIndex
                                            }}"
                                            class="text-xs font-semibold text-gray-700 mb-2 block"
                                          >
                                            Custom Widths
                                          </label>
                                          <input
                                            id="custom-sub-widths-{{ row.rowId }}-{{ columnIndex }}"
                                            type="text"
                                            pInputText
                                            [(ngModel)]="
                                              customSubColumnWidthInputs()[
                                                row.rowId + '-' + columnIndex
                                              ]
                                            "
                                            (ngModelChange)="
                                              onCustomSubWidthsChange(
                                                row.rowId,
                                                columnIndex,
                                                $event
                                              )
                                            "
                                            [placeholder]="
                                              getSubColumnWidthPlaceholder(
                                                getSubColumnCount(row.rowId, columnIndex) || 2
                                              )
                                            "
                                            class="w-full text-sm"
                                          />

                                          @if (
                                            subColumnWidthValidationErrors()[
                                              row.rowId + '-' + columnIndex
                                            ]
                                          ) {
                                            <p-message
                                              severity="error"
                                              [text]="
                                                subColumnWidthValidationErrors()[
                                                  row.rowId + '-' + columnIndex
                                                ]
                                              "
                                              [styleClass]="'mt-2 text-xs'"
                                            />
                                          }
                                        </div>
                                      }
                                    </div>
                                  }
                                </p-accordion-content>
                              </p-accordion-panel>
                            }
                          </p-accordion>
                        </div>
                      }
                    }
                  </div>

                  <!-- Add Row Button -->
                  <div class="add-row-section px-3 pb-3">
                    <button
                      type="button"
                      class="add-row-btn w-full py-2 px-3 text-xs bg-white border border-dashed border-gray-300 rounded hover:border-primary-500 hover:bg-primary-50 transition-colors text-gray-600 hover:text-primary-600"
                      (click)="onAddRowToStep(step.id)"
                    >
                      <i class="pi pi-plus text-xs mr-1"></i>
                      Add Row to {{ step.title }}
                    </button>
                  </div>
                } @else {
                  <!-- Empty State -->
                  <div class="empty-state p-4 text-center">
                    <i class="pi pi-inbox text-gray-300 text-2xl mb-2 block"></i>
                    <p class="text-xs text-gray-500 mb-3">No rows in this step yet</p>
                    <button
                      type="button"
                      class="add-first-row-btn py-1.5 px-3 text-xs bg-primary-500 text-white rounded hover:bg-primary-600 transition-colors"
                      (click)="onAddRowToStep(step.id)"
                    >
                      <i class="pi pi-plus text-xs mr-1"></i>
                      Add First Row
                    </button>
                  </div>
                }
              </div>
            }
          </div>
        }
      </div>

      <!-- Empty State -->
      @if (steps().length === 0) {
        <div class="empty-state text-center py-8 text-gray-500">
          <i class="pi pi-inbox text-4xl mb-2"></i>
          <p class="text-sm">No steps yet. Enable step form to get started.</p>
        </div>
      }
    </div>
  }

  <!-- Enable Step Form Confirmation Dialog -->
  <p-dialog
    [(visible)]="showEnableDialog"
    header="Enable Step Form?"
    [modal]="true"
    [style]="{ width: '450px' }"
    [draggable]="false"
    [resizable]="false"
  >
    <ng-template pTemplate="content">
      <div class="dialog-content">
        <p class="text-gray-700 mb-3">
          This will convert your form to step mode. All existing fields will be moved to
          <strong>Step 1</strong>. You can move them to other steps later.
        </p>
        <div class="bg-blue-50 border border-blue-200 rounded p-3 text-sm text-blue-800">
          <i class="pi pi-info-circle mr-2"></i>
          You can add up to 10 steps and reorder them via drag-and-drop.
        </div>
      </div>
    </ng-template>
    <ng-template pTemplate="footer">
      <p-button
        label="Cancel"
        icon="pi pi-times"
        (onClick)="cancelEnableStepForm()"
        [text]="true"
      />
      <p-button label="Enable" icon="pi pi-check" (onClick)="confirmEnableStepForm()" />
    </ng-template>
  </p-dialog>

  <!-- Disable Step Form Confirmation Dialog -->
  <p-dialog
    [(visible)]="showDisableDialog"
    header="Disable Step Form?"
    [modal]="true"
    [style]="{ width: '450px' }"
    [draggable]="false"
    [resizable]="false"
  >
    <ng-template pTemplate="content">
      <div class="dialog-content">
        <p class="text-gray-700 mb-3">
          This will convert your form back to single-page mode. All fields will remain, but step
          assignments will be removed.
        </p>
        <div class="bg-amber-50 border border-amber-200 rounded p-3 text-sm text-amber-800">
          <i class="pi pi-exclamation-triangle mr-2"></i>
          This action will remove all step configuration.
        </div>
      </div>
    </ng-template>
    <ng-template pTemplate="footer">
      <p-button
        label="Cancel"
        icon="pi pi-times"
        (onClick)="cancelDisableStepForm()"
        [text]="true"
      />
      <p-button
        label="Disable"
        icon="pi pi-check"
        (onClick)="confirmDisableStepForm()"
        severity="warn"
      />
    </ng-template>
  </p-dialog>

  <!-- Edit Step Dialog -->
  <p-dialog
    [(visible)]="showEditDialog"
    header="Edit Step"
    [modal]="true"
    [style]="{ width: '500px' }"
    [draggable]="false"
    [resizable]="false"
  >
    <ng-template pTemplate="content">
      <form [formGroup]="stepForm" class="flex flex-col gap-4">
        <!-- Step Title -->
        <div class="form-field">
          <label for="step-title" class="block font-medium text-gray-700 mb-2">
            Step Title <span class="text-red-500">*</span>
          </label>
          <input
            id="step-title"
            type="text"
            pInputText
            formControlName="title"
            class="w-full"
            placeholder="Enter step title"
            maxlength="100"
          />
          @if (
            stepForm.get('title')?.invalid &&
            (stepForm.get('title')?.dirty || stepForm.get('title')?.touched)
          ) {
            <small class="p-error block mt-1"> Title is required (1-100 characters) </small>
          }
          <small class="text-gray-500 block mt-1">
            {{ stepForm.value.title?.length || 0 }}/100 characters
          </small>
        </div>

        <!-- Step Description -->
        <div class="form-field">
          <label for="step-description" class="block font-medium text-gray-700 mb-2">
            Step Description (Optional)
          </label>
          <textarea
            id="step-description"
            pInputTextarea
            formControlName="description"
            class="w-full"
            placeholder="Add a description for this step"
            rows="3"
            maxlength="500"
          ></textarea>
          @if (
            stepForm.get('description')?.invalid &&
            (stepForm.get('description')?.dirty || stepForm.get('description')?.touched)
          ) {
            <small class="p-error block mt-1"> Description must not exceed 500 characters </small>
          }
          <small class="text-gray-500 block mt-1">
            {{ stepForm.value.description?.length || 0 }}/500 characters
          </small>
        </div>
      </form>
    </ng-template>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" icon="pi pi-times" (onClick)="onCancelEdit()" [text]="true" />
      <p-button
        label="Save"
        icon="pi pi-check"
        (onClick)="onSaveStep()"
        [disabled]="stepForm.invalid"
      />
    </ng-template>
  </p-dialog>

  <!-- Delete Step Confirmation Dialog -->
  <p-dialog
    [(visible)]="showDeleteDialog"
    header="Delete Step"
    [modal]="true"
    [style]="{ width: '450px' }"
    [draggable]="false"
    [resizable]="false"
  >
    <ng-template pTemplate="content">
      <div class="dialog-content">
        <p class="text-gray-700 mb-3">
          Are you sure you want to delete
          <strong>{{ deletingStep()?.title }}</strong
          >?
        </p>
        <div class="bg-red-50 border border-red-200 rounded p-3 text-sm text-red-800">
          <i class="pi pi-exclamation-triangle mr-2"></i>
          Fields in this step will be moved to the first step. This action cannot be undone.
        </div>
      </div>
    </ng-template>
    <ng-template pTemplate="footer">
      <p-button label="Cancel" icon="pi pi-times" (onClick)="cancelDeleteStep()" [text]="true" />
      <p-button
        label="Delete"
        icon="pi pi-trash"
        (onClick)="confirmDeleteStep()"
        severity="danger"
      />
    </ng-template>
  </p-dialog>
</div>
