# Story 23.1: Rollback Epic 21 & 22 Changes

## Status

In Progress

## Story

**As a** developer, **I want** to cleanly rollback Epic 21 & 22 implementations, **so that** we have
a clean foundation for correct implementation.

## Acceptance Criteria

1. Remove all Epic 22 admin theme designer files (components, routes, services)
2. Revert Epic 21 template changes to form-canvas and form-renderer
3. Clean `theme-variables.css` (remove incomplete classes, keep structure)
4. Remove admin theme routes from navigation
5. Verify Epic 20 functionality still works (theme dropdown, API endpoints)
6. Document rollback in git commit with clear message

## Tasks / Subtasks

- [x] Task 1: Remove Epic 22 Admin Theme Designer Files (AC: 1, 4)
  - [x] Delete `apps/web/src/app/features/admin/pages/theme-designer/` directory
  - [x] Delete `apps/web/src/app/features/admin/pages/theme-management/` directory
  - [x] Delete `apps/web/src/app/features/admin/components/theme-preview/` directory
  - [x] Delete `apps/web/src/app/features/admin/components/theme-export-dialog/` directory
  - [x] Delete `apps/web/src/app/features/admin/components/theme-import-dialog/` directory
  - [x] Delete `apps/web/src/app/features/admin/services/theme-designer.service.ts`
  - [x] Delete `apps/api/src/routes/admin-themes.routes.ts`
  - [x] Delete `apps/api/src/controllers/admin-themes.controller.ts`
  - [x] Remove admin theme routes from `apps/web/src/app/features/admin/admin.routes.ts`
  - [x] Remove admin theme navigation from
        `apps/web/src/app/layouts/main-layout/navigation.service.ts`

- [x] Task 2: Revert Epic 21 Template Changes (AC: 2)
  - [x] Checkout
        `apps/web/src/app/features/tools/components/form-builder/form-canvas/form-canvas.component.ts`
        from main branch baseline (before Epic 21 changes)
  - [x] Checkout `apps/web/src/app/features/public/form-renderer/form-renderer.component.html` from
        main branch baseline (before Epic 21 changes)
  - [x] Verify reverted templates compile without errors

- [x] Task 3: Clean `theme-variables.css` (AC: 3)
  - [x] Review `apps/web/src/styles/theme-variables.css` for incomplete utility classes
  - [x] Remove partial utility classes (keep CSS variable definitions from Epic 20)
  - [x] Keep Epic 20 theme variable structure intact (`:root` CSS variables)
  - [x] Document what was removed in code comments

- [x] Task 4: Verify Epic 20 Functionality (AC: 5)
  - [x] Start development environment (`npm start`)
  - [x] Navigate to Form Builder and verify theme dropdown displays 9 seeded themes
  - [x] Select a theme from dropdown and verify form preview shows theme applied (even if
        incomplete)
  - [x] Test API endpoint `GET /api/themes` returns all themes
  - [x] Verify existing forms with themes continue rendering (degraded but functional)

- [ ] Task 5: Git Commit with Clear Documentation (AC: 6)
  - [ ] Stage all deleted and modified files
  - [ ] Create commit message: "Rollback Epic 21 & 22 - Clean foundation for Epic 23 theme system"
  - [ ] Include commit body with: files removed, files reverted, reason for rollback

- [ ] Task 6: Run Full Test Suite to Verify No Breaking Changes
  - [ ] Run backend tests: `npm --workspace=apps/api run test`
  - [ ] Run frontend tests: `npm --workspace=apps/web run test`
  - [ ] Run linters: `npm run lint`
  - [ ] Fix any test failures related to removed files

## Dev Notes

### Previous Story Insights

**From Story 22.5 (CANCELLED):**

- Epic 21/22 implementation was incomplete and flawed
- Theme rendering only applied to inputs/buttons, not backgrounds/containers
- Admin-only theme designer was wrong access pattern (should be Form Builder modal)
- Security vulnerabilities found in theme import validation (CSS sanitization missing)
- E2E tests were failing due to incomplete implementation

**Key Lesson:** Epic 23 provides comprehensive fix by rolling back flawed work and rebuilding
correctly with:

- All users can create themes (not admin-only)
- Theme creation via Form Builder modal (not separate admin panel)
- Complete theme utility classes covering all elements
- Tailwind CSS conflicts resolved

### File Locations

**Files to Delete (Epic 22):** [Source: docs/prd/epic-23-complete-theme-system.md#rollback-strategy]

```
apps/web/src/app/features/admin/pages/theme-designer/*
apps/web/src/app/features/admin/pages/theme-management/*
apps/web/src/app/features/admin/components/theme-preview/*
apps/web/src/app/features/admin/components/theme-export-dialog/*
apps/web/src/app/features/admin/components/theme-import-dialog/*
apps/web/src/app/features/admin/services/theme-designer.service.ts
apps/api/src/routes/admin-themes.routes.ts
apps/api/src/controllers/admin-themes.controller.ts
```

**Files to Revert (Epic 21):** [Source: docs/prd/epic-23-complete-theme-system.md#rollback-strategy]

```
apps/web/src/app/features/tools/components/form-builder/form-canvas/form-canvas.component.ts
apps/web/src/app/features/public/form-renderer/form-renderer.component.html
```

**Files to Clean:**

```
apps/web/src/styles/theme-variables.css
```

**Files to Modify (Remove Routes):** [Source: docs/architecture/unified-project-structure.md]

```
apps/web/src/app/features/admin/admin.routes.ts
apps/web/src/app/layouts/main-layout/navigation.service.ts
```

### Git Operations

**Baseline Branch:** `main` (or `origin/main` if local main is outdated)

**Git Commands for Revert:**

```bash
# Revert specific files to main branch state
git checkout origin/main -- apps/web/src/app/features/tools/components/form-builder/form-canvas/form-canvas.component.ts
git checkout origin/main -- apps/web/src/app/features/public/form-renderer/form-renderer.component.html

# Delete Epic 22 directories
rm -rf apps/web/src/app/features/admin/pages/theme-designer
rm -rf apps/web/src/app/features/admin/pages/theme-management
rm -rf apps/web/src/app/features/admin/components/theme-preview
rm -rf apps/web/src/app/features/admin/components/theme-export-dialog
rm -rf apps/web/src/app/features/admin/components/theme-import-dialog

# Delete Epic 22 individual files
rm apps/web/src/app/features/admin/services/theme-designer.service.ts
rm apps/api/src/routes/admin-themes.routes.ts
rm apps/api/src/controllers/admin-themes.controller.ts
```

### Epic 20 Functionality Verification

**What Must Still Work After Rollback:** [Source:
docs/prd/epic-23-complete-theme-system.md#what-gets-kept-epic-20]

1. ✅ Database schema (`form_themes` table) - No changes
2. ✅ API endpoints `/api/themes/*` - Structure intact
3. ✅ `ThemePreviewService` (CSS variable injection) - Keep unchanged
4. ✅ Theme dropdown component (`theme-dropdown.component.ts`) - Keep unchanged
5. ✅ 9 seeded themes in database - No changes
6. ✅ `FormSettings.themeId` property - No changes

**API Endpoints to Test:**

```
GET /api/themes - Returns all themes (9 seeded themes)
GET /api/themes/:id - Returns specific theme by ID
POST /api/themes - Creates new theme (currently admin-only, will be fixed in Story 23.2)
```

### Project Structure

**Admin Routes Pattern:** [Source: docs/architecture/frontend-architecture.md#routing-architecture]

Angular uses lazy-loaded feature routes. Admin routes defined in:

```typescript
// apps/web/src/app/features/admin/admin.routes.ts
export const ADMIN_ROUTES: Routes = [
  // Remove theme-designer and theme-management routes
];
```

**Navigation Service Pattern:** [Source:
docs/architecture/frontend-architecture.md#component-organization]

Navigation items defined in `apps/web/src/app/layouts/main-layout/navigation.service.ts`. Remove any
admin theme management menu items added by Epic 22.

### Testing

**Testing Standards:** [Source: docs/architecture/testing-strategy.md]

**Backend Tests:**

- Location: `apps/api/tests/unit/` and `apps/api/tests/integration/`
- Framework: Jest + Supertest
- Run: `npm --workspace=apps/api run test`

**Frontend Tests:**

- Location: Colocated `*.spec.ts` files
- Framework: Karma + Jasmine
- Run: `npm --workspace=apps/web run test`

**Linting:**

- Run: `npm run lint`
- Fix: `npm run lint -- --fix`

**Build Verification:**

- Shared: `npm run build:shared`
- Backend: `npm --workspace=apps/api run build`
- Frontend: `npm --workspace=apps/web run build`

### Rollback Scope

**What Gets Removed:**

- Epic 22 admin theme designer UI (entire feature)
- Epic 22 admin theme management interface
- Epic 22 theme export/import dialogs
- Epic 22 admin theme API routes and controllers
- Epic 21 partial Tailwind replacements in templates

**What Stays:**

- Epic 20 database schema (form_themes table)
- Epic 20 API endpoints structure
- Epic 20 theme dropdown in Form Builder
- Epic 20 ThemePreviewService
- Epic 20 9 seeded themes

**Why This Approach:** [Source: docs/prd/epic-23-complete-theme-system.md#problem-statement]

Epic 21/22 had fundamental architectural issues:

1. Incomplete theme utility classes (only inputs/buttons, missing backgrounds/containers)
2. Admin-only access pattern (should be all users via Form Builder modal)
3. Tailwind CSS conflicts not fully resolved
4. Security vulnerabilities in theme import

Epic 23 rebuilds correctly from clean Epic 20 foundation.

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-10-17 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

<!-- Populated by development agent during implementation -->

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

<!-- Reference any debug logs or traces generated during development -->

### Completion Notes List

<!-- Notes about the completion of tasks and any issues encountered -->

### File List

<!-- List all files created, modified, or affected during story implementation -->

## QA Results

<!-- Results from QA Agent QA review of the completed story implementation -->
