# Story 15.2: Add IMAGE Field Type for Visual Content Display

**Epic:** Epic 15: Content Display Field Types **Story Type:** New Feature Implementation
**Estimated Effort:** 8-10 hours

---

## User Story

**As a** form creator, **I want** to upload and display images in my forms, **So that** I can add
branding (logos), visual instructions (diagrams), product images, or other visual content to enhance
form presentation and user experience.

---

## Story Context

### Existing System Integration

**Integrates with:**

- Form field type system (`packages/shared/src/types/forms.types.ts`)
- Field palette component (`apps/web/src/app/features/tools/components/form-builder/field-palette/`)
- Form canvas component (`apps/web/src/app/features/tools/components/form-builder/form-canvas/`)
- Field properties modal
  (`apps/web/src/app/features/tools/components/form-builder/field-properties/`)
- Public form renderer (`apps/web/src/app/features/public/form-renderer/`)
- **File upload service** (existing avatar upload mechanism)

**Technology:**

- Angular 20+ standalone components with signals
- TypeScript 5.3+ with strict mode
- PrimeNG 17+ UI components (FileUpload)
- Tailwind CSS for responsive images
- @nodeangularfullstack/shared for type definitions
- DO Spaces (S3-compatible) for image storage

**Follows pattern:**

- Existing field type pattern (TEXT, EMAIL, SELECT, etc.)
- Existing FILE field upload pattern
- User avatar upload pattern (`apps/api/src/controllers/users.controller.ts`)
- Field properties modal configuration pattern

**Touch points:**

- `FormFieldType` enum (add IMAGE type)
- Field palette template (add IMAGE button)
- Form canvas template (render IMAGE preview)
- Field properties modal (add IMAGE upload/config panel)
- Form renderer template (render responsive image)
- File upload API (reuse existing endpoint or create new)
- Image storage service (DO Spaces)

---

## Acceptance Criteria

### Functional Requirements

**1. Type Definition (Shared Package)**

- [ ] Add `IMAGE = 'image'` to `FormFieldType` enum in `packages/shared/src/types/forms.types.ts`
- [ ] Add JSDoc comment: `/** Image display field (non-input, display only) */`
- [ ] Define `ImageMetadata` interface:
  ```typescript
  interface ImageMetadata {
    imageUrl?: string; // S3/DO Spaces URL
    altText: string; // Required for accessibility
    width?: number | string; // px or % (default: 100%)
    height?: number | string; // px or auto
    alignment?: 'left' | 'center' | 'right' | 'full';
    caption?: string; // Optional caption below image
    objectFit?: 'contain' | 'cover' | 'fill' | 'none';
  }
  ```
- [ ] Rebuild shared package: `npm run build:shared`

**2. Field Palette Integration**

- [ ] Add IMAGE field button to field palette component
- [ ] Use image icon: `<i class="pi pi-image"></i>`
- [ ] Button labeled "Image"
- [ ] Clicking/dragging IMAGE creates new image field
- [ ] IMAGE appears in "Display Fields" section

**3. Field Creation & Default Values**

- [ ] FormBuilderService creates IMAGE field with defaults:
  - `type: FormFieldType.IMAGE`
  - `label: "Image"` (internal label, not displayed)
  - `fieldName: "image_[timestamp]"` (unique identifier)
  - `required: false` (images don't collect data)
  - `order: [next available order]`
  - `metadata: { altText: 'Image', alignment: 'center', width: '100%', height: 'auto' }`
- [ ] IMAGE field gets position property if row layout enabled

**4. Form Canvas Preview**

- [ ] IMAGE field displays in canvas with:
  - Image thumbnail if uploaded (150x150px max preview)
  - Placeholder icon if no image (`pi-image` icon with dashed border)
  - Image alt text displayed below preview
  - Edit icon on hover
  - Delete icon on hover
  - Drag handle for repositioning
- [ ] Clicking image opens field properties modal
- [ ] Image respects row-column positioning (if in row layout)

**5. Field Properties Modal - IMAGE Configuration Panel**

- [ ] Modal shows IMAGE-specific properties:
  - **Image Upload**:
    - File upload button (PrimeNG FileUpload)
    - Accepts: jpg, jpeg, png, gif, webp
    - Max size: 5MB
    - Shows upload progress
    - Displays uploaded image preview
  - **Image URL** (alternative to upload):
    - Text input for external image URL
    - Validates URL format
    - Shows preview when URL entered
  - **Alt Text** (required for accessibility):
    - Text input, required field
    - Help text: "Describe the image for screen readers"
    - Default: "Image"
  - **Dimensions**:
    - Width: number input + unit selector (px or %)
    - Height: number input + "auto" option
    - Default: width 100%, height auto
  - **Alignment**:
    - Buttons: left, center, right, full width
    - Default: center
  - **Object Fit**:
    - Dropdown: contain, cover, fill, none
    - Help text explaining each option
    - Default: contain
  - **Caption** (optional):
    - Text input for caption below image
    - Default: empty
- [ ] Changes update field in real-time
- [ ] Save button persists changes to FormBuilderService state
- [ ] Cancel button reverts changes

**6. Image Upload Implementation**

- [ ] Reuse existing file upload infrastructure:
  - Backend endpoint: `/api/v1/forms/upload-image` (new endpoint)
  - OR extend existing user avatar upload mechanism
  - Multer middleware for file parsing
  - File type validation (jpg, jpeg, png, gif, webp)
  - File size validation (max 5MB)
  - Image optimization/compression (optional: sharp library)
- [ ] Upload returns image URL (S3/DO Spaces URL)
- [ ] Store image URL in `field.metadata.imageUrl`
- [ ] Handle upload errors gracefully (show error message)

**7. Public Form Renderer - IMAGE Display**

- [ ] Form renderer detects `field.type === FormFieldType.IMAGE`
- [ ] Renders responsive image HTML:
  ```html
  <div class="form-image-wrapper" [style.text-align]="alignment">
    <img
      [src]="field.metadata.imageUrl"
      [alt]="field.metadata.altText"
      [style.width]="field.metadata.width"
      [style.height]="field.metadata.height"
      [style.object-fit]="field.metadata.objectFit"
      class="form-image"
      loading="lazy"
    />
    @if (field.metadata.caption) {
    <p class="image-caption">{{ field.metadata.caption }}</p>
    }
  </div>
  ```
- [ ] Image is responsive (max-width: 100%, maintains aspect ratio)
- [ ] Lazy loading enabled for images below fold
- [ ] Shows loading spinner while image loads
- [ ] Shows error placeholder if image fails to load
- [ ] Image is non-interactive (no click handlers)

**8. Data Exclusion (Non-Input Field)**

- [ ] IMAGE fields excluded from form validation logic
- [ ] IMAGE fields excluded from form submission data
- [ ] IMAGE fields don't create FormControl in reactive form group
- [ ] FormRendererComponent `buildFormGroup()` skips IMAGE fields

**9. Row Layout Compatibility**

- [ ] IMAGE works in row-based layout mode
- [ ] Can be positioned in any row/column
- [ ] Drag-drop from palette to row/column works
- [ ] Moving IMAGE between columns works
- [ ] IMAGE respects column width (responsive within column)

### Integration Requirements

**10. Backward Compatibility**

- [ ] Existing forms without IMAGE continue working
- [ ] Existing field types unaffected
- [ ] Form publishing workflow unchanged
- [ ] Form submission API unchanged
- [ ] Existing file upload endpoints unchanged

**11. Existing Pattern Adherence**

- [ ] IMAGE follows same field lifecycle as other field types
- [ ] Uses existing drag-drop infrastructure (Angular CDK)
- [ ] Uses existing field properties modal infrastructure
- [ ] File upload reuses existing upload service/endpoint pattern
- [ ] Image storage uses existing S3/DO Spaces configuration

**12. State Persistence**

- [ ] IMAGE configuration saved to database on form save
- [ ] IMAGE with image URL loads correctly from database on page reload
- [ ] Uploaded images persist in S3/DO Spaces
- [ ] No data loss when toggling row layout on/off

### Quality Requirements

**13. Testing**

- [ ] Unit tests for IMAGE field creation in FormBuilderService
- [ ] Unit tests for IMAGE preview rendering in FormCanvasComponent
- [ ] Unit tests for IMAGE properties panel in FieldPropertiesComponent
- [ ] Unit tests for IMAGE rendering in FormRendererComponent
- [ ] Unit tests verify IMAGE excluded from form submission
- [ ] Integration tests for image upload API endpoint
- [ ] Integration tests verify IMAGE in published forms
- [ ] Test image loading states (loading, success, error)

**14. Styling & UX**

- [ ] IMAGE preview in canvas shows thumbnail or placeholder
- [ ] Uploaded image shows immediately in properties modal
- [ ] Upload progress indicator shows during upload
- [ ] Image in published form is responsive (mobile-friendly)
- [ ] Image maintains aspect ratio (no distortion)
- [ ] Image alignment works correctly (left, center, right, full)
- [ ] Caption styling is clear and readable

**15. Accessibility**

- [ ] Alt text is required (enforced in UI)
- [ ] Alt text validation (minimum 3 characters, max 250)
- [ ] Images use `alt` attribute correctly
- [ ] Images use `loading="lazy"` for performance
- [ ] Screen readers announce image alt text
- [ ] Keyboard navigation works (skip image with Tab)
- [ ] Error states accessible to screen readers

**16. Performance & Security**

- [ ] File size limit enforced (5MB max)
- [ ] File type validation (whitelist: jpg, jpeg, png, gif, webp)
- [ ] Image optimization/compression applied (optional)
- [ ] Lazy loading reduces initial page load time
- [ ] Images served from CDN (DO Spaces with CDN)
- [ ] No XSS risk from image URLs (validate URL format)
- [ ] CORS configured for image loading

**17. Documentation**

- [ ] JSDoc comments added to new code
- [ ] FormFieldType enum updated with IMAGE documentation
- [ ] Image upload API endpoint documented
- [ ] CLAUDE.md updated with IMAGE field type information

---

## Technical Implementation Notes

### 1. Shared Type Definition

**File:** `packages/shared/src/types/forms.types.ts`

```typescript
export enum FormFieldType {
  // ... existing types ...
  /** Image display field (non-input, display only) */
  IMAGE = 'image',
}

// Add to FormField metadata union type
interface ImageMetadata {
  imageUrl?: string; // S3/DO Spaces URL
  altText: string; // Required for accessibility
  width?: number | string; // px or % (default: '100%')
  height?: number | string; // px or 'auto'
  alignment?: 'left' | 'center' | 'right' | 'full';
  caption?: string; // Optional caption
  objectFit?: 'contain' | 'cover' | 'fill' | 'none';
}
```

### 2. Backend Image Upload Endpoint

**File:** `apps/api/src/routes/forms.routes.ts`

```typescript
router.post(
  '/:formId/upload-image',
  authenticateToken,
  upload.single('image'), // Multer middleware
  formsController.uploadFormImage
);
```

**File:** `apps/api/src/controllers/forms.controller.ts`

```typescript
uploadFormImage = AsyncHandler(async (req: Request, res: Response): Promise<void> => {
  const { formId } = req.params;
  const userId = req.user!.userId;
  const file = req.file;

  if (!file) {
    throw new ApiError('No file uploaded', 400, 'NO_FILE');
  }

  // Validate file type
  const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];
  if (!allowedTypes.includes(file.mimetype)) {
    throw new ApiError('Invalid file type', 400, 'INVALID_TYPE');
  }

  // Validate file size (5MB)
  if (file.size > 5 * 1024 * 1024) {
    throw new ApiError('File too large (max 5MB)', 400, 'FILE_TOO_LARGE');
  }

  // Upload to S3/DO Spaces
  const imageUrl = await fileStorageService.uploadFormImage(file, formId, userId);

  res.json({
    success: true,
    message: 'Image uploaded successfully',
    data: { imageUrl },
    timestamp: new Date().toISOString(),
  });
});
```

### 3. Field Palette Addition

**File:**
`apps/web/src/app/features/tools/components/form-builder/field-palette/field-palette.component.html`

```html
<button
  pButton
  type="button"
  label="Image"
  icon="pi pi-image"
  class="p-button-outlined w-full justify-start"
  (click)="onFieldTypeSelected('image')"
></button>
```

### 4. Form Canvas Preview

**File:**
`apps/web/src/app/features/tools/components/form-builder/form-canvas/form-canvas.component.html`

```html
@if (field.type === fieldTypes.IMAGE) {
<div class="image-field-preview" (click)="onFieldClick(field)">
  @if (field.metadata?.imageUrl) {
  <img
    [src]="field.metadata.imageUrl"
    [alt]="field.metadata.altText"
    class="preview-image"
    style="max-width: 150px; max-height: 150px; object-fit: contain;"
  />
  } @else {
  <div class="image-placeholder">
    <i class="pi pi-image text-4xl text-gray-400"></i>
    <p class="text-sm text-gray-500">No image uploaded</p>
  </div>
  }
  <p class="text-xs text-gray-600 mt-1">{{ field.metadata?.altText }}</p>
  <div class="field-actions">
    <button pButton icon="pi pi-pencil" (click)="onEditField(field)"></button>
    <button pButton icon="pi pi-trash" (click)="onDeleteField(field)"></button>
  </div>
</div>
}
```

### 5. Field Properties Modal - IMAGE Upload

**File:**
`apps/web/src/app/features/tools/components/form-builder/field-properties/field-properties.component.html`

```html
@if (field.type === fieldTypes.IMAGE) {
<div class="image-properties">
  <!-- Image Upload -->
  <div class="form-group">
    <label>Upload Image</label>
    <p-fileUpload
      mode="basic"
      accept="image/jpeg,image/jpg,image/png,image/gif,image/webp"
      [maxFileSize]="5000000"
      [customUpload]="true"
      (uploadHandler)="onImageUpload($event)"
      chooseLabel="Upload Image"
    ></p-fileUpload>
    @if (uploadProgress > 0 && uploadProgress < 100) {
    <p-progressBar [value]="uploadProgress"></p-progressBar>
    }
  </div>

  <!-- OR Image URL -->
  <div class="form-group">
    <label for="imageUrl">Or Enter Image URL</label>
    <input
      id="imageUrl"
      type="url"
      pInputText
      [(ngModel)]="field.metadata.imageUrl"
      placeholder="https://example.com/image.jpg"
    />
  </div>

  <!-- Image Preview -->
  @if (field.metadata?.imageUrl) {
  <div class="form-group">
    <img
      [src]="field.metadata.imageUrl"
      [alt]="field.metadata.altText"
      class="w-full max-h-48 object-contain border rounded"
    />
  </div>
  }

  <!-- Alt Text (Required) -->
  <div class="form-group">
    <label for="altText">Alt Text *</label>
    <input
      id="altText"
      type="text"
      pInputText
      [(ngModel)]="field.metadata.altText"
      required
      placeholder="Describe the image for screen readers"
    />
    <small class="text-gray-500">Required for accessibility</small>
  </div>

  <!-- Dimensions -->
  <div class="form-group grid grid-cols-2 gap-2">
    <div>
      <label for="imageWidth">Width</label>
      <input
        id="imageWidth"
        type="text"
        pInputText
        [(ngModel)]="field.metadata.width"
        placeholder="100%"
      />
    </div>
    <div>
      <label for="imageHeight">Height</label>
      <input
        id="imageHeight"
        type="text"
        pInputText
        [(ngModel)]="field.metadata.height"
        placeholder="auto"
      />
    </div>
  </div>

  <!-- Alignment -->
  <div class="form-group">
    <label>Alignment</label>
    <p-selectButton
      [(ngModel)]="field.metadata.alignment"
      [options]="alignmentOptions"
      optionLabel="label"
      optionValue="value"
    ></p-selectButton>
  </div>

  <!-- Object Fit -->
  <div class="form-group">
    <label for="objectFit">Object Fit</label>
    <p-dropdown
      id="objectFit"
      [(ngModel)]="field.metadata.objectFit"
      [options]="objectFitOptions"
      optionLabel="label"
      optionValue="value"
    ></p-dropdown>
    <small class="text-gray-500">How image scales within dimensions</small>
  </div>

  <!-- Caption (Optional) -->
  <div class="form-group">
    <label for="imageCaption">Caption (Optional)</label>
    <input
      id="imageCaption"
      type="text"
      pInputText
      [(ngModel)]="field.metadata.caption"
      placeholder="Add a caption below the image"
    />
  </div>
</div>
}
```

### 6. Image Upload Service Method

**File:**
`apps/web/src/app/features/tools/components/form-builder/field-properties/field-properties.component.ts`

```typescript
onImageUpload(event: any): void {
  const file = event.files[0];
  const formId = this.formBuilderService.currentForm()?.id;

  if (!formId) {
    this.messageService.add({
      severity: 'error',
      summary: 'Error',
      detail: 'Please save the form before uploading images',
    });
    return;
  }

  const formData = new FormData();
  formData.append('image', file);

  this.uploadProgress = 0;

  this.http
    .post<{ success: boolean; data: { imageUrl: string } }>(
      `/api/v1/forms/${formId}/upload-image`,
      formData,
      {
        reportProgress: true,
        observe: 'events',
      }
    )
    .subscribe({
      next: (event) => {
        if (event.type === HttpEventType.UploadProgress) {
          this.uploadProgress = Math.round((100 * event.loaded) / event.total!);
        } else if (event.type === HttpEventType.Response) {
          this.field.metadata.imageUrl = event.body!.data.imageUrl;
          this.uploadProgress = 100;
          this.messageService.add({
            severity: 'success',
            summary: 'Success',
            detail: 'Image uploaded successfully',
          });
        }
      },
      error: (error) => {
        this.uploadProgress = 0;
        this.messageService.add({
          severity: 'error',
          summary: 'Upload Failed',
          detail: error.error?.message || 'Failed to upload image',
        });
      },
    });
}
```

### 7. Form Renderer - IMAGE Display

**File:** `apps/web/src/app/features/public/form-renderer/form-renderer.component.html`

```html
@if (field.type === fieldTypes.IMAGE) {
<div
  class="form-image-wrapper mb-4"
  [class.text-left]="field.metadata?.alignment === 'left'"
  [class.text-center]="field.metadata?.alignment === 'center'"
  [class.text-right]="field.metadata?.alignment === 'right'"
>
  @if (imageLoading[field.id]) {
  <div class="flex justify-center items-center h-32">
    <p-progressSpinner styleClass="w-8 h-8"></p-progressSpinner>
  </div>
  } @if (imageError[field.id]) {
  <div class="border-2 border-dashed border-gray-300 rounded p-4 text-center">
    <i class="pi pi-exclamation-triangle text-2xl text-gray-400 mb-2"></i>
    <p class="text-sm text-gray-500">Image failed to load</p>
  </div>
  } @if (!imageLoading[field.id] && !imageError[field.id] && field.metadata?.imageUrl) {
  <img
    [src]="field.metadata.imageUrl"
    [alt]="field.metadata.altText || 'Image'"
    [style.width]="field.metadata.width || '100%'"
    [style.height]="field.metadata.height || 'auto'"
    [style.object-fit]="field.metadata.objectFit || 'contain'"
    class="form-image max-w-full"
    loading="lazy"
    (load)="onImageLoad(field.id)"
    (error)="onImageError(field.id)"
  />
  @if (field.metadata.caption) {
  <p class="image-caption text-sm text-gray-600 mt-2">{{ field.metadata.caption }}</p>
  } }
</div>
}
```

---

## Definition of Done

- [x] All functional requirements (1-9) completed
- [x] All integration requirements (10-12) verified
- [x] All quality requirements (13-17) met
- [x] Image upload endpoint implemented and tested
- [x] File upload works with progress indicator
- [x] Image URL alternative works
- [x] Unit tests pass for all new code
- [x] Integration tests pass for image upload and rendering
- [x] No regression in existing form builder features
- [x] Images display responsively on mobile devices
- [x] Alt text requirement enforced (accessibility)
- [x] File size and type validation working
- [x] Lazy loading implemented for performance
- [x] Error handling for failed image loads
- [x] Documentation updated (JSDoc, API docs, CLAUDE.md)
- [x] Shared package rebuilt and tested
- [x] Changes committed with descriptive commit message

---

## Risk Assessment

**Primary Risks:**

1. **Storage Costs:** Many large images could increase storage costs
   - **Mitigation:** Enforce 5MB limit, consider image compression, monitor usage

2. **Performance Impact:** Multiple large images slow page load
   - **Mitigation:** Lazy loading, CDN caching, image optimization

3. **Broken Image Links:** External URLs may become unavailable
   - **Mitigation:** Show error placeholder, prefer uploads over external URLs

4. **Missing Alt Text:** Accessibility failure if alt text not provided
   - **Mitigation:** Make alt text required field, validate minimum length

**Rollback:**

- Disable IMAGE in field palette (prevent new creation)
- Existing forms with IMAGE continue working (display images)
- No database schema changes (JSONB is flexible)
- Uploaded images remain in S3/DO Spaces (no cleanup needed immediately)

---

## Dependencies

**Before starting:**

- [ ] Story 15.1 (HEADING field) completed (establishes display field pattern)
- [ ] File upload infrastructure available (reuse user avatar upload)
- [ ] S3/DO Spaces configured and accessible
- [ ] FormBuilderService state management working correctly

**Build order:**

1. Backend image upload endpoint
2. Shared type definition (build shared package)
3. Field palette button
4. FormBuilderService field creation
5. Form canvas preview (with placeholder)
6. Field properties modal (upload + config)
7. Form renderer display (with loading/error states)
8. Tests

---

## Testing Strategy

**Unit Tests:**

- FormBuilderService creates IMAGE with correct defaults
- Field properties modal updates IMAGE metadata
- Form renderer renders responsive image
- Form renderer handles image loading/error states
- Form renderer excludes IMAGE from FormGroup

**Integration Tests:**

- Upload image via API endpoint
- Create form with IMAGE in builder
- Save form with IMAGE
- Reload page → IMAGE persists with image URL
- Publish form → IMAGE displays correctly
- Submit form → IMAGE excluded from submission data
- Test with external URL instead of upload

**Manual Testing:**

- Drag IMAGE from palette to canvas
- Upload image (show progress)
- Enter external image URL
- Configure alt text, dimensions, alignment, caption
- Preview in builder shows image thumbnail
- Publish form shows full responsive image
- Test lazy loading (image loads when scrolled into view)
- Test error handling (invalid URL, large file)
- Test on mobile devices (responsive behavior)
- Test with screen reader (alt text announced)

---

## Notes

- IMAGE is more complex than HEADING due to file upload requirement
- Reuse existing file upload infrastructure to save development time
- Consider image compression/optimization (sharp library) for performance
- Alt text is critical for accessibility (WCAG 2.1 AA requirement)
- Lazy loading improves initial page load performance
- Caption is optional but improves accessibility and context
- Future enhancement: Support image galleries (multiple images)
- Future enhancement: Image cropping/editing in properties modal
