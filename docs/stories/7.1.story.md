# Story 7.1: Super Admin: Tools Settings + Registry

## Status

Draft

## Story

**As a** super admin, **I want** to manage globally available tools through a Settings page, **so
that** I can enable or disable modular tools across the entire application without code deployment.

## Acceptance Criteria

1. Super admin can access Tools Settings page from Admin → Settings → Tools
2. Settings page displays a list of all registered tools with toggles to enable/disable each tool
3. Tool list shows: tool name, description, current status (enabled/disabled)
4. Changes to tool status persist to database immediately upon toggle
5. Database table `tools` created with columns: `id` (UUID), `key` (unique, kebab-case), `name`,
   `description`, `active` (boolean), `created_at`, `updated_at`
6. API endpoints created: GET /api/admin/tools (list all), PATCH /api/admin/tools/:key (update
   status)
7. Only super admin role can access these endpoints (403 for other roles)
8. Response caching implemented with ETag headers for efficiency
9. Initial seed data includes "short-link" tool entry

## Tasks / Subtasks

- [ ] Create database migration for tools table (AC: 5)
  - [ ] Create migration file: apps/api/database/migrations/[timestamp]\_create_tools_table.sql
  - [ ] Define table schema with UUID primary key
  - [ ] Add unique constraint on `key` column
  - [ ] Create update trigger for `updated_at` timestamp
- [ ] Create seed data for tools registry (AC: 9)
  - [ ] Create seed file: apps/api/database/seeds/tools.seed.ts
  - [ ] Add initial "short-link" tool entry
- [ ] Implement backend repository layer (AC: 5, 6)
  - [ ] Create apps/api/src/repositories/tools.repository.ts extending BaseRepository
  - [ ] Implement findAll() method for listing tools
  - [ ] Implement updateStatus(key, active) method
- [ ] Implement backend service layer (AC: 6)
  - [ ] Create apps/api/src/services/tools.service.ts
  - [ ] Implement getTools() method with caching logic
  - [ ] Implement updateToolStatus(key, active) method
  - [ ] Add ETag generation for cache headers
- [ ] Create API controllers and routes (AC: 6, 7, 8)
  - [ ] Create apps/api/src/controllers/tools.controller.ts
  - [ ] Implement GET endpoint for listing tools
  - [ ] Implement PATCH endpoint for updating tool status
  - [ ] Create apps/api/src/routes/tools.routes.ts with super admin middleware
  - [ ] Add ETag header support for responses
- [ ] Create frontend Tools service (AC: 1, 2, 4)
  - [ ] Create apps/web/src/app/features/admin/services/tools.service.ts
  - [ ] Implement getTools() method with caching
  - [ ] Implement updateToolStatus(key, active) method with optimistic updates
  - [ ] Handle ETag headers for cache invalidation
- [ ] Create Tools Settings component (AC: 1, 2, 3, 4)
  - [ ] Create apps/web/src/app/features/admin/pages/tools-settings/tools-settings.page.ts
  - [ ] Display tools list with PrimeNG DataTable
  - [ ] Implement toggle switches for enable/disable
  - [ ] Add loading states and error handling
  - [ ] Implement optimistic UI updates with rollback on error
- [ ] Update admin routing (AC: 1)
  - [ ] Add tools route to apps/web/src/app/features/admin/admin.routes.ts
  - [ ] Add navigation menu item in admin layout
  - [ ] Restrict access to super admin role only
- [ ] Add unit tests
  - [ ] Test tools repository methods (apps/api/tests/unit/repositories/tools.repository.test.ts)
  - [ ] Test tools service with caching (apps/api/tests/unit/services/tools.service.test.ts)
  - [ ] Test tools controller endpoints (apps/api/tests/integration/tools.test.ts)
  - [ ] Test frontend tools service (apps/web/src/app/features/admin/services/tools.service.spec.ts)
  - [ ] Test tools settings component
        (apps/web/src/app/features/admin/pages/tools-settings/tools-settings.page.spec.ts)

## Dev Notes

### Testing Standards

[Source: architecture/testing-strategy.md#Backend Tests]

- Backend test files location: apps/api/tests/unit/ and apps/api/tests/integration/
- Frontend test files location: alongside source files with .spec.ts extension
- Use Jest for backend testing with supertest for API integration tests
- Use Karma/Jasmine for Angular component testing
- Mock external dependencies and database calls in unit tests

### Database Schema

[Source: architecture/database-schema.md#Database Schema]

- Use UUID primary keys with uuid-ossp extension
- Include created_at and updated_at timestamps with timezone
- Implement update trigger for automatic updated_at maintenance
- Follow existing pattern from users/tenants tables

### Backend Architecture

[Source: architecture/backend-architecture.md#Service Architecture]

- Repository pattern: Extend BaseRepository for data access
- Service layer: Business logic and caching implementation
- Controller: Request/response handling with AsyncHandler wrapper
- Use existing ApiError class for error handling
- Follow existing middleware patterns for authentication/authorization

### API Specifications

[Source: architecture/backend-architecture.md#Controller Template]

- Standard response format: { success: true, data: <payload> }
- Error responses use ApiError with appropriate HTTP status codes
- Include JSDoc comments for all public methods with @throws documentation
- Validate input using express-validator middleware

### Frontend Architecture

[Source: architecture/frontend-architecture.md#Component Architecture]

- Use standalone components with ChangeDetectionStrategy.OnPush
- Implement services in feature-specific services folder
- Use signals for reactive state management
- Follow PrimeNG component patterns with Tailwind CSS styling

### Routing Configuration

[Source: architecture/frontend-architecture.md#Protected Route Pattern]

- Lazy load feature modules using dynamic imports
- Apply roleGuard with ['admin'] for admin-only routes
- Place under MainLayoutComponent with authGuard protection

### Coding Standards

[Source: architecture/coding-standards.md#Critical Fullstack Rules]

- Define all types in packages/shared and import from @nodeangularfullstack/shared
- All public functions must have JSDoc comments
- Use parameterized queries for database operations
- Never access process.env directly - use config objects
- Validate input on both frontend and backend

### File Locations

[Source: architecture/unified-project-structure.md#Monorepo Structure]

- Backend: apps/api/src/{repositories,services,controllers,routes}/
- Frontend: apps/web/src/app/features/admin/{services,pages,components}/
- Shared types: packages/shared/src/types/tools.types.ts
- Database migrations: apps/api/database/migrations/
- Database seeds: apps/api/database/seeds/

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-09-26 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
