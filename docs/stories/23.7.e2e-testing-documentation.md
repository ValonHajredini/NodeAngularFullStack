# Story 23.7: End-to-End Testing and Documentation

## Status

Draft

## Story

**As a** QA engineer, **I want** comprehensive E2E tests for the theme system, **so that** we verify
the entire workflow works correctly.

## Acceptance Criteria

1. Create E2E test suite: `tests/e2e/complete-theme-system.spec.ts`
2. Test scenarios:
   - **Scenario 1**: User creates custom theme, applies to form, publishes, verifies public
     rendering
   - **Scenario 2**: User edits own theme, verifies changes apply
   - **Scenario 3**: Non-owner cannot edit other user's theme (403 error)
   - **Scenario 4**: Admin can edit any theme
   - **Scenario 5**: Theme rendering works on mobile/tablet/desktop viewports
   - **Scenario 6**: Forms without themes continue rendering correctly
3. Visual regression tests for theme rendering
4. Performance tests (theme creation <2s, preview update <300ms)
5. Update user documentation with theme creation guide
6. Update architecture documentation with theme system design

## Tasks / Subtasks

- [ ] Task 1: Create E2E Test Suite Structure (AC: 1)
  - [ ] Create test file: `tests/e2e/complete-theme-system.spec.ts`
  - [ ] Import Playwright test utilities: `import { test, expect } from '@playwright/test';`
  - [ ] Set up test fixtures for authenticated users (admin, regular user)
  - [ ] Set up database seeding for test users and forms
  - [ ] Create helper functions:
    - `loginAs(page, email, password)`
    - `createFormWithTheme(page, themeName)`
    - `publishForm(page)`
    - `navigateToPublicForm(page, shortCode)`
    - `verifyThemeApplied(page, themeColors)`
  - [ ] Add test data cleanup in `afterEach` hook
  - [ ] Configure Playwright to run against local dev environment (http://localhost:4200)

- [ ] Task 2: Scenario 1 - User Creates Custom Theme and Publishes Form (AC: 2.1)
  - [ ] Write test: "should create custom theme, apply to form, and publish"
    - Login as regular user
    - Navigate to Form Builder
    - Create new form
    - Click theme dropdown
    - Click "Build Your Own Custom Color Theme" button
    - Verify theme designer modal opens
    - Fill out Step 1: Primary = #3B82F6, Secondary = #10B981
    - Click Next
    - Fill out Step 2: Linear gradient (blue to green, 45deg)
    - Click Next
    - Fill out Step 3: Heading = Montserrat, Body = Open Sans
    - Click Next
    - Fill out Step 4: Border radius = 8px, Padding = 16px
    - Click Next
    - Fill out Step 5: Name = "Test Theme"
    - Click Save
    - Verify modal closes
    - Verify theme applied to canvas (check background color)
    - Add form fields (text input, button)
    - Publish form
    - Verify success message
    - Navigate to public form URL
    - Verify theme applied to public form:
      - Background color matches theme
      - Form container matches theme
      - Input fields use theme colors
      - Button uses theme primary color
  - [ ] Add assertions for each step
  - [ ] Capture screenshots at key points for visual verification

- [ ] Task 3: Scenario 2 - User Edits Own Theme (AC: 2.2)
  - [ ] Write test: "should allow user to edit their own theme"
    - Login as regular user
    - Navigate to Form Builder
    - Create form with custom theme (from Scenario 1)
    - Open theme dropdown
    - Click "Edit Theme" option for owned theme
    - Verify theme designer modal opens with existing values pre-filled
    - Change primary color to #FF5733
    - Click Save
    - Verify changes saved (API call successful)
    - Verify canvas updates with new primary color
    - Publish form and verify public form uses updated theme
  - [ ] Add assertions for theme update
  - [ ] Verify API calls: `PUT /api/themes/:id`

- [ ] Task 4: Scenario 3 - Non-Owner Cannot Edit Other User's Theme (AC: 2.3)
  - [ ] Write test: "should prevent non-owner from editing other user's theme"
    - Login as user1 and create custom theme "User1 Theme"
    - Logout
    - Login as user2
    - Navigate to Form Builder
    - Create new form
    - Open theme dropdown
    - Verify "User1 Theme" appears in list (if admin created or public themes exist)
    - Attempt to edit "User1 Theme" via API call: `PUT /api/themes/{user1-theme-id}`
    - Verify API returns 403 Forbidden
    - Verify error message: "You can only edit your own themes"
  - [ ] Use API client to test authorization directly
  - [ ] Verify frontend does not show "Edit" option for non-owned themes

- [ ] Task 5: Scenario 4 - Admin Can Edit Any Theme (AC: 2.4)
  - [ ] Write test: "should allow admin to edit any theme"
    - Login as regular user and create custom theme "User Theme"
    - Logout
    - Login as admin user
    - Navigate to theme management (or use API directly)
    - Edit "User Theme" via API: `PUT /api/themes/{user-theme-id}`
    - Verify API returns 200 OK
    - Verify changes saved successfully
    - Login as original user
    - Verify form with "User Theme" shows admin's edits
  - [ ] Add assertions for admin authorization
  - [ ] Verify admin role middleware allows edit

- [ ] Task 6: Scenario 5 - Theme Rendering on Mobile/Tablet/Desktop (AC: 2.5)
  - [ ] Write test: "should render theme correctly on mobile viewport"
    - Set viewport to mobile (375x667)
    - Login and create form with theme
    - Publish form
    - Navigate to public form URL
    - Verify theme rendering on mobile:
      - Background visible
      - Form container visible
      - Fields styled with theme colors
      - Row layout stacks vertically
    - Capture mobile screenshot
  - [ ] Write test: "should render theme correctly on tablet viewport"
    - Set viewport to tablet (768x1024)
    - Navigate to same published form
    - Verify theme rendering on tablet
    - Capture tablet screenshot
  - [ ] Write test: "should render theme correctly on desktop viewport"
    - Set viewport to desktop (1920x1080)
    - Navigate to same published form
    - Verify theme rendering on desktop
    - Capture desktop screenshot
  - [ ] Compare screenshots for visual consistency

- [ ] Task 7: Scenario 6 - Forms Without Themes Render Correctly (AC: 2.6)
  - [ ] Write test: "should render form without theme using default styles"
    - Login as user
    - Create new form
    - Do NOT select a theme (leave themeId as null)
    - Add form fields
    - Publish form
    - Navigate to public form URL
    - Verify default theme classes applied:
      - `.theme-form-outer-background` uses default value
      - `.theme-input` uses default colors
      - `.theme-button-primary` uses default primary color
    - Capture screenshot
    - Compare to baseline (before Epic 23) - should be identical
  - [ ] Verify backward compatibility with existing forms created before Epic 23

- [ ] Task 8: Visual Regression Tests for Theme Rendering (AC: 3)
  - [ ] Install Playwright visual comparison plugin (or Percy)
  - [ ] Create baseline screenshots for all 9 seeded themes:
    - For each theme (Ocean Blue, Sunset Orange, Forest Green, etc.):
      - Create form with theme
      - Capture canvas screenshot
      - Capture preview modal screenshot
      - Publish form
      - Capture public form screenshot
  - [ ] Create visual regression tests:
    - Test: "should match canvas baseline for Ocean Blue theme"
    - Test: "should match preview baseline for Ocean Blue theme"
    - Test: "should match public form baseline for Ocean Blue theme"
    - Repeat for all 9 themes
  - [ ] Configure pixel diff threshold: 0.1% (allow minor anti-aliasing differences)
  - [ ] Store baseline screenshots in `tests/e2e/baselines/`
  - [ ] Run visual regression tests on CI pipeline

- [ ] Task 9: Performance Test - Theme Creation <2s (AC: 4)
  - [ ] Write test: "should create theme within 2 seconds"
    - Login as user
    - Navigate to Form Builder
    - Open theme designer modal
    - Start performance timer
    - Fill out all 5 steps with test data
    - Click Save
    - Stop performance timer when API response received
    - Assert: `elapsedTime < 2000ms`
  - [ ] Add performance metrics logging
  - [ ] Test with different network conditions (fast 3G, slow 3G)
  - [ ] Identify performance bottlenecks if threshold exceeded

- [ ] Task 10: Performance Test - Preview Update <300ms (AC: 4)
  - [ ] Write test: "should update preview within 300ms of color change"
    - Open theme designer modal
    - Navigate to Step 1 (Colors)
    - Select primary color picker
    - Start performance timer
    - Change primary color to #FF0000
    - Wait for preview to update (watch for CSS variable change)
    - Stop performance timer
    - Assert: `elapsedTime < 300ms`
  - [ ] Test debouncing logic (multiple rapid changes should only trigger one update)
  - [ ] Verify ThemePreviewService applies CSS variables efficiently

- [ ] Task 11: E2E Test Execution and CI Integration
  - [ ] Run E2E tests locally: `npm run test:e2e -- complete-theme-system.spec.ts`
  - [ ] Verify all tests pass on Chromium
  - [ ] Run tests on Firefox: `npm run test:e2e -- --project=firefox complete-theme-system.spec.ts`
  - [ ] Run tests on WebKit: `npm run test:e2e -- --project=webkit complete-theme-system.spec.ts`
  - [ ] Configure GitHub Actions workflow to run E2E tests on PR:
    - Add step to start backend and frontend servers
    - Add step to seed test database
    - Add step to run Playwright tests
    - Add step to upload test artifacts (screenshots, videos)
  - [ ] Add E2E test results to PR status checks

- [ ] Task 12: Create User Documentation - Theme Creation Guide (AC: 5)
  - [ ] Create documentation file: `docs/user-guides/theme-creation-guide.md`
  - [ ] Document sections:
    - **Introduction**: What are themes and why use them?
    - **Accessing Theme Designer**: How to open theme designer modal from Form Builder
    - **Step-by-Step Guide**:
      - Step 1: Choosing Colors (primary, secondary)
      - Step 2: Setting Background (solid, gradient, image)
      - Step 3: Selecting Fonts (Google Fonts)
      - Step 4: Configuring Field Styling (border radius, padding)
      - Step 5: Preview & Save
    - **Applying Themes**: How to apply theme to form
    - **Editing Themes**: How to edit your own themes
    - **Theme Permissions**: Who can edit/delete themes
    - **Troubleshooting**: Common issues and solutions
  - [ ] Add screenshots for each step
  - [ ] Add video tutorial (optional, link to YouTube)
  - [ ] Include examples of custom themes

- [ ] Task 13: Create Architecture Documentation - Theme System Design (AC: 6)
  - [ ] Create documentation file: `docs/architecture/theme-system.md`
  - [ ] Document sections:
    - **Overview**: High-level architecture of theme system
    - **Database Schema**: `form_themes` table structure
    - **API Endpoints**: REST API documentation for theme CRUD operations
    - **Frontend Architecture**:
      - ThemePreviewService (CSS variable injection)
      - Theme Designer Modal Component structure
      - Theme rendering in canvas, preview, public forms
    - **Theme Utility Classes**: Complete list of CSS classes and CSS variables
    - **Authentication & Authorization**: Theme creation, edit, delete permissions
    - **Performance Considerations**: Caching, debouncing, CSS variable performance
    - **Backward Compatibility**: How existing forms without themes continue working
    - **Future Enhancements**: Potential improvements (theme marketplace, theme templates, etc.)
  - [ ] Add architecture diagrams (component diagram, data flow diagram)
  - [ ] Include code snippets for key implementations

- [ ] Task 14: Update README with Theme System Information
  - [ ] Open `README.md` in project root
  - [ ] Add section: "Theme System" under "Key Features"
  - [ ] Document:
    - Theme creation via Form Builder modal
    - 9 pre-built themes included
    - Custom theme support with gradients, fonts, and styling
    - Real-time preview
    - Per-form theme application
  - [ ] Add link to user guide: `docs/user-guides/theme-creation-guide.md`
  - [ ] Add link to architecture docs: `docs/architecture/theme-system.md`

- [ ] Task 15: Update API Documentation (Swagger) for Theme Endpoints
  - [ ] Open `apps/api/src/controllers/themes.controller.ts`
  - [ ] Verify Swagger JSDoc comments are complete for all endpoints:
    - `GET /api/themes` - List all themes
    - `GET /api/themes/:id` - Get theme by ID
    - `POST /api/themes` - Create new theme
    - `PUT /api/themes/:id` - Update theme (owner or admin)
    - `DELETE /api/themes/:id` - Delete theme (owner or admin)
  - [ ] Document authentication requirements in Swagger
  - [ ] Document request/response schemas
  - [ ] Add example requests/responses
  - [ ] Test Swagger UI at http://localhost:3000/api-docs

- [ ] Task 16: Create Release Notes for Epic 23
  - [ ] Create file: `docs/release-notes/epic-23-theme-system.md`
  - [ ] Document:
    - **What's New**:
      - Custom theme creation from Form Builder
      - Theme designer modal wizard (5 steps)
      - Themes apply to all form elements (backgrounds, containers, fields)
      - Tailwind CSS conflicts resolved
    - **Bug Fixes**:
      - Fixed theme rendering only applying to inputs/labels
      - Fixed admin-only theme creation restriction
      - Fixed Tailwind color class conflicts
    - **Breaking Changes**: None (fully backward compatible)
    - **Migration Guide**: No migration required for existing forms
    - **Known Issues**: None
    - **Deprecated Features**: Admin theme designer panel (Epic 22)
  - [ ] Add version number: v1.5.0 (or appropriate semantic version)
  - [ ] Add release date
  - [ ] Include links to user guide and architecture docs

- [ ] Task 17: Manual QA - Full Theme System Workflow
  - [ ] Start dev environment: `npm start`
  - [ ] Perform full end-to-end workflow:
    1. Login as regular user
    2. Navigate to Form Builder
    3. Create new form
    4. Open theme designer modal
    5. Create custom theme "QA Test Theme":
       - Primary: #FF6B6B, Secondary: #4ECDC4
       - Background: Linear gradient (red to teal, 135deg)
       - Heading font: Poppins, Body font: Lato
       - Border radius: 12px, Padding: 16px
    6. Save theme
    7. Verify theme applied to canvas
    8. Add form fields (text, email, textarea, button)
    9. Preview form - verify theme matches canvas
    10. Publish form
    11. Navigate to public form URL
    12. Verify theme renders correctly on public form
    13. Test form submission with themed form
    14. Test responsive rendering (mobile, tablet, desktop)
  - [ ] Test editing theme:
    1. Return to Form Builder
    2. Open theme dropdown
    3. Edit "QA Test Theme"
    4. Change primary color to #8E44AD
    5. Save
    6. Verify canvas updates
    7. Verify public form updates
  - [ ] Test theme permissions:
    1. Login as different user
    2. Verify cannot edit "QA Test Theme"
    3. Login as admin
    4. Verify can edit any theme
  - [ ] Document any bugs or issues found

- [ ] Task 18: Performance Benchmarking and Optimization
  - [ ] Run Lighthouse audit on public form with theme:
    - Performance score target: >90
    - Accessibility score target: 100
    - Best Practices score target: >90
  - [ ] Measure theme creation time:
    - Target: <2s from Save click to modal close
    - Profile API request timing
    - Profile frontend rendering timing
  - [ ] Measure preview update time:
    - Target: <300ms from color change to preview update
    - Profile debouncing logic
    - Profile ThemePreviewService CSS variable injection
  - [ ] Optimize if benchmarks not met:
    - Add caching for theme API calls
    - Optimize CSS variable injection
    - Reduce payload size of theme objects
  - [ ] Document performance metrics in architecture docs

- [ ] Task 19: Security Testing - Theme System
  - [ ] Test XSS prevention in theme data:
    - Attempt to inject script in theme name: `<script>alert('XSS')</script>`
    - Verify backend sanitizes input
    - Verify frontend escapes output
  - [ ] Test SQL injection in theme queries:
    - Attempt SQL injection in theme ID: `' OR '1'='1`
    - Verify parameterized queries prevent injection
  - [ ] Test CSRF protection:
    - Verify theme creation/edit/delete require CSRF token
  - [ ] Test authentication bypass:
    - Attempt to create/edit theme without auth token
    - Verify 401 Unauthorized returned
  - [ ] Test authorization bypass:
    - Attempt to edit other user's theme as non-admin
    - Verify 403 Forbidden returned
  - [ ] Document security measures in architecture docs

- [ ] Task 20: Final Review and Sign-Off
  - [ ] Review all E2E tests pass (Chromium, Firefox, WebKit)
  - [ ] Review all visual regression tests pass
  - [ ] Review all performance benchmarks met
  - [ ] Review all documentation complete and accurate
  - [ ] Review all security tests pass
  - [ ] Create Epic 23 completion checklist:
    - [ ] All 7 stories completed (23.1-23.7)
    - [ ] All acceptance criteria met
    - [ ] All tests passing
    - [ ] All documentation updated
    - [ ] Performance benchmarks met
    - [ ] Security tests passed
    - [ ] Zero regressions in existing functionality
  - [ ] Get stakeholder sign-off (Product Owner, Tech Lead)
  - [ ] Deploy to staging environment
  - [ ] Perform final QA on staging
  - [ ] Deploy to production

## Dev Notes

### Previous Story Insights

**From Story 23.5 Completion:** The theme designer modal wizard has been implemented with all 5
steps. Users can create custom themes from the Form Builder without leaving their workflow.

**From Story 23.6 Completion:** Themes are now applied correctly in all rendering contexts (canvas,
preview, public forms). Theme loading is handled via ThemePreviewService with proper error handling
and fallbacks.

**From Stories 23.1-23.4:**

- Epic 21 & 22 changes have been rolled back (Story 23.1)
- API authentication updated to allow all users to create themes (Story 23.2)
- Complete theme utility classes defined (Story 23.3)
- Tailwind color classes removed from themeable areas (Story 23.4)

**Key Dependencies:**

- ✅ All previous stories (23.1-23.6) must be complete
- ✅ Backend API functional and tested
- ✅ Frontend components functional and tested
- ✅ Theme system integrated into Form Builder

### Tech Stack

**E2E Testing Framework:** [Source: docs/architecture/tech-stack.md]

- **Playwright 1.40+**: Cross-browser E2E testing
- **TypeScript**: Test scripts written in TypeScript
- **GitHub Actions**: CI/CD pipeline for automated testing

**Documentation Tools:**

- **Markdown**: Documentation format
- **Mermaid**: Architecture diagrams
- **Swagger/OpenAPI**: API documentation

### E2E Test Configuration

**Playwright Configuration:** [Source: docs/architecture/testing-strategy.md#e2e-tests]

```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './tests/e2e',
  fullyParallel: true,
  forbidOnly: !!process.env.CI,
  retries: process.env.CI ? 2 : 0,
  workers: process.env.CI ? 1 : undefined,
  reporter: 'html',
  use: {
    baseURL: 'http://localhost:4200',
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
  },
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
    {
      name: 'Mobile Safari',
      use: { ...devices['iPhone 12'] },
    },
  ],
  webServer: {
    command: 'npm start',
    url: 'http://localhost:4200',
    reuseExistingServer: !process.env.CI,
  },
});
```

### E2E Test Patterns

**Authentication Helper:**

```typescript
// tests/e2e/helpers/auth.ts
import { Page } from '@playwright/test';

export async function loginAs(page: Page, email: string, password: string) {
  await page.goto('/auth/login');
  await page.fill('[name="email"]', email);
  await page.fill('[name="password"]', password);
  await page.click('button[type="submit"]');
  await page.waitForURL('/dashboard');
}

export async function logout(page: Page) {
  await page.click('[data-test="user-menu"]');
  await page.click('[data-test="logout-button"]');
  await page.waitForURL('/auth/login');
}
```

**Theme Creation Helper:**

```typescript
// tests/e2e/helpers/themes.ts
import { Page } from '@playwright/test';

export interface ThemeConfig {
  name: string;
  primaryColor: string;
  secondaryColor: string;
  backgroundType: 'solid' | 'linear' | 'radial';
  gradientAngle?: number;
  headingFont?: string;
  bodyFont?: string;
  borderRadius?: number;
  fieldPadding?: number;
}

export async function createThemeViaModal(page: Page, config: ThemeConfig) {
  // Open theme designer modal
  await page.click('[data-test="theme-dropdown"]');
  await page.click('[data-test="build-your-own-button"]');

  // Wait for modal
  await page.waitForSelector('app-theme-designer-modal');

  // Step 1: Colors
  await page.fill('[data-test="primary-color-input"]', config.primaryColor);
  await page.fill('[data-test="secondary-color-input"]', config.secondaryColor);
  await page.click('[data-test="next-button"]');

  // Step 2: Background
  await page.click(`[data-test="background-type-${config.backgroundType}"]`);
  if (config.backgroundType === 'linear' && config.gradientAngle) {
    await page.fill('[data-test="gradient-angle"]', config.gradientAngle.toString());
  }
  await page.click('[data-test="next-button"]');

  // Step 3: Typography
  if (config.headingFont) {
    await page.selectOption('[data-test="heading-font"]', config.headingFont);
  }
  if (config.bodyFont) {
    await page.selectOption('[data-test="body-font"]', config.bodyFont);
  }
  await page.click('[data-test="next-button"]');

  // Step 4: Styling
  if (config.borderRadius) {
    await page.fill('[data-test="border-radius"]', config.borderRadius.toString());
  }
  if (config.fieldPadding) {
    await page.fill('[data-test="field-padding"]', config.fieldPadding.toString());
  }
  await page.click('[data-test="next-button"]');

  // Step 5: Preview & Save
  await page.fill('[data-test="theme-name"]', config.name);
  await page.click('[data-test="save-button"]');

  // Wait for modal to close
  await page.waitForSelector('app-theme-designer-modal', { state: 'hidden' });
}
```

**Form Publishing Helper:**

```typescript
// tests/e2e/helpers/forms.ts
import { Page } from '@playwright/test';

export async function publishForm(page: Page): Promise<string> {
  // Click Publish button
  await page.click('[data-test="publish-button"]');

  // Wait for publish dialog
  await page.waitForSelector('[data-test="publish-dialog"]');

  // Confirm publish
  await page.click('[data-test="confirm-publish-button"]');

  // Wait for success message
  await page.waitForSelector('[data-test="publish-success"]');

  // Get public form URL
  const urlElement = await page.locator('[data-test="public-form-url"]');
  const publicUrl = await urlElement.innerText();

  return publicUrl;
}
```

### Visual Regression Testing

**Baseline Screenshot Creation:**

```typescript
// tests/e2e/theme-visual-regression.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Theme Visual Regression', () => {
  const themes = [
    'Ocean Blue',
    'Sunset Orange',
    'Forest Green',
    'Midnight Purple',
    'Rose Gold',
    'Arctic Frost',
    'Autumn Harvest',
    'Neon Glow',
    'Minimal Gray',
  ];

  themes.forEach((themeName) => {
    test(`should match baseline for ${themeName} in canvas`, async ({ page }) => {
      // Login and navigate to Form Builder
      await loginAs(page, 'admin@example.com', 'Admin123!@#');
      await page.goto('/tools/forms/new');

      // Apply theme
      await page.click('[data-test="theme-dropdown"]');
      await page.click(`[data-test="theme-option-${themeName.toLowerCase().replace(' ', '-')}"]`);

      // Wait for theme to apply
      await page.waitForTimeout(500);

      // Take screenshot
      const canvas = page.locator('.form-canvas');
      await expect(canvas).toHaveScreenshot(`${themeName}-canvas.png`);
    });

    test(`should match baseline for ${themeName} in public form`, async ({ page }) => {
      // ... create and publish form with theme
      const publicUrl = await publishForm(page);

      await page.goto(publicUrl);
      await page.waitForLoadState('networkidle');

      // Take screenshot
      await expect(page).toHaveScreenshot(`${themeName}-public.png`);
    });
  });
});
```

**Percy Integration (Optional):**

```typescript
// tests/e2e/percy-theme-snapshots.spec.ts
import { test } from '@playwright/test';
import percySnapshot from '@percy/playwright';

test.describe('Theme Percy Snapshots', () => {
  test('should capture Percy snapshots for all themes', async ({ page }) => {
    await loginAs(page, 'admin@example.com', 'Admin123!@#');
    await page.goto('/tools/forms/new');

    const themes = ['Ocean Blue', 'Sunset Orange' /* ... */];

    for (const themeName of themes) {
      await page.click('[data-test="theme-dropdown"]');
      await page.click(`[data-test="theme-option-${themeName.toLowerCase().replace(' ', '-')}"]`);
      await page.waitForTimeout(500);

      await percySnapshot(page, `Form Canvas - ${themeName}`);
    }
  });
});
```

### Performance Testing

**Theme Creation Performance:**

```typescript
// tests/e2e/theme-performance.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Theme Performance', () => {
  test('should create theme within 2 seconds', async ({ page }) => {
    await loginAs(page, 'admin@example.com', 'Admin123!@#');
    await page.goto('/tools/forms/new');

    // Open theme designer
    await page.click('[data-test="theme-dropdown"]');
    await page.click('[data-test="build-your-own-button"]');

    // Fill out wizard quickly
    await page.fill('[data-test="primary-color-input"]', '#3B82F6');
    await page.fill('[data-test="secondary-color-input"]', '#10B981');
    await page.click('[data-test="next-button"]');

    await page.click('[data-test="background-type-solid"]');
    await page.click('[data-test="next-button"]');

    await page.selectOption('[data-test="heading-font"]', 'Montserrat');
    await page.selectOption('[data-test="body-font"]', 'Open Sans');
    await page.click('[data-test="next-button"]');

    await page.fill('[data-test="border-radius"]', '8');
    await page.click('[data-test="next-button"]');

    await page.fill('[data-test="theme-name"]', 'Performance Test Theme');

    // Measure save time
    const startTime = Date.now();

    // Listen for API response
    const responsePromise = page.waitForResponse(
      (response) => response.url().includes('/api/themes') && response.status() === 201
    );

    await page.click('[data-test="save-button"]');

    await responsePromise;

    const endTime = Date.now();
    const elapsedTime = endTime - startTime;

    expect(elapsedTime).toBeLessThan(2000); // <2s
  });

  test('should update preview within 300ms', async ({ page }) => {
    await loginAs(page, 'admin@example.com', 'Admin123!@#');
    await page.goto('/tools/forms/new');

    await page.click('[data-test="theme-dropdown"]');
    await page.click('[data-test="build-your-own-button"]');

    // Measure preview update time
    const startTime = Date.now();

    await page.fill('[data-test="primary-color-input"]', '#FF0000');

    // Wait for CSS variable to update
    await page.waitForFunction(() => {
      const primaryColor = getComputedStyle(document.documentElement).getPropertyValue(
        '--theme-primary-color'
      );
      return primaryColor.includes('255, 0, 0'); // RGB of #FF0000
    });

    const endTime = Date.now();
    const elapsedTime = endTime - startTime;

    expect(elapsedTime).toBeLessThan(300); // <300ms
  });
});
```

### Documentation Structure

**User Guide Outline:**

```markdown
# Theme Creation Guide

## Introduction

- What are themes?
- Why use custom themes?
- Theme system capabilities

## Accessing Theme Designer

- From Form Builder
- Theme dropdown location
- "Build Your Own" button

## Step-by-Step Guide

### Step 1: Choosing Colors

- Primary color (main buttons, links)
- Secondary color (secondary buttons, accents)
- Color picker usage
- Color accessibility (WCAG AA)

### Step 2: Setting Background

- Solid color background
- Linear gradient (angle configuration)
- Radial gradient (position configuration)
- Image upload (file size limits, aspect ratio)

### Step 3: Selecting Fonts

- Google Fonts integration
- Heading font selection
- Body font selection
- Font size configuration

### Step 4: Configuring Field Styling

- Border radius slider
- Field padding
- Border width
- Spacing between fields

### Step 5: Preview & Save

- Real-time preview
- Naming your theme
- Saving and applying to current form

## Applying Themes

- Selecting theme from dropdown
- Switching between themes
- Preview before publishing

## Editing Themes

- Editing your own themes
- Permission restrictions
- Updating published forms

## Theme Permissions

- Who can create themes (all users)
- Who can edit themes (owner or admin)
- Who can delete themes (owner or admin)

## Troubleshooting

- Theme not applying: Clear browser cache
- Preview not updating: Check browser console for errors
- Save failed: Check network connection
```

**Architecture Documentation Outline:**

````markdown
# Theme System Architecture

## Overview

- High-level architecture
- Component diagram
- Data flow diagram

## Database Schema

### form_themes Table

```sql
CREATE TABLE form_themes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name VARCHAR(50) NOT NULL,
  primary_color VARCHAR(7) NOT NULL,
  secondary_color VARCHAR(7) NOT NULL,
  background_color TEXT,
  background_type VARCHAR(20) DEFAULT 'solid',
  background_image_url TEXT,
  gradient_angle INTEGER,
  gradient_position VARCHAR(50),
  heading_font VARCHAR(100),
  body_font VARCHAR(100),
  heading_font_size INTEGER DEFAULT 24,
  body_font_size INTEGER DEFAULT 16,
  border_radius INTEGER DEFAULT 8,
  field_padding INTEGER DEFAULT 12,
  field_margin INTEGER DEFAULT 8,
  border_width INTEGER DEFAULT 1,
  created_by UUID REFERENCES users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```
````

## API Endpoints

### GET /api/themes

- List all themes
- Public endpoint (no auth required)
- Response: Array of theme objects

### GET /api/themes/:id

- Get theme by ID
- Public endpoint
- Response: Single theme object

### POST /api/themes

- Create new theme
- Auth required (any authenticated user)
- Request body: Theme object
- Response: Created theme with ID

### PUT /api/themes/:id

- Update theme
- Auth required (owner or admin)
- Request body: Partial theme object
- Response: Updated theme

### DELETE /api/themes/:id

- Delete theme
- Auth required (owner or admin)
- Response: 204 No Content

## Frontend Architecture

### ThemePreviewService

- Injects CSS variables into DOM
- Methods: `applyTheme(theme)`, `clearTheme()`
- Used in canvas, preview, public form renderer

### Theme Designer Modal

- 5-step wizard component
- Modal state service
- Real-time preview with debouncing (300ms)

### Theme Rendering

- Form Builder canvas
- Preview dialog
- Public form renderer

## Theme Utility Classes

- Complete list of CSS classes
- CSS variable mappings
- Default fallback values

## Authentication & Authorization

- Theme creation: Any authenticated user
- Theme edit: Owner or admin only
- Theme delete: Owner or admin only

## Performance Considerations

- CSS variable injection (fast, no reflow)
- Theme caching (reduce API calls)
- Debouncing preview updates (300ms)

## Backward Compatibility

- Forms without themes use default styles
- No database migration required
- Zero breaking changes

````

### CI/CD Integration

**GitHub Actions Workflow:**

```yaml
# .github/workflows/e2e-tests.yml
name: E2E Tests

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Build shared package
        run: npm run build:shared

      - name: Run database migrations
        run: npm --workspace=apps/api run db:migrate
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db

      - name: Seed database
        run: npm --workspace=apps/api run db:seed
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db

      - name: Install Playwright browsers
        run: npx playwright install --with-deps

      - name: Start backend server
        run: npm --workspace=apps/api run dev &
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db

      - name: Start frontend server
        run: npm --workspace=apps/web run dev &

      - name: Wait for servers
        run: npx wait-on http://localhost:3000/health http://localhost:4200

      - name: Run E2E tests
        run: npm run test:e2e -- complete-theme-system.spec.ts

      - name: Upload test artifacts
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30
````

## Testing

### Testing Standards

**Location:** [Source: docs/architecture/testing-strategy.md]

- E2E tests: `tests/e2e/complete-theme-system.spec.ts`
- Visual regression tests: `tests/e2e/theme-visual-regression.spec.ts`
- Performance tests: `tests/e2e/theme-performance.spec.ts`

**Framework:**

- Playwright 1.40+ for E2E tests
- Percy (optional) for visual regression
- Run: `npm run test:e2e`

**Testing Patterns:** [Source: docs/architecture/testing-strategy.md#e2e-test]

```typescript
import { test, expect } from '@playwright/test';

test.describe('Complete Theme System', () => {
  test.beforeEach(async ({ page }) => {
    // Login before each test
    await loginAs(page, 'admin@example.com', 'Admin123!@#');
  });

  test('should complete full theme creation workflow', async ({ page }) => {
    // Navigate to Form Builder
    await page.goto('/tools/forms/new');

    // Create custom theme
    await createThemeViaModal(page, {
      name: 'Test Theme',
      primaryColor: '#3B82F6',
      secondaryColor: '#10B981',
      backgroundType: 'linear',
      gradientAngle: 45,
      headingFont: 'Montserrat',
      bodyFont: 'Open Sans',
      borderRadius: 8,
      fieldPadding: 16,
    });

    // Verify theme applied to canvas
    const canvas = page.locator('.form-canvas');
    const bgColor = await canvas.evaluate((el) => window.getComputedStyle(el).backgroundColor);
    expect(bgColor).toBeTruthy();

    // Publish form
    const publicUrl = await publishForm(page);

    // Verify theme on public form
    await page.goto(publicUrl);
    const outerBg = page.locator('.theme-form-outer-background');
    await expect(outerBg).toBeVisible();
  });
});
```

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-10-17 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

<!-- Populated by development agent during implementation -->

### Agent Model Used

<!-- e.g., Claude 3.5 Sonnet -->

### Debug Log References

<!-- Reference any debug logs or traces generated during development -->

### Completion Notes List

<!-- Notes about the completion of tasks and any issues encountered -->

### File List

<!-- List all files created, modified, or affected during story implementation -->

## QA Results

<!-- Results from QA Agent QA review of the completed story implementation -->
