# Story 22.2: Admin Theme API Endpoints and Validation - Brownfield Addition

## User Story

As a system administrator, I want secure API endpoints for theme management, So that I can create,
read, update, and delete custom themes through authenticated requests with proper validation.

## Story Context

**Existing System Integration:**

- Integrates with: Epic 20-21 forms API, JWT authentication system, admin role validation
- Technology: Express.js 4.19+, TypeScript, Passport.js JWT, express-validator
- Follows pattern: Existing `apps/api/src/controllers/forms.controller.ts` structure
- Touch points: JWT middleware, admin role guards, existing API routing, Swagger documentation

## Acceptance Criteria

**Functional Requirements:**

1. Admin-only endpoints created: `POST /api/admin/themes`, `GET /api/admin/themes`,
   `PUT /api/admin/themes/:id`, `DELETE /api/admin/themes/:id`
2. JWT authentication with admin role validation enforced on all endpoints
3. Theme validation includes accessibility checks (contrast ratios), CSS safety, size limits (50KB)
4. Error handling with structured error responses following existing patterns
5. Theme CRUD operations integrate with ThemesRepository from Story 22.1

**Integration Requirements:** 6. Existing form API endpoints (`/api/forms`) remain unaffected and
functional 7. Non-admin users receive 403 Forbidden when attempting theme management operations 8.
Theme operations integrate with existing error handling middleware 9. API documentation updated to
reflect new endpoints without breaking existing docs

**Quality Requirements:** 10. Integration tests verify admin-only access and CRUD operations 11.
Theme validation prevents malicious CSS and oversized themes 12. Error responses follow existing API
error format and status codes

## Technical Notes

- **Integration Approach**: Add new `themes.controller.ts` following existing controller patterns
- **Existing Pattern Reference**: Follow `apps/api/src/controllers/forms.controller.ts` structure
  and validation
- **Key Constraints**: Admin-only access, 50KB theme limit, CSS sanitization for security

## Definition of Done

- [ ] Theme controller created with CRUD endpoints
- [ ] Admin role validation enforced on all theme endpoints
- [ ] Theme validation implemented (accessibility, security, size)
- [ ] Integration tests pass for all endpoint scenarios
- [ ] Error handling follows existing patterns
- [ ] Swagger documentation updated for new endpoints

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk**: New endpoints interfere with existing forms API routing
- **Mitigation**: Isolated `/api/admin/themes` route prefix, separate controller
- **Rollback**: Remove theme routes and controller files

**Compatibility Verification:**

- [ ] No breaking changes to existing `/api/forms` endpoints
- [ ] Admin authentication follows existing JWT + role validation patterns
- [ ] Error responses maintain existing API contract format
- [ ] Performance impact negligible (admin-only operations)

## Files Modified

**New Files:**

- `apps/api/src/controllers/themes.controller.ts`
- `apps/api/src/routes/themes.routes.ts`
- `apps/api/src/validators/themes.validator.ts`
- `apps/api/tests/integration/admin-themes-api.test.ts`

**Modified Files:**

- `apps/api/src/app.ts` (add theme routes)
- `apps/api/src/config/swagger.config.ts` (add theme endpoint documentation)

**Integration Points:**

- JWT authentication: Uses existing `passport-jwt` middleware
- Admin role validation: Uses existing admin guard patterns
- Forms API: Isolated from existing endpoints
- Error handling: Uses existing error middleware

## API Endpoints Specification

```typescript
// POST /api/admin/themes
{
  "name": "Custom Corporate Theme",
  "primaryColor": "#1a73e8",
  "secondaryColor": "#34a853",
  "backgroundColor": "linear-gradient(135deg, #f8f9fa 0%, #e8eaed 100%)",
  "fontHeading": "Roboto, sans-serif",
  "fontBody": "Open Sans, sans-serif",
  // ... additional theme properties
}

// GET /api/admin/themes
[
  {
    "id": "uuid",
    "name": "Custom Corporate Theme",
    "isCustom": true,
    "createdBy": "admin@example.com",
    "createdAt": "2025-10-16T10:00:00Z",
    "themeDefinition": { /* theme properties */ }
  }
]
```

## Validation Rules

- **Theme Name**: Required, 3-50 characters, unique
- **Colors**: Valid hex/rgb/hsl format, accessibility contrast validation
- **Fonts**: Web-safe font families or Google Fonts
- **Background**: CSS background property validation, no javascript
- **Size Limit**: Total theme definition < 50KB JSON
- **CSS Safety**: No `javascript:` URLs, no `@import`, sanitized CSS

---

**Story Owner**: Backend Developer **Estimated Duration**: 6 hours **Priority**: Depends on Story
22.1 completion **Epic**: Epic 22 - Admin Theme Designer
