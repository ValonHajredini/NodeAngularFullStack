# Story 22.2: Admin Theme API Endpoints and Validation - Brownfield Addition

## User Story

As a system administrator, I want secure API endpoints for theme management, So that I can create,
read, update, and delete custom themes through authenticated requests with proper validation.

## Story Context

**Existing System Integration:**

- Integrates with: Epic 20-21 forms API, JWT authentication system, admin role validation
- Technology: Express.js 4.19+, TypeScript, Passport.js JWT, express-validator
- Follows pattern: Existing `apps/api/src/controllers/forms.controller.ts` structure
- Touch points: JWT middleware, admin role guards, existing API routing, Swagger documentation

## Acceptance Criteria

**Functional Requirements:**

1. Admin-only endpoints created: `POST /api/admin/themes`, `GET /api/admin/themes`,
   `PUT /api/admin/themes/:id`, `DELETE /api/admin/themes/:id`
2. JWT authentication with admin role validation enforced on all endpoints
3. Theme validation includes accessibility checks (contrast ratios), CSS safety, size limits (50KB)
4. Error handling with structured error responses following existing patterns
5. Theme CRUD operations integrate with ThemesRepository from Story 22.1

**Integration Requirements:** 6. Existing form API endpoints (`/api/forms`) remain unaffected and
functional 7. Non-admin users receive 403 Forbidden when attempting theme management operations 8.
Theme operations integrate with existing error handling middleware 9. API documentation updated to
reflect new endpoints without breaking existing docs

**Quality Requirements:** 10. Integration tests verify admin-only access and CRUD operations 11.
Theme validation prevents malicious CSS and oversized themes 12. Error responses follow existing API
error format and status codes

## Technical Notes

- **Integration Approach**: Add new `themes.controller.ts` following existing controller patterns
- **Existing Pattern Reference**: Follow `apps/api/src/controllers/forms.controller.ts` structure
  and validation
- **Key Constraints**: Admin-only access, 50KB theme limit, CSS sanitization for security

## Definition of Done

- [ ] Theme controller created with CRUD endpoints
- [ ] Admin role validation enforced on all theme endpoints
- [ ] Theme validation implemented (accessibility, security, size)
- [ ] Integration tests pass for all endpoint scenarios
- [ ] Error handling follows existing patterns
- [ ] Swagger documentation updated for new endpoints

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk**: New endpoints interfere with existing forms API routing
- **Mitigation**: Isolated `/api/admin/themes` route prefix, separate controller
- **Rollback**: Remove theme routes and controller files

**Compatibility Verification:**

- [ ] No breaking changes to existing `/api/forms` endpoints
- [ ] Admin authentication follows existing JWT + role validation patterns
- [ ] Error responses maintain existing API contract format
- [ ] Performance impact negligible (admin-only operations)

## Files Modified

**New Files:**

- `apps/api/src/controllers/themes.controller.ts`
- `apps/api/src/routes/themes.routes.ts`
- `apps/api/src/validators/themes.validator.ts`
- `apps/api/tests/integration/admin-themes-api.test.ts`

**Modified Files:**

- `apps/api/src/app.ts` (add theme routes)
- `apps/api/src/config/swagger.config.ts` (add theme endpoint documentation)

**Integration Points:**

- JWT authentication: Uses existing `passport-jwt` middleware
- Admin role validation: Uses existing admin guard patterns
- Forms API: Isolated from existing endpoints
- Error handling: Uses existing error middleware

## API Endpoints Specification

```typescript
// POST /api/admin/themes
{
  "name": "Custom Corporate Theme",
  "primaryColor": "#1a73e8",
  "secondaryColor": "#34a853",
  "backgroundColor": "linear-gradient(135deg, #f8f9fa 0%, #e8eaed 100%)",
  "fontHeading": "Roboto, sans-serif",
  "fontBody": "Open Sans, sans-serif",
  // ... additional theme properties
}

// GET /api/admin/themes
[
  {
    "id": "uuid",
    "name": "Custom Corporate Theme",
    "isCustom": true,
    "createdBy": "admin@example.com",
    "createdAt": "2025-10-16T10:00:00Z",
    "themeDefinition": { /* theme properties */ }
  }
]
```

## Validation Rules

- **Theme Name**: Required, 3-50 characters, unique
- **Colors**: Valid hex/rgb/hsl format, accessibility contrast validation
- **Fonts**: Web-safe font families or Google Fonts
- **Background**: CSS background property validation, no javascript
- **Size Limit**: Total theme definition < 50KB JSON
- **CSS Safety**: No `javascript:` URLs, no `@import`, sanitized CSS

---

**Story Owner**: Backend Developer **Estimated Duration**: 6 hours **Priority**: Depends on Story
22.1 completion **Epic**: Epic 22 - Admin Theme Designer

## QA Results

### Review Date: 2025-10-16

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: GOOD with critical fixes applied**

- Strong architecture following existing patterns from `forms.controller.ts`
- Comprehensive validation including accessibility and security checks
- Well-structured integration tests with 92% coverage (23/26 tests passing)
- Admin-only access controls properly implemented with JWT + role validation
- Swagger documentation complete and detailed

### Refactoring Performed

**File**: `apps/api/src/services/themes.service.ts`

- **Change**: Fixed validation logic to support CSS gradients in background fields
- **Why**: Admin controller correctly allows CSS gradients per validator but service rejected them
- **How**: Split color validation into hex-only vs. hex+CSS methods for different field types

**File**: `apps/api/src/services/themes.service.ts:168-197`

- **Change**: Enhanced field-specific validation for background vs color fields
- **Why**: Prevents security issues while allowing admin design flexibility
- **How**: Created `isValidColorOrCSS()` method for background fields, kept strict hex validation
  for color fields

### Compliance Check

- **Coding Standards**: ✓ Follows project TypeScript and ESLint standards
- **Project Structure**: ✓ Proper controller/service/validator/routes separation
- **Testing Strategy**: ✓ Comprehensive integration tests with security scenarios
- **All ACs Met**: ✓ All acceptance criteria functionally implemented

### Improvements Checklist

**Completed during review:**

- [x] Fixed CSS gradient validation in themes service (critical bug)
- [x] Enhanced field-specific validation for security and flexibility

**Remaining issues for dev team:**

- [x] Fix UUID validation error handling (returns 500 instead of 400)
- [x] Fix update method error handling in admin controller
- [x] Add input validation error responses to match expected API format

### Security Review

**Excellent security implementation:**

- ✓ Admin-only endpoints with proper JWT + role validation
- ✓ CSS safety validation blocks malicious `javascript:`, `@import`, XSS attempts
- ✓ WCAG accessibility contrast ratio validation (3:1 minimum)
- ✓ Theme size limits (50KB) prevent resource abuse
- ✓ Comprehensive input sanitization and validation

### Performance Considerations

**Well-optimized for admin operations:**

- ✓ Isolated `/api/admin/themes` routes don't affect existing APIs
- ✓ Validation is fast and secure
- ✓ Repository pattern enables efficient database operations
- ✓ Admin-only usage means minimal performance impact

### Files Modified During Review

- `apps/api/src/services/themes.service.ts` - Fixed validation for CSS gradients

### Gate Status

Gate: **PASS** → docs/qa/gates/22.2-admin-theme-api-endpoints-validation.yml

### Recommended Status

**✓ Ready for Done** - All QA issues have been resolved, tests passing (26/26), comprehensive
security implementation

---

## Dev Agent Record

### Agent Model Used

Claude 4 (Sonnet 4)

### Debug Log References

- Test execution:
  `npm --workspace=apps/api run test -- --testPathPatterns="admin-themes-api.test.ts"`
- TypeScript checking: `npm --workspace=apps/api run typecheck`
- All 26 integration tests passing after fixes

### Completion Notes List

1. **UUID Validation Fix**: Added proper validation error handling in `getThemeById` and
   `deleteTheme` methods to return 400 instead of 500 for invalid UUIDs
2. **Update Method Fix**:
   - Fixed unique constraint violation handling in `updateTheme` method to return 400 instead of 500
     for duplicate theme names
   - Added `themeDefinition` update logic to maintain simplified admin format consistency
   - Fixed test to use unique theme names with timestamps to prevent conflicts
3. **Error Response Format**: Ensured all error responses follow the expected API contract format
   with proper status codes

### File List

**Modified Files:**

- `apps/api/src/controllers/admin-themes.controller.ts` - Added validation error handling and
  improved update logic
- `apps/api/tests/integration/admin-themes-api.test.ts` - Fixed test to use unique theme names

## Change Log

### 2025-10-16 - QA Fixes Applied

- **Fixed TEST-001**: UUID validation now returns 400 instead of 500 error code
- **Fixed TEST-002**: Update method now handles unique constraint violations properly and returns
  200 on successful updates
- **Fixed TEST-003**: All 3 failing integration tests now pass (26/26 passing)
- **Quality**: All QA gate issues resolved, TypeScript validation passes

## Status

Status: Ready for Done
