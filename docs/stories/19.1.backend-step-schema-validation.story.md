# Story 19.1: Backend - Step Schema Support and Validation

## Status

Draft

## Story

**As a** form builder backend system, **I want** to support step form schema validation and type
definitions, **so that** step forms can be properly validated, stored, and processed while
maintaining backward compatibility with single-page forms.

## Acceptance Criteria

1. New types compile without errors across frontend and backend
2. Validation accepts step form schemas with 2-10 steps
3. Validation rejects invalid step configurations (e.g., duplicate step IDs, missing required
   fields)
4. Existing forms without `stepForm` property continue to validate successfully
5. Migration helper successfully converts single-page form to step form structure
6. All existing backend tests pass
7. New tests achieve >80% coverage for step-related code

## Tasks / Subtasks

- [ ] **Task 1: Extend shared form types** (AC: 1, 4)
  - [ ] Add `FormStep` interface to `packages/shared/src/types/forms.types.ts`:
    - `id: string` (UUID v4)
    - `title: string` (1-100 characters)
    - `description?: string` (optional, max 500 characters)
    - `order: number` (0-based index)
  - [ ] Add `StepFormConfig` interface:
    - `enabled: boolean` (whether step mode is active)
    - `steps: FormStep[]` (array of steps)
  - [ ] Extend `FormSettings` interface with optional `stepForm?: StepFormConfig` property
  - [ ] Extend `FieldPosition` interface with optional `stepId?: string` property
  - [ ] Add JSDoc comments for all new interfaces and properties
  - [ ] Run `npm run build:shared` to compile shared package

- [ ] **Task 2: Backend validation for step configurations** (AC: 2, 3)
  - [ ] Update `apps/api/src/validators/forms.validator.ts`:
    - Add `stepFormConfigSchema` validation schema using express-validator
    - Validate step count: 2-10 steps when enabled
    - Validate step IDs are unique within form
    - Validate step titles are non-empty strings (1-100 characters)
    - Validate step order indices are sequential (0, 1, 2, ...)
    - Validate field `position.stepId` references valid step ID (when provided)
  - [ ] Add validation middleware to forms routes for step-specific endpoints

- [ ] **Task 3: Service layer step validation logic** (AC: 2, 3, 4)
  - [ ] Update `apps/api/src/services/forms.service.ts`:
    - Add `validateStepFormConfiguration(schema: FormSchema): void` method
    - Implement validation for step-specific field positions
    - Ensure backward compatibility: skip step validation if `stepForm.enabled === false` or
      undefined
    - Add method `isStepFormEnabled(schema: FormSchema): boolean` helper
  - [ ] Handle step-related business logic in create/update methods
  - [ ] Add JSDoc comments for all new service methods

- [ ] **Task 4: Migration helper function** (AC: 5)
  - [ ] Create `apps/api/src/utils/form-migration.utils.ts`:
    - Add `convertSinglePageToStepForm(schema: FormSchema, stepTitle?: string): FormSchema` function
    - Create default step with ID and title
    - Assign all existing fields to default step via `position.stepId`
    - Set `stepForm.enabled = true` and add step to `steps` array
    - Maintain existing row layout configurations
    - Return updated schema
  - [ ] Add comprehensive JSDoc documentation with examples
  - [ ] Export function from utils index

- [ ] **Task 5: Unit tests for step validation** (AC: 2, 3, 6, 7)
  - [ ] Create `apps/api/tests/unit/validators/step-forms.validator.test.ts`:
    - Test valid step configurations (2, 5, 10 steps)
    - Test rejection of invalid step counts (0, 1, 11+ steps)
    - Test duplicate step ID detection
    - Test missing required step fields
    - Test invalid step order sequences
  - [ ] Create `apps/api/tests/unit/services/step-forms.service.test.ts`:
    - Test `validateStepFormConfiguration` with valid/invalid schemas
    - Test `isStepFormEnabled` helper
    - Test backward compatibility (forms without stepForm property)
    - Test field position validation (valid/invalid stepId references)
  - [ ] Create `apps/api/tests/unit/utils/form-migration.test.ts`:
    - Test conversion from single-page to step form
    - Test field position updates
    - Test preservation of existing configurations
  - [ ] Run tests and verify >80% coverage for new code

- [ ] **Task 6: Update API documentation** (AC: 1)
  - [ ] Update Swagger/OpenAPI specs in controllers with JSDoc:
    - Document new `stepForm` configuration in form schemas
    - Document step-related request/response formats
    - Add examples for step form creation/update
  - [ ] Verify Swagger UI displays step form documentation at `/api-docs`

- [ ] **Task 7: Integration testing** (AC: 6, 7)
  - [ ] Run all existing backend tests: `npm --workspace=apps/api run test`
  - [ ] Verify no regressions in existing form functionality
  - [ ] Fix any failing tests
  - [ ] Generate coverage report: `npm --workspace=apps/api run test:coverage`
  - [ ] Verify overall coverage >80%

## Dev Notes

### Testing Standards

[Source: docs/architecture/testing-strategy.md]

**Test Location:**

- Unit tests: `apps/api/tests/unit/` organized by type (validators/, services/, utils/)
- Integration tests: `apps/api/tests/integration/` for API endpoint testing
- Test files use `.test.ts` extension alongside implementation files

**Test Framework:**

- Jest with TypeScript support
- Supertest for API integration testing
- Test coverage reports available with `npm --workspace=apps/api run test:coverage`
- Minimum 80% coverage requirement for new code

**Testing Pattern Example:**

```typescript
describe('Step Form Validation', () => {
  beforeEach(async () => {
    // Setup test data
  });

  it('should accept valid step configuration with 2-10 steps', async () => {
    // Test implementation
  });

  it('should reject duplicate step IDs', async () => {
    // Test implementation
  });
});
```

### Type Sharing Architecture

[Source: docs/architecture/coding-standards.md#critical-fullstack-rules]

- **CRITICAL:** Always define types in `packages/shared/src/types/` and import from
  `@nodeangularfullstack/shared`
- Never duplicate type definitions between frontend and backend
- Run `npm run build:shared` after modifying shared types to compile for both packages
- Types must include comprehensive JSDoc comments for all public interfaces

### Backend Architecture Patterns

[Source: docs/architecture/backend-architecture.md]

**Service Layer (apps/api/src/services/):**

- Business logic and validation
- Methods should be focused and testable
- Use dependency injection for repositories
- Return structured responses

**Validation Layer (apps/api/src/validators/):**

- Express-validator for input validation
- Validation schemas co-located with controllers
- Validation middleware applied in routes
- Custom validators for complex rules

**Repository Pattern (apps/api/src/repositories/):**

- Data access layer for PostgreSQL queries
- Extends BaseRepository<T> for common operations
- Parameterized queries to prevent SQL injection
- Supports tenant isolation when multi-tenancy enabled

### Form Schema Structure

[Source: packages/shared/src/types/forms.types.ts]

**Current Relevant Interfaces:**

```typescript
interface FormSettings {
  layout: FormLayout;
  submission: FormSubmissionConfig;
  background?: FormBackgroundSettings;
  rowLayout?: {
    enabled: boolean;
    rows: RowLayoutConfig[];
  };
  // NEW: stepForm property will be added here
}

interface FieldPosition {
  rowId: string;
  columnIndex: number;
  orderInColumn?: number;
  // NEW: stepId property will be added here
}

interface FormField {
  id: string;
  type: FormFieldType;
  label: string;
  fieldName: string;
  // ... other properties ...
  position?: FieldPosition;
}
```

**New Interfaces to Add:**

```typescript
interface FormStep {
  id: string; // UUID v4
  title: string; // 1-100 characters
  description?: string; // Optional, max 500 characters
  order: number; // 0-based sequential index
}

interface StepFormConfig {
  enabled: boolean; // Whether step mode is active
  steps: FormStep[]; // Array of 2-10 steps
}
```

### Database Considerations

[Source: docs/architecture/database-schema.md, Epic 19 context]

- Database schema for `forms`, `form_schemas`, `form_submissions` tables remains unchanged
- Step configuration stored in `form_schemas.schema` JSONB column (already supports nested objects)
- No database migrations required for this story
- Backward compatibility maintained: existing forms without `stepForm` property continue to function

### Project Structure

[Source: docs/architecture/unified-project-structure.md]

**Relevant File Locations:**

```
packages/shared/src/types/forms.types.ts  # Shared type definitions
apps/api/src/
├── validators/forms.validator.ts         # Input validation
├── services/forms.service.ts              # Business logic
├── utils/form-migration.utils.ts          # Migration helpers
└── tests/
    ├── unit/
    │   ├── validators/step-forms.validator.test.ts
    │   ├── services/step-forms.service.test.ts
    │   └── utils/form-migration.test.ts
    └── integration/
        └── forms.test.ts                   # Existing integration tests
```

### Validation Requirements

[Source: docs/architecture/coding-standards.md#critical-fullstack-rules]

- **Input Validation:** Validate all user input on both frontend and backend
- **Database Queries:** Use parameterized queries to prevent SQL injection
- **Error Handling:** All API routes must use the standard error handler
- **Documentation:** All public functions, interfaces, and classes MUST have JSDoc comments

### Backward Compatibility Strategy

[Source: Epic 19 Description]

**Key Principles:**

1. Step configuration is **optional** - forms without `stepForm` property continue to work
2. Feature flag approach: step forms only activate when `settings.stepForm.enabled === true`
3. Separate validation logic paths for step vs. single-page forms
4. Graceful degradation: missing `stepId` in field positions defaults to single-page behavior
5. All existing tests must pass without modification

**Implementation Pattern:**

```typescript
function validateFormSchema(schema: FormSchema): void {
  // Common validation (always runs)
  validateCommonFields(schema);

  // Step-specific validation (only if enabled)
  if (isStepFormEnabled(schema)) {
    validateStepFormConfiguration(schema);
  }

  // Continue with standard validation...
}
```

### Tech Stack

[Source: docs/architecture/tech-stack.md]

- **Backend Framework:** Express.js 4.19+ with TypeScript 5.3+
- **Database:** PostgreSQL 15+ with JSONB support
- **Testing:** Jest 29+ with Supertest 6+
- **Validation:** express-validator (latest)
- **API Documentation:** Swagger/OpenAPI 3.0

### API Documentation Standards

[Source: docs/architecture/coding-standards.md#documentation-standards]

**JSDoc Requirements for Controllers:**

```typescript
/**
 * Updates form schema with step configuration.
 * @param req - Express request with form schema data
 * @param res - Express response
 * @param next - Express next function
 * @returns Updated form schema with step configuration
 * @throws {ApiError} 400 - Invalid step configuration
 * @throws {ApiError} 404 - Form not found
 */
updateFormWithSteps = AsyncHandler(async (req, res, next) => {
  // Implementation
});
```

## Change Log

| Date       | Version | Description         | Author       |
| ---------- | ------- | ------------------- | ------------ |
| 2025-10-13 | 1.0     | Initial story draft | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent during implementation_

### Debug Log References

_To be populated by Dev Agent during implementation_

### Completion Notes List

_To be populated by Dev Agent during implementation_

### File List

_To be populated by Dev Agent during implementation_

## QA Results

_To be populated by QA Agent after review_
