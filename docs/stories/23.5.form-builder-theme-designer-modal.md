# Story 23.5: Form Builder Theme Designer Modal Wizard

## Status

Draft

## Story

**As a** form creator, **I want** to create custom themes from the Form Builder, **so that** I can
design unique form styling without leaving my workflow.

## Acceptance Criteria

1. Add "Build Your Own Custom Color Theme" button to theme dropdown footer
2. Create `ThemeDesignerModalComponent` with PrimeNG Dialog
3. Implement 5-step wizard with stepper component:
   - **Step 1**: Color selection (primary, secondary color pickers)
   - **Step 2**: Background (solid color, linear gradient, radial gradient, image upload)
   - **Step 3**: Typography (heading font, body font dropdowns)
   - **Step 4**: Field styling (border radius slider, spacing inputs)
   - **Step 5**: Preview & Save (real-time preview, name input, save button)
4. Real-time preview updates within 300ms of changes
5. Save creates theme via `POST /api/themes`
6. Successful save applies theme to current form and closes modal
7. Cancel button discards changes without saving
8. Modal state isolated from Form Builder state (no data loss)

## Tasks / Subtasks

- [ ] Task 1: Add Theme Creation Button to Theme Dropdown (AC: 1)
  - [ ] Open
        `apps/web/src/app/features/tools/components/form-builder/theme-dropdown/theme-dropdown.component.ts`
  - [ ] Add "Build Your Own Custom Color Theme" button to dropdown footer template
  - [ ] Style button with PrimeNG Button component: `p-button-outlined p-button-primary`
  - [ ] Add click handler: `openThemeDesigner()`
  - [ ] Emit event to parent FormBuilderComponent to open modal
  - [ ] Write unit test: "should emit openThemeDesigner event when button clicked"

- [ ] Task 2: Create ThemeDesignerModalComponent Shell (AC: 2)
  - [ ] Generate component:
        `apps/web/src/app/features/tools/components/form-builder/theme-designer-modal/theme-designer-modal.component.ts`
  - [ ] Import PrimeNG Dialog module: `DialogModule` from `primeng/dialog`
  - [ ] Import PrimeNG Stepper module: `StepperModule` from `primeng/stepper`
  - [ ] Create modal template with `p-dialog` wrapper:
    - Set `[(visible)]` to bind to modal visibility signal
    - Set `[modal]="true"` for backdrop
    - Set `[closable]="true"` for close button
    - Set responsive sizes: `[style]="{width: '900px'}"` with `@media` breakpoints
  - [ ] Create `ThemeDesignerModalService` for state management
  - [ ] Add `@Input() visible` signal and `@Output() visibleChange` emitter
  - [ ] Write unit test: "should render p-dialog when visible is true"

- [ ] Task 3: Implement 5-Step Wizard with Stepper (AC: 3)
  - [ ] Add PrimeNG Stepper to modal dialog content
  - [ ] Create 5 step components in `steps/` subdirectory:
    - `color-step.component.ts` (Step 1: Primary/Secondary colors)
    - `background-step.component.ts` (Step 2: Background options)
    - `typography-step.component.ts` (Step 3: Font selection)
    - `styling-step.component.ts` (Step 4: Border radius, spacing)
    - `preview-step.component.ts` (Step 5: Preview & Save)
  - [ ] Configure stepper with step labels: "Colors", "Background", "Typography", "Styling",
        "Preview"
  - [ ] Add "Next" and "Previous" navigation buttons to each step
  - [ ] Add step validation (prevent "Next" if required fields empty)
  - [ ] Write unit test: "should render all 5 steps in stepper"
  - [ ] Write unit test: "should navigate between steps with Next/Previous buttons"

- [ ] Task 4: Implement Step 1 - Color Selection (AC: 3.1)
  - [ ] Create `color-step.component.ts` with color picker inputs
  - [ ] Import PrimeNG ColorPicker: `ColorPickerModule` from `primeng/colorpicker`
  - [ ] Add form fields:
    - Primary Color: `<p-colorPicker [(ngModel)]="primaryColor" [inline]="false">`
    - Secondary Color: `<p-colorPicker [(ngModel)]="secondaryColor" [inline]="false">`
  - [ ] Bind to theme designer service state
  - [ ] Add color preview swatches showing selected colors
  - [ ] Add validation: Both colors required to proceed to next step
  - [ ] Write unit test: "should require primary and secondary colors"
  - [ ] Write unit test: "should update theme preview when colors change"

- [ ] Task 5: Implement Step 2 - Background Selection (AC: 3.2)
  - [ ] Create `background-step.component.ts` with background options
  - [ ] Add radio button group for background type:
    - Solid Color (color picker)
    - Linear Gradient (two color pickers + angle input)
    - Radial Gradient (two color pickers + position dropdown)
    - Image Upload (file input + preview)
  - [ ] Import PrimeNG RadioButton: `RadioButtonModule` from `primeng/radiobutton`
  - [ ] Import PrimeNG FileUpload: `FileUploadModule` from `primeng/fileupload`
  - [ ] Add gradient angle slider (0-360 degrees) for linear gradient
  - [ ] Add gradient position dropdown (center, top-left, etc.) for radial gradient
  - [ ] Show live preview of background in preview panel
  - [ ] Write unit test: "should switch between background types"
  - [ ] Write unit test: "should upload and preview background image"

- [ ] Task 6: Implement Step 3 - Typography Selection (AC: 3.3)
  - [ ] Create `typography-step.component.ts` with font selection
  - [ ] Import PrimeNG Dropdown: `DropdownModule` from `primeng/dropdown`
  - [ ] Add dropdown for heading font (Google Fonts list):
    - Options: Roboto, Open Sans, Lato, Montserrat, Poppins, etc.
  - [ ] Add dropdown for body font (Google Fonts list)
  - [ ] Add number inputs for font sizes:
    - Heading font size (default: 24px)
    - Body font size (default: 16px)
  - [ ] Load Google Fonts dynamically when selected
  - [ ] Show preview text in selected fonts
  - [ ] Write unit test: "should load Google Fonts when font selected"
  - [ ] Write unit test: "should update preview with selected fonts"

- [ ] Task 7: Implement Step 4 - Field Styling (AC: 3.4)
  - [ ] Create `styling-step.component.ts` with field styling options
  - [ ] Import PrimeNG Slider: `SliderModule` from `primeng/slider`
  - [ ] Add slider for border radius (0-20px)
  - [ ] Add number inputs for field spacing:
    - Field padding (default: 12px)
    - Field margin (default: 8px)
  - [ ] Add number input for border width (1-5px)
  - [ ] Show preview of styled input field
  - [ ] Write unit test: "should update field styling in preview"

- [ ] Task 8: Implement Step 5 - Preview & Save (AC: 3.5)
  - [ ] Create `preview-step.component.ts` with preview and save
  - [ ] Embed FormRendererComponent in preview mode
  - [ ] Create sample form schema with all field types:
    - Text input, textarea, select, radio, checkbox, date
  - [ ] Apply theme CSS variables to preview form using ThemePreviewService
  - [ ] Add text input for theme name (required, max 50 chars)
  - [ ] Add "Save Theme" button (primary, full width)
  - [ ] Add "Cancel" button (secondary, outlined)
  - [ ] Show loading spinner while saving theme
  - [ ] Write unit test: "should require theme name before saving"
  - [ ] Write unit test: "should show preview with theme applied"

- [ ] Task 9: Implement Real-Time Preview with ThemePreviewService (AC: 4)
  - [ ] Use existing `ThemePreviewService` from Epic 20
  - [ ] Create computed signal for theme object: `currentTheme = computed(() => ({ ... }))`
  - [ ] Watch for changes in any step (colors, background, typography, styling)
  - [ ] Update ThemePreviewService CSS variables on change
  - [ ] Use RxJS `debounceTime(300)` to limit update frequency
  - [ ] Apply CSS variables to preview form in Step 5
  - [ ] Add `.theme-transition` class for smooth updates
  - [ ] Write unit test: "should debounce preview updates to 300ms"
  - [ ] Write unit test: "should apply theme variables to preview form"

- [ ] Task 10: Implement Theme Save via API (AC: 5, 6)
  - [ ] Create `saveTheme()` method in ThemeDesignerModalService
  - [ ] Build theme object from wizard state:
    ```typescript
    {
      name: themeName,
      primaryColor: primaryColor,
      secondaryColor: secondaryColor,
      backgroundColor: backgroundConfig,
      headingFont: headingFont,
      bodyFont: bodyFont,
      fieldPadding: fieldPadding,
      borderRadius: borderRadius
    }
    ```
  - [ ] Call `POST /api/themes` via FormsApiService
  - [ ] Handle success: Emit `themeSaved` event with new theme ID
  - [ ] Handle error: Show error toast with PrimeNG MessageService
  - [ ] On success in FormBuilderComponent:
    - Add new theme to theme list
    - Apply theme to current form (`settings.themeId = newThemeId`)
    - Close modal
  - [ ] Write unit test: "should call POST /api/themes with theme data"
  - [ ] Write unit test: "should emit themeSaved event on success"
  - [ ] Write unit test: "should show error toast on API failure"

- [ ] Task 11: Implement Cancel and Modal Close Logic (AC: 7, 8)
  - [ ] Add `cancel()` method in ThemeDesignerModalService
  - [ ] Confirm dialog if user has unsaved changes: "Discard theme? Changes will be lost."
  - [ ] Use PrimeNG ConfirmDialog: `ConfirmDialogModule` from `primeng/confirmdialog`
  - [ ] On confirm: Reset wizard state and close modal
  - [ ] On cancel: Keep modal open
  - [ ] Ensure FormBuilderComponent state NOT affected by modal
  - [ ] Verify form fields, settings, and canvas remain unchanged after modal close
  - [ ] Write unit test: "should show confirm dialog when canceling with unsaved changes"
  - [ ] Write unit test: "should reset wizard state on cancel"
  - [ ] Write integration test: "should not affect form builder state after modal close"

- [ ] Task 12: Add Responsive Modal Sizing (NFR1 from Epic)
  - [ ] Add responsive CSS for modal dialog:
    - Desktop (â‰¥1024px): `width: 900px`
    - Tablet (768-1023px): `width: 700px`
    - Mobile (<768px): `width: 100vw, height: 100vh` (full-screen)
  - [ ] Use `[breakpoints]` property on `p-dialog`:
    ```typescript
    [breakpoints] = "{'1024px': '900px', '768px': '700px', '0px': '100vw'}";
    ```
  - [ ] Test modal rendering on all three viewport sizes
  - [ ] Verify stepper layout adapts to mobile (vertical stacking)
  - [ ] Write visual regression test for responsive modal

- [ ] Task 13: Integrate Modal into FormBuilderComponent (AC: 1, 6)
  - [ ] Open `apps/web/src/app/features/tools/components/form-builder/form-builder.component.ts`
  - [ ] Import ThemeDesignerModalComponent
  - [ ] Add modal visibility signal: `themeDesignerVisible = signal(false)`
  - [ ] Add method: `openThemeDesigner()` to set visibility to true
  - [ ] Handle `themeSaved` event from modal:
    - Add new theme to theme list
    - Apply theme to form settings:
      `this.formSettingsSignal.update(s => ({ ...s, themeId: newThemeId }))`
    - Show success toast: "Theme created successfully!"
  - [ ] Add ThemeDesignerModalComponent to template:
    ```html
    <app-theme-designer-modal
      [(visible)]="themeDesignerVisible"
      (themeSaved)="onThemeSaved($event)"
    />
    ```
  - [ ] Write integration test: "should open modal when theme dropdown emits openThemeDesigner"
  - [ ] Write integration test: "should apply new theme to form on themeSaved"

- [ ] Task 14: Write Component Unit Tests (AC: All)
  - [ ] Test ThemeDesignerModalComponent:
    - "should render modal when visible is true"
    - "should hide modal when visible is false"
    - "should render 5-step stepper"
    - "should navigate between steps"
    - "should validate required fields before step progression"
  - [ ] Test ColorStepComponent:
    - "should require primary and secondary colors"
    - "should update theme preview on color change"
  - [ ] Test BackgroundStepComponent:
    - "should switch between background types"
    - "should handle image upload"
    - "should calculate gradient CSS correctly"
  - [ ] Test TypographyStepComponent:
    - "should load Google Fonts dynamically"
    - "should update preview fonts"
  - [ ] Test StylingStepComponent:
    - "should update border radius in preview"
    - "should update field padding in preview"
  - [ ] Test PreviewStepComponent:
    - "should require theme name"
    - "should show preview with all field types"
    - "should apply theme to preview form"
  - [ ] Run tests:
        `npm --workspace=apps/web run test -- --include="**/theme-designer-modal/**/*.spec.ts"`

- [ ] Task 15: Write Integration Tests (AC: All)
  - [ ] Create test file: `theme-designer-modal.integration.spec.ts`
  - [ ] Test: "should complete full wizard flow and create theme"
    - Open modal
    - Fill out all 5 steps
    - Save theme
    - Verify API called with correct data
    - Verify modal closes
    - Verify theme applied to form
  - [ ] Test: "should cancel wizard without saving"
    - Open modal
    - Make changes in step 1
    - Click Cancel
    - Confirm discard
    - Verify modal closes
    - Verify no API call made
    - Verify form unchanged
  - [ ] Test: "should prevent navigation without required fields"
    - Open modal
    - Try to proceed from Step 1 without colors
    - Verify error message shown
    - Verify step does not advance
  - [ ] Run tests:
        `npm --workspace=apps/web run test -- --include="**/theme-designer-modal.integration.spec.ts"`

- [ ] Task 16: Manual Testing and QA
  - [ ] Start dev environment: `npm start`
  - [ ] Navigate to Form Builder
  - [ ] Open theme dropdown
  - [ ] Click "Build Your Own Custom Color Theme" button
  - [ ] Complete wizard with sample theme:
    - Step 1: Primary = #3B82F6, Secondary = #10B981
    - Step 2: Linear gradient (blue to green, 45deg)
    - Step 3: Heading = Montserrat, Body = Open Sans
    - Step 4: Border radius = 8px, Padding = 16px
    - Step 5: Name = "Ocean Breeze", Save
  - [ ] Verify theme appears in theme dropdown
  - [ ] Verify theme applied to form canvas
  - [ ] Test canceling wizard with unsaved changes
  - [ ] Test responsive modal on mobile, tablet, desktop
  - [ ] Test real-time preview updates (should be < 300ms)
  - [ ] Run linter: `npm --workspace=apps/web run lint`
  - [ ] Run typecheck: `npm --workspace=apps/web run typecheck`
  - [ ] Run build: `npm --workspace=apps/web run build`

## Dev Notes

### Previous Story Insights

**From Story 23.2 Completion:** The API authentication has been updated to allow all authenticated
users to create themes via `POST /api/themes`. The admin-only restriction has been removed, and
creator-or-admin middleware has been added for edit/delete operations.

**From Story 23.3 Completion:** All theme utility classes have been defined in
`apps/web/src/styles/theme-variables.css`. The ThemePreviewService from Epic 20 is already
functional and injects CSS variables into the DOM for real-time theme preview.

**Key Dependencies:**

- âœ… Story 23.2 must be complete (API allows non-admin theme creation)
- âœ… Story 23.3 must be complete (theme utility classes defined)
- âœ… Epic 20 ThemePreviewService functional (CSS variable injection)

### Tech Stack

**Frontend Framework:** [Source: docs/architecture/tech-stack.md]

- **Angular 20+**: Standalone components (no NgModules)
- **TypeScript 5.3+**: Strict mode enabled
- **PrimeNG 17+**: UI component library
- **NgRx Signals**: Reactive state management
- **RxJS**: Reactive programming for async operations

**PrimeNG Components Used:** [Source: docs/architecture/tech-stack.md,
docs/prd/epic-23-complete-theme-system.md#technical-approach]

```typescript
import { DialogModule } from 'primeng/dialog';
import { StepperModule } from 'primeng/stepper';
import { ColorPickerModule } from 'primeng/colorpicker';
import { RadioButtonModule } from 'primeng/radiobutton';
import { FileUploadModule } from 'primeng/fileupload';
import { DropdownModule } from 'primeng/dropdown';
import { SliderModule } from 'primeng/slider';
import { ConfirmDialogModule } from 'primeng/confirmdialog';
import { MessageService } from 'primeng/api';
```

### Frontend Architecture

**Component Organization:** [Source: docs/architecture/frontend-architecture.md,
docs/architecture/unified-project-structure.md]

```plaintext
apps/web/src/app/features/tools/components/form-builder/
â”œâ”€â”€ theme-dropdown/
â”‚   â””â”€â”€ theme-dropdown.component.ts          # Add "Build Your Own" button here
â”œâ”€â”€ theme-designer-modal/
â”‚   â”œâ”€â”€ theme-designer-modal.component.ts    # Main modal component (NEW)
â”‚   â”œâ”€â”€ theme-designer-modal.component.html  # Modal template (NEW)
â”‚   â”œâ”€â”€ theme-designer-modal.component.scss  # Modal styles (NEW)
â”‚   â”œâ”€â”€ theme-designer-modal.component.spec.ts # Unit tests (NEW)
â”‚   â”œâ”€â”€ theme-designer-modal.service.ts      # Modal state management (NEW)
â”‚   â”œâ”€â”€ theme-designer-modal.service.spec.ts # Service tests (NEW)
â”‚   â””â”€â”€ steps/                               # Step components (NEW)
â”‚       â”œâ”€â”€ color-step.component.ts          # Step 1: Colors
â”‚       â”œâ”€â”€ background-step.component.ts     # Step 2: Background
â”‚       â”œâ”€â”€ typography-step.component.ts     # Step 3: Typography
â”‚       â”œâ”€â”€ styling-step.component.ts        # Step 4: Field Styling
â”‚       â””â”€â”€ preview-step.component.ts        # Step 5: Preview & Save
â””â”€â”€ form-builder.component.ts                # Integrate modal here
```

**Component Template Pattern:** [Source:
docs/architecture/frontend-architecture.md#component-template]

```typescript
import { Component, ChangeDetectionStrategy, Signal, computed, signal } from '@angular/core';
import { CommonModule } from '@angular/common';

@Component({
  selector: 'app-theme-designer-modal',
  standalone: true,
  imports: [CommonModule, DialogModule, StepperModule /* ... */],
  template: `
    <p-dialog
      [(visible)]="visible"
      [modal]="true"
      [closable]="true"
      [style]="{ width: '900px' }"
      [breakpoints]="{ '1024px': '900px', '768px': '700px', '0px': '100vw' }"
    >
      <p-stepper>
        <!-- 5 steps here -->
      </p-stepper>
    </p-dialog>
  `,
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class ThemeDesignerModalComponent {
  protected readonly visible = signal(false);
  protected readonly currentStep = signal(0);
  protected readonly themeData = signal<Partial<Theme>>({});
  // ...
}
```

### State Management

**Modal State Service Pattern:** [Source:
docs/architecture/frontend-architecture.md#state-management-patterns]

```typescript
// theme-designer-modal.service.ts
import { Injectable, signal, computed } from '@angular/core';
import { FormsApiService } from '../forms-api.service';

@Injectable()
export class ThemeDesignerModalService {
  // Wizard state
  private readonly step = signal(0);
  private readonly themeName = signal('');
  private readonly primaryColor = signal('#3B82F6');
  private readonly secondaryColor = signal('#10B981');
  private readonly backgroundType = signal<'solid' | 'linear' | 'radial' | 'image'>('solid');
  private readonly backgroundColor = signal('#FFFFFF');
  // ... other fields

  // Computed theme object
  readonly currentTheme = computed(() => ({
    name: this.themeName(),
    primaryColor: this.primaryColor(),
    secondaryColor: this.secondaryColor(),
    backgroundType: this.backgroundType(),
    backgroundColor: this.backgroundColor(),
    // ... other fields
  }));

  // Validation
  readonly canProceedToNextStep = computed(() => {
    const currentStep = this.step();
    if (currentStep === 0) {
      // Step 1: Colors required
      return this.primaryColor() && this.secondaryColor();
    }
    // ... other step validations
    return true;
  });

  constructor(private formsApiService: FormsApiService) {}

  nextStep() {
    if (this.canProceedToNextStep()) {
      this.step.update((s) => s + 1);
    }
  }

  previousStep() {
    this.step.update((s) => Math.max(0, s - 1));
  }

  async saveTheme() {
    const theme = this.currentTheme();
    return this.formsApiService.createTheme(theme);
  }

  reset() {
    this.step.set(0);
    this.themeName.set('');
    this.primaryColor.set('#3B82F6');
    // ... reset other fields
  }
}
```

### API Integration

**Theme Creation Endpoint:** [Source: docs/prd/epic-23-complete-theme-system.md#technical-approach]

```typescript
// POST /api/themes
// Request Body:
{
  name: string;              // Required, max 50 chars
  primaryColor: string;      // Hex color, e.g., "#3B82F6"
  secondaryColor: string;    // Hex color
  backgroundColor: string;   // Hex color or CSS gradient
  backgroundType: 'solid' | 'linear' | 'radial' | 'image';
  backgroundImageUrl?: string; // Optional, if backgroundType = 'image'
  gradientAngle?: number;    // Optional, if backgroundType = 'linear' (0-360)
  gradientPosition?: string; // Optional, if backgroundType = 'radial' (center, top-left, etc.)
  headingFont: string;       // Google Font name, e.g., "Montserrat"
  bodyFont: string;          // Google Font name
  headingFontSize: number;   // Default: 24
  bodyFontSize: number;      // Default: 16
  borderRadius: number;      // Default: 8 (0-20)
  fieldPadding: number;      // Default: 12
  fieldMargin: number;       // Default: 8
  borderWidth: number;       // Default: 1 (1-5)
}

// Response:
{
  id: string;                // UUID
  name: string;
  created_by: string;        // User ID
  created_at: string;        // ISO timestamp
  // ... all theme properties
}
```

**FormsApiService Method:** [Source: docs/architecture/frontend-architecture.md#service-example]

```typescript
// apps/web/src/app/features/tools/components/form-builder/forms-api.service.ts
import { Injectable, inject } from '@angular/core';
import { ApiClient } from '@core/api/api.client';
import { Observable } from 'rxjs';
import { Theme } from '@nodeangularfullstack/shared';

@Injectable({ providedIn: 'root' })
export class FormsApiService {
  private readonly api = inject(ApiClient);

  createTheme(themeData: Partial<Theme>): Observable<Theme> {
    return this.api.post<Theme>('/themes', themeData);
  }

  // ... other methods
}
```

### Real-Time Preview Implementation

**Using ThemePreviewService:** [Source:
docs/prd/epic-23-complete-theme-system.md#what-gets-kept-epic-20]

Epic 20's `ThemePreviewService` injects CSS variables into the DOM for live theme preview. Reuse
this service for real-time updates in the modal.

```typescript
// theme-designer-modal.component.ts
import { ThemePreviewService } from '../theme-preview.service';
import { effect } from '@angular/core';
import { debounceTime } from 'rxjs/operators';

export class ThemeDesignerModalComponent {
  private readonly themePreviewService = inject(ThemePreviewService);
  private readonly modalService = inject(ThemeDesignerModalService);

  constructor() {
    // Watch for theme changes and update preview (debounced to 300ms)
    effect(() => {
      const theme = this.modalService.currentTheme();
      setTimeout(() => {
        this.themePreviewService.applyTheme(theme);
      }, 300); // Debounce to 300ms
    });
  }
}
```

### Google Fonts Integration

**Loading Fonts Dynamically:**

```typescript
// typography-step.component.ts
loadGoogleFont(fontName: string) {
  const link = document.createElement('link');
  link.href = `https://fonts.googleapis.com/css2?family=${fontName.replace(' ', '+')}:wght@400;600;700&display=swap`;
  link.rel = 'stylesheet';
  document.head.appendChild(link);
}

// Available fonts list
readonly availableFonts = [
  'Roboto',
  'Open Sans',
  'Lato',
  'Montserrat',
  'Poppins',
  'Raleway',
  'Inter',
  'Nunito',
  'Source Sans Pro',
  'PT Sans'
];
```

### Responsive Modal Design

**Breakpoint Configuration:** [Source:
docs/prd/epic-23-complete-theme-system.md#non-functional-requirements]

```scss
// theme-designer-modal.component.scss
::ng-deep .theme-designer-dialog {
  // Desktop (â‰¥1024px)
  @media (min-width: 1024px) {
    width: 900px !important;
  }

  // Tablet (768-1023px)
  @media (min-width: 768px) and (max-width: 1023px) {
    width: 700px !important;
  }

  // Mobile (<768px)
  @media (max-width: 767px) {
    width: 100vw !important;
    height: 100vh !important;
    max-height: 100vh !important;
  }
}
```

### Background Gradient Calculation

**CSS Gradient Generation:**

```typescript
// background-step.component.ts
calculateBackgroundCSS(): string {
  const type = this.backgroundType();

  if (type === 'solid') {
    return this.backgroundColor();
  }

  if (type === 'linear') {
    const color1 = this.gradientColor1();
    const color2 = this.gradientColor2();
    const angle = this.gradientAngle();
    return `linear-gradient(${angle}deg, ${color1}, ${color2})`;
  }

  if (type === 'radial') {
    const color1 = this.gradientColor1();
    const color2 = this.gradientColor2();
    const position = this.gradientPosition();
    return `radial-gradient(circle at ${position}, ${color1}, ${color2})`;
  }

  if (type === 'image') {
    const url = this.backgroundImageUrl();
    return `url(${url})`;
  }

  return '#FFFFFF';
}
```

### File Upload Handling

**Image Upload for Background:**

```typescript
// background-step.component.ts
onImageUpload(event: any) {
  const file = event.files[0];
  const reader = new FileReader();

  reader.onload = (e: any) => {
    const base64 = e.target.result;
    this.backgroundImageUrl.set(base64);
    this.backgroundType.set('image');
  };

  reader.readAsDataURL(file);
}
```

**PrimeNG FileUpload Configuration:**

```html
<p-fileUpload
  mode="basic"
  name="backgroundImage"
  accept="image/*"
  [maxFileSize]="2000000"
  (onSelect)="onImageUpload($event)"
  chooseLabel="Upload Image"
/>
```

### Cancel Confirmation

**Unsaved Changes Detection:**

```typescript
// theme-designer-modal.service.ts
readonly hasUnsavedChanges = computed(() => {
  const theme = this.currentTheme();
  // Check if any field has been modified from default
  return theme.name !== '' ||
         theme.primaryColor !== '#3B82F6' ||
         theme.secondaryColor !== '#10B981';
  // ... check other fields
});
```

**Confirm Dialog Integration:**

```typescript
// theme-designer-modal.component.ts
import { ConfirmationService } from 'primeng/api';

cancel() {
  if (this.modalService.hasUnsavedChanges()) {
    this.confirmationService.confirm({
      message: 'Discard theme? Changes will be lost.',
      header: 'Confirm Cancel',
      icon: 'pi pi-exclamation-triangle',
      accept: () => {
        this.modalService.reset();
        this.visible.set(false);
      }
    });
  } else {
    this.visible.set(false);
  }
}
```

## Testing

### Testing Standards

**Location:** [Source: docs/architecture/testing-strategy.md]

- Component tests:
  `apps/web/src/app/features/tools/components/form-builder/theme-designer-modal/**/*.spec.ts`
- Integration tests:
  `apps/web/src/app/features/tools/components/form-builder/theme-designer-modal.integration.spec.ts`

**Framework:**

- Karma + Jasmine for unit tests
- Angular Testing Library for component tests
- Run: `npm --workspace=apps/web run test`

**Testing Patterns:** [Source: docs/architecture/testing-strategy.md#frontend-component-test]

```typescript
import { ComponentFixture, TestBed } from '@angular/core/testing';
import { ThemeDesignerModalComponent } from './theme-designer-modal.component';
import { ThemeDesignerModalService } from './theme-designer-modal.service';
import { FormsApiService } from '../forms-api.service';
import { of } from 'rxjs';

describe('ThemeDesignerModalComponent', () => {
  let component: ThemeDesignerModalComponent;
  let fixture: ComponentFixture<ThemeDesignerModalComponent>;
  let modalService: jasmine.SpyObj<ThemeDesignerModalService>;
  let formsApiService: jasmine.SpyObj<FormsApiService>;

  beforeEach(() => {
    const modalSpy = jasmine.createSpyObj('ThemeDesignerModalService', [
      'nextStep',
      'previousStep',
      'saveTheme',
      'reset',
    ]);
    const apiSpy = jasmine.createSpyObj('FormsApiService', ['createTheme']);

    TestBed.configureTestingModule({
      imports: [ThemeDesignerModalComponent],
      providers: [
        { provide: ThemeDesignerModalService, useValue: modalSpy },
        { provide: FormsApiService, useValue: apiSpy },
      ],
    });

    fixture = TestBed.createComponent(ThemeDesignerModalComponent);
    component = fixture.componentInstance;
    modalService = TestBed.inject(
      ThemeDesignerModalService
    ) as jasmine.SpyObj<ThemeDesignerModalService>;
    formsApiService = TestBed.inject(FormsApiService) as jasmine.SpyObj<FormsApiService>;
  });

  it('should render modal when visible is true', () => {
    component.visible.set(true);
    fixture.detectChanges();

    const dialog = fixture.nativeElement.querySelector('p-dialog');
    expect(dialog).toBeTruthy();
  });

  it('should hide modal when visible is false', () => {
    component.visible.set(false);
    fixture.detectChanges();

    const dialog = fixture.nativeElement.querySelector('p-dialog');
    expect(dialog).toBeFalsy();
  });

  it('should render 5-step stepper', () => {
    component.visible.set(true);
    fixture.detectChanges();

    const stepper = fixture.nativeElement.querySelector('p-stepper');
    const steps = stepper.querySelectorAll('p-stepperPanel');
    expect(steps.length).toBe(5);
  });

  it('should call saveTheme on save button click', () => {
    const mockTheme = { id: '123', name: 'Test Theme' };
    formsApiService.createTheme.and.returnValue(of(mockTheme));

    component.visible.set(true);
    fixture.detectChanges();

    const saveButton = fixture.nativeElement.querySelector('[data-test="save-button"]');
    saveButton.click();

    expect(formsApiService.createTheme).toHaveBeenCalled();
  });
});
```

### Performance Testing

**Real-Time Preview Performance:** [Source:
docs/prd/epic-23-complete-theme-system.md#non-functional-requirements]

```typescript
it('should debounce preview updates to 300ms', fakeAsync(() => {
  component.visible.set(true);
  fixture.detectChanges();

  // Change color 5 times rapidly
  component.primaryColor.set('#FF0000');
  component.primaryColor.set('#00FF00');
  component.primaryColor.set('#0000FF');
  component.primaryColor.set('#FFFF00');
  component.primaryColor.set('#FF00FF');

  // Should only update once after 300ms
  tick(300);
  expect(themePreviewService.applyTheme).toHaveBeenCalledTimes(1);
}));
```

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-10-17 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

<!-- Populated by development agent during implementation -->

### Agent Model Used

<!-- e.g., Claude 3.5 Sonnet -->

### Debug Log References

<!-- Reference any debug logs or traces generated during development -->

### Completion Notes List

<!-- Notes about the completion of tasks and any issues encountered -->

### File List

<!-- List all files created, modified, or affected during story implementation -->

## QA Results

<!-- Results from QA Agent QA review of the completed story implementation -->
