# Story 30.9: Template Wizard Service and Infrastructure

## Status

Approved

## Story

**As a** frontend developer, **I want** a service to manage wizard state with signals, **so that**
wizard components can share configuration.

## Acceptance Criteria

1. `TemplateWizardService` created with state signals
2. Computed signals for validation and preview
3. Service methods (setCategory, nextStep, updateConfig, saveTemplate)
4. LocalStorage persistence
5. Validation methods per category
6. Schema builder methods
7. Unit tests

## Tasks / Subtasks

- [ ] **Task 1: Create `TemplateWizardService`** (AC: 1, 3)
  - [ ] Add service under `apps/web/src/app/features/admin/template-wizard/services`, providing
        signals for `category`, `currentStep`, `config`, and `status`.
        `[Source: docs/architecture/source-tree.md#frontend-structure-appsweb]`
  - [ ] Implement public methods `setCategory`, `nextStep`, `previousStep`, `updateConfig`,
        `saveTemplateDraft`, aligning with coding standards (JSDoc, strict typing).
        `[Source: docs/architecture/coding-standards.md#documentation-standards]`

- [ ] **Task 2: Add computed signals for validation + preview** (AC: 2)
  - [ ] Use computed signals to surface `isValid`, `previewSchema`, and `wizardSummary`, following
        the recommended NgRx Signals patterns for derived state.
        `[Source: docs/architecture/frontend-architecture.md#state-management-patterns]`

- [ ] **Task 3: Implement persistence + hydration** (AC: 4)
  - [ ] Store drafts in `localStorage` (namespaced key) and hydrate service state on initialization,
        mirroring best practices from the frontend services layer for persistence.
        `[Source: docs/architecture/frontend-architecture.md#state-management-patterns]`

- [ ] **Task 4: Add category-specific validators** (AC: 5)
  - [ ] Introduce pure validator functions (e.g., `validatePollConfig`, `validateQuizConfig`) that
        inspect wizard config objects with strict typing anchored to shared DTOs.
        `[Source: docs/architecture/coding-standards.md#critical-fullstack-rules]`
  - [ ] Surface validation errors via signals so panels can display inline messages.

- [ ] **Task 5: Implement schema builder helpers** (AC: 6)
  - [ ] Provide methods that transform wizard config into `FormSchema` objects compatible with Epic
        29 templates, using shared types from `@nodeangularfullstack/shared`.
        `[Source: docs/architecture/source-tree.md#packagesshared]`
  - [ ] Ensure builder respects JSONB structures required by the FORMS database so backend
        validators accept the payload.
        `[Source: docs/architecture/database-separation-implementation-summary.md#forms-database-nodeangularfullstack_forms]`

- [ ] **Task 6: Add Jest unit tests** (AC: 7)
  - [ ] Create `template-wizard.service.spec.ts` covering state transitions, validation,
        persistence, and schema generation with deterministic fixtures.
        `[Source: docs/architecture/testing-strategy.md#frontend-tests]`

## Dev Notes

### Previous Story Insights

- No specific guidance found in architecture docs.

### Data Models

- Wizard outputs must generate `FormSchema` objects that ultimately populate the FORMS database
  tables, so the service needs to maintain parity with backend schema expectations.
  `[Source: docs/architecture/database-separation-implementation-summary.md#forms-database-nodeangularfullstack_forms]`

### API Specifications

- Eventually the service will call backend template APIs using the shared REST conventions (JWT
  bearer, JSON payloads) once save operations invoke the API client.
  `[Source: docs/architecture/api-specification.md#rest-api-specification]`

### Component Specifications

- Wizard panels will subscribe to service signals, so the service must expose readonly signals and
  pure selectors consistent with the frontend architecture's component-template guidance.
  `[Source: docs/architecture/frontend-architecture.md#component-template]`

### File Locations

- Feature services belong under the admin/template wizard feature folder, while shared helpers
  (e.g., validators) may sit in `apps/web/src/app/shared/utils` if reused, following the source tree
  map. `[Source: docs/architecture/source-tree.md#frontend-structure-appsweb]`

### Testing Requirements

- The testing strategy prescribes colocated Jest specs for frontend services; use spies/mocks for
  `localStorage` and ensure deterministic state transitions.
  `[Source: docs/architecture/testing-strategy.md#frontend-tests]`

### Technical Constraints

- Angular signals + TypeScript strict mode are required, and all shared data types should come from
  the shared package to maintain full-stack consistency.
  `[Source: docs/architecture/tech-stack.md#technology-stack-table]`
- Document every public method with JSDoc per coding standards to aid downstream AI agents.
  `[Source: docs/architecture/coding-standards.md#documentation-standards]`

## Testing

- Run wizard service specs via
  `npm --workspace=apps/web run test -- --testPathPattern="template-wizard.service"` to verify state
  logic and persistence. `[Source: docs/architecture/testing-strategy.md#frontend-tests]`
- Execute `npm run test` at the repo root prior to QA review for combined coverage.
  `[Source: docs/architecture/testing-strategy.md#frontend-tests]`

## Change Log

| Date       | Version | Description                          | Author             |
| ---------- | ------- | ------------------------------------ | ------------------ |
| 2025-01-27 | 1.0     | Initial story draft and task outline | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be populated by the development agent._

### Debug Log References

_To be populated by the development agent._

### Completion Notes List

_To be populated by the development agent._

### File List

_To be populated by the development agent._

## QA Results

_QA review not yet executed for this draft._
