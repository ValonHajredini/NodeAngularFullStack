# Story 10.2: Form Repository and Service Layer

## Status

Draft

## Story

**As a** backend developer, **I want** to implement repository pattern for form data access and
service layer for business logic, **so that** database operations are abstracted and form
creation/management logic is centralized.

## Acceptance Criteria

1. **AC1**: `FormsRepository` class in `/apps/api/src/repositories/forms.repository.ts` implements
   methods: `create()`, `findById()`, `findByUserId()`, `update()`, `delete()`
2. **AC2**: `FormSchemasRepository` class implements methods: `createSchema()`, `findByFormId()`,
   `findByToken()`, `updateSchema()`, `publishSchema()`, `unpublishSchema()`
3. **AC3**: `FormSubmissionsRepository` class implements methods: `create()`,
   `findByFormSchemaId()`, `findByFormId()`, `countByFormSchemaId()`
4. **AC4**: All repositories use existing connection pool from `src/database/pool.ts`
5. **AC5**: `FormsService` class in `/apps/api/src/services/forms.service.ts` implements business
   logic: `createForm()`, `publishForm()`, `validateFormSchema()`, `generateRenderToken()`
6. **AC6**: Token generation uses `jsonwebtoken` library with `FORM_RENDER_TOKEN_SECRET` from
   environment
7. **AC7**: Form schema validation prevents duplicate field names and validates regex patterns
8. **AC8**: Service layer includes JSDoc comments for all public methods

## Tasks / Subtasks

- [ ] Create FormsRepository with CRUD operations (AC: 1, 4)
  - [ ] Create `/apps/api/src/repositories/forms.repository.ts` file
  - [ ] Extend BaseRepository<FormMetadata> class
  - [ ] Implement `create(data: Partial<FormMetadata>): Promise<FormMetadata>` method
  - [ ] Implement `findById(id: string, tenantId?: string): Promise<FormMetadata | null>` with
        tenant filtering
  - [ ] Implement `findByUserId(userId: string, tenantId?: string): Promise<FormMetadata[]>` method
  - [ ] Implement `update(id: string, data: Partial<FormMetadata>): Promise<FormMetadata>` method
  - [ ] Implement `delete(id: string, userId: string): Promise<boolean>` method (ensure owner-only
        deletion)
  - [ ] Import pool from `src/database/pool.ts` for database connection
  - [ ] Add JSDoc comments to all public methods

- [ ] Create FormSchemasRepository for schema management (AC: 2, 4)
  - [ ] Create `/apps/api/src/repositories/form-schemas.repository.ts` file
  - [ ] Implement `createSchema(formId: string, schema: FormSchema): Promise<FormSchema>` method
  - [ ] Implement `findByFormId(formId: string): Promise<FormSchema[]>` method (returns all
        versions)
  - [ ] Implement `findByToken(token: string): Promise<FormSchema | null>` method
  - [ ] Implement `updateSchema(id: string, schema: Partial<FormSchema>): Promise<FormSchema>`
        method
  - [ ] Implement `publishSchema(id: string, token: string, expiresAt: Date): Promise<FormSchema>`
        method
  - [ ] Implement `unpublishSchema(id: string): Promise<FormSchema>` method (sets
        is_published=false)
  - [ ] Add JSDoc comments to all public methods

- [ ] Create FormSubmissionsRepository for submission data (AC: 3, 4)
  - [ ] Create `/apps/api/src/repositories/form-submissions.repository.ts` file
  - [ ] Implement `create(submission: FormSubmission): Promise<FormSubmission>` method
  - [ ] Implement `findByFormSchemaId(schemaId: string, limit?: number): Promise<FormSubmission[]>`
        method
  - [ ] Implement `findByFormId(formId: string): Promise<FormSubmission[]>` method (joins with
        form_schemas)
  - [ ] Implement `countByFormSchemaId(schemaId: string): Promise<number>` method
  - [ ] Add JSDoc comments to all public methods

- [ ] Create FormsService with business logic (AC: 5, 6, 7, 8)
  - [ ] Create `/apps/api/src/services/forms.service.ts` file
  - [ ] Inject FormsRepository, FormSchemasRepository dependencies via constructor
  - [ ] Implement
        `createForm(userId: string, tenantId: string | undefined, formData: Partial<FormMetadata>): Promise<FormMetadata>`
        method
  - [ ] Implement
        `publishForm(formId: string, userId: string, expiresInDays: number): Promise<{ form: FormMetadata, schema: FormSchema, renderUrl: string }>`
        method
  - [ ] Implement
        `validateFormSchema(schema: FormSchema): Promise<{ valid: boolean, errors: string[] }>`
        method
  - [ ] Add validation: Check for duplicate field names in schema.fields array
  - [ ] Add validation: Validate regex patterns using try-catch with new RegExp()
  - [ ] Add validation: Ensure all required fields (label, fieldName) are present
  - [ ] Implement `generateRenderToken(formSchemaId: string, expiresAt: Date): string` method using
        JWT
  - [ ] Use `jsonwebtoken` library with `sign()` method
  - [ ] Token payload: { formSchemaId, expiresAt, iss: 'form-builder', iat: Date.now() }
  - [ ] Use `process.env.FORM_RENDER_TOKEN_SECRET` for JWT secret
  - [ ] Add JSDoc comments to all public methods with @param, @returns, @throws tags

- [ ] Add environment variable for token secret (AC: 6)
  - [ ] Add `FORM_RENDER_TOKEN_SECRET` to `.env.example` with placeholder value
  - [ ] Document in `.env.development` (use existing pattern for secrets)
  - [ ] Add validation in startup config to ensure secret is set in production

- [ ] Write unit tests for repositories (IV: 1, 4)
  - [ ] Create `/apps/api/tests/unit/repositories/forms.repository.test.ts`
  - [ ] Test FormsRepository CRUD operations with mock database responses
  - [ ] Test tenant filtering in findById and findByUserId methods
  - [ ] Test owner validation in delete method
  - [ ] Create `/apps/api/tests/unit/repositories/form-schemas.repository.test.ts`
  - [ ] Test schema creation, publishing, and unpublishing
  - [ ] Test findByToken method with valid and expired tokens
  - [ ] Create `/apps/api/tests/unit/repositories/form-submissions.repository.test.ts`
  - [ ] Test submission creation and retrieval
  - [ ] Test count method for submission statistics

- [ ] Write unit tests for service layer (IV: 2, 3, 5)
  - [ ] Create `/apps/api/tests/unit/services/forms.service.test.ts`
  - [ ] Test createForm method with valid data
  - [ ] Test publishForm method and verify token generation
  - [ ] Test validateFormSchema with duplicate field names (should fail)
  - [ ] Test validateFormSchema with invalid regex patterns (should fail)
  - [ ] Test validateFormSchema with valid schema (should pass)
  - [ ] Mock repository dependencies using Jest spies
  - [ ] Verify error handling uses existing ApiError class from `src/utils/errors.ts`

## Dev Notes

### Previous Story Insights

Story 10.1 created the database schema and shared types. This story builds the data access and
business logic layer on top of that foundation.

### Data Models

**Repository Pattern:** [Source: docs/architecture/backend-architecture.md#Data-Access-Layer]

- All repositories extend BaseRepository<T> for common CRUD operations
- Use existing connection pool from `src/database/pool.ts`
- Tenant filtering applied when `tenantId` parameter provided
- Parameterized queries for SQL injection prevention

**Service Layer Pattern:** [Source: docs/architecture/backend-architecture.md#Service-Architecture]

- Services contain business logic and orchestrate repository calls
- Services inject repository dependencies via constructor
- Services validate data before passing to repositories
- Services handle complex operations like token generation and schema validation

### API Specifications

No API routes in this story. Service and repository layers only. APIs will be added in Story 10.3.

### Component Specifications

No frontend components in this story. Backend data layer only.

### File Locations

**Repositories:** [Source: docs/architecture/unified-project-structure.md#apps/api]

- Create: `/apps/api/src/repositories/forms.repository.ts`
- Create: `/apps/api/src/repositories/form-schemas.repository.ts`
- Create: `/apps/api/src/repositories/form-submissions.repository.ts`
- Pattern: Extend BaseRepository (see `/apps/api/src/repositories/base.repository.ts`)

**Services:** [Source: docs/architecture/unified-project-structure.md#apps/api]

- Create: `/apps/api/src/services/forms.service.ts`
- Pattern: Follow existing services (see `/apps/api/src/services/auth.service.ts`,
  `/apps/api/src/services/users.service.ts`)

**Tests:** [Source: docs/architecture/testing-strategy.md#Backend-Tests]

- Create: `/apps/api/tests/unit/repositories/forms.repository.test.ts`
- Create: `/apps/api/tests/unit/repositories/form-schemas.repository.test.ts`
- Create: `/apps/api/tests/unit/repositories/form-submissions.repository.test.ts`
- Create: `/apps/api/tests/unit/services/forms.service.test.ts`

### Testing Requirements

**Repository Tests:** [Source: docs/architecture/testing-strategy.md#Backend-API-Test]

- Use Jest with supertest for integration tests
- Mock database connection pool for unit tests
- Test tenant isolation when multi-tenancy enabled
- Verify foreign key constraints and cascade deletes
- Test connection pooling stability (no leaks)

**Service Tests:** [Source: docs/architecture/testing-strategy.md#Backend-API-Test]

- Mock repository dependencies with Jest spies
- Test schema validation logic thoroughly
- Test JWT token generation and verification
- Test error handling for invalid inputs
- Verify business logic rules (e.g., owner-only deletion)

**Test Commands:** [Source: docs/CLAUDE.md#Testing-Commands]

- Run all tests: `npm test`
- Run backend tests only: `npm run test:api`
- Run specific test file:
  `npm --workspace=apps/api run test -- --testPathPattern="forms.service.test.ts"`

### Technical Constraints

**Repository Standards:** [Source: docs/architecture/backend-architecture.md#Data-Access-Layer]

- Extend BaseRepository<T> class for common functionality
- Use existing pool from `src/database/pool.ts`
- Apply tenant filtering when `tenantId` provided
- Use parameterized queries ($1, $2, etc.) to prevent SQL injection
- Return null for not found (don't throw errors in repository layer)

**Service Standards:** [Source: docs/architecture/backend-architecture.md#Service-Architecture]

- Constructor dependency injection for repositories
- Business logic validation before database operations
- Use existing error classes from `src/utils/errors.ts` (ApiError)
- JSDoc comments required for all public methods
- Throw ApiError with appropriate status codes (400, 404, 500)

**JWT Token Generation:** [Source:
docs/architecture/backend-architecture.md#Authentication-and-Authorization]

- Use `jsonwebtoken` library (already in dependencies)
- Token payload: formSchemaId, expiresAt, issuer, issued timestamp
- Use dedicated secret: `FORM_RENDER_TOKEN_SECRET` from environment
- Token format: Standard JWT (header.payload.signature)
- Expiration enforcement on verification (not just client-side)

**Multi-Tenancy:** [Source: docs/architecture/backend-architecture.md#Data-Access-Layer]

- Repository methods accept optional `tenantId` parameter
- Queries include tenant filtering when `tenantId` provided
- Service layer receives `tenantId` from authenticated request
- Forms isolated per tenant (users can only access their tenant's forms)

**Error Handling:** [Source: docs/architecture/coding-standards.md#Critical-Fullstack-Rules]

- Use ApiError class from `src/utils/errors.ts`
- Throw errors with appropriate HTTP status codes
- Include descriptive error messages for validation failures
- Services throw errors, repositories return null for not found

### Testing

**Test File Location:** [Source: docs/architecture/testing-strategy.md#Backend-Tests]

- Unit tests: `/apps/api/tests/unit/repositories/` and `/apps/api/tests/unit/services/`
- Integration tests will be added in Story 10.3 when routes are implemented

**Testing Standards:** [Source: docs/architecture/testing-strategy.md#Backend-API-Test]

- Use Jest as testing framework
- Mock external dependencies (database, other services)
- Test happy paths and error cases
- Verify error handling and validation logic
- Check multi-tenancy isolation

**Testing Frameworks:** [Source: docs/architecture/tech-stack.md]

- Jest 29+ for unit testing
- Supertest 6+ for API integration testing (Story 10.3)
- TypeScript 5.3+ for type checking

### Testing

**Test File Location:** [Source: docs/architecture/testing-strategy.md#Backend-Tests]

- `/apps/api/tests/unit/repositories/forms.repository.test.ts`
- `/apps/api/tests/unit/repositories/form-schemas.repository.test.ts`
- `/apps/api/tests/unit/repositories/form-submissions.repository.test.ts`
- `/apps/api/tests/unit/services/forms.service.test.ts`

**Testing Standards:** [Source: docs/architecture/testing-strategy.md]

- Mock database pool with Jest mocks
- Test tenant filtering and owner validation
- Verify JWT token generation and payload structure
- Test schema validation with various edge cases
- Ensure error handling follows existing patterns

**Testing Frameworks:** [Source: docs/architecture/tech-stack.md]

- Jest 29+ for backend testing
- Mock pattern: Use `jest.mock()` for dependencies

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-04 | 1.0     | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
