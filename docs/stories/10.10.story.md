# Story 10.10: Form Submission Handling and Security Hardening

## Status

Draft

## Story

**As a** form respondent, **I want** to submit my form responses securely, **so that** my data is
validated, stored, and the form creator can review submissions.

## Acceptance Criteria

1. **AC1**: `POST /api/public/forms/submit/:token` endpoint validates token and processes submission
2. **AC2**: Server-side validation re-validates all form constraints (required, min/max, email,
   pattern)
3. **AC3**: File uploads handled via FormData, files stored in DigitalOcean Spaces (or local
   storage), metadata saved in submission
4. **AC4**: Submission stored in `form_submissions` table with: form_schema_id, values_json,
   submitted_at, submitter_ip, user_id (if authenticated)
5. **AC5**: XSS sanitization applied to all text inputs before storage
6. **AC6**: Rate limiting on submit endpoint: 10 submissions per hour per IP for unauthenticated
   users
7. **AC7**: CAPTCHA challenge displayed after 3 submissions from same IP (optional, configurable)
8. **AC8**: Success page shows custom success message from form settings or default message
9. **AC9**: Optional redirect to external URL after successful submission (if configured)
10. **AC10**: Form creator can view submissions list: `GET /api/forms/:id/submissions`
    (authenticated, owner only)
11. **AC11**: Submissions list shows: submitted date, field values (truncated), submitter IP (masked
    for privacy)
12. **AC12**: Export submissions as CSV functionality (admin/owner only)

## Tasks / Subtasks

- [ ] Create form submission API endpoint (AC: 1, 2, 4, 5, 6)
  - [ ] Create POST `/api/public/forms/submit/:token` route (no auth required)
  - [ ] Create PublicFormsController.submitForm method
  - [ ] Validate JWT token (same as render endpoint)
  - [ ] Get form_schema from token payload
  - [ ] Verify is_published=true and not expired
  - [ ] Extract submission data from request body
  - [ ] Re-validate all fields server-side:
    - Check required fields are present
    - Validate min/max, minLength/maxLength
    - Validate email format
    - Validate regex patterns
    - Return 400 with validation errors if invalid
  - [ ] Sanitize all text inputs using validator.escape() or DOMPurify
  - [ ] Get submitter IP from req.ip or req.headers['x-forwarded-for']
  - [ ] Create submission record in form_submissions table
  - [ ] Apply rate limiting: 10 submissions per hour per IP (unauthenticated)
  - [ ] Return success response with submission ID

- [ ] Implement file upload handling (AC: 3)
  - [ ] Use multer middleware for multipart/form-data
  - [ ] Configure file upload limits from schema (maxFileSize, maxFiles)
  - [ ] Validate file types against acceptedTypes from schema
  - [ ] Upload files to DigitalOcean Spaces (or local storage for dev):
    - Use existing file storage service
    - Generate unique file names (UUID + extension)
    - Store in bucket/folder: `form-uploads/{formSchemaId}/{submissionId}/`
  - [ ] Save file metadata in submission values_json:
    - originalName, fileName, size, mimeType, url
  - [ ] Handle upload errors (size exceeded, invalid type)

- [ ] Implement CAPTCHA challenge (AC: 7, optional)
  - [ ] Track submission count per IP in Redis or database
  - [ ] After 3rd submission from same IP, require CAPTCHA
  - [ ] Use Google reCAPTCHA v3 or hCaptcha
  - [ ] Add CAPTCHA token to submission request
  - [ ] Verify CAPTCHA token on server before accepting submission
  - [ ] Make CAPTCHA configurable via environment variable
  - [ ] If CAPTCHA fails, return 400 with "CAPTCHA verification failed"

- [ ] Implement frontend submission handling (AC: 8, 9)
  - [ ] Update FormRendererComponent with submit logic
  - [ ] Implement onSubmit() method:
    - Validate formGroup (ensure valid before submit)
    - Prepare submission data from formGroup.value
    - Handle file uploads (convert to FormData if files present)
    - Call formRendererService.submitForm(token, submissionData)
    - Show loading spinner during submission
    - On success: navigate to success page or redirect
    - On error: display error message
  - [ ] Create success page/state:
    - Display custom success message from form settings
    - If redirectUrl configured: auto-redirect after 3 seconds
    - Show "Submit Another Response" button (if allowed)
  - [ ] Handle CAPTCHA display (if required after 3 submissions)

- [ ] Create submissions list view for form creators (AC: 10, 11)
  - [ ] Create GET `/api/forms/:id/submissions` route (authenticated)
  - [ ] Create FormsController.getSubmissions method
  - [ ] Validate form ownership (user owns form or is admin)
  - [ ] Query submissions from form_submissions table
  - [ ] Join with form_schemas to get all versions
  - [ ] Mask submitter IP for privacy (show only first 2 octets: "192.168._._")
  - [ ] Truncate long field values (max 100 chars in list view)
  - [ ] Support pagination (page, limit query params)
  - [ ] Return submissions with metadata
  - [ ] Add OpenAPI/Swagger annotations

- [ ] Implement CSV export functionality (AC: 12)
  - [ ] Create GET `/api/forms/:id/submissions/export` route (authenticated)
  - [ ] Create FormsController.exportSubmissions method
  - [ ] Validate ownership (owner or admin only)
  - [ ] Query all submissions for form
  - [ ] Generate CSV:
    - Header row: field names from schema
    - Data rows: submission values
    - Include metadata columns: Submitted At, Submitter IP (masked)
  - [ ] Use json2csv or similar library
  - [ ] Return CSV file with appropriate headers:
    - Content-Type: text/csv
    - Content-Disposition: attachment; filename="form-submissions-{formId}.csv"
  - [ ] Handle large exports (stream data if >1000 submissions)

- [ ] Create submissions view component in Form Builder (AC: 10, 11)
  - [ ] Create
        `/apps/web/src/app/features/tools/components/form-builder/submissions-list/submissions-list.component.ts`
  - [ ] Route: `/tools/form-builder/:id/submissions`
  - [ ] Use PrimeNG DataTable for submissions display
  - [ ] Columns: Submitted Date, Field Values (truncated), Submitter IP (masked), Actions
  - [ ] Implement pagination with PrimeNG Paginator
  - [ ] Add "View Details" button to see full submission
  - [ ] Add "Export CSV" button (calls export API)
  - [ ] Show submission count and summary stats
  - [ ] Real-time updates (optional: WebSocket or polling)

- [ ] Implement security hardening (AC: 2, 5, IV: 5)
  - [ ] Server-side validation: Re-validate ALL constraints (never trust client)
  - [ ] XSS protection: Sanitize text inputs using validator.escape()
  - [ ] SQL injection prevention: Use parameterized queries (already in place)
  - [ ] CSRF protection: Ensure CSRF token if using sessions (not needed for JWT)
  - [ ] Rate limiting: 10 submissions/hour per IP (unauthenticated)
  - [ ] File upload security:
    - Validate MIME types server-side (not just extension)
    - Scan files for malware (optional: ClamAV integration)
    - Prevent path traversal in file names
  - [ ] Input validation: Reject submissions with fields not in schema

- [ ] Write comprehensive tests (IV: 6, 7, 8)
  - [ ] Backend tests:
    - Test POST /api/public/forms/submit/:token with valid data
    - Test server-side validation (required, min/max, email, pattern)
    - Test XSS sanitization
    - Test file upload with valid and invalid files
    - Test rate limiting (10/hour per IP)
    - Test CAPTCHA requirement after 3 submissions
    - Test GET /api/forms/:id/submissions (authenticated)
    - Test CSV export
    - Security tests: SQL injection, XSS, malicious files
  - [ ] Frontend tests:
    - Test form submission flow
    - Test success page display
    - Test redirect after submission
    - Test error handling (validation, network errors)
    - Mock FormRendererService
  - [ ] E2E test: Full flow
    - Create form → Publish → Access via token → Fill out → Submit → Verify in DB
  - [ ] Performance test: 100 concurrent submissions
  - [ ] Accessibility audit: Form renderer meets WCAG 2.1 AA

## Dev Notes

### Previous Story Insights

Story 10.9 created the public form renderer. This story completes the form lifecycle by implementing
submission handling and creator submission management.

### Data Models

**Form Submission:** [Source: docs/prd-form-builder/epic-10#Story-1.10-AC4]

```typescript
{
  id: UUID,
  form_schema_id: UUID,
  values_json: {
    [fieldName]: value,
    // File fields:
    'file-upload': {
      originalName: string,
      fileName: string,
      size: number,
      mimeType: string,
      url: string
    }
  },
  submitted_at: timestamp,
  submitter_ip: INET (stored as-is, masked on retrieval),
  user_id: UUID (nullable, for authenticated submissions),
  metadata: JSONB (nullable, extensible)
}
```

**CSV Export Format:** [Source: docs/prd-form-builder/epic-10#Story-1.10-AC12]

```csv
Submitted At,Submitter IP,First Name,Email,Message
2025-01-04 14:30:00,192.168.*.*,John,john@example.com,"Hello world"
```

### API Specifications

**Submit Endpoint:** [Source: docs/prd-form-builder/epic-10#Story-1.10-AC1]

- POST /api/public/forms/submit/:token
- No authentication required
- Request body: `{ values: { [fieldName]: value }, captchaToken?: string }`
- File uploads: multipart/form-data
- Rate limited: 10 submissions/hour per IP (unauthenticated)
- Response: `{ success: true, data: { submissionId, message } }`

**Submissions List Endpoint:** [Source: docs/prd-form-builder/epic-10#Story-1.10-AC10]

- GET /api/forms/:id/submissions
- Requires authentication + ownership
- Query params: page, limit
- Response: `{ data: submissions[], pagination: {...} }`

**CSV Export Endpoint:** [Source: docs/prd-form-builder/epic-10#Story-1.10-AC12]

- GET /api/forms/:id/submissions/export
- Requires authentication + ownership/admin
- Returns CSV file
- Content-Type: text/csv

### Component Specifications

**Success Page:** [Source: docs/prd-form-builder/epic-10#Story-1.10-AC8-AC9]

- Display custom success message from form settings
- If redirectUrl configured: auto-redirect after 3 seconds with countdown
- Show "Submit Another Response" button (if allowMultipleSubmissions=true)
- Clean UI with success icon

**Submissions List:** [Source: docs/prd-form-builder/epic-10#Story-1.10-AC11]

- PrimeNG DataTable with pagination
- Columns: Date, Values (truncated), IP (masked), Actions
- View details button → modal with full submission
- Export CSV button
- Summary stats: total submissions, latest submission date

### File Locations

**Backend:** [Source: docs/architecture/unified-project-structure.md#apps/api]

- Update: `/apps/api/src/routes/public.routes.ts` (add submit endpoint)
- Update: `/apps/api/src/controllers/public-forms.controller.ts` (add submit method)
- Update: `/apps/api/src/routes/forms.routes.ts` (add submissions and export routes)
- Update: `/apps/api/src/controllers/forms.controller.ts` (add getSubmissions, exportSubmissions)

**Frontend:** [Source: docs/architecture/unified-project-structure.md#apps/web]

- Update: `/apps/web/src/app/features/public/form-renderer/form-renderer.component.ts` (add submit
  logic)
- Update: `/apps/web/src/app/features/public/form-renderer/form-renderer.service.ts` (add submit
  method)
- Create:
  `/apps/web/src/app/features/tools/components/form-builder/submissions-list/submissions-list.component.ts`

**Tests:** [Source: docs/architecture/testing-strategy.md]

- Create: `/apps/api/tests/integration/form-submissions.test.ts`
- Create: `/apps/api/tests/security/form-security.test.ts`
- Create: `/apps/api/tests/performance/form-submission-load.test.ts`
- Update: `/apps/web/src/app/features/public/form-renderer/form-renderer.component.spec.ts`

### Testing Requirements

**Backend Tests:** [Source: docs/architecture/testing-strategy.md#Backend-API-Test]

- Test submission with valid data
- Test server-side validation for all field types
- Test XSS sanitization (submit <script> tags, verify escaped)
- Test file upload (valid file, invalid type, size exceeded)
- Test rate limiting (11th submission in hour blocked)
- Test CAPTCHA verification
- Test submissions list (owner access, pagination)
- Test CSV export format

**Security Tests:** [Source: docs/prd-form-builder/epic-10#Story-1.10-IV5]

- SQL injection: Attempt injection via form values
- XSS: Submit malicious scripts, verify sanitized
- File upload: Upload .exe, .sh files (should be blocked)
- Path traversal: File names with "../" (should be sanitized)
- CSRF: Verify CSRF protection if using sessions

**Performance Tests:** [Source: docs/prd-form-builder/epic-10#Story-1.10-IV7]

- 100 concurrent submissions
- Verify no database deadlocks
- Verify response times under load
- Test file upload with large files (max size limit)

**E2E Test:** [Source: docs/prd-form-builder/epic-10#Story-1.10-IV6]

- Create form in builder
- Publish form
- Access via public URL
- Fill out all field types
- Submit form
- Verify submission in database
- Verify creator can view submission

**Accessibility Audit:** [Source: docs/prd-form-builder/epic-10#Story-1.10-IV8]

- WCAG 2.1 AA compliance
- Keyboard navigation
- Screen reader compatibility
- Error message announcements

**Test Commands:** [Source: docs/CLAUDE.md#Testing-Commands]

- Backend: `npm --workspace=apps/api run test -- --testPathPattern="form-submissions.test.ts"`
- Security: `npm --workspace=apps/api run test:security`
- Performance: `npm --workspace=apps/api run test:performance`
- E2E: `npm run test:e2e -- --grep "Form submission flow"`

### Technical Constraints

**Server-Side Validation:** [Source: docs/prd-form-builder/epic-10#Story-1.10-AC2]

- NEVER trust client validation
- Re-validate ALL constraints on server
- Use same validation logic as schema definition
- Return specific error messages per field

**XSS Sanitization:** [Source: docs/prd-form-builder/epic-10#Story-1.10-AC5]

- Use validator.escape() for text inputs
- Sanitize before storage (not on retrieval)
- HTML encode special characters: <, >, &, ", '
- File uploads: Store metadata only, not file content in JSON

**File Upload Security:** [Source: docs/prd-form-builder/epic-10#Story-1.10-AC3]

- Validate MIME type server-side (use file-type library)
- Limit file size per schema (enforce with multer)
- Generate unique file names (prevent overwrites)
- Store in isolated bucket/folder per form
- Optional: Scan with ClamAV or similar

**Rate Limiting:** [Source: docs/prd-form-builder/epic-10#Story-1.10-AC6]

- Use express-rate-limit middleware
- 10 submissions per hour per IP (unauthenticated)
- Authenticated users: higher limit or no limit
- Track by IP address from req.ip
- Return 429 with retry-after header

**CAPTCHA Integration:** [Source: docs/prd-form-builder/epic-10#Story-1.10-AC7]

- reCAPTCHA v3 or hCaptcha
- Display after 3rd submission from same IP
- Verify token on server: POST to reCAPTCHA/hCaptcha API
- Configurable via ENABLE_CAPTCHA environment variable
- Fallback: Allow submission without CAPTCHA if disabled

**IP Masking for Privacy:** [Source: docs/prd-form-builder/epic-10#Story-1.10-AC11]

- Store full IP in database
- Mask on retrieval: "192.168._._" (show first 2 octets only)
- Comply with GDPR/privacy regulations
- Admin/owner can see masked IP only

**CSV Export:** [Source: docs/prd-form-builder/epic-10#Story-1.10-AC12]

- Use json2csv library
- Stream data for large exports (>1000 submissions)
- Include all form fields as columns
- Include metadata: Submitted At, Submitter IP (masked)
- Proper CSV escaping for special characters

### Testing

**Test File Location:** [Source: docs/architecture/testing-strategy.md]

- `/apps/api/tests/integration/form-submissions.test.ts`
- `/apps/api/tests/security/form-security.test.ts`
- `/apps/api/tests/performance/form-submission-load.test.ts`

**Testing Standards:** [Source: docs/architecture/testing-strategy.md]

- Test all validation rules server-side
- Test XSS and SQL injection prevention
- Test file upload security (malicious files)
- Test rate limiting enforcement
- Test CAPTCHA integration
- Performance test with 100 concurrent users
- E2E test complete submission flow
- Accessibility audit with axe-core

**Testing Frameworks:** [Source: docs/architecture/tech-stack.md]

- Jest + Supertest for backend
- Artillery or k6 for load testing
- Playwright for E2E testing
- axe-core for accessibility audits

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-04 | 1.0     | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
