# Story 23.2: Remove Admin Restriction from Theme API

## Status

Draft

## Story

**As a** backend developer, **I want** to allow all authenticated users to create themes, **so
that** theme creation is not admin-only.

## Acceptance Criteria

1. Remove `AuthMiddleware.requireAdmin` from `POST /api/themes`
2. Create `AuthMiddleware.requireThemeOwnerOrAdmin` middleware
3. Apply owner-or-admin middleware to `PUT /api/themes/:id` and `DELETE /api/themes/:id`
4. Update Swagger documentation to reflect authentication changes
5. Add integration tests for non-admin theme creation
6. Add integration tests for edit/delete authorization (owner vs. non-owner)

## Tasks / Subtasks

- [ ] Task 1: Modify Theme Routes to Remove Admin Restriction (AC: 1, 3)
  - [ ] Open `apps/api/src/routes/themes.routes.ts`
  - [ ] Remove `AuthMiddleware.requireAdmin` from `POST /api/themes` route
  - [ ] Replace with `AuthMiddleware.authenticate` only (any authenticated user can create)
  - [ ] Update `PUT /api/themes/:id` to use `AuthMiddleware.requireThemeOwnerOrAdmin`
  - [ ] Update `DELETE /api/themes/:id` to use `AuthMiddleware.requireThemeOwnerOrAdmin`
  - [ ] Keep `AuthMiddleware.authenticate` on `GET /api/themes` (read access for all authenticated
        users)

- [ ] Task 2: Create `requireThemeOwnerOrAdmin` Middleware (AC: 2)
  - [ ] Open `apps/api/src/middleware/auth.middleware.ts`
  - [ ] Add new static method `requireThemeOwnerOrAdmin = async (req, res, next) => { ... }`
  - [ ] Extract `themeId` from `req.params.id`
  - [ ] Extract `userId` from `req.user.id` (set by authenticate middleware)
  - [ ] Extract `userRole` from `req.user.role`
  - [ ] If user role is `'Admin'`, call `next()` immediately (admins can edit any theme)
  - [ ] If not admin, fetch theme from database using `themesRepository.findById(themeId)`
  - [ ] If theme not found, return 404: `{ error: 'Theme not found' }`
  - [ ] If `theme.created_by !== userId`, return 403:
        `{ error: 'You can only edit your own themes' }`
  - [ ] If ownership check passes, call `next()`
  - [ ] Add JSDoc comments explaining middleware purpose and behavior

- [ ] Task 3: Update Themes Repository to Support Ownership Checks (AC: 2)
  - [ ] Open `apps/api/src/repositories/themes.repository.ts`
  - [ ] Verify `findById(id)` method returns `created_by` field from database
  - [ ] If `created_by` field not selected, add it to SELECT query
  - [ ] Ensure repository method returns full theme object including creator

- [ ] Task 4: Update Swagger Documentation (AC: 4)
  - [ ] Open `apps/api/src/controllers/themes.controller.ts`
  - [ ] Update JSDoc for `createTheme` endpoint to reflect authentication change:
    - Remove "admin-only" mentions
    - Update to: "Requires authentication. Any authenticated user can create themes."
  - [ ] Update JSDoc for `updateTheme` endpoint:
    - Add: "Requires authentication. Users can only update their own themes. Admins can update any
      theme."
  - [ ] Update JSDoc for `deleteTheme` endpoint:
    - Add: "Requires authentication. Users can only delete their own themes. Admins can delete any
      theme."
  - [ ] Run `npm start` and verify Swagger UI at `http://localhost:3000/api-docs` reflects changes

- [ ] Task 5: Write Integration Tests for Non-Admin Theme Creation (AC: 5)
  - [ ] Create test file: `apps/api/tests/integration/themes-auth.test.ts`
  - [ ] Test case: "should allow non-admin user to create theme"
    - Register non-admin user
    - Authenticate and get access token
    - POST to `/api/themes` with valid theme data
    - Expect 201 Created
    - Verify theme `created_by` matches user ID
  - [ ] Test case: "should reject theme creation without authentication"
    - POST to `/api/themes` without Authorization header
    - Expect 401 Unauthorized
  - [ ] Test case: "should allow admin to create theme"
    - Authenticate as admin user
    - POST to `/api/themes`
    - Expect 201 Created

- [ ] Task 6: Write Integration Tests for Edit/Delete Authorization (AC: 6)
  - [ ] Add to `apps/api/tests/integration/themes-auth.test.ts`
  - [ ] Test case: "should allow user to edit their own theme"
    - Create theme as non-admin user A
    - PUT to `/api/themes/:id` with user A's token
    - Expect 200 OK
  - [ ] Test case: "should reject user editing another user's theme"
    - Create theme as user A
    - Authenticate as user B (non-admin)
    - PUT to `/api/themes/:id` with user B's token
    - Expect 403 Forbidden with message: "You can only edit your own themes"
  - [ ] Test case: "should allow admin to edit any user's theme"
    - Create theme as non-admin user A
    - Authenticate as admin
    - PUT to `/api/themes/:id` with admin token
    - Expect 200 OK
  - [ ] Test case: "should reject user deleting another user's theme"
    - Create theme as user A
    - Authenticate as user B
    - DELETE to `/api/themes/:id` with user B's token
    - Expect 403 Forbidden
  - [ ] Test case: "should allow admin to delete any theme"
    - Create theme as user A
    - Authenticate as admin
    - DELETE to `/api/themes/:id` with admin token
    - Expect 200 OK or 204 No Content

- [ ] Task 7: Run Full Test Suite and Verify Changes
  - [ ] Run integration tests: `npm --workspace=apps/api run test:integration`
  - [ ] Run all backend tests: `npm --workspace=apps/api run test`
  - [ ] Verify existing theme tests still pass
  - [ ] Run linter: `npm --workspace=apps/api run lint`
  - [ ] Fix any linting errors
  - [ ] Run typecheck: `npm --workspace=apps/api run typecheck`

## Dev Notes

### Previous Story Insights

**From Epic 23 Analysis:** [Source: docs/prd/epic-23-complete-theme-system.md#issues-identified]

Epic 22 implemented admin-only theme creation, but Epic 23 corrects this to allow all authenticated
users to create custom themes via Form Builder. This aligns with the product vision of empowering
all form creators to customize their forms without requiring admin privileges.

**Authorization Pattern:**

- **Create:** Any authenticated user
- **Read:** Any authenticated user
- **Update:** Theme owner OR admin
- **Delete:** Theme owner OR admin

### API Specifications

**Theme API Endpoints:** [Source:
docs/prd/epic-23-complete-theme-system.md#api-authentication-changes]

```typescript
// Current (Epic 20-22)
POST   /api/themes      - AuthMiddleware.authenticate + AuthMiddleware.requireAdmin
GET    /api/themes      - AuthMiddleware.authenticate
GET    /api/themes/:id  - AuthMiddleware.authenticate
PUT    /api/themes/:id  - AuthMiddleware.authenticate + AuthMiddleware.requireAdmin
DELETE /api/themes/:id  - AuthMiddleware.authenticate + AuthMiddleware.requireAdmin

// After Story 23.2
POST   /api/themes      - AuthMiddleware.authenticate
GET    /api/themes      - AuthMiddleware.authenticate
GET    /api/themes/:id  - AuthMiddleware.authenticate
PUT    /api/themes/:id  - AuthMiddleware.authenticate + AuthMiddleware.requireThemeOwnerOrAdmin
DELETE /api/themes/:id  - AuthMiddleware.authenticate + AuthMiddleware.requireThemeOwnerOrAdmin
```

**Route Definition Pattern:** [Source:
docs/architecture/backend-architecture.md#controller-route-organization]

```typescript
// apps/api/src/routes/themes.routes.ts
import { Router } from 'express';
import { ThemesController } from '../controllers/themes.controller';
import { AuthMiddleware } from '../middleware/auth.middleware';
import { validateCreateTheme, validateUpdateTheme } from '../validators/themes.validator';

const router = Router();
const controller = new ThemesController();

// Public/authenticated routes
router.get('/', AuthMiddleware.authenticate, controller.getAll);
router.get('/:id', AuthMiddleware.authenticate, controller.getById);
router.post('/', AuthMiddleware.authenticate, validateCreateTheme, controller.create);

// Owner-or-admin protected routes
router.put(
  '/:id',
  AuthMiddleware.authenticate,
  AuthMiddleware.requireThemeOwnerOrAdmin,
  validateUpdateTheme,
  controller.update
);
router.delete(
  '/:id',
  AuthMiddleware.authenticate,
  AuthMiddleware.requireThemeOwnerOrAdmin,
  controller.delete
);

export default router;
```

### Middleware Architecture

**Authentication Middleware Pattern:** [Source:
docs/architecture/backend-architecture.md#middleware-guards]

```typescript
// apps/api/src/middleware/auth.middleware.ts
export class AuthMiddleware {
  /**
   * Authenticates user from JWT token in Authorization header.
   * Attaches user object to req.user if valid.
   */
  static authenticate = async (req: AuthRequest, res: Response, next: NextFunction) => {
    // Implementation already exists
  };

  /**
   * Requires user to have admin role.
   * Must be called after authenticate middleware.
   */
  static requireAdmin = (req: AuthRequest, res: Response, next: NextFunction) => {
    // Implementation already exists
  };

  /**
   * NEW: Requires user to be theme owner OR admin.
   * Checks if user created the theme or has admin role.
   * Must be called after authenticate middleware.
   *
   * @param req - AuthRequest with authenticated user
   * @param res - Express response
   * @param next - Express next function
   * @returns 403 if user is not owner or admin
   * @returns 404 if theme not found
   */
  static requireThemeOwnerOrAdmin = async (req: AuthRequest, res: Response, next: NextFunction) => {
    const themeId = req.params.id;
    const userId = req.user!.id; // Safe to use ! because authenticate runs first
    const userRole = req.user!.role;

    // Admin can edit any theme
    if (userRole === 'Admin') {
      return next();
    }

    // Check ownership for non-admin users
    try {
      const theme = await themesRepository.findById(themeId);

      if (!theme) {
        return res.status(404).json({
          error: { message: 'Theme not found' },
        });
      }

      if (theme.created_by !== userId) {
        return res.status(403).json({
          error: { message: 'You can only edit your own themes' },
        });
      }

      next();
    } catch (error) {
      next(error); // Pass to error handler
    }
  };
}
```

**AuthRequest Interface:** [Source: docs/architecture/backend-architecture.md#middleware-guards]

```typescript
export interface AuthRequest extends Request {
  user?: User; // Set by authenticate middleware
  tenant?: Tenant;
}
```

### Database Schema

**form_themes Table:** [Source: docs/prd/epic-23-complete-theme-system.md#what-gets-kept-epic-20]

```sql
CREATE TABLE form_themes (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name VARCHAR(255) NOT NULL,
    theme_definition JSONB NOT NULL,
    is_custom BOOLEAN DEFAULT FALSE,
    created_by UUID REFERENCES users(id),  -- Creator user ID (NULL for predefined themes)
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

**Key Field:** `created_by` - Used to verify ownership in `requireThemeOwnerOrAdmin` middleware

### Repository Pattern

**Base Repository:** [Source: docs/architecture/backend-architecture.md#data-access-layer]

```typescript
// apps/api/src/repositories/themes.repository.ts
export class ThemesRepository extends BaseRepository<Theme> {
  async findById(id: string): Promise<Theme | null> {
    const query = `
      SELECT id, name, theme_definition, is_custom, created_by, created_at, updated_at
      FROM form_themes
      WHERE id = $1
    `;
    const result = await this.pool.query(query, [id]);
    return result.rows[0] || null;
  }

  // Other methods...
}
```

**Important:** Ensure `created_by` is included in SELECT query for ownership verification.

### Error Handling

**API Error Format:** [Source: docs/architecture/api-specification.md#rest-api-specification]

```typescript
// 403 Forbidden response
{
  "error": {
    "code": "FORBIDDEN",
    "message": "You can only edit your own themes",
    "timestamp": "2025-10-17T10:00:00Z",
    "requestId": "req-123"
  }
}

// 404 Not Found response
{
  "error": {
    "code": "NOT_FOUND",
    "message": "Theme not found",
    "timestamp": "2025-10-17T10:00:00Z",
    "requestId": "req-124"
  }
}
```

### Testing

**Testing Standards:** [Source: docs/architecture/testing-strategy.md#backend-api-test]

**Integration Test Structure:**

```typescript
// apps/api/tests/integration/themes-auth.test.ts
import request from 'supertest';
import { app } from '../../src/server';
import { pool } from '../../src/config/database';

describe('Theme API Authorization', () => {
  let userAToken: string;
  let userBToken: string;
  let adminToken: string;
  let userAThemeId: string;

  beforeAll(async () => {
    // Clean database
    await pool.query('DELETE FROM form_themes WHERE is_custom = TRUE');
    await pool.query("DELETE FROM users WHERE email LIKE '%test-themes%'");

    // Create test users
    const userA = await createTestUser('user-a-test-themes@example.com', 'User');
    const userB = await createTestUser('user-b-test-themes@example.com', 'User');
    const admin = await createTestUser('admin-test-themes@example.com', 'Admin');

    // Get auth tokens
    userAToken = await getAuthToken(userA.email, 'password');
    userBToken = await getAuthToken(userB.email, 'password');
    adminToken = await getAuthToken(admin.email, 'password');
  });

  afterAll(async () => {
    // Cleanup
    await pool.query('DELETE FROM form_themes WHERE is_custom = TRUE');
    await pool.query("DELETE FROM users WHERE email LIKE '%test-themes%'");
  });

  describe('POST /api/themes', () => {
    it('should allow non-admin user to create theme', async () => {
      const response = await request(app)
        .post('/api/themes')
        .set('Authorization', `Bearer ${userAToken}`)
        .send({
          name: 'User A Custom Theme',
          themeDefinition: { primaryColor: '#123456' },
        });

      expect(response.status).toBe(201);
      expect(response.body.data).toHaveProperty('id');
      userAThemeId = response.body.data.id;
    });

    it('should reject theme creation without authentication', async () => {
      const response = await request(app).post('/api/themes').send({ name: 'Test Theme' });

      expect(response.status).toBe(401);
    });
  });

  describe('PUT /api/themes/:id', () => {
    it('should allow user to edit their own theme', async () => {
      const response = await request(app)
        .put(`/api/themes/${userAThemeId}`)
        .set('Authorization', `Bearer ${userAToken}`)
        .send({ name: 'Updated Theme Name' });

      expect(response.status).toBe(200);
    });

    it('should reject user editing another user theme', async () => {
      const response = await request(app)
        .put(`/api/themes/${userAThemeId}`)
        .set('Authorization', `Bearer ${userBToken}`)
        .send({ name: 'Hacked Name' });

      expect(response.status).toBe(403);
      expect(response.body.error.message).toContain('own themes');
    });

    it('should allow admin to edit any theme', async () => {
      const response = await request(app)
        .put(`/api/themes/${userAThemeId}`)
        .set('Authorization', `Bearer ${adminToken}`)
        .send({ name: 'Admin Updated Theme' });

      expect(response.status).toBe(200);
    });
  });

  describe('DELETE /api/themes/:id', () => {
    it('should reject user deleting another user theme', async () => {
      const response = await request(app)
        .delete(`/api/themes/${userAThemeId}`)
        .set('Authorization', `Bearer ${userBToken}`);

      expect(response.status).toBe(403);
    });

    it('should allow admin to delete any theme', async () => {
      const response = await request(app)
        .delete(`/api/themes/${userAThemeId}`)
        .set('Authorization', `Bearer ${adminToken}`);

      expect(response.status).toBe(200);
    });
  });
});
```

**Test Helpers Location:** [Source: docs/architecture/testing-strategy.md#test-organization]

```
apps/api/tests/fixtures/  - Test data and helper functions
apps/api/tests/integration/  - Integration test files
```

**Test Commands:**

```bash
# Run all integration tests
npm --workspace=apps/api run test:integration

# Run specific test file
npm --workspace=apps/api run test -- --testPathPattern="themes-auth.test.ts"

# Run with verbose output
npm --workspace=apps/api run test -- --testPathPattern="themes-auth.test.ts" --verbose

# Run silently
npm --workspace=apps/api run test -- --testPathPattern="themes-auth.test.ts" --silent
```

### Coding Standards

**JSDoc Documentation:** [Source: docs/architecture/coding-standards.md#documentation-standards]

All middleware functions must include:

- Purpose description
- Parameter documentation with types
- Return value / side effects
- Exception documentation
- Usage examples for complex middleware

**Naming Conventions:** [Source: docs/architecture/coding-standards.md#naming-conventions]

- Middleware functions: camelCase static methods
- Routes: kebab-case paths (`/api/themes/:id`)
- Database tables: snake_case (`form_themes`, `created_by`)

### Security Considerations

**Input Validation:** [Source: docs/architecture/coding-standards.md#critical-fullstack-rules]

- Always validate user input on backend
- Use parameterized queries to prevent SQL injection
- Middleware order matters: authenticate → validate → authorize → controller

**Error Messages:**

- Don't leak internal implementation details
- Generic error for authentication failures
- Specific error for authorization failures (403 vs 401)

**Middleware Chain:**

```
Request → authenticate → requireThemeOwnerOrAdmin → controller
          ↓              ↓
          401            403 (if not owner/admin)
                         404 (if theme not found)
```

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-10-17 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

<!-- Populated by development agent during implementation -->

### Agent Model Used

<!-- e.g., Claude 3.5 Sonnet -->

### Debug Log References

<!-- Reference any debug logs or traces generated during development -->

### Completion Notes List

<!-- Notes about the completion of tasks and any issues encountered -->

### File List

<!-- List all files created, modified, or affected during story implementation -->

## QA Results

<!-- Results from QA Agent QA review of the completed story implementation -->
