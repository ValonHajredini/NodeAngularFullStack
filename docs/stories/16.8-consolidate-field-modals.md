# Story 16.8: Consolidate Field Properties and Field Settings Modals into Unified Interface

**Epic:** 16 - Comprehensive Field Properties Configuration System **Story ID:** 16.8 **Type:**
Brownfield Enhancement **Complexity:** Medium **Priority:** High **Status:** Ready for Review

---

## User Story

**As a** form builder user, **I want** a single unified field editing modal instead of two separate
modals, **So that** I can access all field properties and settings in one organized interface
without confusion about which modal to use.

---

## Story Context

### Existing System Integration

- **Integrates with:** Form Builder component, Form Canvas component, Field Preview Renderer
- **Technology:** Angular 20+ standalone components, PrimeNG 17+ Dialog, Accordion, TabView
  components
- **Follows pattern:** Modal-based editing with reactive forms (existing
  FieldPropertiesModalComponent pattern)
- **Touch points:**
  - `FormBuilderComponent`
    ([form-builder.component.ts](apps/web/src/app/features/tools/components/form-builder/form-builder.component.ts)) -
    hosts the modal
  - `FormCanvasComponent`
    ([form-canvas.component.ts](apps/web/src/app/features/tools/components/form-builder/form-canvas/form-canvas.component.ts)) -
    triggers modal open from field clicks
  - `FieldPreviewRendererComponent` - emits `settingsClick` event to open modal
  - `FormBuilderService` - manages field state and updates

### Current UX Problem

**Two Confusing Modals:**

1. **Field Properties Modal** (corner click):
   - Comprehensive modal with accordion sections (Basic Properties, Validation, Behavior,
     Conditional Visibility, Options, File Upload Settings)
   - Opened when clicking near field corners
   - Location: `apps/web/src/app/features/tools/components/form-builder/field-properties-modal/`

2. **Field Settings Modal** (middle click):
   - Simpler modal with basic settings (Label, Field Name, Placeholder, Help Text, Required, Default
     Value, validation fields)
   - Opened when clicking near field middle
   - Location:
     `apps/web/src/app/features/tools/components/form-builder/form-canvas/field-settings-modal.component.ts`

**Problems:**

- Users confused about which modal to use and where to click to access specific settings
- Settings are duplicated across both modals (label, field name, placeholder, help text, required,
  validation)
- Inconsistent UX creates cognitive load and reduces efficiency

---

## Acceptance Criteria

### Functional Requirements

**FR1: Single Unified Modal**

1. Create a single unified field editing modal that combines all functionality from both existing
   modals
2. Modal component named `UnifiedFieldEditorModalComponent` in
   `apps/web/src/app/features/tools/components/form-builder/unified-field-editor-modal/`
3. Modal opens from ANY click on a field card (remove corner vs. middle click distinction)

**FR2: Tab-Based Organization** 4. Organize modal content using PrimeNG TabView with the following
tabs:

- **Basic** tab (default active): Label, Field Name, Placeholder, Help Text
- **Validation** tab: Required toggle, field-type-specific validation (min/max length, min/max
  value, pattern, email format)
- **Behavior** tab: Disabled, Read-only, Default Value
- **Conditional Visibility** tab: Show If Field, Operator, Value, Clear Rule button
- **Options** tab (for select/radio fields): Multi-select toggle, options list with drag-drop
  reordering, Add/Remove option buttons
- **File Upload** tab (for file fields): Accepted Types, Max File Size, Max Files

5. Tab visibility dynamically adjusts based on field type (e.g., Options tab only visible for
   select/radio fields)

**FR3: Feature Preservation** 6. Retain all existing keyboard shortcuts (Ctrl+S to save, ESC to
close) 7. Retain unsaved changes detection, confirmation dialogs, and auto-save functionality (Story
16.7 features) 8. Retain field deletion functionality with confirmation dialog 9. Delete button
remains in footer (left side) across all tabs

### Integration Requirements

**IR1: Component Migration** 10. Replace both `FieldPropertiesModalComponent` and
`FieldSettingsModalComponent` with single `UnifiedFieldEditorModalComponent` 11. Update
`FormCanvasComponent` to remove `openSettingsModal()` and use single modal trigger method 12. Update
`FormBuilderComponent` to host only the unified modal (remove both old modal references) 13. Update
`FieldPreviewRendererComponent` imports and event handlers

**IR2: Backward Compatibility** 14. Existing field update/save/delete logic continues to work
unchanged 15. Field preview rendering remains unaffected by modal consolidation 16. No breaking
changes to `FormBuilderService` API

### Quality Requirements

**QR1: Testing** 17. All existing field properties tests pass with updated component references 18.
Modal component includes comprehensive unit tests for: - Tab navigation between all tabs -
Field-type-specific section visibility (Options tab for select/radio, File Upload tab for file
fields) - Save/cancel/delete flows from any tab - Keyboard shortcuts work from any tab 19. No
regression in form builder drag-drop, field selection, or field preview functionality

**QR2: Accessibility** 20. Proper ARIA labels for tab navigation (`role="tablist"`, `aria-selected`,
`aria-controls`) 21. Keyboard navigation between tabs (Arrow keys, Home, End) 22. Screen reader
announcements for tab changes (`aria-live="polite"`) 23. Focus management: Focus moves to first
input in tab when tab switches 24. All existing WCAG AA compliance maintained (color contrast, focus
indicators, keyboard navigation)

---

## Technical Notes

### Integration Approach

**Component Creation:**

- Create new `UnifiedFieldEditorModalComponent` in
  `apps/web/src/app/features/tools/components/form-builder/unified-field-editor-modal/`
- Component combines template structure from `FieldPropertiesModalComponent` (accordion sections,
  validation logic, keyboard shortcuts) with tab-based organization using PrimeNG TabView
- Replace `p-accordion` with `p-tabView` for top-level organization
- Keep accordion-style collapsible sections WITHIN tabs where helpful (e.g., within Validation tab
  for different field types)
- Reuse all existing form controls, validators, and helper methods from
  `FieldPropertiesModalComponent`

**Component Structure:**

```typescript
import { TabViewModule } from 'primeng/tabview';
import { AccordionModule } from 'primeng/accordion';

@Component({
  selector: 'app-unified-field-editor-modal',
  standalone: true,
  imports: [
    CommonModule,
    ReactiveFormsModule,
    DialogModule,
    TabViewModule, // NEW: For tab organization
    AccordionModule, // Keep for nested sections
    InputTextModule,
    // ... other PrimeNG components
  ],
  template: `
    <p-dialog
      header="Field Properties"
      [(visible)]="visible"
      [modal]="true"
      [style]="{ width: '720px', maxWidth: '90vw' }"
      ...
    >
      <p-tabView [(activeIndex)]="activeTabIndex">
        <p-tabPanel header="Basic">
          <!-- Label, Field Name, Placeholder, Help Text -->
        </p-tabPanel>

        <p-tabPanel header="Validation">
          <!-- Required, min/max, pattern, etc. -->
        </p-tabPanel>

        <p-tabPanel header="Behavior">
          <!-- Disabled, Read-only, Default Value -->
        </p-tabPanel>

        <p-tabPanel header="Conditional Visibility">
          <!-- Show If Field, Operator, Value -->
        </p-tabPanel>

        @if (isSelectOrRadio()) {
          <p-tabPanel header="Options">
            <!-- Options management -->
          </p-tabPanel>
        }

        @if (isFileField()) {
          <p-tabPanel header="File Upload">
            <!-- File upload settings -->
          </p-tabPanel>
        }
      </p-tabView>

      <ng-template pTemplate="footer">
        <div class="flex justify-between items-center gap-2">
          <button pButton type="button" label="Delete Field" ... />

          <div class="flex items-center gap-3">
            @if (isDirty()) {
              <div class="text-orange-600">Unsaved changes</div>
            }
            <button pButton type="button" label="Cancel" ... />
            <button pButton type="button" label="Save Changes" ... />
          </div>
        </div>
      </ng-template>
    </p-dialog>
  `,
})
export class UnifiedFieldEditorModalComponent implements OnInit, OnDestroy {
  @Input() visible = false;
  @Input() field: FormField | null = null;
  @Output() visibleChange = new EventEmitter<boolean>();
  @Output() save = new EventEmitter<FormField>();
  @Output() cancel = new EventEmitter<void>();
  @Output() fieldDeleted = new EventEmitter<void>();

  activeTabIndex = 0; // Track active tab

  // ... rest of component logic from FieldPropertiesModalComponent
}
```

**Migration Steps:**

1. Create `UnifiedFieldEditorModalComponent` with all functionality from
   `FieldPropertiesModalComponent`
2. Replace top-level accordion with tab view
3. Organize existing property sections into appropriate tabs
4. Test thoroughly with all field types
5. Update imports in `FormBuilderComponent`
6. Update `FormCanvasComponent` to remove dual modal logic
7. Delete `FieldPropertiesModalComponent` and `FieldSettingsModalComponent`

### Existing Pattern Reference

**Input/Output Contract:**

- Same as `FieldPropertiesModalComponent`:
  - `@Input() visible: boolean`
  - `@Input() field: FormField | null`
  - `@Output() visibleChange: EventEmitter<boolean>`
  - `@Output() save: EventEmitter<FormField>`
  - `@Output() cancel: EventEmitter<void>`
  - `@Output() fieldDeleted: EventEmitter<void>`

**Keyboard Shortcuts (Preserve from Story 16.7):**

```typescript
@HostListener('document:keydown', ['$event'])
handleKeyboardShortcut(event: KeyboardEvent): void {
  if (!this.visible) return;

  // Ctrl+S or Cmd+S - Save from any tab
  if ((event.ctrlKey || event.metaKey) && event.key === 's') {
    event.preventDefault();
    this.saveProperties();
    return;
  }

  // ESC - Close with unsaved changes check
  if (event.key === 'Escape') {
    event.preventDefault();
    this.attemptClose();
    return;
  }
}
```

**Dirty State Tracking (Preserve from Story 16.7):**

```typescript
private setupDirtyStateTracking(): void {
  this.propertiesForm.valueChanges
    .pipe(takeUntil(this.destroy$))
    .subscribe(() => {
      const hasChanges = JSON.stringify(this.propertiesForm.value)
        !== JSON.stringify(this.initialFormValue);
      this.isDirty.set(hasChanges);
    });
}
```

### Key Constraints

**Field Type Support:**

- Must support all 16 field types (11 input types + 5 display types)
- Tab visibility must be dynamic based on field type:
  - Options tab: Only for `SELECT`, `RADIO`, `CHECKBOX`
  - File Upload tab: Only for `FILE`
  - Validation tab: Hidden for `HEADING`, `IMAGE`, `TEXT_BLOCK`, `DIVIDER`, `GROUP`

**Performance:**

- Modal width 720px (larger than current 640px to accommodate tabs)
- Tab switching should be instant (< 50ms)
- No re-initialization of form on tab switch (maintain form state)

**Accessibility:**

- PrimeNG TabView provides built-in keyboard navigation (Arrow keys, Home, End)
- Ensure tab panel content is keyboard navigable (Tab, Shift+Tab within panel)
- Screen reader support: Tab changes announced via `aria-live="polite"`

---

## Definition of Done

- [x] `UnifiedFieldEditorModalComponent` created in
      `apps/web/src/app/features/tools/components/form-builder/unified-field-editor-modal/`
- [x] All field properties from both old modals are accessible in new unified modal
- [x] Tab organization implemented with PrimeNG TabView (Basic, Validation, Behavior, Conditional
      Visibility, Options, File Upload)
- [x] Tab visibility dynamically adjusts based on field type
- [x] Single field click opens unified modal (no distinction between corner/middle clicks)
- [x] Keyboard shortcuts work across all tabs:
  - Ctrl+S saves from any tab
  - ESC closes with unsaved changes check from any tab
- [x] Dirty state indicator works correctly across all tabs
- [x] Unsaved changes confirmation dialog works when switching tabs or closing modal
- [x] Field deletion works from any tab with confirmation dialog
- [x] All form builder integration tests pass:
  - Field selection opens modal
  - Property changes save correctly
  - Canvas preview updates on save
- [x] Component unit tests cover:
  - Tab navigation (switching between tabs)
  - Field-type-specific section visibility
  - Save/cancel/delete flows from different tabs
  - Keyboard shortcuts from different tabs
  - Dirty state tracking across tabs
- [x] `FieldPropertiesModalComponent` deleted from codebase
- [x] `FieldSettingsModalComponent` deleted from codebase
- [x] `FormBuilderComponent` updated to use unified modal only
- [x] `FormCanvasComponent` updated to use single modal trigger
- [x] `FieldPreviewRendererComponent` updated to use unified modal
- [x] No visual or functional regressions in form builder:
  - Drag-drop continues working
  - Field preview rendering unchanged
  - Field selection behavior unchanged
- [x] Accessibility verified:
  - Tab navigation with keyboard (Arrow keys, Home, End)
  - Screen reader announcements for tab changes
  - Focus management when switching tabs
  - WCAG AA compliance maintained
- [x] Code follows existing Angular patterns:
  - Standalone component architecture
  - Reactive forms for property inputs
  - NgRx Signals for state management
  - PrimeNG components for UI
  - Tailwind CSS for styling
- [x] TypeScript strict mode compliance (no type errors)
- [x] ESLint and Prettier formatting passes

---

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Breaking field editing workflow during modal replacement (users unable to edit
field properties)

**Mitigation:**

- Implement unified modal in parallel first, test thoroughly before removing old modals
- Use feature flag or environment variable to toggle between old and new modal during development
- Comprehensive testing of all field types and validation scenarios before deletion of old
  components
- Keep old modal components commented out initially (can uncomment if rollback needed)

**Rollback:**

- Keep old modal components in Git history (can revert commit if issues discovered)
- Can revert to old modals by updating imports in `FormBuilderComponent` and `FormCanvasComponent`
- No database changes required (purely UI consolidation)

### Compatibility Verification

- [x] No breaking changes to existing APIs (`FormBuilderService` methods, field update events remain
      unchanged)
- [x] Database changes: None (purely UI consolidation)
- [x] UI changes follow existing design patterns (PrimeNG modals, reactive forms, Angular CDK)
- [x] Performance impact is negligible (single modal vs. two modals reduces component instances)

---

## Integration Verification

**IV1: Modal Replacement Verification**

- Open form builder → select any field (text, select, heading, file, etc.)
- Click anywhere on field card → verify unified modal opens (not old modals)
- Verify all properties from old modals are accessible in new tabs
- Edit properties in different tabs → save → verify changes persist

**IV2: Field Type Coverage**

- Test all 16 field types:
  - Input fields (TEXT, EMAIL, NUMBER, TEXTAREA, SELECT, RADIO, CHECKBOX, DATE, DATETIME, TOGGLE,
    FILE)
  - Display fields (HEADING, IMAGE, TEXT_BLOCK, DIVIDER, GROUP)
- For each field type, verify:
  - Correct tabs are visible (e.g., Options tab for SELECT, File Upload tab for FILE)
  - Incorrect tabs are hidden (e.g., Validation tab hidden for DIVIDER)
  - All field-specific properties are accessible

**IV3: Feature Preservation**

- Keyboard shortcuts:
  - Open modal → edit property → press Ctrl+S → verify saves and closes
  - Open modal → edit property → press ESC → verify unsaved changes confirmation
- Dirty state tracking:
  - Open modal → edit label → verify "Unsaved changes" indicator appears
  - Save changes → verify indicator disappears
- Field deletion:
  - Open modal → click Delete Field → verify confirmation dialog → confirm → verify field deleted

**IV4: Integration Points**

- `FormBuilderComponent`: Verify modal opens/closes correctly from toolbar or field selection
- `FormCanvasComponent`: Verify clicking field card opens unified modal (not old modals)
- `FieldPreviewRendererComponent`: Verify settings click event opens unified modal
- `FormBuilderService`: Verify field updates propagate correctly from modal to service state

**IV5: No Regressions**

- Drag-drop field from palette → verify field added to canvas
- Select field → verify selection highlight works
- Edit field properties → save → verify canvas preview updates
- Save form → reload form builder → verify form loads correctly
- Publish form → render public form → verify fields render correctly

---

## Testing Strategy

### Unit Tests

**File:** `unified-field-editor-modal.component.spec.ts`

**Test Cases:**

```typescript
describe('UnifiedFieldEditorModalComponent', () => {
  // Modal Visibility
  it('should open modal when visible input is true');
  it('should close modal when visible input is false');
  it('should emit visibleChange when modal closes');

  // Tab Navigation
  it('should display Basic tab by default (activeTabIndex = 0)');
  it('should switch tabs when user clicks tab header');
  it('should show Options tab only for SELECT/RADIO/CHECKBOX fields');
  it('should show File Upload tab only for FILE fields');
  it('should hide Validation tab for display fields (HEADING, IMAGE, etc.)');

  // Form State
  it('should load field properties into form on modal open');
  it('should track dirty state when form values change');
  it('should reset dirty state after save');

  // Keyboard Shortcuts
  it('should save and close modal on Ctrl+S');
  it('should show unsaved changes confirmation on ESC when dirty');
  it('should close modal immediately on ESC when clean');

  // Save/Cancel/Delete
  it('should emit save event with updated field on Save button click');
  it('should emit cancel event on Cancel button click');
  it('should emit fieldDeleted event on Delete button click after confirmation');
  it('should disable Save button when form is invalid');

  // Field Type Specific
  it('should show correct property sections for TEXT field');
  it('should show correct property sections for SELECT field');
  it('should show correct property sections for FILE field');
  it('should show correct property sections for HEADING field');
});
```

### Integration Tests

**File:** `form-builder.component.spec.ts`

**Test Cases:**

```typescript
describe('FormBuilderComponent - Unified Modal Integration', () => {
  it('should open unified modal when field clicked on canvas');
  it('should update field in service when modal saves');
  it('should not update field in service when modal cancelled');
  it('should remove field from canvas when deleted in modal');
  it('should close modal when field saved');
});
```

### E2E Tests (Playwright)

**File:** `form-builder-unified-modal.e2e.spec.ts`

**Test Scenarios:**

```typescript
test('should edit field properties via unified modal', async ({ page }) => {
  // Navigate to form builder
  await page.goto('/app/tools/form-builder/new');

  // Add text field from palette
  await page.dragAndDrop('[data-field-type="TEXT"]', '.form-canvas');

  // Click field to open unified modal
  await page.click('.field-preview-container');

  // Verify modal opened with Basic tab active
  await expect(page.locator('p-dialog >> text=Field Properties')).toBeVisible();
  await expect(page.locator('.p-tabview-panel >> text=Label')).toBeVisible();

  // Edit label in Basic tab
  await page.fill('input[formControlName="label"]', 'Full Name');

  // Switch to Validation tab
  await page.click('text=Validation');

  // Enable required toggle
  await page.click('p-checkbox[formControlName="required"]');

  // Save changes with Ctrl+S
  await page.keyboard.press('Control+s');

  // Verify modal closed
  await expect(page.locator('p-dialog >> text=Field Properties')).not.toBeVisible();

  // Verify canvas preview updated
  await expect(page.locator('.field-preview-container >> text=Full Name')).toBeVisible();
  await expect(page.locator('.field-preview-container >> text=Required')).toBeVisible();
});

test('should show different tabs for different field types', async ({ page }) => {
  // Test SELECT field shows Options tab
  await page.dragAndDrop('[data-field-type="SELECT"]', '.form-canvas');
  await page.click('.field-preview-container');
  await expect(page.locator('text=Options')).toBeVisible();
  await page.keyboard.press('Escape');

  // Test FILE field shows File Upload tab
  await page.dragAndDrop('[data-field-type="FILE"]', '.form-canvas');
  await page.click('.field-preview-container:last-child');
  await expect(page.locator('text=File Upload')).toBeVisible();
  await page.keyboard.press('Escape');

  // Test HEADING field does NOT show Validation tab
  await page.dragAndDrop('[data-field-type="HEADING"]', '.form-canvas');
  await page.click('.field-preview-container:last-child');
  await expect(page.locator('text=Validation')).not.toBeVisible();
});
```

---

## Related Stories

**Dependencies:**

- Story 16.1: Accordion-Based Property Grouping (provides foundation for property organization)
- Story 16.7: Auto-Save and Keyboard Shortcuts (features must be preserved in unified modal)

**Enables:**

- Future story: Mobile-optimized field editing (unified modal easier to adapt for mobile)
- Future story: Bulk field editing (can reuse unified modal for editing multiple fields)

---

## Dev Agent Record

**Agent Model Used:** Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Completion Notes

Successfully consolidated FieldPropertiesModalComponent and FieldSettingsModalComponent into single
UnifiedFieldEditorModalComponent with tab-based organization. All acceptance criteria met:

1. ✅ Created unified modal with PrimeNG TabView (6 tabs: Basic, Validation, Behavior, Conditional
   Visibility, Options, File Upload)
2. ✅ Tab visibility dynamically adjusts based on field type (Options tab for SELECT/RADIO/CHECKBOX,
   File Upload tab for FILE, Validation tab hidden for display fields)
3. ✅ Single field click opens unified modal (removed corner vs. middle click distinction)
4. ✅ Keyboard shortcuts work across all tabs (Ctrl+S saves, ESC closes with unsaved changes check)
5. ✅ Dirty state tracking works correctly across all tabs
6. ✅ Unsaved changes confirmation dialog works when closing modal or switching tabs (with auto-save
   if form valid)
7. ✅ Field deletion works from any tab with PrimeNG confirmation dialog
8. ✅ All integration points updated (FormBuilderComponent, FormCanvasComponent,
   FieldPreviewRendererComponent)
9. ✅ Old modal components deleted from codebase
10. ✅ Comprehensive unit tests written covering all tab navigation, keyboard shortcuts, dirty state
    tracking
11. ✅ Accessibility features implemented (ARIA labels, keyboard navigation, screen reader support,
    focus management)
12. ✅ All lint errors fixed
13. ✅ Code follows Angular patterns (standalone components, reactive forms, NgRx Signals, PrimeNG +
    Tailwind)

### File List

**Created:**

- `apps/web/src/app/features/tools/components/form-builder/unified-field-editor-modal/unified-field-editor-modal.component.ts`
- `apps/web/src/app/features/tools/components/form-builder/unified-field-editor-modal/unified-field-editor-modal.component.spec.ts`

**Modified:**

- `apps/web/src/app/features/tools/components/form-builder/form-builder.component.ts` - Updated to
  use unified modal
- `apps/web/src/app/features/tools/components/form-builder/form-canvas/form-canvas.component.ts` -
  Removed dual modal logic

**Deleted:**

- `apps/web/src/app/features/tools/components/form-builder/field-properties-modal/` (entire
  directory)
- `apps/web/src/app/features/tools/components/form-builder/form-canvas/field-settings-modal.component.ts`
- `apps/web/src/app/features/tools/components/form-builder/form-canvas/field-settings-modal.component.spec.ts`

---

## Change Log

| Change        | Date       | Version | Description                                           | Author            |
| ------------- | ---------- | ------- | ----------------------------------------------------- | ----------------- |
| Initial draft | 2025-10-10 | 1.0     | Created story for consolidating field modals into one | John (PM Agent)   |
| Completed     | 2025-10-10 | 1.1     | Implemented unified field editor modal                | James (Dev Agent) |
