# Story 10.7: Form Settings and Draft Persistence

## Status

Draft

## Story

**As a** form creator, **I want** to configure global form settings and save drafts to the database,
**so that** I can set form-wide options and resume editing later.

## Acceptance Criteria

1. **AC1**: Form settings dialog accessible via toolbar button
2. **AC2**: Settings include: Form Title (required), Form Description, Column Layout (1-3 columns),
   Field Spacing (compact/normal/relaxed)
3. **AC3**: Submission settings: Success message, Redirect URL (optional), Allow multiple
   submissions toggle
4. **AC4**: "Save Draft" button calls `POST /api/forms` API to create new form or
   `PUT /api/forms/:id` to update
5. **AC5**: Draft saves form metadata (title, description, settings) and current schema JSON
6. **AC6**: Auto-save every 30 seconds if form is dirty (unsaved changes)
7. **AC7**: "My Forms" list view shows all user's draft and published forms with last modified date
8. **AC8**: Load existing draft populates canvas, properties, and settings
9. **AC9**: Dirty state indicator shows unsaved changes with warning before navigation
10. **AC10**: Delete draft confirms action and calls `DELETE /api/forms/:id` API

## Tasks / Subtasks

- [ ] Create FormsApiService for API communication (AC: 4, 7, 10)
  - [ ] Create `/apps/web/src/app/features/tools/components/form-builder/forms-api.service.ts`
  - [ ] Inject ApiClient from @core/api/api.client
  - [ ] Import FormMetadata, FormSchema from @nodeangularfullstack/shared
  - [ ] Implement `createForm(formData: Partial<FormMetadata>): Observable<FormMetadata>` - POST
        /api/forms
  - [ ] Implement
        `updateForm(id: string, formData: Partial<FormMetadata>): Observable<FormMetadata>` - PUT
        /api/forms/:id
  - [ ] Implement
        `getForms(page?: number, limit?: number): Observable<PaginatedResponse<FormMetadata>>` - GET
        /api/forms
  - [ ] Implement `getFormById(id: string): Observable<FormMetadata>` - GET /api/forms/:id
  - [ ] Implement `deleteForm(id: string): Observable<void>` - DELETE /api/forms/:id
  - [ ] Add error handling with catchError() and toast notifications
  - [ ] Add @Injectable({ providedIn: 'root' }) decorator

- [ ] Update FormSettings component with settings form (AC: 1, 2, 3)
  - [ ] Open
        `/apps/web/src/app/features/tools/components/form-builder/form-settings/form-settings.component.ts`
  - [ ] Import ReactiveFormsModule, FormBuilder, Validators
  - [ ] Create reactive form group:
    - title: ['', [Validators.required, Validators.maxLength(200)]]
    - description: ['', Validators.maxLength(2000)]
    - columnLayout: [1, [Validators.min(1), Validators.max(3)]]
    - fieldSpacing: ['normal'] (compact/normal/relaxed)
    - successMessage: ['Thank you for your submission!']
    - redirectUrl: ['', Validators.pattern(/^https?:\/\/.+/)]
    - allowMultipleSubmissions: [true]
  - [ ] Display as PrimeNG Dialog with header "Form Settings"
  - [ ] Use @Input() visible and @Output() visibleChange for dialog control
  - [ ] Emit @Output() settingsSaved event with form values on save
  - [ ] Validate redirectUrl is valid URL (optional field)

- [ ] Implement save draft functionality (AC: 4, 5)
  - [ ] Update FormBuilder main component toolbar
  - [ ] Add "Save Draft" button (pi-save icon)
  - [ ] Implement saveDraft() method:
    - Check if currentForm has ID (existing draft) or null (new draft)
    - Collect form metadata from FormSettings
    - Collect schema JSON from formFields signal
    - If new: call formsApiService.createForm({ ...metadata, schema })
    - If existing: call formsApiService.updateForm(id, { ...metadata, schema })
    - On success: update currentForm signal, mark form as clean, show toast "Draft saved"
    - On error: show error toast with message
  - [ ] Disable save button when form is not dirty or has validation errors

- [ ] Implement auto-save functionality (AC: 6)
  - [ ] In FormBuilder component ngOnInit, setup auto-save interval:
    - setInterval(() => { if (isDirty()) { saveDraft() } }, 30000) // 30 seconds
    - Store interval reference for cleanup
  - [ ] Clear interval in ngOnDestroy to prevent memory leaks
  - [ ] Debounce auto-save to prevent saving during active editing
  - [ ] Show "Auto-saving..." toast during auto-save (brief, non-intrusive)

- [ ] Create "My Forms" list view (AC: 7)
  - [ ] Create
        `/apps/web/src/app/features/tools/components/form-builder/forms-list/forms-list.component.ts`
  - [ ] Make standalone component with PrimeNG DataView or Table
  - [ ] Inject FormsApiService
  - [ ] Load forms on init: call formsApiService.getForms()
  - [ ] Display each form as card/row with:
    - Title
    - Description (truncated)
    - Status badge (Draft/Published)
    - Last modified date (formatted with DatePipe)
    - Actions: Edit, Delete buttons
  - [ ] Implement pagination using PrimeNG Paginator
  - [ ] Add "New Form" button to create blank form
  - [ ] Route to forms-list at /tools/form-builder/list
  - [ ] Route to form-builder at /tools/form-builder/:id for editing

- [ ] Implement load existing draft (AC: 8)
  - [ ] Update FormBuilder component to accept route param :id
  - [ ] Inject ActivatedRoute to get form ID from URL
  - [ ] If ID present, call formsApiService.getFormById(id) on init
  - [ ] On form load:
    - Update currentForm signal with metadata
    - Parse schema JSON and populate formFields signal
    - Update form settings from metadata
    - Mark form as clean (just loaded)
  - [ ] Show loading spinner while fetching form
  - [ ] Handle 404 error: redirect to forms list with error toast

- [ ] Implement dirty state tracking and navigation warning (AC: 9)
  - [ ] Create CanDeactivate guard: `/apps/web/src/app/core/guards/unsaved-changes.guard.ts`
  - [ ] Check isDirty signal in guard
  - [ ] If dirty, show PrimeNG ConfirmDialog: "You have unsaved changes. Are you sure you want to
        leave?"
  - [ ] Return true if user confirms, false to cancel navigation
  - [ ] Apply guard to form-builder route
  - [ ] Add visual indicator in toolbar: "\*" or "Unsaved changes" badge when dirty

- [ ] Implement delete draft (AC: 10)
  - [ ] In forms-list component, add delete button for each form
  - [ ] Implement deleteForm(formId: string) method:
    - Show PrimeNG ConfirmDialog: "Are you sure you want to delete this form?"
    - On confirm: call formsApiService.deleteForm(formId)
    - On success: remove form from list, show toast "Form deleted"
    - On error: show error toast
  - [ ] Prevent deletion of published forms (show warning instead)

- [ ] Integrate with FormBuilderService (AC: 5, 8, 9)
  - [ ] Update FormBuilderService with methods:
    - loadForm(form: FormMetadata): void - populates all signals from loaded form
    - exportFormData(): { metadata: FormMetadata, schema: FormSchema } - collects all data for
      saving
    - resetForm(): void - clears all signals to blank state
  - [ ] Update isDirty tracking to detect any change to form/fields/settings
  - [ ] Mark dirty on: field added/removed/updated, settings changed, form metadata changed
  - [ ] Mark clean on: save success, form loaded

- [ ] Write component tests (AC: 6, 8, 9, 10)
  - [ ] Create forms-api.service.spec.ts:
    - Mock ApiClient
    - Test all CRUD methods
    - Test error handling
  - [ ] Update form-builder.component.spec.ts:
    - Test saveDraft() method
    - Test auto-save interval setup/cleanup
    - Test load form from route param
    - Mock FormsApiService
  - [ ] Create forms-list.component.spec.ts:
    - Test forms load on init
    - Test pagination
    - Test delete confirmation
    - Mock FormsApiService
  - [ ] Test unsaved-changes.guard.ts:
    - Test blocks navigation when dirty
    - Test allows navigation when clean
    - Test user confirmation dialog

- [ ] Integration testing (IV: 1, 2, 3, 4, 5)
  - [ ] Test complete flow: Create form → Add fields → Save draft → Reload → Form restored
  - [ ] Test auto-save triggers after 30 seconds of inactivity
  - [ ] Test debounce prevents excessive saves
  - [ ] Test form list shows correct draft/published status
  - [ ] Test multi-tenancy: users only see their tenant's forms (when enabled)

## Dev Notes

### Previous Story Insights

Story 10.6 implemented field properties configuration. This story completes the Form Builder by
adding persistence (save/load) and form settings.

### Data Models

**Form Persistence Data:** [Source: docs/prd-form-builder/epic-10#Story-1.7]

- Metadata: title, description, status (draft/published), userId, tenantId
- Settings: columnLayout, fieldSpacing, successMessage, redirectUrl, allowMultipleSubmissions
- Schema: JSON representation of formFields array
- All saved via POST/PUT /api/forms

**API Response Format:** [Source: docs/architecture/api-specification.md]

- Success: `{ success: true, data: FormMetadata }`
- Pagination: `{ data: FormMetadata[], pagination: { page, limit, total, totalPages } }`
- Error: `{ error: { code, message, details, timestamp, requestId } }`

### API Specifications

**Forms API Endpoints:** [Source: docs/prd-form-builder/epic-10#Story-1.3]

- POST /api/forms - Create new form (requires auth)
- PUT /api/forms/:id - Update existing form (requires auth + ownership)
- GET /api/forms - List user's forms with pagination (requires auth)
- GET /api/forms/:id - Get single form (requires auth + ownership)
- DELETE /api/forms/:id - Delete form (requires auth + ownership)

**Request/Response:**

- POST body: `{ title, description, schema: { fields: [...], settings: {...} } }`
- PUT body: Same as POST (partial updates allowed)
- GET response: `{ data: { id, userId, title, description, status, schema, createdAt, updatedAt } }`

### Component Specifications

**Auto-Save Pattern:** [Source: docs/prd-form-builder/epic-10#Story-1.7-AC6]

- setInterval() to check isDirty every 30 seconds
- Only save if form is dirty
- Debounce to prevent saving during active editing
- Clear interval on component destroy
- Show non-intrusive "Auto-saving..." notification

**Dirty State Tracking:** [Source: docs/prd-form-builder/epic-10#Story-1.7-AC9]

- Track any change to form metadata, settings, or fields
- CanDeactivate guard to warn before navigation
- Visual indicator in UI (badge or asterisk)
- Reset dirty state on successful save or form load

**Forms List Pattern:** [Source: docs/architecture/frontend-architecture.md#Component-Architecture]

- Standalone component with PrimeNG DataView/Table
- Paginated list of user's forms
- Actions: Edit (navigate to /tools/form-builder/:id), Delete (confirm + API call)
- Status badges for draft/published
- Responsive card/table layout

### File Locations

**New Service:** [Source: docs/architecture/unified-project-structure.md#apps/web]

- Create: `/apps/web/src/app/features/tools/components/form-builder/forms-api.service.ts`
- Pattern: Injectable service using ApiClient for HTTP calls

**New Component:** [Source: docs/architecture/unified-project-structure.md#apps/web]

- Create:
  `/apps/web/src/app/features/tools/components/form-builder/forms-list/forms-list.component.ts`
- Route: /tools/form-builder/list

**New Guard:** [Source: docs/architecture/unified-project-structure.md#apps/web]

- Create: `/apps/web/src/app/core/guards/unsaved-changes.guard.ts`
- Type: CanDeactivate guard

**Components to Update:** [Source: docs/architecture/unified-project-structure.md#apps/web]

- Update: `/apps/web/src/app/features/tools/components/form-builder/form-builder.component.ts`
- Update:
  `/apps/web/src/app/features/tools/components/form-builder/form-settings/form-settings.component.ts`
- Update: `/apps/web/src/app/features/tools/components/form-builder/form-builder.service.ts`

**Routing:** [Source: docs/architecture/unified-project-structure.md#apps/web]

- Update: `/apps/web/src/app/features/tools/tools.routes.ts`
- Add routes: /tools/form-builder/list, /tools/form-builder/:id

**Tests:** [Source: docs/architecture/testing-strategy.md#Frontend-Tests]

- Create: `forms-api.service.spec.ts`
- Create: `forms-list.component.spec.ts`
- Create: `unsaved-changes.guard.spec.ts`
- Update: `form-builder.component.spec.ts`

### Testing Requirements

**Service Tests:** [Source: docs/architecture/testing-strategy.md#Frontend-Component-Test]

- Mock ApiClient with jasmine.createSpyObj
- Test all CRUD methods return correct observables
- Test error handling with catchError
- Verify correct API endpoints called

**Component Tests:** [Source: docs/architecture/testing-strategy.md#Frontend-Component-Test]

- Test saveDraft() calls API service
- Test auto-save interval setup and cleanup
- Test form loading from route params
- Mock FormsApiService and ActivatedRoute
- Test dirty state tracking

**Guard Tests:**

- Test CanDeactivate returns false when dirty
- Test CanDeactivate returns true when clean
- Mock ConfirmDialog service

**Integration Tests:**

- E2E flow: Create → Save → Reload → Edit → Save
- Test auto-save triggers
- Test navigation warning works

**Test Commands:** [Source: docs/CLAUDE.md#Testing-Commands]

- Run frontend tests: `npm run test:web`
- Run specific tests:
  `npm --workspace=apps/web run test -- --include="**/forms-api.service.spec.ts" --watch=false`

### Technical Constraints

**API Service Pattern:** [Source:
docs/architecture/frontend-architecture.md#Frontend-Services-Layer]

- Inject ApiClient for HTTP calls
- Return Observable<T> from all methods
- Use catchError() for error handling
- Show toast notifications for user feedback
- Injectable at root level for singleton

**Auto-Save Implementation:** [Source: docs/prd-form-builder/epic-10#Story-1.7-IV3]

- Debounce to prevent excessive API calls
- Only save if isDirty is true
- Clear interval on component destroy (prevent memory leaks)
- Handle concurrent saves (prevent race conditions)
- Show subtle UI feedback during auto-save

**Navigation Guard:** [Source: docs/architecture/frontend-architecture.md#Protected-Route-Pattern]

- Implement CanDeactivate<FormBuilderComponent> interface
- Check component's isDirty state
- Show PrimeNG ConfirmDialog for user confirmation
- Return Observable<boolean> or boolean
- Apply to form-builder route config

**Multi-Tenancy:** [Source: docs/prd-form-builder/epic-10#Story-1.7-IV5]

- Forms filtered by tenantId on backend (handled by API)
- Frontend displays only user's accessible forms
- No special frontend logic needed (backend enforces isolation)

**Error Handling:** [Source: docs/architecture/frontend-architecture.md#Frontend-Services-Layer]

- Catch HTTP errors with catchError()
- Show user-friendly error messages via toast
- Log errors to console for debugging
- Handle 401 (redirect to login), 403 (show permission error), 404 (redirect to list)

### Testing

**Test File Location:** [Source: docs/architecture/testing-strategy.md#Frontend-Tests]

- `/apps/web/src/app/features/tools/components/form-builder/forms-api.service.spec.ts`
- `/apps/web/src/app/features/tools/components/form-builder/forms-list/forms-list.component.spec.ts`
- `/apps/web/src/app/core/guards/unsaved-changes.guard.spec.ts`

**Testing Standards:** [Source: docs/architecture/testing-strategy.md#Frontend-Component-Test]

- Mock HTTP calls with jasmine.createSpyObj
- Test auto-save interval with fakeAsync/tick
- Test navigation guard with mock router
- Test dirty state tracking on various changes
- Verify API calls made with correct payloads

**Testing Frameworks:** [Source: docs/architecture/tech-stack.md]

- Karma + Jasmine for Angular testing
- Angular Testing Utilities (TestBed, fakeAsync, tick)
- RxJS testing utilities for observable testing

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-04 | 1.0     | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
