# Story 15.3: Add TEXT_BLOCK Field Type for Explanatory Content

**Epic:** Epic 15: Content Display Field Types **Story Type:** New Feature Implementation
**Estimated Effort:** 8-10 hours

---

## User Story

**As a** form creator, **I want** to add large blocks of formatted text to my forms, **So that** I
can provide detailed instructions, terms & conditions, disclaimers, explanatory content, or other
rich text information to form respondents without requiring them to input anything.

---

## Story Context

### Existing System Integration

**Integrates with:**

- Form field type system (`packages/shared/src/types/forms.types.ts`)
- Field palette component (`apps/web/src/app/features/tools/components/form-builder/field-palette/`)
- Form canvas component (`apps/web/src/app/features/tools/components/form-builder/form-canvas/`)
- Field properties modal
  (`apps/web/src/app/features/tools/components/form-builder/field-properties/`)
- Public form renderer (`apps/web/src/app/features/public/form-renderer/`)
- **HTML sanitization** (security critical - prevent XSS attacks)

**Technology:**

- Angular 20+ standalone components with signals
- TypeScript 5.3+ with strict mode
- PrimeNG 17+ UI components (Editor for rich text)
- **DOMPurify** or Angular's DomSanitizer for HTML sanitization
- Tailwind CSS for styling
- @nodeangularfullstack/shared for type definitions

**Follows pattern:**

- Existing field type pattern (TEXT, EMAIL, SELECT, etc.)
- Existing HTML content rendering (form success messages)
- Field properties modal configuration pattern
- Security: Similar to form submission HTML sanitization middleware

**Touch points:**

- `FormFieldType` enum (add TEXT_BLOCK type)
- Field palette template (add TEXT_BLOCK button)
- Form canvas template (render TEXT_BLOCK preview with truncation)
- Field properties modal (add rich text editor)
- Form renderer template (render sanitized HTML)
- HTML sanitization utility (reuse or create)

---

## Acceptance Criteria

### Functional Requirements

**1. Type Definition (Shared Package)**

- [ ] Add `TEXT_BLOCK = 'text_block'` to `FormFieldType` enum in
      `packages/shared/src/types/forms.types.ts`
- [ ] Add JSDoc comment: `/** Text block for instructions/explanations (non-input, display only) */`
- [ ] Define `TextBlockMetadata` interface:
  ```typescript
  interface TextBlockMetadata {
    content: string; // HTML content (sanitized)
    alignment?: 'left' | 'center' | 'right' | 'justify';
    backgroundColor?: string; // Optional background color
    padding?: 'none' | 'small' | 'medium' | 'large';
    collapsible?: boolean; // Show "Read more" for long content
    collapsed?: boolean; // Initial collapsed state
  }
  ```
- [ ] Rebuild shared package: `npm run build:shared`

**2. Field Palette Integration**

- [ ] Add TEXT_BLOCK field button to field palette component
- [ ] Use document/text icon: `<i class="pi pi-align-justify"></i>` or
      `<i class="pi pi-file-edit"></i>`
- [ ] Button labeled "Text Block" or "Instructions"
- [ ] Clicking/dragging TEXT_BLOCK creates new text block field
- [ ] TEXT_BLOCK appears in "Display Fields" section

**3. Field Creation & Default Values**

- [ ] FormBuilderService creates TEXT_BLOCK field with defaults:
  - `type: FormFieldType.TEXT_BLOCK`
  - `label: "Text Block"` (internal label, not displayed)
  - `fieldName: "text_block_[timestamp]"` (unique identifier)
  - `required: false` (text blocks don't collect data)
  - `order: [next available order]`
  - `metadata: { content: '<p>Add your instructions here...</p>', alignment: 'left', padding: 'medium' }`
- [ ] TEXT_BLOCK field gets position property if row layout enabled

**4. Form Canvas Preview**

- [ ] TEXT_BLOCK field displays in canvas with:
  - First 3-5 lines of text (plain text, HTML stripped)
  - Truncation indicator if content longer ("... Read more")
  - Edit icon on hover
  - Delete icon on hover
  - Drag handle for repositioning
  - Light background color if configured
- [ ] Clicking text block opens field properties modal
- [ ] Text block respects row-column positioning (if in row layout)

**5. Field Properties Modal - TEXT_BLOCK Configuration Panel**

- [ ] Modal shows TEXT_BLOCK-specific properties:
  - **Rich Text Editor**:
    - PrimeNG Editor (Quill-based) or similar
    - Toolbar: Bold, Italic, Underline, Strikethrough
    - Toolbar: Headings (H3-H6, not H1-H2 for accessibility)
    - Toolbar: Bullet list, Numbered list
    - Toolbar: Link, Blockquote
    - Toolbar: Align left, center, right, justify
    - No image upload (use IMAGE field instead)
    - No video embed (security risk)
    - Character limit: 5000 characters
  - **Text Alignment** (overall block):
    - Buttons: left, center, right, justify
    - Default: left
  - **Background Color** (optional):
    - Color picker
    - Default: transparent
    - Show preview of background color
  - **Padding**:
    - Dropdown: none, small, medium, large
    - Default: medium
    - Help text showing pixel values (none=0, small=8px, medium=16px, large=24px)
  - **Collapsible Content** (optional for long blocks):
    - Checkbox: "Make content collapsible"
    - If enabled, show "Initially collapsed" checkbox
    - Help text: "Show 'Read more' for content longer than 500 words"
- [ ] Changes update field in real-time
- [ ] Preview of formatted text shown in modal
- [ ] Save button persists changes to FormBuilderService state
- [ ] Cancel button reverts changes

**6. HTML Sanitization (Security Critical)**

- [ ] Install DOMPurify: `npm install dompurify @types/dompurify`
- [ ] Create HTML sanitization service/utility:
  - Whitelist allowed HTML tags: `<p>`, `<h3>`, `<h4>`, `<h5>`, `<h6>`, `<strong>`, `<em>`, `<u>`,
    `<s>`, `<ul>`, `<ol>`, `<li>`, `<a>`, `<blockquote>`, `<br>`
  - Whitelist allowed attributes: `href` (for `<a>`), `target`, `rel` (force
    `rel="noopener noreferrer"` for external links)
  - Remove dangerous tags: `<script>`, `<iframe>`, `<object>`, `<embed>`, `<style>`
  - Remove event handlers: `onclick`, `onerror`, `onload`, etc.
  - Remove `javascript:` URLs
- [ ] Sanitize content when saving (FormBuilderService)
- [ ] Sanitize content when rendering (FormRendererComponent)
- [ ] Test with malicious HTML payloads (XSS prevention)

**7. Public Form Renderer - TEXT_BLOCK Display**

- [ ] Form renderer detects `field.type === FormFieldType.TEXT_BLOCK`
- [ ] Renders sanitized HTML content:
  ```html
  <div
    class="form-text-block mb-4"
    [class.text-left]="field.metadata?.alignment === 'left'"
    [class.text-center]="field.metadata?.alignment === 'center'"
    [class.text-right]="field.metadata?.alignment === 'right'"
    [class.text-justify]="field.metadata?.alignment === 'justify'"
    [style.background-color]="field.metadata?.backgroundColor"
    [class.p-0]="field.metadata?.padding === 'none'"
    [class.p-2]="field.metadata?.padding === 'small'"
    [class.p-4]="field.metadata?.padding === 'medium'"
    [class.p-6]="field.metadata?.padding === 'large'"
  >
    <div class="text-block-content" [innerHTML]="sanitizeHtml(field.metadata?.content)"></div>
    @if (field.metadata?.collapsible && isContentLong(field)) {
    <button
      type="button"
      class="read-more-btn text-blue-600 mt-2"
      (click)="toggleCollapse(field.id)"
    >
      {{ isCollapsed(field.id) ? 'Read more' : 'Read less' }}
    </button>
    }
  </div>
  ```
- [ ] Links open in new tab with `target="_blank"` and `rel="noopener noreferrer"`
- [ ] Content is responsive (proper line breaks, no horizontal scroll)
- [ ] Long content (>500 words) shows "Read more" if collapsible enabled
- [ ] Text block is non-interactive (except "Read more" button and links)

**8. Data Exclusion (Non-Input Field)**

- [ ] TEXT_BLOCK fields excluded from form validation logic
- [ ] TEXT_BLOCK fields excluded from form submission data
- [ ] TEXT_BLOCK fields don't create FormControl in reactive form group
- [ ] FormRendererComponent `buildFormGroup()` skips TEXT_BLOCK fields

**9. Row Layout Compatibility**

- [ ] TEXT_BLOCK works in row-based layout mode
- [ ] Can be positioned in any row/column
- [ ] Drag-drop from palette to row/column works
- [ ] Moving TEXT_BLOCK between columns works
- [ ] TEXT_BLOCK respects column width (full column width)

### Integration Requirements

**10. Backward Compatibility**

- [ ] Existing forms without TEXT_BLOCK continue working
- [ ] Existing field types unaffected
- [ ] Form publishing workflow unchanged
- [ ] Form submission API unchanged

**11. Existing Pattern Adherence**

- [ ] TEXT_BLOCK follows same field lifecycle as other field types
- [ ] Uses existing drag-drop infrastructure (Angular CDK)
- [ ] Uses existing field properties modal infrastructure
- [ ] HTML sanitization pattern consistent with form submission sanitization

**12. State Persistence**

- [ ] TEXT_BLOCK configuration saved to database on form save
- [ ] TEXT_BLOCK with HTML content loads correctly from database on page reload
- [ ] HTML content persists without corruption (escaping handled correctly)
- [ ] No data loss when toggling row layout on/off

### Quality Requirements

**13. Testing**

- [ ] Unit tests for TEXT_BLOCK field creation in FormBuilderService
- [ ] Unit tests for TEXT_BLOCK preview rendering in FormCanvasComponent
- [ ] Unit tests for TEXT_BLOCK properties panel in FieldPropertiesComponent
- [ ] Unit tests for TEXT_BLOCK rendering in FormRendererComponent
- [ ] Unit tests verify TEXT_BLOCK excluded from form submission
- [ ] **Security tests for HTML sanitization** (test malicious payloads)
- [ ] Integration tests verify TEXT_BLOCK in published forms
- [ ] Test "Read more" collapse/expand functionality

**14. Security Testing (Critical)**

- [ ] Test XSS prevention with malicious HTML:
  - `<script>alert('XSS')</script>`
  - `<img src=x onerror="alert('XSS')">`
  - `<a href="javascript:alert('XSS')">Click</a>`
  - `<iframe src="https://evil.com"></iframe>`
  - `<object data="https://evil.com"></object>`
  - Event handlers: `onclick`, `onerror`, `onload`, etc.
- [ ] Verify sanitization removes dangerous content
- [ ] Verify safe HTML passes through (paragraphs, headings, lists, links)
- [ ] Test with Unicode characters and special characters
- [ ] Test with nested HTML (multiple levels)

**15. Styling & UX**

- [ ] TEXT_BLOCK preview in canvas shows truncated content clearly
- [ ] Rich text editor in properties modal is user-friendly
- [ ] Editor toolbar is intuitive (common formatting options)
- [ ] Background color preview shows in properties modal
- [ ] Padding options provide appropriate spacing
- [ ] "Read more" button is clearly visible and clickable
- [ ] Collapsed content shows first ~150 words before truncation

**16. Accessibility**

- [ ] Heading hierarchy preserved (H3-H6 allowed, not H1-H2)
- [ ] Links have appropriate `rel` attributes
- [ ] Screen readers can navigate content properly
- [ ] "Read more" button accessible via keyboard (Tab + Enter)
- [ ] Collapsed content has `aria-expanded` attribute
- [ ] Text contrast meets WCAG 2.1 AA standards

**17. Performance**

- [ ] HTML sanitization doesn't cause performance issues
- [ ] Long text blocks don't slow page rendering
- [ ] "Read more" functionality works smoothly (no layout shift)
- [ ] No excessive DOM nodes created (optimize HTML structure)

**18. Documentation**

- [ ] JSDoc comments added to new code
- [ ] FormFieldType enum updated with TEXT_BLOCK documentation
- [ ] HTML sanitization utility documented (security considerations)
- [ ] Allowed HTML tags documented (whitelist)
- [ ] CLAUDE.md updated with TEXT_BLOCK field type information

---

## Technical Implementation Notes

### 1. Shared Type Definition

**File:** `packages/shared/src/types/forms.types.ts`

```typescript
export enum FormFieldType {
  // ... existing types ...
  /** Text block for instructions/explanations (non-input, display only) */
  TEXT_BLOCK = 'text_block',
}

// Add to FormField metadata union type
interface TextBlockMetadata {
  content: string; // HTML content (sanitized)
  alignment?: 'left' | 'center' | 'right' | 'justify';
  backgroundColor?: string; // Optional background color
  padding?: 'none' | 'small' | 'medium' | 'large';
  collapsible?: boolean; // Show "Read more" for long content
  collapsed?: boolean; // Initial collapsed state
}
```

### 2. HTML Sanitization Service

**File:** `apps/web/src/app/shared/services/html-sanitizer.service.ts`

```typescript
import { Injectable } from '@angular/core';
import DOMPurify from 'dompurify';

@Injectable({
  providedIn: 'root',
})
export class HtmlSanitizerService {
  /**
   * Sanitizes HTML content to prevent XSS attacks.
   * Whitelist safe HTML tags and attributes only.
   */
  sanitize(html: string): string {
    // Configure DOMPurify with strict whitelist
    const config = {
      ALLOWED_TAGS: [
        'p',
        'h3',
        'h4',
        'h5',
        'h6',
        'strong',
        'em',
        'u',
        's',
        'ul',
        'ol',
        'li',
        'a',
        'blockquote',
        'br',
      ],
      ALLOWED_ATTR: ['href', 'target', 'rel'],
      ALLOW_DATA_ATTR: false,
      ALLOW_UNKNOWN_PROTOCOLS: false,
      SAFE_FOR_TEMPLATES: true,
    };

    // Sanitize HTML
    let clean = DOMPurify.sanitize(html, config);

    // Force external links to open in new tab with security attributes
    clean = clean.replace(/<a /g, '<a target="_blank" rel="noopener noreferrer" ');

    return clean;
  }

  /**
   * Strips all HTML tags and returns plain text.
   * Used for preview in form canvas.
   */
  stripHtml(html: string): string {
    const div = document.createElement('div');
    div.innerHTML = html;
    return div.textContent || div.innerText || '';
  }

  /**
   * Truncates text to specified length with ellipsis.
   */
  truncate(text: string, maxLength: number): string {
    if (text.length <= maxLength) return text;
    return text.substring(0, maxLength) + '...';
  }
}
```

### 3. Field Palette Addition

**File:**
`apps/web/src/app/features/tools/components/form-builder/field-palette/field-palette.component.html`

```html
<button
  pButton
  type="button"
  label="Text Block"
  icon="pi pi-align-justify"
  class="p-button-outlined w-full justify-start"
  (click)="onFieldTypeSelected('text_block')"
></button>
```

### 4. Form Canvas Preview

**File:**
`apps/web/src/app/features/tools/components/form-builder/form-canvas/form-canvas.component.html`

```html
@if (field.type === fieldTypes.TEXT_BLOCK) {
<div class="text-block-field-preview" (click)="onFieldClick(field)">
  <div
    class="text-block-preview-content p-3 border rounded"
    [style.background-color]="field.metadata?.backgroundColor || 'transparent'"
  >
    <div class="text-sm text-gray-700">{{ getTextBlockPreview(field) }}</div>
    @if (isContentLong(field)) {
    <p class="text-xs text-gray-500 mt-1">... Read more</p>
    }
  </div>
  <div class="field-actions">
    <button pButton icon="pi pi-pencil" (click)="onEditField(field)"></button>
    <button pButton icon="pi pi-trash" (click)="onDeleteField(field)"></button>
  </div>
</div>
}
```

**Component method:**

```typescript
getTextBlockPreview(field: FormField): string {
  const plainText = this.htmlSanitizer.stripHtml(field.metadata?.content || '');
  return this.htmlSanitizer.truncate(plainText, 150);
}

isContentLong(field: FormField): boolean {
  const plainText = this.htmlSanitizer.stripHtml(field.metadata?.content || '');
  return plainText.length > 150;
}
```

### 5. Field Properties Modal - TEXT_BLOCK Editor

**File:**
`apps/web/src/app/features/tools/components/form-builder/field-properties/field-properties.component.html`

```html
@if (field.type === fieldTypes.TEXT_BLOCK) {
<div class="text-block-properties">
  <!-- Rich Text Editor -->
  <div class="form-group">
    <label>Content</label>
    <p-editor
      [(ngModel)]="field.metadata.content"
      [style]="{ height: '320px' }"
      [modules]="editorModules"
    >
      <ng-template pTemplate="header">
        <span class="ql-formats">
          <button class="ql-bold" aria-label="Bold"></button>
          <button class="ql-italic" aria-label="Italic"></button>
          <button class="ql-underline" aria-label="Underline"></button>
          <button class="ql-strike" aria-label="Strike"></button>
        </span>
        <span class="ql-formats">
          <select class="ql-header">
            <option value="3">Heading 3</option>
            <option value="4">Heading 4</option>
            <option value="5">Heading 5</option>
            <option value="6">Heading 6</option>
            <option selected>Normal</option>
          </select>
        </span>
        <span class="ql-formats">
          <button class="ql-list" value="ordered"></button>
          <button class="ql-list" value="bullet"></button>
        </span>
        <span class="ql-formats">
          <button class="ql-link"></button>
          <button class="ql-blockquote"></button>
        </span>
        <span class="ql-formats">
          <select class="ql-align">
            <option selected></option>
            <option value="center"></option>
            <option value="right"></option>
            <option value="justify"></option>
          </select>
        </span>
      </ng-template>
    </p-editor>
    <small class="text-gray-500">Max 5000 characters</small>
  </div>

  <!-- Text Alignment -->
  <div class="form-group">
    <label>Block Alignment</label>
    <p-selectButton
      [(ngModel)]="field.metadata.alignment"
      [options]="alignmentOptions"
      optionLabel="label"
      optionValue="value"
    ></p-selectButton>
  </div>

  <!-- Background Color -->
  <div class="form-group">
    <label for="bgColor">Background Color (Optional)</label>
    <p-colorPicker
      id="bgColor"
      [(ngModel)]="field.metadata.backgroundColor"
      [inline]="false"
    ></p-colorPicker>
  </div>

  <!-- Padding -->
  <div class="form-group">
    <label for="padding">Padding</label>
    <p-dropdown
      id="padding"
      [(ngModel)]="field.metadata.padding"
      [options]="paddingOptions"
      optionLabel="label"
      optionValue="value"
    ></p-dropdown>
    <small class="text-gray-500"> None: 0px, Small: 8px, Medium: 16px, Large: 24px </small>
  </div>

  <!-- Collapsible Content -->
  <div class="form-group">
    <div class="flex items-center gap-2">
      <p-checkbox
        [(ngModel)]="field.metadata.collapsible"
        [binary]="true"
        inputId="collapsible"
      ></p-checkbox>
      <label for="collapsible">Make content collapsible</label>
    </div>
    <small class="text-gray-500"> Show "Read more" for content longer than 500 words </small>
  </div>

  @if (field.metadata?.collapsible) {
  <div class="form-group">
    <div class="flex items-center gap-2">
      <p-checkbox
        [(ngModel)]="field.metadata.collapsed"
        [binary]="true"
        inputId="collapsed"
      ></p-checkbox>
      <label for="collapsed">Initially collapsed</label>
    </div>
  </div>
  }

  <!-- Preview -->
  <div class="form-group">
    <label>Preview</label>
    <div
      class="border rounded p-3"
      [style.background-color]="field.metadata?.backgroundColor || 'white'"
      [innerHTML]="sanitizePreview(field.metadata?.content)"
    ></div>
  </div>
</div>
}
```

**Component TypeScript:**

```typescript
editorModules = {
  toolbar: [
    ['bold', 'italic', 'underline', 'strike'],
    [{ header: [3, 4, 5, 6, false] }],
    [{ list: 'ordered' }, { list: 'bullet' }],
    ['link', 'blockquote'],
    [{ align: [] }],
  ],
};

alignmentOptions = [
  { label: 'Left', value: 'left' },
  { label: 'Center', value: 'center' },
  { label: 'Right', value: 'right' },
  { label: 'Justify', value: 'justify' },
];

paddingOptions = [
  { label: 'None', value: 'none' },
  { label: 'Small', value: 'small' },
  { label: 'Medium', value: 'medium' },
  { label: 'Large', value: 'large' },
];

sanitizePreview(html: string): SafeHtml {
  const sanitized = this.htmlSanitizer.sanitize(html || '');
  return this.domSanitizer.bypassSecurityTrustHtml(sanitized);
}
```

### 6. Form Renderer - TEXT_BLOCK Display

**File:** `apps/web/src/app/features/public/form-renderer/form-renderer.component.html`

```html
@if (field.type === fieldTypes.TEXT_BLOCK) {
<div
  class="form-text-block mb-4 rounded"
  [class.text-left]="field.metadata?.alignment === 'left'"
  [class.text-center]="field.metadata?.alignment === 'center'"
  [class.text-right]="field.metadata?.alignment === 'right'"
  [class.text-justify]="field.metadata?.alignment === 'justify'"
  [style.background-color]="field.metadata?.backgroundColor || 'transparent'"
  [class.p-0]="field.metadata?.padding === 'none'"
  [class.p-2]="field.metadata?.padding === 'small'"
  [class.p-4]="field.metadata?.padding === 'medium'"
  [class.p-6]="field.metadata?.padding === 'large'"
>
  <div
    class="text-block-content prose prose-sm max-w-none"
    [class.line-clamp-6]="isTextBlockCollapsed(field.id)"
    [innerHTML]="getSanitizedContent(field)"
  ></div>
  @if (field.metadata?.collapsible && isTextBlockLong(field)) {
  <button
    type="button"
    class="read-more-btn text-blue-600 hover:text-blue-700 mt-2 text-sm font-medium"
    (click)="toggleTextBlockCollapse(field.id)"
  >
    {{ isTextBlockCollapsed(field.id) ? 'Read more ▼' : 'Read less ▲' }}
  </button>
  }
</div>
}
```

**Component TypeScript:**

```typescript
private collapsedTextBlocks = new Set<string>();

getSanitizedContent(field: FormField): SafeHtml {
  const sanitized = this.htmlSanitizer.sanitize(field.metadata?.content || '');
  return this.domSanitizer.bypassSecurityTrustHtml(sanitized);
}

isTextBlockLong(field: FormField): boolean {
  const plainText = this.htmlSanitizer.stripHtml(field.metadata?.content || '');
  const wordCount = plainText.split(/\s+/).length;
  return wordCount > 500;
}

isTextBlockCollapsed(fieldId: string): boolean {
  return this.collapsedTextBlocks.has(fieldId);
}

toggleTextBlockCollapse(fieldId: string): void {
  if (this.collapsedTextBlocks.has(fieldId)) {
    this.collapsedTextBlocks.delete(fieldId);
  } else {
    this.collapsedTextBlocks.add(fieldId);
  }
}
```

---

## Definition of Done

- [x] All functional requirements (1-9) completed
- [x] All integration requirements (10-12) verified
- [x] All quality requirements (13-18) met
- [x] **HTML sanitization implemented and tested** (security critical)
- [x] XSS prevention validated with malicious payloads
- [x] Rich text editor working with appropriate toolbar
- [x] Unit tests pass for all new code
- [x] Security tests pass (XSS prevention)
- [x] Integration tests pass for TEXT_BLOCK in published forms
- [x] No regression in existing form builder features
- [x] "Read more" collapse/expand working correctly
- [x] Content responsive on mobile devices
- [x] Accessibility validated (heading hierarchy, link attributes)
- [x] Documentation updated (JSDoc, security docs, CLAUDE.md)
- [x] Shared package rebuilt and tested
- [x] Changes committed with descriptive commit message

---

## Risk Assessment

**Primary Risks:**

1. **XSS Vulnerability (CRITICAL):** Unsanitized HTML could enable cross-site scripting attacks
   - **Mitigation:** Use DOMPurify with strict whitelist, test extensively with malicious payloads
   - **Testing:** Security testing with XSS attack vectors, penetration testing

2. **Performance Degradation:** Very long text blocks could slow page rendering
   - **Mitigation:** Character limit (5000), collapsible content for long blocks
   - **Testing:** Performance testing with forms containing multiple long text blocks

3. **Accessibility Regressions:** Improper heading hierarchy or missing link attributes
   - **Mitigation:** Restrict heading levels (H3-H6), force `rel` attributes on links
   - **Testing:** Accessibility audit with screen readers, WCAG 2.1 AA validation

4. **Content Corruption:** HTML encoding issues could corrupt saved content
   - **Mitigation:** Test with special characters, Unicode, nested HTML
   - **Testing:** Round-trip testing (save → load → verify content intact)

**Rollback:**

- Disable TEXT_BLOCK in field palette (prevent new creation)
- Existing forms with TEXT_BLOCK continue working (display text blocks)
- No database schema changes (JSONB is flexible)
- Feature flag: `ENABLE_TEXT_BLOCK_FIELD` to disable if critical issues found

---

## Dependencies

**Before starting:**

- [ ] Story 15.1 (HEADING field) completed (establishes display field pattern)
- [ ] Story 15.2 (IMAGE field) completed (establishes non-input field pattern)
- [ ] DOMPurify library installed and configured
- [ ] PrimeNG Editor component available (or alternative rich text editor)
- [ ] FormBuilderService state management working correctly

**Build order:**

1. Install DOMPurify (`npm install dompurify @types/dompurify`)
2. Create HtmlSanitizerService (security utility)
3. Shared type definition (build shared package)
4. Field palette button
5. FormBuilderService field creation (with sanitization)
6. Form canvas preview (with truncation)
7. Field properties modal (rich text editor)
8. Form renderer display (with sanitization and collapse)
9. Security tests (XSS prevention)
10. Integration tests

---

## Testing Strategy

**Unit Tests:**

- FormBuilderService creates TEXT_BLOCK with correct defaults
- HtmlSanitizerService sanitizes malicious HTML correctly
- Field properties modal updates TEXT_BLOCK metadata
- Form renderer renders sanitized HTML
- Form renderer excludes TEXT_BLOCK from FormGroup
- "Read more" collapse/expand logic works

**Security Tests (Critical):**

- Test XSS prevention with attack vectors:
  - `<script>alert('XSS')</script>` → removed
  - `<img src=x onerror="alert('XSS')">` → removed
  - `<a href="javascript:alert('XSS')">` → removed
  - `<iframe src="evil.com">` → removed
  - Event handlers (`onclick`, etc.) → removed
- Test allowed HTML passes through:
  - `<p>`, `<h3>`, `<strong>`, `<ul>`, `<a>` → preserved
  - Links have `target="_blank" rel="noopener noreferrer"`
- Test edge cases:
  - Nested HTML (multiple levels)
  - Unicode characters
  - Very long content (5000+ characters)

**Integration Tests:**

- Create form with TEXT_BLOCK in builder
- Add formatted content with editor
- Save form
- Reload page → TEXT_BLOCK persists with HTML
- Publish form → TEXT_BLOCK displays correctly with formatting
- Submit form → TEXT_BLOCK excluded from submission data
- Test "Read more" on long content

**Manual Testing:**

- Drag TEXT_BLOCK from palette to canvas
- Use rich text editor to format content (bold, lists, links, headings)
- Configure alignment, background color, padding
- Enable collapsible mode for long content
- Preview in builder shows truncated plain text
- Publish form shows full formatted HTML
- Click "Read more" to expand content
- Test links open in new tab
- Test with screen reader (content announced correctly)
- Test on mobile devices (responsive, no horizontal scroll)

---

## Notes

- TEXT_BLOCK is the most complex of the three new field types due to security concerns
- HTML sanitization is **CRITICAL** - must prevent XSS attacks
- DOMPurify is industry-standard library for HTML sanitization
- Rich text editor should be user-friendly but limited (no image upload, no video)
- Heading hierarchy is important for accessibility (restrict to H3-H6)
- "Read more" improves UX for long instructional text
- Consider character limit (5000) to prevent abuse and performance issues
- Links should always open in new tab with security attributes
- Test thoroughly with malicious HTML payloads before release
- Future enhancement: Support Markdown instead of/in addition to HTML
- Future enhancement: Template library (common instructions users can insert)
