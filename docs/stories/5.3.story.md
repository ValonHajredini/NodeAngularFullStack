# Story 5.3: API Token Authentication Integration

## Status

Draft

## Story

**As an** external software developer, **I want** to use API tokens to authenticate API requests and
have usage tracked, **so that** my software can securely access the system's APIs with proper
monitoring and accountability.

## Acceptance Criteria

1. Apply API token authentication to existing protected routes alongside JWT session auth
2. Implement basic usage logging to track API token requests (timestamp, endpoint, token_id,
   success/failure)
3. Create simple API usage endpoint (`GET /api/tokens/:id/usage`) for users to view their token
   activity
4. Existing JWT session-based route protection continues to work unchanged
5. New token authentication integrates seamlessly with current AuthMiddleware flow
6. Integration with existing monitoring.utils.ts maintains current logging patterns
7. API token authentication covered by integration tests on protected routes
8. Usage logging verified through existing monitoring test patterns
9. No regression in existing route protection and session authentication

## Tasks / Subtasks

- [ ] Integrate API token authentication with protected routes (AC: 1, 4, 5)
  - [ ] Update route protection to accept both JWT and API token authentication
  - [ ] Extend AuthMiddleware.authenticate() to handle Bearer API tokens
  - [ ] Ensure API token validation populates same AuthRequest context as JWT
  - [ ] Maintain existing JWT session authentication flow without changes
  - [ ] Test integration on all existing protected routes

- [ ] Implement API token usage logging (AC: 2, 6)
  - [ ] Create usage logging functions in existing monitoring.utils.ts
  - [ ] Log API token requests with timestamp, endpoint, token_id, success/failure
  - [ ] Create api_token_usage database table for usage tracking
  - [ ] Integrate logging middleware with existing monitoring patterns
  - [ ] Ensure minimal performance impact on API requests

- [ ] Create token usage tracking database schema (AC: 2)
  - [ ] Create migration for api_token_usage table
  - [ ] Include columns: id, token_id, endpoint, method, timestamp, response_status, ip_address
  - [ ] Add proper indexes for query performance
  - [ ] Test migration with existing database

- [ ] Implement usage viewing endpoint (AC: 3)
  - [ ] Create GET /api/v1/tokens/:id/usage endpoint in TokenController
  - [ ] Return paginated usage data for specific token
  - [ ] Include proper authorization (user can only view own token usage)
  - [ ] Add request validation and error handling

- [ ] Create usage repository and service layer (AC: 3)
  - [ ] Create TokenUsageRepository for database operations
  - [ ] Create TokenUsageService for business logic
  - [ ] Implement pagination and filtering for usage queries
  - [ ] Add proper tenant isolation for usage data

- [ ] Integration tests for API token authentication (AC: 7, 9)
  - [ ] Test API token authentication on existing protected routes
  - [ ] Test usage logging for successful and failed requests
  - [ ] Test usage viewing endpoint with proper authorization
  - [ ] Verify existing JWT session authentication still works
  - [ ] Test both authentication methods work simultaneously

- [ ] Update existing route definitions (AC: 1, 4)
  - [ ] Ensure all existing protected routes accept both authentication methods
  - [ ] Update route middleware to use extended AuthMiddleware
  - [ ] Verify no breaking changes to existing route behavior
  - [ ] Test route protection with both JWT and API tokens

## Dev Notes

### Previous Story Insights

Story 5.1 provides API token backend infrastructure with CRUD endpoints and AuthMiddleware
integration. Story 5.2 provides frontend UI for token management. This story completes the
integration by enabling actual API token usage and tracking.

### Data Models

**Usage Tracking Entity** [Source: architecture/data-models.md, database-schema.md]:

```typescript
interface TokenUsage {
  id: string; // UUID primary key
  tokenId: string; // Foreign key to api_tokens.id
  endpoint: string; // API endpoint accessed
  method: string; // HTTP method (GET, POST, etc.)
  timestamp: Date; // Request timestamp
  responseStatus: number; // HTTP response status code
  ipAddress: string; // Client IP address
  userAgent?: string; // Client user agent
  processingTime?: number; // Request processing time in ms
}
```

**Usage Response Interface** [Source: architecture/api-specification.md]:

```typescript
interface TokenUsageResponse {
  usage: TokenUsage[];
  pagination: {
    page: number;
    limit: number;
    total: number;
    totalPages: number;
  };
}
```

### API Specifications

**Usage Endpoint** [Source: architecture/api-specification.md#rest-api-specification]:

- `GET /api/v1/tokens/:id/usage` - Get token usage history
  - Query params: `?page=1&limit=50&from=2024-01-01&to=2024-12-31`
  - Response: Paginated token usage data
  - Authentication: Bearer JWT or Bearer API Token (must own token)
  - Authorization: User can only view usage for their own tokens

**Authentication Flow Enhancement** [Source:
architecture/backend-architecture.md#authentication-and-authorization]:

```typescript
// Enhanced AuthMiddleware flow
if (authHeader.startsWith('Bearer ')) {
  const token = authHeader.substring(7);

  // Try JWT validation first
  if (isJwtFormat(token)) {
    return validateJwtToken(token);
  }

  // Fall back to API token validation
  return validateApiToken(token);
}
```

### Component Specifications

**Middleware Integration** [Source: architecture/backend-architecture.md#middlewareguards, story
5.1]:

- Extend existing AuthMiddleware.authenticate() function
- Add token type detection (JWT vs API token format)
- Maintain same AuthRequest interface for both authentication methods
- Preserve existing JWT validation logic unchanged

**Usage Logging Middleware** [Source: architecture/monitoring-and-observability.md]:

- Create reusable logging middleware for API token requests
- Integrate with existing monitoring.utils.ts patterns
- Log minimal data for performance (async logging preferred)
- Include proper error handling for logging failures

**Repository Pattern** [Source: architecture/backend-architecture.md#data-access-layer]:

- TokenUsageRepository extends BaseRepository pattern
- Support tenant isolation for usage queries
- Implement efficient pagination for large usage datasets
- Include proper indexing strategy for query performance

### File Locations

**Backend Integration** [Source: architecture/unified-project-structure.md]:

- Middleware: Extend existing `apps/api/src/middleware/auth.middleware.ts`
- Monitoring: Extend existing `apps/api/src/utils/monitoring.utils.ts`
- Migration: `apps/api/migrations/YYYY-MM-DD-create-token-usage-table.sql`
- Repository: `apps/api/src/repositories/token-usage.repository.ts`
- Service: `apps/api/src/services/token-usage.service.ts`
- Controller: Extend existing `apps/api/src/controllers/token.controller.ts`

**Shared Types** [Source: architecture/unified-project-structure.md]:

- Interface: `packages/shared/src/types/token-usage.interface.ts`

### Testing Requirements

**Test File Locations** [Source: architecture/testing-strategy.md#backend-tests]:

- Integration tests: `apps/api/tests/integration/token-auth.test.ts`
- Usage tests: `apps/api/tests/integration/token-usage.test.ts`
- Middleware tests: `apps/api/tests/unit/middleware/auth.middleware.test.ts`

**Testing Standards** [Source: architecture/testing-strategy.md#backend-api-test]:

- Test API token authentication on existing protected routes
- Test usage logging with database verification
- Test usage endpoint with proper authorization
- Verify no regression in existing JWT authentication
- Test both authentication methods work simultaneously

**Testing Frameworks and Patterns** [Source: architecture/testing-strategy.md]:

- Jest + Supertest for API endpoint testing
- Database cleanup for usage table in test setup
- Mock external dependencies (monitoring, logging)
- Test both success and error scenarios for usage tracking
- Integration tests verify end-to-end token authentication flow

### Technical Constraints

**Authentication Compatibility** [Source: architecture/backend-architecture.md#middlewareguards]:

- Must not break existing JWT session authentication
- Both JWT and API tokens must populate same AuthRequest interface
- Existing route protection behavior must remain unchanged
- Token type detection must be reliable and performant

**Performance Requirements** [Source: architecture/monitoring-and-observability.md]:

- Usage logging must not significantly impact API response times
- Consider async logging for usage tracking
- Database queries must be optimized with proper indexing
- Minimal memory footprint for logging middleware

**Multi-tenancy Support** [Source: architecture/data-models.md#tenant]:

- Usage data must respect tenant isolation
- Users can only view usage for their own tokens
- Usage queries must include tenant context when applicable
- Repository pattern must support tenant-aware operations

**Monitoring Integration** [Source: architecture/monitoring-and-observability.md]:

- Usage logging must integrate with existing monitoring patterns
- Follow existing error tracking and metrics collection
- Maintain existing log format and structure
- Include proper error handling for logging failures

**Database Design** [Source: architecture/database-schema.md]:

- Usage table must support high-volume inserts efficiently
- Proper indexing on token_id, timestamp, and endpoint columns
- Consider data retention policies for usage logs
- Foreign key constraints with proper cascade behavior

### Testing

**Test File Location**:

- Integration tests: `apps/api/tests/integration/token-auth.test.ts`,
  `apps/api/tests/integration/token-usage.test.ts`
- Unit tests: `apps/api/tests/unit/middleware/auth.middleware.test.ts` [Source:
  architecture/testing-strategy.md#backend-tests]

**Test Standards**: All API token authentication and usage tracking must follow existing testing
patterns with comprehensive integration test coverage [Source:
architecture/testing-strategy.md#backend-api-test]

**Testing Frameworks and Patterns**:

- Backend testing: Jest + Supertest for API authentication testing [Source:
  architecture/testing-strategy.md#backend-api-test]
- Database testing: Clean usage tables in beforeEach hooks
- Auth testing: Test both JWT and API token authentication on same endpoints
- Usage testing: Verify usage logging works for successful and failed requests
- Integration testing: Test complete flow from token creation to usage tracking

## Change Log

| Date       | Version | Description                                                                   | Author             |
| ---------- | ------- | ----------------------------------------------------------------------------- | ------------------ |
| 2025-09-25 | 1.0     | Initial story creation with API token authentication integration requirements | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be added here after story implementation_
