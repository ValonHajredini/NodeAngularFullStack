# Story 10.6: Field Properties Configuration Panel

## Status

Draft

## Story

**As a** form creator, **I want** to configure properties for selected form fields in a properties
panel, **so that** I can customize labels, validation rules, and behavior for each field.

## Acceptance Criteria

1. **AC1**: Properties panel displays when a field is selected on canvas
2. **AC2**: Common properties for all field types: Label (required), Field Name (required, unique,
   kebab-case auto-generated from label), Placeholder, Help Text
3. **AC3**: Validation properties: Required toggle, Min/Max (for numbers), Min/Max Length (for
   text), Pattern (regex with validation), Email format toggle
4. **AC4**: Behavior properties: Disabled toggle, Read-only toggle, Default Value
5. **AC5**: Conditional visibility: "Show If" rule builder with field selection, operator (equals,
   not equals, contains), and value
6. **AC6**: Select/Radio specific properties: Options list (add/edit/remove), Value/Label pairs,
   Reorder options, Multi-select toggle (select only)
7. **AC7**: File upload specific properties: Accepted file types (MIME types), Max file size, Max
   files count
8. **AC8**: Properties panel uses reactive forms for real-time validation
9. **AC9**: Duplicate field name detection with error message
10. **AC10**: Changes immediately reflected in canvas field preview

## Tasks / Subtasks

- [ ] Update FieldProperties component with reactive form (AC: 1, 2, 8)
  - [ ] Open
        `/apps/web/src/app/features/tools/components/form-builder/field-properties/field-properties.component.ts`
  - [ ] Import ReactiveFormsModule, FormBuilder, Validators
  - [ ] Inject FormBuilder and FormBuilderService
  - [ ] Create reactive form group with controls:
    - label: ['', [Validators.required, Validators.maxLength(200)]]
    - fieldName: ['', [Validators.required, Validators.pattern(/^[a-z0-9-]+$/)]]
    - placeholder: ['', Validators.maxLength(100)]
    - helpText: ['', Validators.maxLength(500)]
  - [ ] Use effect() to watch selectedField signal and patch form values
  - [ ] Implement (ngSubmit) or valueChanges subscription to update field in service
  - [ ] Add auto-generate fieldName from label: kebab-case transformation on label blur

- [ ] Implement validation properties (AC: 3)
  - [ ] Add form controls for validation:
    - required: [false]
    - minValue: [null] (for number fields)
    - maxValue: [null] (for number fields)
    - minLength: [null] (for text/textarea)
    - maxLength: [null] (for text/textarea)
    - pattern: [''] (regex pattern)
    - emailFormat: [false] (for email validation)
  - [ ] Show/hide validation controls based on field type using @if directives
  - [ ] Implement regex pattern validator: test pattern validity on blur
  - [ ] Display validation error message if regex pattern invalid

- [ ] Implement behavior properties (AC: 4)
  - [ ] Add form controls:
    - disabled: [false]
    - readOnly: [false]
    - defaultValue: ['']
  - [ ] Adjust defaultValue control type based on field type:
    - Checkbox/Toggle: boolean
    - Number: number
    - Date/DateTime: date string
    - Others: string
  - [ ] Bind controls to PrimeNG Checkbox/InputSwitch components

- [ ] Implement conditional visibility rule builder (AC: 5)
  - [ ] Add "Show If" section in properties panel
  - [ ] Create form controls:
    - showIfField: [''] (dropdown of other fields in form)
    - showIfOperator: ['equals'] (dropdown: equals, not-equals, contains)
    - showIfValue: [''] (input for comparison value)
  - [ ] Populate showIfField dropdown from formFields signal (exclude current field)
  - [ ] Use PrimeNG Dropdown for field and operator selection
  - [ ] Add "Clear Rule" button to remove conditional visibility

- [ ] Implement Select/Radio specific properties (AC: 6)
  - [ ] Show "Options" section only when field type is select or radio
  - [ ] Create options FormArray for dynamic option list
  - [ ] Each option has: value (string), label (string)
  - [ ] Add "Add Option" button to push new option to FormArray
  - [ ] Add remove button (trash icon) for each option
  - [ ] Implement drag-to-reorder options using CDK DragDrop
  - [ ] Add "Multi-select" toggle (only visible for select field type)
  - [ ] Update field configuration when options change

- [ ] Implement File Upload specific properties (AC: 7)
  - [ ] Show "File Upload Settings" section only when field type is file
  - [ ] Create form controls:
    - acceptedTypes: [[]] (array of MIME types)
    - maxFileSize: [null] (in MB)
    - maxFiles: [1]
  - [ ] Use PrimeNG MultiSelect or Chips for MIME types selection
  - [ ] Common MIME types dropdown: image/\*, application/pdf, .docx, .xlsx, etc.
  - [ ] Validate maxFileSize is positive number
  - [ ] Validate maxFiles is positive integer

- [ ] Implement field name uniqueness validation (AC: 9)
  - [ ] Create custom async validator or sync validator for fieldName control
  - [ ] Check fieldName against all fields in formFields signal (exclude current field)
  - [ ] Show error message "Field name must be unique" if duplicate found
  - [ ] Highlight fieldName input with error border
  - [ ] Prevent saving if fieldName is duplicate

- [ ] Implement live canvas preview updates (AC: 10)
  - [ ] Subscribe to form.valueChanges in component
  - [ ] Debounce changes (300ms) to avoid excessive updates
  - [ ] Call formBuilderService.updateField() with new values
  - [ ] Signal update triggers canvas re-render via OnPush
  - [ ] Verify label change updates canvas field immediately
  - [ ] Verify validation rules update (visual indicator on canvas if needed)

- [ ] Design and style properties panel UI (AC: 1)
  - [ ] Use PrimeNG Panel or Card for section grouping
  - [ ] Sections: Basic Properties, Validation, Behavior, Conditional Visibility, Type-Specific
  - [ ] Use PrimeNG form controls: InputText, Checkbox, Dropdown, InputNumber, Chips
  - [ ] Apply Tailwind styling: consistent spacing, labels above inputs
  - [ ] Show field type badge at top (read-only, styled pill)
  - [ ] Empty state: "Select a field to configure its properties" with icon

- [ ] Write component tests (AC: 8, 9, 10)
  - [ ] Update field-properties.component.spec.ts:
    - Test reactive form creation
    - Test form controls match selected field values
    - Test fieldName auto-generation from label
    - Mock FormBuilderService and verify updateField() called
    - Test duplicate fieldName validation error
    - Test valueChanges triggers service update
    - Test type-specific properties show/hide correctly
  - [ ] Test options FormArray add/remove/reorder
  - [ ] Test conditional visibility rule builder

- [ ] Test integration with canvas (IV: 1, 2, 4, 5)
  - [ ] Select field on canvas → properties panel populates
  - [ ] Change label in properties → canvas updates immediately
  - [ ] Add validation rule → verify stored in field configuration
  - [ ] Test with 100+ field form: properties panel remains responsive
  - [ ] Test all field types have appropriate property controls

## Dev Notes

### Previous Story Insights

Story 10.5 implemented drag-and-drop. This story adds the configuration layer for customizing each
field's properties.

### Data Models

**FormField Properties:** [Source: packages/shared/src/types/forms.types.ts (from Story 10.1)]

- Basic: label, fieldName, placeholder, helpText
- Validation: required, min/max, minLength/maxLength, pattern, emailFormat
- Behavior: disabled, readOnly, defaultValue
- Conditional: showIf (field, operator, value)
- Type-specific: options (select/radio), acceptedTypes (file), etc.

**Field Name Rules:** [Source: docs/prd-form-builder/epic-10#Story-1.6-AC2]

- Required field
- Unique within form
- Kebab-case format (lowercase, hyphens, no spaces)
- Auto-generated from label (e.g., "First Name" → "first-name")
- User can override auto-generated value

### API Specifications

No API calls in this story. Pure frontend field configuration.

### Component Specifications

**Reactive Forms Pattern:** [Source:
docs/architecture/frontend-architecture.md#State-Management-Architecture]

- FormBuilder for creating FormGroup
- Validators for input validation
- valueChanges observable for live updates
- patchValue() to populate form from selected field
- Async validators for cross-field validation (uniqueness)

**Dynamic Form Controls:** [Source: docs/architecture/frontend-architecture.md#Component-Template]

- Show/hide controls based on field type using @if
- FormArray for dynamic options list
- Custom validators for business logic
- Debounced updates to service (avoid excessive calls)

### File Locations

**Component to Update:** [Source: docs/architecture/unified-project-structure.md#apps/web]

- Update:
  `/apps/web/src/app/features/tools/components/form-builder/field-properties/field-properties.component.ts`
- Update:
  `/apps/web/src/app/features/tools/components/form-builder/field-properties/field-properties.component.html`

**Service to Update:** [Source: docs/architecture/unified-project-structure.md#apps/web]

- Update: `/apps/web/src/app/features/tools/components/form-builder/form-builder.service.ts`
- Add method: `updateField(fieldId: string, updates: Partial<FormField>): void`

**Tests:** [Source: docs/architecture/testing-strategy.md#Frontend-Tests]

- Update:
  `/apps/web/src/app/features/tools/components/form-builder/field-properties/field-properties.component.spec.ts`

### Testing Requirements

**Component Tests:** [Source: docs/architecture/testing-strategy.md#Frontend-Component-Test]

- Test form control creation and validation
- Test form population from selected field
- Test auto-generation of fieldName from label
- Test duplicate fieldName validation
- Mock FormBuilderService
- Test valueChanges subscription and debounce
- Test type-specific property visibility

**Integration Tests:**

- Select field → properties populate correctly
- Update property → canvas reflects change
- Validate unique fieldName across form
- Test FormArray operations (add/remove/reorder options)

**Test Commands:** [Source: docs/CLAUDE.md#Testing-Commands]

- Run component tests:
  `npm --workspace=apps/web run test -- --include="**/field-properties.component.spec.ts" --watch=false`

### Technical Constraints

**Reactive Forms:** [Source:
docs/architecture/frontend-architecture.md#State-Management-Architecture]

- Use FormBuilder for form creation
- Apply Validators for validation rules
- Use effect() to watch signal changes and update form
- Debounce valueChanges (300ms) before calling service
- Prevent memory leaks: unsubscribe in ngOnDestroy

**Field Name Validation:** [Source: docs/prd-form-builder/epic-10#Story-1.6-AC9]

- Sync validator for uniqueness (check against formFields signal)
- Regex pattern for kebab-case validation: /^[a-z0-9-]+$/
- Error message: "Field name must be unique"
- Auto-generation: convert label to kebab-case on blur

**Performance:** [Source: docs/prd-form-builder/epic-10#Story-1.6-IV5]

- Properties panel must remain responsive with 100+ field forms
- Debounce updates to avoid excessive re-renders
- Use OnPush change detection
- Signals for efficient state updates

**Type-Specific Properties:** [Source: docs/prd-form-builder/epic-10#Story-1.6-AC6-AC7]

- Select/Radio: Options list (FormArray), multi-select toggle
- File Upload: MIME types, max size, max files
- Number: Min/max values
- Text: Min/max length, regex pattern
- Email: Email format validation toggle

**PrimeNG Components:** [Source: docs/architecture/tech-stack.md]

- InputText, InputNumber for text/number inputs
- Checkbox, InputSwitch for toggles
- Dropdown for select fields (operator, field selection)
- Chips or MultiSelect for MIME types
- Panel or Accordion for section grouping

### Testing

**Test File Location:** [Source: docs/architecture/testing-strategy.md#Frontend-Tests]

- `/apps/web/src/app/features/tools/components/form-builder/field-properties/field-properties.component.spec.ts`

**Testing Standards:** [Source: docs/architecture/testing-strategy.md#Frontend-Component-Test]

- Mock FormBuilderService with jasmine.createSpyObj
- Test reactive form validation rules
- Test form population from signal (use effect)
- Test debounced valueChanges updates
- Test fieldName uniqueness validation
- Test type-specific property visibility

**Testing Frameworks:** [Source: docs/architecture/tech-stack.md]

- Karma + Jasmine for Angular testing
- Angular Testing Utilities (TestBed, ComponentFixture)
- RxJS testing utilities for observable testing

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-04 | 1.0     | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
