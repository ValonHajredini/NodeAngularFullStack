# Story 5.1: API Token Backend Infrastructure

## Status

Draft

## Story

**As a** system administrator or API consumer, **I want** the backend system to generate, store, and
validate API tokens, **so that** external software can securely authenticate and access our APIs
using persistent tokens.

## Acceptance Criteria

1. Create `api_tokens` database table with columns: id, user_id, tenant_id, token_hash, name,
   scopes, expires_at, created_at, last_used_at, is_active
2. Implement API token CRUD endpoints (`POST /api/tokens`, `GET /api/tokens`,
   `DELETE /api/tokens/:id`)
3. Extend existing AuthMiddleware to validate API tokens from Authorization header (Bearer format)
4. Existing JWT session authentication continues to work unchanged
5. New token validation follows existing AuthMiddleware pattern in auth.middleware.ts
6. Integration with tenant system maintains current behavior via existing AuthRequest interface
7. API token endpoints are covered by unit and integration tests
8. Database migration script is created and tested
9. No regression in existing authentication functionality verified through existing test suite

## Tasks / Subtasks

- [ ] Create database migration for api_tokens table (AC: 1)
  - [ ] Add migration file in `apps/api/migrations/`
  - [ ] Create api_tokens table with all required columns
  - [ ] Add appropriate indexes for performance
  - [ ] Test migration with existing development database

- [ ] Implement API token data model and repository (AC: 1)
  - [ ] Create ApiToken interface in `packages/shared/src/types/`
  - [ ] Create ApiTokenRepository in `apps/api/src/repositories/`
  - [ ] Extend BaseRepository pattern for tenant-aware operations

- [ ] Create API token service layer (AC: 1, 2)
  - [ ] Create ApiTokenService in `apps/api/src/services/`
  - [ ] Implement token generation using crypto.randomBytes
  - [ ] Implement token hashing using bcrypt (following password pattern)
  - [ ] Implement CRUD operations (create, find, delete)
  - [ ] Add token validation and expiration checking

- [ ] Implement API token CRUD endpoints (AC: 2)
  - [ ] Create TokenController in `apps/api/src/controllers/`
  - [ ] Add POST /api/v1/tokens endpoint for token creation
  - [ ] Add GET /api/v1/tokens endpoint for listing user tokens
  - [ ] Add DELETE /api/v1/tokens/:id endpoint for token revocation
  - [ ] Create tokens.routes.ts in `apps/api/src/routes/`
  - [ ] Add proper request validation using express-validator

- [ ] Extend AuthMiddleware for API token validation (AC: 3, 5, 6)
  - [ ] Modify AuthRequest interface to include tokenType field
  - [ ] Update authenticate() function to check Authorization header format
  - [ ] Add API token validation path alongside JWT validation
  - [ ] Maintain existing tenant context via AuthRequest interface
  - [ ] Ensure no breaking changes to existing JWT flow

- [ ] Unit tests for API token functionality (AC: 7)
  - [ ] Test ApiTokenService methods in `apps/api/tests/unit/services/`
  - [ ] Test ApiTokenRepository methods in `apps/api/tests/unit/repositories/`
  - [ ] Test TokenController methods in `apps/api/tests/unit/controllers/`

- [ ] Integration tests for API token endpoints (AC: 7, 9)
  - [ ] Test token creation endpoint in `apps/api/tests/integration/`
  - [ ] Test token listing endpoint with proper tenant isolation
  - [ ] Test token deletion endpoint
  - [ ] Test API token authentication on protected routes
  - [ ] Verify existing JWT session authentication still works

## Dev Notes

### Previous Story Insights

Latest story (4.4) completed developer onboarding documentation with no critical debugging issues.
Jest configuration for ES modules is stable. All validation scripts and metrics systems are
operational.

### Data Models

**API Token Entity** [Source: architecture/data-models.md#user, database-schema.md]:

```typescript
interface ApiToken {
  id: string; // UUID primary key
  userId: string; // Foreign key to users.id
  tenantId?: string; // Optional foreign key to tenants.id
  tokenHash: string; // Bcrypt hashed token value
  name: string; // User-friendly token name
  scopes: string[]; // Token permissions ['read', 'write']
  expiresAt: Date; // Token expiration timestamp
  createdAt: Date; // Creation timestamp
  lastUsedAt?: Date; // Last usage timestamp
  isActive: boolean; // Active status flag
}
```

**Database Schema** [Source: architecture/database-schema.md]:

- Follow existing pattern with UUID primary keys using uuid_generate_v4()
- Include tenant_id column with REFERENCES tenants(id) ON DELETE CASCADE
- Add unique constraint on (user_id, name) to prevent duplicate token names per user
- Include indexes on user_id, tenant_id, and token_hash for query performance
- Use TIMESTAMP WITH TIME ZONE for all datetime fields

### API Specifications

**Token Endpoints** [Source: architecture/api-specification.md#rest-api-specification]:

- `POST /api/v1/tokens` - Create new API token
  - Request: `{ name: string, scopes: string[] }`
  - Response: `{ token: string, id: string, name: string, scopes: string[], expiresAt: string }`
  - Authentication: Bearer JWT (existing session auth)
- `GET /api/v1/tokens` - List user's API tokens
  - Response: Array of token objects (without token values)
  - Authentication: Bearer JWT (existing session auth)
- `DELETE /api/v1/tokens/:id` - Revoke API token
  - Response: `{ success: boolean }`
  - Authentication: Bearer JWT (existing session auth)

**Authentication Flow** [Source:
architecture/backend-architecture.md#authentication-and-authorization]:

- API tokens validated in Authorization header: `Bearer <api_token>`
- JWT tokens continue to work in Authorization header: `Bearer <jwt_token>`
- AuthMiddleware detects token type and routes to appropriate validation
- Both token types result in same AuthRequest interface with user and tenant context

### Component Specifications

**Repository Pattern** [Source: architecture/backend-architecture.md#data-access-layer]:

- Extend BaseRepository<T> class for api_tokens operations
- Support tenant isolation via supportsTenancy() method
- Use parameterized queries for SQL injection prevention
- Implement findById(), create(), update(), delete() methods

**Service Layer Pattern** [Source: architecture/backend-architecture.md#service-architecture]:

- ApiTokenService handles business logic for token lifecycle
- Generate tokens using crypto.randomBytes(32).toString('hex')
- Hash tokens using bcrypt before storage (same pattern as passwords)
- Validate token format and expiration before authentication

**Controller Pattern** [Source: architecture/backend-architecture.md#controller-template]:

- Follow AsyncHandler pattern for error handling
- Use ApiError class for structured error responses
- Implement proper HTTP status codes (201, 200, 404, 409)
- Return consistent JSON response format with success/data structure

### File Locations

**Database Files** [Source: architecture/unified-project-structure.md]:

- Migration: `apps/api/migrations/YYYY-MM-DD-create-api-tokens-table.sql`

**Backend Code** [Source: architecture/unified-project-structure.md]:

- Interface: `packages/shared/src/types/api-token.interface.ts`
- Repository: `apps/api/src/repositories/api-token.repository.ts`
- Service: `apps/api/src/services/api-token.service.ts`
- Controller: `apps/api/src/controllers/token.controller.ts`
- Routes: `apps/api/src/routes/tokens.routes.ts`
- Middleware: Extend existing `apps/api/src/middleware/auth.middleware.ts`

### Testing Requirements

**Test File Locations** [Source: architecture/testing-strategy.md#test-organization]:

- Unit tests: `apps/api/tests/unit/services/api-token.service.test.ts`
- Unit tests: `apps/api/tests/unit/repositories/api-token.repository.test.ts`
- Unit tests: `apps/api/tests/unit/controllers/token.controller.test.ts`
- Integration tests: `apps/api/tests/integration/token.test.ts`

**Testing Standards** [Source: architecture/testing-strategy.md#backend-api-test]:

- Use Jest + Supertest for API endpoint testing
- Use request(app) pattern for integration tests
- Clean database with pool.query('DELETE FROM api_tokens') in beforeEach
- Test all HTTP status codes (201, 200, 400, 401, 404, 409)
- Mock external dependencies using Jest spies
- Follow existing test patterns in apps/api/tests/integration/auth.test.ts

**Testing Frameworks and Patterns** [Source: architecture/testing-strategy.md]:

- Jest framework with TypeScript support for backend testing
- Supertest for HTTP request testing
- Database cleanup in beforeEach hooks
- Structured test organization with describe blocks for endpoints
- Test both success and failure scenarios for each endpoint

### Technical Constraints

**JWT Integration** [Source: architecture/backend-architecture.md#middlewareguards]:

- AuthRequest interface must support both JWT and API token authentication
- Existing authenticate() function in auth.middleware.ts must be extended, not replaced
- Token validation must populate same user and tenant context as JWT validation
- No changes to existing JWT token verification logic

**Multi-tenancy Support** [Source: architecture/data-models.md#tenant]:

- API tokens must respect tenant isolation via tenant_id foreign key
- Token operations must filter by tenant context when tenant_id is present
- Repository queries must include tenant_id in WHERE clauses when applicable

**Security Requirements** [Source: architecture/coding-standards.md#critical-fullstack-rules]:

- Never store raw tokens in database - use bcrypt hashing
- Use parameterized queries to prevent SQL injection
- Validate all input using express-validator middleware
- Token scopes limited to 'read' and 'write' for initial implementation

**Database Constraints** [Source: architecture/database-schema.md]:

- Use UUID primary keys with uuid_generate_v4()
- Include proper foreign key constraints with CASCADE deletion
- Add updated_at trigger using existing update_updated_at_column() function
- Follow existing index naming conventions (idx_table_column)

### Testing

**Test File Location**:

- Unit tests: `apps/api/tests/unit/services/`, `apps/api/tests/unit/repositories/`,
  `apps/api/tests/unit/controllers/`
- Integration tests: `apps/api/tests/integration/token.test.ts` [Source:
  architecture/testing-strategy.md#test-organization]

**Test Standards**: All API token functionality must follow existing testing patterns with
comprehensive test coverage including success and failure scenarios [Source:
architecture/testing-strategy.md#testing-pyramid]

**Testing Frameworks and Patterns**:

- Backend testing: Jest + Supertest for API endpoints [Source:
  architecture/testing-strategy.md#backend-api-test]
- Database cleanup: Use pool.query('DELETE FROM api_tokens') in beforeEach hooks
- Integration testing: Follow existing auth.test.ts patterns with request(app) setup
- Mock external dependencies using Jest spyOn and mock implementations

## Change Log

| Date       | Version | Description                                                     | Author             |
| ---------- | ------- | --------------------------------------------------------------- | ------------------ |
| 2025-09-25 | 1.0     | Initial story creation with backend infrastructure requirements | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be added here after story implementation_
