# Story 30.6: Frontend Category Detection and Analytics Service

## Status

Approved

## Story

**As a** frontend developer, **I want** a service to fetch category metrics and detect template
categories, **so that** analytics components can load correct data.

## Acceptance Criteria

1. `CategoryAnalyticsService` created with HTTP methods
2. `FormAnalyticsComponent` modified with category signals
3. Loading and error states implemented
4. Unit tests for service
5. Component tests for signals

## Tasks / Subtasks

- [ ] **Task 1: Implement `CategoryAnalyticsService`** (AC: 1)
  - [ ] Create `apps/web/src/app/core/services/category-analytics.service.ts` using Angular's
        injectable service pattern and HttpClient wrappers defined for core services.
        `[Source: docs/architecture/source-tree.md#frontend-structure-appsweb]`
  - [ ] Add methods `getCategoryMetrics(formId)` and `detectTemplateCategory(formSchema)` leveraging
        shared DTOs from `@nodeangularfullstack/shared`.
        `[Source: docs/architecture/coding-standards.md#critical-fullstack-rules]`
  - [ ] Apply centralized HTTP error handling so responses conform to the frontend error strategy
        and surface user-friendly toast messages.
        `[Source: docs/architecture/error-handling-strategy.md#frontend-error-handling]`

- [ ] **Task 2: Integrate signals in `FormAnalyticsComponent`** (AC: 2)
  - [ ] Update the component under `apps/web/src/app/features/dashboard/components/form-analytics/`
        (exact path per source tree) to add signals for `category`, `metrics`, `loading`, and
        `error`, using computed signals for derived UI.
        `[Source: docs/architecture/source-tree.md#frontend-structure-appsweb]`
  - [ ] Follow the documented NgRx Signals guidance for state derivation and optimistic updates.
        `[Source: docs/architecture/frontend-architecture.md#state-management-patterns]`

- [ ] **Task 3: Implement loading and error UX** (AC: 3)
  - [ ] Show PrimeNG skeletons/spinners while awaiting metrics, and display error alerts when the
        service throws, aligning with the shared frontend error handler pattern.
        `[Source: docs/architecture/tech-stack.md#technology-stack-table]`
  - [ ] Ensure fallback to generic analytics when category detection returns `null`, preventing
        regressions for existing forms.
        `[Source: docs/architecture/frontend-architecture.md#state-management-patterns]`

- [ ] **Task 4: Add unit tests for the service** (AC: 4)
  - [ ] Create `category-analytics.service.spec.ts` beside the service with Jest + Testing Library
        utilities to mock HttpClient and verify error handling.
        `[Source: docs/architecture/testing-strategy.md#frontend-tests]`
  - [ ] Cover success responses, HTTP errors, and null category fallbacks to maintain high
        confidence.

- [ ] **Task 5: Add component tests for signals** (AC: 5)
  - [ ] Update or create `form-analytics.component.spec.ts` ensuring signals react to mocked service
        responses and template renders targeted placeholders.
        `[Source: docs/architecture/testing-strategy.md#frontend-component-test]`
  - [ ] Mock `CategoryAnalyticsService` to emit loading/error states, asserting DOM updates for each
        scenario.

## Dev Notes

### Previous Story Insights

- No specific guidance found in architecture docs.

### Data Models

- Category analytics rely on form schemas and submissions stored in the FORMS Postgres database, so
  front-end DTOs must align with the server-side metrics derived from those tables.
  `[Source: docs/architecture/database-separation-implementation-summary.md#forms-database-nodeangularfullstack_forms]`

### API Specifications

- The analytics service will call the authenticated REST API described in the spec, inheriting JWT
  bearer requirements and standardized error payloads.
  `[Source: docs/architecture/api-specification.md#rest-api-specification]`

### Component Specifications

- Angular components follow the standalone component template and rely on PrimeNG for UI, so the
  analytics component should keep templates declarative and leverage chart directives consistent
  with existing guidance. `[Source: docs/architecture/frontend-architecture.md#component-template]`

### File Locations

- Core Angular services are located under `apps/web/src/app/core/services`, and analytics UI lives
  under `apps/web/src/app/features`, matching the feature-based structure.
  `[Source: docs/architecture/source-tree.md#frontend-structure-appsweb]`

### Testing Requirements

- Frontend unit and component tests use Jest + Testing Library with the folder structure outlined in
  the testing strategy; place service specs alongside source files and maintain deterministic mocks.
  `[Source: docs/architecture/testing-strategy.md#frontend-tests]`

### Technical Constraints

- Angular 20+, PrimeNG, and NgRx signals are the mandated stack for UI development, ensuring
  consistent performance and DX across the project.
  `[Source: docs/architecture/tech-stack.md#technology-stack-table]`
- Follow shared coding standards: strict TypeScript typing, no direct `process.env` usage, and full
  JSDoc for public APIs. `[Source: docs/architecture/coding-standards.md#critical-fullstack-rules]`

## Testing

- Run targeted frontend unit tests with
  `npm --workspace=apps/web run test -- --testPathPattern="category-analytics"` and component specs
  with `--testPathPattern="form-analytics"`, aligning with the documented frontend test workflow.
  `[Source: docs/architecture/testing-strategy.md#frontend-tests]`
- Execute `npm run test` at the repo root for combined coverage before handing off to QA.
  `[Source: docs/architecture/testing-strategy.md#frontend-tests]`

## Change Log

| Date       | Version | Description                          | Author             |
| ---------- | ------- | ------------------------------------ | ------------------ |
| 2025-01-27 | 1.0     | Initial story draft and task outline | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be populated by the development agent._

### Debug Log References

_To be populated by the development agent._

### Completion Notes List

_To be populated by the development agent._

### File List

_To be populated by the development agent._

## QA Results

_QA review not yet executed for this draft._
