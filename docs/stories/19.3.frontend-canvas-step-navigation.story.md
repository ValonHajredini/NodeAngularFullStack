# Story 19.3: Frontend - Canvas Step Navigation and Field Assignment

## Status

Draft

## Story

**As a** form builder user, **I want** to navigate between steps in the canvas and assign fields to
specific steps, **so that** I can organize form fields across multiple steps with clear visual
feedback.

## Acceptance Criteria

1. Step tabs/selector displays all steps with clear active state
2. Clicking step tab switches canvas to display that step's fields
3. Dragging field from palette assigns it to active step
4. Fields cannot be dragged between steps (future enhancement)
5. Empty steps show appropriate placeholder message
6. Row layout sidebar shows rows for active step only
7. All existing canvas tests pass
8. New tests achieve >80% coverage

## Tasks / Subtasks

- [ ] **Task 1: Add step navigation tabs to FormCanvasComponent** (AC: 1, 2)
  - [ ] Update
        `apps/web/src/app/features/tools/components/form-builder/form-canvas/form-canvas.component.ts`
  - [ ] Import required modules: `TabViewModule` (PrimeNG) or custom tab component
  - [ ] Inject `FormBuilderService` to access step state
  - [ ] Add signals:
    - `steps = computed(() => this.formBuilderService.steps())`
    - `activeStepId = this.formBuilderService.activeStepId`
    - `stepFormEnabled = this.formBuilderService.stepFormEnabled`
  - [ ] Add method `onStepTabClick(stepId: string): void`:
    - Call `formBuilderService.setActiveStep(stepId)`
    - Filter fields to show only active step fields
    - Update canvas rendering
  - [ ] Add template section above canvas grid:
    ```html
    @if (stepFormEnabled()) {
    <div class="step-tabs">
      @for (step of steps(); track step.id) {
      <button [class.active]="step.id === activeStepId()" (click)="onStepTabClick(step.id)">
        Step {{ step.order + 1 }}: {{ step.title }}
      </button>
      }
    </div>
    }
    ```
  - [ ] Style tabs with Tailwind: border-b, active state with primary color

- [ ] **Task 2: Filter fields by active step** (AC: 2, 5)
  - [ ] Add computed signal for filtered fields:
    ```typescript
    protected readonly visibleFields = computed(() => {
      if (!this.stepFormEnabled()) {
        return this.formBuilderService.fields();
      }
      const activeId = this.activeStepId();
      return this.formBuilderService.fields().filter(
        field => field.position?.stepId === activeId
      );
    });
    ```
  - [ ] Update canvas template to render `visibleFields()` instead of all fields
  - [ ] Add empty state template:
    ```html
    @if (stepFormEnabled() && visibleFields().length === 0) {
    <div class="empty-step-placeholder">
      <i class="pi pi-inbox text-gray-400" style="font-size: 3rem;"></i>
      <p>No fields in this step yet</p>
      <p class="text-sm text-gray-500">
        Drag fields from the palette to add them to Step {{ activeStepOrder() + 1 }}
      </p>
    </div>
    }
    ```
  - [ ] Style placeholder: center, gray text, padding

- [ ] **Task 3: Update drag-drop to assign stepId** (AC: 3, 4)
  - [ ] Update `onFieldDrop(event: CdkDragDrop)` method:
    - When dropping field from palette:
      - Assign `field.position.stepId = this.activeStepId()`
      - Assign `field.position.rowId` and `field.position.columnIndex` as before
      - Add field to active step only
    - When moving field within canvas:
      - Prevent drag if source and target have different stepIds (AC: 4)
      - Show error toast: "Cannot move fields between steps yet"
      - Keep field in original step
  - [ ] Add drop validation predicate:

    ```typescript
    canDropField = (drag: CdkDrag, drop: CdkDropList): boolean => {
      const draggedField = drag.data as FormField;
      const targetStepId = this.activeStepId();

      // Allow drop from palette (no stepId yet)
      if (!draggedField.position?.stepId) return true;

      // Prevent drop if different step
      return draggedField.position.stepId === targetStepId;
    };
    ```

  - [ ] Apply predicate to drop lists: `[cdkDropListEnterPredicate]="canDropField"`

- [ ] **Task 4: Integrate row layout with active step** (AC: 6)
  - [ ] Update RowLayoutSidebarComponent to filter rows by active step
  - [ ] Add computed signal:
    ```typescript
    protected readonly activeStepRows = computed(() => {
      if (!this.stepFormEnabled()) {
        return this.formBuilderService.rows();
      }
      const activeId = this.activeStepId();
      return this.formBuilderService.rows().filter(
        row => row.stepId === activeId
      );
    });
    ```
  - [ ] Update row template to render `activeStepRows()` instead of all rows
  - [ ] When adding new row, assign `row.stepId = activeStepId()`
  - [ ] Add empty state: "No rows in this step yet"

- [ ] **Task 5: Update FormBuilderService with step navigation** (AC: 1, 2)
  - [ ] Add to `form-builder.service.ts`:
  - [ ] Add signal: `private _activeStepId = signal<string | null>(null)`
  - [ ] Add readonly: `readonly activeStepId = this._activeStepId.asReadonly()`
  - [ ] Add computed signal:
    ```typescript
    readonly activeStep = computed(() =>
      this._steps().find(s => s.id === this._activeStepId())
    );
    readonly activeStepOrder = computed(() =>
      this.activeStep()?.order ?? 0
    );
    ```
  - [ ] Add method:
    ```typescript
    setActiveStep(stepId: string): void {
      const step = this._steps().find(s => s.id === stepId);
      if (!step) {
        console.error('Invalid step ID:', stepId);
        return;
      }
      this._activeStepId.set(stepId);
      // Emit change event for canvas update
      this.emitChange();
    }
    ```
  - [ ] Update `enableStepForm()` to set first step as active:
    ```typescript
    this._activeStepId.set(defaultStep.id);
    ```

- [ ] **Task 6: Add step indicator to canvas header** (AC: 1)
  - [ ] Add step info badge above canvas:
    ```html
    @if (stepFormEnabled()) {
    <div class="step-indicator">
      <span class="badge-primary"> Step {{ activeStepOrder() + 1 }} of {{ steps().length }} </span>
      <span class="text-gray-700"> {{ activeStep()?.title }} </span>
      <button class="btn-icon" (click)="quickEditStep()" pTooltip="Edit step properties">
        <i class="pi pi-pencil"></i>
      </button>
    </div>
    }
    ```
  - [ ] Add `quickEditStep()` method to open step edit dialog from canvas
  - [ ] Style indicator: flex row, gap, items-center, p-3, border-b

- [ ] **Task 7: Handle field deletion in step context** (AC: 2)
  - [ ] Update field deletion logic to remove from specific step
  - [ ] When deleting field:
    - Remove field from `fields` array
    - Update `orderInColumn` for remaining fields in same column
    - No need to update other steps (field belongs to one step only)
  - [ ] Show confirmation with step context:
    - "Delete field from Step {{ stepOrder + 1 }}?"

- [ ] **Task 8: Update field preview to show step assignment** (AC: 1)
  - [ ] Add step badge to field preview cards:
    ```html
    @if (stepFormEnabled() && field.position?.stepId) {
    <span class="step-badge"> Step {{ getStepOrder(field.position.stepId) + 1 }} </span>
    }
    ```
  - [ ] Add helper method:
    ```typescript
    getStepOrder(stepId: string): number {
      const step = this.formBuilderService.steps().find(s => s.id === stepId);
      return step?.order ?? 0;
    }
    ```
  - [ ] Style badge: small, rounded, bg-primary, text-white

- [ ] **Task 9: Extend RowLayoutConfig with stepId** (AC: 6)
  - [ ] Update `packages/shared/src/types/forms.types.ts`:
  - [ ] Extend `RowLayoutConfig` interface:
    ```typescript
    export interface RowLayoutConfig {
      rowId: string;
      columnCount: 0 | 1 | 2 | 3 | 4;
      order: number;
      stepId?: string; // NEW: Optional step assignment
    }
    ```
  - [ ] Run `npm run build:shared` to compile
  - [ ] Update backend validation to accept `stepId` in rows (optional property)

- [ ] **Task 10: Unit tests for step navigation** (AC: 7, 8)
  - [ ] Update
        `apps/web/src/app/features/tools/components/form-builder/form-canvas/form-canvas.component.spec.ts`
  - [ ] Add test suite: "Step Navigation"
  - [ ] Test cases:
    - Should display step tabs when step mode enabled
    - Should highlight active step tab
    - Should switch active step on tab click
    - Should filter fields by active step
    - Should show empty placeholder when step has no fields
    - Should assign stepId when dropping field from palette
    - Should prevent dragging fields between steps
    - Should show only active step rows in row layout sidebar
    - Should delete field from correct step
  - [ ] Run tests:
        `npm --workspace=apps/web run test -- --include="**/form-canvas.component.spec.ts" --watch=false`

- [ ] **Task 11: Unit tests for FormBuilderService step navigation** (AC: 8)
  - [ ] Update `form-builder.service.spec.ts`
  - [ ] Add test suite: "Step Navigation"
  - [ ] Test cases:
    - `setActiveStep()` updates activeStepId signal
    - `setActiveStep()` with invalid ID shows error
    - `activeStep` computed returns correct step
    - `activeStepOrder` computed returns correct order
    - `enableStepForm()` sets first step as active
    - Fields filtered by active step work correctly
  - [ ] Run tests and verify >80% coverage

- [ ] **Task 12: Integration testing** (AC: 7)
  - [ ] Run all frontend tests: `npm --workspace=apps/web run test -- --watch=false`
  - [ ] Verify no regressions in existing canvas/drag-drop functionality
  - [ ] Manual workflow testing:
    - Enable step form mode
    - Add 3 steps
    - Click step tabs and verify canvas updates
    - Drag fields from palette to different steps
    - Try to move field between steps (should fail)
    - Delete field from step
    - Verify row layout shows only active step rows
    - Save and reload form
  - [ ] Fix any failing tests

## Dev Notes

### Previous Story Context

[Source: Story 19.2 completion notes - to be updated after Story 19.2 implementation]

**Key Takeaways from Story 19.2:**

- `StepFormSidebarComponent` created for step configuration
- `FormBuilderService` has methods: `enableStepForm()`, `addStep()`, `removeStep()`, `updateStep()`,
  `reorderSteps()`
- Step state managed with signals: `steps`, `stepFormEnabled`, `activeStepId`
- User can create, edit, delete, and reorder steps (2-10 steps)
- Step configuration persists in form schema on save

**Integration Points:**

- FormCanvasComponent must read `stepFormEnabled` and `activeStepId` signals
- Field drop logic must assign `position.stepId` to active step
- Row layout sidebar must filter rows by active step
- Field palette drag-drop scoped to active step only

### Testing Standards

[Source: docs/architecture/testing-strategy.md]

**Frontend Test Location:**

- Component tests: `*.spec.ts` co-located with components
- Use Karma + Jasmine for unit testing
- Angular Testing Library with TestBed configuration

**Test Framework:**

- Jasmine with Angular testing utilities
- Mock FormBuilderService with jasmine.SpyObj
- Test drag-drop using CDK testing utilities
- Minimum 80% coverage for new code

**Canvas Drag-Drop Testing Pattern:**

```typescript
import { CdkDragDrop } from '@angular/cdk/drag-drop';

it('should assign stepId when dropping field from palette', () => {
  const mockField: FormField = { id: 'field1', type: FormFieldType.TEXT /* ... */ };
  const mockStep: FormStep = { id: 'step1', title: 'Step 1', order: 0 };

  component.activeStepId.set(mockStep.id);

  const dropEvent: CdkDragDrop<FormField[]> = {
    previousContainer: paletteContainer,
    container: canvasContainer,
    previousIndex: 0,
    currentIndex: 0,
    item: { data: mockField } as any,
    /* ... */
  };

  component.onFieldDrop(dropEvent);

  expect(mockField.position?.stepId).toBe(mockStep.id);
});
```

### Frontend Canvas Architecture

[Source: Existing form-canvas.component.ts implementation]

**Current FormCanvasComponent Structure:**

```
apps/web/src/app/features/tools/components/form-builder/form-canvas/
├── form-canvas.component.ts        # Canvas container with drag-drop
├── form-canvas.component.html      # Template with row/column grid
├── form-canvas.component.scss      # Canvas styling
├── form-canvas.component.spec.ts   # Unit tests
└── field-preview-renderer/         # Field preview components
    └── *.component.ts              # Type-specific preview renderers
```

**Existing Functionality:**

- Renders fields in row-based multi-column layout
- Angular CDK drag-drop from palette to canvas
- Field preview rendering with live updates
- Row layout configuration (1-4 columns per row)
- Field reordering within columns (`orderInColumn`)

**NEW Step-Specific Changes:**

- Add step navigation tabs above canvas
- Filter fields by `position.stepId === activeStepId`
- Assign `stepId` on field drop from palette
- Prevent cross-step field movement
- Show empty state when step has no fields
- Display active step indicator

### Drag-Drop Architecture

[Source: Angular CDK Drag-Drop documentation, existing implementation]

**CDK Drag-Drop Setup:**

```typescript
// Template
<div cdkDropListGroup>
  <!-- Palette (source) -->
  <div cdkDropList [cdkDropListData]="fieldTypes">
    <div cdkDrag [cdkDragData]="fieldType">{{ fieldType.label }}</div>
  </div>

  <!-- Canvas (target) with rows and columns -->
  @for (row of rows(); track row.rowId) {
    <div class="row">
      @for (col of getColumns(row); track col) {
        <div
          cdkDropList
          [cdkDropListData]="getFieldsInColumn(row.rowId, col)"
          [cdkDropListEnterPredicate]="canDropField"
          (cdkDropListDropped)="onFieldDrop($event)">
          <!-- Field previews -->
        </div>
      }
    </div>
  }
</div>
```

**Drop Predicate Pattern:**

```typescript
canDropField = (drag: CdkDrag, drop: CdkDropList): boolean => {
  const draggedField = drag.data as FormField;

  // Coming from palette (new field) - always allow
  if (!draggedField.position) return true;

  const targetStepId = this.activeStepId();
  const sourceStepId = draggedField.position.stepId;

  // Prevent cross-step dragging
  if (sourceStepId && sourceStepId !== targetStepId) {
    this.showError('Cannot move fields between steps');
    return false;
  }

  return true;
};
```

### Signal-Based Field Filtering

[Source: Angular 20+ signals documentation]

**Computed Signal Pattern:**

```typescript
// Filter fields by active step
protected readonly visibleFields = computed(() => {
  const enabled = this.stepFormEnabled();
  const activeId = this.activeStepId();
  const allFields = this.formBuilderService.fields();

  if (!enabled) return allFields;

  return allFields.filter(f => f.position?.stepId === activeId);
});

// Group fields by row and column for active step
protected readonly fieldsByRowColumn = computed(() => {
  const fields = this.visibleFields();
  const rows = this.activeStepRows();

  const grouped: Map<string, Map<number, FormField[]>> = new Map();

  rows.forEach(row => {
    const rowMap = new Map<number, FormField[]>();
    for (let col = 0; col < row.columnCount; col++) {
      const colFields = fields
        .filter(f => f.position?.rowId === row.rowId && f.position?.columnIndex === col)
        .sort((a, b) => (a.position?.orderInColumn ?? 0) - (b.position?.orderInColumn ?? 0));
      rowMap.set(col, colFields);
    }
    grouped.set(row.rowId, rowMap);
  });

  return grouped;
});
```

### Row Layout Integration

[Source: Epic 14 row layout implementation, Story 19.2 context]

**Row Layout Sidebar Changes:**

- Filter rows by `row.stepId === activeStepId()` when step mode enabled
- Assign `stepId` when creating new row in step mode
- Show only active step's rows for editing
- Empty state: "No rows in this step - add a row to organize fields"

**RowLayoutConfig Extension:**

```typescript
export interface RowLayoutConfig {
  rowId: string;
  columnCount: 0 | 1 | 2 | 3 | 4;
  order: number;
  stepId?: string; // NEW: Step assignment for multi-step forms
}
```

**Usage Pattern:**

```typescript
// Creating row in step mode
addRow(): void {
  const newRow: RowLayoutConfig = {
    rowId: this.generateUuid(),
    columnCount: 2,
    order: this.rows().length,
    stepId: this.activeStepId() // Assign to active step
  };
  this.formBuilderService.addRow(newRow);
}

// Filtering rows for active step
const activeStepRows = computed(() => {
  if (!this.stepFormEnabled()) return this.allRows();

  const activeId = this.activeStepId();
  return this.allRows().filter(r => r.stepId === activeId);
});
```

### Step Navigation UI Design

[Source: Epic 19 requirements, UI/UX best practices]

**Tab Navigation Pattern:**

```html
<div class="step-tabs-container">
  <div class="step-tabs">
    @for (step of steps(); track step.id) {
    <button
      class="step-tab"
      [class.active]="step.id === activeStepId()"
      [attr.aria-selected]="step.id === activeStepId()"
      (click)="onStepTabClick(step.id)"
    >
      <span class="step-number">{{ step.order + 1 }}</span>
      <span class="step-title">{{ step.title }}</span>
    </button>
    }
  </div>

  <div class="step-indicator">
    <span class="badge"> Step {{ activeStepOrder() + 1 }} of {{ steps().length }} </span>
    <button (click)="quickEditStep()" class="btn-icon" pTooltip="Edit step">
      <i class="pi pi-pencil"></i>
    </button>
  </div>
</div>
```

**Styling with Tailwind:**

```scss
.step-tabs-container {
  @apply border-b border-gray-200 bg-white;
}

.step-tabs {
  @apply flex gap-1 overflow-x-auto p-2;
}

.step-tab {
  @apply flex items-center gap-2 px-4 py-2 rounded-t-md border border-b-0 bg-gray-50 text-gray-700 hover:bg-gray-100 transition-colors;

  &.active {
    @apply bg-white border-primary-500 text-primary-700 font-semibold;
  }
}

.step-number {
  @apply flex items-center justify-center w-6 h-6 rounded-full bg-primary-100 text-primary-700 text-sm font-bold;
}

.step-title {
  @apply truncate max-w-[150px];
}
```

### Empty State Design

[Source: UI/UX best practices]

**Empty Step Placeholder:**

```html
<div class="empty-step-state">
  <div class="empty-icon">
    <i class="pi pi-inbox text-6xl text-gray-300"></i>
  </div>
  <h3 class="empty-title">No fields in Step {{ activeStepOrder() + 1 }} yet</h3>
  <p class="empty-description">
    Drag field types from the palette on the left to add them to this step.
  </p>
  <p class="empty-hint">
    <i class="pi pi-info-circle"></i>
    You can organize fields within this step using rows and columns.
  </p>
</div>
```

**Styling:**

```scss
.empty-step-state {
  @apply flex flex-col items-center justify-center min-h-[400px] p-8 text-center;
}

.empty-icon {
  @apply mb-4;
}

.empty-title {
  @apply text-xl font-semibold text-gray-700 mb-2;
}

.empty-description {
  @apply text-gray-600 mb-4 max-w-md;
}

.empty-hint {
  @apply flex items-center gap-2 text-sm text-gray-500 bg-blue-50 px-4 py-2 rounded-md;
}
```

### Error Handling

[Source: docs/architecture/coding-standards.md]

**Cross-Step Drag Prevention:**

```typescript
onFieldDrop(event: CdkDragDrop<FormField[]>): void {
  const field = event.item.data as FormField;
  const sourceStepId = field.position?.stepId;
  const targetStepId = this.activeStepId();

  // Prevent cross-step movement
  if (sourceStepId && sourceStepId !== targetStepId) {
    this.messageService.add({
      severity: 'warn',
      summary: 'Cannot Move Field',
      detail: 'Moving fields between steps is not supported yet. Create a new field in the target step instead.',
      life: 5000
    });
    return;
  }

  // Proceed with normal drop logic...
  this.handleFieldDrop(event);
}
```

### Accessibility Requirements

[Source: Epic 19 WCAG AA compliance]

**ARIA Attributes:**

- Step tabs: `role="tablist"`, `aria-label="Form steps"`
- Individual tab: `role="tab"`, `aria-selected="true/false"`, `aria-controls="canvas-panel"`
- Canvas panel: `role="tabpanel"`, `aria-labelledby="step-tab-{id}"`
- Empty state: `aria-live="polite"` for screen reader announcements

**Keyboard Navigation:**

- Tab through step tabs
- Arrow keys to navigate between step tabs
- Enter/Space to activate step tab
- Canvas maintains existing keyboard navigation for field management

### Project Structure

[Source: docs/architecture/unified-project-structure.md]

**Updated File Locations:**

```
apps/web/src/app/features/tools/components/form-builder/
├── form-canvas/
│   ├── form-canvas.component.ts        # UPDATE: Add step navigation
│   ├── form-canvas.component.html      # UPDATE: Add step tabs, filtering
│   ├── form-canvas.component.scss      # UPDATE: Step tab styling
│   └── form-canvas.component.spec.ts   # UPDATE: Add step navigation tests
├── row-layout-sidebar/
│   └── row-layout-sidebar.component.ts # UPDATE: Filter rows by step
├── form-builder.service.ts              # UPDATE: Add setActiveStep(), activeStep signals
└── step-form-sidebar/                   # From Story 19.2
    └── step-form-sidebar.component.ts
```

**Shared Types:**

```
packages/shared/src/types/forms.types.ts
├── RowLayoutConfig (UPDATE: Add stepId?: string)
├── FieldPosition (already has stepId?: string from Story 19.1)
└── FormStep (from Story 19.1)
```

### Backward Compatibility

[Source: Epic 19 context]

**Key Principles:**

1. Step tabs only visible when `stepFormEnabled() === true`
2. When step mode disabled, canvas shows all fields (existing behavior)
3. Fields without `position.stepId` display in non-step mode
4. Row layout without `stepId` works in global mode
5. No breaking changes to existing drag-drop functionality

### Tech Stack

[Source: docs/architecture/tech-stack.md]

- **Frontend Framework:** Angular 20+ standalone components
- **UI Library:** PrimeNG 17+ with Tailwind CSS 3.4+
- **Drag-Drop:** Angular CDK Drag-Drop module
- **State Management:** NgRx Signals 17+
- **Testing:** Jest 29+ with Angular Testing Library
- **TypeScript:** 5.3+ with strict mode

## Change Log

| Date       | Version | Description         | Author       |
| ---------- | ------- | ------------------- | ------------ |
| 2025-10-13 | 1.0     | Initial story draft | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent during implementation_

### Debug Log References

_To be populated by Dev Agent during implementation_

### Completion Notes List

_To be populated by Dev Agent during implementation_

### File List

_To be populated by Dev Agent during implementation_

## QA Results

_To be populated by QA Agent after review_
