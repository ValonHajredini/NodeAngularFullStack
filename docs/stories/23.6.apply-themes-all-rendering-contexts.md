# Story 23.6: Apply Themes to All Form Rendering Contexts

## Status

Draft

## Story

**As a** frontend developer, **I want** themes to apply correctly in canvas, preview, and public
forms, **so that** users see consistent theme rendering everywhere.

## Acceptance Criteria

1. Apply theme classes to Form Builder canvas:
   - Canvas background: `.theme-form-canvas-background`
   - Field wrappers: `.theme-row-container`, `.theme-column-container`
   - All field elements: use appropriate `.theme-*` classes
2. Apply theme classes to Preview modal:
   - Same class structure as canvas
   - Verify preview matches canvas exactly
3. Apply theme classes to Public form renderer:
   - Outer background: `.theme-form-outer-background`
   - Form wrapper: `.theme-form-container-wrapper`
   - All field elements: use appropriate `.theme-*` classes
4. Test all 9 seeded themes render correctly in all contexts
5. Test custom themes render correctly in all contexts
6. Verify forms without themes render with default styles

## Tasks / Subtasks

- [ ] Task 1: Apply Theme Classes to Form Builder Canvas (AC: 1)
  - [ ] Open
        `apps/web/src/app/features/tools/components/form-builder/form-canvas/form-canvas.component.ts`
  - [ ] Add `.theme-form-canvas-background` class to canvas wrapper div
  - [ ] Ensure ThemePreviewService is injected and applying CSS variables
  - [ ] Add computed signal to watch `formSettingsSignal().themeId`
  - [ ] Load theme from API when themeId changes: `GET /api/themes/:id`
  - [ ] Apply theme CSS variables using ThemePreviewService:
    ```typescript
    effect(() => {
      const themeId = this.formSettingsSignal().themeId;
      if (themeId) {
        this.loadAndApplyTheme(themeId);
      } else {
        this.themePreviewService.clearTheme(); // Use defaults
      }
    });
    ```
  - [ ] Verify canvas background color changes when theme selected
  - [ ] Write unit test: "should apply theme-form-canvas-background class"
  - [ ] Write unit test: "should load and apply theme when themeId changes"

- [ ] Task 2: Apply Theme Classes to Field Wrappers in Canvas (AC: 1)
  - [ ] Locate field rendering logic in FormCanvasComponent
  - [ ] For row layout mode:
    - Add `.theme-row-container` class to row wrapper divs
    - Add `.theme-column-container` class to column divs
  - [ ] For global layout mode:
    - Add `.theme-form-container-wrapper` class to form wrapper
  - [ ] Verify row/column backgrounds use theme colors
  - [ ] Test with row layout enabled (2-4 columns)
  - [ ] Test with global layout (1-3 columns)
  - [ ] Write unit test: "should apply theme-row-container to rows"
  - [ ] Write unit test: "should apply theme-column-container to columns"

- [ ] Task 3: Apply Theme Classes to Field Elements in Canvas (AC: 1)
  - [ ] Ensure all field previews in canvas use theme utility classes (from Story 23.4):
    - Text inputs: `.theme-input`
    - Textareas: `.theme-textarea`
    - Selects: `.theme-select`
    - Radio buttons: `.theme-radio`
    - Checkboxes: `.theme-checkbox`
    - Buttons: `.theme-button-primary`, `.theme-button-secondary`
    - Labels: `.theme-label`
    - Help text: `.theme-help-text`
  - [ ] Verify all field types render with correct theme colors
  - [ ] Test with theme selected vs. no theme (default styles)
  - [ ] Write unit test: "should apply theme-input class to text inputs"
  - [ ] Write unit test: "should apply theme-label class to labels"

- [ ] Task 4: Apply Theme Classes to Preview Dialog (AC: 2)
  - [ ] Open
        `apps/web/src/app/features/tools/components/form-builder/preview-dialog/preview-dialog.component.ts`
  - [ ] Add `.theme-form-canvas-background` class to preview dialog content area
  - [ ] Inject ThemePreviewService
  - [ ] Watch for theme changes from parent FormBuilderComponent
  - [ ] Apply theme CSS variables in preview dialog:
    ```typescript
    effect(() => {
      const themeId = this.formSchema().settings?.themeId;
      if (themeId) {
        this.loadAndApplyTheme(themeId);
      } else {
        this.themePreviewService.clearTheme();
      }
    });
    ```
  - [ ] Ensure FormRendererComponent in preview mode uses theme classes
  - [ ] Verify preview matches canvas rendering exactly
  - [ ] Write unit test: "should apply same theme as canvas"
  - [ ] Write unit test: "should match canvas rendering exactly"

- [ ] Task 5: Apply Theme Classes to Public Form Renderer - Outer Background (AC: 3)
  - [ ] Open `apps/web/src/app/features/public/form-renderer/form-renderer.component.html`
  - [ ] Locate outer page wrapper div (min-h-screen container)
  - [ ] Add `.theme-form-outer-background` class to outer div
  - [ ] Verify Tailwind layout classes are preserved (min-h-screen, py-8)
  - [ ] Test background rendering with solid color theme
  - [ ] Test background rendering with gradient theme
  - [ ] Write unit test: "should apply theme-form-outer-background to page wrapper"

- [ ] Task 6: Apply Theme Classes to Public Form Renderer - Form Container (AC: 3)
  - [ ] Locate form container div (max-w-3xl wrapper)
  - [ ] Add `.theme-form-container-wrapper` class to form container
  - [ ] Verify container background and border use theme colors
  - [ ] Test container rendering with different themes
  - [ ] Write unit test: "should apply theme-form-container-wrapper to form container"

- [ ] Task 7: Apply Theme Classes to Public Form Renderer - Field Elements (AC: 3)
  - [ ] Ensure all field rendering uses theme utility classes (already done in Story 23.4):
    - Text inputs: `.theme-input`
    - Textareas: `.theme-textarea`
    - Selects: `.theme-select`
    - Radio buttons: `.theme-radio`
    - Checkboxes: `.theme-checkbox`
    - Buttons: `.theme-button-primary`
    - Labels: `.theme-label`
    - Help text: `.theme-help-text`
    - Error text: `.theme-error-text`
  - [ ] Verify all field types render with theme colors in public form
  - [ ] Test form submission with themed form
  - [ ] Write unit test: "should apply theme classes to all field types"

- [ ] Task 8: Load and Apply Theme in Public Form Renderer (AC: 3)
  - [ ] Open `apps/web/src/app/features/public/form-renderer/form-renderer.component.ts`
  - [ ] Inject ThemePreviewService
  - [ ] Load theme from `formSchema.settings.themeId` on component init
  - [ ] Fetch theme data via `GET /api/themes/:id` (public endpoint)
  - [ ] Apply theme CSS variables using ThemePreviewService:

    ```typescript
    ngOnInit() {
      const themeId = this.formSchema().settings?.themeId;
      if (themeId) {
        this.loadAndApplyTheme(themeId);
      }
    }

    private loadAndApplyTheme(themeId: string) {
      this.formsApiService.getTheme(themeId).subscribe({
        next: (theme) => {
          this.themePreviewService.applyTheme(theme);
        },
        error: (err) => {
          console.warn('Failed to load theme, using defaults', err);
        }
      });
    }
    ```

  - [ ] Handle theme loading errors gracefully (fallback to defaults)
  - [ ] Write unit test: "should load theme on init if themeId present"
  - [ ] Write unit test: "should fallback to defaults if theme load fails"

- [ ] Task 9: Test Row Layout Rendering with Themes (AC: 1, 3)
  - [ ] Create test form with row layout enabled (2-4 columns)
  - [ ] Apply theme to form
  - [ ] Verify canvas rendering:
    - Row containers have `.theme-row-container` class
    - Column containers have `.theme-column-container` class
    - Fields within columns use theme classes
  - [ ] Verify preview dialog matches canvas
  - [ ] Publish form and verify public form rendering
  - [ ] Test responsive row stacking on mobile (columns stack vertically)
  - [ ] Write integration test: "should render row layouts with theme classes in all contexts"

- [ ] Task 10: Test Step Form Rendering with Themes (AC: 1, 3)
  - [ ] Create test step form (3+ steps)
  - [ ] Apply theme to form
  - [ ] Verify canvas rendering:
    - Step indicators use `.theme-step-indicator` class
    - Active step uses `.theme-step-indicator.active` class
    - Step navigation buttons use `.theme-step-button` class
  - [ ] Verify preview dialog matches canvas
  - [ ] Publish form and verify public form rendering
  - [ ] Test step progression (Next/Previous buttons styled with theme)
  - [ ] Write integration test: "should render step forms with theme classes in all contexts"

- [ ] Task 11: Test All 9 Seeded Themes in All Contexts (AC: 4)
  - [ ] Load Form Builder with test form
  - [ ] For each seeded theme (Ocean Blue, Sunset Orange, Forest Green, etc.):
    - Apply theme from dropdown
    - Verify canvas rendering shows theme colors
    - Open preview dialog and verify rendering matches canvas
    - Publish form and verify public form rendering
    - Verify all field types render correctly
    - Verify backgrounds, containers, and fields all use theme colors
  - [ ] Document any visual inconsistencies or bugs
  - [ ] Create visual regression screenshots for each theme in each context
  - [ ] Write automated visual regression tests (Playwright or Percy)

- [ ] Task 12: Test Custom Themes in All Contexts (AC: 5)
  - [ ] Use theme designer modal (Story 23.5) to create custom theme
  - [ ] Apply custom theme to test form
  - [ ] Verify canvas rendering shows custom theme colors
  - [ ] Open preview dialog and verify rendering matches canvas
  - [ ] Publish form and verify public form rendering
  - [ ] Test custom theme with:
    - Solid background color
    - Linear gradient background
    - Radial gradient background
    - Custom fonts (Google Fonts)
    - Custom border radius and spacing
  - [ ] Write integration test: "should render custom themes correctly in all contexts"

- [ ] Task 13: Test Forms Without Themes (Default Styles) (AC: 6)
  - [ ] Create test form with `themeId: null` (no theme selected)
  - [ ] Verify canvas rendering:
    - Theme utility classes still present
    - CSS variables use default values
    - No visual regressions compared to baseline
  - [ ] Verify preview dialog matches canvas
  - [ ] Publish form and verify public form rendering
  - [ ] Compare rendering to baseline (before Epic 23 changes)
  - [ ] Ensure backward compatibility with existing forms without themes
  - [ ] Write unit test: "should render with default theme classes when themeId is null"
  - [ ] Write integration test: "should maintain visual appearance for forms without themes"

- [ ] Task 14: Verify Theme Rendering Consistency Across Contexts (AC: 2)
  - [ ] Create test form with specific theme (e.g., Ocean Blue)
  - [ ] Take screenshot of canvas rendering
  - [ ] Take screenshot of preview dialog rendering
  - [ ] Take screenshot of published public form rendering
  - [ ] Compare screenshots pixel-by-pixel for consistency
  - [ ] Verify:
    - Background colors match
    - Container colors match
    - Field colors match
    - Font styles match
    - Spacing and padding match
  - [ ] Document any differences and fix inconsistencies
  - [ ] Write visual regression test suite for rendering consistency

- [ ] Task 15: Test Responsive Theme Rendering (Mobile, Tablet, Desktop)
  - [ ] Test canvas rendering on desktop (≥1024px)
  - [ ] Test preview dialog on desktop
  - [ ] Resize browser to tablet viewport (768-1023px)
  - [ ] Verify theme classes apply correctly at tablet breakpoint
  - [ ] Resize to mobile viewport (<768px)
  - [ ] Verify theme classes apply correctly at mobile breakpoint
  - [ ] Publish form and test on actual mobile devices (iOS, Android)
  - [ ] Test responsive row layout stacking with themes
  - [ ] Write Playwright tests for responsive theme rendering at all breakpoints

- [ ] Task 16: Add Theme Loading States and Error Handling
  - [ ] Show loading spinner while theme is being fetched in FormRendererComponent
  - [ ] Handle theme load errors gracefully:
    - Log warning to console
    - Fallback to default theme styles
    - Show error toast only in builder context (not public forms)
  - [ ] Add retry logic for failed theme loads (max 3 retries)
  - [ ] Test offline scenario (no network connection)
  - [ ] Write unit test: "should show loading spinner while theme loads"
  - [ ] Write unit test: "should fallback to defaults on theme load error"

- [ ] Task 17: Write Component Unit Tests (AC: All)
  - [ ] Test FormCanvasComponent:
    - "should apply theme-form-canvas-background class"
    - "should load and apply theme when themeId changes"
    - "should apply theme-row-container to row layouts"
    - "should apply theme utility classes to field elements"
    - "should use default styles when themeId is null"
  - [ ] Test PreviewDialogComponent:
    - "should apply same theme as canvas"
    - "should match canvas rendering exactly"
    - "should load theme when dialog opens"
  - [ ] Test FormRendererComponent:
    - "should apply theme-form-outer-background to page wrapper"
    - "should apply theme-form-container-wrapper to form container"
    - "should load theme on init if themeId present"
    - "should fallback to defaults if theme load fails"
    - "should render with default styles when themeId is null"
  - [ ] Run tests:
        `npm --workspace=apps/web run test -- --include="**/form-canvas/**/*.spec.ts" --include="**/preview-dialog/**/*.spec.ts" --include="**/form-renderer/**/*.spec.ts"`

- [ ] Task 18: Write Integration Tests (AC: All)
  - [ ] Create test file:
        `apps/web/src/app/features/tools/components/form-builder/theme-rendering.integration.spec.ts`
  - [ ] Test: "should render theme consistently in canvas, preview, and public form"
    - Create form with theme
    - Verify canvas rendering
    - Open preview and verify rendering matches
    - Publish form and verify public rendering matches
  - [ ] Test: "should render all 9 seeded themes correctly"
    - Loop through all seeded themes
    - Apply each theme
    - Verify rendering in canvas, preview, public form
  - [ ] Test: "should render custom themes correctly"
    - Create custom theme via modal
    - Apply to form
    - Verify rendering in all contexts
  - [ ] Test: "should render forms without themes with default styles"
    - Create form with no theme
    - Verify default theme classes apply
    - Verify no visual regressions
  - [ ] Run tests:
        `npm --workspace=apps/web run test -- --include="**/theme-rendering.integration.spec.ts"`

- [ ] Task 19: Write E2E Tests with Playwright (AC: All)
  - [ ] Create test file: `tests/e2e/theme-rendering.spec.ts`
  - [ ] Test: "should apply theme to form in builder canvas"
    - Login as user
    - Navigate to Form Builder
    - Create new form
    - Select theme from dropdown
    - Verify canvas background color matches theme
    - Verify field colors match theme
  - [ ] Test: "should render theme in preview modal"
    - Create form with theme
    - Click Preview button
    - Verify modal rendering matches canvas
  - [ ] Test: "should render theme in published public form"
    - Create form with theme
    - Publish form
    - Navigate to public form URL
    - Verify background, container, fields match theme
  - [ ] Test: "should render theme on mobile viewport"
    - Set viewport to mobile (375x667)
    - Navigate to published form
    - Verify theme rendering on mobile
  - [ ] Run tests: `npm run test:e2e -- theme-rendering.spec.ts`

- [ ] Task 20: Manual Testing and QA
  - [ ] Start dev environment: `npm start`
  - [ ] Test canvas rendering:
    - Create form with "Ocean Blue" theme
    - Verify canvas background is blue gradient
    - Verify fields use blue primary color
  - [ ] Test preview modal:
    - Click Preview button
    - Verify preview matches canvas exactly
  - [ ] Test public form rendering:
    - Publish form
    - Navigate to public form URL
    - Verify theme renders correctly
  - [ ] Test all 9 seeded themes in all contexts
  - [ ] Test custom theme created via modal
  - [ ] Test form without theme (default styles)
  - [ ] Test responsive rendering (mobile, tablet, desktop)
  - [ ] Run linter: `npm --workspace=apps/web run lint`
  - [ ] Run typecheck: `npm --workspace=apps/web run typecheck`
  - [ ] Run build: `npm --workspace=apps/web run build`
  - [ ] Visual QA: Compare screenshots across contexts for consistency

## Dev Notes

### Previous Story Insights

**From Story 23.4 Completion:** Story 23.4 removed all Tailwind color/typography classes from
form-canvas, preview-dialog, and form-renderer templates. All Tailwind layout utilities (flex, grid,
padding, margin) have been preserved. Theme utility classes are now in place, but CSS variables may
not be applied yet.

**From Story 23.3 Completion:** All theme utility classes have been defined in
`apps/web/src/styles/theme-variables.css`. These classes use CSS variables like
`var(--theme-primary-color)`, `var(--theme-background-color)`, etc.

**From Epic 20:** The ThemePreviewService exists and injects CSS variables into the DOM for
real-time theme preview. This service is functional and tested.

**Key Dependencies:**

- ✅ Story 23.4 must be complete (Tailwind removed, theme classes in templates)
- ✅ Story 23.3 must be complete (theme utility classes defined)
- ✅ Epic 20 ThemePreviewService functional

**From Epic 23 Analysis:** [Source: docs/prd/epic-23-complete-theme-system.md#issues-identified]

The main issue in Epic 21 was that themes only applied to form inputs and labels, not to backgrounds
and containers. Story 23.6 addresses this by ensuring ALL theme classes are applied in ALL rendering
contexts (canvas, preview, public).

### Tech Stack

**Frontend Framework:** [Source: docs/architecture/tech-stack.md]

- **Angular 20+**: Standalone components with signals
- **TypeScript 5.3+**: Strict mode enabled
- **PrimeNG 17+**: UI component library
- **RxJS**: Reactive programming for async theme loading

### Frontend Architecture

**Component Organization:** [Source: docs/architecture/frontend-architecture.md,
docs/architecture/unified-project-structure.md]

```plaintext
apps/web/src/app/features/tools/components/form-builder/
├── form-canvas/
│   └── form-canvas.component.ts          # Apply theme classes here
├── preview-dialog/
│   └── preview-dialog.component.ts       # Apply theme classes here
└── form-builder.component.ts             # Parent component

apps/web/src/app/features/public/form-renderer/
└── form-renderer.component.ts            # Apply theme classes here
```

**Shared Services:**

```plaintext
apps/web/src/app/features/tools/components/form-builder/
├── theme-preview.service.ts              # CSS variable injection (Epic 20)
└── forms-api.service.ts                  # API client for theme loading
```

### Theme Loading Pattern

**Service Method:** [Source: docs/architecture/frontend-architecture.md#service-example]

```typescript
// forms-api.service.ts
import { Injectable, inject } from '@angular/core';
import { ApiClient } from '@core/api/api.client';
import { Observable } from 'rxjs';
import { Theme } from '@nodeangularfullstack/shared';

@Injectable({ providedIn: 'root' })
export class FormsApiService {
  private readonly api = inject(ApiClient);

  getTheme(themeId: string): Observable<Theme> {
    return this.api.get<Theme>(`/themes/${themeId}`);
  }

  // ... other methods
}
```

**Component Implementation:**

```typescript
// form-canvas.component.ts
import { Component, inject, effect } from '@angular/core';
import { ThemePreviewService } from '../theme-preview.service';
import { FormsApiService } from '../forms-api.service';

export class FormCanvasComponent {
  private readonly themePreviewService = inject(ThemePreviewService);
  private readonly formsApiService = inject(FormsApiService);
  private readonly formSettingsSignal = inject(FormBuilderService).formSettingsSignal;

  constructor() {
    // Watch for theme changes and apply
    effect(() => {
      const themeId = this.formSettingsSignal().themeId;
      if (themeId) {
        this.loadAndApplyTheme(themeId);
      } else {
        this.themePreviewService.clearTheme(); // Use defaults
      }
    });
  }

  private loadAndApplyTheme(themeId: string) {
    this.formsApiService.getTheme(themeId).subscribe({
      next: (theme) => {
        this.themePreviewService.applyTheme(theme);
      },
      error: (err) => {
        console.warn('Failed to load theme, using defaults', err);
        this.themePreviewService.clearTheme();
      },
    });
  }
}
```

### ThemePreviewService Usage

**Service Interface:** [Source: docs/prd/epic-23-complete-theme-system.md#what-gets-kept-epic-20]

```typescript
// theme-preview.service.ts (Epic 20)
import { Injectable } from '@angular/core';

@Injectable({ providedIn: 'root' })
export class ThemePreviewService {
  applyTheme(theme: Theme) {
    // Inject CSS variables into document root
    const root = document.documentElement;
    root.style.setProperty('--theme-primary-color', theme.primaryColor);
    root.style.setProperty('--theme-secondary-color', theme.secondaryColor);
    root.style.setProperty('--theme-background-color', theme.backgroundColor);
    root.style.setProperty('--theme-heading-font', theme.headingFont);
    root.style.setProperty('--theme-body-font', theme.bodyFont);
    root.style.setProperty('--theme-border-radius', `${theme.borderRadius}px`);
    root.style.setProperty('--theme-field-padding', `${theme.fieldPadding}px`);
    // ... other CSS variables
  }

  clearTheme() {
    // Remove CSS variables (fallback to defaults)
    const root = document.documentElement;
    root.style.removeProperty('--theme-primary-color');
    root.style.removeProperty('--theme-secondary-color');
    // ... remove other CSS variables
  }
}
```

### Theme Utility Classes

**Class Definitions:** [Source: docs/prd/epic-23-complete-theme-system.md#technical-approach, Story
23.3]

```css
/* apps/web/src/styles/theme-variables.css */

/* Form Container & Background */
.theme-form-outer-background {
  background: var(--theme-background-color, #f9fafb);
  transition: background 300ms ease;
}

.theme-form-container-wrapper {
  background: var(--theme-container-background, #ffffff);
  border: 1px solid var(--theme-border-color, #e5e7eb);
  border-radius: var(--theme-border-radius, 8px);
  transition: all 300ms ease;
}

.theme-form-canvas-background {
  background: var(--theme-canvas-background, #f9fafb);
  transition: background 300ms ease;
}

/* Row Layout Containers */
.theme-row-container {
  background: var(--theme-row-background, transparent);
  border-radius: var(--theme-border-radius, 8px);
  transition: all 300ms ease;
}

.theme-column-container {
  background: var(--theme-column-background, transparent);
  transition: all 300ms ease;
}

/* Field Elements */
.theme-input,
.theme-textarea,
.theme-select {
  background: var(--theme-input-background, #ffffff);
  color: var(--theme-input-text-color, #111827);
  border: 1px solid var(--theme-border-color, #d1d5db);
  border-radius: var(--theme-border-radius, 8px);
  padding: var(--theme-field-padding, 12px);
  font-family: var(--theme-body-font, 'Inter', sans-serif);
  font-size: var(--theme-body-font-size, 16px);
  transition: all 300ms ease;
}

.theme-input:focus,
.theme-textarea:focus,
.theme-select:focus {
  border-color: var(--theme-primary-color, #3b82f6);
  box-shadow: 0 0 0 3px var(--theme-primary-color-light, rgba(59, 130, 246, 0.1));
}

.theme-label {
  color: var(--theme-label-color, #374151);
  font-family: var(--theme-body-font, 'Inter', sans-serif);
  font-size: var(--theme-body-font-size, 16px);
  font-weight: 500;
  transition: color 300ms ease;
}

.theme-button-primary {
  background: var(--theme-primary-color, #3b82f6);
  color: var(--theme-button-text-color, #ffffff);
  border: none;
  border-radius: var(--theme-border-radius, 8px);
  padding: var(--theme-field-padding, 12px) 24px;
  font-family: var(--theme-body-font, 'Inter', sans-serif);
  font-size: var(--theme-body-font-size, 16px);
  font-weight: 600;
  transition: all 300ms ease;
}

.theme-button-primary:hover {
  background: var(--theme-primary-color-dark, #2563eb);
}

.theme-button-secondary {
  background: var(--theme-secondary-color, #10b981);
  color: var(--theme-button-text-color, #ffffff);
  border: none;
  border-radius: var(--theme-border-radius, 8px);
  padding: var(--theme-field-padding, 12px) 24px;
  font-family: var(--theme-body-font, 'Inter', sans-serif);
  font-size: var(--theme-body-font-size, 16px);
  font-weight: 600;
  transition: all 300ms ease;
}

.theme-heading {
  color: var(--theme-heading-color, #111827);
  font-family: var(--theme-heading-font, 'Montserrat', sans-serif);
  font-size: var(--theme-heading-font-size, 24px);
  font-weight: 700;
  transition: all 300ms ease;
}

.theme-help-text {
  color: var(--theme-help-text-color, #6b7280);
  font-family: var(--theme-body-font, 'Inter', sans-serif);
  font-size: 14px;
  transition: color 300ms ease;
}

.theme-error-text {
  color: #dc2626; /* Always red for accessibility */
  font-family: var(--theme-body-font, 'Inter', sans-serif);
  font-size: 14px;
}

/* Step Form Navigation */
.theme-step-indicator {
  background: var(--theme-primary-color-light, rgba(59, 130, 246, 0.1));
  color: var(--theme-primary-color, #3b82f6);
  border: 2px solid var(--theme-primary-color, #3b82f6);
  border-radius: 50%;
  transition: all 300ms ease;
}

.theme-step-indicator.active {
  background: var(--theme-primary-color, #3b82f6);
  color: var(--theme-button-text-color, #ffffff);
}

.theme-step-button {
  background: var(--theme-secondary-color, #10b981);
  color: var(--theme-button-text-color, #ffffff);
  border: none;
  border-radius: var(--theme-border-radius, 8px);
  padding: 8px 16px;
  font-family: var(--theme-body-font, 'Inter', sans-serif);
  transition: all 300ms ease;
}

/* Transitions */
.theme-transition {
  transition: all 300ms ease;
}
```

### API Endpoint for Theme Loading

**GET /api/themes/:id:** [Source: docs/prd/epic-23-complete-theme-system.md#what-gets-kept-epic-20]

```
GET /api/themes/:id

Response (200 OK):
{
  id: string;                // UUID
  name: string;              // Theme name
  primaryColor: string;      // Hex color
  secondaryColor: string;    // Hex color
  backgroundColor: string;   // Hex color or CSS gradient
  backgroundType: 'solid' | 'linear' | 'radial' | 'image';
  backgroundImageUrl?: string;
  gradientAngle?: number;
  gradientPosition?: string;
  headingFont: string;       // Google Font name
  bodyFont: string;          // Google Font name
  headingFontSize: number;
  bodyFontSize: number;
  borderRadius: number;
  fieldPadding: number;
  fieldMargin: number;
  borderWidth: number;
  created_by: string;        // User ID
  created_at: string;        // ISO timestamp
}
```

This endpoint is public (no authentication required) for published forms.

### Rendering Context Comparison

**Canvas vs. Preview vs. Public Form:**

| Aspect              | Canvas                          | Preview Modal                   | Public Form                     |
| ------------------- | ------------------------------- | ------------------------------- | ------------------------------- |
| Background class    | `.theme-form-canvas-background` | `.theme-form-canvas-background` | `.theme-form-outer-background`  |
| Container class     | `.theme-row-container` or N/A   | `.theme-form-container-wrapper` | `.theme-form-container-wrapper` |
| Field classes       | All `.theme-*` classes          | All `.theme-*` classes          | All `.theme-*` classes          |
| Theme loading       | From FormBuilderService state   | From formSchema prop            | From API on init                |
| ThemePreviewService | Injected, watches themeId       | Injected, watches formSchema    | Injected, loads on init         |
| Editable            | Yes (drag-drop fields)          | No (read-only preview)          | No (form submission)            |

**Key Insight:** Canvas and preview should render identically except for interactivity. Public form
rendering should match preview/canvas exactly, but with different outer background class and no
editing capabilities.

### Responsive Design Considerations

**Breakpoints:** [Source: docs/prd/epic-23-complete-theme-system.md#non-functional-requirements]

- Mobile: `max-width: 767px`
- Tablet: `min-width: 768px and max-width: 1023px`
- Desktop: `min-width: 1024px`

**Row Layout Stacking:**

```css
/* Row layout responsive stacking */
.theme-row-container {
  display: grid;
  grid-template-columns: repeat(var(--column-count), 1fr);
  gap: 16px;
}

@media (max-width: 767px) {
  .theme-row-container {
    grid-template-columns: 1fr; /* Stack vertically on mobile */
  }
}
```

### Error Handling and Fallbacks

**Theme Load Failure:**

```typescript
private loadAndApplyTheme(themeId: string) {
  this.formsApiService.getTheme(themeId).pipe(
    retry(3), // Retry up to 3 times
    catchError((err) => {
      console.warn('Failed to load theme after 3 retries, using defaults', err);
      this.themePreviewService.clearTheme();
      return of(null); // Return null theme (use defaults)
    })
  ).subscribe({
    next: (theme) => {
      if (theme) {
        this.themePreviewService.applyTheme(theme);
      }
    }
  });
}
```

**Offline Scenario:**

When the network is unavailable, theme loading will fail gracefully and fallback to default theme
utility class values. The form will still render correctly, just without custom theme colors.

### Performance Considerations

**CSS Variable Performance:** CSS variables are very fast and do not trigger reflows. Changing a CSS
variable value updates all elements using that variable instantly without recalculating layout.

**Theme Loading:**

- Canvas: Theme loaded when themeId changes (reactive)
- Preview: Theme loaded when preview dialog opens (on-demand)
- Public form: Theme loaded once on page load (init)

**Caching:** Consider implementing theme caching in FormsApiService to avoid repeated API calls for
the same theme.

```typescript
private themeCache = new Map<string, Theme>();

getTheme(themeId: string): Observable<Theme> {
  if (this.themeCache.has(themeId)) {
    return of(this.themeCache.get(themeId)!);
  }

  return this.api.get<Theme>(`/themes/${themeId}`).pipe(
    tap(theme => this.themeCache.set(themeId, theme))
  );
}
```

### Backward Compatibility

**Forms Without Themes:** [Source:
docs/prd/epic-23-complete-theme-system.md#non-functional-requirements]

All existing forms (created before Epic 23) have `themeId: null`. These forms MUST continue
rendering identically after Epic 23 deployment. Theme utility classes will apply, but CSS variables
will use default values, resulting in the same visual appearance.

**Migration:** No database migration required. Existing forms without themes continue working
without changes.

## Testing

### Testing Standards

**Location:** [Source: docs/architecture/testing-strategy.md]

- Component tests: `apps/web/src/app/**/*.spec.ts`
- Integration tests:
  `apps/web/src/app/features/tools/components/form-builder/theme-rendering.integration.spec.ts`
- E2E tests: `tests/e2e/theme-rendering.spec.ts`

**Framework:**

- Karma + Jasmine for unit tests
- Angular Testing Library for component tests
- Playwright for E2E tests
- Run unit tests: `npm --workspace=apps/web run test`
- Run E2E tests: `npm run test:e2e`

**Testing Patterns:** [Source: docs/architecture/testing-strategy.md#frontend-component-test]

```typescript
import { ComponentFixture, TestBed } from '@angular/core/testing';
import { FormCanvasComponent } from './form-canvas.component';
import { ThemePreviewService } from '../theme-preview.service';
import { FormsApiService } from '../forms-api.service';
import { of } from 'rxjs';

describe('FormCanvasComponent - Theme Rendering', () => {
  let component: FormCanvasComponent;
  let fixture: ComponentFixture<FormCanvasComponent>;
  let themePreviewService: jasmine.SpyObj<ThemePreviewService>;
  let formsApiService: jasmine.SpyObj<FormsApiService>;

  beforeEach(() => {
    const themeSpy = jasmine.createSpyObj('ThemePreviewService', ['applyTheme', 'clearTheme']);
    const apiSpy = jasmine.createSpyObj('FormsApiService', ['getTheme']);

    TestBed.configureTestingModule({
      imports: [FormCanvasComponent],
      providers: [
        { provide: ThemePreviewService, useValue: themeSpy },
        { provide: FormsApiService, useValue: apiSpy },
      ],
    });

    fixture = TestBed.createComponent(FormCanvasComponent);
    component = fixture.componentInstance;
    themePreviewService = TestBed.inject(
      ThemePreviewService
    ) as jasmine.SpyObj<ThemePreviewService>;
    formsApiService = TestBed.inject(FormsApiService) as jasmine.SpyObj<FormsApiService>;
  });

  it('should apply theme-form-canvas-background class', () => {
    fixture.detectChanges();

    const canvas = fixture.nativeElement.querySelector('.form-canvas');
    expect(canvas.classList.contains('theme-form-canvas-background')).toBe(true);
  });

  it('should load and apply theme when themeId changes', () => {
    const mockTheme = {
      id: '123',
      name: 'Ocean Blue',
      primaryColor: '#3B82F6',
      secondaryColor: '#10B981',
    };
    formsApiService.getTheme.and.returnValue(of(mockTheme));

    component.formSettingsSignal.set({ themeId: '123' });
    fixture.detectChanges();

    expect(formsApiService.getTheme).toHaveBeenCalledWith('123');
    expect(themePreviewService.applyTheme).toHaveBeenCalledWith(mockTheme);
  });

  it('should use default styles when themeId is null', () => {
    component.formSettingsSignal.set({ themeId: null });
    fixture.detectChanges();

    expect(themePreviewService.clearTheme).toHaveBeenCalled();
  });
});
```

### E2E Testing Pattern

```typescript
// tests/e2e/theme-rendering.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Theme Rendering Across Contexts', () => {
  test('should apply theme to form in builder canvas', async ({ page }) => {
    // Login
    await page.goto('/auth/login');
    await page.fill('[name="email"]', 'admin@example.com');
    await page.fill('[name="password"]', 'Admin123!@#');
    await page.click('button[type="submit"]');

    // Navigate to Form Builder
    await page.goto('/tools/forms/new');

    // Select theme from dropdown
    await page.click('[data-test="theme-dropdown"]');
    await page.click('[data-test="theme-option-ocean-blue"]');

    // Verify canvas background color
    const canvas = page.locator('.form-canvas.theme-form-canvas-background');
    await expect(canvas).toBeVisible();

    const bgColor = await canvas.evaluate((el) => window.getComputedStyle(el).backgroundColor);
    expect(bgColor).toContain('59, 130, 246'); // RGB of #3B82F6
  });

  test('should render theme in preview modal', async ({ page }) => {
    // ... create form with theme
    await page.click('[data-test="preview-button"]');

    // Verify preview rendering
    const previewDialog = page.locator('p-dialog');
    await expect(previewDialog).toBeVisible();

    const previewCanvas = previewDialog.locator('.theme-form-canvas-background');
    const bgColor = await previewCanvas.evaluate(
      (el) => window.getComputedStyle(el).backgroundColor
    );
    expect(bgColor).toContain('59, 130, 246');
  });

  test('should render theme in published public form', async ({ page }) => {
    // ... create and publish form with theme
    const publicUrl = await page.locator('[data-test="public-form-url"]').innerText();

    // Navigate to public form
    await page.goto(publicUrl);

    // Verify theme rendering
    const outerBg = page.locator('.theme-form-outer-background');
    await expect(outerBg).toBeVisible();

    const container = page.locator('.theme-form-container-wrapper');
    await expect(container).toBeVisible();
  });
});
```

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-10-17 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

<!-- Populated by development agent during implementation -->

### Agent Model Used

<!-- e.g., Claude 3.5 Sonnet -->

### Debug Log References

<!-- Reference any debug logs or traces generated during development -->

### Completion Notes List

<!-- Notes about the completion of tasks and any issues encountered -->

### File List

<!-- List all files created, modified, or affected during story implementation -->

## QA Results

<!-- Results from QA Agent QA review of the completed story implementation -->
