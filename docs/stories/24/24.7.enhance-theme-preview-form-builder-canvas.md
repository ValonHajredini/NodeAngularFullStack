# Story 24.7: Enhance Theme Preview in Form Builder Canvas

## Status

Draft

## Story

**As a** form creator,  
**I want** the form builder canvas to immediately reflect theme changes across all field type
previews,  
**so that** I can preview exactly how my published form will look and make design decisions with
real-time visual feedback.

## Acceptance Criteria

1. **Immediate Theme Application**: Theme selection triggers instant visual update across all field
   previews (no page reload)

2. **Field Preview Components Updated**: All preview components consume theme CSS variables:
   - `text-input-preview.component.ts/.scss`
   - `select-preview.component.ts/.scss`
   - `checkbox-preview.component.ts/.scss`
   - `radio-preview.component.ts/.scss`
   - `textarea-preview.component.ts/.scss`
   - (and all other field type preview components)

3. **Canvas Background**: Form canvas respects `--theme-container-background` and
   `--theme-container-opacity`

   ```scss
   #form-canvas {
     background-color: var(--theme-container-background, transparent);
     opacity: var(--theme-container-opacity, 1);
   }
   ```

4. **Theme Designer Modal Preview**: Preview section in Theme Designer Modal shows accurate field
   rendering with selected colors

5. **No Visual Flicker**: Theme transitions are smooth without intermediate states or flicker

6. **Multi-Field Update**: All fields on canvas update simultaneously (not one-by-one)

7. **Row Layout Theming**: Row containers and column borders respect theme spacing/colors

8. **Step Form Theming**: Step indicators use `--theme-step-active-color` and
   `--theme-step-inactive-color`

## Tasks / Subtasks

- [ ] Task 1: Update FormBuilderService theme application (AC: 1, 6)
  - [ ] Ensure applyTheme method triggers change detection properly
  - [ ] Implement batch theme application for all fields simultaneously
  - [ ] Add theme application performance monitoring
  - [ ] Ensure theme state is properly managed in form builder service
- [ ] Task 2: Update form canvas container styling (AC: 3)
  - [ ] Apply theme container background and opacity to form canvas
  - [ ] Ensure canvas background updates immediately with theme changes
  - [ ] Test canvas background with different theme configurations
- [ ] Task 3: Update all field preview components (AC: 2)
  - [ ] Update text-input-preview.component.scss with theme variables
  - [ ] Update select-preview.component.scss with theme variables
  - [ ] Update checkbox-preview.component.scss with theme variables
  - [ ] Update radio-preview.component.scss with theme variables
  - [ ] Update textarea-preview.component.scss with theme variables
  - [ ] Update all remaining field type preview components
  - [ ] Ensure consistent theme variable usage across all previews
- [ ] Task 4: Implement row layout theming (AC: 7)
  - [ ] Apply theme spacing variables to row containers
  - [ ] Style column borders with theme border colors
  - [ ] Ensure row layout respects theme spacing settings
  - [ ] Test row layout theming with different column configurations
- [ ] Task 5: Implement step form theming (AC: 8)
  - [ ] Apply theme step colors to step indicators
  - [ ] Style active and inactive step states
  - [ ] Ensure step navigation respects theme colors
  - [ ] Test step form theming across different step configurations
- [ ] Task 6: Update Theme Designer Modal preview (AC: 4)
  - [ ] Ensure preview section shows accurate field rendering
  - [ ] Update preview fields to use current theme colors
  - [ ] Test theme designer modal preview accuracy
- [ ] Task 7: Optimize theme transition performance (AC: 5)
  - [ ] Implement smooth theme transitions without flicker
  - [ ] Ensure theme application completes in <50ms
  - [ ] Test theme switching performance with large forms
  - [ ] Optimize change detection for theme updates
- [ ] Task 8: Testing and verification (AC: 1-8)
  - [ ] Test theme selection shows immediate visual update
  - [ ] Test all field previews reflect theme changes
  - [ ] Test canvas background updates with theme
  - [ ] Test row layout theming
  - [ ] Test step form theming
  - [ ] Test theme designer modal preview
  - [ ] Verify no console errors during theme switching
  - [ ] Test performance with forms containing 20+ fields

## Dev Notes

### Previous Story Insights

This story builds on Stories 24.2-24.6 (all field type theme implementations). The form builder
canvas needs to integrate all the theme variable implementations from the previous stories and
ensure real-time preview updates.

### Data Models

**Theme CSS Variables** [Source: architecture/tech-stack.md#css-framework]:

- --theme-container-background: Canvas background color
- --theme-container-opacity: Canvas opacity
- --theme-step-active-color: Active step indicator color
- --theme-step-inactive-color: Inactive step indicator color
- --theme-field-spacing: Spacing between fields
- --theme-row-spacing: Spacing between rows
- --theme-column-gap: Gap between columns
- All field-specific theme variables from previous stories

### API Specifications

**Theme Application Flow** [Source: architecture/frontend-architecture.md#component-architecture]:

- FormBuilderService.applyTheme() triggers theme application
- ThemePreviewService injects CSS variables into document :root
- FormBuilderComponent manages theme selection and application
- Theme data stored in form.schema.settings.themeId

### Component Specifications

**Form Builder Components** [Source: architecture/unified-project-structure.md]:

- FormBuilderComponent: form-builder.component.ts
- FormBuilderService: form-builder.service.ts
- FormCanvasComponent: form-canvas.component.ts
- ThemePreviewService: theme-preview.service.ts
- All field preview components in form-canvas/field-preview-renderer/

**CSS Implementation Pattern** [Source: architecture/tech-stack.md#css-framework]:

```scss
// Form canvas container with theme-aware background
#form-canvas {
  background-color: var(--theme-container-background, transparent);
  opacity: var(--theme-container-opacity, 1);
  transition:
    background-color 0.2s ease,
    opacity 0.2s ease;
}

// Field preview components
.field-preview-container {
  margin-bottom: var(--theme-field-spacing, 1rem);

  .preview-label {
    color: var(--theme-label-color, #374151);
    font-family: var(--theme-body-font, system-ui);
    font-weight: 500;
    margin-bottom: 0.5rem;
    display: block;
  }

  .preview-input {
    background-color: var(--theme-input-background, #ffffff);
    border: 1px solid var(--theme-input-border-color, #d1d5db);
    color: var(--theme-input-text-color, #1f2937);
    font-family: var(--theme-body-font, system-ui);
    border-radius: var(--theme-border-radius, 0.375rem);
    padding: 0.5rem 0.75rem;
    width: 100%;

    &::placeholder {
      color: var(--theme-help-text-color, #9ca3af);
    }
  }

  .preview-help-text {
    color: var(--theme-help-text-color, #6b7280);
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }
}

// Row layout theming
.row-container {
  margin-bottom: var(--theme-row-spacing, 1rem);

  .column {
    gap: var(--theme-column-gap, 1rem);
    border: 1px solid var(--theme-input-border-color, #d1d5db);
    border-radius: var(--theme-border-radius, 0.375rem);
    padding: var(--theme-container-padding, 1rem);
  }
}

// Step form theming
.step-indicator {
  &.active {
    background-color: var(--theme-step-active-color, #3b82f6);
    color: white;
  }

  &.inactive {
    background-color: var(--theme-step-inactive-color, #e5e7eb);
    color: var(--theme-text-secondary, #6b7280);
  }
}
```

### File Locations

**Key Files to Modify** [Source: architecture/unified-project-structure.md]:

- `apps/web/src/app/features/tools/components/form-builder/form-builder.component.ts` - Main form
  builder component
- `apps/web/src/app/features/tools/components/form-builder/form-builder.service.ts` - Form builder
  service
- `apps/web/src/app/features/tools/components/form-builder/form-canvas/form-canvas.component.scss` -
  Form canvas styles
- `apps/web/src/app/features/tools/components/form-builder/theme-preview.service.ts` - Theme preview
  service
- All field preview component SCSS files in `form-canvas/field-preview-renderer/`

### Testing Requirements

**Testing Standards** [Source: architecture/testing-strategy.md#frontend-tests]:

- Component tests beside implementation files (\*.spec.ts)
- Use Angular testing utilities with TestBed
- Visual regression testing with Playwright for E2E scenarios
- Manual testing for theme application verification

**Specific Testing Requirements for This Story**:

- Unit tests for form builder service theme application
- E2E tests for theme selection and canvas updates
- Visual regression tests for theme preview accuracy
- Performance testing for theme application speed
- Integration testing for all field preview components

### Technical Constraints

**CSS Specificity Strategy** [Source: architecture/tech-stack.md#css-framework]:

- Use CSS variables with fallback values for graceful degradation
- Custom field CSS (Story 16.2) overrides theme CSS variables
- Always provide fallback values in var() function
- Test CSS variable inheritance in nested components

**Performance Considerations**:

- Theme application must complete in <50ms for forms with 50+ fields
- Use ChangeDetectionStrategy.OnPush for field preview components
- Batch DOM updates when switching themes
- Implement performance monitoring for theme application

**Change Detection Strategy**:

- Ensure theme changes trigger proper change detection
- Use signals for reactive theme state management
- Optimize change detection for large forms
- Test theme application with forms containing 20+ fields

### Project Structure Notes

All file paths align with the unified project structure. Form builder components are located in the
tools feature module, with field preview components in the form-canvas subdirectory.

## Testing

**Manual Testing Checklist**:

- [ ] Select theme from dropdown → all canvas fields update immediately
- [ ] Switch between 3 different themes → verify consistent real-time updates
- [ ] Add new field after theme applied → new field inherits current theme
- [ ] Open Theme Designer Modal → preview section shows theme-styled fields
- [ ] Test row layout theming with different column configurations
- [ ] Test step form theming with multi-step forms
- [ ] Verify no console errors during theme switching
- [ ] Test performance with forms containing 20+ fields

**Automated Testing**:

- [ ] Unit tests for form builder service theme application
- [ ] E2E tests for theme selection and canvas updates
- [ ] Visual regression tests for theme preview accuracy
- [ ] Performance tests for theme application speed
- [ ] Integration tests for all field preview components

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2025-01-27 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be populated here_
