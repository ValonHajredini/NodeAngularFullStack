# Story 24.8: End-to-End Theme Verification & Regression Testing

## Status

Draft

## Story

**As a** QA engineer,  
**I want** comprehensive testing of theme application across all field types in form builder and
published forms,  
**so that** I can verify all 16 field types correctly apply theme styling in all environments
without breaking existing functionality.

## Acceptance Criteria

1. **All Field Types Tested**: Each of 16 field types manually tested with 3 different themes:
   - **Light Theme** (white background, dark text, blue primary)
   - **Dark Theme** (dark background, light text, purple primary)
   - **Custom Theme** (custom colors, fonts, spacing)

2. **Builder Canvas Testing**:
   - [ ] All fields show theme colors immediately after theme selection
   - [ ] Theme switching updates all fields without page reload
   - [ ] New fields inherit current theme when added
   - [ ] Field drag-drop maintains theme styling
   - [ ] Field editing modal shows themed fields

3. **Preview Mode Testing** (Story 14.3):
   - [ ] Preview dialog shows form with correct theme styling
   - [ ] All field types render with theme colors in preview
   - [ ] Preview matches published form appearance

4. **Published Form Testing**:
   - [ ] Public form loads theme data from API correctly
   - [ ] All field types render with theme styling
   - [ ] Theme colors match builder preview exactly
   - [ ] Form submission works with themed fields

5. **Mobile Responsive Testing** (<768px):
   - [ ] Mobile theme overrides apply correctly
   - [ ] All field types readable and functional on mobile
   - [ ] Touch interactions work with themed fields
   - [ ] Grid layouts adapt responsively with theme spacing

6. **Forms Without Themes** (Backward Compatibility):
   - [ ] Existing forms without `themeId` show default PrimeNG styling
   - [ ] No visual regression for un-themed forms
   - [ ] Forms can be edited without requiring theme selection

7. **Theme Deletion Handling** (AC: 5 from Story 20.7):
   - [ ] Forms with deleted themes fall back to default styling
   - [ ] Console warning displayed when theme not found
   - [ ] No errors thrown when theme is missing
   - [ ] Form remains functional after theme deletion

8. **Browser Compatibility**:
   - [ ] Chrome (latest)
   - [ ] Firefox (latest)
   - [ ] Safari (latest)
   - [ ] Edge (latest)

9. **Performance Testing**:
   - [ ] Theme application completes in <50ms (measured with DevTools)
   - [ ] No memory leaks when switching themes repeatedly
   - [ ] Smooth animations during theme transitions

10. **Visual Regression Tests**:
    - [ ] Playwright screenshots captured for each field type with each theme
    - [ ] Baseline screenshots match expected appearance
    - [ ] No unintended styling changes detected

## Tasks / Subtasks

- [ ] Task 1: Create comprehensive manual testing checklist (AC: 1)
  - [ ] Document testing checklist for all 16 field types with 3 themes
  - [ ] Create test data for light, dark, and custom themes
  - [ ] Prepare test forms with all field types for testing
  - [ ] Document expected visual outcomes for each theme/field combination
- [ ] Task 2: Execute builder canvas testing (AC: 2)
  - [ ] Test theme selection and immediate visual updates
  - [ ] Test theme switching without page reload
  - [ ] Test new field inheritance of current theme
  - [ ] Test field drag-drop with theme styling
  - [ ] Test field editing modal theme application
- [ ] Task 3: Execute preview mode testing (AC: 3)
  - [ ] Test preview dialog theme rendering
  - [ ] Verify all field types show theme colors in preview
  - [ ] Compare preview appearance with published form
  - [ ] Test preview mode with different themes
- [ ] Task 4: Execute published form testing (AC: 4)
  - [ ] Test public form theme data loading from API
  - [ ] Verify all field types render with theme styling
  - [ ] Compare published form with builder preview
  - [ ] Test form submission functionality with themed fields
- [ ] Task 5: Execute mobile responsive testing (AC: 5)
  - [ ] Test mobile theme overrides on actual devices
  - [ ] Verify field readability and functionality on mobile
  - [ ] Test touch interactions with themed fields
  - [ ] Test responsive grid layouts with theme spacing
- [ ] Task 6: Execute backward compatibility testing (AC: 6)
  - [ ] Test existing forms without themeId
  - [ ] Verify default PrimeNG styling for un-themed forms
  - [ ] Test form editing without theme selection
  - [ ] Document any visual regressions
- [ ] Task 7: Execute theme deletion handling testing (AC: 7)
  - [ ] Test forms with deleted themes
  - [ ] Verify graceful fallback to default styling
  - [ ] Check console warnings for missing themes
  - [ ] Test form functionality after theme deletion
- [ ] Task 8: Execute browser compatibility testing (AC: 8)
  - [ ] Test theme application in Chrome (latest)
  - [ ] Test theme application in Firefox (latest)
  - [ ] Test theme application in Safari (latest)
  - [ ] Test theme application in Edge (latest)
- [ ] Task 9: Execute performance testing (AC: 9)
  - [ ] Measure theme application time with DevTools
  - [ ] Test memory usage during theme switching
  - [ ] Verify smooth animations during transitions
  - [ ] Test performance with large forms (50+ fields)
- [ ] Task 10: Create automated visual regression tests (AC: 10)
  - [ ] Create Playwright test suite for theme verification
  - [ ] Capture baseline screenshots for each field type/theme combination
  - [ ] Implement automated screenshot comparison
  - [ ] Set up CI/CD integration for visual regression testing

## Dev Notes

### Previous Story Insights

This story builds on all previous stories in Epic 24 (24.1-24.7). It provides comprehensive
verification that all theme implementations work correctly across all environments and use cases.

### Data Models

**Theme Testing Data** [Source: architecture/tech-stack.md#css-framework]:

- Light Theme: White background, dark text, blue primary (#3b82f6)
- Dark Theme: Dark background, light text, purple primary (#8b5cf6)
- Custom Theme: Custom colors, fonts, spacing for edge case testing
- All 16 field types: TEXT, EMAIL, NUMBER, TEXTAREA, SELECT, RADIO, CHECKBOX, DATE, DATETIME,
  TOGGLE, FILE, IMAGE_GALLERY, HEADING, IMAGE, TEXT_BLOCK, DIVIDER

### API Specifications

**Theme Testing Endpoints** [Source: architecture/frontend-architecture.md#component-architecture]:

- Theme data loading: `/api/themes/{id}` for published forms
- Form submission: `/api/public/forms/{shortCode}/submit`
- Theme application: ThemePreviewService.applyThemeCss()
- Form builder theme selection: FormBuilderService.applyTheme()

### Component Specifications

**Testing Components** [Source: architecture/unified-project-structure.md]:

- FormBuilderComponent: Theme selection and canvas updates
- FormRendererComponent: Public form theme rendering
- All field preview components: Theme variable application
- ThemePreviewService: CSS variable injection
- FormBuilderService: Theme state management

**Automated Testing Implementation** [Source: architecture/testing-strategy.md#e2e-tests]:

```typescript
// tests/e2e/story-24.8-theme-verification.spec.ts

import { test, expect } from '@playwright/test';

test.describe('Story 24.8: Universal Theme Application', () => {
  test.beforeEach(async ({ page }) => {
    // Login and navigate to form builder
    await page.goto('/login');
    await page.fill('input[type="email"]', 'admin@example.com');
    await page.fill('input[type="password"]', 'Admin123!@#');
    await page.click('button[type="submit"]');
    await page.goto('/app/tools/form-builder');
  });

  test('should apply light theme to all field types', async ({ page }) => {
    // Add all 16 field types to form
    const fieldTypes = [
      'Text Input',
      'Email',
      'Number',
      'Select Option',
      'Text Area',
      'File Upload',
      'Checkbox',
      'Radio Button',
      'Date',
      'Date & Time',
      'Toggle',
      'Image Gallery',
      'Untitled Heading',
      'Image',
      'Text Block',
      'Section Divider',
    ];

    for (const fieldType of fieldTypes) {
      await page.click(`text=${fieldType}`);
      await page.waitForTimeout(500);
    }

    // Select light theme from dropdown
    await page.click('button:has-text("Styling Themes")');
    await page.waitForSelector('.theme-grid');
    await page.click('.theme-card:has-text("Light Theme")');
    await page.waitForTimeout(1000);

    // Take screenshot for visual regression
    await page.screenshot({
      path: 'tests/screenshots/light-theme-all-fields.png',
      fullPage: true,
    });

    // Verify theme CSS variables are applied
    const primaryColor = await page.evaluate(() => {
      return getComputedStyle(document.documentElement).getPropertyValue('--theme-primary-color');
    });
    expect(primaryColor).toBeTruthy();

    // Save and publish form
    await page.click('button:has-text("Save")');
    await page.waitForSelector('text=Draft Saved');
    await page.click('button:has-text("Publish")');
    await page.waitForSelector('text=Form Published');

    // Get public form URL and test
    const publicUrl = await page.inputValue('input[readonly][value*="/forms/render/"]');
    expect(publicUrl).toContain('/forms/render/');

    // Open public form in new page
    const publicPage = await page.context().newPage();
    await publicPage.goto(publicUrl);
    await publicPage.waitForLoadState('networkidle');

    // Verify theme applied in public form
    const publicPrimaryColor = await publicPage.evaluate(() => {
      return getComputedStyle(document.documentElement).getPropertyValue('--theme-primary-color');
    });
    expect(publicPrimaryColor).toBe(primaryColor);

    // Take screenshot of public form
    await publicPage.screenshot({
      path: 'tests/screenshots/light-theme-public-form.png',
      fullPage: true,
    });
  });

  test('should handle forms without themes (backward compatibility)', async ({ page }) => {
    // Add fields without selecting theme
    await page.click('text=Text Input');
    await page.click('text=Email');
    await page.click('text=Select Option');

    // Verify default styling (no theme CSS variables)
    const backgroundColor = await page.evaluate(() => {
      const input = document.querySelector('input[type="text"]');
      return input ? getComputedStyle(input).backgroundColor : null;
    });
    expect(backgroundColor).toBeTruthy();

    // Save and publish
    await page.click('button:has-text("Save")');
    await page.click('button:has-text("Publish")');

    // Verify public form works without theme
    const publicUrl = await page.inputValue('input[readonly][value*="/forms/render/"]');
    const publicPage = await page.context().newPage();
    await publicPage.goto(publicUrl);

    // Verify form is functional
    await publicPage.fill('input[type="text"]', 'Test value');
    await publicPage.click('button[type="submit"]');
    await publicPage.waitForSelector('text=Thank you');
  });

  test('theme application performance', async ({ page }) => {
    // Add multiple fields
    for (let i = 0; i < 20; i++) {
      await page.click('text=Text Input');
    }

    // Measure theme application time
    const startTime = Date.now();
    await page.click('button:has-text("Styling Themes")');
    await page.click('.theme-card:first-child');
    await page.waitForTimeout(100); // Small buffer for visual update
    const endTime = Date.now();

    const duration = endTime - startTime;
    expect(duration).toBeLessThan(100); // Should be < 100ms for 20 fields
  });
});
```

### File Locations

**Key Files for Testing** [Source: architecture/unified-project-structure.md]:

- `tests/e2e/story-24.8-theme-verification.spec.ts` - Main E2E test suite
- `tests/e2e/story-24.8-performance.spec.ts` - Performance testing
- `tests/screenshots/` - Visual regression test screenshots
- `apps/web/src/app/features/tools/components/form-builder/` - Form builder components
- `apps/web/src/app/features/public/form-renderer/` - Public form renderer

### Testing Requirements

**Testing Standards** [Source: architecture/testing-strategy.md#e2e-tests]:

- Playwright for cross-browser E2E testing
- Visual regression testing with screenshot comparison
- Performance testing with DevTools integration
- Manual testing for comprehensive verification

**Specific Testing Requirements for This Story**:

- Comprehensive manual testing across all field types and themes
- Automated E2E tests for theme application workflow
- Visual regression tests for theme consistency
- Performance testing for theme application speed
- Browser compatibility testing across major browsers
- Mobile responsive testing on actual devices

### Technical Constraints

**Testing Environment Requirements** [Source: architecture/testing-strategy.md#e2e-tests]:

- Local development environment with all services running
- Test database with seeded data
- Multiple browser environments for compatibility testing
- Mobile devices for responsive testing

**Performance Testing Constraints**:

- Theme application must complete in <50ms
- No memory leaks during repeated theme switching
- Smooth animations during theme transitions
- Performance testing with forms containing 50+ fields

**Visual Regression Testing**:

- Baseline screenshots must be captured for each field type/theme combination
- Screenshot comparison must detect unintended styling changes
- CI/CD integration for automated visual regression testing

### Project Structure Notes

All file paths align with the unified project structure. Testing files are located in the tests
directory, with E2E tests in the e2e subdirectory and screenshots in the screenshots subdirectory.

## Testing

**Manual Testing Checklist** (per theme):

```markdown
## Theme: [Light/Dark/Custom]

### TEXT Input

- [ ] Background color matches theme
- [ ] Border color matches theme
- [ ] Text color matches theme
- [ ] Label color matches theme
- [ ] Focus state shows primary color
- [ ] Help text shows secondary color

### EMAIL Input

- [ ] Same checks as TEXT

### NUMBER Input

- [ ] Same checks as TEXT
- [ ] Number controls styled with theme

### TEXTAREA

- [ ] Same checks as TEXT
- [ ] Resizable handle styled appropriately

### SELECT Dropdown

- [ ] Dropdown background matches theme
- [ ] Border color matches theme
- [ ] Selected option text matches theme
- [ ] Dropdown icon colored with theme

### RADIO Buttons

- [ ] Selected state uses primary color
- [ ] Label color matches theme
- [ ] Hover state shows primary color

### CHECKBOX

- [ ] Checked state uses primary color
- [ ] Checkmark visible on themed background
- [ ] Label color matches theme

### DATE Picker

- [ ] Input field styled with theme
- [ ] Calendar header uses primary color
- [ ] Selected date highlighted with primary color

### DATETIME Picker

- [ ] Same checks as DATE
- [ ] Time section styled with theme

### TOGGLE Switch

- [ ] Active state uses primary color
- [ ] Inactive state uses neutral theme color
- [ ] Label color matches theme

### FILE Upload

- [ ] Button uses primary button background
- [ ] Button text uses primary button text color
- [ ] File name display uses theme text color

### IMAGE_GALLERY

- [ ] Grid borders use theme border color
- [ ] Selected image border uses primary color
- [ ] Hover effect shows primary color
- [ ] Grid spacing matches theme

### HEADING (h1-h6)

- [ ] Font family matches theme heading font
- [ ] Color matches theme heading color
- [ ] All heading levels styled consistently

### IMAGE

- [ ] Border radius matches theme
- [ ] Caption uses theme secondary text color

### TEXT_BLOCK

- [ ] Font family matches theme body font
- [ ] Text color matches theme primary text
- [ ] Paragraph spacing appropriate

### DIVIDER

- [ ] Line color matches theme border color
- [ ] Thickness/style options work correctly
```

**Automated Testing**:

- [ ] Playwright E2E test suite for theme verification
- [ ] Visual regression tests with screenshot comparison
- [ ] Performance tests for theme application speed
- [ ] Browser compatibility tests across major browsers
- [ ] Mobile responsive tests on actual devices

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2025-01-27 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be populated here_
