# Story 24.9: Enhanced Theme Management - Update and Delete Existing Themes

## Brownfield Addition

## User Story

As a **form builder user**, I want **the ability to update and delete my existing custom themes from
the same Theme Designer Modal used for creation**, So that **I can manage my theme library without
navigating away from the form builder and maintain consistency in my theme management workflow**.

## Story Context

**Existing System Integration:**

- Integrates with: ThemeDesignerModal, ThemeDropdownComponent, ThemesApiService
- Technology: Angular 20+ standalone components, PrimeNG 17+, RxJS signals, Express.js backend
- Follows pattern: Edit/delete actions in dropdown cards (similar to form cards in
  FormBuilderComponent)
- Touch points:
  - Frontend: `apps/web/src/app/features/tools/components/form-builder/theme-designer-modal/`
  - Frontend: `apps/web/src/app/features/tools/components/form-builder/theme-dropdown/`
  - Backend: `apps/api/src/controllers/themes.controller.ts` (UPDATE and DELETE endpoints already
    exist)
  - Backend: `apps/api/src/routes/themes.routes.ts` (routes configured with authorization
    middleware)

## Acceptance Criteria

**Functional Requirements:**

1. **Edit Theme Action**
   - Theme cards in the dropdown display "Edit" icon button (only for custom themes owned by current
     user)
   - Clicking "Edit" opens the existing ThemeDesignerModal in **edit mode**
   - Modal pre-populates all wizard steps with the theme's current configuration:
     - Step 1 (Colors): primaryColor, secondaryColor
     - Step 2 (Background): backgroundType, backgroundColor, gradient settings, imageUrl
     - Step 3 (Typography): headingFont, bodyFont, font sizes
     - Step 4 (Styling): borderRadius, fieldPadding, fieldSpacing, border widths
     - Step 5 (Preview): theme name (editable)
   - Modal header changes from "Create Custom Theme" to "Edit Theme: {name}"
   - Saving the edited theme calls PUT `/api/themes/:id` endpoint
   - Theme dropdown refreshes to show updated theme after successful save

2. **Delete Theme Action**
   - Theme cards in the dropdown display "Delete" icon button (only for custom themes owned by
     current user)
   - Clicking "Delete" shows PrimeNG ConfirmDialog with warning:
     - Header: "Delete Theme"
     - Message: "Are you sure you want to delete '{themeName}'? This action cannot be undone. Forms
       using this theme will revert to the default theme."
     - Buttons: "Cancel" (secondary) and "Delete" (danger)
   - Confirming deletion calls DELETE `/api/themes/:id` endpoint
   - Theme dropdown refreshes to remove deleted theme after successful deletion
   - Toast notification shows "Theme deleted successfully"

3. **Authorization and Ownership**
   - Edit and Delete buttons only appear for themes where `theme.createdBy === currentUserId`
   - System themes (predefined themes) do not show Edit or Delete buttons
   - Backend authorization middleware validates ownership before allowing update/delete

**Integration Requirements:**

4. Existing ThemeDesignerModalService API remains unchanged for create mode
5. ThemeDesignerModalService extended with new methods:
   - `loadTheme(theme: FormTheme): void` - Populates wizard state from existing theme
   - `setEditMode(themeId: string): void` - Sets modal to edit mode with theme ID
   - `isEditMode(): boolean` - Returns true if editing existing theme
6. ThemeDropdownComponent refreshes theme list after create, update, or delete operations
7. FormBuilderComponent passes current user ID to ThemeDropdownComponent for ownership checks
8. ThemesApiService uses existing methods:
   - `updateTheme(id: string, data: UpdateThemeRequest): Observable<FormTheme>`
   - `deleteTheme(id: string): Observable<void>`

**Quality Requirements:**

7. Changes covered by appropriate unit tests for modal service and components
8. E2E test validates full edit and delete workflow
9. No regression in existing theme creation functionality verified

## Technical Notes

**Integration Approach:**

- **Modal Reuse**: ThemeDesignerModal component supports both create and edit modes via service
  flags
- **Theme Loading**: ThemeDesignerModalService maps `FormTheme` → internal wizard signals in
  `loadTheme()` method
- **Card Actions**: ThemeCardComponent extended with `@Output() edit` and `@Output() delete` events
- **Ownership Check**: ThemeDropdownComponent receives `@Input() currentUserId` from
  FormBuilderComponent
- **API Integration**: Backend endpoints already exist with proper validation and authorization

**Existing Pattern Reference:**

- FormBuilderComponent → FormsList → Form cards with Edit/Delete actions (similar UX pattern)
- PrimeNG ConfirmDialog usage: See `theme-designer-modal.component.ts:418-442` for unsaved changes
  confirmation
- Authorization middleware: `apps/api/src/middleware/auth.middleware.ts` →
  `requireThemeOwnerOrAdmin`

**Key Constraints:**

- Must maintain backward compatibility with existing theme creation workflow
- Edit mode must validate all fields before allowing save (reuse existing wizard validation)
- Delete operation is soft delete (sets `is_active = false` in database)
- Forms using deleted themes must handle gracefully (theme service should provide fallback to
  default theme)

**UI/UX Notes:**

- Edit and Delete buttons appear on hover over theme card (desktop) or always visible (mobile)
- Edit button: Icon `pi-pencil`, tooltip "Edit theme"
- Delete button: Icon `pi-trash`, tooltip "Delete theme", danger color
- Modal title changes: "Create Custom Theme" (create mode) vs "Edit Theme: {name}" (edit mode)
- Save button text changes: "Save Theme" (create mode) vs "Update Theme" (edit mode)

## Definition of Done

- [x] **Quick Project Assessment** - Context gathered, existing patterns identified
- [x] ThemeDesignerModalService extended with `loadTheme()`, `setEditMode()`, `isEditMode()` methods
- [x] ThemeDesignerModalComponent supports edit mode with dynamic header and button text
- [x] ThemeCardComponent extended with Edit and Delete event emitters
- [x] ThemeDropdownComponent implements ownership checks and shows Edit/Delete buttons conditionally
- [x] ThemesApiService methods integrated for update and delete operations (updateTheme,
      deleteTheme)
- [x] FormBuilderComponent passes current user ID to ThemeDropdownComponent
- [x] PrimeNG ConfirmDialog integrated for delete confirmation
- [x] Toast notifications for successful update and delete operations
- [ ] Unit tests pass for ThemeDesignerModalService, ThemeDropdownComponent, ThemeCardComponent
- [ ] E2E test validates full edit and delete workflow (story-24.9-theme-management.spec.ts)
- [ ] Existing theme creation functionality regression tested
- [x] Code follows Angular 20+ standalone component patterns and PrimeNG best practices
- [x] Authorization middleware tested to prevent unauthorized edit/delete (backend already has
      requireThemeOwnerOrAdmin middleware)

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk**: Editing a theme that's actively used by multiple forms could confuse users if
  they see unexpected visual changes
- **Mitigation**: Show usage count and list of forms using the theme in confirmation dialog before
  saving edits
- **Rollback**: Deleted themes are soft-deleted (`is_active = false`), can be restored via database
  if needed

**Compatibility Verification:**

- [x] No breaking changes to existing theme creation API
- [x] Database changes are read-only (no schema modifications required)
- [x] UI changes follow existing PrimeNG and Tailwind CSS design patterns
- [x] Performance impact is negligible (one additional API call on modal open for edit mode)

**Additional Safeguards:**

- Edit mode validates all fields before enabling "Update Theme" button (reuse existing wizard
  validation)
- Delete confirmation dialog prevents accidental deletions
- Theme dropdown automatically refreshes after CUD operations to maintain UI consistency
- Backend authorization middleware prevents users from editing/deleting themes they don't own

## Story Dependencies

**Depends On:**

- Story 23.6: Theme system foundation (theme designer modal, theme API)

**Blocks:**

- None (independent enhancement)

## Estimation

**Complexity**: Low-Medium (4 hours focused development)

- Modal service extension: 1 hour
- Component UI changes: 1.5 hours
- Integration and testing: 1.5 hours

**Risk Level**: Low

- Follows existing patterns exactly
- Backend APIs already tested and working
- No architectural changes required

---

**Created**: 2025-10-18 **Epic**: 24 - Theme System Correction **Priority**: Medium **Type**:
Enhancement (Brownfield)
