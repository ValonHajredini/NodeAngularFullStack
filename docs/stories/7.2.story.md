# Story 7.2: App: Feature Gate + Tools Registry Client

## Status

Draft

## Story

**As a** developer, **I want** the application to conditionally render tool components based on
their enabled status, **so that** disabled tools are completely hidden from users without requiring
code changes.

## Acceptance Criteria

1. Angular ToolsService created that fetches tool status from backend API
2. Service implements client-side caching with configurable TTL (default 5 minutes)
3. Cache automatically invalidated when admin makes changes (via WebSocket or polling)
4. Custom directive \*appToolGate created for conditional rendering based on tool status
5. Guard function created for route-level tool access control
6. Service gracefully handles API failures with fallback to last known state
7. Loading states properly managed during initial fetch and updates
8. Sample implementation added to at least one existing page demonstrating usage

## Tasks / Subtasks

- [ ] Create shared types for tools (AC: 1)
  - [ ] Create packages/shared/src/types/tools.types.ts
  - [ ] Define Tool interface with all properties
  - [ ] Define ToolsResponse interface for API responses
  - [ ] Export types from packages/shared index
- [ ] Implement ToolsService (AC: 1, 2, 3, 6, 7)
  - [ ] Create apps/web/src/app/core/services/tools.service.ts
  - [ ] Implement getToolStatus(key: string) method
  - [ ] Implement isToolEnabled(key: string) method with caching
  - [ ] Add BehaviorSubject for tools state management
  - [ ] Implement cache with TTL and invalidation logic
  - [ ] Add WebSocket listener or polling for admin updates
  - [ ] Handle API failures with fallback to cached state
- [ ] Create feature gate directive (AC: 4)
  - [ ] Create apps/web/src/app/shared/directives/tool-gate.directive.ts
  - [ ] Implement structural directive with tool key input
  - [ ] Subscribe to ToolsService for reactivity
  - [ ] Handle loading and error states
  - [ ] Add proper cleanup on destroy
- [ ] Create route guard for tools (AC: 5)
  - [ ] Create apps/web/src/app/core/guards/tool.guard.ts
  - [ ] Implement canActivate with tool key parameter
  - [ ] Redirect to appropriate page when tool is disabled
  - [ ] Add loading state handling
- [ ] Implement WebSocket or polling for updates (AC: 3)
  - [ ] Add Socket.io client or implement polling mechanism
  - [ ] Listen for tool status change events
  - [ ] Update local cache on changes
  - [ ] Notify all active components of updates
- [ ] Update app initialization (AC: 7)
  - [ ] Modify app.config.ts to provide ToolsService
  - [ ] Ensure service initializes on app start
  - [ ] Add initial tools fetch before app renders
- [ ] Add sample implementation (AC: 8)
  - [ ] Choose appropriate existing page (e.g., dashboard)
  - [ ] Add conditional section using \*appToolGate directive
  - [ ] Demonstrate both directive and programmatic usage
  - [ ] Add appropriate loading states
- [ ] Create loading component for tools (AC: 7)
  - [ ] Create apps/web/src/app/shared/components/tool-loading/tool-loading.component.ts
  - [ ] Design skeleton loader for tool sections
  - [ ] Integrate with tool gate directive
- [ ] Add unit tests
  - [ ] Test ToolsService caching logic (apps/web/src/app/core/services/tools.service.spec.ts)
  - [ ] Test tool-gate directive (apps/web/src/app/shared/directives/tool-gate.directive.spec.ts)
  - [ ] Test tool guard (apps/web/src/app/core/guards/tool.guard.spec.ts)
  - [ ] Test cache invalidation scenarios
  - [ ] Test error handling and fallback behavior

## Dev Notes

### Testing Standards

[Source: architecture/testing-strategy.md#Frontend Tests]

- Test files located alongside source files with .spec.ts extension
- Use Karma/Jasmine for Angular testing
- Mock HTTP calls and WebSocket connections
- Test loading states, error states, and success paths
- Use TestBed for component and directive testing

### Frontend Architecture

[Source: architecture/frontend-architecture.md#Component Architecture]

- Core services in apps/web/src/app/core/services/
- Shared directives in apps/web/src/app/shared/directives/
- Guards in apps/web/src/app/core/guards/
- Use signals and computed for reactive state
- Follow ChangeDetectionStrategy.OnPush pattern

### State Management

[Source: architecture/frontend-architecture.md#State Management Architecture]

- Use BehaviorSubject for tools state in service
- Implement computed signals for derived state
- Cache API responses with configurable TTL
- Manage loading and error states properly

### Service Implementation Pattern

[Source: architecture/frontend-architecture.md#Component Template]

```typescript
@Injectable({ providedIn: 'root' })
export class ToolsService {
  private readonly toolsSignal = signal<Map<string, Tool>>(new Map());
  protected readonly loadingSignal = signal<boolean>(false);

  constructor() {
    // Initialize service
  }
}
```

### Directive Pattern

[Source: architecture/coding-standards.md#Documentation Standards]

- Structural directives modify DOM structure
- Use ViewContainerRef and TemplateRef
- Implement OnDestroy for cleanup
- Add comprehensive JSDoc documentation

### WebSocket/Polling Implementation

- Consider using Socket.io for real-time updates
- Alternative: Implement polling with configurable interval
- Handle reconnection logic for WebSocket
- Graceful degradation when connection fails

### Caching Strategy

- Default TTL: 5 minutes for tool status
- Store in memory (not localStorage for security)
- Invalidate on admin changes via WebSocket/polling
- Fallback to last known state on API failure

### Integration Points

[Source: architecture/tech-stack.md#Technology Stack Table]

- Use HttpClient for API calls
- RxJS for reactive programming
- Angular signals for state management
- PrimeNG components for UI where needed

### Coding Standards

[Source: architecture/coding-standards.md#Critical Fullstack Rules]

- Import types from @nodeangularfullstack/shared
- Add JSDoc comments for all public methods
- Never store sensitive data in localStorage
- Handle all error cases gracefully
- Use proper TypeScript types, avoid 'any'

### File Locations

[Source: architecture/source-tree.md#Frontend Structure]

- Core services: apps/web/src/app/core/services/
- Shared directives: apps/web/src/app/shared/directives/
- Guards: apps/web/src/app/core/guards/
- Shared components: apps/web/src/app/shared/components/
- Types: packages/shared/src/types/

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-09-26 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
