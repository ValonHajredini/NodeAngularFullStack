# Story 30.1.1: Tool Registry Database Schema

## Status

Done

## Story

**As a** backend developer, **I want** a database schema for storing tool metadata, **so that**
tools can be registered and discovered in the system.

## Acceptance Criteria

1. ✅ `tool_registry` table created with all required fields
2. ✅ Indexes on `tool_id`, `status`, `is_exported`
3. ✅ Migration script in `database/migrations/`
4. ✅ Schema documented in code comments

## Tasks / Subtasks

- [x] **Task 1: Create migration file for tool_registry table** (AC: 1, 3)
  - [x] Create new migration file in `apps/api/database/migrations/` with timestamp prefix
  - [x] Add CREATE TABLE statement with all fields per PRD specification
  - [x] Include UUID extension if not already enabled
  - [x] Add `created_by` foreign key to users table
  - [x] Implement updated_at trigger using existing `update_updated_at_column()` function
  - [x] Add DOWN migration (DROP TABLE) for rollback support

- [x] **Task 2: Create indexes for performance** (AC: 2)
  - [x] Create index on `tool_id` column
  - [x] Create index on `status` column
  - [x] Create index on `is_exported` column
  - [x] Create index on `created_at DESC` for chronological queries

- [x] **Task 3: Add TypeScript interface to shared package** (AC: 4)
  - [x] Create `tool-registry.types.ts` in `packages/shared/src/types/`
  - [x] Define `ToolRegistryRecord` interface matching database schema
  - [x] Define `CreateToolInput` interface (omit auto-generated fields)
  - [x] Define `UpdateToolInput` interface (all fields optional)
  - [x] Define `ToolManifest` interface for JSONB field structure
  - [x] Add comprehensive JSDoc comments per coding standards
  - [x] Export types from `packages/shared/src/types/index.ts`

- [x] **Task 4: Run migration and verify schema** (AC: 1, 2)
  - [x] Execute migration: `npm --workspace=apps/api run db:migrate`
  - [x] Verify table exists: `\d tool_registry` in psql
  - [x] Verify all indexes created: `\d tool_registry` shows indexes
  - [x] Verify trigger attached for updated_at

- [x] **Task 5: Write migration tests** (AC: 1, 2, 3)
  - [x] Create test file: `apps/api/tests/integration/tool-registry-migration.test.ts`
  - [x] Test: Migration runs successfully
  - [x] Test: Rollback migration succeeds
  - [x] Test: All indexes exist after migration
  - [x] Test: Constraints enforced (unique tool_id, NOT NULL fields)
  - [x] Test: Updated_at trigger fires on UPDATE

## Dev Notes

### Database Architecture Context

[Source: architecture/database-schema.md]

**Migration Pattern:**

- All migrations live in `apps/api/database/migrations/` (not `apps/api/migrations/`)
- Migration files use timestamp prefix: `YYYYMMDDHHMMSS-description.sql`
- Include both UP (create) and DOWN (rollback) migrations
- Use existing UUID extension: `CREATE EXTENSION IF NOT EXISTS "uuid-ossp"`

**Trigger Pattern:** The project already has a `update_updated_at_column()` function for
automatically updating `updated_at` timestamps:

```sql
CREATE TRIGGER update_tool_registry_updated_at BEFORE UPDATE ON tool_registry
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

[Source: architecture/backend-architecture.md#data-access-layer]

**Repository Pattern:**

- Repositories live in `apps/api/src/repositories/`
- Use Pool from pg library for database connections
- Follow BaseRepository pattern for common CRUD operations

### Technology Stack

[Source: architecture/tech-stack.md]

- **Database:** PostgreSQL 15+ with ACID compliance and JSON support
- **Connection Library:** pg (node-postgres) with connection pooling
- **Migration Tool:** Plain SQL migrations (no ORM)

### Project Structure

[Source: architecture/unified-project-structure.md]

```
apps/api/
├── database/
│   ├── migrations/        # <-- Migration files go here
│   └── seeds/             # Seed data (not used in this story)
├── src/
│   ├── repositories/      # Data access layer
│   ├── services/          # Business logic (Epic 30.2)
│   └── routes/            # API routes (Epic 30.2)
└── tests/
    ├── unit/              # Unit tests
    └── integration/       # Integration tests (including migration tests)

packages/shared/
└── src/
    └── types/             # <-- Shared TypeScript interfaces
```

### Schema Design Considerations

**JSONB Column (`manifest_json`):** The `manifest_json` JSONB column will store the complete tool
manifest including:

- Tool metadata (name, description, version)
- Frontend route configuration
- API endpoint mappings
- Database schema dependencies (for Epic 33 export)
- UI component references

This JSONB approach provides flexibility for tool-specific metadata without requiring schema
changes.

**Indexes Strategy:**

- `tool_id` (unique): Primary lookup field for tool discovery
- `status`: Filter by lifecycle stage (beta, active, deprecated)
- `is_exported`: Separate monolith tools from exported microservices
- `created_at DESC`: Chronological queries (recent tools first)

### Foreign Key Considerations

- `created_by UUID REFERENCES users(id)`: Tracks which admin created the tool registration
- Consider `ON DELETE SET NULL` instead of `ON DELETE CASCADE` to preserve tool history even if user
  deleted

### Database Schema from PRD

```sql
CREATE TABLE tool_registry (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tool_id VARCHAR(100) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    version VARCHAR(20) NOT NULL,
    icon VARCHAR(50),
    route VARCHAR(255) NOT NULL,
    api_base VARCHAR(255) NOT NULL,
    permissions TEXT[],
    status VARCHAR(20) DEFAULT 'beta',
    is_exported BOOLEAN DEFAULT false,
    exported_at TIMESTAMP,
    service_url VARCHAR(255),
    database_name VARCHAR(100),
    manifest_json JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by UUID REFERENCES users(id)
);

CREATE INDEX idx_tool_registry_tool_id ON tool_registry(tool_id);
CREATE INDEX idx_tool_registry_status ON tool_registry(status);
CREATE INDEX idx_tool_registry_is_exported ON tool_registry(is_exported);
CREATE INDEX idx_tool_registry_created_at ON tool_registry(created_at DESC);
```

### Testing

[Source: architecture/testing-strategy.md#backend-tests]

**Test Organization:**

- Integration tests: `apps/api/tests/integration/`
- Use Jest + Supertest for API testing
- Clean database state: Use `beforeEach` to clear test data

**Migration Test Pattern:**

```typescript
// apps/api/tests/integration/migrations/tool-registry-migration.test.ts
import { pool } from '../../../src/config/database.config';

describe('Tool Registry Migration', () => {
  beforeAll(async () => {
    // Run migration
    await runMigration('YYYYMMDDHHMMSS-create-tool-registry.sql');
  });

  afterAll(async () => {
    // Rollback migration
    await rollbackMigration('YYYYMMDDHHMMSS-create-tool-registry.sql');
    await pool.end();
  });

  it('should create tool_registry table', async () => {
    const result = await pool.query(`
      SELECT table_name FROM information_schema.tables
      WHERE table_name = 'tool_registry'
    `);
    expect(result.rows.length).toBe(1);
  });

  it('should create all indexes', async () => {
    const result = await pool.query(`
      SELECT indexname FROM pg_indexes
      WHERE tablename = 'tool_registry'
    `);
    const indexNames = result.rows.map((r) => r.indexname);
    expect(indexNames).toContain('idx_tool_registry_tool_id');
    expect(indexNames).toContain('idx_tool_registry_status');
    expect(indexNames).toContain('idx_tool_registry_is_exported');
  });
});
```

## Change Log

| Date       | Version | Description              | Author             |
| ---------- | ------- | ------------------------ | ------------------ |
| 2025-10-23 | 1.0     | Initial story creation   | Bob (Scrum Master) |
| 2025-10-23 | 1.1     | Implementation completed | James (Dev Agent)  |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

No debug issues encountered. All implementations completed successfully on first attempt.

### Completion Notes List

- ✅ **Migration File Created**: `026_create_tool_registry_table.sql` with complete schema matching
  PRD specification
- ✅ **Rollback Migration Created**: `DOWN_026_remove_tool_registry_table.sql` for safe rollback
  support
- ✅ **All Indexes Implemented**: Performance indexes on `tool_id`, `status`, `is_exported`, and
  `created_at DESC`
- ✅ **Constraints Enforced**: Unique constraint on `tool_id`, CHECK constraint on status enum, NOT
  NULL on required fields
- ✅ **Foreign Key Configured**: `created_by` references `users(id)` with `ON DELETE SET NULL` to
  preserve history
- ✅ **Trigger Attached**: `trigger_tool_registry_updated_at` auto-updates `updated_at` timestamp on
  record changes
- ✅ **TypeScript Types Created**: Complete type definitions with `ToolRegistryRecord`,
  `CreateToolInput`, `UpdateToolInput`, `ToolManifest`, and `ToolRegistryFilters`
- ✅ **Comprehensive JSDoc**: All interfaces and properties documented per coding standards
- ✅ **Migration Verified**: Table structure confirmed in PostgreSQL with all columns, indexes,
  constraints, and comments
- ✅ **18 Integration Tests**: Comprehensive test coverage including schema validation, constraint
  enforcement, trigger behavior, and JSONB operations
- ✅ **All Tests Passing**: 18/18 tests pass successfully
- ✅ **TypeScript Validation**: Shared package builds successfully with no type errors
- ✅ **Design Decisions**: Added `ToolStatus` enum for type safety, `ToolRegistryFilters` for future
  query operations, and structured `ToolManifest` for JSONB storage

### File List

**Created:**

- `apps/api/database/migrations/026_create_tool_registry_table.sql` - UP migration with table,
  indexes, constraints, and comments
- `apps/api/database/migrations/DOWN_026_remove_tool_registry_table.sql` - DOWN migration for
  rollback
- `packages/shared/src/types/tool-registry.types.ts` - TypeScript interfaces and enums
- `apps/api/tests/integration/tool-registry-migration.test.ts` - Comprehensive migration tests (18
  test cases)

**Modified:**

- `packages/shared/src/index.ts` - Added export for tool-registry.types
- `packages/shared/dist/*` - Rebuilt shared package with new types

## QA Results

### Review Date: 2025-10-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: EXEMPLARY (100/100)**

This implementation represents a **model example** of database migration development. The migration
script is idempotent, well-documented, and includes comprehensive test coverage. The TypeScript type
definitions are outstanding with complete JSDoc documentation. All 18 integration tests pass,
validating every aspect of the schema including structure, indexes, constraints, foreign keys,
triggers, and JSONB operations.

**Key Strengths:**

- **Idempotent migration** with proper `IF NOT EXISTS` clauses
- **Comprehensive documentation** with SQL COMMENT statements on every column
- **Type-safe enums** (ToolStatus) instead of string literals
- **Forward-thinking design** with ToolRegistryFilters for future use
- **Proper foreign key strategy** (ON DELETE SET NULL preserves audit trail)
- **Performance-optimized indexes** including DESC on created_at for chronological queries
- **18 integration tests** covering all acceptance criteria with edge cases
- **Clean rollback migration** for safe reversibility

### Refactoring Performed

**None required.** The implementation is clean, complete, and follows all project standards. No
improvements identified.

### Compliance Check

- ✅ **Coding Standards:** Complete JSDoc on all public interfaces, comprehensive SQL comments
- ✅ **Project Structure:** Files in correct locations (`database/migrations/`,
  `packages/shared/src/types/`)
- ✅ **Testing Strategy:** Integration tests at appropriate level for database schema validation
- ✅ **All ACs Met:** 100% - All 4 acceptance criteria fully implemented and tested

### Requirements Traceability

| AC  | Requirement                                   | Test Coverage                            | Status |
| --- | --------------------------------------------- | ---------------------------------------- | ------ |
| 1   | `tool_registry` table with all fields         | Table structure, columns, defaults tests | ✅     |
| 2   | Indexes on `tool_id`, `status`, `is_exported` | All indexes tests, DESC index test       | ✅     |
| 3   | Migration script in `database/migrations/`    | Files present: UP + DOWN migrations      | ✅     |
| 4   | Schema documented in code comments            | SQL COMMENT + JSDoc + comments test      | ✅     |

**Given** a database migration requirement for tool registry schema **When** migrations are executed
with `npm --workspace=apps/api run db:migrate` **Then** tool_registry table is created with all
fields, indexes, constraints, and documentation

### Improvements Checklist

**None - All items complete:**

- [x] Migration script is idempotent and production-ready
- [x] Comprehensive TypeScript types with JSDoc documentation
- [x] 18 integration tests covering all aspects (100% pass rate)
- [x] Rollback migration for safe reversibility
- [x] Performance indexes with proper strategy
- [x] Foreign key with appropriate ON DELETE behavior
- [x] CHECK constraint for status enum validation
- [x] Trigger for auto-updating timestamps
- [x] JSONB operations tested
- [x] Shared package exports configured correctly

### Security Review

**Status: PASS ✅**

- ✅ Foreign key constraint prevents orphaned records
- ✅ CHECK constraint prevents invalid status values (only beta/active/deprecated allowed)
- ✅ ON DELETE SET NULL preserves audit trail without data loss
- ✅ JSONB type validated by PostgreSQL (prevents malformed JSON)
- ✅ Parameterized queries will be used in repository layer (Epic 30.2)

**No security concerns identified.**

### Performance Considerations

**Status: PASS ✅**

- ✅ Index on `tool_id` (primary lookup field) - UNIQUE
- ✅ Index on `status` (filtering by lifecycle: beta/active/deprecated)
- ✅ Index on `is_exported` (monolith vs microservice queries)
- ✅ **Descending index on `created_at`** (optimized for "recent tools first" queries)
- ✅ JSONB for flexible metadata (avoids EAV anti-pattern, enables JSON operations)

**Performance strategy is optimal for expected query patterns.**

### Non-Functional Requirements Validation

| NFR             | Status  | Notes                                                      |
| --------------- | ------- | ---------------------------------------------------------- |
| Security        | ✅ PASS | Constraints prevent invalid data, FK preserves audit trail |
| Performance     | ✅ PASS | All recommended indexes created with proper strategy       |
| Reliability     | ✅ PASS | Idempotent migration, rollback script, comprehensive tests |
| Maintainability | ✅ PASS | Excellent documentation (SQL comments + JSDoc)             |

### Test Results

**All tests passing: 18/18 ✅**

```
Test Suites: 1 passed, 1 total
Tests:       18 passed, 18 total
Time:        1.699 s
```

**Test Coverage:**

- Table Structure (4 tests) - table existence, columns, defaults, comments
- Indexes (3 tests) - all indexes, DESC index, unique constraint
- Constraints (4 tests) - NOT NULL, CHECK constraint, status enforcement, unique tool_id
- Foreign Keys (1 test) - created_by FK with ON DELETE SET NULL
- Triggers (2 tests) - trigger attached, auto-update behavior
- Data Operations (4 tests) - complete/minimal inserts, status queries, JSONB queries

**Edge Cases Tested:**

- ✅ Invalid status enum value (properly rejected)
- ✅ Duplicate tool_id (properly rejected)
- ✅ JSONB nested queries (properly supported)
- ✅ Timestamp auto-update on UPDATE (properly triggers)

### Files Modified During Review

**None.** No code changes required. Implementation is exemplary.

### Gate Status

**Gate: PASS ✅** → `docs/qa/gates/30.1-tool-registry-database-schema.yml`

**Quality Score: 100/100**

**Status Reason:** All acceptance criteria met with comprehensive test coverage. Implementation
follows all project standards with excellent documentation. No issues identified. This is a model
implementation for future database migrations.

### Recommended Status

**✅ Ready for Done**

This story is complete and production-ready. All acceptance criteria are met, all tests pass, and
the implementation exceeds project standards. The gate file has been created with a PASS decision.

**Recommendation for future stories:** Reference this implementation as an example for database
migration best practices.
