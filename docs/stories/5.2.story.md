# Story 5.2: Settings UI for Token Management

## Status

Draft

## Story

**As a** registered user, **I want** a simple interface in my profile settings to create, view, and
revoke API tokens, **so that** I can generate secure tokens for my external applications while
managing them easily.

## Acceptance Criteria

1. Add "API Tokens" section to existing profile.component.ts with light, simple design matching
   current theme
2. Implement token generation form with fields: token name and simple scope selection (read/write)
3. Display existing tokens in a clean list showing: name, created date, last used date, and revoke
   button
4. Existing profile functionality (user info editing, password change) continues to work unchanged
5. New token section follows existing profile.component.ts form patterns and validation
6. Integration with existing AuthService maintains current user context and error handling
7. Token UI components covered by Angular component tests
8. Form validation follows existing pattern in profile component
9. No regression in existing profile functionality verified through existing tests

## Tasks / Subtasks

- [ ] Create API token service for frontend (AC: 6)
  - [ ] Create TokenService in `apps/web/src/app/core/services/`
  - [ ] Implement token CRUD operations using ApiClient pattern
  - [ ] Follow existing service patterns from AuthService and UsersService
  - [ ] Add proper error handling and response typing

- [ ] Add API token types to shared package (AC: 1, 2, 3)
  - [ ] Create token interfaces in `packages/shared/src/types/`
  - [ ] Define CreateTokenRequest, TokenResponse, and TokenListItem interfaces
  - [ ] Export from shared package index

- [ ] Extend profile component with API tokens section (AC: 1, 4, 5)
  - [ ] Add API tokens section to existing profile.component.ts template
  - [ ] Create token generation form using reactive forms pattern
  - [ ] Add token list display component within profile template
  - [ ] Ensure existing profile functionality remains unchanged
  - [ ] Follow existing Tailwind CSS classes and theme patterns

- [ ] Implement token creation form (AC: 2, 5, 8)
  - [ ] Add reactive form for token name and scope selection
  - [ ] Implement form validation following existing profile patterns
  - [ ] Add proper error handling and success feedback
  - [ ] Use existing PrimeNG components matching current design

- [ ] Implement token list display (AC: 3)
  - [ ] Create token list component showing name, dates, and actions
  - [ ] Add revoke token functionality with confirmation dialog
  - [ ] Implement proper loading states and error handling
  - [ ] Use existing PrimeNG Table or custom list matching current design

- [ ] Add component tests for token functionality (AC: 7, 9)
  - [ ] Test token generation form in profile component tests
  - [ ] Test token list display and revoke functionality
  - [ ] Test integration with TokenService
  - [ ] Verify existing profile functionality regression tests pass

## Dev Notes

### Previous Story Insights

Story 5.1 (API Token Backend Infrastructure) provides the backend endpoints and authentication
integration that this story will consume. The backend API provides `/api/v1/tokens` endpoints for
CRUD operations and extends AuthMiddleware for API token validation.

### Data Models

**Frontend Token Interfaces** [Source: architecture/data-models.md, story 5.1]:

```typescript
// Shared interfaces for frontend consumption
interface CreateTokenRequest {
  name: string;
  scopes: string[]; // ['read', 'write']
}

interface TokenResponse {
  id: string;
  token: string; // Only returned on creation
  name: string;
  scopes: string[];
  expiresAt: string;
  createdAt: string;
}

interface TokenListItem {
  id: string;
  name: string;
  scopes: string[];
  expiresAt: string;
  createdAt: string;
  lastUsedAt?: string;
  isActive: boolean;
}
```

**Component State Management** [Source:
architecture/frontend-architecture.md#state-management-patterns]:

- Use Angular signals for reactive token state management
- Implement computed signals for derived token list state
- Use signal-based forms for token creation form management

### API Specifications

**Token Service Integration** [Source: architecture/frontend-architecture.md#service-example, story
5.1]:

```typescript
// Token service methods consuming backend API
createToken(request: CreateTokenRequest): Observable<TokenResponse>
getTokens(): Observable<TokenListItem[]>
revokeToken(tokenId: string): Observable<{ success: boolean }>
```

**HTTP Endpoints** [From story 5.1]:

- `POST /api/v1/tokens` - Create new API token
- `GET /api/v1/tokens` - List user's API tokens
- `DELETE /api/v1/tokens/:id` - Revoke API token

### Component Specifications

**Profile Component Integration** [Source:
architecture/frontend-architecture.md#component-template]:

- Extend existing ProfileComponent without breaking current functionality
- Add new section using existing component structure and styling
- Use standalone component pattern with proper imports
- Follow ChangeDetectionStrategy.OnPush for performance

**Form Implementation** [Source: architecture/frontend-architecture.md, components.md]:

- Use Angular reactive forms following existing profile form patterns
- Implement proper form validation with custom validators
- Use existing error handling and display patterns from profile component
- Include loading states and success/error feedback

**UI Component Library** [Source: architecture/tech-stack.md#technology-stack-table]:

- Use PrimeNG 17+ components matching existing profile design
- Follow Tailwind CSS 3.4+ utility classes for styling
- Maintain consistent theme with existing profile sections
- Use existing dialog/confirmation patterns for token revocation

### File Locations

**Frontend Service Layer** [Source: architecture/unified-project-structure.md]:

- Service: `apps/web/src/app/core/services/token.service.ts`
- Types: `packages/shared/src/types/token.interface.ts`

**Component Files** [Source: architecture/unified-project-structure.md]:

- Main component: Extend existing `apps/web/src/app/features/profile/profile.component.ts`
- Component template: Update existing `apps/web/src/app/features/profile/profile.component.html`
- Component styles: Update existing `apps/web/src/app/features/profile/profile.component.scss`

### Testing Requirements

**Test File Locations** [Source: architecture/testing-strategy.md#frontend-tests]:

- Component tests: `apps/web/src/app/features/profile/profile.component.spec.ts` (extend existing)
- Service tests: `apps/web/src/app/core/services/token.service.spec.ts`

**Testing Standards** [Source: architecture/testing-strategy.md#frontend-component-test]:

- Use Angular testing utilities with TestBed
- Mock TokenService using jasmine.createSpyObj
- Test component initialization, form submission, and token operations
- Use fixture.detectChanges() for change detection testing
- Follow existing profile component test patterns

**Testing Frameworks and Patterns** [Source: architecture/testing-strategy.md]:

- Jest + Testing Library for Angular component testing
- Use component fixture testing for form interactions
- Mock HTTP requests using jasmine spies
- Test both success and error scenarios for all token operations
- Ensure existing profile component tests continue to pass

### Technical Constraints

**Integration with Existing Profile** [Source: epic 5 story 5.2 context]:

- Must not modify existing profile functionality (user info editing, password change)
- New token section should be additive to existing ProfileComponent
- Follow existing form validation patterns and error handling
- Maintain current user context and authentication state

**UI/UX Consistency** [Source: architecture/tech-stack.md, components.md]:

- Use existing Tailwind CSS classes and theme variables
- Match existing PrimeNG component styling and layout patterns
- Follow current form field styling and validation display
- Maintain consistent spacing and typography with existing profile sections

**Service Integration** [Source: architecture/frontend-architecture.md#frontend-services-layer]:

- Use existing ApiClient for HTTP requests to backend
- Follow existing AuthService patterns for authentication context
- Implement proper error handling matching existing service error patterns
- Use existing HTTP interceptors for automatic token injection

**Angular 20+ Patterns** [Source: architecture/tech-stack.md, frontend-architecture.md]:

- Use standalone components with proper imports
- Implement signal-based state management for reactive UI updates
- Use computed signals for derived token list state
- Follow ChangeDetectionStrategy.OnPush for performance optimization

### Testing

**Test File Location**:

- Component tests: Extend existing `apps/web/src/app/features/profile/profile.component.spec.ts`
- Service tests: `apps/web/src/app/core/services/token.service.spec.ts` [Source:
  architecture/testing-strategy.md#frontend-tests]

**Test Standards**: All token UI functionality must follow existing Angular testing patterns with
comprehensive component and service test coverage [Source:
architecture/testing-strategy.md#frontend-component-test]

**Testing Frameworks and Patterns**:

- Angular testing: TestBed + Jasmine for component and service testing [Source:
  architecture/testing-strategy.md#frontend-component-test]
- Component testing: Use fixture.detectChanges() and component.property assertions
- Service testing: Mock HTTP calls with jasmine spies and return observables
- Form testing: Test form validation, submission, and error states
- Integration testing: Verify token operations integrate properly with backend endpoints

## Change Log

| Date       | Version | Description                                                           | Author             |
| ---------- | ------- | --------------------------------------------------------------------- | ------------------ |
| 2025-09-25 | 1.0     | Initial story creation with frontend token management UI requirements | Bob (Scrum Master) |

## Dev Agent Record

_This section will be populated by the development agent during implementation_

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes List

_To be filled by dev agent_

### File List

_To be filled by dev agent_

## QA Results

_Results from QA Agent review will be added here after story implementation_
