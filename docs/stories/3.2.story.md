# Story 3.2: Environment Configuration System

## Status
Draft

## Story
**As a** developer,
**I want** environment variable controls for multi-tenancy features,
**so that** I can deploy the same codebase in different operational modes.

## Acceptance Criteria
1. Environment variables control multi-tenancy enable/disable with clear documentation
2. Configuration validation ensures consistent settings across all application components
3. Default configuration supports single-tenant mode for simplest deployment scenario
4. Multi-tenant configuration includes tenant isolation and data security settings
5. Configuration changes require application restart with clear warning messages

## Tasks / Subtasks
- [ ] Task 1: Create comprehensive environment configuration schema (AC: 1)
  - [ ] Define ENABLE_MULTI_TENANCY boolean flag with default false
  - [ ] Add TENANT_ISOLATION_LEVEL enum (row, schema, database)
  - [ ] Create TENANT_DEFAULT_PLAN configuration
  - [ ] Add TENANT_MAX_USERS_DEFAULT setting
  - [ ] Define TENANT_FEATURES_DEFAULT JSON configuration
- [ ] Task 2: Implement configuration validation system (AC: 2)
  - [ ] Create environment variable schema validation using Joi
  - [ ] Add startup configuration validation with detailed error messages
  - [ ] Implement configuration consistency checks across services
  - [ ] Create configuration validation middleware for API routes
  - [ ] Add configuration drift detection and warnings
- [ ] Task 3: Set up single-tenant mode as default (AC: 3)
  - [ ] Configure default .env.example with single-tenant settings
  - [ ] Create development environment with single-tenant configuration
  - [ ] Add clear documentation for single-tenant deployment
  - [ ] Implement graceful fallback when multi-tenancy is disabled
  - [ ] Create single-tenant optimization flags
- [ ] Task 4: Configure multi-tenant security and isolation settings (AC: 4)
  - [ ] Add TENANT_RLS_ENABLED flag for Row-Level Security
  - [ ] Create TENANT_CROSS_ACCESS_PREVENTION setting
  - [ ] Add TENANT_AUDIT_LOGGING configuration
  - [ ] Implement TENANT_TOKEN_ISOLATION setting
  - [ ] Create TENANT_DATA_ENCRYPTION configuration options
- [ ] Task 5: Add configuration change management (AC: 5)
  - [ ] Create configuration hash validation on startup
  - [ ] Add configuration change detection with restart warnings
  - [ ] Implement configuration reload prevention with clear messages
  - [ ] Create configuration backup and restore utilities
  - [ ] Add configuration change logging and audit trail
- [ ] Task 6: Create configuration documentation and examples (AC: 1, 3, 4)
  - [ ] Document all multi-tenancy environment variables
  - [ ] Create deployment configuration examples
  - [ ] Add troubleshooting guide for configuration issues
  - [ ] Create configuration migration guide
  - [ ] Add security configuration best practices

## Dev Notes

### Previous Story Insights
[Source: Story 3.1 completion notes (anticipated)]
- Enhanced tenant table with configuration and isolation settings
- Tenant-aware repository pattern with automatic filtering
- Row-Level Security policies for database-level tenant isolation
- Migration scripts for tenant mode conversion

### Technology Stack for Configuration Management
[Source: architecture/tech-stack.md]
- **Backend Framework**: Express.js 4.19+ for configuration middleware
- **Validation**: Joi for environment variable schema validation
- **Environment Management**: dotenv for environment variable loading
- **Configuration**: Custom configuration service with validation
- **Documentation**: Environment variable documentation in README

### Project Structure for Configuration
[Source: architecture/unified-project-structure.md]
**Configuration Files:**
- Environment templates: `.env.example`, `.env.development`, `.env.production`
- Configuration services: `apps/api/src/config/`
- Validation schemas: `apps/api/src/validators/config.validators.ts`
- Middleware: `apps/api/src/middleware/config.middleware.ts`

**Key File Paths:**
- `apps/api/src/config/app.config.ts` - Main application configuration
- `apps/api/src/config/tenant.config.ts` - Multi-tenancy specific configuration
- `apps/api/src/validators/config.validators.ts` - Configuration validation schemas
- `apps/api/src/middleware/config.middleware.ts` - Configuration validation middleware
- `.env.example` - Updated with multi-tenancy variables

### Environment Configuration Schema
**Multi-Tenancy Environment Variables:**
```bash
# Multi-Tenancy Configuration
ENABLE_MULTI_TENANCY=false                    # Enable/disable multi-tenancy
TENANT_ISOLATION_LEVEL=row                    # row, schema, database
TENANT_RLS_ENABLED=true                       # Enable Row-Level Security
TENANT_CROSS_ACCESS_PREVENTION=true          # Prevent cross-tenant access
TENANT_AUDIT_LOGGING=true                    # Enable tenant audit logging
TENANT_TOKEN_ISOLATION=true                  # Include tenant in JWT tokens

# Tenant Defaults
TENANT_DEFAULT_PLAN=free                     # free, starter, professional, enterprise
TENANT_MAX_USERS_DEFAULT=5                   # Default user limit per tenant
TENANT_FEATURES_DEFAULT={}                   # JSON object of default features

# Security Settings
TENANT_DATA_ENCRYPTION=false                 # Enable tenant data encryption
TENANT_REQUIRE_VERIFICATION=true            # Require tenant email verification
```

### Configuration Validation Implementation
[Source: architecture/backend-architecture.md]
**Configuration Service Pattern:**
```typescript
// config/tenant.config.ts
import Joi from 'joi';

const tenantConfigSchema = Joi.object({
  ENABLE_MULTI_TENANCY: Joi.boolean().default(false),
  TENANT_ISOLATION_LEVEL: Joi.string()
    .valid('row', 'schema', 'database')
    .default('row'),
  TENANT_RLS_ENABLED: Joi.boolean().default(true),
  TENANT_CROSS_ACCESS_PREVENTION: Joi.boolean().default(true),
  TENANT_AUDIT_LOGGING: Joi.boolean().default(true),
  TENANT_TOKEN_ISOLATION: Joi.boolean().default(true),
  TENANT_DEFAULT_PLAN: Joi.string()
    .valid('free', 'starter', 'professional', 'enterprise')
    .default('free'),
  TENANT_MAX_USERS_DEFAULT: Joi.number().integer().min(1).default(5),
  TENANT_FEATURES_DEFAULT: Joi.object().default({}),
  TENANT_DATA_ENCRYPTION: Joi.boolean().default(false),
  TENANT_REQUIRE_VERIFICATION: Joi.boolean().default(true)
});

export interface TenantConfig {
  multiTenancyEnabled: boolean;
  isolationLevel: 'row' | 'schema' | 'database';
  rlsEnabled: boolean;
  crossAccessPrevention: boolean;
  auditLogging: boolean;
  tokenIsolation: boolean;
  defaultPlan: 'free' | 'starter' | 'professional' | 'enterprise';
  maxUsersDefault: number;
  featuresDefault: Record<string, boolean>;
  dataEncryption: boolean;
  requireVerification: boolean;
}

export const validateTenantConfig = (): TenantConfig => {
  const { error, value } = tenantConfigSchema.validate(process.env);

  if (error) {
    throw new Error(`Tenant configuration validation failed: ${error.message}`);
  }

  return {
    multiTenancyEnabled: value.ENABLE_MULTI_TENANCY,
    isolationLevel: value.TENANT_ISOLATION_LEVEL,
    rlsEnabled: value.TENANT_RLS_ENABLED,
    crossAccessPrevention: value.TENANT_CROSS_ACCESS_PREVENTION,
    auditLogging: value.TENANT_AUDIT_LOGGING,
    tokenIsolation: value.TENANT_TOKEN_ISOLATION,
    defaultPlan: value.TENANT_DEFAULT_PLAN,
    maxUsersDefault: value.TENANT_MAX_USERS_DEFAULT,
    featuresDefault: JSON.parse(value.TENANT_FEATURES_DEFAULT || '{}'),
    dataEncryption: value.TENANT_DATA_ENCRYPTION,
    requireVerification: value.TENANT_REQUIRE_VERIFICATION
  };
};
```

### Configuration Middleware Implementation
**Configuration Validation Middleware:**
```typescript
// middleware/config.middleware.ts
import { Request, Response, NextFunction } from 'express';
import { tenantConfig } from '../config/tenant.config';
import { ApiError } from '../utils/api-error';

export const validateTenantConfiguration = (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  // Check for configuration consistency
  if (tenantConfig.multiTenancyEnabled && !tenantConfig.rlsEnabled) {
    console.warn('WARNING: Multi-tenancy enabled without RLS. This may compromise data isolation.');
  }

  if (tenantConfig.tokenIsolation && !tenantConfig.multiTenancyEnabled) {
    throw new ApiError(500, 'Invalid configuration: Token isolation requires multi-tenancy to be enabled');
  }

  next();
};

export const requireMultiTenancy = (
  req: Request,
  res: Response,
  next: NextFunction
) => {
  if (!tenantConfig.multiTenancyEnabled) {
    throw new ApiError(404, 'Multi-tenancy features are not enabled');
  }

  next();
};
```

### Single-Tenant Mode Configuration
**Default Single-Tenant Settings:**
```bash
# .env.example - Single-tenant mode (default)
ENABLE_MULTI_TENANCY=false
TENANT_ISOLATION_LEVEL=row
TENANT_RLS_ENABLED=false
TENANT_CROSS_ACCESS_PREVENTION=false
TENANT_AUDIT_LOGGING=false
TENANT_TOKEN_ISOLATION=false
```

### Configuration Change Management
**Configuration Hash Validation:**
```typescript
// utils/config.utils.ts
import crypto from 'crypto';

export const generateConfigHash = (): string => {
  const configString = JSON.stringify({
    multiTenancy: process.env.ENABLE_MULTI_TENANCY,
    isolation: process.env.TENANT_ISOLATION_LEVEL,
    rls: process.env.TENANT_RLS_ENABLED,
    // ... other config vars
  });

  return crypto.createHash('sha256').update(configString).digest('hex');
};

export const validateConfigurationConsistency = (): void => {
  const currentHash = generateConfigHash();
  const storedHash = process.env.CONFIG_HASH;

  if (storedHash && currentHash !== storedHash) {
    console.warn('⚠️  Configuration change detected. Application restart required for changes to take effect.');
  }
};
```

### Documentation and Examples
**Environment Variable Documentation:**
- Complete variable reference with descriptions
- Deployment scenario examples (single-tenant, multi-tenant)
- Security configuration guidelines
- Performance optimization settings
- Troubleshooting common configuration issues

## Testing

### Test File Locations
[Source: architecture/testing-strategy.md]
- **Unit Tests**: `apps/api/tests/unit/config/`
- **Integration Tests**: `apps/api/tests/integration/config/`
- **Configuration Tests**: `apps/api/tests/config/`

### Testing Requirements
- Environment variable validation testing
- Configuration consistency verification
- Single-tenant mode validation
- Multi-tenant configuration testing
- Configuration change detection testing
- Invalid configuration error handling
- Configuration middleware functionality

### Test Examples Pattern
```typescript
// Configuration validation testing
describe('Tenant Configuration', () => {
  it('should validate multi-tenancy configuration', () => {
    process.env.ENABLE_MULTI_TENANCY = 'true';
    process.env.TENANT_ISOLATION_LEVEL = 'row';

    const config = validateTenantConfig();

    expect(config.multiTenancyEnabled).toBe(true);
    expect(config.isolationLevel).toBe('row');
  });

  it('should reject invalid isolation level', () => {
    process.env.TENANT_ISOLATION_LEVEL = 'invalid';

    expect(() => validateTenantConfig()).toThrow();
  });

  it('should warn about inconsistent security settings', () => {
    const consoleSpy = jest.spyOn(console, 'warn');
    process.env.ENABLE_MULTI_TENANCY = 'true';
    process.env.TENANT_RLS_ENABLED = 'false';

    validateTenantConfiguration(req, res, next);

    expect(consoleSpy).toHaveBeenCalledWith(
      expect.stringContaining('Multi-tenancy enabled without RLS')
    );
  });
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-21 | 1.0 | Initial story creation for environment configuration system | Bob (Scrum Master) |