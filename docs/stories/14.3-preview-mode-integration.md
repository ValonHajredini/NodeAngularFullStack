# Story 14.3: Preview Mode Integration & Polish - Brownfield Enhancement

**Epic:** Multi-Field Column Support & Public Form Rendering **Story ID:**
`story-preview-mode-integration` **Priority:** High **Estimated Effort:** 1-2 days **Dependencies:**
Story 14.1 (Multi-Field Column Support), Story 14.2 (Public Form Rendering)

---

## User Story

**As a** form builder user, **I want** to preview exactly how my form will appear to visitors before
publishing, **So that** I can verify the layout, field arrangement, and styling match my design
intent and make adjustments before sharing the form publicly.

---

## Story Context

### Existing System Integration:

- **Integrates with:**
  - FormBuilderComponent
    ([form-builder.component.ts](../../apps/web/src/app/features/tools/components/form-builder/form-builder.component.ts)) -
    Main builder container
  - FormRendererComponent
    ([form-renderer.component.ts](../../apps/web/src/app/features/public/form-renderer/form-renderer.component.ts)) -
    Public form rendering (Story 14.2)
  - FormBuilderService
    ([form-builder.service.ts](../../apps/web/src/app/features/tools/components/form-builder/form-builder.service.ts)) -
    State management
  - PrimeNG Dialog component - Modal/dialog for preview
  - Shared types
    ([packages/shared/src/types/forms.types.ts](../../packages/shared/src/types/forms.types.ts)) -
    FormSchema, FormSettings
- **Technology:** Angular 20+ standalone components, signals, PrimeNG Dialog, reactive state
- **Follows pattern:**
  - FormBuilderComponent toolbar actions (publish button, settings button)
  - PrimeNG Dialog modal pattern (settings dialog, field properties modal)
  - FormBuilderService schema export (`exportFormData()` method)
  - FormRendererComponent embedding in preview mode
- **Touch points:**
  - FormBuilderComponent template - Add preview button to toolbar
  - FormBuilderComponent class - Add preview dialog state management
  - Create PreviewDialogComponent - Wrapper for FormRendererComponent in preview mode
  - FormRendererComponent - Support preview mode (in-memory schema, no submission)

---

## Current State Analysis

### FormBuilderComponent Current Behavior:

**Current Toolbar (No Preview Button):**

```html
<!-- FormBuilderComponent toolbar (CURRENT) -->
<div class="toolbar">
  <button (click)="openSettings()">Settings</button>
  <button (click)="saveForm()">Save</button>
  <button (click)="publishForm()" [disabled]="!canPublish()">Publish</button>
</div>
```

**Current Workflow:**

1. User builds form with row layout and fields
2. User clicks "Publish" ‚Üí form saved and short link created
3. User navigates to `/public/form/:shortCode` to see published form
4. **Problem:** No way to preview form before publishing
5. **User pain point:** User must publish ‚Üí view ‚Üí unpublish ‚Üí edit ‚Üí republish to iterate on design

**Desired Workflow (Story 14.3):**

1. User builds form with row layout and fields
2. User clicks "Preview" ‚Üí modal opens showing exact public form rendering
3. User sees form with row-column layout, field styling, responsive behavior
4. Preview reflects **unsaved changes** (in-memory schema, not database)
5. User closes preview ‚Üí returns to builder
6. User makes adjustments ‚Üí clicks preview again ‚Üí sees updated design
7. User satisfied with preview ‚Üí clicks "Publish"

---

## Desired State (Story 14.3)

### Enhanced FormBuilderComponent Toolbar:

```html
<!-- FormBuilderComponent toolbar (NEW) -->
<div class="toolbar">
  <button (click)="openSettings()">Settings</button>
  <button (click)="openPreview()">Preview</button>
  <button (click)="saveForm()">Save</button>
  <button (click)="publishForm()" [disabled]="!canPublish()">Publish</button>
</div>
```

### New PreviewDialogComponent:

**Component Purpose:**

- Wrapper component that embeds FormRendererComponent in preview mode
- Displays "Preview Mode" badge/header
- Passes in-memory schema (unsaved changes) to FormRendererComponent
- Prevents form submission (preview mode flag)
- Provides "Close" button to return to builder

**Template:**

```html
<p-dialog
  [(visible)]="visible"
  [modal]="true"
  [closable]="true"
  [dismissableMask]="true"
  [style]="{ width: '90vw', maxWidth: '1200px', height: '90vh' }"
  header="Form Preview"
  (onHide)="onClose.emit()"
>
  <!-- Preview mode indicator -->
  <div class="preview-header">
    <span class="preview-badge">
      <i class="pi pi-eye"></i>
      Preview Mode
    </span>
    <p class="preview-hint">
      This is how your form will appear to visitors. Unsaved changes are included.
    </p>
  </div>

  <!-- Embedded FormRendererComponent in preview mode -->
  <div class="preview-content">
    <app-form-renderer [formSchema]="formSchema" [previewMode]="true" />
  </div>

  <!-- Footer actions -->
  <ng-template pTemplate="footer">
    <button pButton label="Close Preview" (click)="onClose.emit()"></button>
  </ng-template>
</p-dialog>
```

**Component Class:**

```typescript
import { Component, Input, Output, EventEmitter } from '@angular/core';
import { CommonModule } from '@angular/common';
import { DialogModule } from 'primeng/dialog';
import { ButtonModule } from 'primeng/button';
import { FormSchema } from '@nodeangularfullstack/shared';
import { FormRendererComponent } from '../../../public/form-renderer/form-renderer.component';

@Component({
  selector: 'app-preview-dialog',
  standalone: true,
  imports: [CommonModule, DialogModule, ButtonModule, FormRendererComponent],
  templateUrl: './preview-dialog.component.html',
  styleUrls: ['./preview-dialog.component.scss'],
})
export class PreviewDialogComponent {
  @Input() visible = false;
  @Input() formSchema: FormSchema | null = null;
  @Output() onClose = new EventEmitter<void>();
}
```

### Enhanced FormBuilderComponent:

```typescript
export class FormBuilderComponent {
  // ... existing properties

  // Preview state
  readonly previewVisible = signal<boolean>(false);
  readonly previewSchema = signal<FormSchema | null>(null);

  /**
   * Open preview dialog with current form schema (includes unsaved changes)
   */
  openPreview(): void {
    // Export current form data (in-memory, not saved)
    const schema = this.exportFormData();
    this.previewSchema.set(schema);
    this.previewVisible.set(true);
  }

  /**
   * Close preview dialog
   */
  closePreview(): void {
    this.previewVisible.set(false);
    this.previewSchema.set(null);
  }

  /**
   * Export form data (existing method, used for save and preview)
   */
  private exportFormData(): FormSchema {
    return {
      id: this.currentFormId() || undefined,
      title: this.formTitle(),
      description: this.formDescription(),
      fields: this.formBuilderService.formFields().map((field) => ({
        ...field,
        position: field.position
          ? {
              rowId: field.position.rowId,
              columnIndex: field.position.columnIndex,
              orderInColumn: field.position.orderInColumn ?? 0,
            }
          : undefined,
      })),
      settings: {
        columnLayout: this.formBuilderService.columnLayout(),
        submitButtonText: this.formBuilderService.submitButtonText(),
        successMessage: this.formBuilderService.successMessage(),
        rowLayout: this.formBuilderService.rowLayoutEnabled()
          ? {
              enabled: true,
              rows: this.formBuilderService.rowConfigs().map((row) => ({
                rowId: row.rowId,
                columnCount: row.columnCount,
                order: row.order,
              })),
            }
          : undefined,
      },
    };
  }
}
```

### Enhanced FormRendererComponent (Preview Mode Support):

```typescript
export class FormRendererComponent {
  // ... existing properties

  /**
   * Input: FormSchema for preview mode (bypasses API fetch)
   */
  @Input() formSchema: FormSchema | null = null;

  /**
   * Input: Preview mode flag (disables submission)
   */
  @Input() previewMode = false;

  ngOnInit() {
    // If in preview mode, use provided schema (skip API fetch)
    if (this.previewMode && this.formSchema) {
      this.formSchemaSignal.set(this.formSchema);
      this.buildFormGroup(this.formSchema);
      this.isLoading.set(false);
      return;
    }

    // Otherwise, load from API (published form mode)
    const shortCode = this.route.snapshot.paramMap.get('shortCode');
    if (!shortCode) {
      this.error.set('Invalid form link');
      this.isLoading.set(false);
      return;
    }

    this.loadFormSchema(shortCode);
  }

  /**
   * Handle form submission
   */
  onSubmit(): void {
    // Prevent submission in preview mode
    if (this.previewMode) {
      console.log('Form submission disabled in preview mode');
      return;
    }

    // ... existing submission logic
  }
}
```

**Key Changes:**

- Add "Preview" button to FormBuilderComponent toolbar
- Create PreviewDialogComponent wrapper with PrimeNG Dialog
- Pass in-memory schema to FormRendererComponent (unsaved changes included)
- FormRendererComponent supports preview mode (input schema, disable submission)
- Preview modal shows "Preview Mode" badge and helpful hint text
- Close preview returns to builder without navigating away

---

## Acceptance Criteria

### Functional Requirements:

#### 1. **Preview Button in Toolbar**

- [ ] Add "Preview" button to FormBuilderComponent toolbar
- [ ] Button positioned between "Settings" and "Save" buttons (visual consistency)
- [ ] Button enabled at all times (even if form not saved)
- [ ] Button click opens preview dialog with current form schema
- [ ] Button icon: Eye icon (`pi pi-eye`) for visual clarity
- [ ] Button label: "Preview" or "Preview Form"

#### 2. **Preview Dialog Component**

- [ ] PreviewDialogComponent created as standalone Angular component
- [ ] Uses PrimeNG Dialog component for modal behavior
- [ ] Dialog width: 90vw, max-width: 1200px (large viewport for desktop preview)
- [ ] Dialog height: 90vh (full-height preview)
- [ ] Dialog header: "Form Preview" with close button (X)
- [ ] Dialog is modal (blocks interaction with builder behind)
- [ ] Dialog is dismissable via mask click or ESC key
- [ ] Dialog embeds FormRendererComponent in preview mode

#### 3. **Preview Mode Indicator**

- [ ] "Preview Mode" badge displayed at top of preview dialog
- [ ] Badge styling: Blue background, white text, eye icon
- [ ] Badge text: "Preview Mode" or "üëÅÔ∏è Preview Mode"
- [ ] Helpful hint text below badge:
  - "This is how your form will appear to visitors. Unsaved changes are included."
  - Or: "Preview reflects current design, including unsaved changes."
- [ ] Visual distinction: Badge stands out from form content (border, shadow, margin)

#### 4. **Preview Schema Generation**

- [ ] FormBuilderComponent exports current schema on preview button click
- [ ] Schema includes all fields with current positions (`rowId`, `columnIndex`, `orderInColumn`)
- [ ] Schema includes row layout configuration (if enabled)
- [ ] Schema includes form settings (title, description, submit button text, success message)
- [ ] Schema includes **unsaved changes** (in-memory state, not database)
- [ ] Schema matches format used for saving/publishing forms (consistent structure)

#### 5. **FormRendererComponent Preview Mode**

- [ ] FormRendererComponent accepts `@Input() formSchema: FormSchema | null`
- [ ] FormRendererComponent accepts `@Input() previewMode: boolean` flag
- [ ] When `previewMode === true`:
  - Use provided `formSchema` input (skip API fetch)
  - Build form group from schema
  - Render form with row-column layout (if enabled)
  - Disable form submission (prevent POST to backend)
  - Show visual indicator: "Preview Mode" in submit button or disable submit button
- [ ] When `previewMode === false`:
  - Load schema from API via shortCode (existing behavior)
  - Enable form submission (published form mode)

#### 6. **Preview Rendering Accuracy**

- [ ] Preview renders **exact same layout** as published form (pixel-perfect match)
- [ ] Preview uses FormRendererComponent (Story 14.2) for rendering
- [ ] Preview shows row-column layout if row layout enabled
- [ ] Preview shows global column layout if row layout disabled
- [ ] Preview includes all fields in correct positions with correct `orderInColumn`
- [ ] Preview includes all field styling (labels, placeholders, help text, validation)
- [ ] Preview responsive behavior: columns stack on mobile viewport (if dialog resized)

#### 7. **Unsaved Changes Reflection**

- [ ] Preview reflects current builder state (in-memory), not saved state
- [ ] Scenario 1: User adds field ‚Üí clicks preview ‚Üí preview shows new field
- [ ] Scenario 2: User reorders fields in column ‚Üí clicks preview ‚Üí preview shows new order
- [ ] Scenario 3: User changes row column count ‚Üí clicks preview ‚Üí preview shows new column count
- [ ] Scenario 4: User edits field label ‚Üí clicks preview ‚Üí preview shows new label
- [ ] Scenario 5: User toggles row layout off ‚Üí clicks preview ‚Üí preview shows global layout

#### 8. **Preview Interactions**

- [ ] Preview form is interactive: fields can receive input (text, select, checkbox, etc.)
- [ ] Preview form validation works: required fields show errors if empty
- [ ] Preview submit button disabled or shows "Preview Mode" text (no actual submission)
- [ ] Clicking submit button in preview mode does nothing (or shows "Preview Mode" toast)
- [ ] Preview form scrolls if content overflows dialog height

#### 9. **Close Preview Behavior**

- [ ] Close button in dialog header (X) closes preview and returns to builder
- [ ] Close button in dialog footer ("Close Preview") closes preview
- [ ] Clicking dialog mask (outside dialog) closes preview
- [ ] Pressing ESC key closes preview
- [ ] Closing preview does not navigate away from builder (stays on same route)
- [ ] Closing preview does not trigger save (preview is read-only)

### Integration Requirements:

#### 10. **FormBuilderComponent Integration**

- [ ] FormBuilderComponent imports PreviewDialogComponent
- [ ] FormBuilderComponent manages preview dialog visibility state (`previewVisible` signal)
- [ ] FormBuilderComponent exports schema on preview open (`exportFormData()` method)
- [ ] FormBuilderComponent passes schema to PreviewDialogComponent via input binding
- [ ] FormBuilderComponent listens to dialog close event (`onClose` output)

#### 11. **FormRendererComponent Integration**

- [ ] FormRendererComponent supports both published mode and preview mode
- [ ] Published mode: Load schema from API (existing behavior)
- [ ] Preview mode: Use provided schema input (new behavior)
- [ ] FormRendererComponent conditionally disables submission in preview mode
- [ ] FormRendererComponent rendering logic unchanged (Story 14.2 implementation)

#### 12. **Existing Functionality Preserved**

- [ ] Save workflow unchanged (save button saves form to database)
- [ ] Publish workflow unchanged (publish button creates short link)
- [ ] Settings dialog unchanged (settings button opens settings modal)
- [ ] Field properties modal unchanged (click field opens properties)
- [ ] Preview does not interfere with builder state (builder remains editable)

### Quality Requirements:

#### 13. **Unit Tests**

**FormBuilderComponent tests:**

- [ ] `openPreview()` sets `previewVisible` to true
- [ ] `openPreview()` exports current schema to `previewSchema`
- [ ] `closePreview()` sets `previewVisible` to false
- [ ] `closePreview()` clears `previewSchema` (sets to null)
- [ ] Exported schema includes all fields with correct positions
- [ ] Exported schema includes row layout configuration (if enabled)

**PreviewDialogComponent tests:**

- [ ] Component renders PrimeNG Dialog when `visible === true`
- [ ] Component hides dialog when `visible === false`
- [ ] Component emits `onClose` event when close button clicked
- [ ] Component emits `onClose` event when mask clicked
- [ ] Component passes `formSchema` to FormRendererComponent via input
- [ ] Component passes `previewMode === true` to FormRendererComponent

**FormRendererComponent tests:**

- [ ] Component uses provided schema when `previewMode === true`
- [ ] Component skips API fetch when `previewMode === true`
- [ ] Component loads schema from API when `previewMode === false`
- [ ] `onSubmit()` does nothing when `previewMode === true`
- [ ] `onSubmit()` submits form when `previewMode === false`

#### 14. **E2E Tests**

**Test 1: Preview button opens modal with correct layout**

- [ ] Create form with row layout (2 rows: 2 columns, 3 columns)
- [ ] Add 3 fields to row 1, column 0
- [ ] Add 2 fields to row 1, column 1
- [ ] Click "Preview" button
- [ ] Verify: Preview dialog opens
- [ ] Verify: Preview shows 2 rows with correct column counts
- [ ] Verify: Fields render in correct columns and order
- [ ] Verify: "Preview Mode" badge visible

**Test 2: Preview reflects unsaved changes**

- [ ] Open existing form (saved to database)
- [ ] Add new field to column without saving
- [ ] Click "Preview" button
- [ ] Verify: Preview shows new field (unsaved change reflected)
- [ ] Close preview
- [ ] Remove field
- [ ] Click "Preview" again
- [ ] Verify: Preview does not show removed field

**Test 3: Preview submit button disabled**

- [ ] Create form with fields
- [ ] Click "Preview" button
- [ ] Fill out form fields in preview
- [ ] Click submit button
- [ ] Verify: No API request made (form submission disabled)
- [ ] Verify: Toast or visual indicator shows "Preview Mode"

**Test 4: Close preview returns to builder**

- [ ] Click "Preview" button
- [ ] Preview dialog opens
- [ ] Click close button (X in header)
- [ ] Verify: Dialog closes, builder visible again
- [ ] Verify: Builder state unchanged (fields, rows, settings preserved)
- [ ] Verify: No navigation occurred (still on builder route)

**Test 5: Preview with global layout (backward compatibility)**

- [ ] Create form with global layout (3 columns, no row layout)
- [ ] Add 6 fields
- [ ] Click "Preview" button
- [ ] Verify: Preview shows global 3-column layout
- [ ] Verify: Fields render in correct order
- [ ] Verify: No errors or warnings in browser console

#### 15. **Manual Testing Checklist**

**Test 1: Preview accuracy comparison**

- [ ] Create complex form with row layout (3 rows, mixed column counts, multi-field columns)
- [ ] Click "Preview" button
- [ ] Open preview in separate browser tab (or side-by-side)
- [ ] Publish form and navigate to published URL
- [ ] Compare preview side-by-side with published form
- [ ] Verify: Layouts match exactly (rows, columns, fields, spacing, styling)

**Test 2: Preview responsiveness**

- [ ] Create form with row layout
- [ ] Click "Preview" button
- [ ] Resize preview dialog (if possible) or use browser dev tools to resize viewport
- [ ] Test desktop (1920px), laptop (1440px), tablet (768px), mobile (375px)
- [ ] Verify: Preview responsive behavior matches published form (columns stack on mobile)

**Test 3: Preview interactions**

- [ ] Create form with various field types (text, email, number, textarea, select, checkbox, radio)
- [ ] Click "Preview" button
- [ ] Interact with each field type:
  - Type text into text fields
  - Select options in select fields
  - Check/uncheck checkboxes
  - Select radio buttons
  - Pick dates in date fields
- [ ] Verify: All field interactions work correctly
- [ ] Verify: Field validation shows errors for invalid input

**Test 4: Preview with unsaved changes**

- [ ] Open existing saved form
- [ ] Make multiple changes without saving:
  - Add new field
  - Reorder fields in column
  - Change row column count
  - Edit field label
- [ ] Click "Preview" button
- [ ] Verify: Preview shows ALL unsaved changes
- [ ] Close preview
- [ ] Save form
- [ ] Click "Preview" again
- [ ] Verify: Preview still shows same layout (now saved)

**Test 5: Preview close behavior**

- [ ] Click "Preview" button
- [ ] Try each close method:
  - Click close button in header (X)
  - Click close button in footer ("Close Preview")
  - Click dialog mask (outside dialog)
  - Press ESC key
- [ ] Verify: Each method closes dialog successfully
- [ ] Verify: Builder state preserved after closing

#### 16. **Documentation**

- [ ] JSDoc comments for FormBuilderComponent methods:
  - `openPreview()` method
  - `closePreview()` method
  - `exportFormData()` method (if not already documented)
- [ ] JSDoc comments for PreviewDialogComponent:
  - Component purpose and usage
  - Input properties (`visible`, `formSchema`)
  - Output event (`onClose`)
- [ ] JSDoc comments for FormRendererComponent:
  - `previewMode` input property
  - Preview mode behavior explanation
- [ ] Update CLAUDE.md "Form Builder Development" section:
  - Add preview mode feature description
  - Document preview button location and behavior
  - Note that preview reflects unsaved changes

#### 17. **No Regression**

- [ ] Existing FormBuilderComponent tests pass
- [ ] Existing FormRendererComponent tests pass (published form mode)
- [ ] Save workflow unchanged (no side effects from preview feature)
- [ ] Publish workflow unchanged (no side effects from preview feature)
- [ ] Settings dialog, field properties modal unchanged
- [ ] Published forms continue to work correctly (no regression in public rendering)

---

## Technical Notes

### Integration Approach:

#### **FormBuilderComponent Template (Toolbar Update):**

```html
<!-- Updated toolbar with Preview button -->
<div class="form-builder-toolbar flex items-center justify-between p-4 bg-white border-b">
  <div class="toolbar-left flex items-center gap-3">
    <button
      pButton
      type="button"
      label="Settings"
      icon="pi pi-cog"
      class="p-button-outlined"
      (click)="openSettings()"
    ></button>
    <button
      pButton
      type="button"
      label="Preview"
      icon="pi pi-eye"
      class="p-button-outlined p-button-info"
      (click)="openPreview()"
    ></button>
  </div>

  <div class="toolbar-right flex items-center gap-3">
    <button
      pButton
      type="button"
      label="Save"
      icon="pi pi-save"
      class="p-button-success"
      (click)="saveForm()"
      [disabled]="!isDirty()"
    ></button>
    <button
      pButton
      type="button"
      label="Publish"
      icon="pi pi-send"
      class="p-button-primary"
      (click)="publishForm()"
      [disabled]="!canPublish()"
    ></button>
  </div>
</div>

<!-- Preview dialog -->
<app-preview-dialog
  [visible]="previewVisible()"
  [formSchema]="previewSchema()"
  (onClose)="closePreview()"
/>
```

#### **PreviewDialogComponent Styles:**

```scss
.preview-header {
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: #eff6ff; // Light blue background
  border-left: 4px solid #3b82f6; // Blue accent border
  border-radius: 0.375rem;

  .preview-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.25rem 0.75rem;
    background: #3b82f6;
    color: white;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    font-weight: 600;
    margin-bottom: 0.5rem;

    i {
      font-size: 1rem;
    }
  }

  .preview-hint {
    margin: 0.5rem 0 0 0;
    font-size: 0.875rem;
    color: #4b5563; // Gray-600
    line-height: 1.5;
  }
}

.preview-content {
  max-height: calc(90vh - 200px); // Account for header and footer
  overflow-y: auto;
  padding: 1rem;

  // Ensure form renderer uses full width
  app-form-renderer {
    display: block;
    width: 100%;
  }
}

// Override PrimeNG Dialog styles for preview
:host ::ng-deep {
  .p-dialog {
    .p-dialog-header {
      background: #f9fafb;
      border-bottom: 1px solid #e5e7eb;

      .p-dialog-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: #111827;
      }
    }

    .p-dialog-footer {
      background: #f9fafb;
      border-top: 1px solid #e5e7eb;
      padding: 1rem 1.5rem;
      display: flex;
      justify-content: flex-end;

      button {
        min-width: 120px;
      }
    }
  }
}
```

#### **FormRendererComponent Preview Mode Implementation:**

```typescript
export class FormRendererComponent implements OnInit {
  // ... existing properties

  /**
   * Input: FormSchema for preview mode (bypasses API fetch)
   */
  @Input() formSchema: FormSchema | null = null;

  /**
   * Input: Preview mode flag (disables submission)
   */
  @Input() previewMode = false;

  // Internal schema signal (used for both preview and published modes)
  private readonly formSchemaSignal = signal<FormSchema | null>(null);

  // Computed signals use internal schema signal
  readonly isRowLayoutEnabled = computed(
    () => this.formSchemaSignal()?.settings?.rowLayout?.enabled === true
  );

  readonly sortedRows = computed(() => {
    if (!this.isRowLayoutEnabled()) return [];
    const rows = this.formSchemaSignal()?.settings?.rowLayout?.rows || [];
    return [...rows].sort((a, b) => a.order - b.order);
  });

  ngOnInit() {
    // If in preview mode, use provided schema (skip API fetch)
    if (this.previewMode && this.formSchema) {
      this.formSchemaSignal.set(this.formSchema);
      this.buildFormGroup(this.formSchema);
      this.isLoading.set(false);
      return;
    }

    // Otherwise, load from API (published form mode)
    const shortCode = this.route.snapshot.paramMap.get('shortCode');
    if (!shortCode) {
      this.error.set('Invalid form link');
      this.isLoading.set(false);
      return;
    }

    this.loadFormSchema(shortCode);
  }

  /**
   * Handle form submission
   */
  onSubmit(): void {
    // Prevent submission in preview mode
    if (this.previewMode) {
      this.messageService.add({
        severity: 'info',
        summary: 'Preview Mode',
        detail: 'Form submission is disabled in preview mode.',
      });
      return;
    }

    // ... existing submission logic
  }
}
```

#### **FormRendererComponent Template (Submit Button Update):**

```html
<!-- Submit button with preview mode indicator -->
<div class="form-actions mt-6">
  <button type="submit" class="submit-btn" [disabled]="formGroup().invalid || previewMode">
    {{ previewMode ? 'Submit (Preview Mode)' : formSchema()?.settings?.submitButtonText || 'Submit'
    }}
  </button>
</div>
```

### Key Constraints:

- **Backward compatibility:** Preview feature is additive (no changes to existing save/publish
  workflows)
- **Preview accuracy:** Preview must match published form exactly (same rendering logic)
- **Performance:** Preview schema export is synchronous (in-memory, no API call)
- **Type safety:** All code must pass TypeScript strict mode compilation
- **User experience:** Preview is instant (no loading state, no network delay)

### Testing Strategy:

- **Unit tests:** Preview dialog state management, schema export, preview mode behavior
- **E2E tests:** Preview button interaction, preview accuracy, unsaved changes, close behavior
- **Manual QA:** Visual comparison builder vs. preview vs. published form, responsiveness,
  cross-browser

---

## Definition of Done

- [ ] "Preview" button added to FormBuilderComponent toolbar
- [ ] PreviewDialogComponent created with PrimeNG Dialog wrapper
- [ ] Preview dialog displays "Preview Mode" badge with helpful hint text
- [ ] FormBuilderComponent exports current schema on preview open (includes unsaved changes)
- [ ] PreviewDialogComponent passes schema to FormRendererComponent via input
- [ ] FormRendererComponent supports `previewMode` input flag
- [ ] FormRendererComponent uses provided schema in preview mode (skips API fetch)
- [ ] FormRendererComponent disables submission in preview mode
- [ ] Preview dialog renders form with exact same layout as published form (row-column layout)
- [ ] Preview reflects unsaved changes (in-memory state)
- [ ] Close preview returns to builder (no navigation, no save)
- [ ] Unit tests written and passing:
  - FormBuilderComponent preview methods (3 tests)
  - PreviewDialogComponent rendering and events (4 tests)
  - FormRendererComponent preview mode behavior (5 tests)
- [ ] E2E tests written and passing:
  - Preview button interaction (5 scenarios)
  - Preview accuracy and unsaved changes
  - Preview submit button disabled
  - Close preview behavior
- [ ] Manual testing checklist completed (5 test scenarios)
- [ ] Existing functionality verified:
  - Save, publish, settings workflows unchanged
  - Published forms continue to work correctly
  - No side effects from preview feature
- [ ] Code follows project standards (TypeScript strict, ESLint, Prettier)
- [ ] JSDoc comments added for new components and methods
- [ ] CLAUDE.md updated with preview mode feature description
- [ ] No regression in existing tests
- [ ] Cross-browser testing completed (Chrome, Firefox, Safari, Edge)

---

## Risk and Compatibility Check

### Minimal Risk Assessment:

- **Primary Risk:** Breaking existing FormRendererComponent for published forms
- **Mitigation:**
  - Make preview mode conditional (`previewMode` input flag)
  - Preserve published form rendering path (existing behavior)
  - Add comprehensive unit tests for both preview and published modes
  - Test published forms after implementing preview feature (no regression)
  - Add E2E tests for both modes
- **Rollback:**
  - Remove preview button from toolbar (revert template change)
  - Delete PreviewDialogComponent (isolated component, no dependencies)
  - Revert FormRendererComponent preview mode changes (remove inputs)
  - No database or schema changes required (frontend-only story)

### Compatibility Verification:

- [x] No breaking changes to existing APIs (FormRendererComponent extends with optional inputs)
- [x] Database schema changes are N/A (frontend-only)
- [x] UI changes follow existing patterns (PrimeNG Dialog, toolbar buttons)
- [x] Performance impact is minimal (in-memory schema export, no API call)

---

## Validation Checklist

### Scope Validation:

- [x] Story can be completed in 1-2 days (toolbar button, dialog component, preview mode flag)
- [x] Integration approach is straightforward (embed FormRendererComponent in dialog)
- [x] Follows existing patterns exactly (PrimeNG Dialog, toolbar actions, input bindings)
- [x] No complex design work required (UI patterns established, dialog component)

### Clarity Check:

- [x] Story requirements are unambiguous (specific toolbar button, dialog component, preview mode
      behavior)
- [x] Integration points are clearly specified (FormBuilderComponent, PreviewDialogComponent,
      FormRendererComponent)
- [x] Success criteria are testable (unit tests, E2E tests, manual QA checklist)
- [x] Rollback approach is simple (remove preview button, delete dialog component)

---

**Story Status:** ‚úÖ Ready for Development **Epic Status:** ‚úÖ All Stories Completed (14.1, 14.2,
14.3) **Next Step:** Dev agent implements stories in sequence (14.1 ‚Üí 14.2 ‚Üí 14.3)
