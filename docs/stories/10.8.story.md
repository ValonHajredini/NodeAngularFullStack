# Story 10.8: Form Publishing and Token Generation

## Status

Draft

## Story

**As a** form creator, **I want** to publish my form and receive a secure shareable URL, **so that**
I can distribute the form to respondents via the public renderer.

## Acceptance Criteria

1. **AC1**: "Publish" button validates form schema before allowing publish (all required fields have
   labels, no duplicate field names, valid regex patterns)
2. **AC2**: Publish dialog shows: Expiration date/time picker (default: 30 days), Preview of render
   URL
3. **AC3**: `POST /api/forms/:id/publish` endpoint generates cryptographically secure token using
   JWT
4. **AC4**: Token payload includes: formSchemaId, expiresAt, issuer, issued time
5. **AC5**: Render URL format: `https://{domain}/forms/render/{token}`
6. **AC6**: Published form creates new form_schema record with `is_published=true`, render_token,
   and expires_at
7. **AC7**: Re-publishing updates existing schema or creates new version (based on user choice)
8. **AC8**: Unpublish option revokes token (sets `is_published=false`) and invalidates render URL
9. **AC9**: Copy URL button copies render URL to clipboard with toast notification
10. **AC10**: Published forms marked as read-only in draft editor (must unpublish to edit)

## Tasks / Subtasks

- [ ] Create publish API endpoint (AC: 3, 4, 6, 7)
  - [ ] Create `/apps/api/src/routes/forms.routes.ts` POST `/api/forms/:id/publish` route
  - [ ] Apply authenticate middleware for JWT validation
  - [ ] Create `publishForm` method in FormsController
  - [ ] Validate form ownership before allowing publish
  - [ ] Implement schema validation: check all fields have labels, no duplicates, valid regex
        patterns
  - [ ] Generate JWT token using FormsService.generateRenderToken()
  - [ ] Token payload: `{ formSchemaId, expiresAt, iss: 'form-builder', iat: Date.now() }`
  - [ ] Use `FORM_RENDER_TOKEN_SECRET` from environment
  - [ ] Create new form_schema record with is_published=true, render_token, expires_at
  - [ ] Update forms.status to 'published'
  - [ ] Return published form metadata with render URL
  - [ ] Add OpenAPI/Swagger annotations

- [ ] Implement re-publish and versioning logic (AC: 7)
  - [ ] Check if form already has published schema
  - [ ] Show dialog: "Update existing version" or "Create new version"
  - [ ] If update: update existing form_schema record with new token and expiration
  - [ ] If new version: increment schema_version, create new form_schema record
  - [ ] Keep old tokens active until their expiration (versioning support)
  - [ ] Return version information in response

- [ ] Create unpublish API endpoint (AC: 8)
  - [ ] Create POST `/api/forms/:id/unpublish` route
  - [ ] Validate form ownership
  - [ ] Set is_published=false on current form_schema
  - [ ] Update forms.status to 'draft'
  - [ ] Return success response
  - [ ] Add OpenAPI/Swagger annotations

- [ ] Create publish dialog component (AC: 1, 2, 9, 10)
  - [ ] Create
        `/apps/web/src/app/features/tools/components/form-builder/publish-dialog/publish-dialog.component.ts`
  - [ ] Use PrimeNG Dialog for modal
  - [ ] Create reactive form with controls:
    - expirationDate: [defaultDate (30 days from now), Validators.required]
    - expirationTime: [defaultTime, Validators.required]
  - [ ] Display render URL preview (before publish, show placeholder)
  - [ ] Validate form schema before showing dialog:
    - Check all fields have labels
    - Check for duplicate field names
    - Check regex patterns are valid
    - Show validation errors if any
  - [ ] Emit @Output() publish event with expiration date/time
  - [ ] Show loading state during publish API call

- [ ] Integrate publish functionality in FormBuilder (AC: 1, 9, 10)
  - [ ] Add "Publish" button to FormBuilder toolbar
  - [ ] Disable publish if form is not saved (force save first)
  - [ ] Implement publishForm() method:
    - Validate schema using FormsService
    - Show publish dialog on validation success
    - Call formsApiService.publishForm(formId, expirationDate)
    - On success: show render URL dialog with copy button
    - Mark form as read-only after publish
  - [ ] Implement copyRenderUrl() method:
    - Use Clipboard API: navigator.clipboard.writeText(url)
    - Show toast: "URL copied to clipboard"
    - Handle errors (permissions, browser support)
  - [ ] Show "Published" badge in toolbar when form is published
  - [ ] Disable canvas/properties editing when published (read-only mode)

- [ ] Implement unpublish functionality (AC: 8)
  - [ ] Add "Unpublish" button (only visible when form is published)
  - [ ] Show confirmation dialog: "Are you sure? This will invalidate the render URL"
  - [ ] Implement unpublishForm() method:
    - Call formsApiService.unpublishForm(formId)
    - On success: enable editing, remove published badge, show toast
  - [ ] Re-enable canvas/properties editing after unpublish

- [ ] Update FormsApiService with publish endpoints (AC: 3, 8)
  - [ ] Add
        `publishForm(formId: string, expiresAt: Date): Observable<{ form: FormMetadata, schema: FormSchema, renderUrl: string }>`
        method
  - [ ] POST /api/forms/:id/publish with body: { expiresAt }
  - [ ] Add `unpublishForm(formId: string): Observable<void>` method
  - [ ] POST /api/forms/:id/unpublish
  - [ ] Handle errors with catchError and toast notifications

- [ ] Implement read-only mode for published forms (AC: 10)
  - [ ] Add `isPublished` computed signal in FormBuilderService
  - [ ] Disable drag-drop on canvas when published
  - [ ] Disable field properties editing when published
  - [ ] Show info message: "Form is published. Unpublish to make changes."
  - [ ] Prevent save operations on published forms (except unpublish)

- [ ] Apply rate limiting to publish endpoint (IV: 5)
  - [ ] Use existing express-rate-limit middleware
  - [ ] Limit: 10 publishes per hour per user
  - [ ] Return 429 Too Many Requests with retry-after header
  - [ ] Show user-friendly error message in UI

- [ ] Write tests for publish functionality (IV: 1, 2, 3, 4)
  - [ ] Backend tests:
    - Test POST /api/forms/:id/publish creates token and schema
    - Test token payload contains required fields
    - Test publish validation (duplicate names, missing labels)
    - Test unpublish sets is_published=false
    - Test rate limiting (10 publishes per hour)
    - Test token generation uses existing JWT pattern
  - [ ] Frontend tests:
    - Test publish dialog validation
    - Test copy URL to clipboard
    - Test read-only mode when published
    - Mock FormsApiService
  - [ ] Integration tests:
    - Test full publish flow: validate → publish → get URL
    - Test re-publish with versioning
    - Test unpublish enables editing

## Dev Notes

### Previous Story Insights

Story 10.7 implemented form persistence and settings. This story adds the publishing mechanism to
generate shareable public form URLs.

### Data Models

**Form Publishing Data:** [Source: docs/prd-form-builder/epic-10#Story-1.8]

- Published schema stored in form_schemas table with is_published=true
- Render token: JWT with formSchemaId, expiresAt, issuer
- Forms status updated to 'published'
- Versioning: Multiple schemas per form, each with unique token

**Token Structure:** [Source: docs/prd-form-builder/epic-10#Story-1.8-AC4]

```javascript
{
  formSchemaId: "uuid",
  expiresAt: "ISO8601 timestamp",
  iss: "form-builder",
  iat: timestamp
}
```

**Render URL Format:** [Source: docs/prd-form-builder/epic-10#Story-1.8-AC5]

- `https://{domain}/forms/render/{jwt-token}`
- Token is JWT signed with FORM_RENDER_TOKEN_SECRET
- Public access (no authentication required)

### API Specifications

**Publish Endpoint:** [Source: docs/prd-form-builder/epic-10#Story-1.8]

- POST /api/forms/:id/publish
- Request body: `{ expiresAt: "ISO8601 date" }`
- Response: `{ success: true, data: { form, schema, renderUrl } }`
- Requires authentication and ownership
- Rate limited: 10 publishes per hour per user

**Unpublish Endpoint:** [Source: docs/prd-form-builder/epic-10#Story-1.8-AC8]

- POST /api/forms/:id/unpublish
- No request body
- Response: `{ success: true }`
- Sets is_published=false, invalidates token

### Component Specifications

**Publish Dialog:** [Source: docs/prd-form-builder/epic-10#Story-1.8-AC2]

- PrimeNG Dialog component
- Expiration date/time picker (Calendar + time selector)
- Default: 30 days from current date
- Render URL preview (after publish)
- Copy button with clipboard integration

**Read-Only Mode:** [Source: docs/prd-form-builder/epic-10#Story-1.8-AC10]

- Disable canvas drag-drop
- Disable field properties editing
- Disable field palette
- Show visual indicator (badge, banner)
- Only allow unpublish action

### File Locations

**Backend:** [Source: docs/architecture/unified-project-structure.md#apps/api]

- Update: `/apps/api/src/routes/forms.routes.ts` (add publish/unpublish routes)
- Update: `/apps/api/src/controllers/forms.controller.ts` (add publish/unpublish methods)
- Update: `/apps/api/src/services/forms.service.ts` (use existing generateRenderToken method)

**Frontend:** [Source: docs/architecture/unified-project-structure.md#apps/web]

- Create:
  `/apps/web/src/app/features/tools/components/form-builder/publish-dialog/publish-dialog.component.ts`
- Update: `/apps/web/src/app/features/tools/components/form-builder/form-builder.component.ts`
- Update: `/apps/web/src/app/features/tools/components/form-builder/forms-api.service.ts`
- Update: `/apps/web/src/app/features/tools/components/form-builder/form-builder.service.ts`

**Tests:** [Source: docs/architecture/testing-strategy.md]

- Create: `/apps/api/tests/integration/forms-publish.test.ts`
- Create:
  `/apps/web/src/app/features/tools/components/form-builder/publish-dialog/publish-dialog.component.spec.ts`

### Testing Requirements

**Backend Tests:** [Source: docs/architecture/testing-strategy.md#Backend-API-Test]

- Test publish endpoint with valid form
- Test schema validation (duplicate names, missing labels, invalid regex)
- Test JWT token generation and payload
- Test versioning: re-publish creates new schema
- Test unpublish invalidates token
- Test rate limiting (10/hour per user)
- Test ownership validation

**Frontend Tests:** [Source: docs/architecture/testing-strategy.md#Frontend-Component-Test]

- Test publish dialog validation
- Test clipboard copy functionality
- Test read-only mode disables editing
- Mock FormsApiService
- Test error handling for failed publish

**Integration Tests:**

- Full publish flow: validate → API call → URL generation
- Test render URL is accessible (Story 10.9 will validate)
- Test unpublish re-enables editing

**Test Commands:** [Source: docs/CLAUDE.md#Testing-Commands]

- Backend: `npm --workspace=apps/api run test -- --testPathPattern="forms-publish.test.ts"`
- Frontend:
  `npm --workspace=apps/web run test -- --include="**/publish-dialog.component.spec.ts" --watch=false`

### Technical Constraints

**JWT Token Generation:** [Source:
docs/architecture/backend-architecture.md#Authentication-and-Authorization]

- Use existing jsonwebtoken library
- Secret: FORM_RENDER_TOKEN_SECRET from environment
- Payload: formSchemaId, expiresAt, issuer, iat
- Token expiration enforced on verification (server-side)
- No client-side token validation

**Schema Validation:** [Source: docs/prd-form-builder/epic-10#Story-1.8-AC1]

- All fields must have label (not empty)
- Field names must be unique within form
- Regex patterns must be valid RegExp
- Prevent publish if validation fails
- Show specific error messages

**Versioning Strategy:** [Source: docs/prd-form-builder/epic-10#Story-1.8-AC7]

- Multiple form_schemas per form
- Each publish creates or updates schema
- Old tokens remain valid until expiration
- schema_version increments for new versions
- Current published version tracked

**Rate Limiting:** [Source: docs/prd-form-builder/epic-10#Story-1.8-IV5]

- Use express-rate-limit middleware (existing pattern)
- 10 publishes per hour per user (tracked by userId)
- 429 status code on limit exceeded
- Include retry-after header in response

**Clipboard API:** [Source: docs/prd-form-builder/epic-10#Story-1.8-AC9]

- Use navigator.clipboard.writeText() for modern browsers
- Fallback to document.execCommand('copy') for older browsers
- Request clipboard permission if needed
- Show error toast if copy fails

### Testing

**Test File Location:** [Source: docs/architecture/testing-strategy.md]

- `/apps/api/tests/integration/forms-publish.test.ts`
- `/apps/web/src/app/features/tools/components/form-builder/publish-dialog/publish-dialog.component.spec.ts`

**Testing Standards:** [Source: docs/architecture/testing-strategy.md]

- Test JWT token structure and expiration
- Test schema validation edge cases
- Test clipboard copy with mock Clipboard API
- Test read-only mode UI states
- Test rate limiting behavior

**Testing Frameworks:** [Source: docs/architecture/tech-stack.md]

- Jest + Supertest for backend API tests
- Karma + Jasmine for Angular component tests
- Mock navigator.clipboard in tests

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-04 | 1.0     | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
