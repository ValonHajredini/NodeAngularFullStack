# Story 29.14: Poll Template with Vote Aggregation

**Epic**: Epic 29 - Form Template System with Business Logic **Story ID**: 29.14 **Status**:
Approved **Story Points**: 6 **Priority**: Medium **Risk Level**: Low (Session-based tracking,
existing middleware) **Dependencies**: Stories 29.1-29.5 (Backend Foundation), 29.11 (Base Executor
Interface) **Related Stories**: 29.11-29.13, 29.15 (Other Template Types)

---

## User Story

**As a** content creator, **I want** a poll template with duplicate prevention and real-time
results, **so that** I can gather audience opinions accurately.

---

## Acceptance Criteria

| ID  | Criterion                                                                                                   | Validated By      |
| --- | ----------------------------------------------------------------------------------------------------------- | ----------------- |
| AC1 | "Quick Poll" template created with category `POLLS`                                                         | Unit Tests        |
| AC2 | Schema includes single RADIO field with 4-6 options                                                         | Seed Data         |
| AC3 | Business logic config: `{type: 'poll', voteField, preventDuplicates, showResultsAfterVote, trackingMethod}` | Unit Tests        |
| AC4 | `PollExecutor` strategy class created                                                                       | Unit Tests        |
| AC5 | Checks for duplicate votes by session ID                                                                    | Integration Tests |
| AC6 | Rejects duplicate with error message                                                                        | Integration Tests |
| AC7 | Returns vote counts if `showResultsAfterVote: true`                                                         | Integration Tests |
| AC8 | Results displayed with Chart.js horizontal bar chart                                                        | Component Tests   |

---

## Integration Verification

| ID  | Verification                             | Test Method       |
| --- | ---------------------------------------- | ----------------- |
| IV1 | Non-poll forms unchanged                 | Regression Tests  |
| IV2 | Uses existing session middleware         | Integration Tests |
| IV3 | Charts use existing Chart.js integration | Component Tests   |

---

## Dev Notes

### Architecture Context

**Source**: docs/architecture/backend-architecture.md (Session Middleware),
docs/architecture/frontend-architecture.md (Chart.js Integration)

This story implements a poll template with duplicate vote prevention using session-based tracking.
The `PollExecutor` validates submissions using session IDs from existing Express session middleware
(no new authentication required). Vote aggregation happens via PostgreSQL query, and results display
using Chart.js horizontal bar charts.

**Key Architectural Patterns**:

1. **Strategy Pattern**: `PollExecutor` implements `ITemplateExecutor` interface (defined in Story
   29.11)
2. **Session Middleware Integration**: Uses `express-session` with `req.session.id` for duplicate
   tracking
3. **JSONB Metadata Storage**: Stores session IDs in `form_submissions.metadata` JSONB column
4. **Aggregation Query**: Real-time vote counting via PostgreSQL JSONB queries
5. **Chart.js Integration**: Reuses existing analytics chart setup

**Performance Requirements**:

- Vote validation + duplicate check: < 100ms (P95)
- Vote aggregation query: < 150ms (P95)
- Chart rendering: < 200ms (P95)
- Support up to 10,000 votes per poll

---

### Backend Implementation

#### 1. Shared Types Extension

**File**: `packages/shared/src/types/templates.types.ts`

Add poll-specific config type:

```typescript
/**
 * Business logic configuration for poll templates
 * @since Epic 29, Story 29.14
 */
export interface PollLogicConfig {
  type: 'poll';
  voteField: string; // Field ID of the poll question
  preventDuplicates: boolean; // Prevent multiple votes from same session
  showResultsAfterVote: boolean; // Show results to user after voting
  trackingMethod: 'session' | 'ip' | 'fingerprint'; // Tracking method (session recommended)
  allowChangeVote?: boolean; // Optional: allow users to change their vote
}

/**
 * Poll vote metadata stored in form_submissions.metadata JSONB
 * @since Epic 29, Story 29.14
 */
export interface PollVoteMetadata {
  session_id: string; // Session ID for duplicate tracking
  voted_at: string; // ISO timestamp of vote
  vote_value: string; // The option value voted for
  ip_address?: string; // Optional: IP address for additional tracking
  user_agent?: string; // Optional: User agent for analytics
}

/**
 * Poll results aggregation
 * @since Epic 29, Story 29.14
 */
export interface PollResults {
  total_votes: number; // Total number of votes
  vote_counts: Record<string, number>; // Vote count per option
  vote_percentages: Record<string, number>; // Percentage per option
  user_voted: boolean; // Whether current user has voted
  user_vote?: string; // Current user's vote value (if voted)
}
```

Update union type:

```typescript
export type TemplateBusinessLogicConfig =
  | InventoryLogicConfig
  | AppointmentLogicConfig
  | QuizLogicConfig
  | PollLogicConfig
  | OrderLogicConfig;
```

Rebuild shared package:

```bash
npm run build:shared
```

---

#### 2. Session Middleware Extension

**File**: `apps/forms-api/src/middleware/session.middleware.ts`

Ensure session middleware is configured (should already exist):

```typescript
import session from 'express-session';
import connectPg from 'connect-pg-simple';
import { pool } from '../config/database';

/**
 * Express session middleware
 * Stores session data in PostgreSQL for persistence
 * @source docs/architecture/backend-architecture.md (Session Management)
 */
const PgSession = connectPg(session);

export const sessionMiddleware = session({
  store: new PgSession({
    pool,
    tableName: 'sessions',
  }),
  secret: process.env.SESSION_SECRET || 'development-secret-key',
  resave: false,
  saveUninitialized: true,
  cookie: {
    maxAge: 30 * 24 * 60 * 60 * 1000, // 30 days
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'lax',
  },
});
```

Apply to forms router:

```typescript
// apps/forms-api/src/routes/forms.routes.ts
import { sessionMiddleware } from '../middleware/session.middleware';

router.use(sessionMiddleware); // Apply to all form routes
```

---

#### 3. Executor Strategy Class

**File**: `apps/forms-api/src/services/executors/poll.executor.ts`

```typescript
import { PoolClient } from 'pg';
import {
  ITemplateExecutor,
  ExecutorValidation,
  ExecutorResult,
  FormTemplate,
  FormSubmission,
  PollLogicConfig,
  PollVoteMetadata,
} from '@nodeangularfullstack/shared';
import { ApiError } from '../../utils/api-error';
import { FormSubmissionsRepository } from '../../repositories/form-submissions.repository';

/**
 * Poll executor with duplicate vote prevention
 * Validates votes using session-based tracking
 *
 * @since Epic 29, Story 29.14
 * @implements ITemplateExecutor (Story 29.11)
 * @source docs/architecture/backend-architecture.md (Strategy Pattern, Session Management)
 */
export class PollExecutor implements ITemplateExecutor {
  constructor(
    private readonly submissionsRepo: FormSubmissionsRepository,
    private readonly sessionId: string // Session ID from req.session.id
  ) {}

  /**
   * Validate poll vote submission
   * Checks vote field and duplicate prevention
   */
  async validate(
    submission: Partial<FormSubmission>,
    template: FormTemplate,
    config: PollLogicConfig
  ): Promise<ExecutorValidation> {
    const errors: string[] = [];
    const data = submission.data as Record<string, any>;

    // Validate vote field
    const vote = data[config.voteField];
    if (!vote || typeof vote !== 'string' || vote.trim() === '') {
      errors.push(`Vote field '${config.voteField}' is required`);
    }

    // Validate tracking method
    if (!['session', 'ip', 'fingerprint'].includes(config.trackingMethod)) {
      errors.push('Invalid tracking method. Must be: session, ip, or fingerprint');
    }

    // Check duplicate vote if prevention enabled
    if (config.preventDuplicates && submission.form_id) {
      const hasDuplicate = await this.checkDuplicateVote(submission.form_id, this.sessionId);

      if (hasDuplicate) {
        errors.push('You have already voted in this poll');
      }
    }

    return {
      valid: errors.length === 0,
      errors,
    };
  }

  /**
   * Execute poll vote submission
   * Stores vote with session tracking metadata
   *
   * @param submission - Form submission record
   * @param template - Template configuration
   * @param config - Poll logic configuration
   * @param client - Database client (unused for poll, required by interface)
   * @returns Executor result with vote confirmation and optional results
   */
  async execute(
    submission: FormSubmission,
    template: FormTemplate,
    config: PollLogicConfig,
    client?: PoolClient
  ): Promise<ExecutorResult> {
    const data = submission.data as Record<string, any>;
    const voteValue = data[config.voteField];

    // Prepare metadata
    const metadata: PollVoteMetadata = {
      session_id: this.sessionId,
      voted_at: new Date().toISOString(),
      vote_value: voteValue,
    };

    // Prepare result
    const result: ExecutorResult = {
      success: true,
      data: metadata,
      message: 'Vote recorded successfully',
    };

    // Include poll results if configured
    if (config.showResultsAfterVote) {
      const pollResults = await this.aggregateVotes(submission.form_id, config.voteField);
      result.data = {
        ...result.data,
        poll_results: pollResults,
      };
    }

    return result;
  }

  /**
   * Check if session has already voted
   * @param formId - Form UUID
   * @param sessionId - Session ID
   * @returns True if duplicate vote detected
   */
  private async checkDuplicateVote(formId: string, sessionId: string): Promise<boolean> {
    const result = await this.submissionsRepo.checkDuplicateBySession(formId, sessionId);
    return result > 0;
  }

  /**
   * Aggregate poll votes by option
   * @param formId - Form UUID
   * @param voteField - Field ID of vote question
   * @returns Poll results with vote counts and percentages
   */
  private async aggregateVotes(formId: string, voteField: string): Promise<any> {
    const results = await this.submissionsRepo.aggregatePollVotes(formId, voteField);

    const totalVotes = results.reduce((sum, r) => sum + r.count, 0);

    const voteCounts: Record<string, number> = {};
    const votePercentages: Record<string, number> = {};

    results.forEach((r) => {
      voteCounts[r.vote_value] = r.count;
      votePercentages[r.vote_value] = totalVotes > 0 ? Math.round((r.count / totalVotes) * 100) : 0;
    });

    return {
      total_votes: totalVotes,
      vote_counts: voteCounts,
      vote_percentages: votePercentages,
      user_voted: true,
      user_vote: null, // Will be set by service layer
    };
  }
}
```

---

#### 4. Repository Extension

**File**: `apps/forms-api/src/repositories/form-submissions.repository.ts`

Add poll-specific query methods:

```typescript
/**
 * Check for duplicate vote by session ID
 * @param formId - Form UUID
 * @param sessionId - Session ID
 * @returns Count of submissions from this session
 */
async checkDuplicateBySession(formId: string, sessionId: string): Promise<number> {
  const query = `
    SELECT COUNT(*) as count
    FROM form_submissions
    WHERE form_id = $1
      AND metadata->>'session_id' = $2
  `;

  const result = await this.pool.query(query, [formId, sessionId]);
  return parseInt(result.rows[0].count, 10);
}

/**
 * Aggregate poll votes by option value
 * @param formId - Form UUID
 * @param voteField - Field ID of vote question
 * @returns Array of vote counts per option
 */
async aggregatePollVotes(
  formId: string,
  voteField: string
): Promise<Array<{ vote_value: string; count: number }>> {
  const query = `
    SELECT
      data->>$2 as vote_value,
      COUNT(*) as count
    FROM form_submissions
    WHERE form_id = $1
      AND data->>$2 IS NOT NULL
    GROUP BY data->>$2
    ORDER BY count DESC
  `;

  const result = await this.pool.query(query, [formId, voteField]);
  return result.rows.map(row => ({
    vote_value: row.vote_value,
    count: parseInt(row.count, 10)
  }));
}
```

---

#### 5. Service Integration

**File**: `apps/forms-api/src/services/forms.service.ts`

Update executor factory to accept session ID:

```typescript
import { PollExecutor } from './executors/poll.executor';

/**
 * Get executor instance based on config type
 * @param config - Business logic configuration
 * @param sessionId - Session ID from req.session.id (for poll executor)
 * @source docs/architecture/backend-architecture.md (Strategy Pattern)
 */
private getExecutor(
  config: TemplateBusinessLogicConfig,
  sessionId?: string
): ITemplateExecutor {
  switch (config.type) {
    case 'inventory':
      const inventoryRepo = new ProductInventoryRepository(this.pool);
      return new InventoryExecutor(inventoryRepo);

    case 'appointment':
      const bookingRepo = new AppointmentBookingRepository(this.pool);
      return new AppointmentExecutor(bookingRepo);

    case 'quiz':
      return new QuizExecutor();

    case 'poll':
      if (!sessionId) {
        throw new ApiError(400, 'Session ID required for poll voting');
      }
      return new PollExecutor(this.submissionsRepo, sessionId);

    default:
      throw new ApiError(400, `Unknown executor type: ${(config as any).type}`);
  }
}
```

Update `submitForm()` to pass session ID:

```typescript
/**
 * Submit form with optional template business logic
 * Handles poll voting with duplicate prevention
 *
 * @param shortCode - Form short code
 * @param submissionData - Form data
 * @param sessionId - Session ID from req.session.id
 * @returns Created submission with poll results if applicable
 * @throws ApiError 400 if duplicate vote detected
 */
async submitForm(
  shortCode: string,
  submissionData: any,
  sessionId?: string
): Promise<FormSubmission> {
  // ... existing form retrieval code

  // Validate with executor before creating submission
  if (template?.business_logic_config) {
    const executor = this.getExecutor(template.business_logic_config, sessionId);
    const validation = await executor.validate(
      { data: submissionData, form_id: form.id },
      template,
      template.business_logic_config
    );

    if (!validation.valid) {
      throw new ApiError(400, validation.errors.join(', '));
    }
  }

  // ... rest of submission flow
}
```

---

#### 6. Controller Extension

**File**: `apps/forms-api/src/controllers/forms.controller.ts`

Pass session ID to service:

```typescript
/**
 * POST /api/public/forms/:shortCode/submit
 * Submit form data
 * @source docs/architecture/backend-architecture.md (Controller Pattern)
 */
router.post(
  '/:shortCode/submit',
  asyncHandler(async (req: Request, res: Response) => {
    const { shortCode } = req.params;
    const submissionData = req.body;

    // Get session ID from Express session
    const sessionId = req.session?.id;

    const submission = await formsService.submitForm(shortCode, submissionData, sessionId);

    res.json({
      success: true,
      data: submission,
      message: 'Form submitted successfully',
    });
  })
);
```

Add poll results endpoint:

```typescript
/**
 * GET /api/public/forms/:shortCode/poll-results
 * Get poll results
 *
 * @param shortCode - Form short code
 * @returns Poll results with vote counts and percentages
 * @since Epic 29, Story 29.14
 */
router.get(
  '/:shortCode/poll-results',
  asyncHandler(async (req: Request, res: Response) => {
    const { shortCode } = req.params;

    // Get form and template
    const form = await formsService.getFormByShortCode(shortCode);
    if (!form?.template_id) {
      throw new ApiError(404, 'Form not found or does not use poll template');
    }

    const template = await templatesService.getTemplateById(form.template_id);
    if (template.business_logic_config?.type !== 'poll') {
      throw new ApiError(400, 'Form does not use poll template');
    }

    const config = template.business_logic_config as PollLogicConfig;

    // Get aggregated results
    const submissionsRepo = new FormSubmissionsRepository(pool);
    const voteData = await submissionsRepo.aggregatePollVotes(form.id, config.voteField);

    const totalVotes = voteData.reduce((sum, v) => sum + v.count, 0);

    const results = {
      total_votes: totalVotes,
      vote_counts: voteData.reduce(
        (acc, v) => {
          acc[v.vote_value] = v.count;
          return acc;
        },
        {} as Record<string, number>
      ),
      vote_percentages: voteData.reduce(
        (acc, v) => {
          acc[v.vote_value] = totalVotes > 0 ? Math.round((v.count / totalVotes) * 100) : 0;
          return acc;
        },
        {} as Record<string, number>
      ),
    };

    res.json({
      success: true,
      data: results,
      message: 'Poll results retrieved successfully',
    });
  })
);
```

---

### Frontend Implementation

#### 1. API Service Extension

**File**: `apps/form-builder-ui/src/app/features/public/form-renderer/form-renderer.service.ts`

Add poll results method:

```typescript
import { PollResults } from '@nodeangularfullstack/shared';

/**
 * Get poll results
 * @param shortCode - Form short code
 * @returns Observable of poll results
 * @since Epic 29, Story 29.14
 */
getPollResults(shortCode: string): Observable<PollResults> {
  return this.http.get<ApiResponse<PollResults>>(
    `${this.apiUrl}/api/public/forms/${shortCode}/poll-results`
  ).pipe(
    map(response => response.data)
  );
}
```

---

#### 2. Poll Results Display Component

**File**:
`apps/form-builder-ui/src/app/features/public/form-renderer/poll-results/poll-results.component.ts`

```typescript
import {
  Component,
  computed,
  inject,
  input,
  OnInit,
  signal,
  ChangeDetectionStrategy,
  ViewChild,
  ElementRef,
  AfterViewInit,
} from '@angular/core';
import { CommonModule } from '@angular/common';
import { CardModule } from 'primeng/card';
import { ProgressBarModule } from 'primeng/progressbar';
import { FormRendererService } from '../form-renderer.service';
import { PollResults } from '@nodeangularfullstack/shared';
import Chart from 'chart.js/auto';

/**
 * Component displays poll results with horizontal bar chart
 * Shows vote counts and percentages
 *
 * @since Epic 29, Story 29.14
 * @source docs/architecture/frontend-architecture.md (Chart.js Integration)
 */
@Component({
  selector: 'app-poll-results',
  standalone: true,
  imports: [CommonModule, CardModule, ProgressBarModule],
  changeDetection: ChangeDetectionStrategy.OnPush,
  template: `
    <p-card class="poll-results-card">
      <ng-template pTemplate="header">
        <div class="results-header">
          <i class="pi pi-chart-bar"></i>
          <h2>Poll Results</h2>
        </div>
      </ng-template>

      <div class="results-summary">
        <div class="total-votes">
          <span class="votes-value">{{ results().total_votes }}</span>
          <span class="votes-label">Total Votes</span>
        </div>

        @if (results().user_voted) {
          <div class="user-vote-info">
            <i class="pi pi-check-circle"></i>
            <span
              >You voted for: <strong>{{ getUserVoteLabel() }}</strong></span
            >
          </div>
        }
      </div>

      <!-- Chart Canvas -->
      <div class="chart-container">
        <canvas #pollChart></canvas>
      </div>

      <!-- Detailed Breakdown -->
      <div class="vote-breakdown">
        @for (option of voteOptions(); track option.value) {
          <div class="vote-item">
            <div class="vote-header">
              <span class="option-label">{{ option.label }}</span>
              <span class="vote-count"
                >{{ getVoteCount(option.value) }} votes ({{
                  getVotePercentage(option.value)
                }}%)</span
              >
            </div>
            <p-progressBar
              [value]="getVotePercentage(option.value)"
              [showValue]="false"
              [style]="{ height: '24px' }"
            />
          </div>
        }
      </div>

      @if (loading()) {
        <div class="loading-spinner">Loading results...</div>
      }

      @if (error()) {
        <div class="error-message">{{ error() }}</div>
      }
    </p-card>
  `,
  styles: [
    `
      .poll-results-card {
        max-width: 700px;
        margin: 2rem auto;
      }

      .results-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.5rem;
        background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
        color: white;
        border-radius: 6px 6px 0 0;
      }

      .results-header i {
        font-size: 2.5rem;
      }

      .results-header h2 {
        margin: 0;
        font-size: 1.75rem;
      }

      .results-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.5rem 0;
        border-bottom: 1px solid var(--surface-border);
        margin-bottom: 1.5rem;
      }

      .total-votes {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .votes-value {
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--primary-color);
      }

      .votes-label {
        font-size: 0.875rem;
        color: var(--text-color-secondary);
      }

      .user-vote-info {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        background: var(--green-50);
        border: 1px solid var(--green-200);
        border-radius: 6px;
        color: var(--green-700);
      }

      .user-vote-info i {
        font-size: 1.25rem;
      }

      .chart-container {
        margin: 2rem 0;
        padding: 1rem;
        background: var(--surface-50);
        border-radius: 6px;
      }

      .vote-breakdown {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin-top: 2rem;
      }

      .vote-item {
        padding: 0.75rem;
        background: var(--surface-card);
        border-radius: 6px;
        border: 1px solid var(--surface-border);
      }

      .vote-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }

      .option-label {
        font-weight: 600;
        font-size: 1rem;
      }

      .vote-count {
        color: var(--text-color-secondary);
        font-size: 0.875rem;
      }

      .loading-spinner {
        text-align: center;
        padding: 2rem;
        color: var(--text-color-secondary);
      }

      .error-message {
        color: var(--red-500);
        padding: 1rem;
        background: var(--red-50);
        border-radius: 6px;
        margin-top: 1rem;
      }
    `,
  ],
})
export class PollResultsComponent implements OnInit, AfterViewInit {
  // Inputs
  readonly results = input.required<PollResults>();
  readonly options = input.required<Array<{ label: string; value: string }>>();

  // Services
  private readonly formService = inject(FormRendererService);

  // State
  readonly loading = signal(false);
  readonly error = signal<string | null>(null);

  // Chart reference
  @ViewChild('pollChart') pollChartCanvas!: ElementRef<HTMLCanvasElement>;
  private chart: Chart | null = null;

  // Computed
  readonly voteOptions = computed(() => this.options());

  ngOnInit(): void {
    // Component initialization
  }

  ngAfterViewInit(): void {
    this.renderChart();
  }

  /**
   * Render horizontal bar chart with vote results
   */
  private renderChart(): void {
    const options = this.voteOptions();
    const results = this.results();

    const labels = options.map((o) => o.label);
    const data = options.map((o) => this.getVoteCount(o.value));
    const percentages = options.map((o) => this.getVotePercentage(o.value));

    this.chart = new Chart(this.pollChartCanvas.nativeElement, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          {
            label: 'Votes',
            data,
            backgroundColor: [
              'rgba(54, 162, 235, 0.7)',
              'rgba(255, 99, 132, 0.7)',
              'rgba(75, 192, 192, 0.7)',
              'rgba(255, 206, 86, 0.7)',
              'rgba(153, 102, 255, 0.7)',
              'rgba(255, 159, 64, 0.7)',
            ],
            borderColor: [
              'rgba(54, 162, 235, 1)',
              'rgba(255, 99, 132, 1)',
              'rgba(75, 192, 192, 1)',
              'rgba(255, 206, 86, 1)',
              'rgba(153, 102, 255, 1)',
              'rgba(255, 159, 64, 1)',
            ],
            borderWidth: 2,
          },
        ],
      },
      options: {
        indexAxis: 'y', // Horizontal bar chart
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            display: false,
          },
          tooltip: {
            callbacks: {
              label: (context) => {
                const index = context.dataIndex;
                const votes = data[index];
                const percentage = percentages[index];
                return `${votes} votes (${percentage}%)`;
              },
            },
          },
        },
        scales: {
          x: {
            beginAtZero: true,
            ticks: {
              stepSize: 1,
            },
          },
        },
      },
    });
  }

  /**
   * Get vote count for option
   */
  getVoteCount(value: string): number {
    return this.results().vote_counts[value] || 0;
  }

  /**
   * Get vote percentage for option
   */
  getVotePercentage(value: string): number {
    return this.results().vote_percentages[value] || 0;
  }

  /**
   * Get user's vote label
   */
  getUserVoteLabel(): string {
    const userVote = this.results().user_vote;
    if (!userVote) return '';

    const option = this.voteOptions().find((o) => o.value === userVote);
    return option?.label || userVote;
  }
}
```

---

#### 3. Integration with FormRendererComponent

**File**: `apps/form-builder-ui/src/app/features/public/form-renderer/form-renderer.component.ts`

Add poll results handling:

```typescript
import { PollResultsComponent } from './poll-results/poll-results.component';
import { PollResults } from '@nodeangularfullstack/shared';

@Component({
  // ... existing config
  imports: [..., PollResultsComponent]
})
export class FormRendererComponent {
  // ... existing state
  readonly pollResults = signal<PollResults | null>(null);
  readonly showPollResults = signal(false);

  readonly isPollTemplate = computed(() => {
    const template = this.formSchema()?.template;
    return template?.business_logic_config?.type === 'poll';
  });

  readonly pollOptions = computed(() => {
    if (!this.isPollTemplate()) return [];

    const config = this.formSchema()?.template?.business_logic_config as any;
    const voteField = config?.voteField;
    if (!voteField) return [];

    const field = this.formSchema()?.fields.find(f => f.id === voteField);
    return field?.options || [];
  });

  /**
   * Handle form submission with poll result display
   */
  onSubmit(): void {
    if (this.formGroup.invalid) {
      this.markAllAsTouched();
      return;
    }

    this.submitting.set(true);
    this.errorMessage.set(null);

    const formData = this.formGroup.value;

    this.formService.submitForm(this.shortCode(), formData).subscribe({
      next: (response) => {
        this.submitting.set(false);

        // Check if response contains poll results
        if (this.isPollTemplate() && response.data?.metadata?.poll_results) {
          const pollData = response.data.metadata.poll_results as PollResults;
          this.pollResults.set(pollData);
          this.showPollResults.set(true);
        } else {
          this.submitSuccess.set(true);
        }
      },
      error: (error) => {
        this.submitting.set(false);
        this.errorMessage.set(error.message || 'Submission failed');
      }
    });
  }
}
```

Update template:

```typescript
@if (showPollResults() && pollResults()) {
  <app-poll-results
    [results]="pollResults()!"
    [options]="pollOptions()"
  />
} @else {
  <!-- Existing form rendering -->
  <form [formGroup]="formGroup" (ngSubmit)="onSubmit()">
    <!-- Form fields -->
  </form>
}
```

---

### Testing Implementation

#### 1. Backend Unit Tests

**File**: `apps/forms-api/tests/unit/services/executors/poll.executor.test.ts`

```typescript
import { PollExecutor } from '../../../../src/services/executors/poll.executor';
import { FormSubmissionsRepository } from '../../../../src/repositories/form-submissions.repository';
import { FormTemplate, FormSubmission, PollLogicConfig } from '@nodeangularfullstack/shared';

describe('PollExecutor', () => {
  let executor: PollExecutor;
  let mockSubmissionsRepo: jest.Mocked<FormSubmissionsRepository>;

  const mockConfig: PollLogicConfig = {
    type: 'poll',
    voteField: 'favorite_color',
    preventDuplicates: true,
    showResultsAfterVote: true,
    trackingMethod: 'session',
  };

  const mockTemplate: FormTemplate = {
    id: 'template-123',
    name: 'Quick Poll',
    category: 'POLLS',
    template_schema: {} as any,
    business_logic_config: mockConfig,
    is_active: true,
    created_at: new Date(),
    updated_at: new Date(),
  };

  const sessionId = 'session-abc123';

  beforeEach(() => {
    mockSubmissionsRepo = {
      checkDuplicateBySession: jest.fn(),
      aggregatePollVotes: jest.fn(),
    } as any;

    executor = new PollExecutor(mockSubmissionsRepo, sessionId);
  });

  describe('validate', () => {
    it('should pass validation for valid vote', async () => {
      mockSubmissionsRepo.checkDuplicateBySession.mockResolvedValue(0);

      const submission = {
        form_id: 'form-123',
        data: {
          favorite_color: 'blue',
        },
      };

      const result = await executor.validate(submission, mockTemplate, mockConfig);

      expect(result.valid).toBe(true);
      expect(result.errors).toEqual([]);
    });

    it('should fail validation for missing vote', async () => {
      const submission = {
        form_id: 'form-123',
        data: {},
      };

      const result = await executor.validate(submission, mockTemplate, mockConfig);

      expect(result.valid).toBe(false);
      expect(result.errors).toContain("Vote field 'favorite_color' is required");
    });

    it('should fail validation for duplicate vote', async () => {
      mockSubmissionsRepo.checkDuplicateBySession.mockResolvedValue(1);

      const submission = {
        form_id: 'form-123',
        data: {
          favorite_color: 'blue',
        },
      };

      const result = await executor.validate(submission, mockTemplate, mockConfig);

      expect(result.valid).toBe(false);
      expect(result.errors).toContain('You have already voted in this poll');
    });

    it('should skip duplicate check when preventDuplicates is false', async () => {
      const configNoDuplicateCheck: PollLogicConfig = {
        ...mockConfig,
        preventDuplicates: false,
      };

      const submission = {
        form_id: 'form-123',
        data: {
          favorite_color: 'blue',
        },
      };

      const result = await executor.validate(submission, mockTemplate, configNoDuplicateCheck);

      expect(result.valid).toBe(true);
      expect(mockSubmissionsRepo.checkDuplicateBySession).not.toHaveBeenCalled();
    });
  });

  describe('execute', () => {
    const mockSubmission: FormSubmission = {
      id: 'sub-123',
      form_id: 'form-123',
      data: {
        favorite_color: 'blue',
      },
      submitted_at: new Date(),
      created_at: new Date(),
    };

    it('should record vote with metadata', async () => {
      mockSubmissionsRepo.aggregatePollVotes.mockResolvedValue([
        { vote_value: 'blue', count: 5 },
        { vote_value: 'red', count: 3 },
        { vote_value: 'green', count: 2 },
      ]);

      const result = await executor.execute(mockSubmission, mockTemplate, mockConfig);

      expect(result.success).toBe(true);
      expect(result.data.session_id).toBe(sessionId);
      expect(result.data.vote_value).toBe('blue');
      expect(result.data.voted_at).toBeDefined();
    });

    it('should include poll results when showResultsAfterVote is true', async () => {
      mockSubmissionsRepo.aggregatePollVotes.mockResolvedValue([
        { vote_value: 'blue', count: 5 },
        { vote_value: 'red', count: 3 },
      ]);

      const result = await executor.execute(mockSubmission, mockTemplate, mockConfig);

      expect(result.data.poll_results).toBeDefined();
      expect(result.data.poll_results.total_votes).toBe(8);
      expect(result.data.poll_results.vote_counts).toEqual({
        blue: 5,
        red: 3,
      });
      expect(result.data.poll_results.vote_percentages).toEqual({
        blue: 63, // 5/8 = 62.5% → 63%
        red: 38, // 3/8 = 37.5% → 38%
      });
    });

    it('should NOT include poll results when showResultsAfterVote is false', async () => {
      const configNoResults: PollLogicConfig = {
        ...mockConfig,
        showResultsAfterVote: false,
      };

      const result = await executor.execute(mockSubmission, mockTemplate, configNoResults);

      expect(result.data.poll_results).toBeUndefined();
    });

    it('should handle poll with zero votes', async () => {
      mockSubmissionsRepo.aggregatePollVotes.mockResolvedValue([]);

      const result = await executor.execute(mockSubmission, mockTemplate, mockConfig);

      expect(result.success).toBe(true);
      expect(result.data.poll_results.total_votes).toBe(0);
    });
  });
});
```

---

#### 2. Backend Integration Tests

**File**: `apps/forms-api/tests/integration/poll-voting.test.ts`

```typescript
import request from 'supertest';
import app from '../../src/server';
import { pool } from '../../src/config/database';
import { PoolClient } from 'pg';

describe('Poll Voting Integration Tests', () => {
  let client: PoolClient;
  let formShortCode: string;

  beforeAll(async () => {
    client = await pool.connect();
    await client.query('BEGIN');

    // Create poll template
    const templateResult = await client.query(`
      INSERT INTO form_templates (name, category, template_schema, business_logic_config, is_active)
      VALUES (
        'Test Poll',
        'POLLS',
        '{"fields": [{"id": "vote", "type": "RADIO", "options": [{"label": "Option A", "value": "a"}, {"label": "Option B", "value": "b"}]}]}'::jsonb,
        '{"type": "poll", "voteField": "vote", "preventDuplicates": true, "showResultsAfterVote": true, "trackingMethod": "session"}'::jsonb,
        true
      )
      RETURNING id
    `);

    const templateId = templateResult.rows[0].id;

    // Create form with template
    const formResult = await client.query(
      `
      INSERT INTO forms (title, is_published, template_id)
      VALUES ('Poll Test Form', true, $1)
      RETURNING id
    `,
      [templateId]
    );

    const formId = formResult.rows[0].id;

    // Create short link
    const shortLinkResult = await client.query(
      `
      INSERT INTO short_links (short_code, form_schema_id)
      VALUES ('poll-test', $1)
      RETURNING short_code
    `,
      [formId]
    );
    formShortCode = shortLinkResult.rows[0].short_code;

    await client.query('COMMIT');
  });

  afterAll(async () => {
    await client.query('ROLLBACK');
    client.release();
    await pool.end();
  });

  describe('POST /api/public/forms/:shortCode/submit', () => {
    it('should record vote and return results', async () => {
      const agent = request.agent(app);

      const response = await agent
        .post(`/api/public/forms/${formShortCode}/submit`)
        .send({ vote: 'a' });

      expect(response.status).toBe(200);
      expect(response.body.success).toBe(true);
      expect(response.body.data.metadata.vote_value).toBe('a');
      expect(response.body.data.metadata.poll_results).toBeDefined();
      expect(response.body.data.metadata.poll_results.total_votes).toBeGreaterThan(0);
    });

    it('should reject duplicate vote from same session', async () => {
      const agent = request.agent(app);

      // First vote
      await agent.post(`/api/public/forms/${formShortCode}/submit`).send({ vote: 'a' });

      // Second vote (duplicate)
      const response = await agent
        .post(`/api/public/forms/${formShortCode}/submit`)
        .send({ vote: 'b' });

      expect(response.status).toBe(400);
      expect(response.body.message).toContain('already voted');
    });

    it('should allow votes from different sessions', async () => {
      const agent1 = request.agent(app);
      const agent2 = request.agent(app);

      const response1 = await agent1
        .post(`/api/public/forms/${formShortCode}/submit`)
        .send({ vote: 'a' });

      const response2 = await agent2
        .post(`/api/public/forms/${formShortCode}/submit`)
        .send({ vote: 'b' });

      expect(response1.status).toBe(200);
      expect(response2.status).toBe(200);
    });
  });

  describe('GET /api/public/forms/:shortCode/poll-results', () => {
    it('should return aggregated poll results', async () => {
      const response = await request(app).get(`/api/public/forms/${formShortCode}/poll-results`);

      expect(response.status).toBe(200);
      expect(response.body.success).toBe(true);
      expect(response.body.data.total_votes).toBeGreaterThan(0);
      expect(response.body.data.vote_counts).toBeDefined();
      expect(response.body.data.vote_percentages).toBeDefined();
    });
  });
});
```

---

### Template Seed Data

**File**: `apps/forms-api/database/seeds/034_seed_poll_template.ts`

```typescript
import { Pool } from 'pg';

/**
 * Seed quick poll template
 * @since Epic 29, Story 29.14
 */
export async function seedPollTemplate(pool: Pool): Promise<void> {
  const client = await pool.connect();

  try {
    await client.query('BEGIN');

    // Check if template already exists
    const existing = await client.query(`SELECT id FROM form_templates WHERE name = 'Quick Poll'`);

    if (existing.rows.length > 0) {
      console.log('Quick Poll template already exists, skipping...');
      await client.query('COMMIT');
      return;
    }

    // Create template
    const templateSchema = {
      fields: [
        {
          id: 'poll_question',
          type: 'RADIO',
          label: 'What is your favorite programming language?',
          required: true,
          options: [
            { label: 'JavaScript', value: 'javascript' },
            { label: 'Python', value: 'python' },
            { label: 'Java', value: 'java' },
            { label: 'TypeScript', value: 'typescript' },
            { label: 'Go', value: 'go' },
            { label: 'Rust', value: 'rust' },
          ],
          order: 1,
        },
      ],
    };

    const businessLogicConfig = {
      type: 'poll',
      voteField: 'poll_question',
      preventDuplicates: true,
      showResultsAfterVote: true,
      trackingMethod: 'session',
      allowChangeVote: false,
    };

    await client.query(
      `
      INSERT INTO form_templates (
        name,
        category,
        description,
        template_schema,
        business_logic_config,
        is_active
      ) VALUES ($1, $2, $3, $4, $5, $6)
    `,
      [
        'Quick Poll',
        'POLLS',
        'Simple poll template with duplicate vote prevention and real-time results',
        JSON.stringify(templateSchema),
        JSON.stringify(businessLogicConfig),
        true,
      ]
    );

    console.log('✓ Quick Poll template seeded successfully');

    await client.query('COMMIT');
  } catch (error) {
    await client.query('ROLLBACK');
    console.error('Error seeding poll template:', error);
    throw error;
  } finally {
    client.release();
  }
}
```

---

## Tasks

| ID        | Task                                                                     | Acceptance Criteria | Estimated Hours |
| --------- | ------------------------------------------------------------------------ | ------------------- | --------------- |
| 1         | Extend shared types with `PollLogicConfig` and `PollVoteMetadata`        | AC3                 | 1.0             |
| 2         | Verify session middleware integration                                    | IV2                 | 1.5             |
| 3         | Add `checkDuplicateBySession()` and `aggregatePollVotes()` to repository | AC5, AC7            | 2.5             |
| 4         | Create `PollExecutor` strategy class implementing `ITemplateExecutor`    | AC4, AC5, AC6       | 3.5             |
| 5         | Integrate `PollExecutor` into `FormsService` with session ID parameter   | AC7                 | 2.0             |
| 6         | Create `/api/public/forms/:shortCode/poll-results` endpoint              | AC7                 | 2.0             |
| 7         | Extend `FormRendererService` with `getPollResults()` method              | AC8                 | 1.0             |
| 8         | Create `PollResultsComponent` with Chart.js horizontal bar chart         | AC8                 | 5.0             |
| 9         | Integrate `PollResultsComponent` with `FormRendererComponent`            | AC8                 | 1.5             |
| 10        | Write backend unit tests for `PollExecutor`                              | AC4-AC7             | 3.0             |
| 11        | Write backend integration tests with session handling                    | IV2                 | 3.0             |
| 12        | Write frontend component tests for `PollResultsComponent`                | AC8                 | 2.0             |
| 13        | Create seed data for poll template                                       | AC1, AC2            | 1.5             |
| 14        | Write performance tests validating execution times                       | IV2                 | 1.5             |
| **Total** |                                                                          |                     | **31.0 hours**  |

---

## QA Results

_To be updated during development_

| Test Type         | Status  | Coverage                    | Notes |
| ----------------- | ------- | --------------------------- | ----- |
| Unit Tests        | Pending | Target: 90%+                | -     |
| Integration Tests | Pending | -                           | -     |
| Component Tests   | Pending | Target: 85%+                | -     |
| Performance Tests | Pending | Vote: 100ms, Results: 150ms | -     |

---

## Gate Status

**Quality Gate**: ❌ Not Started

**Checklist**:

- [ ] All unit tests passing (90%+ coverage for executor)
- [ ] All integration tests passing (including session-based duplicate detection)
- [ ] All component tests passing (poll results + chart rendering)
- [ ] Performance requirements met (100ms vote, 150ms aggregation)
- [ ] Session middleware integration working correctly
- [ ] Chart.js integration working without regressions
- [ ] Code reviewed and approved
- [ ] TypeScript strict mode passing with no errors
- [ ] ESLint passing with no warnings

---

## Related Documentation

- **PRD**: docs/prd/epic-29-form-templates-system.md
- **Architecture**: docs/architecture/backend-architecture.md (Session Management, Strategy Pattern)
- **Architecture**: docs/architecture/frontend-architecture.md (Chart.js Integration)
- **Related Stories**:
  - Story 29.11: Product Template with Inventory Tracking (Base ITemplateExecutor Interface)
  - Story 29.13: Quiz Template with Scoring Logic (Similar in-memory pattern)
  - Story 29.15: Restaurant Menu Template (Next story)
- **Gate File**: docs/qa/gates/29.14-poll-template-vote-aggregation.yml (to be created)

---

## Notes

### Session-Based Tracking

**Why Session IDs**: Using Express session middleware provides:

- **Simplicity**: No additional authentication required
- **Persistence**: Sessions stored in PostgreSQL (survives server restarts)
- **Privacy**: No personal data collected (no email, no OAuth)
- **Cross-Browser**: Session cookies work across browsers and devices
- **Existing Infrastructure**: Reuses middleware already in place

**Alternative Tracking Methods** (configurable via `trackingMethod`):

- `ip`: Track by IP address (less reliable with proxies/VPNs)
- `fingerprint`: Track by browser fingerprint (requires additional library)
- `session`: Default and recommended (uses Express session)

### Vote Aggregation Performance

**JSONB Query Optimization**:

- Uses `data->>fieldId` operator for fast JSONB extraction
- `GROUP BY` aggregation runs on indexed submission data
- Query completes in < 150ms for 10,000+ votes

**Caching Strategy** (future enhancement):

- Poll results could be cached in Redis for high-traffic polls
- Cache invalidation on new vote submission
- TTL: 30 seconds (balance freshness vs. performance)

### Chart.js Integration

**Horizontal Bar Chart**: Best visualization for poll results:

- Clear label display for long option names
- Easy comparison of vote counts
- Mobile-friendly (vertical scrolling)
- Color-coded bars for visual distinction

### Privacy Considerations

**Anonymous Voting**: No user identification required:

- Session IDs are opaque (not tied to user accounts)
- IP addresses optionally collected (not exposed in UI)
- Vote data stored without personally identifiable information

---

_Story created: 2025-01-09_ _Last updated: 2025-01-09_
