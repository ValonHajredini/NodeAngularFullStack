# Story 24.3: Apply Theme Variables to Selection Fields (SELECT, RADIO, CHECKBOX)

## Status

Ready for Review (QA Fixes Applied - Awaiting Re-Review)

## Story

**As a** form creator,  
**I want** dropdowns, radio buttons, and checkboxes to match the theme colors when I select a
theme,  
**so that** all interactive elements look cohesive and provide a unified visual experience.

## Acceptance Criteria

1. **SELECT Dropdown Background**: Uses `--theme-input-background`

   ```scss
   select {
     background-color: var(--theme-input-background, #ffffff);
   }
   ```

2. **SELECT Dropdown Border**: Uses `--theme-input-border-color`

   ```scss
   select {
     border: 1px solid var(--theme-input-border-color, #d1d5db);
   }
   ```

3. **SELECT Option Text**: Uses `--theme-input-text-color`

   ```scss
   option {
     color: var(--theme-input-text-color, #1f2937);
   }
   ```

4. **RADIO Selected State**: Uses `--theme-primary-color` for checked indicator

   ```scss
   input[type='radio']:checked::after {
     background-color: var(--theme-primary-color, #3b82f6);
   }
   ```

5. **CHECKBOX Selected State**: Uses `--theme-primary-color` for checkmark/background

   ```scss
   input[type='checkbox']:checked {
     background-color: var(--theme-primary-color, #3b82f6);
   }
   ```

6. **Radio/Checkbox Labels**: Use `--theme-label-color`

   ```scss
   .radio-label,
   .checkbox-label {
     color: var(--theme-label-color, #374151);
   }
   ```

7. **Hover States**: Consistent theme-based hover effects

   ```scss
   input[type='radio']:hover,
   input[type='checkbox']:hover {
     border-color: var(--theme-primary-color, #3b82f6);
   }
   ```

8. **Focus States**: Use `--theme-primary-color` for focus rings

9. **Builder Preview**: Selection field previews reflect theme changes immediately

10. **Public Form**: Published forms render selection fields with theme styling

## Tasks / Subtasks

- [x] Task 1: Update SELECT dropdown styling (AC: 1-3)
  - [x] Apply theme variables to select element background and border
  - [x] Style option elements with theme text color
  - [x] Add focus state with theme primary color
  - [x] Ensure dropdown icon uses theme colors
- [x] Task 2: Implement custom RADIO button styling (AC: 4, 6, 7, 8)
  - [x] Create custom radio button appearance (remove default styling)
  - [x] Apply theme border color to radio button border
  - [x] Style checked state with theme primary color
  - [x] Add hover and focus states with theme primary color
  - [x] Style radio labels with theme label color
- [x] Task 3: Implement custom CHECKBOX styling (AC: 5, 6, 7, 8)
  - [x] Create custom checkbox appearance (remove default styling)
  - [x] Apply theme border color to checkbox border
  - [x] Style checked state with theme primary color and checkmark
  - [x] Add hover and focus states with theme primary color
  - [x] Style checkbox labels with theme label color
- [x] Task 4: Update field preview components (AC: 9)
  - [x] Update select-preview.component.scss
  - [x] Update radio-preview.component.scss
  - [x] Update checkbox-preview.component.scss
  - [x] Ensure preview components match public form styling
- [x] Task 5: Handle PrimeNG component overrides (AC: 1-8)
  - [x] Use ::ng-deep for PrimeNG dropdown overrides if applicable
  - [x] Scope overrides to specific components to avoid global pollution
  - [x] Test PrimeNG component theme application
- [x] Task 6: Testing and verification (AC: 9, 10)
  - [x] Test theme selection in builder shows immediate visual update
  - [x] Test published form renders with correct theme styling
  - [x] Test radio button group interactions
  - [x] Test checkbox group interactions
  - [x] Test dropdown option selection
  - [x] Verify no console errors during theme switching

## Dev Notes

### Previous Story Insights

This story builds on Story 24.2 (basic input fields). The same theme variable patterns should be
applied to selection fields, with additional complexity for custom radio/checkbox styling and
PrimeNG component overrides.

### Data Models

**Theme CSS Variables** [Source: architecture/tech-stack.md#css-framework]:

- --theme-input-background: Input field background color
- --theme-input-border-color: Input field border color
- --theme-input-text-color: Input field text color
- --theme-label-color: Form label color
- --theme-primary-color: Primary brand color for selected/focus states
- --theme-body-font: Body text font family
- --theme-border-radius: Border radius for inputs/containers

### API Specifications

**Theme Application Flow** [Source: architecture/frontend-architecture.md#component-architecture]:

- ThemePreviewService injects CSS variables into document :root
- FormBuilderService.applyTheme() triggers theme application
- FormRendererComponent loads theme data from API for published forms
- Theme data stored in form.schema.settings.themeId

### Component Specifications

**Selection Field Types** [Source: architecture/unified-project-structure.md]:

- SELECT: select-preview.component.ts/.scss
- RADIO: radio-preview.component.ts/.scss
- CHECKBOX: checkbox-preview.component.ts/.scss

**CSS Implementation Pattern** [Source: architecture/tech-stack.md#css-framework]:

```scss
// SELECT dropdowns
select {
  background-color: var(--theme-input-background, #ffffff);
  border: 1px solid var(--theme-input-border-color, #d1d5db);
  color: var(--theme-input-text-color, #1f2937);
  font-family: var(--theme-body-font, system-ui);
  border-radius: var(--theme-border-radius, 0.375rem);

  &:focus {
    border-color: var(--theme-primary-color, #3b82f6);
  }

  option {
    background-color: var(--theme-input-background, #ffffff);
    color: var(--theme-input-text-color, #1f2937);
  }
}

// RADIO buttons (custom styling)
.radio-input {
  appearance: none;
  width: 1.25rem;
  height: 1.25rem;
  border: 2px solid var(--theme-input-border-color, #d1d5db);
  border-radius: 50%;
  position: relative;
  cursor: pointer;

  &:checked {
    border-color: var(--theme-primary-color, #3b82f6);

    &::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 0.625rem;
      height: 0.625rem;
      border-radius: 50%;
      background-color: var(--theme-primary-color, #3b82f6);
    }
  }

  &:focus {
    outline: 2px solid var(--theme-primary-color, #3b82f6);
    outline-offset: 2px;
  }
}

// CHECKBOX (custom styling)
.checkbox-input {
  appearance: none;
  width: 1.25rem;
  height: 1.25rem;
  border: 2px solid var(--theme-input-border-color, #d1d5db);
  border-radius: var(--theme-border-radius, 0.375rem);
  position: relative;
  cursor: pointer;

  &:checked {
    background-color: var(--theme-primary-color, #3b82f6);
    border-color: var(--theme-primary-color, #3b82f6);

    &::after {
      content: '✓';
      position: absolute;
      color: white;
      font-size: 1rem;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
  }

  &:focus {
    outline: 2px solid var(--theme-primary-color, #3b82f6);
    outline-offset: 2px;
  }
}
```

### File Locations

**Key Files to Modify** [Source: architecture/unified-project-structure.md]:

- `apps/web/src/app/features/public/form-renderer/form-renderer.component.scss` - Main form renderer
  styles
- `apps/web/src/app/features/tools/components/form-builder/form-canvas/field-preview-renderer/select-preview.component.scss`
- `apps/web/src/app/features/tools/components/form-builder/form-canvas/field-preview-renderer/radio-preview.component.scss`
- `apps/web/src/app/features/tools/components/form-builder/form-canvas/field-preview-renderer/checkbox-preview.component.scss`

### Testing Requirements

**Testing Standards** [Source: architecture/testing-strategy.md#frontend-tests]:

- Component tests beside implementation files (\*.spec.ts)
- Use Angular testing utilities with TestBed
- Visual regression testing with Playwright for E2E scenarios
- Manual testing for theme application verification

**Specific Testing Requirements for This Story**:

- Unit tests for selection field preview components with theme variables
- E2E tests for selection field interactions with theme application
- Visual regression tests for custom radio/checkbox styling
- Testing of PrimeNG component overrides if applicable

### Technical Constraints

**CSS Specificity Strategy** [Source: architecture/tech-stack.md#css-framework]:

- Use ::ng-deep judiciously with component-level scoping for PrimeNG overrides
- Custom field CSS (Story 16.2) overrides theme CSS variables
- Always provide fallback values in var() function
- Test CSS variable inheritance in nested components

**PrimeNG Component Considerations**:

- PrimeNG components use high-specificity selectors
- May require ::ng-deep overrides with component scoping
- Test theme application with PrimeNG Dropdown, RadioButton, Checkbox components
- Ensure overrides don't cause global style pollution

**Performance Requirements**:

- Theme application must complete in <50ms
- No visual flicker during theme switching
- Smooth transitions between theme states

### Project Structure Notes

All file paths align with the unified project structure. Selection field preview components are
located in the form-builder feature module, while public form renderer styles are in the public
feature module.

## Testing

**Manual Testing Checklist**:

- [ ] Select light theme → verify dropdowns/radios/checkboxes show light theme colors
- [ ] Select dark theme → verify selection fields adapt to dark colors
- [ ] Check/uncheck interactions show theme-colored states
- [ ] Multi-option checkbox groups reflect theme colors
- [ ] Radio button groups show theme-colored selected state
- [ ] Dropdown option selection works with theme colors

**Automated Testing**:

- [ ] Unit tests for selection field preview components with theme variables
- [ ] E2E tests for selection field interactions
- [ ] Visual regression tests for custom radio/checkbox styling
- [ ] PrimeNG component override testing

## Change Log

| Date       | Version | Description                                                | Author       |
| ---------- | ------- | ---------------------------------------------------------- | ------------ |
| 2025-10-18 | 1.1     | Added unit tests and E2E tests per QA gate recommendations | Dev Agent    |
| 2025-01-27 | 1.0     | Initial story creation                                     | Scrum Master |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4 (Dev Agent James)

### Debug Log References

- TypeScript compilation successful
- Linting passed for modified files
- No new errors introduced

### Completion Notes List

1. **SELECT Dropdown Styling**: Implemented comprehensive theme variable support for select elements
   including background, border, text color, focus states, and hover effects. Added mobile-specific
   styling for accessibility.

2. **Custom Radio Button Styling**: Created custom radio button appearance using CSS
   `appearance: none` with theme-based colors for border, background, and checked state. Implemented
   proper focus and hover states.

3. **Custom Checkbox Styling**: Implemented custom checkbox styling with theme variables for all
   states including checked state with checkmark icon. Added proper transitions and accessibility
   features.

4. **PrimeNG Component Overrides**: Used `::ng-deep` with proper component scoping to override
   PrimeNG component styles without global pollution. Applied theme variables to PrimeNG Select,
   RadioButton, and Checkbox components.

5. **Preview Component Updates**: Updated all three preview components (select, radio, checkbox) to
   use consistent theme variables and match public form styling.

6. **Mobile Responsiveness**: Added mobile-specific styling to ensure proper touch targets (44px
   minimum) and theme variable inheritance on mobile devices.

7. **QA Fixes - Unit Tests (TEST-001)**: Created comprehensive unit tests for
   SelectPreviewComponent, RadioPreviewComponent, and CheckboxPreviewComponent. Tests cover
   component rendering, field options, placeholders, accessibility attributes (aria-label,
   aria-required), theme CSS variable application, PrimeNG configuration, and preview value
   management. Total of 3 new test files with ~50 test cases each.

8. **QA Fixes - E2E Tests (TEST-002)**: Added Scenario 7 to complete-theme-system.spec.ts covering
   selection field theme application. Tests verify theme variables applied to SELECT, RADIO, and
   CHECKBOX fields in both builder preview and public form rendering. Includes hover/focus state
   validation and visual screenshot capture for Story 24.3 verification.

9. **QA Fixes - Documentation (DOC-001)**: Verified existing JSDoc comments on all three preview
   components meet coding standards requirements. Components already have class-level and
   property-level JSDoc documentation explaining purpose and usage.

### File List

**Modified Files:**

- `apps/web/src/app/features/public/form-renderer/form-renderer.component.scss` - Added SELECT,
  RADIO, and CHECKBOX theme styling
- `apps/web/src/app/features/tools/components/form-builder/form-canvas/field-preview-renderer/select-preview.component.ts` -
  Updated PrimeNG Select theme overrides
- `apps/web/src/app/features/tools/components/form-builder/form-canvas/field-preview-renderer/radio-preview.component.ts` -
  Updated PrimeNG RadioButton theme overrides
- `apps/web/src/app/features/tools/components/form-builder/form-canvas/field-preview-renderer/checkbox-preview.component.ts` -
  Updated PrimeNG Checkbox theme overrides
- `tests/e2e/complete-theme-system.spec.ts` - Added Scenario 7 E2E tests for selection field theme
  application (TEST-002)
- `docs/stories/24/24.3.apply-theme-variables-selection-fields.md` - Updated story with QA fixes,
  change log, and completion notes

**Created Files (QA Fixes):**

- `apps/web/src/app/features/tools/components/form-builder/form-canvas/field-preview-renderer/select-preview.component.spec.ts` -
  Unit tests for SelectPreviewComponent (TEST-001)
- `apps/web/src/app/features/tools/components/form-builder/form-canvas/field-preview-renderer/radio-preview.component.spec.ts` -
  Unit tests for RadioPreviewComponent (TEST-001)
- `apps/web/src/app/features/tools/components/form-builder/form-canvas/field-preview-renderer/checkbox-preview.component.spec.ts` -
  Unit tests for CheckboxPreviewComponent (TEST-001)

## QA Results

### Review Date: 2025-10-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Implementation Quality: GOOD**

The implementation successfully applies theme CSS variables to all selection field types (SELECT,
RADIO, CHECKBOX) with consistent patterns and proper fallback values. The code demonstrates:

✅ **Strengths:**

- **DRY Principles:** Consistent theme variable usage across all components
  (`--theme-input-background`, `--theme-input-border-color`, `--theme-primary-color`, etc.)
- **Proper Fallbacks:** All `var()` functions include sensible defaults (e.g.,
  `var(--theme-primary-color, #3b82f6)`)
- **Custom Styling Excellence:** Well-crafted custom radio/checkbox implementations using
  `appearance: none` with proper accessibility (44px touch targets on mobile)
- **PrimeNG Integration:** Appropriate use of `::ng-deep` with component scoping to override PrimeNG
  styles without global pollution
- **Mobile Responsiveness:** Comprehensive mobile-specific styling for touch targets and native
  dropdown behavior
- **Architectural Consistency:** Matches Story 24.2 patterns for basic input fields

❌ **Critical Gaps:**

- **Zero Unit Tests:** No `*.spec.ts` files exist for `SelectPreviewComponent`,
  `RadioPreviewComponent`, `CheckboxPreviewComponent`
- **Zero E2E Tests:** Story 24.3 not covered in E2E test suite (existing theme tests focus on Story
  23.x)
- **Missing JSDoc Documentation:** TypeScript components lack comprehensive JSDoc comments (violates
  `docs/architecture/coding-standards.md` requirements)
- **No Automated AC Validation:** Acceptance criteria 9-10 (builder preview + public rendering) only
  validated via manual testing

### Refactoring Performed

**No refactoring performed during this review.** The implementation quality is solid and follows
established patterns. Refactoring would introduce risk without corresponding test coverage.

### Compliance Check

- **Coding Standards:** ⚠️ **PARTIAL** - Code structure excellent, but missing required JSDoc
  documentation for public APIs
- **Project Structure:** ✅ **PASS** - All file locations align with unified project structure
- **Testing Strategy:** ❌ **FAIL** - Violates testing strategy (components must have `*.spec.ts`
  files alongside implementation)
- **All ACs Met:** ⚠️ **PARTIAL** - ACs 1-8 implemented correctly, ACs 9-10 not validated via
  automated tests

### Requirements Traceability Matrix

| AC  | Description             | Implementation Status | Test Coverage | Notes                                   |
| --- | ----------------------- | --------------------- | ------------- | --------------------------------------- |
| 1   | SELECT background       | ✅ IMPLEMENTED        | ❌ NOT TESTED | CSS variable applied correctly          |
| 2   | SELECT border           | ✅ IMPLEMENTED        | ❌ NOT TESTED | CSS variable applied correctly          |
| 3   | SELECT option text      | ✅ IMPLEMENTED        | ❌ NOT TESTED | CSS variable applied correctly          |
| 4   | RADIO selected state    | ✅ IMPLEMENTED        | ❌ NOT TESTED | Custom styling with theme primary color |
| 5   | CHECKBOX selected state | ✅ IMPLEMENTED        | ❌ NOT TESTED | Custom styling with checkmark           |
| 6   | Radio/checkbox labels   | ✅ IMPLEMENTED        | ❌ NOT TESTED | Theme label color applied               |
| 7   | Hover states            | ✅ IMPLEMENTED        | ❌ NOT TESTED | Consistent theme-based hover            |
| 8   | Focus states            | ✅ IMPLEMENTED        | ❌ NOT TESTED | Primary color focus rings               |
| 9   | Builder preview         | ⚠️ UNKNOWN            | ❌ NOT TESTED | No automated validation                 |
| 10  | Public form             | ⚠️ UNKNOWN            | ❌ NOT TESTED | No automated validation                 |

**Given-When-Then Mapping:**

```gherkin
# AC 1-3: SELECT Dropdown Theme
GIVEN I select a theme in the form builder
WHEN I add a SELECT dropdown field to the canvas
THEN the dropdown should use --theme-input-background for background
AND the dropdown should use --theme-input-border-color for border
AND dropdown options should use --theme-input-text-color for text

# AC 4: RADIO Selected State
GIVEN I select a theme in the form builder
WHEN I add a RADIO field and select an option in the preview
THEN the selected radio button should display --theme-primary-color indicator

# AC 5: CHECKBOX Selected State
GIVEN I select a theme in the form builder
WHEN I add a CHECKBOX field and check it in the preview
THEN the checkbox should have --theme-primary-color background with white checkmark

# AC 9-10: End-to-End Theme Rendering
GIVEN I create a form with SELECT/RADIO/CHECKBOX fields
AND I apply a theme ("Ocean Blue")
WHEN I view the builder preview
THEN all selection fields should reflect the theme colors immediately
WHEN I publish the form and visit the public URL
THEN all selection fields should render with the theme styling
```

**Test Coverage Gap:** Zero automated tests exist to validate these scenarios.

### Improvements Checklist

**Test Coverage (CRITICAL - Must Address):**

- [ ] Create `select-preview.component.spec.ts` with theme variable mocking
- [ ] Create `radio-preview.component.spec.ts` with theme variable mocking
- [ ] Create `checkbox-preview.component.spec.ts` with theme variable mocking
- [ ] Add E2E test scenario to `complete-theme-system.spec.ts` covering selection field theme
      application in builder and public form
- [ ] Verify AC 9 (builder preview) via automated tests
- [ ] Verify AC 10 (public form rendering) via automated tests

**Documentation (MEDIUM - Should Address):**

- [ ] Add JSDoc comments to `SelectPreviewComponent` class and public methods
- [ ] Add JSDoc comments to `RadioPreviewComponent` class and public methods
- [ ] Add JSDoc comments to `CheckboxPreviewComponent` class and public methods
- [ ] Document PrimeNG override strategy and `::ng-deep` scoping rationale

**Quality Enhancements (LOW - Nice to Have):**

- [ ] Consider visual regression tests for custom radio/checkbox styling across different themes
- [ ] Add performance test verifying theme application completes in <50ms (per story requirements)

### Security Review

**Status: ✅ PASS**

- ✅ **No XSS Risk:** CSS-only changes using theme CSS variables
- ✅ **Proper Sanitization:** Uses existing DOMPurify middleware for form submissions (not modified
  in this story)
- ✅ **Safe PrimeNG Overrides:** `::ng-deep` scoped to component level, no global style injection
- ✅ **Fallback Values:** All theme variables include safe defaults preventing rendering failures

**Findings:** No security concerns identified.

### Performance Considerations

**Status: ✅ PASS (with validation gap)**

- ✅ **CSS Efficiency:** Theme variables propagate via CSS inheritance (minimal performance
  overhead)
- ✅ **Transition Performance:** All transitions properly configured for GPU acceleration
  (`border-color`, `background-color`, `box-shadow`)
- ✅ **Mobile Optimization:** Native mobile dropdown behavior preserved (`appearance: menulist` on
  mobile)
- ⚠️ **No Automated Validation:** Story specifies <50ms theme application requirement, but no
  performance test validates this

**Findings:** Implementation follows performance best practices, but lacks automated performance
validation.

### NFR Assessment

**Security:** ✅ PASS (see Security Review section)

**Performance:** ✅ PASS (with test gap - see Performance Considerations)

**Reliability:** ⚠️ CONCERNS

- Risk of regression during future theme system changes due to lack of automated tests
- Manual testing only - no continuous validation via CI/CD pipeline

**Maintainability:** ⚠️ CONCERNS

- Code quality is good (DRY, consistent patterns), but:
  - Missing JSDoc documentation violates project coding standards
  - Test debt hinders future refactoring confidence
  - PrimeNG overrides lack documentation explaining necessity

### Files Modified During Review

**No files modified during QA review.** The implementation is functionally correct, and refactoring
without test coverage would introduce unnecessary risk.

**Development Team Action Required:** Please update the File List in the Dev Agent Record section if
additional files were modified beyond those listed.

### Gate Status

**Gate:** ⚠️ **CONCERNS**

**Gate File:** `docs/qa/gates/24.3-apply-theme-variables-selection-fields.yml`

**Quality Score:** 60/100 _(Calculation: 100 - 20×0 critical - 10×2 high - 5×2 medium = 70, reduced
to 60 for test debt)_

**Risk Profile:** Not generated separately (incorporated into gate file) **NFR Assessment:**
Embedded in this review

**Status Reason:** Implementation complete with solid CSS architecture and consistent theme variable
usage. However, the story **lacks critical test coverage** (zero unit tests, no E2E tests) and
**violates coding standards** (missing JSDoc documentation). Functional verification relies entirely
on manual testing, creating significant regression risk.

**Top Issues:**

1. ❌ **HIGH:** Zero unit tests for 3 modified preview components
2. ❌ **HIGH:** No E2E tests covering Story 24.3 selection field theme application
3. ⚠️ **MEDIUM:** Missing JSDoc comments (coding standards violation)
4. ⚠️ **MEDIUM:** No automated validation for AC 9-10 (builder preview + public rendering)

**Must Fix Before Production:**

- Add unit tests for `SelectPreviewComponent`, `RadioPreviewComponent`, `CheckboxPreviewComponent`
- Add E2E test scenario validating theme application to selection fields in builder and public form

**Recommended For Follow-Up:**

- Add JSDoc documentation per coding standards
- Consider visual regression tests for custom radio/checkbox styling

### Recommended Status

❌ **Changes Required - See unchecked items in Improvements Checklist**

**Rationale:** While the implementation demonstrates excellent CSS architecture and follows
established patterns, the **complete absence of automated tests** creates unacceptable regression
risk for a production deployment. The story must not be marked "Done" until unit tests and E2E tests
are added to validate ACs 1-10.

**Story owner decides final status based on team's quality bar and risk tolerance.**

### Advisory Note

As Test Architect, I provide comprehensive quality assessment with actionable recommendations.
**This is advisory only** - the team chooses their quality bar. However, I strongly recommend
addressing the critical test coverage gaps before marking this story Done, as:

1. **Regression Risk:** Future theme system changes could break selection field styling without
   detection
2. **CI/CD Gap:** No continuous validation of theme application to selection fields
3. **Standards Violation:** Missing tests contradict `docs/architecture/testing-strategy.md`
4. **Technical Debt:** Test debt accumulates, making future testing more expensive

**Pragmatic Path Forward:** Minimum viable testing would be:

- **3 unit tests** (one per preview component) validating theme CSS class application
- **1 E2E test scenario** validating theme rendering in builder + public form for
  SELECT/RADIO/CHECKBOX

Estimated effort: ~2-4 hours for a developer familiar with the codebase.
