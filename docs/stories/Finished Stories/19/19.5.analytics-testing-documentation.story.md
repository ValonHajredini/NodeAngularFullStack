# Story 19.5: Analytics, Testing, and Documentation

## Status

Approved

## Story

**As a** development team and form builder administrator, **I want** comprehensive analytics,
testing, and documentation for step forms, **so that** we can track user engagement, ensure quality,
and maintain the feature effectively.

## Acceptance Criteria

1. Analytics dashboard shows step completion rates per step
2. Drop-off chart visualizes where users abandon step forms
3. All integration tests pass for step form CRUD operations
4. E2E tests cover complete step form lifecycle (create → publish → submit)
5. Performance tests verify no degradation with complex step forms
6. CLAUDE.md includes comprehensive step form documentation
7. All public APIs have JSDoc comments
8. Developer guide explains step form extension points
9. Overall test coverage remains >80%

## Tasks / Subtasks

- [ ] **Task 1: Extend StatisticsEngineService for step analytics** (AC: 1, 2)
  - [ ] Update
        `apps/web/src/app/features/tools/components/form-builder/statistics-engine.service.ts`
  - [ ] Add interface for step statistics:

    ```typescript
    export interface StepCompletionStats {
      stepId: string;
      stepTitle: string;
      stepOrder: number;
      totalStarted: number; // Users who reached this step
      totalCompleted: number; // Users who completed this step (clicked Next or Submit)
      completionRate: number; // Percentage (completed / started * 100)
      dropOffCount: number; // Users who abandoned at this step
      dropOffRate: number; // Percentage (dropOff / started * 100)
    }

    export interface StepFormAnalytics {
      isStepForm: boolean;
      totalSteps: number;
      overallCompletionRate: number; // Percentage who completed all steps
      stepStats: StepCompletionStats[];
      funnelData: { step: string; count: number }[]; // For funnel visualization
    }
    ```

  - [ ] Add method
        `calculateStepAnalytics(submissions: FormSubmission[], formSchema: FormSchema): StepFormAnalytics`
  - [ ] Implementation logic:
    - Detect if form is step form from schema
    - Track step-level events from submission metadata (if available)
    - Calculate completion rates for each step
    - Identify drop-off points (steps where users stopped)
    - Generate funnel visualization data
  - [ ] Add JSDoc documentation for new interfaces and methods

- [ ] **Task 2: Update backend to track step navigation events** (AC: 1, 2)
  - [ ] Add optional `stepEvents` field to FormSubmission metadata:

    ```typescript
    // In packages/shared/src/types/forms.types.ts
    export interface FormSubmission {
      id: string;
      formSchemaId: string;
      values: Record<string, unknown>;
      submittedAt: Date;
      submitterIp: string;
      userId?: string;
      metadata?: {
        stepEvents?: StepNavigationEvent[]; // NEW
        [key: string]: unknown;
      };
    }

    export interface StepNavigationEvent {
      stepId: string;
      stepOrder: number;
      action: 'view' | 'next' | 'previous' | 'submit';
      timestamp: Date;
    }
    ```

  - [ ] Run `npm run build:shared` to compile
  - [ ] No backend changes required (metadata stored as JSONB)

- [ ] **Task 3: Update FormRendererComponent to track step events** (AC: 1, 2)
  - [ ] Add signal: `private stepEvents = signal<StepNavigationEvent[]>([])`
  - [ ] Track events in navigation methods:

    ```typescript
    goToNextStep(): void {
      this.recordStepEvent('next');
      // ... existing navigation logic
    }

    goToPreviousStep(): void {
      this.recordStepEvent('previous');
      // ... existing navigation logic
    }

    onSubmit(): void {
      this.recordStepEvent('submit');
      // ... existing submission logic
    }

    private recordStepEvent(action: 'view' | 'next' | 'previous' | 'submit'): void {
      const currentStep = this.currentStep();
      if (!currentStep) return;

      this.stepEvents.update(events => [
        ...events,
        {
          stepId: currentStep.id,
          stepOrder: currentStep.order,
          action,
          timestamp: new Date()
        }
      ]);
    }
    ```

  - [ ] Include step events in submission payload:
    ```typescript
    submitForm(): void {
      const submissionData = {
        values: this.formGroup.value,
        metadata: {
          stepEvents: this.stepEvents()
        }
      };
      this.formRendererService.submitForm(submissionData).subscribe(/* ... */);
    }
    ```

- [ ] **Task 4: Create step analytics dashboard component** (AC: 1, 2)
  - [ ] Create
        `apps/web/src/app/features/tools/components/form-builder/step-analytics/step-analytics.component.ts`
  - [ ] Make component standalone
  - [ ] Inject `StatisticsEngineService` and `FormBuilderService`
  - [ ] Add template sections:
    - Overall completion rate card
    - Step completion table (step title, started, completed, rate)
    - Funnel chart showing drop-off visualization
    - Step completion bar chart
  - [ ] Use PrimeNG Chart.js components:
    - `p-chart` for funnel and bar charts
    - `p-table` for step statistics table
  - [ ] Add computed signals:

    ```typescript
    protected readonly stepAnalytics = computed(() => {
      const submissions = this.submissions();
      const schema = this.formSchema();
      return this.statisticsService.calculateStepAnalytics(submissions, schema);
    });

    protected readonly funnelChartData = computed(() => {
      const analytics = this.stepAnalytics();
      return {
        labels: analytics.stepStats.map(s => s.stepTitle),
        datasets: [{
          label: 'Users Reached',
          data: analytics.stepStats.map(s => s.totalStarted),
          backgroundColor: '#3B82F6'
        }]
      };
    });

    protected readonly dropOffChartData = computed(() => {
      const analytics = this.stepAnalytics();
      return {
        labels: analytics.stepStats.map(s => s.stepTitle),
        datasets: [{
          label: 'Drop-off Rate (%)',
          data: analytics.stepStats.map(s => s.dropOffRate),
          backgroundColor: '#EF4444'
        }]
      };
    });
    ```

- [ ] **Task 5: Integrate step analytics into form analytics page** (AC: 1, 2)
  - [ ] Update `form-analytics.component.ts` to conditionally show step analytics
  - [ ] Add template section:
    ```html
    @if (isStepForm()) {
    <app-step-analytics [formSchema]="formSchema()" [submissions]="submissions()">
    </app-step-analytics>
    }
    ```
  - [ ] Add tab or section: "Step Performance" alongside existing analytics

- [ ] **Task 6: Backend integration tests for step forms** (AC: 3)
  - [ ] Create `apps/api/tests/integration/step-forms.test.ts`
  - [ ] Test scenarios:
    - Create form with step configuration
    - Update form to add/remove steps
    - Publish step form and verify short link
    - Submit step form with step events in metadata
    - Retrieve submissions and verify step event data
    - Validate step form schema
    - Test migration from single-page to step form
  - [ ] Test pattern:

    ```typescript
    describe('Step Form API Integration', () => {
      let authToken: string;
      let createdFormId: string;

      beforeEach(async () => {
        authToken = await getAuthToken();
      });

      it('should create form with step configuration', async () => {
        const response = await request(app)
          .post('/api/forms')
          .set('Authorization', `Bearer ${authToken}`)
          .send({
            title: 'Multi-Step Survey',
            schema: {
              fields: [...],
              settings: {
                stepForm: {
                  enabled: true,
                  steps: [
                    { id: 'step1', title: 'Personal Info', order: 0 },
                    { id: 'step2', title: 'Contact Info', order: 1 }
                  ]
                }
              }
            }
          });

        expect(response.status).toBe(201);
        expect(response.body.data.schema.settings.stepForm.enabled).toBe(true);
        createdFormId = response.body.data.id;
      });

      it('should submit step form with step events', async () => {
        // Publish form first...
        // Then submit with step events
        const response = await request(app)
          .post(`/api/public/forms/${shortCode}/submit`)
          .send({
            values: { firstName: 'John', email: 'john@example.com' },
            metadata: {
              stepEvents: [
                { stepId: 'step1', stepOrder: 0, action: 'view', timestamp: new Date() },
                { stepId: 'step1', stepOrder: 0, action: 'next', timestamp: new Date() },
                { stepId: 'step2', stepOrder: 1, action: 'view', timestamp: new Date() },
                { stepId: 'step2', stepOrder: 1, action: 'submit', timestamp: new Date() }
              ]
            }
          });

        expect(response.status).toBe(201);
        expect(response.body.data.metadata.stepEvents).toHaveLength(4);
      });
    });
    ```

  - [ ] Run tests: `npm --workspace=apps/api run test:integration`

- [ ] **Task 7: E2E tests for complete step form lifecycle** (AC: 4)
  - [ ] Update `tests/e2e/form-builder-workflow.spec.ts`
  - [ ] Add test suite: "Step Form Lifecycle"
  - [ ] Test scenarios:
    - **Builder workflow:**
      - Login as admin
      - Create new form
      - Enable step form mode
      - Add 3 steps with titles
      - Add fields to each step
      - Configure row layout for step 2
      - Save form
      - Publish form
      - Get short link
    - **Public submission workflow:**
      - Navigate to short link
      - Verify first step displays
      - Fill fields and navigate through all steps
      - Submit on final step
      - Verify success message
    - **Analytics verification:**
      - Navigate back to form analytics
      - Verify step completion rates display
      - Verify drop-off chart renders
  - [ ] Test pattern:

    ```typescript
    test('should complete full step form lifecycle', async ({ page }) => {
      // 1. Create and publish step form
      await page.goto('/admin/forms/new');
      await page.fill('[name="title"]', 'Multi-Step Survey');

      // Enable step form
      await page.click('button:has-text("Step Form")'); // Sidebar tab
      await page.click('button:has-text("Enable Step Form")');
      await page.click('button:has-text("Enable")'); // Confirmation

      // Add steps
      await page.click('button:has-text("Add Step")');
      await page.fill('[name="stepTitle"]', 'Step 2');
      await page.click('button:has-text("Save")');

      // Add fields to steps
      // ... drag field types to canvas

      // Save and publish
      await page.click('button:has-text("Save")');
      await page.click('button:has-text("Publish")');

      const shortLink = await page.locator('[data-testid="short-link"]').textContent();

      // 2. Submit form via public link
      await page.goto(shortLink!);

      await expect(page.locator('text=Step 1 of')).toBeVisible();
      await page.fill('[name="firstName"]', 'John');
      await page.click('button:has-text("Next")');

      await expect(page.locator('text=Step 2 of')).toBeVisible();
      await page.fill('[name="email"]', 'john@example.com');
      await page.click('button:has-text("Submit")');

      await expect(page.locator('text=Thank you')).toBeVisible();

      // 3. Verify analytics
      await page.goto('/admin/forms');
      await page.click('text=Multi-Step Survey');
      await page.click('button:has-text("Analytics")');

      await expect(page.locator('text=Step Completion Rates')).toBeVisible();
      await expect(page.locator('text=100%')).toBeVisible(); // Step 1 completion
    });
    ```

  - [ ] Run E2E tests: `npm run test:e2e -- --grep="step form lifecycle"`

- [ ] **Task 8: Performance tests for complex step forms** (AC: 5)
  - [ ] Create `apps/api/tests/performance/step-forms-performance.test.ts`
  - [ ] Test scenarios:
    - Create form with 10 steps and 50 fields total
    - Measure form schema save time (< 500ms target)
    - Measure form schema load time (< 200ms target)
    - Measure validation time (< 100ms target)
    - Publish form and measure token generation (< 100ms target)
    - Submit form with all fields and measure processing (< 1000ms target)
  - [ ] Performance test pattern:

    ```typescript
    describe('Step Form Performance', () => {
      it('should handle large step form efficiently', async () => {
        const largeSchema = generateLargeStepFormSchema(10, 50); // 10 steps, 50 fields

        const startTime = Date.now();

        const response = await request(app)
          .post('/api/forms')
          .set('Authorization', `Bearer ${token}`)
          .send({
            title: 'Large Step Form',
            schema: largeSchema,
          });

        const endTime = Date.now();
        const duration = endTime - startTime;

        expect(response.status).toBe(201);
        expect(duration).toBeLessThan(500); // < 500ms
      });

      it('should validate large step form efficiently', async () => {
        // Similar test for validation performance
      });
    });
    ```

  - [ ] Add frontend performance tests for rendering:
    - `apps/web/src/app/features/public/form-renderer/form-renderer.component.perf.spec.ts`
    - Test rendering time for 10-step form (< 1000ms target)
    - Test step navigation time (< 100ms target)
  - [ ] Run performance tests: `npm --workspace=apps/api run test:performance`

- [ ] **Task 9: Update CLAUDE.md with step form documentation** (AC: 6)
  - [ ] Add section to `/Applications/MAMP/htdocs/Projects/NodeAngularFullStack/CLAUDE.md`:

    ````markdown
    ### Step Form (Multi-Step Wizard) Architecture

    **Overview:** The form builder supports multi-step wizards, enabling users to create guided,
    sequential forms that display one step at a time with navigation controls.

    **Key Components:**

    - `StepFormSidebarComponent` - Step configuration UI in builder
    - `FormCanvasComponent` - Canvas with step navigation tabs
    - `FormRendererComponent` - Public form rendering with step navigation
    - `StepProgressIndicatorComponent` - Visual progress indicator
    - `StatisticsEngineService` - Step analytics and completion tracking

    **Database Schema:**

    - Step configuration stored in `form_schemas.schema` JSONB column
    - Step structure: `settings.stepForm = { enabled: boolean, steps: FormStep[] }`
    - Field-to-step assignment: `field.position.stepId`
    - Row-to-step assignment: `row.stepId` (optional)

    **Type Definitions:**

    ```typescript
    interface FormStep {
      id: string;
      title: string;
      description?: string;
      order: number;
    }

    interface StepFormConfig {
      enabled: boolean;
      steps: FormStep[];
    }

    interface FieldPosition {
      rowId: string;
      columnIndex: number;
      orderInColumn?: number;
      stepId?: string; // Step assignment
    }
    ```
    ````

    **Builder Workflow:**
    1. User enables step mode in sidebar
    2. User adds/edits/reorders steps
    3. User drags fields to canvas (assigns to active step)
    4. User configures row layout per step
    5. User saves and publishes form

    **Public Form Workflow:**
    1. User opens short link
    2. First step displays with fields
    3. User fills fields and clicks "Next"
    4. Step validation runs before proceeding
    5. Repeat for all steps
    6. "Submit" button appears on final step
    7. Form submits all fields (flat structure)

    **Analytics:**
    - Step completion rates tracked per step
    - Drop-off visualization identifies abandonment points
    - Funnel chart shows user progression
    - Step events stored in submission metadata

    **Backward Compatibility:**
    - Step configuration is optional
    - Forms without `stepForm.enabled` render as single-page
    - No breaking changes to existing forms

    **Testing:**
    - Unit tests: >80% coverage for step-related code
    - Integration tests: Step form CRUD operations
    - E2E tests: Complete lifecycle (create → publish → submit)
    - Performance tests: 10 steps, 50 fields (< 500ms save time)

    ```

    ```

  - [ ] Add to "Important Development Notes" section:
    - Step form architecture overview
    - How to extend step form functionality
    - Common patterns and best practices

- [ ] **Task 10: Add JSDoc comments to all public APIs** (AC: 7)
  - [ ] Review and add JSDoc to:
    - **Backend:**
      - `forms.service.ts` - Step validation methods
      - `forms.controller.ts` - Step-related endpoints
      - `form-migration.utils.ts` - Migration helpers
    - **Frontend:**
      - `form-builder.service.ts` - Step management methods
      - `step-form-sidebar.component.ts` - Step configuration
      - `form-canvas.component.ts` - Step navigation
      - `form-renderer.component.ts` - Step rendering
      - `statistics-engine.service.ts` - Step analytics
  - [ ] JSDoc template:
    ````typescript
    /**
     * Enables step form mode and migrates existing fields to first step.
     * Creates a default step with title "Step 1" and assigns all existing fields.
     * Updates form schema with `stepForm.enabled = true`.
     *
     * @example
     * ```typescript
     * formBuilderService.enableStepForm();
     * // Form now has 1 step with all fields assigned
     * ```
     *
     * @returns void
     * @fires {FormChangeEvent} Emits form change event for autosave
     */
    enableStepForm(): void {
      // Implementation
    }
    ````
  - [ ] Verify JSDoc in Swagger/OpenAPI docs: `/api-docs`

- [ ] **Task 11: Create developer guide for step forms** (AC: 8)
  - [ ] Create `docs/guides/step-form-development-guide.md`
  - [ ] Include sections:
    - **Introduction** - What are step forms and why use them
    - **Architecture Overview** - High-level component diagram
    - **Type Definitions** - Complete type reference
    - **Extension Points** - How to extend step form functionality
    - **Custom Validation** - Adding custom step validation rules
    - **Custom Analytics** - Adding custom step metrics
    - **Troubleshooting** - Common issues and solutions
    - **Migration Guide** - Converting single-page forms to step forms
    - **API Reference** - Complete API documentation
    - **Examples** - Code examples for common use cases
  - [ ] Add code examples:

    ````markdown
    ### Example: Adding Custom Step Validation

    ```typescript
    // Custom validation rule: Require email confirmation in step 2
    validateStep2(): boolean {
      const email = this.formGroup.get('email')?.value;
      const confirmEmail = this.formGroup.get('confirmEmail')?.value;

      if (email !== confirmEmail) {
        this.messageService.add({
          severity: 'error',
          summary: 'Email Mismatch',
          detail: 'Email addresses must match'
        });
        return false;
      }

      return true;
    }

    goToNextStep(): void {
      // Run standard validation
      if (!this.validateCurrentStep()) return;

      // Run custom step-specific validation
      if (this._currentStepIndex() === 1 && !this.validateStep2()) return;

      // Proceed with navigation
      this._currentStepIndex.update(i => i + 1);
    }
    ```
    ````

    ```

    ```

  - [ ] Link to guide from CLAUDE.md

- [ ] **Task 12: Verify overall test coverage** (AC: 9)
  - [ ] Run all tests with coverage:
    - Backend: `npm --workspace=apps/api run test:coverage`
    - Frontend: `npm --workspace=apps/web run test:coverage`
    - E2E: `npm run test:e2e`
  - [ ] Generate coverage reports
  - [ ] Verify coverage metrics:
    - Overall coverage >80%
    - Step-related code coverage >80%
    - No uncovered critical paths
  - [ ] Fix any coverage gaps
  - [ ] Update package.json scripts if needed

- [ ] **Task 13: Final integration testing and validation** (AC: 3, 4, 5, 9)
  - [ ] Run full test suite:
    - `npm test` (root level - runs all tests)
    - `npm run quality:check` (lint + typecheck + format)
  - [ ] Verify all tests pass:
    - Backend unit tests
    - Backend integration tests
    - Backend performance tests
    - Frontend unit tests
    - Frontend component tests
    - E2E tests
  - [ ] Manual testing checklist:
    - Create step form with 5 steps
    - Add 20 fields across steps
    - Configure row layouts for each step
    - Publish form
    - Submit 10 test submissions with varying completion rates
    - Verify analytics show correct step completion rates
    - Verify drop-off chart displays
    - Test on mobile device
    - Test keyboard navigation
    - Test with screen reader
  - [ ] Performance validation:
    - Verify builder loads in < 2 seconds
    - Verify canvas renders in < 1 second
    - Verify public form loads in < 1 second
    - Verify form submission completes in < 2 seconds
  - [ ] Browser compatibility testing:
    - Chrome (latest)
    - Firefox (latest)
    - Safari (latest)
    - Edge (latest)
    - Mobile Safari (iOS)
    - Mobile Chrome (Android)

## Dev Notes

### Previous Story Context

[Source: Stories 19.1-19.4 completion notes - to be updated after implementation]

**Key Takeaways from Stories 19.1-19.4:**

- **Story 19.1:** Backend types and validation for step forms complete
- **Story 19.2:** Step configuration UI in sidebar complete
- **Story 19.3:** Canvas step navigation and field assignment complete
- **Story 19.4:** Public form rendering with step navigation complete

**Integration Points:**

- StatisticsEngineService must calculate step-level analytics
- FormRendererComponent tracking step navigation events
- Backend storing step events in submission metadata
- Analytics dashboard displaying step completion rates and drop-offs

### Testing Standards

[Source: docs/architecture/testing-strategy.md]

**Test Organization:**

```
apps/api/tests/
├── unit/               # Unit tests
│   ├── validators/
│   ├── services/
│   └── utils/
├── integration/        # API integration tests
│   ├── auth.test.ts
│   ├── forms.test.ts
│   └── step-forms.test.ts # NEW
└── performance/        # Performance tests
    └── step-forms-performance.test.ts # NEW

apps/web/src/
└── app/
    └── features/
        └── tools/
            └── components/
                └── form-builder/
                    ├── *.spec.ts  # Unit tests
                    └── step-analytics/
                        └── *.spec.ts # NEW

tests/e2e/
├── form-builder-workflow.spec.ts # UPDATE
└── step-form-submission.spec.ts  # NEW
```

**Coverage Requirements:**

- Overall: >80%
- New code: >80%
- Critical paths: 100%
- Integration tests: All API endpoints
- E2E tests: Happy path + error scenarios

**Performance Benchmarks:**

- Form save: < 500ms (10 steps, 50 fields)
- Form load: < 200ms
- Validation: < 100ms
- Form submission: < 1000ms
- Canvas rendering: < 1000ms (10 steps)
- Step navigation: < 100ms

### Analytics Architecture

[Source: Existing statistics-engine.service.ts implementation]

**Current StatisticsEngineService:**

- Calculates field-level statistics (numeric, choice, time series)
- Generates chart data for visualizations
- Supports filtering by date range and field values
- Exports data to CSV

**NEW Step Analytics:**

```typescript
export interface StepCompletionStats {
  stepId: string;
  stepTitle: string;
  stepOrder: number;
  totalStarted: number; // Count of users who viewed this step
  totalCompleted: number; // Count of users who clicked Next/Submit
  completionRate: number; // (completed / started) * 100
  dropOffCount: number; // started - completed
  dropOffRate: number; // (dropOff / started) * 100
  averageTimeSpent?: number; // Optional: average time on step (if tracked)
}

export interface StepFormAnalytics {
  isStepForm: boolean;
  totalSteps: number;
  overallCompletionRate: number; // Percentage who completed ALL steps
  totalSubmissions: number;
  stepStats: StepCompletionStats[];
  funnelData: { step: string; count: number }[];
}
```

**Calculation Logic:**

```typescript
calculateStepAnalytics(submissions: FormSubmission[], formSchema: FormSchema): StepFormAnalytics {
  if (!formSchema.settings.stepForm?.enabled) {
    return { isStepForm: false, /* defaults */ };
  }

  const steps = formSchema.settings.stepForm.steps;
  const stepStats: Map<string, StepCompletionStats> = new Map();

  // Initialize stats for each step
  steps.forEach(step => {
    stepStats.set(step.id, {
      stepId: step.id,
      stepTitle: step.title,
      stepOrder: step.order,
      totalStarted: 0,
      totalCompleted: 0,
      completionRate: 0,
      dropOffCount: 0,
      dropOffRate: 0
    });
  });

  // Process each submission's step events
  submissions.forEach(submission => {
    const stepEvents = submission.metadata?.stepEvents as StepNavigationEvent[] || [];

    stepEvents.forEach(event => {
      const stats = stepStats.get(event.stepId);
      if (!stats) return;

      if (event.action === 'view') {
        stats.totalStarted++;
      }
      if (event.action === 'next' || event.action === 'submit') {
        stats.totalCompleted++;
      }
    });
  });

  // Calculate rates
  stepStats.forEach(stats => {
    if (stats.totalStarted > 0) {
      stats.completionRate = (stats.totalCompleted / stats.totalStarted) * 100;
      stats.dropOffCount = stats.totalStarted - stats.totalCompleted;
      stats.dropOffRate = (stats.dropOffCount / stats.totalStarted) * 100;
    }
  });

  return {
    isStepForm: true,
    totalSteps: steps.length,
    overallCompletionRate: calculateOverallRate(submissions, steps),
    totalSubmissions: submissions.length,
    stepStats: Array.from(stepStats.values()).sort((a, b) => a.stepOrder - b.stepOrder),
    funnelData: generateFunnelData(stepStats)
  };
}
```

### Chart Visualization with PrimeNG

[Source: PrimeNG Chart.js documentation]

**Funnel Chart (Step Progression):**

```typescript
funnelChartOptions = {
  plugins: {
    legend: { display: false },
    title: {
      display: true,
      text: 'Step Progression Funnel',
    },
  },
  scales: {
    y: {
      beginAtZero: true,
      title: { display: true, text: 'Users' },
    },
    x: {
      title: { display: true, text: 'Steps' },
    },
  },
};

funnelChartData = computed(() => ({
  labels: this.stepStats().map((s) => `Step ${s.stepOrder + 1}: ${s.stepTitle}`),
  datasets: [
    {
      label: 'Users Reached',
      data: this.stepStats().map((s) => s.totalStarted),
      backgroundColor: '#3B82F6',
      borderColor: '#2563EB',
      borderWidth: 1,
    },
    {
      label: 'Users Completed',
      data: this.stepStats().map((s) => s.totalCompleted),
      backgroundColor: '#10B981',
      borderColor: '#059669',
      borderWidth: 1,
    },
  ],
}));
```

**Drop-Off Bar Chart:**

```typescript
dropOffChartData = computed(() => ({
  labels: this.stepStats().map((s) => `Step ${s.stepOrder + 1}`),
  datasets: [
    {
      label: 'Drop-off Rate (%)',
      data: this.stepStats().map((s) => s.dropOffRate),
      backgroundColor: '#EF4444',
      borderColor: '#DC2626',
      borderWidth: 1,
    },
  ],
}));
```

### Performance Testing Strategy

[Source: docs/architecture/testing-strategy.md]

**Performance Test Tools:**

- Node.js `perf_hooks` for timing measurements
- Jest with custom timing assertions
- Lighthouse for frontend performance audits
- Playwright for E2E performance testing

**Performance Test Pattern:**

```typescript
describe('Step Form Performance', () => {
  it('should save large step form within 500ms', async () => {
    const largeSchema = generateLargeStepFormSchema(10, 50);

    const { performance } = require('perf_hooks');
    const startTime = performance.now();

    const response = await request(app)
      .post('/api/forms')
      .set('Authorization', `Bearer ${token}`)
      .send({ title: 'Large Form', schema: largeSchema });

    const endTime = performance.now();
    const duration = endTime - startTime;

    expect(response.status).toBe(201);
    expect(duration).toBeLessThan(500);
  });
});
```

### Documentation Standards

[Source: docs/architecture/coding-standards.md]

**JSDoc Requirements:**

- All public functions must have JSDoc
- Include `@param`, `@returns`, `@throws`, `@example`
- Document side effects and state changes
- Reference related functions/types

**Documentation Structure:**

````typescript
/**
 * Calculates step completion rates and drop-off statistics for step forms.
 * Analyzes step navigation events from form submissions to determine user behavior.
 *
 * @param submissions - Array of form submissions with step event metadata
 * @param formSchema - Form schema containing step configuration
 * @returns Step analytics including completion rates, drop-offs, and funnel data
 *
 * @example
 * ```typescript
 * const analytics = statisticsService.calculateStepAnalytics(submissions, schema);
 * console.log(`Overall completion: ${analytics.overallCompletionRate}%`);
 * console.log(`Step 1 drop-off: ${analytics.stepStats[0].dropOffRate}%`);
 * ```
 *
 * @throws {Error} If form schema is invalid or missing step configuration
 *
 * @see StepFormAnalytics
 * @see StepCompletionStats
 */
calculateStepAnalytics(
  submissions: FormSubmission[],
  formSchema: FormSchema
): StepFormAnalytics {
  // Implementation
}
````

### Developer Guide Content Outline

[Source: Epic 19 requirements]

**Guide Sections:**

1. **Introduction**
   - What are step forms?
   - Use cases and benefits
   - Architecture overview

2. **Getting Started**
   - Enabling step mode
   - Creating steps
   - Assigning fields to steps

3. **Advanced Features**
   - Custom step validation
   - Conditional step visibility
   - Dynamic step creation
   - Step-specific analytics

4. **Extension Points**
   - Adding custom step types
   - Custom progress indicators
   - Custom navigation logic
   - Custom analytics metrics

5. **API Reference**
   - FormBuilderService methods
   - StatisticsEngineService methods
   - Type definitions
   - Event interfaces

6. **Troubleshooting**
   - Common issues and solutions
   - Debugging step navigation
   - Performance optimization
   - Browser compatibility

7. **Migration Guide**
   - Converting single-page to step form
   - Migrating existing submissions
   - Backward compatibility notes

8. **Examples**
   - Basic multi-step form
   - Complex conditional steps
   - Custom validation rules
   - Analytics dashboard integration

### Project Structure

[Source: docs/architecture/unified-project-structure.md]

**Updated Documentation:**

```
docs/
├── CLAUDE.md                        # UPDATE: Add step form section
├── guides/
│   └── step-form-development-guide.md # NEW: Developer guide
├── prd/
│   └── epic-19-step-form-wizard.md  # Existing PRD
└── stories/
    ├── 19.1.*.story.md
    ├── 19.2.*.story.md
    ├── 19.3.*.story.md
    ├── 19.4.*.story.md
    └── 19.5.*.story.md
```

**Test Files:**

```
apps/api/tests/
├── integration/
│   └── step-forms.test.ts           # NEW
└── performance/
    └── step-forms-performance.test.ts # NEW

apps/web/src/app/features/
└── tools/components/form-builder/
    ├── step-analytics/
    │   ├── step-analytics.component.ts      # NEW
    │   ├── step-analytics.component.spec.ts # NEW
    │   └── step-analytics.component.html    # NEW
    └── statistics-engine.service.ts         # UPDATE

tests/e2e/
├── form-builder-workflow.spec.ts    # UPDATE
└── step-form-submission.spec.ts     # NEW
```

### Tech Stack

[Source: docs/architecture/tech-stack.md]

- **Testing:** Jest 29+, Supertest 6+, Playwright 1.40+
- **Performance:** Node.js perf_hooks, Lighthouse
- **Charts:** PrimeNG Chart.js integration
- **Documentation:** Markdown, JSDoc, TypeDoc (optional)
- **Coverage:** Istanbul/NYC for coverage reports

### Success Metrics

[Source: Epic 19 requirements]

**Testing Metrics:**

- Overall test coverage >80%
- Step-related code coverage >80%
- All integration tests passing
- All E2E tests passing
- Performance benchmarks met

**Documentation Metrics:**

- All public APIs documented with JSDoc
- CLAUDE.md updated with step form section
- Developer guide created with examples
- README updated (if applicable)

**Quality Metrics:**

- No lint errors
- No TypeScript errors
- No console warnings in production
- All accessibility checks passing (WCAG AA)

## Change Log

| Date       | Version | Description         | Author       |
| ---------- | ------- | ------------------- | ------------ |
| 2025-10-13 | 1.0     | Initial story draft | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent during implementation_

### Debug Log References

_To be populated by Dev Agent during implementation_

### Completion Notes List

_To be populated by Dev Agent during implementation_

### File List

_To be populated by Dev Agent during implementation_

## QA Results

_To be populated by QA Agent after review_
