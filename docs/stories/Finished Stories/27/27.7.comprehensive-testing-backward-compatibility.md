# Story 27.7: Comprehensive Testing and Backward Compatibility Validation

**Story ID**: STORY-27.7 **Epic**: Epic 27 - Nested Column Layout System with Variable Width
Configuration **Priority**: High **Status**: Approved **Estimated Effort**: 10 hours **Sprint**: TBD

---

## Story

**As a** QA engineer, **I want** comprehensive test coverage for nested column functionality and
backward compatibility, **so that** we can confidently deploy without breaking existing forms.

---

## Acceptance Criteria

### AC1: FormBuilderService Unit Tests (Story 27.3)

- [ ] Sub-column state management methods achieve 90%+ code coverage
- [ ] Tests for `addSubColumn()`, `removeSubColumn()`, `updateSubColumnWidths()` methods
- [ ] Tests for computed signals: `subColumnsByRowColumn()`, `fieldsByRowColumn()`
- [ ] Tests for field position updates when moving to/from sub-columns
- [ ] Tests for `loadForm()` and `buildSchema()` with sub-column configurations

### AC2: Row Layout Sidebar Component Tests (Story 27.4)

- [ ] All sub-column control interactions tested (enable, configure count, widths)
- [ ] Preset width ratio dropdown selection tests
- [ ] Custom width input validation tests
- [ ] Confirmation dialog tests for disabling sub-columns
- [ ] Visual indicator (icon/badge) rendering tests

### AC3: FormCanvasComponent Tests (Story 27.5)

- [ ] Sub-column drop zone rendering tests
- [ ] Drag-drop from palette to sub-column tests
- [ ] Drag-drop between sub-columns tests
- [ ] Multi-field vertical stacking tests
- [ ] Visual feedback (drag-over class) tests
- [ ] Backward compatibility tests for equal-width columns

### AC4: FormRendererComponent Tests (Story 27.6)

- [ ] Variable column width application tests
- [ ] Sub-column container rendering tests
- [ ] Field positioning within sub-columns tests
- [ ] Desktop responsive rendering tests
- [ ] Mobile responsive rendering tests (vertical stacking)
- [ ] Theme styles application tests

### AC5: Backend API Validation Tests

- [ ] Integration tests for fractional unit syntax validation
- [ ] Integration tests for sub-column structure validation
- [ ] Tests for rejecting invalid `columnWidths` (e.g., "2px", "abc")
- [ ] Tests for rejecting invalid `subColumnCount` (e.g., 5, 0)
- [ ] Tests for saving forms with nested column configurations

### AC6: Playwright E2E Tests

- [ ] E2E test: Drag field from palette to sub-column
- [ ] E2E test: Configure variable column widths via sidebar
- [ ] E2E test: Publish form with nested columns and view on desktop
- [ ] E2E test: Publish form with nested columns and view on mobile
- [ ] E2E test: Submit form with fields in sub-columns
- [ ] E2E test: Existing forms without nested columns render correctly

### AC7: Regression Test Suite

- [ ] Validate 10+ existing forms render identically before/after deployment
- [ ] Screenshot comparison tests for visual regression detection
- [ ] Tests for equal-width row layouts (backward compatible)
- [ ] Tests for global layout mode (backward compatible)
- [ ] Tests for forms without `rowLayout` property

### AC8: Performance Benchmark Tests

- [ ] Render time remains <50ms for 50-field form with nested columns
- [ ] Memory usage increase <15% compared to equal-width layouts
- [ ] Drag-drop performance acceptable with 100+ fields
- [ ] Public form load time <100ms for 5 rows with nested sub-columns

### AC9: Accessibility Audit Tests

- [ ] WCAG AA compliance verified for sub-column drop zones
- [ ] Keyboard navigation tests for drag-drop
- [ ] Screen reader tests for sub-column field positioning
- [ ] Focus management tests after drag-drop operations
- [ ] Color contrast tests for drag-over visual feedback

---

## Tasks / Subtasks

### Task 1: FormBuilderService Unit Tests (AC: 1)

- [ ] Write test: `addSubColumn()` adds config to `_subColumnConfigs` signal
- [ ] Write test: `removeSubColumn()` removes config and moves fields to parent
- [ ] Write test: `updateSubColumnWidths()` updates widths array
- [ ] Write test: `getFieldsInColumn()` filters by `subColumnIndex` when provided
- [ ] Write test: `setFieldPosition()` updates field with new `subColumnIndex`
- [ ] Write test: `reorderFieldInColumn()` recalculates `orderInColumn` for sub-column
- [ ] Write test: `loadForm()` populates `_subColumnConfigs` from schema
- [ ] Write test: `buildSchema()` includes sub-column configs in saved schema
- [ ] Run:
      `npm --workspace=apps/web run test -- --include="**/form-builder.service.spec.ts" --watch=false`
- [ ] Verify: 90%+ code coverage for sub-column methods

### Task 2: Row Layout Sidebar Component Tests (AC: 2)

- [ ] Write test: "Enable Sub-Columns" toggle calls `FormBuilderService.addSubColumn()`
- [ ] Write test: Sub-column count dropdown updates `subColumnCount` property
- [ ] Write test: Preset width ratio dropdown sets correct fractional units
- [ ] Write test: Custom width input validates fractional syntax (e.g., "1fr 2fr")
- [ ] Write test: Invalid custom input (e.g., "2px 3px") shows error message
- [ ] Write test: Disabling sub-columns shows confirmation dialog
- [ ] Write test: Confirmation dialog "Yes" moves fields to parent column
- [ ] Write test: Visual indicator (badge) appears when sub-columns enabled
- [ ] Run:
      `npm --workspace=apps/web run test -- --include="**/row-layout-sidebar.component.spec.ts" --watch=false`
- [ ] Verify: All AC2 criteria pass

### Task 3: FormCanvasComponent Drag-Drop Tests (AC: 3)

- [ ] Write test: Sub-column drop zones render when `subColumnConfigs` defined
- [ ] Write test: Drag-over adds `.sub-column-drop-zone--drag-over` class
- [ ] Write test: Drag-exit removes drag-over class
- [ ] Write test: Palette-to-sub-column creates field with correct `subColumnIndex`
- [ ] Write test: Field-to-sub-column updates position correctly
- [ ] Write test: Multi-field stacking calculates correct `orderInColumn`
- [ ] Write test: Sub-column-to-parent clears `subColumnIndex`
- [ ] Write test: Existing equal-width column drag-drop still works
- [ ] Write test: CDK `cdkDropListGroup` connects palette and sub-columns
- [ ] Run:
      `npm --workspace=apps/web run test -- --include="**/form-canvas.component.spec.ts" --watch=false`
- [ ] Verify: All AC3 criteria pass

### Task 4: FormRendererComponent Tests (AC: 4)

- [ ] Write test: `columnGridTemplateColumns()` returns correct CSS Grid template
- [ ] Write test: `hasSubColumns()` detects sub-column config correctly
- [ ] Write test: `fieldsForSubColumn()` filters and sorts fields correctly
- [ ] Write test: Sub-column containers render when `subColumns` defined
- [ ] Write test: Variable column widths apply via `[style.grid-template-columns]`
- [ ] Write test: Forms without nested columns render with equal-width fallback
- [ ] Write test: Mobile media query forces vertical stacking (mock viewport width)
- [ ] Write test: Theme CSS variables apply to sub-column fields
- [ ] Run:
      `npm --workspace=apps/web run test -- --include="**/form-renderer.component.spec.ts" --watch=false`
- [ ] Verify: All AC4 criteria pass

### Task 5: Backend API Validation Tests (AC: 5)

- [ ] Write integration test: POST `/api/forms` with valid nested column config succeeds
- [ ] Write integration test: POST with invalid `columnWidths` (e.g., "2px") returns 400 error
- [ ] Write integration test: POST with invalid fractional syntax (e.g., "abc") returns 400
- [ ] Write integration test: POST with invalid `subColumnCount: 5` returns 400 error
- [ ] Write integration test: POST with `subColumnCount: 0` returns 400 error
- [ ] Write integration test: Validator `validateFractionalUnits()` rejects non-fr units
- [ ] Write integration test: Validator `validateSubColumnStructure()` checks consistency
- [ ] Run: `npm --workspace=apps/api run test -- --testPathPatterns="forms-column-widths.test.ts"`
- [ ] Verify: All AC5 criteria pass

### Task 6: Playwright E2E Tests (AC: 6)

- [ ] Write E2E test: "Drag field from palette to sub-column"
  - Navigate to form builder
  - Enable row layout with 2 columns
  - Enable sub-columns on column 1 (2 sub-columns)
  - Drag "Text Input" from palette to sub-column 1
  - Verify field appears in sub-column 1
- [ ] Write E2E test: "Configure variable column widths"
  - Open row layout sidebar for row 1
  - Select "Narrow-Wide" preset (1fr 2fr)
  - Verify column widths update in canvas
- [ ] Write E2E test: "Publish form with nested columns (desktop)"
  - Create form with sub-columns
  - Publish form
  - Navigate to public URL
  - Verify sub-columns render side-by-side (1280px viewport)
- [ ] Write E2E test: "Publish form with nested columns (mobile)"
  - Same form as above
  - Set viewport to 375px width
  - Verify sub-columns stack vertically
- [ ] Write E2E test: "Submit form with sub-column fields"
  - Fill out form with fields in sub-columns
  - Submit form
  - Verify backend receives all field values
- [ ] Write E2E test: "Existing forms render correctly"
  - Load 5 forms created before Epic 27
  - Verify no visual regression (screenshot comparison)
- [ ] Create test file: `tests/e2e/form-builder/variable-column-widths.spec.ts`
- [ ] Run: `npm run test:e2e -- tests/e2e/form-builder/variable-column-widths.spec.ts`
- [ ] Verify: All AC6 criteria pass

### Task 7: Regression Test Suite (AC: 7)

- [ ] Create baseline screenshots for 10 existing forms (before deployment)
- [ ] Deploy nested column feature to staging environment
- [ ] Capture comparison screenshots for same 10 forms (after deployment)
- [ ] Use Playwright screenshot comparison to detect visual differences
- [ ] Write regression test: Forms without `columnWidths` render equal-width columns
- [ ] Write regression test: Forms without `subColumns` render parent columns only
- [ ] Write regression test: Forms with `rowLayout.enabled === false` use global layout
- [ ] Write regression test: Forms without `rowLayout` property render without errors
- [ ] Create test file: `tests/e2e/form-builder/regression-equal-widths.spec.ts`
- [ ] Run: `npm run test:e2e -- tests/e2e/form-builder/regression-equal-widths.spec.ts`
- [ ] Verify: Zero visual regressions detected

### Task 8: Performance Benchmark Tests (AC: 8)

- [ ] Create performance test: Form builder render time with 50 fields + nested columns
  - Measure initial render time using Chrome DevTools Performance API
  - Target: <50ms render time
- [ ] Create performance test: Memory usage with nested columns
  - Use Chrome DevTools Memory profiler
  - Compare memory usage with and without nested columns
  - Target: <15% increase
- [ ] Create performance test: Drag-drop performance with 100+ fields
  - Measure drag-drop latency with performance.mark()
  - Target: <100ms drag-drop response time
- [ ] Create performance test: Public form load time with nested columns
  - Measure time from navigation to first contentful paint
  - Target: <100ms load time
- [ ] Document performance baseline in `docs/qa/epic-27-performance-baseline.md`
- [ ] Run: Manual performance profiling with Chrome DevTools
- [ ] Verify: All performance targets met

### Task 9: Accessibility Audit Tests (AC: 9)

- [ ] Run automated WCAG AA audit on form builder with sub-columns enabled
  - Use Playwright's built-in accessibility scanner
  - Target: Zero WCAG AA violations
- [ ] Write accessibility test: Keyboard navigation through sub-column drop zones
  - Use Tab key to navigate between drop zones
  - Verify focus order: palette → column → sub-column → fields
- [ ] Write accessibility test: Screen reader announces sub-column labels
  - Use NVDA or VoiceOver to test screen reader support
  - Verify ARIA labels announce "Sub-column 1 of 2 drop zone"
- [ ] Write accessibility test: Focus management after drag-drop
  - Drag field to new sub-column
  - Verify focus moves to dragged field
- [ ] Write accessibility test: Color contrast for drag-over visual feedback
  - Measure contrast ratio for green drag-over border (#10b981)
  - Target: ≥4.5:1 contrast ratio
- [ ] Create test file: `tests/e2e/form-builder/variable-column-widths-accessibility.spec.ts`
- [ ] Run: `npm run test:e2e -- tests/e2e/form-builder/variable-column-widths-accessibility.spec.ts`
- [ ] Verify: All AC9 criteria pass

### Task 10: Test Coverage Report and Summary (AC: All)

- [ ] Run full test suite: `npm test`
- [ ] Generate coverage report: `npm --workspace=apps/web run test:coverage`
- [ ] Generate coverage report: `npm --workspace=apps/api run test:coverage`
- [ ] Verify frontend coverage: ≥90% for nested column code
- [ ] Verify backend coverage: ≥90% for nested column validators
- [ ] Document test results in `docs/qa/epic-27-test-summary.md`
- [ ] Create summary table with pass/fail status for all ACs
- [ ] Review test results with QA lead
- [ ] Address any failing tests before story completion

---

## Dev Notes

### Previous Story Insights

- **Stories 27.1-27.6**: All nested column functionality implemented. This story validates quality.
- **Epic 14 Testing**: Existing row layout tests provide patterns for nested column testing.
- **Testing Strategy**: Combination of unit, integration, E2E, and regression tests ensures
  comprehensive coverage.

### Architecture Context

**Testing Strategy Overview**: [Source: architecture/testing-strategy.md#Testing_Pyramid]

```
        E2E Tests (Playwright)
       /                      \
   Integration Tests         Performance Tests
   /            \            /              \
Frontend Unit  Backend Unit  Regression  Accessibility
```

**Test Organization**: [Source: architecture/testing-strategy.md#Test_Organization]

**Frontend Tests**:

```
apps/web/src/app/features/tools/components/form-builder/
├── form-builder.service.spec.ts        # Unit tests for state management
├── row-layout-sidebar/
│   └── row-layout-sidebar.component.spec.ts
├── form-canvas/
│   └── form-canvas.component.spec.ts   # Drag-drop tests
```

**Backend Tests**:

```
apps/api/tests/
├── integration/
│   └── forms-column-widths.test.ts     # API validation tests
└── unit/
    └── validators/
        └── nested-columns.validator.test.ts
```

**E2E Tests**:

```
tests/e2e/form-builder/
├── variable-column-widths.spec.ts
├── variable-column-widths-accessibility.spec.ts
└── regression-equal-widths.spec.ts
```

### Testing Frameworks and Tools

**Frontend Testing**: [Source: architecture/tech-stack.md#Technology_Stack_Table]

- Jest + Testing Library for unit tests
- Karma + Jasmine for Angular component tests
- Angular testing utilities (`TestBed`, `ComponentFixture`)

**Backend Testing**:

- Jest + Supertest for API integration tests
- Supertest for HTTP request testing

**E2E Testing**:

- Playwright 1.40+ for cross-browser testing
- Chromium, Firefox, WebKit browsers
- Mobile device emulation for responsive testing

**Performance Testing**:

- Chrome DevTools Performance API
- Chrome DevTools Memory Profiler
- Playwright performance tracing

**Accessibility Testing**:

- Playwright accessibility scanner (based on Axe)
- NVDA or VoiceOver for screen reader testing
- Chrome DevTools Lighthouse accessibility audit

### Test Coverage Targets

**Unit Test Coverage**:

- FormBuilderService sub-column methods: ≥90%
- Row Layout Sidebar component: ≥90%
- FormCanvasComponent drag-drop logic: ≥90%
- FormRendererComponent nested rendering: ≥90%

**Integration Test Coverage**:

- Backend API validation: 100% (all validators tested)
- Form schema save/load with nested columns: 100%

**E2E Test Coverage**:

- Drag-drop workflows: 100% (palette-to-sub-column, field-to-sub-column, etc.)
- Publish and view workflows: 100% (desktop + mobile)
- Form submission: 100%

### Backend Validator Tests

**Validator Location**: `apps/api/src/validators/nested-columns.validator.ts`

**Test File**: `apps/api/tests/unit/validators/nested-columns.validator.test.ts`

**Validator Functions to Test**:

```typescript
// Validate fractional unit syntax
function validateFractionalUnits(widths: string[]): CSSValidationResult {
  // Valid: ["1fr", "2fr", "3fr"]
  // Invalid: ["2px", "50%", "abc"]
}

// Validate sub-column structure consistency
function validateSubColumnStructure(config: SubColumnConfig): CSSValidationResult {
  // Valid: { columnIndex: 0, subColumnCount: 2, subColumnWidths: ["1fr", "2fr"] }
  // Invalid: { columnIndex: 5, subColumnCount: 0, subColumnWidths: [] }
}
```

**Test Patterns**:

```typescript
describe('validateFractionalUnits', () => {
  it('should accept valid fractional units', () => {
    const result = validateFractionalUnits(['1fr', '2fr', '3fr']);
    expect(result.valid).toBe(true);
    expect(result.errors).toHaveLength(0);
  });

  it('should reject pixel units', () => {
    const result = validateFractionalUnits(['10px', '20px']);
    expect(result.valid).toBe(false);
    expect(result.errors).toContain('Only fractional units (fr) are supported');
  });

  it('should reject percentage units', () => {
    const result = validateFractionalUnits(['50%', '50%']);
    expect(result.valid).toBe(false);
  });

  it('should reject non-numeric fractional units', () => {
    const result = validateFractionalUnits(['abc', 'def']);
    expect(result.valid).toBe(false);
  });
});
```

### E2E Test Examples

**Drag-Drop E2E Test**:

```typescript
// tests/e2e/form-builder/variable-column-widths.spec.ts

import { test, expect } from '@playwright/test';

test.describe('Epic 27: Nested Column Drag-Drop', () => {
  test.beforeEach(async ({ page }) => {
    // Login as admin
    await page.goto('/login');
    await page.fill('input[type="email"]', 'admin@example.com');
    await page.fill('input[type="password"]', 'User123!@#');
    await page.click('button[type="submit"]');
    await page.waitForURL('/app/dashboard');

    // Navigate to form builder
    await page.goto('/app/tools/form-builder');
    await page.waitForLoadState('networkidle');
  });

  test('should drag field from palette to sub-column', async ({ page }) => {
    // Enable row layout
    await page.click('button:has-text("Row Layout")');
    await page.click('button:has-text("Add Row")');

    // Enable sub-columns on column 1
    await page.click('button[aria-label="Row 1 settings"]');
    await page.click('label:has-text("Enable Sub-Columns")');
    await page.selectOption('select[aria-label="Sub-column count"]', '2');

    // Drag "Text Input" from palette to sub-column 1
    const textInputField = page.locator('text=Text Input');
    const subColumn1 = page.locator('[id^="subColumn-"][id$="-0-0"]');

    await textInputField.dragTo(subColumn1);

    // Verify field appears in sub-column 1
    await expect(subColumn1.locator('.field-preview')).toBeVisible();
    await expect(subColumn1.locator('text=Untitled')).toBeVisible();
  });

  test('should publish form with nested columns and view on desktop', async ({ page }) => {
    // ... (create form with nested columns)

    // Publish form
    await page.click('button:has-text("Publish")');
    await page.waitForSelector('text=Form Published');

    // Get public URL
    const publicUrl = await page.inputValue('input[readonly][value*="/forms/render/"]');

    // Open public form in new tab
    const publicPage = await page.context().newPage();
    await publicPage.goto(publicUrl);
    await publicPage.setViewportSize({ width: 1280, height: 720 });

    // Verify sub-columns render side-by-side
    const subColumns = publicPage.locator('.sub-column-container');
    await expect(subColumns).toHaveCount(2);

    // Verify column widths (approximate check)
    const col1Width = await subColumns.nth(0).evaluate((el) => el.offsetWidth);
    const col2Width = await subColumns.nth(1).evaluate((el) => el.offsetWidth);
    expect(col1Width).toBeLessThan(col2Width); // 1fr < 2fr
  });
});
```

**Regression Test Example**:

```typescript
// tests/e2e/form-builder/regression-equal-widths.spec.ts

import { test, expect } from '@playwright/test';

test.describe('Epic 27: Backward Compatibility Regression Tests', () => {
  const existingFormIds = [
    'form-abc123', // Form created in Epic 14 (equal-width columns)
    'form-def456', // Form without row layout
    'form-ghi789', // Form with global layout mode
    // ... (add 7 more existing form IDs)
  ];

  for (const formId of existingFormIds) {
    test(`should render existing form ${formId} without regression`, async ({ page }) => {
      // Navigate to public form
      await page.goto(`/public/form/${formId}`);
      await page.waitForLoadState('networkidle');

      // Capture screenshot
      const screenshot = await page.screenshot({ fullPage: true });

      // Compare with baseline (stored in tests/screenshots/baseline/)
      expect(screenshot).toMatchSnapshot(`${formId}-baseline.png`, {
        maxDiffPixels: 100, // Allow minor rendering differences
      });
    });
  }

  test('should render form without columnWidths with equal-width columns', async ({ page }) => {
    // Create form with 2-column row layout (no columnWidths defined)
    await page.goto('/app/tools/form-builder');
    // ... (create form with equal-width columns)

    // Verify columns have equal width
    const columns = page.locator('.form-column');
    const col1Width = await columns.nth(0).evaluate((el) => el.offsetWidth);
    const col2Width = await columns.nth(1).evaluate((el) => el.offsetWidth);
    expect(Math.abs(col1Width - col2Width)).toBeLessThan(5); // Allow 5px tolerance
  });
});
```

### File Locations

**Unit Test Files**:

- `apps/web/src/app/features/tools/components/form-builder/form-builder.service.spec.ts`
- `apps/web/src/app/features/tools/components/form-builder/row-layout-sidebar/row-layout-sidebar.component.spec.ts`
- `apps/web/src/app/features/tools/components/form-builder/form-canvas/form-canvas.component.spec.ts`
- `apps/web/src/app/features/public/form-renderer/form-renderer.component.spec.ts`

**Integration Test Files**:

- `apps/api/tests/integration/forms-column-widths.test.ts`
- `apps/api/tests/unit/validators/nested-columns.validator.test.ts`

**E2E Test Files**:

- `tests/e2e/form-builder/variable-column-widths.spec.ts`
- `tests/e2e/form-builder/variable-column-widths-accessibility.spec.ts`
- `tests/e2e/form-builder/regression-equal-widths.spec.ts`

**Documentation Files**:

- `docs/qa/epic-27-test-summary.md`
- `docs/qa/epic-27-performance-baseline.md`

### Testing Commands

**Run All Tests**:

```bash
npm test  # Runs both frontend and backend tests
```

**Frontend Unit Tests**:

```bash
npm --workspace=apps/web run test -- --watch=false
npm --workspace=apps/web run test:coverage
```

**Backend Unit/Integration Tests**:

```bash
npm --workspace=apps/api run test -- --silent
npm --workspace=apps/api run test:coverage
```

**E2E Tests**:

```bash
npm run test:e2e
npm run test:e2e:ui  # Run with Playwright UI
npm run test:e2e -- tests/e2e/form-builder/variable-column-widths.spec.ts
```

**Specific Test Patterns**:

```bash
# Frontend: Specific component
npm --workspace=apps/web run test -- --include="**/form-canvas.component.spec.ts" --watch=false

# Backend: Specific test file
npm --workspace=apps/api run test -- --testPathPatterns="forms-column-widths.test.ts"

# E2E: Specific test suite
npm run test:e2e -- --grep "nested column drag-drop"
```

**Linting**:

```bash
npm run lint
npm --workspace=apps/web run lint
npm --workspace=apps/api run lint
```

---

## Testing & Verification

### Manual Testing Checklist

**Unit Test Verification**:

- [ ] All FormBuilderService sub-column tests pass
- [ ] All Row Layout Sidebar component tests pass
- [ ] All FormCanvasComponent drag-drop tests pass
- [ ] All FormRendererComponent nested rendering tests pass
- [ ] Frontend unit test coverage ≥90% for nested column code
- [ ] Backend unit test coverage ≥90% for nested column validators

**Integration Test Verification**:

- [ ] Backend API validation tests pass for valid nested column configs
- [ ] Backend API validation tests reject invalid fractional units
- [ ] Backend API validation tests reject invalid sub-column structures
- [ ] Form schema save/load with nested columns works correctly

**E2E Test Verification**:

- [ ] Drag-drop from palette to sub-column E2E test passes
- [ ] Variable column width configuration E2E test passes
- [ ] Publish and view (desktop) E2E test passes
- [ ] Publish and view (mobile) E2E test passes
- [ ] Form submission with sub-column fields E2E test passes
- [ ] Existing forms regression E2E test passes

**Regression Test Verification**:

- [ ] 10+ existing forms render identically (screenshot comparison)
- [ ] Forms without `columnWidths` render equal-width columns
- [ ] Forms without `subColumns` render parent columns only
- [ ] Forms with `rowLayout.enabled === false` use global layout
- [ ] Forms without `rowLayout` property render without errors
- [ ] Zero visual regressions detected

**Performance Test Verification**:

- [ ] Form builder render time <50ms for 50-field form with nested columns
- [ ] Memory usage increase <15% compared to equal-width layouts
- [ ] Drag-drop performance <100ms response time with 100+ fields
- [ ] Public form load time <100ms for 5 rows with nested sub-columns
- [ ] Performance baseline documented

**Accessibility Test Verification**:

- [ ] Zero WCAG AA violations detected in automated audit
- [ ] Keyboard navigation through sub-column drop zones works
- [ ] Screen reader announces sub-column labels correctly
- [ ] Focus management works after drag-drop operations
- [ ] Color contrast meets 4.5:1 ratio for drag-over feedback

### Automated Testing

**Full Test Suite**:

```bash
npm test
```

**Expected Results**:

- All frontend unit tests pass (0 failures)
- All backend unit/integration tests pass (0 failures)
- All E2E tests pass (0 failures)
- Frontend coverage ≥90% for nested column code
- Backend coverage ≥90% for nested column validators

**Linting**:

```bash
npm run lint
```

**Expected Results**:

- Zero ESLint warnings or errors
- Zero TypeScript compilation errors

---

## Dependencies

### Prerequisites

- **Stories 27.1-27.6**: All nested column functionality implemented
- **Playwright Installed**: E2E testing framework available
- **Test Data**: 10+ existing forms for regression testing
- **Dev Environment Running**: Backend and frontend servers running for E2E tests

### Blocking Issues

- Cannot test without Stories 27.1-27.6 implementation complete
- Requires test user accounts (admin, user roles)
- Requires published forms with various configurations

### Required Knowledge

- Jest testing framework
- Jasmine/Karma for Angular testing
- Playwright E2E testing API
- Chrome DevTools (Performance, Memory, Accessibility)
- WCAG AA accessibility standards

---

## Risk Assessment

### Risk 1: Flaky E2E Tests

**Severity**: Medium **Probability**: High **Impact**: CI/CD pipeline fails intermittently due to
timing issues **Mitigation**:

- Use `waitForLoadState('networkidle')` to ensure page fully loaded
- Add explicit `waitForSelector()` before interacting with elements
- Increase default timeout for slow environments **Contingency**: Retry failed tests (Playwright
  built-in retry mechanism)

### Risk 2: Regression Tests False Positives

**Severity**: Low **Probability**: Medium **Impact**: Screenshot comparison detects minor rendering
differences as regressions **Mitigation**:

- Set `maxDiffPixels: 100` to allow minor pixel differences
- Capture baseline screenshots in consistent environment (same browser, viewport)
- Use Playwright's visual regression testing best practices **Contingency**: Manually review flagged
  regressions to confirm legitimate issues

### Risk 3: Performance Tests Inconsistent Results

**Severity**: Low **Probability**: Medium **Impact**: Performance benchmarks vary across test runs
due to system load **Mitigation**:

- Run performance tests in isolated environment (no other processes)
- Average results over 5 test runs
- Document hardware specs for reproducible results **Contingency**: Accept ±10% variance in
  performance results

---

## Definition of Done

- [ ] All unit tests pass for FormBuilderService, Row Layout Sidebar, FormCanvasComponent,
      FormRendererComponent
- [ ] All integration tests pass for backend API validation
- [ ] All E2E tests pass for drag-drop, publish/view, form submission workflows
- [ ] Regression test suite validates 10+ existing forms render correctly
- [ ] Performance benchmarks meet targets (<50ms render, <15% memory, <100ms drag-drop)
- [ ] Accessibility audit passes with zero WCAG AA violations
- [ ] Frontend unit test coverage ≥90% for nested column code
- [ ] Backend unit test coverage ≥90% for nested column validators
- [ ] E2E test coverage 100% for critical workflows
- [ ] Test summary document created in `docs/qa/epic-27-test-summary.md`
- [ ] Performance baseline document created in `docs/qa/epic-27-performance-baseline.md`
- [ ] All linting passes with zero warnings
- [ ] All TypeScript compilation passes with zero errors
- [ ] Code reviewed by QA lead
- [ ] Test results approved by tech lead

---

## Change Log

| Date       | Version | Description                                                     | Author             |
| ---------- | ------- | --------------------------------------------------------------- | ------------------ |
| 2025-10-23 | 0.1     | Initial story creation for comprehensive testing and validation | Bob (Scrum Master) |

---

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent during implementation_

### Debug Log References

_To be populated by dev agent during implementation_

### Completion Notes

_To be populated by dev agent during implementation_

### File List

_To be populated by dev agent during implementation_

---

## QA Results

_To be populated by QA agent after implementation review_
