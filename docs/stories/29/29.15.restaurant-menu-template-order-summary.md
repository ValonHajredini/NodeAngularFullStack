# Story 29.15: Restaurant Menu Template with Order Summary

**Epic**: Epic 29 - Form Template System with Business Logic **Story ID**: 29.15 **Status**: Draft
**Story Points**: 6 **Priority**: Medium **Risk Level**: Low (In-memory calculation, similar to quiz
template) **Dependencies**: Stories 29.1-29.5 (Backend Foundation), 29.11 (Base Executor Interface)
**Related Stories**: 29.11-29.14 (Other Template Types)

---

## User Story

**As a** restaurant owner, **I want** a menu ordering template with order total calculation, **so
that** customers can place orders online.

---

## Acceptance Criteria

| ID  | Criterion                                                                            | Validated By      |
| --- | ------------------------------------------------------------------------------------ | ----------------- |
| AC1 | "Restaurant Menu Order" template created with category `SERVICES`                    | Unit Tests        |
| AC2 | Schema: Multiple CHECKBOX fields (menu items) with nested NUMBER fields (quantities) | Seed Data         |
| AC3 | Each item includes `metadata.price`                                                  | Unit Tests        |
| AC4 | Business logic config: `{type: 'order', itemFields, calculateTotal}`                 | Unit Tests        |
| AC5 | `OrderExecutor` strategy class created                                               | Unit Tests        |
| AC6 | Calculates total: `sum(item.metadata.price * item.quantity)`                         | Unit Tests        |
| AC7 | Stores order total in submission metadata                                            | Integration Tests |
| AC8 | Frontend displays running total as user selects items                                | Component Tests   |

---

## Integration Verification

| ID  | Verification                              | Test Method       |
| --- | ----------------------------------------- | ----------------- |
| IV1 | Existing checkbox/number fields unchanged | Regression Tests  |
| IV2 | Calculation executes within 50ms          | Performance Tests |
| IV3 | Order total displays in analytics         | Component Tests   |

---

## Dev Notes

### Architecture Context

**Source**: docs/architecture/backend-architecture.md (Strategy Pattern),
docs/architecture/frontend-architecture.md (Reactive Forms)

This story implements a restaurant menu ordering template with automatic order total calculation.
The `OrderExecutor` calculates totals synchronously using the Strategy Pattern and stores results in
the existing `form_submissions.metadata` JSONB column. Similar to the quiz template (Story 29.13),
this executor requires no database tables and performs pure in-memory calculation for optimal
performance.

**Key Architectural Patterns**:

1. **Strategy Pattern**: `OrderExecutor` implements `ITemplateExecutor` interface (defined in Story
   29.11)
2. **JSONB Metadata Storage**: Uses existing `form_submissions.metadata` column (no new tables)
3. **Synchronous Execution**: No async database operations during calculation (pure arithmetic)
4. **Service Integration**: Integrates with `FormsService.submitForm()` workflow
5. **Real-Time Frontend Calculation**: Angular reactive forms with computed signals for running
   total

**Performance Requirements**:

- Order total calculation: < 50ms (P95)
- Frontend running total update: < 16ms (60fps)
- Support up to 100 menu items per order

---

### Backend Implementation

#### 1. Shared Types Extension

**File**: `packages/shared/src/types/templates.types.ts`

Add order-specific config type:

```typescript
/**
 * Menu item configuration with pricing
 * @since Epic 29, Story 29.15
 */
export interface MenuItemConfig {
  fieldId: string; // Field ID of the menu item checkbox
  quantityFieldId: string; // Field ID of the quantity number input
  price: number; // Price per unit (in cents to avoid floating point issues)
  name: string; // Display name of item
  category?: string; // Optional: category (appetizer, entree, dessert, etc.)
}

/**
 * Business logic configuration for restaurant order templates
 * @since Epic 29, Story 29.15
 */
export interface OrderLogicConfig {
  type: 'order';
  itemFields: MenuItemConfig[]; // Array of menu items with pricing
  calculateTotal: boolean; // Whether to calculate order total (always true)
  currency?: string; // Currency code (default: USD)
  taxRate?: number; // Optional: tax rate as decimal (e.g., 0.08 for 8%)
  serviceFee?: number; // Optional: fixed service fee in cents
}

/**
 * Order submission metadata stored in form_submissions.metadata JSONB
 * @since Epic 29, Story 29.15
 */
export interface OrderMetadata {
  subtotal: number; // Subtotal before tax/fees (in cents)
  tax?: number; // Tax amount (in cents)
  service_fee?: number; // Service fee (in cents)
  total: number; // Final total (in cents)
  items: Array<{
    fieldId: string;
    name: string;
    quantity: number;
    unitPrice: number; // Price per unit (in cents)
    itemTotal: number; // quantity * unitPrice (in cents)
  }>;
  ordered_at: string; // ISO timestamp of order
}
```

Update union type:

```typescript
export type TemplateBusinessLogicConfig =
  | InventoryLogicConfig
  | AppointmentLogicConfig
  | QuizLogicConfig
  | PollLogicConfig
  | OrderLogicConfig;
```

Rebuild shared package:

```bash
npm run build:shared
```

---

#### 2. Executor Strategy Class

**File**: `apps/forms-api/src/services/executors/order.executor.ts`

```typescript
import { PoolClient } from 'pg';
import {
  ITemplateExecutor,
  ExecutorValidation,
  ExecutorResult,
  FormTemplate,
  FormSubmission,
  OrderLogicConfig,
  OrderMetadata,
} from '@nodeangularfullstack/shared';
import { ApiError } from '../../utils/api-error';

/**
 * Order executor with automatic total calculation
 * Calculates order total synchronously without database operations
 *
 * @since Epic 29, Story 29.15
 * @implements ITemplateExecutor (Story 29.11)
 * @source docs/architecture/backend-architecture.md (Strategy Pattern)
 */
export class OrderExecutor implements ITemplateExecutor {
  /**
   * Validate order submission data
   * Checks that at least one item is selected with valid quantity
   */
  async validate(
    submission: Partial<FormSubmission>,
    template: FormTemplate,
    config: OrderLogicConfig
  ): Promise<ExecutorValidation> {
    const errors: string[] = [];
    const data = submission.data as Record<string, any>;

    // Validate that at least one item is selected
    let hasSelectedItems = false;

    for (const item of config.itemFields) {
      const isSelected = data[item.fieldId] === true || data[item.fieldId] === 'true';

      if (isSelected) {
        hasSelectedItems = true;

        // Validate quantity for selected items
        const quantity = parseInt(data[item.quantityFieldId], 10);

        if (isNaN(quantity) || quantity < 1) {
          errors.push(`Quantity for '${item.name}' must be at least 1`);
        }

        if (quantity > 100) {
          errors.push(`Quantity for '${item.name}' cannot exceed 100`);
        }
      }
    }

    if (!hasSelectedItems) {
      errors.push('Please select at least one menu item');
    }

    // Validate price values in configuration
    for (const item of config.itemFields) {
      if (item.price < 0) {
        errors.push(`Invalid price for '${item.name}'`);
      }
    }

    // Validate tax rate if provided
    if (config.taxRate !== undefined && (config.taxRate < 0 || config.taxRate > 1)) {
      errors.push('Tax rate must be between 0 and 1');
    }

    return {
      valid: errors.length === 0,
      errors,
    };
  }

  /**
   * Execute order total calculation
   * Calculates subtotal, tax, fees, and final total
   *
   * @param submission - Form submission record
   * @param template - Template configuration
   * @param config - Order logic configuration
   * @param client - Database client (unused for order, required by interface)
   * @returns Executor result with order details
   */
  async execute(
    submission: FormSubmission,
    template: FormTemplate,
    config: OrderLogicConfig,
    client?: PoolClient
  ): Promise<ExecutorResult> {
    const data = submission.data as Record<string, any>;

    let subtotal = 0;
    const items: OrderMetadata['items'] = [];

    // Calculate subtotal and collect item details
    for (const item of config.itemFields) {
      const isSelected = data[item.fieldId] === true || data[item.fieldId] === 'true';

      if (isSelected) {
        const quantity = parseInt(data[item.quantityFieldId], 10);
        const itemTotal = item.price * quantity;

        subtotal += itemTotal;

        items.push({
          fieldId: item.fieldId,
          name: item.name,
          quantity,
          unitPrice: item.price,
          itemTotal,
        });
      }
    }

    // Calculate tax if tax rate provided
    const tax = config.taxRate ? Math.round(subtotal * config.taxRate) : undefined;

    // Calculate service fee if provided
    const serviceFee = config.serviceFee || undefined;

    // Calculate final total
    const total = subtotal + (tax || 0) + (serviceFee || 0);

    // Prepare metadata
    const metadata: OrderMetadata = {
      subtotal,
      tax,
      service_fee: serviceFee,
      total,
      items,
      ordered_at: new Date().toISOString(),
    };

    // Prepare result
    const result: ExecutorResult = {
      success: true,
      data: metadata,
      message: `Order received. Total: ${this.formatCurrency(total, config.currency)}`,
    };

    return result;
  }

  /**
   * Format currency value
   * @param cents - Amount in cents
   * @param currency - Currency code (default: USD)
   * @returns Formatted currency string
   */
  private formatCurrency(cents: number, currency: string = 'USD'): string {
    const dollars = cents / 100;
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency,
    }).format(dollars);
  }
}
```

**Design Note**: Prices stored in **cents** (integer) to avoid floating-point precision issues. All
calculations use integer arithmetic, then divide by 100 for display.

---

#### 3. Service Integration

**File**: `apps/forms-api/src/services/forms.service.ts`

Update executor factory:

```typescript
import { OrderExecutor } from './executors/order.executor';

/**
 * Get executor instance based on config type
 * @source docs/architecture/backend-architecture.md (Strategy Pattern)
 */
private getExecutor(
  config: TemplateBusinessLogicConfig,
  sessionId?: string
): ITemplateExecutor {
  switch (config.type) {
    case 'inventory':
      const inventoryRepo = new ProductInventoryRepository(this.pool);
      return new InventoryExecutor(inventoryRepo);

    case 'appointment':
      const bookingRepo = new AppointmentBookingRepository(this.pool);
      return new AppointmentExecutor(bookingRepo);

    case 'quiz':
      return new QuizExecutor();

    case 'poll':
      if (!sessionId) {
        throw new ApiError(400, 'Session ID required for poll voting');
      }
      return new PollExecutor(this.submissionsRepo, sessionId);

    case 'order':
      return new OrderExecutor();

    default:
      throw new ApiError(400, `Unknown executor type: ${(config as any).type}`);
  }
}
```

Order executor integration (existing `submitForm()` flow works without changes).

---

### Frontend Implementation

#### 1. Running Total Component

**File**:
`apps/form-builder-ui/src/app/features/public/form-renderer/order-summary/order-summary.component.ts`

```typescript
import { Component, computed, inject, input, ChangeDetectionStrategy } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormGroup } from '@angular/forms';
import { CardModule } from 'primeng/card';
import { OrderLogicConfig, MenuItemConfig } from '@nodeangularfullstack/shared';

/**
 * Component displays running order total as user selects items
 * Real-time calculation using reactive form values
 *
 * @since Epic 29, Story 29.15
 * @source docs/architecture/frontend-architecture.md (Reactive Forms, Computed Signals)
 */
@Component({
  selector: 'app-order-summary',
  standalone: true,
  imports: [CommonModule, CardModule],
  changeDetection: ChangeDetectionStrategy.OnPush,
  template: `
    <p-card class="order-summary-card">
      <ng-template pTemplate="header">
        <div class="summary-header">
          <i class="pi pi-shopping-cart"></i>
          <h3>Order Summary</h3>
        </div>
      </ng-template>

      @if (selectedItems().length > 0) {
        <div class="order-items">
          @for (item of selectedItems(); track item.fieldId) {
            <div class="order-item">
              <div class="item-details">
                <span class="item-name">{{ item.name }}</span>
                <span class="item-quantity">x {{ item.quantity }}</span>
              </div>
              <span class="item-total">{{ formatCurrency(item.itemTotal) }}</span>
            </div>
          }
        </div>

        <div class="order-totals">
          <div class="total-row">
            <span class="label">Subtotal:</span>
            <span class="value">{{ formatCurrency(subtotal()) }}</span>
          </div>

          @if (config().taxRate) {
            <div class="total-row">
              <span class="label">Tax ({{ config().taxRate! * 100 }}%):</span>
              <span class="value">{{ formatCurrency(tax()) }}</span>
            </div>
          }

          @if (config().serviceFee) {
            <div class="total-row">
              <span class="label">Service Fee:</span>
              <span class="value">{{ formatCurrency(config().serviceFee!) }}</span>
            </div>
          }

          <div class="total-row final-total">
            <span class="label">Total:</span>
            <span class="value">{{ formatCurrency(total()) }}</span>
          </div>
        </div>
      } @else {
        <div class="empty-order">
          <i class="pi pi-inbox"></i>
          <p>No items selected</p>
        </div>
      }
    </p-card>
  `,
  styles: [
    `
      .order-summary-card {
        position: sticky;
        top: 20px;
        margin-top: 1rem;
      }

      .summary-header {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 1rem;
        background: var(--primary-500);
        color: white;
        border-radius: 6px 6px 0 0;
      }

      .summary-header i {
        font-size: 1.5rem;
      }

      .summary-header h3 {
        margin: 0;
        font-size: 1.25rem;
      }

      .order-items {
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--surface-border);
      }

      .order-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 0;
      }

      .item-details {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
      }

      .item-name {
        font-weight: 500;
        color: var(--text-color);
      }

      .item-quantity {
        font-size: 0.875rem;
        color: var(--text-color-secondary);
      }

      .item-total {
        font-weight: 600;
        color: var(--primary-color);
      }

      .order-totals {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .total-row {
        display: flex;
        justify-content: space-between;
        padding: 0.5rem 0;
      }

      .total-row.final-total {
        border-top: 2px solid var(--surface-border);
        padding-top: 0.75rem;
        margin-top: 0.5rem;
        font-size: 1.25rem;
        font-weight: bold;
      }

      .total-row .label {
        color: var(--text-color-secondary);
      }

      .total-row .value {
        color: var(--text-color);
        font-weight: 600;
      }

      .total-row.final-total .value {
        color: var(--primary-color);
      }

      .empty-order {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 2rem;
        color: var(--text-color-secondary);
      }

      .empty-order i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
      }

      .empty-order p {
        margin: 0;
        font-size: 1rem;
      }
    `,
  ],
})
export class OrderSummaryComponent {
  // Inputs
  readonly formGroup = input.required<FormGroup>();
  readonly config = input.required<OrderLogicConfig>();

  // Computed: Selected items with quantities and prices
  readonly selectedItems = computed(() => {
    const form = this.formGroup();
    const config = this.config();
    const items: Array<{
      fieldId: string;
      name: string;
      quantity: number;
      unitPrice: number;
      itemTotal: number;
    }> = [];

    for (const item of config.itemFields) {
      const isSelected = form.get(item.fieldId)?.value === true;

      if (isSelected) {
        const quantity = parseInt(form.get(item.quantityFieldId)?.value || '0', 10);

        if (quantity > 0) {
          items.push({
            fieldId: item.fieldId,
            name: item.name,
            quantity,
            unitPrice: item.price,
            itemTotal: item.price * quantity,
          });
        }
      }
    }

    return items;
  });

  // Computed: Subtotal
  readonly subtotal = computed(() => {
    return this.selectedItems().reduce((sum, item) => sum + item.itemTotal, 0);
  });

  // Computed: Tax
  readonly tax = computed(() => {
    const config = this.config();
    const subtotal = this.subtotal();
    return config.taxRate ? Math.round(subtotal * config.taxRate) : 0;
  });

  // Computed: Total
  readonly total = computed(() => {
    const config = this.config();
    return this.subtotal() + this.tax() + (config.serviceFee || 0);
  });

  /**
   * Format currency value from cents
   */
  formatCurrency(cents: number): string {
    const currency = this.config().currency || 'USD';
    const dollars = cents / 100;
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency,
    }).format(dollars);
  }
}
```

---

#### 2. Integration with FormRendererComponent

**File**: `apps/form-builder-ui/src/app/features/public/form-renderer/form-renderer.component.ts`

Add order summary integration:

```typescript
import { OrderSummaryComponent } from './order-summary/order-summary.component';
import { OrderLogicConfig } from '@nodeangularfullstack/shared';

@Component({
  // ... existing config
  imports: [..., OrderSummaryComponent]
})
export class FormRendererComponent {
  // ... existing state

  readonly isOrderTemplate = computed(() => {
    const template = this.formSchema()?.template;
    return template?.business_logic_config?.type === 'order';
  });

  readonly orderConfig = computed(() => {
    if (!this.isOrderTemplate()) return null;
    return this.formSchema()?.template?.business_logic_config as OrderLogicConfig;
  });
}
```

Update template:

```typescript
<div class="form-renderer-container">
  <div class="form-column">
    <!-- Existing form rendering -->
    <form [formGroup]="formGroup" (ngSubmit)="onSubmit()">
      <!-- Form fields -->
    </form>
  </div>

  @if (isOrderTemplate() && orderConfig()) {
    <div class="summary-column">
      <app-order-summary
        [formGroup]="formGroup"
        [config]="orderConfig()!"
      />
    </div>
  }
</div>
```

Add CSS for two-column layout:

```css
.form-renderer-container {
  display: grid;
  grid-template-columns: 1fr;
  gap: 2rem;
}

@media (min-width: 768px) {
  .form-renderer-container {
    grid-template-columns: 2fr 1fr;
  }
}

.form-column {
  min-width: 0; /* Prevent overflow */
}

.summary-column {
  min-width: 0; /* Prevent overflow */
}
```

---

#### 3. Analytics Extension

**File**:
`apps/form-builder-ui/src/app/features/dashboard/form-analytics/statistics-engine.service.ts`

Add order analytics:

```typescript
import { OrderMetadata } from '@nodeangularfullstack/shared';

/**
 * Analyze order revenue statistics
 * @param submissions - All form submissions
 * @returns Revenue statistics
 */
analyzeOrderRevenue(submissions: FormSubmission[]): {
  totalRevenue: number;
  averageOrderValue: number;
  topItems: Array<{ name: string; count: number; revenue: number }>;
} {
  let totalRevenue = 0;
  const itemStats = new Map<string, { count: number; revenue: number }>();

  submissions.forEach(sub => {
    const metadata = sub.metadata as OrderMetadata;
    if (!metadata?.total) return;

    totalRevenue += metadata.total;

    metadata.items.forEach(item => {
      const existing = itemStats.get(item.name) || { count: 0, revenue: 0 };
      itemStats.set(item.name, {
        count: existing.count + item.quantity,
        revenue: existing.revenue + item.itemTotal
      });
    });
  });

  const averageOrderValue = submissions.length > 0
    ? Math.round(totalRevenue / submissions.length)
    : 0;

  const topItems = Array.from(itemStats.entries())
    .map(([name, stats]) => ({ name, ...stats }))
    .sort((a, b) => b.revenue - a.revenue)
    .slice(0, 10);

  return {
    totalRevenue,
    averageOrderValue,
    topItems
  };
}
```

---

### Testing Implementation

#### 1. Backend Unit Tests

**File**: `apps/forms-api/tests/unit/services/executors/order.executor.test.ts`

```typescript
import { OrderExecutor } from '../../../../src/services/executors/order.executor';
import { FormTemplate, FormSubmission, OrderLogicConfig } from '@nodeangularfullstack/shared';

describe('OrderExecutor', () => {
  let executor: OrderExecutor;

  const mockConfig: OrderLogicConfig = {
    type: 'order',
    itemFields: [
      { fieldId: 'pizza', quantityFieldId: 'pizza_qty', price: 1200, name: 'Pizza' }, // $12.00
      { fieldId: 'burger', quantityFieldId: 'burger_qty', price: 900, name: 'Burger' }, // $9.00
      { fieldId: 'fries', quantityFieldId: 'fries_qty', price: 400, name: 'Fries' }, // $4.00
    ],
    calculateTotal: true,
    currency: 'USD',
    taxRate: 0.08, // 8% tax
    serviceFee: 200, // $2.00 service fee
  };

  const mockTemplate: FormTemplate = {
    id: 'template-123',
    name: 'Restaurant Menu',
    category: 'SERVICES',
    template_schema: {} as any,
    business_logic_config: mockConfig,
    is_active: true,
    created_at: new Date(),
    updated_at: new Date(),
  };

  beforeEach(() => {
    executor = new OrderExecutor();
  });

  describe('validate', () => {
    it('should pass validation for valid order', async () => {
      const submission = {
        data: {
          pizza: true,
          pizza_qty: '2',
          burger: true,
          burger_qty: '1',
        },
      };

      const result = await executor.validate(submission, mockTemplate, mockConfig);

      expect(result.valid).toBe(true);
      expect(result.errors).toEqual([]);
    });

    it('should fail validation when no items selected', async () => {
      const submission = {
        data: {
          pizza: false,
          burger: false,
          fries: false,
        },
      };

      const result = await executor.validate(submission, mockTemplate, mockConfig);

      expect(result.valid).toBe(false);
      expect(result.errors).toContain('Please select at least one menu item');
    });

    it('should fail validation for invalid quantity', async () => {
      const submission = {
        data: {
          pizza: true,
          pizza_qty: '0', // Invalid: quantity must be >= 1
        },
      };

      const result = await executor.validate(submission, mockTemplate, mockConfig);

      expect(result.valid).toBe(false);
      expect(result.errors.some((e) => e.includes('Quantity'))).toBe(true);
    });

    it('should fail validation for excessive quantity', async () => {
      const submission = {
        data: {
          pizza: true,
          pizza_qty: '150', // Exceeds 100 limit
        },
      };

      const result = await executor.validate(submission, mockTemplate, mockConfig);

      expect(result.valid).toBe(false);
      expect(result.errors.some((e) => e.includes('cannot exceed 100'))).toBe(true);
    });
  });

  describe('execute', () => {
    it('should calculate order total with tax and service fee', async () => {
      const mockSubmission: FormSubmission = {
        id: 'sub-123',
        form_id: 'form-123',
        data: {
          pizza: true,
          pizza_qty: '2',
          burger: true,
          burger_qty: '1',
        },
        submitted_at: new Date(),
        created_at: new Date(),
      };

      const result = await executor.execute(mockSubmission, mockTemplate, mockConfig);

      // Subtotal: (1200 * 2) + (900 * 1) = 2400 + 900 = 3300 cents ($33.00)
      // Tax: 3300 * 0.08 = 264 cents ($2.64)
      // Service Fee: 200 cents ($2.00)
      // Total: 3300 + 264 + 200 = 3764 cents ($37.64)

      expect(result.success).toBe(true);
      expect(result.data.subtotal).toBe(3300);
      expect(result.data.tax).toBe(264);
      expect(result.data.service_fee).toBe(200);
      expect(result.data.total).toBe(3764);
      expect(result.data.items.length).toBe(2);
      expect(result.message).toContain('$37.64');
    });

    it('should calculate order without tax or service fee', async () => {
      const configNoExtras: OrderLogicConfig = {
        ...mockConfig,
        taxRate: undefined,
        serviceFee: undefined,
      };

      const mockSubmission: FormSubmission = {
        id: 'sub-123',
        form_id: 'form-123',
        data: {
          fries: true,
          fries_qty: '3',
        },
        submitted_at: new Date(),
        created_at: new Date(),
      };

      const result = await executor.execute(mockSubmission, mockTemplate, configNoExtras);

      // Subtotal: 400 * 3 = 1200 cents ($12.00)
      // No tax or service fee

      expect(result.data.subtotal).toBe(1200);
      expect(result.data.tax).toBeUndefined();
      expect(result.data.service_fee).toBeUndefined();
      expect(result.data.total).toBe(1200);
    });

    it('should include detailed item breakdown', async () => {
      const mockSubmission: FormSubmission = {
        id: 'sub-123',
        form_id: 'form-123',
        data: {
          pizza: true,
          pizza_qty: '1',
          fries: true,
          fries_qty: '2',
        },
        submitted_at: new Date(),
        created_at: new Date(),
      };

      const result = await executor.execute(mockSubmission, mockTemplate, mockConfig);

      expect(result.data.items).toEqual([
        {
          fieldId: 'pizza',
          name: 'Pizza',
          quantity: 1,
          unitPrice: 1200,
          itemTotal: 1200,
        },
        {
          fieldId: 'fries',
          name: 'Fries',
          quantity: 2,
          unitPrice: 400,
          itemTotal: 800,
        },
      ]);
    });

    it('should execute in < 50ms', async () => {
      const mockSubmission: FormSubmission = {
        id: 'sub-123',
        form_id: 'form-123',
        data: {
          pizza: true,
          pizza_qty: '2',
          burger: true,
          burger_qty: '1',
          fries: true,
          fries_qty: '3',
        },
        submitted_at: new Date(),
        created_at: new Date(),
      };

      const startTime = Date.now();
      await executor.execute(mockSubmission, mockTemplate, mockConfig);
      const executionTime = Date.now() - startTime;

      expect(executionTime).toBeLessThan(50);
    });
  });
});
```

---

#### 2. Frontend Component Tests

**File**:
`apps/form-builder-ui/src/app/features/public/form-renderer/order-summary/order-summary.component.spec.ts`

```typescript
import { ComponentFixture, TestBed } from '@angular/core/testing';
import { FormGroup, FormControl, ReactiveFormsModule } from '@angular/forms';
import { OrderSummaryComponent } from './order-summary.component';
import { OrderLogicConfig } from '@nodeangularfullstack/shared';
import { signal } from '@angular/core';

describe('OrderSummaryComponent', () => {
  let component: OrderSummaryComponent;
  let fixture: ComponentFixture<OrderSummaryComponent>;
  let formGroup: FormGroup;

  const mockConfig: OrderLogicConfig = {
    type: 'order',
    itemFields: [
      { fieldId: 'pizza', quantityFieldId: 'pizza_qty', price: 1200, name: 'Pizza' },
      { fieldId: 'burger', quantityFieldId: 'burger_qty', price: 900, name: 'Burger' },
    ],
    calculateTotal: true,
    currency: 'USD',
    taxRate: 0.08,
    serviceFee: 200,
  };

  beforeEach(async () => {
    formGroup = new FormGroup({
      pizza: new FormControl(false),
      pizza_qty: new FormControl('1'),
      burger: new FormControl(false),
      burger_qty: new FormControl('1'),
    });

    await TestBed.configureTestingModule({
      imports: [OrderSummaryComponent, ReactiveFormsModule],
    }).compileComponents();

    fixture = TestBed.createComponent(OrderSummaryComponent);
    component = fixture.componentInstance;
    fixture.componentRef.setInput('formGroup', formGroup);
    fixture.componentRef.setInput('config', mockConfig);
  });

  it('should create', () => {
    expect(component).toBeTruthy();
  });

  it('should show empty state when no items selected', () => {
    fixture.detectChanges();

    const compiled = fixture.nativeElement;
    expect(compiled.textContent).toContain('No items selected');
    expect(component.selectedItems().length).toBe(0);
  });

  it('should calculate subtotal for selected items', () => {
    formGroup.patchValue({
      pizza: true,
      pizza_qty: '2',
    });

    fixture.detectChanges();

    expect(component.selectedItems().length).toBe(1);
    expect(component.subtotal()).toBe(2400); // 1200 * 2
  });

  it('should calculate tax correctly', () => {
    formGroup.patchValue({
      pizza: true,
      pizza_qty: '1',
    });

    fixture.detectChanges();

    expect(component.subtotal()).toBe(1200);
    expect(component.tax()).toBe(96); // 1200 * 0.08 = 96
  });

  it('should calculate total with tax and service fee', () => {
    formGroup.patchValue({
      pizza: true,
      pizza_qty: '1',
      burger: true,
      burger_qty: '1',
    });

    fixture.detectChanges();

    // Subtotal: 1200 + 900 = 2100
    // Tax: 2100 * 0.08 = 168
    // Service Fee: 200
    // Total: 2100 + 168 + 200 = 2468

    expect(component.subtotal()).toBe(2100);
    expect(component.tax()).toBe(168);
    expect(component.total()).toBe(2468);
  });

  it('should update in real-time as form changes', () => {
    formGroup.patchValue({
      pizza: true,
      pizza_qty: '1',
    });

    fixture.detectChanges();
    expect(component.total()).toBe(1496); // 1200 + 96 + 200

    // Update quantity
    formGroup.patchValue({ pizza_qty: '3' });
    fixture.detectChanges();
    expect(component.total()).toBe(4088); // 3600 + 288 + 200
  });

  it('should format currency correctly', () => {
    const formatted = component.formatCurrency(1200);
    expect(formatted).toBe('$12.00');

    const formatted2 = component.formatCurrency(4550);
    expect(formatted2).toBe('$45.50');
  });
});
```

---

### Template Seed Data

**File**: `apps/forms-api/database/seeds/035_seed_restaurant_menu_template.ts`

```typescript
import { Pool } from 'pg';

/**
 * Seed restaurant menu order template
 * @since Epic 29, Story 29.15
 */
export async function seedRestaurantMenuTemplate(pool: Pool): Promise<void> {
  const client = await pool.connect();

  try {
    await client.query('BEGIN');

    // Check if template already exists
    const existing = await client.query(
      `SELECT id FROM form_templates WHERE name = 'Restaurant Menu Order'`
    );

    if (existing.rows.length > 0) {
      console.log('Restaurant Menu Order template already exists, skipping...');
      await client.query('COMMIT');
      return;
    }

    // Create template
    const templateSchema = {
      fields: [
        {
          id: 'margherita_pizza',
          type: 'CHECKBOX',
          label: 'Margherita Pizza ($12.00)',
          required: false,
          order: 1,
        },
        {
          id: 'margherita_pizza_qty',
          type: 'NUMBER',
          label: 'Quantity',
          required: false,
          defaultValue: 1,
          order: 2,
        },
        {
          id: 'pepperoni_pizza',
          type: 'CHECKBOX',
          label: 'Pepperoni Pizza ($14.00)',
          required: false,
          order: 3,
        },
        {
          id: 'pepperoni_pizza_qty',
          type: 'NUMBER',
          label: 'Quantity',
          required: false,
          defaultValue: 1,
          order: 4,
        },
        {
          id: 'burger',
          type: 'CHECKBOX',
          label: 'Classic Burger ($9.00)',
          required: false,
          order: 5,
        },
        {
          id: 'burger_qty',
          type: 'NUMBER',
          label: 'Quantity',
          required: false,
          defaultValue: 1,
          order: 6,
        },
        {
          id: 'fries',
          type: 'CHECKBOX',
          label: 'French Fries ($4.00)',
          required: false,
          order: 7,
        },
        {
          id: 'fries_qty',
          type: 'NUMBER',
          label: 'Quantity',
          required: false,
          defaultValue: 1,
          order: 8,
        },
        {
          id: 'salad',
          type: 'CHECKBOX',
          label: 'Caesar Salad ($7.00)',
          required: false,
          order: 9,
        },
        {
          id: 'salad_qty',
          type: 'NUMBER',
          label: 'Quantity',
          required: false,
          defaultValue: 1,
          order: 10,
        },
        {
          id: 'customer_name',
          type: 'TEXT',
          label: 'Name',
          required: true,
          order: 11,
        },
        {
          id: 'customer_phone',
          type: 'TEL',
          label: 'Phone Number',
          required: true,
          order: 12,
        },
        {
          id: 'delivery_address',
          type: 'TEXTAREA',
          label: 'Delivery Address',
          required: false,
          order: 13,
        },
      ],
    };

    const businessLogicConfig = {
      type: 'order',
      itemFields: [
        {
          fieldId: 'margherita_pizza',
          quantityFieldId: 'margherita_pizza_qty',
          price: 1200,
          name: 'Margherita Pizza',
          category: 'pizza',
        },
        {
          fieldId: 'pepperoni_pizza',
          quantityFieldId: 'pepperoni_pizza_qty',
          price: 1400,
          name: 'Pepperoni Pizza',
          category: 'pizza',
        },
        {
          fieldId: 'burger',
          quantityFieldId: 'burger_qty',
          price: 900,
          name: 'Classic Burger',
          category: 'main',
        },
        {
          fieldId: 'fries',
          quantityFieldId: 'fries_qty',
          price: 400,
          name: 'French Fries',
          category: 'side',
        },
        {
          fieldId: 'salad',
          quantityFieldId: 'salad_qty',
          price: 700,
          name: 'Caesar Salad',
          category: 'side',
        },
      ],
      calculateTotal: true,
      currency: 'USD',
      taxRate: 0.08,
      serviceFee: 200,
    };

    await client.query(
      `
      INSERT INTO form_templates (
        name,
        category,
        description,
        template_schema,
        business_logic_config,
        is_active
      ) VALUES ($1, $2, $3, $4, $5, $6)
    `,
      [
        'Restaurant Menu Order',
        'SERVICES',
        'Restaurant menu ordering template with automatic order total calculation including tax and service fees',
        JSON.stringify(templateSchema),
        JSON.stringify(businessLogicConfig),
        true,
      ]
    );

    console.log('✓ Restaurant Menu Order template seeded successfully');

    await client.query('COMMIT');
  } catch (error) {
    await client.query('ROLLBACK');
    console.error('Error seeding restaurant menu template:', error);
    throw error;
  } finally {
    client.release();
  }
}
```

---

## Tasks

| ID        | Task                                                                   | Acceptance Criteria | Estimated Hours |
| --------- | ---------------------------------------------------------------------- | ------------------- | --------------- |
| 1         | Extend shared types with `OrderLogicConfig` and `OrderMetadata`        | AC4                 | 1.0             |
| 2         | Create `OrderExecutor` strategy class implementing `ITemplateExecutor` | AC5, AC6            | 3.5             |
| 3         | Integrate `OrderExecutor` into `FormsService` executor factory         | AC7                 | 1.0             |
| 4         | Create `OrderSummaryComponent` with real-time total calculation        | AC8                 | 5.0             |
| 5         | Integrate `OrderSummaryComponent` with `FormRendererComponent`         | AC8                 | 2.0             |
| 6         | Add two-column layout CSS for form + summary display                   | AC8                 | 1.5             |
| 7         | Extend `StatisticsEngineService` with `analyzeOrderRevenue()` method   | IV3                 | 2.5             |
| 8         | Update `FormAnalyticsComponent` to display order revenue statistics    | IV3                 | 2.0             |
| 9         | Write backend unit tests for `OrderExecutor`                           | AC5-AC7             | 3.0             |
| 10        | Write backend integration tests for order submission flow              | AC7                 | 2.0             |
| 11        | Write frontend component tests for `OrderSummaryComponent`             | AC8                 | 3.0             |
| 12        | Create seed data for restaurant menu template                          | AC1, AC2, AC3       | 1.5             |
| 13        | Write performance tests validating 50ms execution time                 | IV2                 | 1.0             |
| **Total** |                                                                        |                     | **29.0 hours**  |

---

## QA Results

_To be updated during development_

| Test Type         | Status  | Coverage         | Notes |
| ----------------- | ------- | ---------------- | ----- |
| Unit Tests        | Pending | Target: 90%+     | -     |
| Integration Tests | Pending | -                | -     |
| Component Tests   | Pending | Target: 85%+     | -     |
| Performance Tests | Pending | Target: 50ms P95 | -     |

---

## Gate Status

**Quality Gate**: ❌ Not Started

**Checklist**:

- [ ] All unit tests passing (90%+ coverage for executor)
- [ ] All integration tests passing
- [ ] All component tests passing (order summary + real-time calculation)
- [ ] Performance requirement met (50ms P95 for calculation)
- [ ] Real-time total updates work smoothly (< 16ms)
- [ ] No regression in existing checkbox/number field functionality
- [ ] Order revenue analytics display correctly
- [ ] Code reviewed and approved
- [ ] TypeScript strict mode passing with no errors
- [ ] ESLint passing with no warnings

---

## Related Documentation

- **PRD**: docs/prd/epic-29-form-templates-system.md
- **Architecture**: docs/architecture/backend-architecture.md (Strategy Pattern)
- **Architecture**: docs/architecture/frontend-architecture.md (Reactive Forms, Computed Signals)
- **Related Stories**:
  - Story 29.11: Product Template with Inventory Tracking (Base ITemplateExecutor Interface)
  - Story 29.13: Quiz Template with Scoring Logic (Similar in-memory pattern)
  - Story 29.16: End-to-End Template System Testing and Documentation (Next story)
- **Gate File**: docs/qa/gates/29.15-restaurant-menu-template-order-summary.yml (to be created)

---

## Notes

### Currency Handling

**Cents-Based Arithmetic**: All prices stored in cents (integer) to avoid floating-point precision
issues:

- Store: `1200` (represents $12.00)
- Calculate: `1200 * 2 = 2400` (integer arithmetic, no rounding errors)
- Display: `2400 / 100 = 24.00` → `$24.00` (formatted with Intl.NumberFormat)

**Why This Matters**: JavaScript's `0.1 + 0.2 === 0.30000000000000004` problem would cause incorrect
totals with decimal arithmetic.

### Real-Time Calculation

**Computed Signals for Performance**: Angular's computed signals provide:

- **Automatic Updates**: Total recalculates when form values change (no manual subscriptions)
- **Efficient**: Only recomputes when dependencies change (reactive granularity)
- **60fps Updates**: Computation completes in < 16ms for smooth UX

**Form Integration**: `OrderSummaryComponent` reacts to `FormGroup` value changes via computed
signals (no explicit RxJS subscriptions needed).

### Analytics Value

**Revenue Insights**:

- Total revenue across all orders
- Average order value (AOV)
- Top 10 menu items by revenue
- Item popularity (quantity sold)

**Business Metrics**: Helps restaurant owners understand:

- Which items drive revenue
- Optimal pricing strategies
- Menu optimization opportunities

### UX Considerations

**Two-Column Layout**:

- Left: Form with menu items (scrollable)
- Right: Sticky order summary (always visible)
- Mobile: Stacks vertically (form above, summary below)

**Running Total**: Provides instant feedback as users build their order, reducing cart abandonment.

---

_Story created: 2025-01-09_ _Last updated: 2025-01-09_
