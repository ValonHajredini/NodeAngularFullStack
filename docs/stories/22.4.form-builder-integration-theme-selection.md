# Story 22.4: Form Builder Integration and Theme Selection Enhancement - Brownfield Addition

## User Story

As a form builder user, I want custom themes available in the theme dropdown alongside predefined
themes, So that I can apply admin-created themes to my forms seamlessly without any workflow
changes.

## Story Context

**Existing System Integration:**

- Integrates with: Epic 20-21 theme dropdown, FormBuilderService, theme selection workflow
- Technology: Angular 20+ standalone components, Epic 20-21 ThemeDropdownComponent, NgRx Signals
- Follows pattern: Existing theme selection in
  `apps/web/src/app/features/tools/components/form-builder/theme-dropdown/`
- Touch points: Theme dropdown UI, theme application logic, form persistence, theme preview

## Acceptance Criteria

**Functional Requirements:**

1. Theme dropdown displays custom themes with visual indicators (icon/badge) distinguishing them
   from predefined themes
2. Custom theme selection applies identically to predefined themes using existing
   ThemePreviewService
3. Form builder preview shows custom themes correctly with all field types
4. Theme persistence saves custom theme association with forms in database
5. Theme switching between predefined and custom themes operates smoothly without performance impact

**Integration Requirements:** 6. Existing Epic 20-21 theme selection workflow continues unchanged 7.
Form builder performance remains unaffected with additional custom themes loaded 8. Theme
application logic (Epic 21) works identically for custom themes 9. Form saving and loading preserves
custom theme associations correctly

**Quality Requirements:** 10. Component tests verify custom theme integration with existing
dropdown 11. Theme loading handles large numbers of custom themes efficiently 12. UI clearly
differentiates custom vs predefined themes for user clarity

## Technical Notes

- **Integration Approach**: Extend existing ThemeDropdownComponent to fetch and display custom
  themes
- **Existing Pattern Reference**: Follow Epic 20-21 theme loading and application patterns
- **Key Constraints**: No breaking changes to existing theme selection UX, maintain performance

## Definition of Done

- [ ] Theme dropdown loads and displays custom themes with visual indicators
- [ ] Custom theme selection applies correctly using existing ThemePreviewService
- [ ] Form persistence includes custom theme associations
- [ ] Theme switching performance maintained
- [ ] Component tests verify integration functionality
- [ ] No regression in existing Epic 20-21 theme selection

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk**: Custom themes break existing theme application logic
- **Mitigation**: Use identical theme application patterns, comprehensive testing
- **Rollback**: Revert theme dropdown to predefined themes only

**Compatibility Verification:**

- [ ] No breaking changes to existing theme dropdown component
- [ ] Theme application follows Epic 20-21 patterns exactly
- [ ] Form builder performance baseline maintained
- [ ] Existing form theme associations remain functional

## Files Modified

**Modified Files:**

- `apps/web/src/app/features/tools/components/form-builder/theme-dropdown/theme-dropdown.component.ts`
- `apps/web/src/app/features/tools/components/form-builder/theme-dropdown/theme-dropdown.component.html`
- `apps/web/src/app/features/tools/components/form-builder/forms-api.service.ts` (add custom theme
  loading)
- `apps/web/src/app/features/tools/components/form-builder/form-builder.service.ts` (extend theme
  management)

**Test Files:**

- `apps/web/src/app/features/tools/components/form-builder/theme-dropdown/theme-dropdown.component.spec.ts`

**Integration Points:**

- Epic 20-21 theme system: ThemeDropdownComponent, theme application logic
- FormBuilderService: Theme persistence and form state management
- FormsApiService: API calls for custom theme loading
- Epic 21 theme application: CSS utility classes and visual theme rendering

## UI Enhancement Specification

```html
<!-- Enhanced Theme Dropdown -->
<p-dropdown
  [options]="allThemes"
  [(ngModel)]="selectedTheme"
  optionLabel="name"
  optionValue="id"
  placeholder="Select a theme"
>
  <ng-template pTemplate="selectedItem" let-theme>
    <div class="flex align-items-center gap-2">
      <i [class]="getThemeIcon(theme)" class="text-sm"></i>
      <span>{{ theme.name }}</span>
    </div>
  </ng-template>

  <ng-template pTemplate="item" let-theme>
    <div class="flex align-items-center gap-2">
      <i [class]="getThemeIcon(theme)" class="text-sm"></i>
      <span>{{ theme.name }}</span>
      <p-badge *ngIf="theme.isCustom" value="Custom" severity="info" class="ml-auto"> </p-badge>
    </div>
  </ng-template>
</p-dropdown>
```

## Theme Loading Implementation

```typescript
// Extended theme loading in FormsApiService
async getAllThemes(): Promise<Theme[]> {
  const [predefinedThemes, customThemes] = await Promise.all([
    this.getPredefinedThemes(), // Existing Epic 20 method
    this.getCustomThemes()      // New method for custom themes
  ]);

  return [
    ...predefinedThemes.map(theme => ({ ...theme, isCustom: false })),
    ...customThemes.map(theme => ({ ...theme, isCustom: true }))
  ];
}

// Theme application (no changes needed - uses existing ThemePreviewService)
applyTheme(theme: Theme): void {
  // Epic 20-21 logic unchanged
  this.themePreviewService.injectThemeVariables(theme.themeDefinition);
  this.formBuilderService.updateFormTheme(theme.id);
}
```

## Visual Indicators

**Predefined Themes:**

- Icon: `pi pi-palette` (existing Epic 20 icon)
- No badge

**Custom Themes:**

- Icon: `pi pi-cog` (settings/custom indicator)
- Badge: "Custom" with info severity
- Tooltip: "Created by admin" on hover

## Performance Considerations

**Theme Loading:**

- Load custom themes once on form builder initialization
- Cache themes in service to avoid repeated API calls
- Lazy load theme previews only when dropdown opened

**Theme Switching:**

- Use existing Epic 21 debounced theme application (300ms)
- No additional performance overhead for custom themes
- Maintain Epic 20-21 smooth transition animations

## Form Persistence Integration

```typescript
// Form save with custom theme support
saveForm(formData: FormData): Observable<Form> {
  const formPayload = {
    ...formData,
    themeId: this.selectedTheme.id, // Works for both predefined and custom
    themeType: this.selectedTheme.isCustom ? 'custom' : 'predefined'
  };

  return this.http.post<Form>('/api/forms', formPayload);
}

// Form load with custom theme support
loadForm(formId: string): Observable<Form> {
  return this.http.get<Form>(`/api/forms/${formId}`).pipe(
    tap(form => {
      // Load associated theme (predefined or custom)
      this.loadAndApplyTheme(form.themeId);
    })
  );
}
```

---

**Story Owner**: Frontend Developer (Form Builder specialist) **Estimated Duration**: 6 hours  
**Priority**: Depends on Stories 22.1, 22.2, 22.3 completion **Epic**: Epic 22 - Admin Theme
Designer
