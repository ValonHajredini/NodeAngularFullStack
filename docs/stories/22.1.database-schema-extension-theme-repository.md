# Story 22.1: Database Schema Extension and Theme Repository Enhancement - Brownfield Addition

## User Story

As a system administrator, I want the database schema extended to support custom theme storage, So
that custom themes can be persisted alongside the existing 9 predefined themes without breaking Epic
20-21 functionality.

## Story Context

**Existing System Integration:**

- Integrates with: Epic 20-21 theme infrastructure (`form_themes` table, ThemesRepository)
- Technology: PostgreSQL 15+, TypeScript Repository pattern, Express.js migrations
- Follows pattern: Existing migration system in `apps/api/database/migrations/`
- Touch points: `form_themes` table, `FormSchemasRepository`, theme seeding system

## Acceptance Criteria

**Functional Requirements:**

1. `form_themes` table extended with `is_custom` (boolean), `creator_id` (uuid), `theme_definition`
   (jsonb) columns
2. Database migration `023_extend_form_themes_for_custom_themes.sql` created with rollback
   capability
3. ThemesRepository class extended with CRUD operations for custom themes
4. Theme validation ensures custom themes don't exceed 50KB storage limit
5. Custom themes can be queried separately from predefined themes

**Integration Requirements:** 6. Existing 9 predefined themes continue functioning unchanged after
migration 7. Epic 20-21 theme selection workflow operates without modifications 8. Published forms
with existing themes render identically 9. Integration with existing `form_schemas.theme_id` foreign
key relationships maintained

**Quality Requirements:** 10. Migration is covered by integration tests in
`apps/api/tests/integration/` 11. Repository tests verify both predefined and custom theme
operations 12. No regression in existing Epic 20-21 functionality verified

## Technical Notes

- **Integration Approach**: Additive-only database changes, extending existing repository pattern
- **Existing Pattern Reference**: Follow `018_add_theme_id_to_form_schemas.sql` migration structure
- **Key Constraints**: Must not modify existing `form_themes` records; custom themes stored as
  structured JSON

## Definition of Done

- [ ] Database migration created and tested (up/down)
- [ ] ThemesRepository extended with custom theme methods
- [ ] Integration tests pass for theme operations
- [ ] Existing Epic 20-21 theme functionality verified unchanged
- [ ] Custom theme storage validation implemented
- [ ] Migration tested in development environment

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk**: Database migration breaks existing theme relationships
- **Mitigation**: Additive-only changes with comprehensive rollback testing
- **Rollback**: `DOWN_023_remove_custom_theme_extensions.sql` script provided

**Compatibility Verification:**

- [ ] No breaking changes to existing `form_themes` structure
- [ ] Database changes are additive only (new columns with defaults)
- [ ] No changes to existing theme seeding or API endpoints
- [ ] Performance impact negligible (indexed columns for custom theme queries)

## Files Modified

**New Files:**

- `apps/api/database/migrations/023_extend_form_themes_for_custom_themes.sql`
- `apps/api/database/migrations/DOWN_023_remove_custom_theme_extensions.sql`
- `apps/api/tests/integration/custom-themes.test.ts`

**Modified Files:**

- `apps/api/src/repositories/form-schemas.repository.ts` (extend ThemesRepository methods)

**Integration Points:**

- Epic 20-21 theme system: `form_themes` table, theme seeding, FormSchemasRepository
- Authentication system: `creator_id` links to existing `users` table
- Migration system: follows existing migration numbering and structure

---

**Story Owner**: Backend Developer **Estimated Duration**: 4 hours **Priority**: Must complete
before any other Epic 22 stories **Epic**: Epic 22 - Admin Theme Designer
