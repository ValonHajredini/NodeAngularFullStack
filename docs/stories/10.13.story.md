# Story 10.13: Form Builder - Live Form Preview in New Tab

## User Story

**As a** form creator, **I want** to preview my form in a new browser tab while building it, **So
that** I can see exactly how my form will appear to end users without needing to publish it first.

---

## Story Context

**Existing System Integration:**

- **Integrates with:**
  - Form Builder Component
    ([form-builder.component.ts:698-705](apps/web/src/app/features/tools/components/form-builder/form-builder.component.ts#L698-L705))
  - Form Renderer Component
    ([form-renderer.component.ts:42-48](apps/web/src/app/features/public/form-renderer/form-renderer.component.ts#L42-L48))
  - FormBuilderService
    ([form-builder.service.ts](apps/web/src/app/features/tools/components/form-builder/form-builder.service.ts))
  - Router ([app.routes.ts:24-29](apps/web/src/app/app.routes.ts#L24-L29))

- **Technology:** Angular 20+ standalone components, Angular Router with `target="_blank"`
  navigation, RxJS observables, localStorage for preview data

- **Follows pattern:**
  - Public form rendering pattern (existing `/forms/render/:token` route)
  - Window.open for new tab navigation
  - Preview mode with temporary data storage

- **Touch points:**
  - Routes: Public form renderer route (`/forms/render/:token`) will be reused for preview mode
  - Components: FormBuilderComponent (preview trigger), FormRendererComponent (display preview)
  - Services: FormBuilderService (current form state), Router (new tab navigation)
  - Storage: localStorage or sessionStorage for temporary preview data

---

## Acceptance Criteria

**Functional Requirements:**

1. **Preview Button**: Clicking "Preview" button in FormBuilderComponent toolbar opens form preview
   in new browser tab (`target="_blank"`)

2. **Preview URL**: Preview opens at `/forms/preview/:previewId` route (separate from published
   forms at `/forms/render/:token`)
   - `previewId` is a temporary UUID generated client-side for this preview session
   - Preview data stored in sessionStorage with key `form-preview-{previewId}`

3. **Preview Data**: Preview displays current form state including:
   - Form title, description, layout settings (from FormSettings)
   - All form fields with current configuration (from FormBuilderService.formFields())
   - Responsive layout matching column settings
   - Field validation rules and properties

4. **Preview Mode Banner**: Preview page displays prominent banner at top:
   - "PREVIEW MODE - This is a temporary preview. Changes are not saved."
   - Orange/yellow background with info icon
   - Banner does not appear in published forms

**Integration Requirements:**

5. Form preview reuses existing FormRendererComponent with preview mode flag

6. Preview data retrieval uses sessionStorage (not API calls) for instant preview without backend

7. Preview button remains enabled regardless of form publish status (can preview unpublished forms)

8. Preview form is read-only (submit button disabled or hidden in preview mode)

**Quality Requirements:**

9. Preview opens in new tab without blocking popup warnings (uses window.open with proper timing)

10. Preview data cleans up after browser tab closes (sessionStorage auto-cleanup)

11. No breaking changes to existing form publish/render workflow

12. TypeScript strict mode passes, no new ESLint warnings

---

## Technical Notes

**Integration Approach:**

1. **Preview Route** (add to [app.routes.ts:24-29](apps/web/src/app/app.routes.ts#L24-L29)):

   ```typescript
   // Add new preview route before existing render route
   {
     path: 'forms/preview/:previewId',
     loadComponent: () =>
       import('./features/public/form-renderer/form-renderer.component').then(
         (m) => m.FormRendererComponent,
       ),
   },
   ```

2. **Preview Button Implementation** (update
   [form-builder.component.ts:698-705](apps/web/src/app/features/tools/components/form-builder/form-builder.component.ts#L698-L705)):

   ```typescript
   onPreview(): void {
     // Generate temporary preview ID
     const previewId = crypto.randomUUID();

     // Prepare preview data from current form state
     const previewData = {
       schema: {
         fields: this.formBuilderService.formFields(),
         version: '1.0.0',
       },
       settings: {
         title: this.formBuilderService.formTitle(),
         description: this.formBuilderService.formDescription() || '',
         columnLayout: this.formBuilderService.columnLayout(),
         rowSpacing: this.formBuilderService.rowSpacing(),
         redirectUrl: this.formBuilderService.redirectUrl(),
       },
       isPreview: true, // Flag to indicate preview mode
     };

     // Store in sessionStorage for retrieval by preview page
     sessionStorage.setItem(`form-preview-${previewId}`, JSON.stringify(previewData));

     // Open preview in new tab
     const previewUrl = `/forms/preview/${previewId}`;
     window.open(previewUrl, '_blank', 'noopener,noreferrer');
   }
   ```

3. **Preview Mode Detection** (update FormRendererComponent):

   ```typescript
   ngOnInit(): void {
     this.route.url.pipe(takeUntil(this.destroy$)).subscribe((urlSegments) => {
       const isPreviewRoute = urlSegments[0]?.path === 'forms' && urlSegments[1]?.path === 'preview';

       if (isPreviewRoute) {
         this.loadPreviewData();
       } else {
         this.loadPublishedForm();
       }
     });
   }

   private loadPreviewData(): void {
     const previewId = this.route.snapshot.paramMap.get('previewId');
     if (!previewId) {
       this.handleError('Invalid preview URL', 'FORM_NOT_FOUND');
       return;
     }

     const previewDataStr = sessionStorage.getItem(`form-preview-${previewId}`);
     if (!previewDataStr) {
       this.handleError('Preview data not found. Please generate a new preview.', 'FORM_NOT_FOUND');
       return;
     }

     try {
       const previewData = JSON.parse(previewDataStr);
       this.schema = previewData.schema;
       this.settings = previewData.settings;
       this.isPreview = previewData.isPreview || false;
       this.buildFormGroup();
       this.state.loading = false;
     } catch (error) {
       this.handleError('Failed to load preview data', 'PARSE_ERROR');
     }
   }
   ```

4. **Preview Mode Banner** (update FormRendererComponent template):

   ```html
   <!-- Add banner at top of form-renderer.component.html -->
   @if (isPreview) {
   <div
     class="preview-banner bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 p-4 mb-6 flex items-center gap-3"
   >
     <i class="pi pi-info-circle text-2xl"></i>
     <div>
       <p class="font-semibold">PREVIEW MODE</p>
       <p class="text-sm">This is a temporary preview. Changes are not saved.</p>
     </div>
   </div>
   }
   ```

5. **Submit Button Handling in Preview Mode**:
   ```typescript
   // In FormRendererComponent, disable submit button if isPreview is true
   get canSubmit(): boolean {
     return !this.isPreview && this.formGroup?.valid && !this.state.submitting;
   }
   ```

**Existing Pattern Reference:**

- Window.open pattern: Standard browser API for new tab navigation
- sessionStorage: HTML5 Web Storage API (auto-cleans on tab close)
- Public form rendering: Existing FormRendererComponent at `/forms/render/:token` (AC5 reuse)
- UUID generation: `crypto.randomUUID()` (built-in browser API, supported in all modern browsers)

**Key Constraints:**

- Preview must work without backend API calls (instant preview, no latency)
- Preview data stored client-side only (sessionStorage, not localStorage for auto-cleanup)
- No authentication required for preview route (reuses public form renderer pattern)
- Preview banner must be visually distinct from published forms
- Submit functionality disabled in preview mode (read-only preview)

---

## Definition of Done

- [ ] "Preview" button in FormBuilderComponent opens form preview in new tab
- [ ] Preview URL format: `/forms/preview/:previewId` with UUID-based previewId
- [ ] Preview displays current form state (fields, settings, layout) from FormBuilderService
- [ ] Preview mode banner displays at top: "PREVIEW MODE - This is a temporary preview"
- [ ] Preview reuses FormRendererComponent with `isPreview` mode flag
- [ ] Preview data stored in sessionStorage with key `form-preview-{previewId}`
- [ ] Preview button enabled for both published and unpublished forms
- [ ] Submit button disabled in preview mode
- [ ] No popup blocker warnings (window.open executed in click handler)
- [ ] Preview data auto-cleans when browser tab closes (sessionStorage behavior)
- [ ] Existing form publish/render workflow unchanged (no regression)
- [ ] TypeScript compilation passes (`npm --workspace=apps/web run typecheck`)
- [ ] No new ESLint warnings (`npm --workspace=apps/web run lint`)
- [ ] Component tests updated for preview functionality

---

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk:** Browser popup blockers might prevent new tab from opening
- **Mitigation:** Execute window.open directly in click handler (not async), use proper window
  features string (`noopener,noreferrer`)
- **Rollback:** Revert onPreview() implementation and route addition, restore "coming soon" toast
  message

**Compatibility Verification:**

- [ ] No breaking changes to existing APIs (client-side only)
- [ ] No database changes (preview data stored client-side)
- [ ] New route `/forms/preview/:previewId` does not conflict with `/forms/render/:token`
- [ ] sessionStorage supported in all modern browsers (IE11+, Chrome, Firefox, Safari, Edge)
- [ ] Performance impact minimal (no API calls, instant preview)

---

## Validation Checklist

**Scope Validation:**

- [ ] Story can be completed in one development session (~4 hours)
- [ ] Integration approach is straightforward (route + storage + window.open)
- [ ] Follows existing public form rendering pattern
- [ ] No design or architecture work required (reuses FormRendererComponent)

**Clarity Check:**

- [ ] Story requirements are unambiguous (clear preview workflow, new tab, preview banner)
- [ ] Integration points clearly specified (FormBuilderComponent, FormRendererComponent, routes)
- [ ] Success criteria testable (manual testing of preview button, new tab, preview mode)
- [ ] Rollback approach simple (revert preview button and route changes)

---

## Dev Agent Record

**Agent Model Used:** Claude 3.7 Sonnet (claude-sonnet-4-5-20250929)

**Status:** Ready for Review

### Implementation Summary

Implemented live form preview functionality allowing form creators to preview forms in a new browser
tab before publishing. Preview uses sessionStorage for instant client-side rendering without backend
API calls.

### Key Implementation Details

**Files Modified:**

- [app.routes.ts](apps/web/src/app/app.routes.ts) - Added `/forms/preview/:previewId` route
- [form-builder.component.ts](apps/web/src/app/features/tools/components/form-builder/form-builder.component.ts) -
  Implemented `onPreview()` with sessionStorage and window.open
- [form-renderer.component.ts](apps/web/src/app/features/public/form-renderer/form-renderer.component.ts) -
  Added preview mode detection, data loading, and submit prevention
- [form-renderer.component.html](apps/web/src/app/features/public/form-renderer/form-renderer.component.html) -
  Added preview mode banner and conditional submit button
- [form-renderer.service.ts](apps/web/src/app/features/public/form-renderer/form-renderer.service.ts) -
  Added FORM_NOT_FOUND and PARSE_ERROR to FormRenderErrorType enum
- [form-builder.component.spec.ts](apps/web/src/app/features/tools/components/form-builder/form-builder.component.spec.ts) -
  Added preview tests
- [form-renderer.component.spec.ts](apps/web/src/app/features/public/form-renderer/form-renderer.component.spec.ts) -
  Added preview mode tests

**Implementation Approach:**

1. Preview route added before existing render route to handle `/forms/preview/:previewId`
2. onPreview() generates UUID, serializes form state to sessionStorage, opens new tab with
   window.open
3. FormRendererComponent detects preview route via URL segments, loads from sessionStorage instead
   of API
4. Preview banner displays prominent warning message with yellow background
5. Submit button hidden in preview mode via `canSubmit` getter and template conditional
6. Preview data auto-cleans when tab closes (sessionStorage behavior)

### Validation Results

✅ TypeScript compilation passes without errors ✅ No new ESLint warnings introduced by changes ✅
Preview functionality implemented according to AC ✅ Tests added for preview behavior (note: some
pre-existing test infrastructure issues unrelated to this story)

### File List

- apps/web/src/app/app.routes.ts
- apps/web/src/app/features/tools/components/form-builder/form-builder.component.ts
- apps/web/src/app/features/public/form-renderer/form-renderer.component.ts
- apps/web/src/app/features/public/form-renderer/form-renderer.component.html
- apps/web/src/app/features/public/form-renderer/form-renderer.service.ts
- apps/web/src/app/features/tools/components/form-builder/form-builder.component.spec.ts
- apps/web/src/app/features/public/form-renderer/form-renderer.component.spec.ts

---

**Story 10.13 - Ready for Review** ✅
