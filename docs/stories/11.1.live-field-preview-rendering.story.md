# Story 11.1: Live Field Preview Rendering

## Status

Draft

## Story

**As a** form creator, **I want** form fields to render as they will appear on the published form
(WYSIWYG), **so that** I can see exactly how my form will look while building it without needing to
preview in a separate tab.

---

## Acceptance Criteria

1. ✅ All 12 field types render as actual form controls (text input, select dropdown, textarea,
   checkbox, radio, date, datetime, number, email, file, toggle, divider)
2. ✅ Drag-drop works with live field previews using CDK drag handles
3. ✅ Field selection highlights the selected field with visual indicator (border/shadow)
4. ✅ Required and validation indicators display correctly on live fields
5. ✅ Column layout (1-3 columns) applies to live field rendering
6. ✅ No breaking changes to existing form save/load functionality

---

## Tasks / Subtasks

- [ ] **Task 1: Create field preview renderer components** (AC: 1)
  - [ ] Create `field-preview-renderer.component.ts` wrapper component in `form-canvas/` directory
  - [ ] Implement individual field type renderers:
    - [ ] `text-input-preview.component.ts` (handles TEXT, EMAIL, NUMBER types)
    - [ ] `select-preview.component.ts` (handles SELECT dropdown)
    - [ ] `textarea-preview.component.ts` (handles TEXTAREA)
    - [ ] `checkbox-preview.component.ts` (handles CHECKBOX)
    - [ ] `radio-preview.component.ts` (handles RADIO button group)
    - [ ] `date-preview.component.ts` (handles DATE, DATETIME)
    - [ ] `file-preview.component.ts` (handles FILE upload)
    - [ ] `toggle-preview.component.ts` (handles TOGGLE switch)
    - [ ] `divider-preview.component.ts` (handles DIVIDER visual separator)
  - [ ] Each preview component renders disabled form control matching final appearance
  - [ ] Add PrimeNG components for rich field rendering (p-inputText, p-dropdown, p-checkbox,
        p-calendar, p-fileUpload, p-inputSwitch)

- [ ] **Task 2: Update form-canvas.component.ts to use live field renderers** (AC: 1, 2, 5)
  - [ ] Replace card-based field display template with field preview renderer
  - [ ] Update template to render `<app-field-preview-renderer>` for each field
  - [ ] Maintain CDK drag-drop functionality with `cdkDrag` on preview containers
  - [ ] Add drag handle icon (pi-bars) separate from preview content
  - [ ] Pass `FormField` and `FormSettings` (columnLayout, rowSpacing) to renderer
  - [ ] Apply responsive grid classes based on `settings.columnLayout` (1-3 columns)
  - [ ] Preserve field selection click handlers and keyboard navigation

- [ ] **Task 3: Implement visual indicators for field states** (AC: 3, 4)
  - [ ] Add border highlight for selected field (border-blue-500, shadow-md)
  - [ ] Display required badge/indicator (red asterisk or "Required" badge)
  - [ ] Show validation rule indicators (min/max length, pattern hints)
  - [ ] Add hover states for unselected fields (border-blue-300)
  - [ ] Implement focus management for keyboard navigation

- [ ] **Task 4: Ensure backward compatibility** (AC: 6)
  - [ ] Verify `FormBuilderService.formFields()` signal works with new rendering
  - [ ] Test form save/load operations with live preview rendering
  - [ ] Confirm `FormField` interface remains unchanged (no breaking changes)
  - [ ] Validate published forms render identically using `FormRendererComponent`

- [ ] **Task 5: Add unit tests for field preview components**
  - [ ] Test suite for `field-preview-renderer.component.spec.ts`
  - [ ] Test each field type renderer component (9 components)
  - [ ] Test field selection and visual indicators
  - [ ] Test drag-drop with live previews
  - [ ] Test column layout application (1, 2, 3 columns)

---

## Dev Notes

### Integration with Existing System

**Component Location:** `apps/web/src/app/features/tools/components/form-builder/form-canvas/`
[Source: architecture/unified-project-structure.md#frontend]

This story enhances the existing Form Builder (Epic 10) by replacing the card-based field display in
`form-canvas.component.ts` with live form field previews. The current implementation uses a simple
card layout showing field metadata. We will replace this with actual rendered form controls that
match the published form appearance.

**Key Integration Points:**

- **FormBuilderService**
  ([form-builder.service.ts:1-150](apps/web/src/app/features/tools/components/form-builder/form-builder.service.ts#L1-L150)):
  State management service with signal-based reactive state
  - `formFields()` signal: Readonly array of FormField objects
  - `selectedField()` signal: Currently selected field for editing
  - `selectField(field)`: Method to set selected field
  - No changes required to service API (backward compatible)

- **FormCanvasComponent**
  ([form-canvas.component.ts:1-150](apps/web/src/app/features/tools/components/form-builder/form-canvas/form-canvas.component.ts#L1-L150)):
  Current card-based display
  - Uses CDK Drag-Drop for field reordering
  - Applies grid layout based on `settings.columnLayout` (1-3 columns)
  - Handles field selection via click events
  - **Change required:** Replace card template with field preview renderers

- **FormRendererComponent** (Published form display): The target appearance we must match
  - Located at `apps/web/src/app/features/public/form-renderer/`
  - Renders actual form controls for end users
  - Our live previews must look identical (WYSIWYG requirement)

### Data Models

**FormField Interface**
([packages/shared/src/types/forms.types.ts:83-100](packages/shared/src/types/forms.types.ts#L83-L100)):

```typescript
interface FormField {
  id: string; // Unique field identifier
  type: FormFieldType; // Field type enum (12 types)
  label: string; // Field label displayed to user
  fieldName: string; // Field name used as key in submission
  placeholder?: string; // Placeholder text
  helpText?: string; // Help text displayed below field
  required: boolean; // Whether field is required
  validation?: FormFieldValidation; // Validation rules
  defaultValue?: any; // Default value
  options?: FormFieldOption[]; // For select/radio/checkbox fields
  conditional?: FormFieldConditional; // Conditional visibility
}
```

[Source: architecture/data-models.md + packages/shared/src/types/forms.types.ts]

**FormFieldType Enum**
([packages/shared/src/types/forms.types.ts:9-34](packages/shared/src/types/forms.types.ts#L9-L34)):
All 12 field types that must be supported:

- TEXT, EMAIL, NUMBER (text input variations)
- SELECT (dropdown)
- TEXTAREA (multi-line text)
- FILE (file upload)
- CHECKBOX, RADIO (choice inputs)
- DATE, DATETIME (date pickers)
- TOGGLE (switch)
- DIVIDER (visual separator, non-input)

**FormSettings Interface**:

```typescript
interface FormSettings {
  title: string;
  description?: string;
  columnLayout: 1 | 2 | 3; // Responsive grid columns
  rowSpacing: 'compact' | 'normal' | 'relaxed';
  redirectUrl?: string;
}
```

### Component Architecture

**New Component Structure:**

```
form-canvas/
├── form-canvas.component.ts (existing, modified)
├── field-preview-renderer/
│   ├── field-preview-renderer.component.ts (new wrapper)
│   ├── text-input-preview.component.ts (new)
│   ├── select-preview.component.ts (new)
│   ├── textarea-preview.component.ts (new)
│   ├── checkbox-preview.component.ts (new)
│   ├── radio-preview.component.ts (new)
│   ├── date-preview.component.ts (new)
│   ├── file-preview.component.ts (new)
│   ├── toggle-preview.component.ts (new)
│   └── divider-preview.component.ts (new)
```

**Field Preview Renderer Wrapper Pattern:**

```typescript
@Component({
  selector: 'app-field-preview-renderer',
  standalone: true,
  imports: [CommonModule, TextInputPreviewComponent, SelectPreviewComponent, ...],
  template: `
    @switch (field.type) {
      @case (FormFieldType.TEXT) { <app-text-input-preview [field]="field" /> }
      @case (FormFieldType.EMAIL) { <app-text-input-preview [field]="field" /> }
      @case (FormFieldType.NUMBER) { <app-text-input-preview [field]="field" /> }
      @case (FormFieldType.SELECT) { <app-select-preview [field]="field" /> }
      // ... all 12 types
    }
  `
})
export class FieldPreviewRendererComponent {
  @Input({ required: true }) field!: FormField;
}
```

### PrimeNG Components for Field Rendering

[Source: architecture/tech-stack.md#ui-component-library]

- **Text Inputs:** `<p-inputText>` with `[disabled]="true"` for TEXT, EMAIL, NUMBER
- **Select Dropdown:** `<p-dropdown [options]="field.options" [disabled]="true">`
- **Textarea:** `<textarea pInputTextarea [disabled]="true">`
- **Checkbox:** `<p-checkbox [binary]="true" [disabled]="true">`
- **Radio:** `<p-radioButton *ngFor="let opt of field.options" [disabled]="true">`
- **Date/DateTime:** `<p-calendar [disabled]="true" [showTime]="field.type === 'datetime'">`
- **File Upload:** `<p-fileUpload mode="basic" [disabled]="true">`
- **Toggle:** `<p-inputSwitch [disabled]="true">`
- **Divider:** `<p-divider />` (non-input visual element)

All preview fields are **disabled** to prevent user interaction (this is a preview, not an editable
form).

### Drag-Drop Functionality

**CDK Drag-Drop Integration**
([form-canvas.component.ts:10](apps/web/src/app/features/tools/components/form-canvas/form-canvas.component.ts#L10)):
[Source: architecture/frontend-architecture.md#component-architecture]

Current implementation uses `@angular/cdk/drag-drop`:

```typescript
<div cdkDropList (cdkDropListDropped)="onFieldDropped($event)">
  @for (field of formBuilderService.formFields(); track field.id) {
    <div cdkDrag [cdkDragData]="field">
      <!-- REPLACE THIS CARD WITH LIVE PREVIEW -->
      <i class="pi pi-bars" cdkDragHandle></i> <!-- Drag handle -->
    </div>
  }
</div>
```

**Critical:** Drag handle (`cdkDragHandle`) must remain separate from preview content to allow field
preview interaction without triggering drag events. Use `event.stopPropagation()` if needed.

### Column Layout and Responsive Grid

**Grid Classes**
([form-canvas.component.ts:135-150](apps/web/src/app/features/tools/components/form-canvas/form-canvas.component.ts#L135-L150)):

```typescript
getGridClass(): string {
  const layout = this.settings.columnLayout;
  return {
    1: 'grid-cols-1',
    2: 'grid-cols-1 md:grid-cols-2',
    3: 'grid-cols-1 md:grid-cols-2 lg:grid-cols-3'
  }[layout] || 'grid-cols-1';
}

getSpacingClass(): string {
  return `spacing-${this.settings.rowSpacing}`;
}
```

Tailwind CSS grid classes for responsive layout. These must be preserved and applied to the preview
grid container.

### Visual Indicators

**Selected Field Indicator:**

```typescript
[class.border-blue-500]="isFieldSelected(field)"
[class.shadow-md]="isFieldSelected(field)"
```

**Required Field Badge:**

```html
@if (field.required) {
<span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded">Required</span>
}
```

**Validation Indicators:** Display validation rules as subtle hints (e.g., "Max 100 chars", "Min
value: 10") below field preview.

### Testing

**Test Location:**
`apps/web/src/app/features/tools/components/form-builder/form-canvas/field-preview-renderer/`
[Source: architecture/testing-strategy.md#frontend-tests]

**Test Framework:** Jest + Angular Testing Library [Source:
architecture/tech-stack.md#frontend-testing]

**Test Files Required:**

- `field-preview-renderer.component.spec.ts` (wrapper component)
- `text-input-preview.component.spec.ts`
- `select-preview.component.spec.ts`
- `textarea-preview.component.spec.ts`
- `checkbox-preview.component.spec.ts`
- `radio-preview.component.spec.ts`
- `date-preview.component.spec.ts`
- `file-preview.component.spec.ts`
- `toggle-preview.component.spec.ts`
- `divider-preview.component.spec.ts`
- Update `form-canvas.component.spec.ts` to test live preview rendering

**Test Coverage Requirements:**

```typescript
describe('FieldPreviewRendererComponent', () => {
  it('should render text input preview for TEXT type', () => {
    const field: FormField = { type: FormFieldType.TEXT, label: 'Name', ... };
    fixture.componentInstance.field = field;
    fixture.detectChanges();
    expect(fixture.nativeElement.querySelector('app-text-input-preview')).toBeTruthy();
  });

  it('should render all 12 field types correctly', () => {
    // Test each FormFieldType enum value
  });

  it('should pass field data to preview component', () => {
    // Verify @Input() bindings
  });
});

describe('FormCanvasComponent with Live Previews', () => {
  it('should render live field previews instead of cards', () => {
    const fields = [/* mock fields */];
    service.setFormFields(fields);
    fixture.detectChanges();
    expect(fixture.nativeElement.querySelectorAll('app-field-preview-renderer').length).toBe(fields.length);
  });

  it('should maintain drag-drop functionality with live previews', () => {
    // Test CDK drag-drop with preview components
  });

  it('should highlight selected field', () => {
    const field = fields[0];
    component.onFieldClicked(field);
    fixture.detectChanges();
    expect(/* selected field has border-blue-500 class */);
  });

  it('should apply column layout grid classes', () => {
    component.settings.columnLayout = 3;
    fixture.detectChanges();
    expect(/* grid has 3-column class */);
  });
});
```

**Test Commands:**

```bash
# Run tests for this component
npm --workspace=apps/web run test -- --include="**/field-preview-renderer/**/*.spec.ts" --watch=false

# Run tests for updated form-canvas component
npm --workspace=apps/web run test -- --include="**/form-canvas.component.spec.ts" --watch=false
```

### Accessibility Requirements

[Source: architecture/frontend-architecture.md#component-template]

- All preview fields must have proper ARIA labels matching field labels
- Keyboard navigation must work (Tab through fields, Enter to select)
- Disabled form controls must indicate read-only state to screen readers
- Required fields must announce "required" to screen readers
- Drag handles must have `aria-label="Reorder field"`

### Performance Considerations

- Use `ChangeDetectionStrategy.OnPush` for all preview components
- Track fields by `field.id` in `@for` loop to prevent unnecessary re-renders
- Avoid heavy computations in computed signals for field rendering

### Backward Compatibility Verification

**No Breaking Changes Allowed:**

1. `FormBuilderService` API unchanged (all existing methods preserved)
2. `FormField` interface unchanged (no new required fields)
3. Form save/load operations must work identically
4. Published forms continue to render correctly via `FormRendererComponent`
5. Existing unit tests for `FormBuilderService` must pass without modification

**Compatibility Test Plan:**

1. Load an existing saved form → verify fields render as live previews
2. Save a form with live previews → verify saved schema is identical to card-based version
3. Publish a form built with live previews → verify public rendering matches previous behavior
4. Drag-drop fields → verify field order persists correctly

---

## Change Log

| Date       | Version | Description                | Author             |
| ---------- | ------- | -------------------------- | ------------------ |
| 2025-10-07 | 1.0     | Story created from Epic 11 | Scrum Master (Bob) |

---

## Dev Agent Record

_This section will be populated by the development agent during implementation._

### Agent Model Used

_To be filled by dev agent_

### Debug Log References

_To be filled by dev agent_

### Completion Notes

_To be filled by dev agent_

### File List

_To be filled by dev agent_

---

## QA Results

_This section will be populated by the QA agent after story completion._
