# Story 9.1: Canvas Drawing Surface & Line Drawing with Smart Guides

## Status

Done

## Story

**As a** user, **I want** to draw lines on a full-viewport canvas with horizontal/vertical snap
guides and real-time angle indicators, **so that** I can create precise geometric drawings with
visual feedback.

## Acceptance Criteria

1. Canvas fills viewport and responds to window resize
2. Lines can be drawn smoothly with mouse drag
3. Snap guides appear when line angle is within 5° of horizontal/vertical
4. Angle indicator shows current line angle with 1° precision
5. Drawing state persists during component lifecycle

## Tasks / Subtasks

- [x] Create canvas renderer component scaffold (AC: 1)
  - [x] Create
        `apps/web/src/app/features/tools/components/svg-drawing/components/canvas-renderer/canvas-renderer.component.ts`
  - [x] Create
        `apps/web/src/app/features/tools/components/svg-drawing/components/canvas-renderer/canvas-renderer.component.spec.ts`
  - [x] Configure as standalone component with OnPush change detection
  - [x] Add PrimeNG module imports (CardModule, ButtonModule)
  - [x] Create canvas element with ViewChild reference
- [x] Implement responsive canvas (AC: 1)
  - [x] Add full-viewport canvas element with absolute positioning
  - [x] Implement window resize listener using HostListener
  - [x] Update canvas dimensions on resize events
  - [x] Set canvas width/height to match container dimensions
  - [x] Implement canvas coordinate scaling for high DPI displays
- [x] Create drawing state management (AC: 5)
  - [x] Update `apps/web/src/app/features/tools/services/svg-drawing.service.ts`
  - [x] Define DrawingState interface with shapes array and current tool
  - [x] Implement Angular signals for reactive state (currentTool, shapes, isDrawing)
  - [x] Create computed signal for selected shapes
  - [x] Add methods: startDrawing(), updateDrawing(), finishDrawing()
- [x] Implement line drawing with mouse events (AC: 2)
  - [x] Add mousedown event handler to capture start point
  - [x] Add mousemove event handler for line preview
  - [x] Add mouseup event handler to finalize line
  - [x] Convert canvas pixel coordinates to drawing coordinates
  - [x] Store line in shapes array with start/end points
  - [x] Render line on canvas using Canvas API or SVG path
- [x] Create Shape data models (AC: 2, 5)
  - [x] Update `packages/shared/src/types/tools.interface.ts`
  - [x] Define Shape base interface with type, id, color, strokeWidth
  - [x] Define LineShape interface extending Shape with start/end points
  - [x] Define Point interface with x, y coordinates
  - [x] Add ShapeType enum ('line', 'polygon')
- [x] Implement snap guide logic (AC: 3)
  - [x] Create `calculateAngle(start: Point, end: Point)` utility function
  - [x] Check if angle is within 5° of 0°, 90°, 180°, 270°
  - [x] Snap line to perfect horizontal/vertical when threshold met
  - [x] Render visual guide lines on canvas (dashed lines)
  - [x] Add snap threshold configuration in service
- [x] Implement real-time angle indicator (AC: 4)
  - [x] Create angle display overlay component
  - [x] Calculate angle in degrees during mousemove
  - [x] Display angle with 1° precision near cursor
  - [x] Position indicator to avoid overlap with line
  - [x] Style indicator with Tailwind CSS (badge style)
- [x] Implement canvas rendering (AC: 2)
  - [x] Choose HTML5 Canvas API or SVG for rendering
  - [x] Implement renderShapes() method
  - [x] Draw all stored shapes from state
  - [x] Render preview shape during active drawing
  - [x] Clear and redraw canvas on state changes
  - [x] Apply stroke color and width from shape properties
- [x] Update main svg-drawing component (AC: 1)
  - [x] Update `apps/web/src/app/features/tools/components/svg-drawing/svg-drawing.component.ts`
  - [x] Import and use canvas-renderer component
  - [x] Apply \*appToolGate="'svg-drawing'" directive
  - [x] Add component layout with Tailwind CSS
  - [x] Integrate with svg-drawing service for state management
- [x] Add basic toolbar UI (AC: 2)
  - [x] Create temporary toolbar in svg-drawing component
  - [x] Add PrimeNG Button for line tool selection
  - [x] Display current tool state
  - [x] Style toolbar with Tailwind CSS (fixed position)
- [x] Create unit tests for canvas renderer
  - [x] Test canvas initialization and resize handling
  - [x] Test coordinate conversion functions
  - [x] Test component lifecycle and cleanup
  - [x] Mock canvas context for testing
- [x] Create unit tests for drawing service
  - [x] Test state signal updates
  - [x] Test startDrawing/updateDrawing/finishDrawing methods
  - [x] Test snap guide angle calculations
  - [x] Test shape creation and storage
- [x] Create unit tests for angle calculations
  - [x] Test calculateAngle utility function
  - [x] Test snap threshold detection
  - [x] Test angle display formatting
- [x] Verify TypeScript compilation
  - [x] Run `npm --workspace=apps/web run typecheck`
  - [x] Fix any type errors
- [x] Verify build success
  - [x] Run `npm --workspace=apps/web run build`
  - [x] Ensure no build errors

## Dev Notes

### Testing Standards

[Source: architecture/testing-strategy.md#Test Organization]

- Frontend tests: alongside source files with .spec.ts extension
- Use Karma/Jasmine for Angular component testing
- Mock external dependencies and services
- Test user interactions with fixture.debugElement
- Use TestBed.configureTestingModule for component setup

### Frontend Component Structure

[Source: architecture/frontend-architecture.md#Component Architecture]

- Standalone components with explicit imports
- Use Angular signals for reactive state management
- ChangeDetectionStrategy.OnPush for performance optimization
- Proper component lifecycle management with OnDestroy
- Use ViewChild for canvas element reference

**Component Template Pattern:**

```typescript
@Component({
  selector: 'app-canvas-renderer',
  standalone: true,
  imports: [CommonModule, CardModule, ButtonModule],
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class CanvasRendererComponent implements OnInit, OnDestroy {
  private readonly canvasRef = viewChild<ElementRef<HTMLCanvasElement>>('canvas');
  private readonly drawingService = inject(SvgDrawingService);
}
```

### State Management with Signals

[Source: architecture/frontend-architecture.md#State Management Architecture]

- Use signal() for mutable state values
- Use computed() for derived state values
- Implement effect() for side effects on state changes
- Keep state immutable - create new objects for updates

**State Structure:**

```typescript
interface DrawingState {
  shapes: Shape[];
  selectedShapeId: string | null;
  currentTool: 'line' | 'polygon' | 'select';
  isDrawing: boolean;
  snapEnabled: boolean;
  snapThreshold: number;
}
```

### HTML5 Canvas vs SVG Decision

Both approaches are valid for this implementation:

**HTML5 Canvas API:**

- Better performance with many shapes (50+)
- Pixel-based rendering
- Requires manual redrawing on changes
- More complex coordinate transformations

**SVG:**

- Declarative markup easier to manage
- Built-in event handling per shape
- Better for editing and selection
- Scales perfectly with zoom

**Recommendation:** Start with SVG for easier shape management and event handling. Switch to Canvas
if performance issues arise in Story 3.

### Canvas Coordinate System

- Canvas uses pixel coordinates (top-left origin)
- Drawing coordinates may need translation/scaling
- Handle high DPI displays with devicePixelRatio
- Convert between screen coordinates and drawing coordinates

### Snap Guide Implementation

[Source: Epic 9 requirements]

**Snap Logic:**

```typescript
function shouldSnap(angle: number, threshold: number = 5): boolean {
  const snapAngles = [0, 90, 180, 270];
  return snapAngles.some((snapAngle) => Math.abs(angle - snapAngle) <= threshold);
}

function snapToNearest(angle: number): number {
  const snapAngles = [0, 90, 180, 270];
  return snapAngles.reduce((prev, curr) =>
    Math.abs(curr - angle) < Math.abs(prev - angle) ? curr : prev
  );
}
```

### Angle Calculation

```typescript
function calculateAngle(start: Point, end: Point): number {
  const dx = end.x - start.x;
  const dy = end.y - start.y;
  let angle = Math.atan2(dy, dx) * (180 / Math.PI);
  // Normalize to 0-360
  if (angle < 0) angle += 360;
  return Math.round(angle);
}
```

### PrimeNG Components

[Source: architecture/tech-stack.md#Technology Stack Table]

- CardModule for component container
- ButtonModule for toolbar buttons
- TooltipModule for angle indicator
- Use PrimeNG 17+ API with standalone component support

### File Locations

[Source: architecture/unified-project-structure.md]

- Main component: `apps/web/src/app/features/tools/components/svg-drawing/`
- Sub-components: `apps/web/src/app/features/tools/components/svg-drawing/components/`
- Service: `apps/web/src/app/features/tools/services/svg-drawing.service.ts`
- Shared types: `packages/shared/src/types/tools.interface.ts`
- Unit tests: alongside components with .spec.ts extension

### Existing Tool Integration

[Source: Epic 7 context]

- Svg-drawing component already scaffolded in Story 7.1
- Basic service structure exists
- Tool registration complete in admin panel
- Apply \*appToolGate directive for conditional rendering
- Follow existing tool component patterns (map, calendar, todo-app)

### Coding Standards

[Source: architecture/coding-standards.md#Critical Fullstack Rules]

- All shared types in packages/shared/src/types/
- JSDoc comments for all public methods and interfaces
- Use proper Angular dependency injection with inject()
- Validate input on frontend for user experience
- Use proper error handling patterns

### Performance Considerations

[Source: Epic 9 Risk Mitigation]

- Use requestAnimationFrame for smooth rendering
- Throttle mousemove events (16ms for 60fps)
- Implement viewport culling if needed in future stories
- Monitor performance with 50+ shapes

### Tailwind CSS Styling

[Source: architecture/tech-stack.md#Technology Stack Table]

- Use Tailwind utility classes for component styling
- Full viewport: `w-full h-full absolute inset-0`
- Toolbar positioning: `fixed top-0 left-0 right-0 z-10`
- Angle indicator: `absolute bg-gray-800 text-white px-2 py-1 rounded text-sm`

### Shared Types Structure

[Source: architecture/coding-standards.md#Critical Fullstack Rules]

All drawing-related types must be defined in `packages/shared/src/types/tools.interface.ts`:

```typescript
export interface Point {
  x: number;
  y: number;
}

export interface Shape {
  id: string;
  type: 'line' | 'polygon';
  color: string;
  strokeWidth: number;
  createdAt: Date;
}

export interface LineShape extends Shape {
  type: 'line';
  start: Point;
  end: Point;
}
```

### Previous Story Insights

No previous SVG drawing stories exist. This is the first story in Epic 9. Follow patterns
established in Tool stories 7.1, 7.2, and 7.3 for component structure and service integration.

## Change Log

| Date       | Version | Description                                         | Author             |
| ---------- | ------- | --------------------------------------------------- | ------------------ |
| 2025-09-30 | 1.0     | Initial story creation                              | Bob (Scrum Master) |
| 2025-09-30 | 1.1     | Implementation complete - all AC met, tests passing | James (Dev Agent)  |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929) - Development Agent James

### Debug Log References

No debug log entries required. Implementation proceeded smoothly following the story specifications.

### Completion Notes List

✅ **Shared Types Created:**

- Defined Point, Shape, LineShape, PolygonShape, and DrawingState interfaces in
  packages/shared/src/types/tools.interface.ts
- Built shared package successfully

✅ **Drawing Service Implemented:**

- Complete state management using Angular signals
- Reactive state with readonly public signals and computed values
- Snap guide logic with configurable threshold (5° default)
- Angle calculation utilities (calculateAngle, shouldSnap, snapToNearest, applySnapToPoint)
- Shape management methods (add, remove, select, clear)
- Tool selection and drawing lifecycle management

✅ **Canvas Renderer Component:**

- Standalone component with OnPush change detection
- SVG-based rendering (chosen over Canvas API for easier shape management)
- Full-viewport responsive canvas with window resize handling
- Mouse event handlers for line drawing (mousedown, mousemove, mouseup, mouseleave)
- Real-time preview line during drawing
- Snap guide visualization (red dashed line)
- Real-time angle indicator positioned near cursor
- Smooth drawing experience with proper coordinate conversion

✅ **Main SVG Drawing Component:**

- Updated with PrimeNG Toolbar integration
- Line tool selection button with visual feedback
- Clear All functionality with confirmation dialog
- Shape count display in toolbar
- Full-height layout with flex-based structure
- Integration with canvas renderer sub-component

✅ **Unit Tests:**

- Comprehensive service tests (59 test cases covering all functionality)
- Canvas renderer component tests (9 test cases)
- Tests cover: initialization, drawing operations, shape management, tool selection, snap
  functionality, angle calculations, computed signals

✅ **Build Verification:**

- TypeScript compilation: ✓ Passed
- Build process: ✓ Completed successfully (599.17 kB initial, 142.81 kB gzipped)
- No TypeScript errors in new code

### File List

**Created:**

- `packages/shared/src/types/tools.interface.ts` (modified - added SVG Drawing types)
- `apps/web/src/app/features/tools/components/svg-drawing/components/canvas-renderer/canvas-renderer.component.ts`
- `apps/web/src/app/features/tools/components/svg-drawing/components/canvas-renderer/canvas-renderer.component.spec.ts`
- `apps/web/src/app/features/tools/components/svg-drawing/svg-drawing.service.spec.ts`

**Modified:**

- `apps/web/src/app/features/tools/components/svg-drawing/svg-drawing.service.ts`
- `apps/web/src/app/features/tools/components/svg-drawing/svg-drawing.component.ts`

## QA Results

### Review Date: 2025-09-30

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT** ⭐

This implementation demonstrates exceptional Angular architecture and development practices. The
code exhibits:

- **Modern Angular 20+ Patterns**: Excellent use of standalone components, signals, and computed
  values
- **Separation of Concerns**: Clean architectural layering between service (state/logic) and
  components (presentation)
- **Type Safety**: Comprehensive TypeScript types properly defined in shared package
- **Documentation Quality**: Outstanding JSDoc documentation on all public methods and interfaces
- **State Management**: Proper immutable state updates using Angular signals
- **Performance Optimization**: OnPush change detection strategy correctly implemented

The implementation successfully delivers all 5 acceptance criteria with high code quality and proper
architectural patterns.

### Requirements Traceability

**All Acceptance Criteria Validated:**

| AC  | Requirement                       | Implementation                                                                                                                                                  | Test Coverage                                                                                                                                                              | Status  |
| --- | --------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------- |
| 1   | Canvas fills viewport & resizes   | [canvas-renderer.component.ts:148-163](apps/web/src/app/features/tools/components/svg-drawing/components/canvas-renderer/canvas-renderer.component.ts#L148-163) | ✅ [canvas-renderer.component.spec.ts:26-36](apps/web/src/app/features/tools/components/svg-drawing/components/canvas-renderer/canvas-renderer.component.spec.ts#L26-36)   | ✅ PASS |
| 2   | Lines drawn smoothly with mouse   | [canvas-renderer.component.ts:168-266](apps/web/src/app/features/tools/components/svg-drawing/components/canvas-renderer/canvas-renderer.component.ts#L168-266) | ✅ [canvas-renderer.component.spec.ts:38-116](apps/web/src/app/features/tools/components/svg-drawing/components/canvas-renderer/canvas-renderer.component.spec.ts#L38-116) | ✅ PASS |
| 3   | Snap guides within 5° threshold   | [svg-drawing.service.ts:170-186](apps/web/src/app/features/tools/components/svg-drawing/svg-drawing.service.ts#L170-186)                                        | ✅ [svg-drawing.service.spec.ts:236-254](apps/web/src/app/features/tools/components/svg-drawing/svg-drawing.service.spec.ts#L236-254)                                      | ✅ PASS |
| 4   | Angle indicator with 1° precision | [canvas-renderer.component.ts:202-207](apps/web/src/app/features/tools/components/svg-drawing/components/canvas-renderer/canvas-renderer.component.ts#L202-207) | ✅ [canvas-renderer.component.spec.ts:80-100](apps/web/src/app/features/tools/components/svg-drawing/components/canvas-renderer/canvas-renderer.component.spec.ts#L80-100) | ✅ PASS |
| 5   | State persists during lifecycle   | [svg-drawing.service.ts:18-46](apps/web/src/app/features/tools/components/svg-drawing/svg-drawing.service.ts#L18-46)                                            | ✅ [svg-drawing.service.spec.ts:339-347](apps/web/src/app/features/tools/components/svg-drawing/svg-drawing.service.spec.ts#L339-347)                                      | ✅ PASS |

### Test Architecture Assessment

**Test Coverage Summary:**

- ✅ **Service Tests**: 59 comprehensive test cases covering all functionality
- ✅ **Canvas Renderer Tests**: 9 test cases covering component lifecycle and interactions
- ⚠️ **Main Component Tests**: Missing test file for svg-drawing.component.ts

**Test Quality:**

- Proper use of Angular testing utilities (TestBed, fixtures)
- Appropriate mocking strategy for unit tests
- Edge cases well covered (snap threshold validation, angle normalization, signal reactivity)
- Test organization follows project conventions

### Compliance Check

- ✅ **Coding Standards**: Excellent adherence to JSDoc requirements and type sharing
- ✅ **Project Structure**: Correct file locations and component architecture
- ✅ **Testing Strategy**: Tests properly located alongside source files
- ✅ **TypeScript Compilation**: All files compile without errors
- ✅ **Build Verification**: Build completed successfully (599.17 kB initial, 142.81 kB gzipped)

### Refactoring Performed

No refactoring was necessary. The code quality is excellent and follows all architectural patterns
correctly.

### Improvements Checklist

**Completed During Review:**

- [x] Verified all acceptance criteria implementations
- [x] Confirmed test coverage for service and canvas renderer
- [x] Validated TypeScript compilation
- [x] Verified build success
- [x] Confirmed standards compliance

**Recommended for Future Stories (Non-blocking):**

- [ ] Add test file for svg-drawing.component.ts to test toolbar interactions and tool selection
- [ ] Consider replacing console.log
      ([svg-drawing.service.ts:61](apps/web/src/app/features/tools/components/svg-drawing/svg-drawing.service.ts#L61))
      with proper logging service
- [ ] Consider using PrimeNG ConfirmDialog instead of native confirm() for consistency
      ([svg-drawing.component.ts:156](apps/web/src/app/features/tools/components/svg-drawing/svg-drawing.component.ts#L156))
- [ ] Add E2E tests for actual drawing interactions in future stories

### NFR Validation

**Security: PASS** ✅

- No authentication/authorization concerns
- No sensitive data handling
- UUID generation uses secure crypto.randomUUID()
- No XSS/injection vectors identified

**Performance: PASS** ✅

- SVG rendering chosen over Canvas (correct decision for this use case)
- OnPush change detection strategy implemented
- Signal-based reactivity prevents unnecessary re-renders
- Expected to perform well under 100 shapes (as per Epic 9 requirements)

**Reliability: PASS** ✅

- Proper error handling with try-catch in initialization
- Drawing cancellation on mouse leave prevents stuck states
- Proper state cleanup in component lifecycle
- Immutable state updates prevent race conditions

**Maintainability: PASS** ✅

- Excellent JSDoc documentation throughout
- Clear separation of concerns
- Strong type safety with shared types
- Self-documenting code with descriptive names
- Comprehensive test coverage for critical paths

### Security Review

**No security concerns identified.** This is a client-side drawing feature with no server
interaction, data persistence, or user authentication requirements.

### Performance Considerations

**Current Implementation:** Excellent performance characteristics for the initial story scope.

**Future Monitoring:** As documented in Epic 9 Risk Mitigation, performance should be monitored
when:

- Shape count exceeds 50+ shapes (Story 3 scope)
- Viewport culling may be needed (Story 3 scope)
- Consider requestAnimationFrame throttling if needed

### Files Modified During Review

No files were modified during this review. Code quality was excellent as delivered.

### Gate Status

Gate: **CONCERNS** →
[docs/qa/gates/9.1-canvas-drawing-surface-line-drawing-smart-guides.yml](docs/qa/gates/9.1-canvas-drawing-surface-line-drawing-smart-guides.yml)

**Gate Rationale:** While implementation quality is excellent and all ACs are met, the missing test
file for the main component (svg-drawing.component.ts) represents a minor gap in test coverage. This
is a CONCERNS rating rather than FAIL because:

- The core drawing logic is thoroughly tested via service and canvas renderer tests
- The main component is primarily integration/presentation layer
- All critical functionality has test coverage
- This is easily addressable in future iterations

### Recommended Status

**✅ Ready for Done**

This story can proceed to Done status. The missing test file is noted for future improvement but
does not block completion of this story's scope. The implementation successfully delivers all
acceptance criteria with high code quality and proper architectural patterns.
