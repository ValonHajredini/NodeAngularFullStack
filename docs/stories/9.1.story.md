# Story 9.1: Canvas Drawing Surface & Line Drawing with Smart Guides

## Status

Draft

## Story

**As a** user, **I want** to draw lines on a full-viewport canvas with horizontal/vertical snap
guides and real-time angle indicators, **so that** I can create precise geometric drawings with
visual feedback.

## Acceptance Criteria

1. Canvas fills viewport and responds to window resize
2. Lines can be drawn smoothly with mouse drag
3. Snap guides appear when line angle is within 5° of horizontal/vertical
4. Angle indicator shows current line angle with 1° precision
5. Drawing state persists during component lifecycle

## Tasks / Subtasks

- [ ] Create canvas renderer component scaffold (AC: 1)
  - [ ] Create
        `apps/web/src/app/features/tools/components/svg-drawing/components/canvas-renderer/canvas-renderer.component.ts`
  - [ ] Create
        `apps/web/src/app/features/tools/components/svg-drawing/components/canvas-renderer/canvas-renderer.component.spec.ts`
  - [ ] Configure as standalone component with OnPush change detection
  - [ ] Add PrimeNG module imports (CardModule, ButtonModule)
  - [ ] Create canvas element with ViewChild reference
- [ ] Implement responsive canvas (AC: 1)
  - [ ] Add full-viewport canvas element with absolute positioning
  - [ ] Implement window resize listener using HostListener
  - [ ] Update canvas dimensions on resize events
  - [ ] Set canvas width/height to match container dimensions
  - [ ] Implement canvas coordinate scaling for high DPI displays
- [ ] Create drawing state management (AC: 5)
  - [ ] Update `apps/web/src/app/features/tools/services/svg-drawing.service.ts`
  - [ ] Define DrawingState interface with shapes array and current tool
  - [ ] Implement Angular signals for reactive state (currentTool, shapes, isDrawing)
  - [ ] Create computed signal for selected shapes
  - [ ] Add methods: startDrawing(), updateDrawing(), finishDrawing()
- [ ] Implement line drawing with mouse events (AC: 2)
  - [ ] Add mousedown event handler to capture start point
  - [ ] Add mousemove event handler for line preview
  - [ ] Add mouseup event handler to finalize line
  - [ ] Convert canvas pixel coordinates to drawing coordinates
  - [ ] Store line in shapes array with start/end points
  - [ ] Render line on canvas using Canvas API or SVG path
- [ ] Create Shape data models (AC: 2, 5)
  - [ ] Update `packages/shared/src/types/tools.interface.ts`
  - [ ] Define Shape base interface with type, id, color, strokeWidth
  - [ ] Define LineShape interface extending Shape with start/end points
  - [ ] Define Point interface with x, y coordinates
  - [ ] Add ShapeType enum ('line', 'polygon')
- [ ] Implement snap guide logic (AC: 3)
  - [ ] Create `calculateAngle(start: Point, end: Point)` utility function
  - [ ] Check if angle is within 5° of 0°, 90°, 180°, 270°
  - [ ] Snap line to perfect horizontal/vertical when threshold met
  - [ ] Render visual guide lines on canvas (dashed lines)
  - [ ] Add snap threshold configuration in service
- [ ] Implement real-time angle indicator (AC: 4)
  - [ ] Create angle display overlay component
  - [ ] Calculate angle in degrees during mousemove
  - [ ] Display angle with 1° precision near cursor
  - [ ] Position indicator to avoid overlap with line
  - [ ] Style indicator with Tailwind CSS (badge style)
- [ ] Implement canvas rendering (AC: 2)
  - [ ] Choose HTML5 Canvas API or SVG for rendering
  - [ ] Implement renderShapes() method
  - [ ] Draw all stored shapes from state
  - [ ] Render preview shape during active drawing
  - [ ] Clear and redraw canvas on state changes
  - [ ] Apply stroke color and width from shape properties
- [ ] Update main svg-drawing component (AC: 1)
  - [ ] Update `apps/web/src/app/features/tools/components/svg-drawing/svg-drawing.component.ts`
  - [ ] Import and use canvas-renderer component
  - [ ] Apply \*appToolGate="'svg-drawing'" directive
  - [ ] Add component layout with Tailwind CSS
  - [ ] Integrate with svg-drawing service for state management
- [ ] Add basic toolbar UI (AC: 2)
  - [ ] Create temporary toolbar in svg-drawing component
  - [ ] Add PrimeNG Button for line tool selection
  - [ ] Display current tool state
  - [ ] Style toolbar with Tailwind CSS (fixed position)
- [ ] Create unit tests for canvas renderer
  - [ ] Test canvas initialization and resize handling
  - [ ] Test coordinate conversion functions
  - [ ] Test component lifecycle and cleanup
  - [ ] Mock canvas context for testing
- [ ] Create unit tests for drawing service
  - [ ] Test state signal updates
  - [ ] Test startDrawing/updateDrawing/finishDrawing methods
  - [ ] Test snap guide angle calculations
  - [ ] Test shape creation and storage
- [ ] Create unit tests for angle calculations
  - [ ] Test calculateAngle utility function
  - [ ] Test snap threshold detection
  - [ ] Test angle display formatting
- [ ] Verify TypeScript compilation
  - [ ] Run `npm --workspace=apps/web run typecheck`
  - [ ] Fix any type errors
- [ ] Verify build success
  - [ ] Run `npm --workspace=apps/web run build`
  - [ ] Ensure no build errors

## Dev Notes

### Testing Standards

[Source: architecture/testing-strategy.md#Test Organization]

- Frontend tests: alongside source files with .spec.ts extension
- Use Karma/Jasmine for Angular component testing
- Mock external dependencies and services
- Test user interactions with fixture.debugElement
- Use TestBed.configureTestingModule for component setup

### Frontend Component Structure

[Source: architecture/frontend-architecture.md#Component Architecture]

- Standalone components with explicit imports
- Use Angular signals for reactive state management
- ChangeDetectionStrategy.OnPush for performance optimization
- Proper component lifecycle management with OnDestroy
- Use ViewChild for canvas element reference

**Component Template Pattern:**

```typescript
@Component({
  selector: 'app-canvas-renderer',
  standalone: true,
  imports: [CommonModule, CardModule, ButtonModule],
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class CanvasRendererComponent implements OnInit, OnDestroy {
  private readonly canvasRef = viewChild<ElementRef<HTMLCanvasElement>>('canvas');
  private readonly drawingService = inject(SvgDrawingService);
}
```

### State Management with Signals

[Source: architecture/frontend-architecture.md#State Management Architecture]

- Use signal() for mutable state values
- Use computed() for derived state values
- Implement effect() for side effects on state changes
- Keep state immutable - create new objects for updates

**State Structure:**

```typescript
interface DrawingState {
  shapes: Shape[];
  selectedShapeId: string | null;
  currentTool: 'line' | 'polygon' | 'select';
  isDrawing: boolean;
  snapEnabled: boolean;
  snapThreshold: number;
}
```

### HTML5 Canvas vs SVG Decision

Both approaches are valid for this implementation:

**HTML5 Canvas API:**

- Better performance with many shapes (50+)
- Pixel-based rendering
- Requires manual redrawing on changes
- More complex coordinate transformations

**SVG:**

- Declarative markup easier to manage
- Built-in event handling per shape
- Better for editing and selection
- Scales perfectly with zoom

**Recommendation:** Start with SVG for easier shape management and event handling. Switch to Canvas
if performance issues arise in Story 3.

### Canvas Coordinate System

- Canvas uses pixel coordinates (top-left origin)
- Drawing coordinates may need translation/scaling
- Handle high DPI displays with devicePixelRatio
- Convert between screen coordinates and drawing coordinates

### Snap Guide Implementation

[Source: Epic 9 requirements]

**Snap Logic:**

```typescript
function shouldSnap(angle: number, threshold: number = 5): boolean {
  const snapAngles = [0, 90, 180, 270];
  return snapAngles.some((snapAngle) => Math.abs(angle - snapAngle) <= threshold);
}

function snapToNearest(angle: number): number {
  const snapAngles = [0, 90, 180, 270];
  return snapAngles.reduce((prev, curr) =>
    Math.abs(curr - angle) < Math.abs(prev - angle) ? curr : prev
  );
}
```

### Angle Calculation

```typescript
function calculateAngle(start: Point, end: Point): number {
  const dx = end.x - start.x;
  const dy = end.y - start.y;
  let angle = Math.atan2(dy, dx) * (180 / Math.PI);
  // Normalize to 0-360
  if (angle < 0) angle += 360;
  return Math.round(angle);
}
```

### PrimeNG Components

[Source: architecture/tech-stack.md#Technology Stack Table]

- CardModule for component container
- ButtonModule for toolbar buttons
- TooltipModule for angle indicator
- Use PrimeNG 17+ API with standalone component support

### File Locations

[Source: architecture/unified-project-structure.md]

- Main component: `apps/web/src/app/features/tools/components/svg-drawing/`
- Sub-components: `apps/web/src/app/features/tools/components/svg-drawing/components/`
- Service: `apps/web/src/app/features/tools/services/svg-drawing.service.ts`
- Shared types: `packages/shared/src/types/tools.interface.ts`
- Unit tests: alongside components with .spec.ts extension

### Existing Tool Integration

[Source: Epic 7 context]

- Svg-drawing component already scaffolded in Story 7.1
- Basic service structure exists
- Tool registration complete in admin panel
- Apply \*appToolGate directive for conditional rendering
- Follow existing tool component patterns (map, calendar, todo-app)

### Coding Standards

[Source: architecture/coding-standards.md#Critical Fullstack Rules]

- All shared types in packages/shared/src/types/
- JSDoc comments for all public methods and interfaces
- Use proper Angular dependency injection with inject()
- Validate input on frontend for user experience
- Use proper error handling patterns

### Performance Considerations

[Source: Epic 9 Risk Mitigation]

- Use requestAnimationFrame for smooth rendering
- Throttle mousemove events (16ms for 60fps)
- Implement viewport culling if needed in future stories
- Monitor performance with 50+ shapes

### Tailwind CSS Styling

[Source: architecture/tech-stack.md#Technology Stack Table]

- Use Tailwind utility classes for component styling
- Full viewport: `w-full h-full absolute inset-0`
- Toolbar positioning: `fixed top-0 left-0 right-0 z-10`
- Angle indicator: `absolute bg-gray-800 text-white px-2 py-1 rounded text-sm`

### Shared Types Structure

[Source: architecture/coding-standards.md#Critical Fullstack Rules]

All drawing-related types must be defined in `packages/shared/src/types/tools.interface.ts`:

```typescript
export interface Point {
  x: number;
  y: number;
}

export interface Shape {
  id: string;
  type: 'line' | 'polygon';
  color: string;
  strokeWidth: number;
  createdAt: Date;
}

export interface LineShape extends Shape {
  type: 'line';
  start: Point;
  end: Point;
}
```

### Previous Story Insights

No previous SVG drawing stories exist. This is the first story in Epic 9. Follow patterns
established in Tool stories 7.1, 7.2, and 7.3 for component structure and service integration.

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-09-30 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
