# Story 30.4: Product, Appointment, and Restaurant Analytics Strategies (Backend)

## Status

Draft

## Story

**As a** backend developer, **I want** analytics strategies for Product, Appointment, and Restaurant
templates, **so that** sales metrics, booking heatmaps, and item popularity can be computed.

## Acceptance Criteria

1. `ProductAnalyticsStrategy` computes sales/revenue metrics
2. `AppointmentAnalyticsStrategy` generates booking heatmap
3. `RestaurantAnalyticsStrategy` computes item popularity
4. Performance optimization (transactions, indexes, JSONB aggregation)
5. Unit tests for all three strategies
6. Integration tests with test data

## Tasks / Subtasks

- [ ] **Task 1: Add repository helpers for commerce templates** (AC: 1, 3, 4)
  - [ ] Implement queries that aggregate order totals, revenue sums, and menu item popularity from
        `form_submissions` JSONB payloads for product and restaurant templates.
        `[Source: docs/architecture/epic-18-architecture-diagram.md#storage--database]`
  - [ ] Ensure SQL uses indexes/GIN operators aligned with the FORMS database to keep analytics
        queries performant even with thousands of submissions.
        `[Source: docs/architecture/database-separation-implementation-summary.md#forms-database-nodeangularfullstack_forms]`

- [ ] **Task 2: Build `ProductAnalyticsStrategy`** (AC: 1, 4)
  - [ ] Create `apps/api/src/services/analytics/strategies/product-analytics.strategy.ts` that
        surfaces totals (orders, units sold, revenue, average order value) plus trend data.
        `[Source: docs/architecture/backend-architecture.md#service-architecture]`
  - [ ] Wrap revenue aggregation in a read-only transaction to keep calculations consistent while
        scanning submission data.
        `[Source: docs/architecture/security-and-performance.md#performance-optimization]`

- [ ] **Task 3: Build `AppointmentAnalyticsStrategy`** (AC: 2, 4)
  - [ ] Add `apps/api/src/services/analytics/strategies/appointment-analytics.strategy.ts` that
        buckets bookings by time slot/day to power a heatmap.
        `[Source: docs/architecture/backend-architecture.md#service-architecture]`
  - [ ] Normalize timestamps to the tenant's timezone (if available) before building slot counts so
        downstream visualizations stay accurate.
        `[Source: docs/architecture/security-and-performance.md#performance-optimization]`

- [ ] **Task 4: Build `RestaurantAnalyticsStrategy`** (AC: 3, 4)
  - [ ] Create `apps/api/src/services/analytics/strategies/restaurant-analytics.strategy.ts`
        summarizing menu item selections, option popularity, and add-on frequency from submission
        JSON. `[Source: docs/architecture/backend-architecture.md#service-architecture]`
  - [ ] Reuse repository helpers from Task 1 to avoid re-implementing JSON parsing logic and keep
        code testable. `[Source: docs/architecture/source-tree.md#backend-structure-appsapi]`

- [ ] **Task 5: Enforce performance safeguards** (AC: 4)
  - [ ] Add EXPLAIN ANALYZE checks (documented in story notes) proving each strategy's core query
        executes in <300 ms for representative datasets, meeting backend performance targets.
        `[Source: docs/architecture/security-and-performance.md#performance-optimization]`
  - [ ] Introduce indexes or partial aggregations only within the FORMS database so the dashboard
        database remains untouched.
        `[Source: docs/architecture/database-separation-implementation-summary.md#forms-database-nodeangularfullstack_forms]`

- [ ] **Task 6: Unit tests for every strategy** (AC: 5)
  - [ ] Mock repository outputs covering top-selling item, zero-booking day, and tie scenarios to
        ensure formatting logic does not divide by zero.
        `[Source: docs/architecture/testing-strategy.md#backend-tests]`

- [ ] **Task 7: Integration smoke tests with seeded data** (AC: 6)
  - [ ] Seed product, appointment, and restaurant submissions in the FORMS database fixture, then
        exercise analytics endpoints/service functions via Supertest to verify JSON shapes match
        `CategoryMetrics`. `[Source: docs/architecture/testing-strategy.md#backend-api-test]`
  - [ ] Confirm ApiError responses follow the documented format when requested form IDs lack
        category metadata.
        `[Source: docs/architecture/error-handling-strategy.md#error-response-format]`

## Dev Notes

### Previous Story Insights

- No specific guidance found in architecture docs.

### Data Models

- The FORMS database stores submission payloads (including commerce-related fields) in JSONB
  columns, so analytics queries must extract numeric fields (quantity, price, slot) from
  `form_submissions`.
  `[Source: docs/architecture/database-separation-implementation-summary.md#forms-database-nodeangularfullstack_forms]`
- Storage diagrams emphasize reliance on PostgreSQL JSONB features, encouraging use of operators and
  indexes tailored to those columns for performance.
  `[Source: docs/architecture/epic-18-architecture-diagram.md#storage--database]`

### API Specifications

- Result payloads must map cleanly to the OpenAPI-defined response schema and error shape, ensuring
  parity once Story 30.5 exposes the REST endpoint.
  `[Source: docs/architecture/api-specification.md#rest-api-specification]`

### Component Specifications

- No specific guidance found in architecture docs.

### File Locations

- Strategy classes belong in the backend service layer
  (`apps/api/src/services/analytics/strategies`) and should avoid leaking repository internals
  upward per the documented folder structure.
  `[Source: docs/architecture/source-tree.md#backend-structure-appsapi]`
- Shared metric types feeding these strategies originate from `packages/shared`, reinforcing the
  cross-workspace type-sharing discipline.
  `[Source: docs/architecture/source-tree.md#packagesshared]`

### Testing Requirements

- Jest unit tests continue to live under `apps/api/tests/unit/services`, giving each strategy its
  own spec file for deterministic scenarios.
  `[Source: docs/architecture/testing-strategy.md#backend-tests]`
- Integration coverage relies on Supertest with a real database connection, matching the recommended
  backend API testing approach. `[Source: docs/architecture/testing-strategy.md#backend-api-test]`

### Technical Constraints

- Backend performance targets (P95 <200 ms, P99 <500 ms) apply to analytics endpoints, so queries
  must lean on prepared statements, indexes, and transactions only where necessary.
  `[Source: docs/architecture/security-and-performance.md#performance-optimization]`
- Clean architecture requires strategies to orchestrate repositories without embedding SQL inside
  controllers/routes. `[Source: docs/architecture/backend-architecture.md#service-architecture]`
- Shared coding standards mandate JSDoc and type safety for all exported classes and DTOs.
  `[Source: docs/architecture/coding-standards.md#documentation-standards]`

## Testing

- Run Jest unit specs for each new strategy plus repository helper tests using the backend unit test
  layout. `[Source: docs/architecture/testing-strategy.md#backend-tests]`
- Execute Supertest-based integration scenarios that seed representative submissions, verifying
  ApiError formatting for invalid states.
  `[Source: docs/architecture/testing-strategy.md#backend-api-test]`

## Change Log

| Date       | Version | Description                          | Author             |
| ---------- | ------- | ------------------------------------ | ------------------ |
| 2025-01-27 | 1.0     | Initial story draft and task outline | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be populated by the development agent._

### Debug Log References

_To be populated by the development agent._

### Completion Notes List

_To be populated by the development agent._

### File List

_To be populated by the development agent._

## QA Results

_QA review not yet executed for this draft._
