# Story 10.3: Form Builder API Routes and Controllers

## Status

Draft

## Story

**As a** backend developer, **I want** to create RESTful API endpoints for form CRUD operations with
proper authentication and validation, **so that** authenticated users can manage their forms via
HTTP API.

## Acceptance Criteria

1. **AC1**: `/apps/api/src/routes/forms.routes.ts` implements protected routes: `POST /api/forms`,
   `GET /api/forms`, `GET /api/forms/:id`, `PUT /api/forms/:id`, `DELETE /api/forms/:id`
2. **AC2**: All routes use `AuthMiddleware.authenticate` for JWT validation
3. **AC3**: Routes include role-based access control (users can only access their own forms, admins
   can access all)
4. **AC4**: `FormsController` in `/apps/api/src/controllers/forms.controller.ts` handles all route
   logic
5. **AC5**: Request validators in `/apps/api/src/validators/forms.validator.ts` validate: title
   (required, max 200 chars), description (max 2000 chars), schema JSON structure
6. **AC6**: XSS protection middleware sanitizes all text inputs (title, description, field labels)
7. **AC7**: All routes include OpenAPI/Swagger JSDoc annotations
8. **AC8**: Error responses follow existing error format with status codes and messages

## Tasks / Subtasks

- [ ] Create FormsController with route handlers (AC: 4, 8)
  - [ ] Create `/apps/api/src/controllers/forms.controller.ts` file
  - [ ] Import FormsService and inject via constructor
  - [ ] Implement `createForm = AsyncHandler(async (req, res, next) => {...})` handler
  - [ ] Extract userId from req.user, tenantId from req.tenant (populated by auth middleware)
  - [ ] Call formsService.createForm() and return 201 status with created form
  - [ ] Implement `getForms = AsyncHandler(async (req, res, next) => {...})` handler
  - [ ] Support pagination query params: page (default 1), limit (default 20)
  - [ ] Filter by userId (or all for admins) and tenantId
  - [ ] Return forms array with pagination metadata
  - [ ] Implement `getFormById = AsyncHandler(async (req, res, next) => {...})` handler
  - [ ] Validate form ownership (userId match) or admin role
  - [ ] Return 404 ApiError if form not found
  - [ ] Return 403 ApiError if user doesn't own form and is not admin
  - [ ] Implement `updateForm = AsyncHandler(async (req, res, next) => {...})` handler
  - [ ] Validate ownership before allowing update
  - [ ] Call formsService.update() with sanitized input
  - [ ] Implement `deleteForm = AsyncHandler(async (req, res, next) => {...})` handler
  - [ ] Validate ownership before deletion
  - [ ] Return 204 No Content on successful deletion
  - [ ] Add JSDoc comments to all controller methods

- [ ] Create request validators (AC: 5, 6)
  - [ ] Create `/apps/api/src/validators/forms.validator.ts` file
  - [ ] Import express-validator functions: body, param, validationResult
  - [ ] Create `createFormValidator` array with rules:
    - body('title').trim().notEmpty().isLength({ max: 200 })
    - body('description').optional().trim().isLength({ max: 2000 })
    - body('schema').optional().isObject()
    - body('schema.fields').optional().isArray()
  - [ ] Create `updateFormValidator` array with same rules (all optional except param validation)
  - [ ] Create `formIdValidator` for param validation:
    - param('id').isUUID().withMessage('Invalid form ID')
  - [ ] Create `validateFormSchema` function to check schema structure:
    - Verify fields array contains valid FormField objects
    - Check for duplicate field names
    - Validate regex patterns are valid RegExp
  - [ ] Apply XSS sanitization using express-validator's `escape()` on title and description
  - [ ] Export validators for use in routes

- [ ] Create routes with authentication and validation (AC: 1, 2, 3, 7)
  - [ ] Create `/apps/api/src/routes/forms.routes.ts` file
  - [ ] Import Router from express
  - [ ] Import AuthMiddleware.authenticate and authorize from existing middleware
  - [ ] Import FormsController and validators
  - [ ] Define POST /api/forms route:
    - Apply authenticate middleware
    - Apply createFormValidator
    - Call formsController.createForm
    - Add OpenAPI JSDoc: @swagger tags, summary, requestBody, responses
  - [ ] Define GET /api/forms route:
    - Apply authenticate middleware
    - Add query params for pagination
    - Call formsController.getForms
    - Add OpenAPI JSDoc annotations
  - [ ] Define GET /api/forms/:id route:
    - Apply authenticate middleware
    - Apply formIdValidator
    - Call formsController.getFormById
    - Add OpenAPI JSDoc annotations
  - [ ] Define PUT /api/forms/:id route:
    - Apply authenticate middleware
    - Apply formIdValidator and updateFormValidator
    - Call formsController.updateForm
    - Add OpenAPI JSDoc annotations
  - [ ] Define DELETE /api/forms/:id route:
    - Apply authenticate middleware
    - Apply formIdValidator
    - Call formsController.deleteForm
    - Add OpenAPI JSDoc annotations
  - [ ] Export router as `formsRouter`

- [ ] Register routes in main server file (IV: 1)
  - [ ] Open `/apps/api/src/index.ts` (or server.ts/app.ts based on project structure)
  - [ ] Import formsRouter from './routes/forms.routes'
  - [ ] Register with app.use('/api/forms', formsRouter)
  - [ ] Verify route prefix follows existing pattern (/api/v1 or /api)

- [ ] Write integration tests for API endpoints (IV: 2, 3, 4, 5)
  - [ ] Create `/apps/api/tests/integration/forms.test.ts`
  - [ ] Setup test database and seed test user
  - [ ] Test POST /api/forms:
    - Test successful form creation (201 status)
    - Test missing title validation (400 status)
    - Test title too long validation (400 status)
    - Test unauthenticated request (401 status)
  - [ ] Test GET /api/forms:
    - Test returns user's forms only (not other users' forms)
    - Test admin can see all forms
    - Test pagination works correctly
  - [ ] Test GET /api/forms/:id:
    - Test returns form for owner (200 status)
    - Test 403 error for non-owner non-admin
    - Test 404 error for invalid ID
  - [ ] Test PUT /api/forms/:id:
    - Test successful update for owner (200 status)
    - Test 403 error for non-owner
    - Test validation errors (400 status)
  - [ ] Test DELETE /api/forms/:id:
    - Test successful deletion for owner (204 status)
    - Test 403 error for non-owner
    - Test 404 error for invalid ID
  - [ ] Test existing routes still work after adding forms routes (IV: 2)

- [ ] Update Swagger documentation (AC: 7)
  - [ ] Verify OpenAPI annotations generate correct Swagger docs
  - [ ] Test Swagger UI at http://localhost:3000/api-docs
  - [ ] Verify all routes appear under "Forms" tag
  - [ ] Check request/response schemas are correctly documented

## Dev Notes

### Previous Story Insights

Story 10.2 created repositories and service layer. This story exposes that functionality via REST
API endpoints with proper authentication and validation.

### Data Models

**Request/Response Formats:** [Source: docs/architecture/api-specification.md]

- Standard success response: `{ success: true, data: {...} }`
- Standard error response:
  `{ error: { code: string, message: string, details: object, timestamp: ISO8601, requestId: string } }`
- Pagination response: `{ data: [...], pagination: { page, limit, total, totalPages } }`

**Authentication Context:** [Source: docs/architecture/backend-architecture.md#Middleware/Guards]

- req.user populated by authenticate middleware (User object with id, role, tenantId)
- req.tenant populated when user has tenantId (Tenant object)
- AuthRequest interface extends Express Request with user and tenant properties

### API Specifications

**Route Patterns:** [Source: docs/architecture/api-specification.md]

- POST /api/forms - Create new form (requires auth)
- GET /api/forms - List user's forms with pagination (requires auth)
- GET /api/forms/:id - Get single form (requires auth + ownership/admin)
- PUT /api/forms/:id - Update form (requires auth + ownership)
- DELETE /api/forms/:id - Delete form (requires auth + ownership)

**Authentication:** [Source:
docs/architecture/backend-architecture.md#Authentication-and-Authorization]

- All routes require JWT authentication via AuthMiddleware.authenticate
- Token extracted from Authorization header: `Bearer <token>`
- Middleware attaches user object to request
- Role-based access: Users can only access own forms, admins can access all

**Validation:** [Source: docs/architecture/backend-architecture.md#Service-Architecture]

- express-validator for input validation
- XSS sanitization using escape() function
- JSON schema validation for form schema structure
- Custom validators for business logic (duplicate field names, regex patterns)

### Component Specifications

No frontend components in this story. Backend API only. Frontend will consume these APIs in Story
10.4+.

### File Locations

**Controller:** [Source: docs/architecture/unified-project-structure.md#apps/api]

- Create: `/apps/api/src/controllers/forms.controller.ts`
- Pattern: Follow existing controllers (e.g., `/apps/api/src/controllers/users.controller.ts`)

**Routes:** [Source: docs/architecture/unified-project-structure.md#apps/api]

- Create: `/apps/api/src/routes/forms.routes.ts`
- Register in: `/apps/api/src/index.ts` with `app.use('/api/forms', formsRouter)`
- Pattern: Follow existing routes (e.g., `/apps/api/src/routes/users.routes.ts`)

**Validators:** [Source: docs/architecture/unified-project-structure.md#apps/api]

- Create: `/apps/api/src/validators/forms.validator.ts`
- Pattern: Follow existing validators (e.g., `/apps/api/src/validators/users.validator.ts`)

**Tests:** [Source: docs/architecture/testing-strategy.md#Backend-Tests]

- Create: `/apps/api/tests/integration/forms.test.ts`
- Pattern: Follow existing integration tests (e.g., `/apps/api/tests/integration/auth.test.ts`)

### Testing Requirements

**Integration Tests:** [Source: docs/architecture/testing-strategy.md#Backend-API-Test]

- Use supertest for HTTP request testing
- Test all routes with various scenarios (success, validation errors, auth errors)
- Verify authentication middleware integration
- Test role-based access control (user vs admin)
- Verify existing routes remain functional

**Test Database:** [Source: docs/architecture/testing-strategy.md#Backend-Tests]

- Use separate test database (configured in test environment)
- Clean database before each test suite
- Seed test users with different roles (admin, user)
- Verify multi-tenancy isolation when enabled

**Test Commands:** [Source: docs/CLAUDE.md#Testing-Commands]

- Run integration tests: `npm run test:integration`
- Run specific test: `npm --workspace=apps/api run test -- --testPathPattern="forms.test.ts"`

### Technical Constraints

**Controller Standards:** [Source:
docs/architecture/backend-architecture.md#Controller/Route-Organization]

- Use AsyncHandler wrapper for error handling in async routes
- Extract user from req.user (populated by auth middleware)
- Extract tenant from req.tenant (when multi-tenancy enabled)
- Return standardized response format: { success: true, data: {...} }
- Throw ApiError with appropriate status codes for errors

**Route Standards:** [Source: docs/architecture/backend-architecture.md#Service-Architecture]

- Apply authenticate middleware to all protected routes
- Apply validation middleware before controller
- Use existing passport JWT strategy from `src/config/passport.ts`
- Register routes in main app with consistent prefix (/api/forms)
- Include OpenAPI/Swagger JSDoc annotations

**Validation Standards:** [Source: docs/architecture/coding-standards.md#Critical-Fullstack-Rules]

- Validate all user input on backend (never trust client)
- Use express-validator for declarative validation
- Sanitize inputs to prevent XSS attacks
- Validate JSON schema structure for complex objects
- Return 400 status code with descriptive error messages

**Error Handling:** [Source: docs/architecture/backend-architecture.md#Service-Architecture]

- All errors use ApiError class from `src/utils/errors.ts`
- 400: Bad Request (validation errors)
- 401: Unauthorized (authentication required)
- 403: Forbidden (insufficient permissions)
- 404: Not Found (resource doesn't exist)
- 500: Internal Server Error (unexpected errors)

**OpenAPI Documentation:** [Source: docs/architecture/api-specification.md]

- Use JSDoc @swagger annotations for route documentation
- Include tags, summary, description, requestBody, responses
- Define request/response schemas
- Document authentication requirements
- Auto-generated docs available at /api-docs endpoint

### Testing

**Test File Location:** [Source: docs/architecture/testing-strategy.md#Backend-Tests]

- `/apps/api/tests/integration/forms.test.ts`

**Testing Standards:** [Source: docs/architecture/testing-strategy.md#Backend-API-Test]

- Test all CRUD operations (POST, GET, PUT, DELETE)
- Verify authentication middleware blocks unauthenticated requests
- Test role-based access control (owner vs admin)
- Verify validation errors return appropriate status codes
- Test tenant isolation when multi-tenancy enabled
- Verify existing routes remain functional

**Testing Frameworks:** [Source: docs/architecture/tech-stack.md]

- Jest 29+ for test framework
- Supertest 6+ for HTTP request testing
- Seed test database with users and forms

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-04 | 1.0     | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
