# Story 9.3: SVG Export & Polish

## Status

Draft

## Story

**As a** user, **I want** to export my drawings as SVG files with configurable options, persist my
work across sessions, and access comprehensive keyboard shortcuts, **so that** I can save, share,
and efficiently work with my geometric drawings.

## Acceptance Criteria

1. SVG export generates valid, browser-renderable files
2. Export options allow customization of output
3. Keyboard shortcuts work as documented
4. Drawing state persists across browser sessions
5. Help panel documents all features and shortcuts
6. UI polish matches existing tools standards

## Tasks / Subtasks

- [ ] Implement SVG export functionality (AC: 1)
  - [ ] Create exportToSVG() method in svg-drawing.service.ts
  - [ ] Convert all shapes to SVG path/polygon elements
  - [ ] Generate SVG document with proper namespaces
  - [ ] Set viewBox based on drawing bounds
  - [ ] Include shape styles (stroke, fill, width) in SVG
  - [ ] Create downloadSVG() utility to trigger browser download
  - [ ] Validate generated SVG structure
- [ ] Create export options panel component (AC: 2)
  - [ ] Create
        `apps/web/src/app/features/tools/components/svg-drawing/components/export-options/export-options.component.ts`
  - [ ] Create `export-options.component.spec.ts`
  - [ ] Configure as standalone component
  - [ ] Add PrimeNG Dialog, InputText, Dropdown imports
  - [ ] Filename input field with .svg extension
  - [ ] Canvas dimensions input (width x height)
  - [ ] Optimization level dropdown (none, basic, aggressive)
  - [ ] Preview checkbox option
  - [ ] Export button with loading state
  - [ ] Style as modal dialog with Tailwind CSS
- [ ] Define export options interface (AC: 2)
  - [ ] Update `packages/shared/src/types/tools.interface.ts`
  - [ ] Define ExportOptions interface
  - [ ] Fields: filename, width, height, optimizationLevel
  - [ ] Define OptimizationLevel enum
  - [ ] Add viewport padding option
- [ ] Implement SVG optimization (AC: 2)
  - [ ] Remove unnecessary whitespace and formatting
  - [ ] Round coordinate values to 2 decimal places
  - [ ] Combine similar path segments
  - [ ] Remove default style attributes
  - [ ] Minify SVG output for 'aggressive' mode
- [ ] Create guide overlay component (AC: 3, 5)
  - [ ] Create
        `apps/web/src/app/features/tools/components/svg-drawing/components/guide-overlay/guide-overlay.component.ts`
  - [ ] Create `guide-overlay.component.spec.ts`
  - [ ] Configure as standalone component
  - [ ] Render grid lines (optional, toggleable)
  - [ ] Render snap guide indicators
  - [ ] Display ruler markings on edges
  - [ ] Add snap threshold configuration toggle
  - [ ] Style with semi-transparent overlay
- [ ] Implement configurable snap settings (AC: 3, 5)
  - [ ] Add snap settings to drawing service state
  - [ ] Enable/disable snap guides toggle
  - [ ] Snap threshold slider (1-10 degrees)
  - [ ] Grid snap option (align to grid)
  - [ ] Update guide overlay based on settings
  - [ ] Persist snap settings to localStorage
- [ ] Add comprehensive keyboard shortcuts (AC: 3)
  - [ ] Ctrl+S: Export to SVG
  - [ ] Ctrl+O: Open export options dialog
  - [ ] G: Toggle grid visibility
  - [ ] H: Toggle help panel
  - [ ] Spacebar: Pan mode toggle
  - [ ] - / -: Zoom in/out
  - [ ] Ctrl+A: Select all shapes
  - [ ] Implement using HostListener in main component
  - [ ] Prevent browser default actions (Ctrl+S)
- [ ] Implement localStorage persistence (AC: 4)
  - [ ] Create persistence service or utility
  - [ ] Save drawing state to localStorage on changes
  - [ ] Debounce save operations (1 second)
  - [ ] Load state on component initialization
  - [ ] Clear state on explicit user action
  - [ ] Handle localStorage quota exceeded errors
  - [ ] Add "New Drawing" button to clear state
  - [ ] Confirm before clearing unsaved work
- [ ] Create help panel component (AC: 5, 6)
  - [ ] Create
        `apps/web/src/app/features/tools/components/svg-drawing/components/help-panel/help-panel.component.ts`
  - [ ] Create `help-panel.component.spec.ts`
  - [ ] Configure as standalone component
  - [ ] Add PrimeNG Panel, Accordion imports
  - [ ] Document all drawing tools and their usage
  - [ ] List all keyboard shortcuts with descriptions
  - [ ] Add feature overview section
  - [ ] Include quick start guide
  - [ ] Style as collapsible side panel
  - [ ] Toggle with H key or button
- [ ] Add loading states (AC: 6)
  - [ ] Export button loading spinner during generation
  - [ ] Canvas loading state on initial load
  - [ ] "Saving..." indicator during localStorage writes
  - [ ] Use PrimeNG ProgressSpinner component
  - [ ] Disable UI during critical operations
- [ ] Add tooltips throughout UI (AC: 6)
  - [ ] Toolbar button tooltips with shortcuts
  - [ ] Property panel input tooltips
  - [ ] Export option tooltips
  - [ ] Use PrimeNG Tooltip directive
  - [ ] Consistent tooltip styling
- [ ] Implement file validation (AC: 1)
  - [ ] Validate SVG structure before download
  - [ ] Test SVG in hidden img element
  - [ ] Show error message on validation failure
  - [ ] Provide debug information for invalid SVG
- [ ] Add success/error notifications (AC: 6)
  - [ ] Success toast on SVG export
  - [ ] Error toast on export failure
  - [ ] Success toast on state save
  - [ ] Warning toast on localStorage quota
  - [ ] Use PrimeNG Toast service
  - [ ] Auto-dismiss after 3 seconds
- [ ] Implement canvas bounds calculation (AC: 1, 2)
  - [ ] Calculate bounding box for all shapes
  - [ ] Add configurable padding around bounds
  - [ ] Use bounds for SVG viewBox
  - [ ] Handle empty canvas (default dimensions)
  - [ ] Center shapes in exported SVG
- [ ] Polish UI/UX (AC: 6)
  - [ ] Consistent spacing and alignment
  - [ ] Smooth transitions for panel toggles
  - [ ] Loading states for async operations
  - [ ] Empty state message when no shapes
  - [ ] Confirmation dialogs for destructive actions
  - [ ] Consistent color scheme with other tools
  - [ ] Responsive design for various screen sizes
- [ ] Add performance monitoring (AC: 6)
  - [ ] Track render time for large drawings
  - [ ] Display warning for 50+ shapes
  - [ ] Add performance mode toggle (reduced quality)
  - [ ] Monitor localStorage size
  - [ ] Add shape count indicator
- [ ] Update main component with all features (AC: 5, 6)
  - [ ] Integrate export options dialog
  - [ ] Integrate guide overlay
  - [ ] Integrate help panel
  - [ ] Add export button to toolbar
  - [ ] Add new drawing button
  - [ ] Implement keyboard shortcut handling
  - [ ] Add loading states
  - [ ] Wire up all component events
- [ ] Create unit tests for SVG export
  - [ ] Test SVG generation with various shapes
  - [ ] Test export options application
  - [ ] Test SVG validation
  - [ ] Test bounds calculation
  - [ ] Test optimization levels
- [ ] Create unit tests for localStorage persistence
  - [ ] Test state save and load
  - [ ] Test debounce behavior
  - [ ] Test quota exceeded handling
  - [ ] Test clear state functionality
- [ ] Create unit tests for export options component
  - [ ] Test form validation
  - [ ] Test export trigger
  - [ ] Test option changes
- [ ] Create unit tests for help panel
  - [ ] Test content rendering
  - [ ] Test panel toggle
  - [ ] Test keyboard shortcut documentation
- [ ] Create unit tests for guide overlay
  - [ ] Test snap setting changes
  - [ ] Test grid toggle
  - [ ] Test visual rendering
- [ ] Create integration tests (AC: 1, 4)
  - [ ] Test full drawing → export → load workflow
  - [ ] Test persistence across page reload
  - [ ] Test exported SVG in browser
  - [ ] Test all keyboard shortcuts
- [ ] Verify E2E functionality
  - [ ] Manual test: Create drawing, export, verify SVG
  - [ ] Manual test: Draw shapes, reload page, verify persistence
  - [ ] Manual test: All keyboard shortcuts work
  - [ ] Manual test: Help panel shows all documentation
  - [ ] Manual test: Export options customize output
- [ ] Verify TypeScript compilation
  - [ ] Run `npm --workspace=apps/web run typecheck`
  - [ ] Fix any type errors
- [ ] Verify build success
  - [ ] Run `npm --workspace=apps/web run build`
  - [ ] Ensure no build errors
- [ ] Performance verification
  - [ ] Test with 50+ shapes for smooth rendering
  - [ ] Test localStorage with large drawings
  - [ ] Verify no memory leaks

## Dev Notes

### Testing Standards

[Source: architecture/testing-strategy.md#Test Organization]

- Frontend tests: alongside source files with .spec.ts extension
- Integration tests for full workflows
- Mock localStorage API in tests
- Test file download simulation
- Manual E2E testing for exported SVG validity

### SVG Export Implementation

**SVG Structure:**

```xml
<svg xmlns="http://www.w3.org/2000/svg"
     viewBox="0 0 800 600"
     width="800"
     height="600">
  <line x1="10" y1="20" x2="100" y2="200"
        stroke="#000000" stroke-width="2"/>
  <polygon points="50,50 100,100 75,150"
           stroke="#000000" stroke-width="2"
           fill="transparent"/>
</svg>
```

**Export Process:**

1. Calculate bounding box of all shapes
2. Apply padding to bounds
3. Generate SVG header with viewBox
4. Convert each shape to SVG element
5. Apply optimization based on level
6. Validate SVG structure
7. Trigger browser download

### SVG Export Utilities

```typescript
function shapesToSVG(shapes: Shape[], options: ExportOptions): string {
  const bounds = calculateBounds(shapes, options.padding);
  let svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="${bounds.x} ${bounds.y} ${bounds.width} ${bounds.height}" width="${options.width}" height="${options.height}">`;

  shapes.forEach((shape) => {
    svg += shapeToSVGElement(shape);
  });

  svg += '</svg>';

  if (options.optimizationLevel !== 'none') {
    svg = optimizeSVG(svg, options.optimizationLevel);
  }

  return svg;
}

function downloadSVG(svgContent: string, filename: string): void {
  const blob = new Blob([svgContent], { type: 'image/svg+xml' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = filename;
  link.click();
  URL.revokeObjectURL(url);
}
```

### localStorage Persistence

[Source: architecture/frontend-architecture.md#State Management Architecture]

**Storage Strategy:**

```typescript
interface StoredDrawing {
  version: string; // Schema version for migration
  shapes: Shape[];
  settings: DrawingSettings;
  timestamp: Date;
}

function saveDrawing(state: DrawingState): void {
  try {
    const stored: StoredDrawing = {
      version: '1.0',
      shapes: state.shapes,
      settings: state.settings,
      timestamp: new Date(),
    };
    localStorage.setItem('svg-drawing-state', JSON.stringify(stored));
  } catch (e) {
    if (e.name === 'QuotaExceededError') {
      // Handle quota exceeded
      console.error('localStorage quota exceeded');
    }
  }
}

function loadDrawing(): StoredDrawing | null {
  const stored = localStorage.getItem('svg-drawing-state');
  if (!stored) return null;

  try {
    return JSON.parse(stored);
  } catch (e) {
    console.error('Failed to parse stored drawing');
    return null;
  }
}
```

**Debouncing:** Use RxJS debounceTime for save operations:

```typescript
effect(() => {
  const state = this.drawingState();
  this.savePending$.next(state);
});

this.savePending$.pipe(debounceTime(1000)).subscribe((state) => {
  this.saveToLocalStorage(state);
});
```

### Keyboard Shortcuts Implementation

[Source: architecture/frontend-architecture.md#Component Architecture]

**Complete Shortcut Map:**

```typescript
const KEYBOARD_SHORTCUTS = {
  // Tools
  l: 'Select Line Tool',
  p: 'Select Polygon Tool',
  s: 'Select Selection Tool',

  // Actions
  Delete: 'Delete Selected Shape',
  Escape: 'Cancel / Deselect',

  // Undo/Redo
  'Ctrl+z': 'Undo',
  'Ctrl+y': 'Redo',
  'Ctrl+Shift+z': 'Redo',

  // File Operations
  'Ctrl+s': 'Export to SVG',
  'Ctrl+o': 'Open Export Options',

  // View
  g: 'Toggle Grid',
  h: 'Toggle Help Panel',
  '+': 'Zoom In',
  '-': 'Zoom Out',
  Space: 'Pan Mode',

  // Selection
  'Ctrl+a': 'Select All',
} as const;
```

### PrimeNG Components

[Source: architecture/tech-stack.md#Technology Stack Table]

**Export Options Dialog:**

- DialogModule for modal
- InputTextModule for filename
- InputNumberModule for dimensions
- DropdownModule for optimization level
- ButtonModule for actions

**Help Panel:**

- PanelModule or SidebarModule
- AccordionModule for sections
- DataViewModule for shortcut list

**Loading & Feedback:**

- ProgressSpinnerModule for loading states
- ToastModule for notifications
- MessageModule for inline messages

### File Locations

[Source: architecture/unified-project-structure.md]

- Export options:
  `apps/web/src/app/features/tools/components/svg-drawing/components/export-options/`
- Guide overlay: `apps/web/src/app/features/tools/components/svg-drawing/components/guide-overlay/`
- Help panel: `apps/web/src/app/features/tools/components/svg-drawing/components/help-panel/`
- Persistence utility: `apps/web/src/app/features/tools/services/` or inline in service
- Shared types: `packages/shared/src/types/tools.interface.ts`

### Previous Story Insights

From Story 9.1:

- Canvas renderer handles shape rendering
- Snap guides implemented
- Angle indicators working
- SVG rendering chosen

From Story 9.2:

- Toolbar component structure established
- Shape properties panel pattern defined
- Command pattern for undo/redo
- Shape selection and editing working

**Key Learnings:**

- Use sub-component architecture for complex UIs
- Signals for state management performs well
- Debounce operations for performance
- Immutable state updates essential

### SVG Optimization Strategies

**Basic Optimization:**

- Remove comments and unnecessary whitespace
- Round coordinates to 2 decimal places
- Use shorthand notation where possible

**Aggressive Optimization:**

- Combine consecutive path segments
- Remove default attribute values
- Use CSS classes for repeated styles
- Minify the entire SVG string

### Browser Download Implementation

Modern approach using Blob API:

```typescript
function triggerDownload(content: string, filename: string, mimeType: string): void {
  const blob = new Blob([content], { type: mimeType });
  const url = URL.createObjectURL(blob);

  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();

  // Cleanup
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
```

### Performance Monitoring

[Source: Epic 9 Risk Mitigation]

**Metrics to Track:**

- Shape count
- Render time (requestAnimationFrame)
- localStorage size
- Memory usage (if possible)

**Thresholds:**

- Warning at 50 shapes
- Performance mode suggestion at 75 shapes
- Max 100 shapes hard limit

**Performance Mode:**

- Reduce vertex rendering
- Simplify snap guides
- Throttle more aggressively
- Disable shadows/effects

### Coding Standards

[Source: architecture/coding-standards.md#Critical Fullstack Rules]

- JSDoc for all public APIs
- Error handling for file operations
- Validation for user inputs
- Proper cleanup in OnDestroy
- Type safety throughout

### UI Polish Checklist

[Source: Epic 9 Success Criteria]

**Visual Consistency:**

- Match PrimeNG theme used in other tools
- Consistent Tailwind spacing (p-4, m-2, etc.)
- Same color palette as existing tools
- Smooth transitions (transition-all duration-200)

**User Feedback:**

- Loading spinners for async operations
- Success/error toast notifications
- Disabled states for invalid actions
- Hover states for interactive elements

**Responsive Design:**

- Full desktop experience (1024px+)
- Simplified mobile view (hide side panels)
- Touch-friendly button sizes
- Readable text on all screen sizes

### Empty State Handling

When no shapes exist:

```html
<div class="flex flex-col items-center justify-center h-full text-gray-500">
  <i class="pi pi-pencil text-6xl mb-4"></i>
  <h3 class="text-xl font-semibold mb-2">No Drawings Yet</h3>
  <p class="text-sm mb-4">Start by selecting a tool and drawing on the canvas</p>
  <button pButton label="View Tutorial" (click)="openHelp()"></button>
</div>
```

### Integration with Existing Tools

[Source: Epic 7 context]

- Maintain same navigation patterns
- Use same PrimeNG components
- Follow same layout structure
- Consistent error handling
- Same accessibility standards

### Accessibility Considerations

- Keyboard navigation for all features
- ARIA labels for toolbar buttons
- Screen reader announcements for actions
- Focus management in dialogs
- High contrast mode support

### Help Panel Content Structure

**Sections:**

1. Quick Start Guide
2. Drawing Tools (Line, Polygon, Select)
3. Shape Properties
4. Keyboard Shortcuts (organized by category)
5. Export Options
6. Tips & Tricks

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-09-30 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
