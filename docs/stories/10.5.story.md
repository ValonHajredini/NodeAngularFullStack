# Story 10.5: Drag-and-Drop Field Palette and Canvas

## Status

Draft

## Story

**As a** form creator, **I want** to drag form field components from a palette onto a canvas, **so
that** I can visually build my form layout.

## Acceptance Criteria

1. **AC1**: Field palette displays draggable components: Text Input, Email, Number, Select,
   Textarea, File Upload, Checkbox, Radio Group, Date, DateTime, Toggle, Section Divider
2. **AC2**: Angular CDK DragDrop module integrated for drag-and-drop functionality
3. **AC3**: Canvas accepts dropped fields and displays them in order
4. **AC4**: Each dropped field shows: field type icon, label (default: "Untitled Field"), drag
   handle for reordering
5. **AC5**: Fields can be reordered on canvas via drag-and-drop
6. **AC6**: Clicking a field on canvas selects it and shows properties in right sidebar
7. **AC7**: Visual feedback during drag: ghost preview, drop zones highlighted, invalid drop areas
   indicated
8. **AC8**: Keyboard accessibility: Tab to navigate fields, Arrow keys to reorder, Enter to select
9. **AC9**: Empty canvas shows helpful hint: "Drag fields from the palette to start building your
   form"
10. **AC10**: Service tracks field array with unique IDs, types, and properties

## Tasks / Subtasks

- [ ] Install and configure Angular CDK DragDrop (AC: 2)
  - [ ] Verify @angular/cdk is installed (check package.json)
  - [ ] If not installed, run `npm install @angular/cdk --workspace=apps/web`
  - [ ] Import DragDropModule in field-palette.component.ts and form-canvas.component.ts

- [ ] Update FieldPalette component for drag source (AC: 1, 2, 7)
  - [ ] Open
        `/apps/web/src/app/features/tools/components/form-builder/field-palette/field-palette.component.ts`
  - [ ] Import DragDropModule from @angular/cdk/drag-drop
  - [ ] Add cdkDrag directive to each field type card in template
  - [ ] Create field types array with metadata:
    - { type: 'text', label: 'Text Input', icon: 'pi-pencil' }
    - { type: 'email', label: 'Email', icon: 'pi-envelope' }
    - { type: 'number', label: 'Number', icon: 'pi-hashtag' }
    - { type: 'select', label: 'Select', icon: 'pi-list' }
    - { type: 'textarea', label: 'Textarea', icon: 'pi-align-left' }
    - { type: 'file', label: 'File Upload', icon: 'pi-upload' }
    - { type: 'checkbox', label: 'Checkbox', icon: 'pi-check-square' }
    - { type: 'radio', label: 'Radio Group', icon: 'pi-circle' }
    - { type: 'date', label: 'Date', icon: 'pi-calendar' }
    - { type: 'datetime', label: 'DateTime', icon: 'pi-clock' }
    - { type: 'toggle', label: 'Toggle', icon: 'pi-toggle-on' }
    - { type: 'divider', label: 'Section Divider', icon: 'pi-minus' }
  - [ ] Add drag preview template with cdkDragPreview directive
  - [ ] Style drag preview: semi-transparent, shows field type icon and label
  - [ ] Add cdkDragData binding with field type metadata

- [ ] Update FormCanvas component for drop target (AC: 3, 4, 5, 7, 9)
  - [ ] Open
        `/apps/web/src/app/features/tools/components/form-builder/form-canvas/form-canvas.component.ts`
  - [ ] Import CdkDropList, CdkDrag from @angular/cdk/drag-drop
  - [ ] Wrap field list in cdkDropList directive
  - [ ] Set cdkDropListData to formFields signal
  - [ ] Implement (cdkDropListDropped)="onFieldDropped($event)" handler
  - [ ] In onFieldDropped handler:
    - Check if dropped from palette (event.previousContainer !== event.container)
    - If from palette: create new FormField with unique ID, default label "Untitled Field", field
      type
    - If reordering: update formFields array order using moveItemInArray()
    - Call formBuilderService.addField() or reorder method
    - Mark form as dirty
  - [ ] Add cdkDrag directive to each field item for reordering
  - [ ] Add drag handle with cdkDragHandle: <i class="pi pi-bars cdkDragHandle"></i>
  - [ ] Style drop list placeholder (shown during drag): dashed border, background highlight
  - [ ] Implement empty state: @if (!formFields().length) with helper text and icon

- [ ] Implement field selection on canvas (AC: 6)
  - [ ] Add (click)="selectField(field)" handler to each field card
  - [ ] Implement selectField(field: FormField) method:
    - Call formBuilderService.selectField(field)
    - Add 'selected' CSS class to clicked field (blue border)
    - Remove 'selected' class from previously selected field
  - [ ] Use computed signal from service to track selected field
  - [ ] Apply visual indicator: border-blue-500 Tailwind class when selected

- [ ] Update FormBuilderService for field management (AC: 10)
  - [ ] Open `/apps/web/src/app/features/tools/components/form-builder/form-builder.service.ts`
  - [ ] Update addField method:
    - Generate unique ID using crypto.randomUUID() or nanoid
    - Create FormField object with: id, type, label: 'Untitled Field', fieldName: kebab-case of
      label, default values
    - Add to formFields signal array
    - Mark isDirty as true
  - [ ] Implement reorderFields(previousIndex: number, currentIndex: number) method:
    - Use array splice to reorder fields
    - Update formFields signal
    - Mark isDirty as true
  - [ ] Implement removeField(fieldId: string) method:
    - Filter out field from formFields array
    - If removed field was selected, clear selectedField
    - Mark isDirty as true

- [ ] Implement keyboard accessibility (AC: 8, IV: 5)
  - [ ] Add tabindex="0" to field cards on canvas
  - [ ] Implement (keydown)="handleKeyboard($event)" on field cards
  - [ ] Handle keyboard events:
    - Tab: Navigate between fields (native browser behavior)
    - Enter/Space: Select field (call selectField())
    - ArrowUp: Move field up in list (reorder)
    - ArrowDown: Move field down in list (reorder)
    - Delete: Remove selected field
  - [ ] Add aria-label to field cards: "{{field.label}} field"
  - [ ] Add role="listitem" to field cards
  - [ ] Test keyboard navigation with screen reader (optional)

- [ ] Style drag-and-drop visual feedback (AC: 7)
  - [ ] Add CSS for drag preview: opacity-75, shadow-lg, rounded border
  - [ ] Style drop zone highlight: border-dashed border-blue-400 when cdkDropListDragover
  - [ ] Add transition classes for smooth animations
  - [ ] Style invalid drop zone (if needed): border-red-400, cursor-not-allowed
  - [ ] Add drag placeholder: dashed border box with "Drop here" text

- [ ] Test drag-and-drop functionality (IV: 1, 2, 3, 4)
  - [ ] Test dragging each field type from palette to canvas
  - [ ] Verify field added to canvas with correct type, default label
  - [ ] Test reordering fields on canvas (drag up/down)
  - [ ] Test dropping outside canvas (should not add field)
  - [ ] Test rapid dragging (50+ fields) - verify performance remains smooth
  - [ ] Test on tablet/touch device (if CDK supports touch)
  - [ ] Verify unique IDs generated for each field
  - [ ] Test undo/redo consideration for future (note in technical debt)

- [ ] Write component tests (AC: 8, IV: 5)
  - [ ] Update field-palette.component.spec.ts:
    - Test field types array contains all 12 types
    - Test cdkDrag directive applied to field cards
  - [ ] Update form-canvas.component.spec.ts:
    - Test empty state displays when no fields
    - Test field cards render when fields present
    - Test field selection updates selectedField signal
    - Mock FormBuilderService and test interactions
  - [ ] Test keyboard event handlers:
    - Test Enter key selects field
    - Test Arrow keys reorder fields
    - Test Delete key removes field

## Dev Notes

### Previous Story Insights

Story 10.4 created the component structure. This story adds drag-and-drop interactivity using
Angular CDK.

### Data Models

**Field Types:** [Source: docs/prd-form-builder/epic-10#Story-1.5]

- 12 field types supported: text, email, number, select, textarea, file, checkbox, radio, date,
  datetime, toggle, divider
- Each field has: type, label, fieldName (unique), icon for palette display
- Default label: "Untitled Field" when dropped

**FormField Structure:** [Source: packages/shared/src/types/forms.types.ts (from Story 10.1)]

- id: string (UUID or nanoid)
- type: FormFieldType enum
- label: string
- fieldName: string (unique, kebab-case)
- Additional properties: placeholder, helpText, required, validation, etc.

### API Specifications

No API calls in this story. Pure frontend drag-and-drop interaction.

### Component Specifications

**Angular CDK DragDrop:** [Source: https://material.angular.io/cdk/drag-drop]

- CdkDropList: Container that accepts dropped items
- CdkDrag: Makes element draggable
- CdkDragHandle: Specific area to initiate drag
- Events: cdkDropListDropped, cdkDropListEntered, cdkDropListExited
- Utilities: moveItemInArray() for reordering

**Drag-and-Drop Flow:**

1. User drags field from palette (CdkDrag on palette item)
2. Field preview appears during drag (cdkDragPreview template)
3. Canvas drop zone highlights (cdkDropList on canvas)
4. User drops on canvas
5. cdkDropListDropped event fires
6. Handler creates new FormField or reorders existing
7. FormBuilderService updates formFields signal
8. Change detection updates UI (OnPush + signals)

### File Locations

**Components to Update:** [Source: docs/architecture/unified-project-structure.md#apps/web]

- Update:
  `/apps/web/src/app/features/tools/components/form-builder/field-palette/field-palette.component.ts`
- Update:
  `/apps/web/src/app/features/tools/components/form-builder/form-canvas/form-canvas.component.ts`
- Update: `/apps/web/src/app/features/tools/components/form-builder/form-builder.service.ts`

**Styles:** [Source: docs/architecture/unified-project-structure.md#apps/web]

- Inline Tailwind classes in component templates
- Optional: Create shared styles in component .scss files

**Tests:** [Source: docs/architecture/testing-strategy.md#Frontend-Tests]

- Update: `field-palette.component.spec.ts`
- Update: `form-canvas.component.spec.ts`

### Testing Requirements

**Component Tests:** [Source: docs/architecture/testing-strategy.md#Frontend-Component-Test]

- Test drag-and-drop simulation using Angular CDK testing utilities
- Mock FormBuilderService
- Test field creation with correct default values
- Test reordering logic with moveItemInArray()
- Test keyboard accessibility handlers

**Visual/Manual Tests:**

- Drag field from palette to canvas (visual confirmation)
- Reorder fields on canvas (visual confirmation)
- Test on different screen sizes (desktop, tablet)
- Test touch gestures on tablet (if CDK supports)

**Test Commands:** [Source: docs/CLAUDE.md#Testing-Commands]

- Run component tests:
  `npm --workspace=apps/web run test -- --include="**/form-canvas.component.spec.ts" --watch=false`

### Technical Constraints

**Angular CDK Version:** [Source: docs/architecture/tech-stack.md]

- Use Angular CDK version compatible with Angular 20+
- Check package.json for @angular/cdk version
- DragDrop module from @angular/cdk/drag-drop

**Performance Considerations:** [Source: docs/prd-form-builder/epic-10#Story-1.5-IV2]

- Canvas rendering must remain smooth with 50+ fields
- Use OnPush change detection strategy
- Signals for efficient updates
- Virtual scrolling if performance degrades (consider for technical debt)

**Accessibility:** [Source: docs/prd-form-builder/epic-10#Story-1.5-AC8]

- Keyboard navigation: Tab, Arrow keys, Enter, Delete
- ARIA labels for screen readers
- Focus management during drag-and-drop
- Announce field additions/removals to screen readers (future enhancement)

**Unique ID Generation:** [Source: docs/architecture/coding-standards.md]

- Use crypto.randomUUID() for browser support
- Alternative: nanoid library if crypto not available
- Ensure IDs are unique within form scope (not globally)

**State Management:** [Source: docs/architecture/frontend-architecture.md#State-Management-Patterns]

- FormBuilderService tracks all field state
- Use signals for reactive updates
- Computed signals for derived state (e.g., selected field index)
- Mark form as dirty on any field change

### Testing

**Test File Location:** [Source: docs/architecture/testing-strategy.md#Frontend-Tests]

- `/apps/web/src/app/features/tools/components/form-builder/field-palette/field-palette.component.spec.ts`
- `/apps/web/src/app/features/tools/components/form-builder/form-canvas/form-canvas.component.spec.ts`

**Testing Standards:** [Source: docs/architecture/testing-strategy.md#Frontend-Component-Test]

- Use Angular CDK testing utilities for drag-and-drop simulation
- Mock FormBuilderService with jasmine.createSpyObj
- Test event handlers (click, keydown, drop)
- Verify signal updates correctly
- Test edge cases: empty canvas, 50+ fields, rapid interactions

**Testing Frameworks:** [Source: docs/architecture/tech-stack.md]

- Karma + Jasmine for Angular testing
- Angular Testing Utilities (TestBed, ComponentFixture)
- Angular CDK testing utilities for drag-and-drop

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-04 | 1.0     | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
