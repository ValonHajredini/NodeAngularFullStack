# Story 31.1.1: CLI Package Setup with Commander

## Status

Draft

## Story

**As a** developer, **I want** a CLI package with Commander.js framework, **so that** I can run
`npx create-tool` to scaffold new tools with an intuitive command-line interface.

## Acceptance Criteria

1. ✅ New package created at `packages/create-tool/`
2. ✅ Commander.js installed and configured
3. ✅ CLI executable with proper permissions
4. ✅ `npx @nodeangularfullstack/create-tool` command works
5. ✅ Help command displays usage information

## Tasks / Subtasks

- [ ] **Task 1: Create CLI package structure** (AC: 1)
  - [ ] Create directory: `packages/create-tool/`
  - [ ] Create `package.json` with CLI configuration
  - [ ] Set package name: `@nodeangularfullstack/create-tool`
  - [ ] Configure `bin` field to point to CLI entry point
  - [ ] Add TypeScript configuration: `tsconfig.json`
  - [ ] Create source directory: `packages/create-tool/src/`
  - [ ] Create `src/index.ts` as CLI entry point
  - [ ] Add `.gitignore` for `dist/` and `node_modules/`

- [ ] **Task 2: Install dependencies** (AC: 2)
  - [ ] Install Commander.js: `npm install commander --workspace=packages/create-tool`
  - [ ] Install TypeScript types:
        `npm install @types/node --save-dev --workspace=packages/create-tool`
  - [ ] Install ts-node for development:
        `npm install ts-node --save-dev --workspace=packages/create-tool`
  - [ ] Verify dependencies in package.json

- [ ] **Task 3: Setup Commander.js CLI framework** (AC: 2, 4)
  - [ ] Import Commander in `src/index.ts`
  - [ ] Create program instance with `new Command()`
  - [ ] Configure CLI metadata (name, version, description)
  - [ ] Add shebang line: `#!/usr/bin/env node`
  - [ ] Parse command-line arguments: `program.parse(process.argv)`

- [ ] **Task 4: Create main command** (AC: 4, 5)
  - [ ] Define default action for tool creation
  - [ ] Add `create` command (or make it default)
  - [ ] Configure command description
  - [ ] Add command options (optional flags for future use)
  - [ ] Implement placeholder action that prints "CLI is working!"

- [ ] **Task 5: Add help and version commands** (AC: 5)
  - [ ] Configure `--version` flag using package.json version
  - [ ] Configure `--help` flag with usage examples
  - [ ] Add command descriptions for help output
  - [ ] Add usage examples in help text

- [ ] **Task 6: Setup build and execution scripts** (AC: 3, 4)
  - [ ] Add `build` script: `tsc` to compile TypeScript
  - [ ] Add `dev` script: `ts-node src/index.ts` for development
  - [ ] Add `prepublishOnly` script to build before publishing
  - [ ] Build CLI: `npm run build --workspace=packages/create-tool`
  - [ ] Make executable: `chmod +x packages/create-tool/dist/index.js`

- [ ] **Task 7: Test CLI execution** (AC: 4, 5)
  - [ ] Run locally: `node packages/create-tool/dist/index.js`
  - [ ] Run with npx (local): `npx --package=./packages/create-tool create-tool`
  - [ ] Test `--help` flag outputs usage information
  - [ ] Test `--version` flag outputs package version
  - [ ] Verify CLI executable permissions work

- [ ] **Task 8: Register package in workspace** (AC: 1)
  - [ ] Verify package appears in root `package.json` workspaces
  - [ ] Run `npm install` from root to link workspace package
  - [ ] Test workspace resolution: `npm ls @nodeangularfullstack/create-tool`

## Dev Notes

### Previous Story Insights

[Source: Epic 30.2 Stories]

- Clean separation of concerns proved effective (service → controller → routes)
- Comprehensive testing upfront saves time debugging later
- TypeScript strict mode catches errors early
- JSDoc documentation critical for maintainability

### CLI Package Architecture

[Source: architecture/source-tree.md#shared-packages-structure]

**New Package Location:** `packages/create-tool/`

**Package Structure:**

```
packages/create-tool/
├── src/
│   ├── index.ts              # CLI entry point
│   ├── commands/             # Command implementations (future)
│   ├── prompts/              # Inquirer prompts (Story 31.1.2)
│   ├── templates/            # EJS templates (Story 31.1.3)
│   └── utils/                # Helper functions
├── dist/                     # Compiled JavaScript (gitignored)
├── tests/                    # Jest tests (Story 31.1.4)
├── package.json              # Package configuration
├── tsconfig.json             # TypeScript configuration
└── README.md                 # CLI documentation
```

### Commander.js Framework

[Source: architecture/tech-stack.md + PRD Epic 31.1]

**Commander.js** is a popular Node.js CLI framework used by major tools (npm, yarn,
create-react-app).

**Basic Pattern:**

```typescript
#!/usr/bin/env node
import { Command } from 'commander';

const program = new Command();

program
  .name('create-tool')
  .version('1.0.0')
  .description('Scaffold new tools for NodeAngularFullStack')
  .action(() => {
    console.log('Creating tool...');
  });

program.parse(process.argv);
```

**Features Used:**

- `.name()` - CLI command name
- `.version()` - Version from package.json
- `.description()` - Help text
- `.action()` - Command handler
- `.option()` - Command flags (future)
- `.argument()` - Positional args (future)

### Package.json Configuration

[Source: packages/shared/package.json pattern]

**CLI Package Configuration:**

```json
{
  "name": "@nodeangularfullstack/create-tool",
  "version": "1.0.0",
  "description": "CLI tool to scaffold new tools",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "bin": {
    "create-tool": "dist/index.js"
  },
  "scripts": {
    "build": "tsc",
    "dev": "ts-node src/index.ts",
    "test": "jest",
    "prepublishOnly": "npm run build"
  },
  "keywords": ["cli", "scaffolding", "tools"],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "commander": "^11.0.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "ts-node": "^10.0.0",
    "typescript": "^5.0.0"
  }
}
```

**Key Fields:**

- `bin`: Maps command name to executable file
- `main`: Entry point for programmatic use
- `types`: TypeScript declarations
- `prepublishOnly`: Auto-build before npm publish

### TypeScript Configuration

[Source: architecture/tech-stack.md]

**CLI TypeScript Config:**

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "CommonJS",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "moduleResolution": "node",
    "resolveJsonModule": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

**Key Settings:**

- `module: "CommonJS"` - Node.js compatibility
- `target: "ES2020"` - Modern JavaScript features
- `declaration: true` - Generate .d.ts files
- `strict: true` - Type safety

### Shebang Line

[Source: Node.js CLI best practices]

**Shebang (first line of index.ts):**

```typescript
#!/usr/bin/env node
```

**Purpose:**

- Tells OS to execute with Node.js
- Required for `npx` and direct execution
- Must be first line (before imports)
- File must have executable permissions

**Making Executable:**

```bash
chmod +x packages/create-tool/dist/index.js
```

### NPM Workspace Integration

[Source: root package.json]

**Workspace Configuration:** Root `package.json` already includes `packages/*` in workspaces, so the
new CLI package will be automatically detected.

**Workspace Benefits:**

- Shared `node_modules` (reduces disk usage)
- Symlinked packages (no need to publish for local dev)
- Single `npm install` from root
- Cross-package dependencies work automatically

**Testing Workspace:**

```bash
# From root directory
npm install                    # Links all workspace packages
npm ls @nodeangularfullstack/create-tool  # Verify package linked

# Run CLI from workspace
npm run build --workspace=packages/create-tool
npx @nodeangularfullstack/create-tool --help
```

### CLI Entry Point Pattern

[Source: Commander.js docs + PRD]

**src/index.ts Structure:**

```typescript
#!/usr/bin/env node
import { Command } from 'commander';
import { version } from '../package.json';

const program = new Command();

program
  .name('create-tool')
  .version(version)
  .description('Scaffold new tools for NodeAngularFullStack platform')
  .usage('[options] <tool-name>')
  .helpOption('-h, --help', 'Display help for command')
  .action((toolName: string) => {
    console.log(`Creating tool: ${toolName}`);
    console.log('CLI framework is working!');
    // Actual implementation in Story 31.1.2
  });

program.parse(process.argv);
```

**Error Handling:**

```typescript
// Catch uncaught errors
process.on('uncaughtException', (error) => {
  console.error('Error:', error.message);
  process.exit(1);
});

process.on('unhandledRejection', (error) => {
  console.error('Error:', error);
  process.exit(1);
});
```

### Help Output Format

[Source: Commander.js conventions]

**Expected Help Output:**

```
Usage: create-tool [options] <tool-name>

Scaffold new tools for NodeAngularFullStack platform

Options:
  -V, --version  output the version number
  -h, --help     Display help for command

Examples:
  $ create-tool my-awesome-tool
  $ create-tool inventory-tracker
```

### File Permissions

[Source: Node.js CLI best practices]

**Why Permissions Matter:**

- CLI needs executable bit: `chmod +x`
- `npm install` sets permissions automatically if `bin` is configured
- Manual execution requires executable permissions
- `npx` handles permissions automatically

**Setting Permissions:**

```bash
# After building
chmod +x packages/create-tool/dist/index.js

# Verify
ls -la packages/create-tool/dist/index.js
# Should show: -rwxr-xr-x (note the 'x' bits)
```

### Dependencies on Previous Stories

**Epic 30 Complete (Tool Registry API):**

- CLI will eventually call tool registry API (Story 31.2.x)
- For now, CLI package is independent

**No Direct Dependencies:**

- This story is foundation work
- Future stories (31.1.2-31.1.4) depend on this

### JSDoc Documentation

[Source: architecture/coding-standards.md]

**CLI Entry Point Documentation:**

````typescript
/**
 * Create Tool CLI
 *
 * Command-line interface for scaffolding new tools in the NodeAngularFullStack platform.
 * Generates complete tool structure including frontend components, backend routes,
 * and automatic tool registration.
 *
 * @example
 * ```bash
 * npx @nodeangularfullstack/create-tool my-tool
 * npx @nodeangularfullstack/create-tool --help
 * ```
 *
 * @packageDocumentation
 */

/**
 * Main CLI program entry point.
 * Configures Commander.js and executes the create tool workflow.
 */
function main() {
  // Implementation
}
````

## Testing

### Manual Testing

**Test CLI Package Setup:**

```bash
# 1. Build CLI package
npm run build --workspace=packages/create-tool

# 2. Test help command
node packages/create-tool/dist/index.js --help

# Expected output:
# Usage: create-tool [options] <tool-name>
# ...

# 3. Test version command
node packages/create-tool/dist/index.js --version

# Expected output:
# 1.0.0

# 4. Test with npx (local package)
npx @nodeangularfullstack/create-tool --help

# 5. Test default action
node packages/create-tool/dist/index.js test-tool

# Expected output:
# Creating tool: test-tool
# CLI framework is working!
```

**Verify Workspace Integration:**

```bash
# From root directory
npm install                                # Link workspaces
npm ls @nodeangularfullstack/create-tool   # Should show package

# Build from root
npm run build --workspace=packages/create-tool

# Run from root
npm run dev --workspace=packages/create-tool -- --help
```

### Verification Checklist

After implementation:

- [ ] Package structure matches expected layout
- [ ] `package.json` has correct `bin` configuration
- [ ] TypeScript compiles without errors
- [ ] CLI executable has correct permissions
- [ ] `--help` displays usage information
- [ ] `--version` displays package version
- [ ] npx command works from any directory
- [ ] Workspace integration successful

### Known Issues & Solutions

**Issue: Permission denied when running CLI**

```bash
# Solution: Set executable permissions
chmod +x packages/create-tool/dist/index.js
```

**Issue: Module not found errors**

```bash
# Solution: Rebuild and reinstall workspace
npm run build --workspace=packages/create-tool
npm install
```

**Issue: npx doesn't find package**

```bash
# Solution: Use full workspace path or publish to npm
npx --package=./packages/create-tool create-tool
```

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-10-24 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent after story completion)
