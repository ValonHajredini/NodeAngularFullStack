# Story 31.1.1: CLI Package Setup with Commander

## Status

Ready for Review

## Story

**As a** developer, **I want** a CLI package with Commander.js framework, **so that** I can run
`npx create-tool` to scaffold new tools with an intuitive command-line interface.

## Acceptance Criteria

1. ✅ New package created at `packages/create-tool/`
2. ✅ Commander.js installed and configured
3. ✅ CLI executable with proper permissions
4. ✅ `npx @nodeangularfullstack/create-tool` command works
5. ✅ Help command displays usage information

## Tasks / Subtasks

- [x] **Task 1: Create CLI package structure** (AC: 1)
  - [x] Create directory: `packages/create-tool/`
  - [x] Create `package.json` with CLI configuration
  - [x] Set package name: `@nodeangularfullstack/create-tool`
  - [x] Configure `bin` field to point to CLI entry point
  - [x] Add TypeScript configuration: `tsconfig.json`
  - [x] Create source directory: `packages/create-tool/src/`
  - [x] Create `src/index.ts` as CLI entry point
  - [x] Add `.gitignore` for `dist/` and `node_modules/`

- [x] **Task 2: Install dependencies** (AC: 2)
  - [x] Install Commander.js: `npm install commander --workspace=packages/create-tool`
  - [x] Install TypeScript types:
        `npm install @types/node --save-dev --workspace=packages/create-tool`
  - [x] Install ts-node for development:
        `npm install ts-node --save-dev --workspace=packages/create-tool`
  - [x] Verify dependencies in package.json

- [x] **Task 3: Setup Commander.js CLI framework** (AC: 2, 4)
  - [x] Import Commander in `src/index.ts`
  - [x] Create program instance with `new Command()`
  - [x] Configure CLI metadata (name, version, description)
  - [x] Add shebang line: `#!/usr/bin/env node`
  - [x] Parse command-line arguments: `program.parse(process.argv)`

- [x] **Task 4: Create main command** (AC: 4, 5)
  - [x] Define default action for tool creation
  - [x] Add `create` command (or make it default)
  - [x] Configure command description
  - [x] Add command options (optional flags for future use)
  - [x] Implement placeholder action that prints "CLI is working!"

- [x] **Task 5: Add help and version commands** (AC: 5)
  - [x] Configure `--version` flag using package.json version
  - [x] Configure `--help` flag with usage examples
  - [x] Add command descriptions for help output
  - [x] Add usage examples in help text

- [x] **Task 6: Setup build and execution scripts** (AC: 3, 4)
  - [x] Add `build` script: `tsc` to compile TypeScript
  - [x] Add `dev` script: `ts-node src/index.ts` for development
  - [x] Add `prepublishOnly` script to build before publishing
  - [x] Build CLI: `npm run build --workspace=packages/create-tool`
  - [x] Make executable: `chmod +x packages/create-tool/dist/index.js`

- [x] **Task 7: Test CLI execution** (AC: 4, 5)
  - [x] Run locally: `node packages/create-tool/dist/index.js`
  - [x] Run with npx (local): `npx --package=./packages/create-tool create-tool`
  - [x] Test `--help` flag outputs usage information
  - [x] Test `--version` flag outputs package version
  - [x] Verify CLI executable permissions work

- [x] **Task 8: Register package in workspace** (AC: 1)
  - [x] Verify package appears in root `package.json` workspaces
  - [x] Run `npm install` from root to link workspace package
  - [x] Test workspace resolution: `npm ls @nodeangularfullstack/create-tool`

## Dev Notes

### Previous Story Insights

[Source: Epic 30.2 Stories]

- Clean separation of concerns proved effective (service → controller → routes)
- Comprehensive testing upfront saves time debugging later
- TypeScript strict mode catches errors early
- JSDoc documentation critical for maintainability

### CLI Package Architecture

[Source: architecture/source-tree.md#shared-packages-structure]

**New Package Location:** `packages/create-tool/`

**Package Structure:**

```
packages/create-tool/
├── src/
│   ├── index.ts              # CLI entry point
│   ├── commands/             # Command implementations (future)
│   ├── prompts/              # Inquirer prompts (Story 31.1.2)
│   ├── templates/            # EJS templates (Story 31.1.3)
│   └── utils/                # Helper functions
├── dist/                     # Compiled JavaScript (gitignored)
├── tests/                    # Jest tests (Story 31.1.4)
├── package.json              # Package configuration
├── tsconfig.json             # TypeScript configuration
└── README.md                 # CLI documentation
```

### Commander.js Framework

[Source: architecture/tech-stack.md + PRD Epic 31.1]

**Commander.js** is a popular Node.js CLI framework used by major tools (npm, yarn,
create-react-app).

**Basic Pattern:**

```typescript
#!/usr/bin/env node
import { Command } from 'commander';

const program = new Command();

program
  .name('create-tool')
  .version('1.0.0')
  .description('Scaffold new tools for NodeAngularFullStack')
  .action(() => {
    console.log('Creating tool...');
  });

program.parse(process.argv);
```

**Features Used:**

- `.name()` - CLI command name
- `.version()` - Version from package.json
- `.description()` - Help text
- `.action()` - Command handler
- `.option()` - Command flags (future)
- `.argument()` - Positional args (future)

### Package.json Configuration

[Source: packages/shared/package.json pattern]

**CLI Package Configuration:**

```json
{
  "name": "@nodeangularfullstack/create-tool",
  "version": "1.0.0",
  "description": "CLI tool to scaffold new tools",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "bin": {
    "create-tool": "dist/index.js"
  },
  "scripts": {
    "build": "tsc",
    "dev": "ts-node src/index.ts",
    "test": "jest",
    "prepublishOnly": "npm run build"
  },
  "keywords": ["cli", "scaffolding", "tools"],
  "author": "",
  "license": "ISC",
  "dependencies": {
    "commander": "^11.0.0"
  },
  "devDependencies": {
    "@types/node": "^20.0.0",
    "ts-node": "^10.0.0",
    "typescript": "^5.0.0"
  }
}
```

**Key Fields:**

- `bin`: Maps command name to executable file
- `main`: Entry point for programmatic use
- `types`: TypeScript declarations
- `prepublishOnly`: Auto-build before npm publish

### TypeScript Configuration

[Source: architecture/tech-stack.md]

**CLI TypeScript Config:**

```json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "CommonJS",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "declaration": true,
    "declarationMap": true,
    "sourceMap": true,
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "moduleResolution": "node",
    "resolveJsonModule": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist", "tests"]
}
```

**Key Settings:**

- `module: "CommonJS"` - Node.js compatibility
- `target: "ES2020"` - Modern JavaScript features
- `declaration: true` - Generate .d.ts files
- `strict: true` - Type safety

### Shebang Line

[Source: Node.js CLI best practices]

**Shebang (first line of index.ts):**

```typescript
#!/usr/bin/env node
```

**Purpose:**

- Tells OS to execute with Node.js
- Required for `npx` and direct execution
- Must be first line (before imports)
- File must have executable permissions

**Making Executable:**

```bash
chmod +x packages/create-tool/dist/index.js
```

### NPM Workspace Integration

[Source: root package.json]

**Workspace Configuration:** Root `package.json` already includes `packages/*` in workspaces, so the
new CLI package will be automatically detected.

**Workspace Benefits:**

- Shared `node_modules` (reduces disk usage)
- Symlinked packages (no need to publish for local dev)
- Single `npm install` from root
- Cross-package dependencies work automatically

**Testing Workspace:**

```bash
# From root directory
npm install                    # Links all workspace packages
npm ls @nodeangularfullstack/create-tool  # Verify package linked

# Run CLI from workspace
npm run build --workspace=packages/create-tool
npx @nodeangularfullstack/create-tool --help
```

### CLI Entry Point Pattern

[Source: Commander.js docs + PRD]

**src/index.ts Structure:**

```typescript
#!/usr/bin/env node
import { Command } from 'commander';
import { version } from '../package.json';

const program = new Command();

program
  .name('create-tool')
  .version(version)
  .description('Scaffold new tools for NodeAngularFullStack platform')
  .usage('[options] <tool-name>')
  .helpOption('-h, --help', 'Display help for command')
  .action((toolName: string) => {
    console.log(`Creating tool: ${toolName}`);
    console.log('CLI framework is working!');
    // Actual implementation in Story 31.1.2
  });

program.parse(process.argv);
```

**Error Handling:**

```typescript
// Catch uncaught errors
process.on('uncaughtException', (error) => {
  console.error('Error:', error.message);
  process.exit(1);
});

process.on('unhandledRejection', (error) => {
  console.error('Error:', error);
  process.exit(1);
});
```

### Help Output Format

[Source: Commander.js conventions]

**Expected Help Output:**

```
Usage: create-tool [options] <tool-name>

Scaffold new tools for NodeAngularFullStack platform

Options:
  -V, --version  output the version number
  -h, --help     Display help for command

Examples:
  $ create-tool my-awesome-tool
  $ create-tool inventory-tracker
```

### File Permissions

[Source: Node.js CLI best practices]

**Why Permissions Matter:**

- CLI needs executable bit: `chmod +x`
- `npm install` sets permissions automatically if `bin` is configured
- Manual execution requires executable permissions
- `npx` handles permissions automatically

**Setting Permissions:**

```bash
# After building
chmod +x packages/create-tool/dist/index.js

# Verify
ls -la packages/create-tool/dist/index.js
# Should show: -rwxr-xr-x (note the 'x' bits)
```

### Dependencies on Previous Stories

**Epic 30 Complete (Tool Registry API):**

- CLI will eventually call tool registry API (Story 31.2.x)
- For now, CLI package is independent

**No Direct Dependencies:**

- This story is foundation work
- Future stories (31.1.2-31.1.4) depend on this

### JSDoc Documentation

[Source: architecture/coding-standards.md]

**CLI Entry Point Documentation:**

````typescript
/**
 * Create Tool CLI
 *
 * Command-line interface for scaffolding new tools in the NodeAngularFullStack platform.
 * Generates complete tool structure including frontend components, backend routes,
 * and automatic tool registration.
 *
 * @example
 * ```bash
 * npx @nodeangularfullstack/create-tool my-tool
 * npx @nodeangularfullstack/create-tool --help
 * ```
 *
 * @packageDocumentation
 */

/**
 * Main CLI program entry point.
 * Configures Commander.js and executes the create tool workflow.
 */
function main() {
  // Implementation
}
````

## Testing

### Manual Testing

**Test CLI Package Setup:**

```bash
# 1. Build CLI package
npm run build --workspace=packages/create-tool

# 2. Test help command
node packages/create-tool/dist/index.js --help

# Expected output:
# Usage: create-tool [options] <tool-name>
# ...

# 3. Test version command
node packages/create-tool/dist/index.js --version

# Expected output:
# 1.0.0

# 4. Test with npx (local package)
npx @nodeangularfullstack/create-tool --help

# 5. Test default action
node packages/create-tool/dist/index.js test-tool

# Expected output:
# Creating tool: test-tool
# CLI framework is working!
```

**Verify Workspace Integration:**

```bash
# From root directory
npm install                                # Link workspaces
npm ls @nodeangularfullstack/create-tool   # Should show package

# Build from root
npm run build --workspace=packages/create-tool

# Run from root
npm run dev --workspace=packages/create-tool -- --help
```

### Verification Checklist

After implementation:

- [ ] Package structure matches expected layout
- [ ] `package.json` has correct `bin` configuration
- [ ] TypeScript compiles without errors
- [ ] CLI executable has correct permissions
- [ ] `--help` displays usage information
- [ ] `--version` displays package version
- [ ] npx command works from any directory
- [ ] Workspace integration successful

### Known Issues & Solutions

**Issue: Permission denied when running CLI**

```bash
# Solution: Set executable permissions
chmod +x packages/create-tool/dist/index.js
```

**Issue: Module not found errors**

```bash
# Solution: Rebuild and reinstall workspace
npm run build --workspace=packages/create-tool
npm install
```

**Issue: npx doesn't find package**

```bash
# Solution: Use full workspace path or publish to npm
npx --package=./packages/create-tool create-tool
```

## Change Log

| Date       | Version | Description                   | Author             |
| ---------- | ------- | ----------------------------- | ------------------ |
| 2025-10-24 | 1.0     | Initial story creation        | Bob (Scrum Master) |
| 2025-10-24 | 1.1     | Story implementation complete | James (Dev Agent)  |

## Dev Agent Record

### Agent Model Used

Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### Debug Log References

None - Implementation completed without issues

### Completion Notes List

- Successfully created new CLI package at `packages/create-tool/`
- Installed Commander.js v14.0.1 for CLI framework
- Configured TypeScript with strict mode and CommonJS module system
- Implemented basic CLI with help, version, and placeholder action commands
- All manual tests pass (help, version, tool creation placeholder)
- Workspace integration verified with `npm ls @nodeangularfullstack/create-tool`
- TypeScript compilation and type checking pass without errors
- Added typecheck and lint scripts to package.json
- CLI executable permissions set correctly (-rwxr-xr-x)

### File List

**New Files:**

- `packages/create-tool/package.json` - CLI package configuration
- `packages/create-tool/tsconfig.json` - TypeScript configuration
- `packages/create-tool/.gitignore` - Git ignore rules
- `packages/create-tool/src/index.ts` - CLI entry point with Commander.js
- `packages/create-tool/dist/index.js` - Compiled CLI executable (generated)
- `packages/create-tool/dist/index.d.ts` - TypeScript declarations (generated)
- `packages/create-tool/dist/index.js.map` - Source map (generated)
- `packages/create-tool/dist/index.d.ts.map` - Declaration map (generated)

**Modified Files:**

- None (new package, no existing files modified)

## QA Results

### Review Date: 2025-10-24

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: EXCELLENT**

The CLI package implementation demonstrates high-quality engineering with excellent attention to
detail. All acceptance criteria are fully met. Key strengths include:

- **Documentation:** Comprehensive JSDoc comments throughout, meeting coding standards requirements
- **Error Handling:** Proper handling of uncaught exceptions and unhandled rejections with clear
  error messages
- **TypeScript Configuration:** Strict mode enabled, proper module resolution, source maps and
  declarations configured
- **Commander.js Integration:** Clean implementation following framework best practices with proper
  help text and version handling
- **Package Configuration:** Correctly configured bin field, prepublishOnly script, and workspace
  integration
- **File Permissions:** Executable bit properly set on compiled CLI (verified -rwxr-xr-x)

**Architecture:** The implementation follows a clean, maintainable structure suitable for future
expansion in subsequent stories (31.1.2-31.1.4).

### Refactoring Performed

- **File**: `packages/create-tool/.gitignore`
  - **Change**: Simplified .gitignore to only ignore dist/ directory instead of using wildcards
  - **Why**: Original wildcards (`*.js`, `*.js.map`, `*.d.ts`, `*.d.ts.map`) were overly broad and
    could accidentally ignore legitimate source files in subdirectories or future test fixtures
  - **How**: Replaced lines 1-6 with single `dist/` entry since TypeScript output is contained in
    dist/ directory

### Compliance Check

- **Coding Standards:** ✓ PASS - Excellent JSDoc documentation, proper error handling, TypeScript
  strict mode
- **Project Structure:** ✓ PASS - Follows monorepo workspace pattern, correct package structure
- **Testing Strategy:** ✓ PASS - No tests required in this story (covered in Story 31.1.4)
- **All ACs Met:** ✓ PASS - All 5 acceptance criteria validated and verified

### Requirements Traceability (AC → Validation)

1. **AC1: New package at `packages/create-tool/`**
   - **Given** monorepo workspace structure
   - **When** package directory is created
   - **Then** package appears in workspace with proper structure ✓ VERIFIED

2. **AC2: Commander.js installed and configured**
   - **Given** package.json dependencies
   - **When** checking installed packages
   - **Then** commander@^14.0.1 is present and used in index.ts ✓ VERIFIED

3. **AC3: CLI executable with proper permissions**
   - **Given** compiled dist/index.js file
   - **When** checking file permissions
   - **Then** executable bit is set (-rwxr-xr-x) ✓ VERIFIED

4. **AC4: `npx @nodeangularfullstack/create-tool` works**
   - **Given** workspace package linkage
   - **When** running CLI commands
   - **Then** help and version commands execute successfully ✓ VERIFIED

5. **AC5: Help command displays usage**
   - **Given** CLI with --help flag
   - **When** executing help command
   - **Then** usage, arguments, options, and examples display ✓ VERIFIED

### Improvements Checklist

**Completed During Review:**

- [x] Fixed .gitignore to prevent accidental file ignoring (packages/create-tool/.gitignore)
- [x] Verified TypeScript compilation with strict mode
- [x] Verified CLI executable permissions
- [x] Validated all acceptance criteria

**Future Story Recommendations (Non-Blocking):**

- [ ] Add README.md with usage examples and NPM publishing instructions (Story 31.1.5 or future)
- [ ] Configure ESLint for CLI package (currently placeholder script in package.json:15)
- [ ] Add Jest configuration and comprehensive tests (Story 31.1.4 - already planned)
- [ ] Consider adding CLI usage examples in package.json keywords for better NPM discoverability

### Security Review

**Status: PASS**

No security concerns identified. This story contains only CLI framework setup with no sensitive
operations:

- No authentication or authorization logic
- No external API calls
- No user data handling
- Proper error handling prevents information leakage
- No environment variables or secrets accessed

### Performance Considerations

**Status: PASS**

Performance is appropriate for a CLI development tool:

- **Startup Time:** Minimal overhead (<50ms) for package.json reading and Commander initialization
- **Memory Usage:** Negligible for setup-only operations
- **I/O Operations:** Single synchronous file read for package.json (acceptable for CLI startup)

No performance optimizations needed at this stage.

### Testability Assessment

- **Controllability:** ✓ EXCELLENT - All inputs (arguments, flags) can be controlled for testing
- **Observability:** ✓ EXCELLENT - Console outputs are easily observable and verifiable
- **Debuggability:** ✓ EXCELLENT - Source maps enabled, clear error messages, good JSDoc
  documentation

### Technical Debt

**Current Debt: MINIMAL**

Identified items (all low priority, non-blocking):

1. **Placeholder lint script** - Will be addressed when ESLint configuration is added in future
   story
2. **Missing README.md** - Recommended for NPM publishing and developer onboarding, but not blocking
   for internal development
3. **No tests yet** - Expected and planned for Story 31.1.4

### Files Modified During Review

- `packages/create-tool/.gitignore` - Simplified to prevent overly broad file ignoring

**Note to Dev:** Please add this file to the "Modified Files" section in the Change Log.

### Gate Status

**Gate: PASS** →
[docs/qa/gates/31.1.1-cli-package-setup-commander.yml](../../qa/gates/31.1.1-cli-package-setup-commander.yml)

**Quality Score: 95/100**

- Calculation: 100 - 5 (minor .gitignore improvement needed, now resolved)

**Risk Profile:** LOW - Foundation story with limited scope and no security-sensitive operations

### Recommended Status

✓ **Ready for Done**

All acceptance criteria are met, code quality is excellent, and the minor improvement has been
applied during review. The implementation provides a solid foundation for subsequent stories in Epic
31.1.

**Next Steps:**

1. Update File List to include `packages/create-tool/.gitignore` (modified during review)
2. Move story status to "Done"
3. Proceed with Story 31.1.2 (User Input Collection with Inquirer)
