# Story 31.2.3: Backend Boilerplate Enhancement & Index Exports

## Status

Draft

## Story

**As a** developer, **I want** the CLI to automatically update backend index files and add generated
files to proper exports, **so that** new tool services, controllers, and repositories are
immediately importable throughout the application.

## Acceptance Criteria

1. ✅ Auto-update `apps/api/src/controllers/index.ts` with new controller export
2. ✅ Auto-update `apps/api/src/services/index.ts` with new service export
3. ✅ Auto-update `apps/api/src/repositories/index.ts` with new repository export
4. ✅ Auto-update `apps/api/src/validators/index.ts` with new validator export
5. ✅ Auto-update `apps/api/src/routes/index.ts` with new route registration
6. ✅ Auto-update `packages/shared/src/index.ts` with new type exports
7. ✅ Preserve existing imports and comments in index files
8. ✅ Generate Express route integration helper
9. ✅ Database migration helper file generated

## Tasks / Subtasks

- [ ] **Task 1: Create index file updater module** (AC: 1-7)
  - [ ] Create file: `packages/create-tool/src/utils/index-updater.ts`
  - [ ] Import Node.js fs/promises for file operations
  - [ ] Implement `readIndexFile(path)` to read existing content
  - [ ] Implement `parseImports(content)` to extract existing imports
  - [ ] Implement `addExport(content, exportLine)` to append new export
  - [ ] Implement `writeIndexFile(path, content)` to save updated file
  - [ ] Add JSDoc documentation

- [ ] **Task 2: Update controllers index** (AC: 1)
  - [ ] Read `apps/api/src/controllers/index.ts`
  - [ ] Parse existing exports
  - [ ] Add new export: `export { ${ClassName}Controller } from './${toolId}.controller';`
  - [ ] Preserve alphabetical ordering
  - [ ] Preserve file comments and blank lines
  - [ ] Write updated file

- [ ] **Task 3: Update services index** (AC: 2)
  - [ ] Read `apps/api/src/services/index.ts`
  - [ ] Add new export: `export { ${ClassName}Service } from './${toolId}.service';`
  - [ ] Maintain alphabetical order
  - [ ] Write updated file

- [ ] **Task 4: Update repositories index** (AC: 3)
  - [ ] Read `apps/api/src/repositories/index.ts`
  - [ ] Add new export: `export { ${ClassName}Repository } from './${toolId}.repository';`
  - [ ] Maintain alphabetical order
  - [ ] Write updated file

- [ ] **Task 5: Update validators index** (AC: 4)
  - [ ] Read `apps/api/src/validators/index.ts`
  - [ ] Add new exports:
    - [ ] `export { validate${ClassName}Create } from './${toolId}.validator';`
    - [ ] `export { validate${ClassName}Update } from './${toolId}.validator';`
  - [ ] Maintain alphabetical order
  - [ ] Write updated file

- [ ] **Task 6: Update routes index with registration** (AC: 5)
  - [ ] Read `apps/api/src/routes/index.ts`
  - [ ] Add import: `import ${toolId}Routes from './${toolId}.routes';`
  - [ ] Add route registration in setupRoutes function:
    - [ ] `app.use('${apiBase}', ${toolId}Routes);`
  - [ ] Preserve existing route order
  - [ ] Write updated file

- [ ] **Task 7: Update shared types index** (AC: 6)
  - [ ] Read `packages/shared/src/index.ts`
  - [ ] Add type exports:
    - [ ] `export type { ${ClassName}Record, Create${ClassName}Input, Update${ClassName}Input } from './types/${toolId}.types';`
  - [ ] Group with other type exports
  - [ ] Maintain alphabetical order
  - [ ] Write updated file

- [ ] **Task 8: Generate Express app integration helper** (AC: 8)
  - [ ] Create template: `templates/backend/app-integration.md.ejs`
  - [ ] Document how to register routes in Express app
  - [ ] Include code snippet for route registration
  - [ ] Include middleware order (auth, validation, controller)
  - [ ] Save as `apps/api/docs/${toolId}-integration.md`

- [ ] **Task 9: Generate database migration helper** (AC: 9)
  - [ ] Create template: `templates/backend/migration-template.sql.ejs`
  - [ ] Generate SQL migration file with:
    - [ ] CREATE TABLE statement
    - [ ] Column definitions (id, name, description, timestamps, created_by)
    - [ ] Indexes (id primary key, created_by foreign key)
    - [ ] Comments explaining each column
  - [ ] Save as `apps/api/database/migrations/draft_${toolId}_table.sql`
  - [ ] Add .draft suffix to prevent accidental migration

- [ ] **Task 10: Implement smart import insertion** (AC: 7)
  - [ ] Create function: `insertImportAlphabetically(content, newImport)`
  - [ ] Parse existing imports using regex
  - [ ] Find correct insertion point (alphabetical)
  - [ ] Insert new import line
  - [ ] Preserve blank lines between import groups
  - [ ] Return updated content

- [ ] **Task 11: Implement export insertion** (AC: 7)
  - [ ] Create function: `insertExportAlphabetically(content, newExport)`
  - [ ] Parse existing exports using regex
  - [ ] Find correct insertion point (alphabetical)
  - [ ] Insert new export line
  - [ ] Preserve file structure
  - [ ] Return updated content

- [ ] **Task 12: Update file generator to call index updaters** (AC: 1-7)
  - [ ] Import index updater functions in file-generator.ts
  - [ ] After file generation, call index updaters:
    - [ ] Update controllers/index.ts
    - [ ] Update services/index.ts
    - [ ] Update repositories/index.ts
    - [ ] Update validators/index.ts
    - [ ] Update routes/index.ts
    - [ ] Update shared/index.ts
  - [ ] Log each index update: "✓ Updated: apps/api/src/services/index.ts"
  - [ ] Handle errors gracefully (warn but don't fail generation)

- [ ] **Task 13: Generate post-generation checklist** (AC: 8, 9)
  - [ ] Print checklist after successful generation:
    - [ ] "✅ Generated files"
    - [ ] "✅ Updated index exports"
    - [ ] "⚠️ Manual steps required:"
    - [ ] "1. Review and rename draft migration:
          apps/api/database/migrations/draft\_${toolId}\_table.sql"
    - [ ] "2. Run migration: npm --workspace=apps/api run db:migrate"
    - [ ] "3. Restart API server: npm --workspace=apps/api run dev"
    - [ ] "4. Build shared types: npm run build:shared"

- [ ] **Task 14: Test index file updates** (AC: 1-7)
  - [ ] Generate sample tool
  - [ ] Verify controllers/index.ts updated with new export
  - [ ] Verify services/index.ts updated
  - [ ] Verify repositories/index.ts updated
  - [ ] Verify validators/index.ts updated
  - [ ] Verify routes/index.ts updated with route registration
  - [ ] Verify shared/index.ts updated with type exports
  - [ ] Verify alphabetical ordering maintained
  - [ ] Verify existing imports/exports preserved
  - [ ] Build backend: `npm run build --workspace=apps/api`
  - [ ] Verify no import errors

## Dev Notes

### Previous Story Insights

[Source: Story 31.2.1 & 31.2.2 Dev Agent Records]

- File generation orchestrator working correctly
- Directory structure properly created
- Templates render successfully
- Frontend components integrated with routing

### Index File Management Strategy

[Source: Node.js module patterns + TypeScript best practices]

**Why Index Files Matter:**

- Provide clean public API for modules
- Enable barrel exports: `import { ServiceA, ServiceB } from './services'`
- Reduce import statement complexity
- Make refactoring easier (change internal paths without breaking consumers)

**Current Index File Structure:**

```typescript
// apps/api/src/services/index.ts (example)
export { AuthService } from './auth.service';
export { UserService } from './user.service';
export { FormsService } from './forms.service';
// ... alphabetically ordered
```

**After Tool Generation:**

```typescript
// apps/api/src/services/index.ts
export { AuthService } from './auth.service';
export { FormsService } from './forms.service';
export { InventoryTrackerService } from './inventory-tracker.service'; // ← Added
export { UserService } from './user.service';
```

### File Parsing and Modification

[Source: TypeScript AST manipulation patterns]

**Import/Export Parsing Pattern:**

```typescript
/**
 * Parse export statements from index file content.
 * @param content - File content
 * @returns Array of export lines
 */
function parseExports(content: string): string[] {
  const exportRegex = /^export\s+\{[^}]+\}\s+from\s+['"][^'"]+['"];?/gm;
  return content.match(exportRegex) || [];
}

/**
 * Insert export line in alphabetical order.
 * @param content - Current file content
 * @param newExport - New export line to add
 * @returns Updated content
 */
function insertExportAlphabetically(content: string, newExport: string): string {
  const lines = content.split('\n');
  const exportLines = lines.filter((line) => line.trim().startsWith('export {'));

  // Find insertion point
  let insertIndex = lines.length;
  for (let i = 0; i < lines.length; i++) {
    if (lines[i].trim().startsWith('export {')) {
      if (newExport < lines[i]) {
        insertIndex = i;
        break;
      }
    }
  }

  lines.splice(insertIndex, 0, newExport);
  return lines.join('\n');
}
```

**Safer Approach - Append at End:**

```typescript
/**
 * Append export to end of file (simpler, safer).
 * @param content - Current file content
 * @param newExport - New export line
 * @returns Updated content
 */
function appendExport(content: string, newExport: string): string {
  // Ensure file ends with newline
  const trimmed = content.trimEnd();
  return `${trimmed}\n${newExport}\n`;
}
```

### Controllers Index Update

[Source: architecture/backend-architecture.md]

**Pattern:**

```typescript
// apps/api/src/controllers/index.ts
export { AuthController } from './auth.controller';
export { FormsController } from './forms.controller';
// ... existing exports

// After tool generation:
export { InventoryTrackerController } from './inventory-tracker.controller';
```

**Updater Implementation:**

```typescript
async function updateControllersIndex(toolId: string, className: string): Promise<void> {
  const indexPath = path.join(workspaceRoot, 'apps/api/src/controllers/index.ts');
  const content = await fs.readFile(indexPath, 'utf-8');

  const newExport = `export { ${className}Controller } from './${toolId}.controller';`;

  // Check if already exists
  if (content.includes(newExport)) {
    console.log('  ⊘ Controller export already exists');
    return;
  }

  const updated = appendExport(content, newExport);
  await fs.writeFile(indexPath, updated, 'utf-8');
  console.log('  ✓ Updated controllers/index.ts');
}
```

### Routes Index Update with Registration

[Source: architecture/backend-architecture.md + Express routing]

**Current Routes Index Pattern:**

```typescript
// apps/api/src/routes/index.ts
import { Express } from 'express';
import authRoutes from './auth.routes';
import userRoutes from './user.routes';
import formsRoutes from './forms.routes';

export function setupRoutes(app: Express): void {
  // Public routes
  app.use('/api/auth', authRoutes);

  // Protected routes
  app.use('/api/users', userRoutes);
  app.use('/api/forms', formsRoutes);
}
```

**After Tool Generation:**

```typescript
// apps/api/src/routes/index.ts
import { Express } from 'express';
import authRoutes from './auth.routes';
import userRoutes from './user.routes';
import formsRoutes from './forms.routes';
import inventoryTrackerRoutes from './inventory-tracker.routes'; // ← Added

export function setupRoutes(app: Express): void {
  // Public routes
  app.use('/api/auth', authRoutes);

  // Protected routes
  app.use('/api/users', userRoutes);
  app.use('/api/forms', formsRoutes);
  app.use('/api/tools/inventory-tracker', inventoryTrackerRoutes); // ← Added
}
```

**Updater Implementation:**

```typescript
async function updateRoutesIndex(toolId: string, apiBase: string): Promise<void> {
  const indexPath = path.join(workspaceRoot, 'apps/api/src/routes/index.ts');
  const content = await fs.readFile(indexPath, 'utf-8');

  const camelCaseName = toCamelCase(toolId);
  const newImport = `import ${camelCaseName}Routes from './${toolId}.routes';`;
  const newRoute = `  app.use('${apiBase}', ${camelCaseName}Routes);`;

  // Add import
  let updated = insertImportAlphabetically(content, newImport);

  // Add route registration inside setupRoutes function
  const setupFunctionRegex = /export function setupRoutes\(app: Express\): void \{([^}]*)\}/s;
  updated = updated.replace(setupFunctionRegex, (match, body) => {
    return match.replace(body, `${body}\n${newRoute}\n`);
  });

  await fs.writeFile(indexPath, updated, 'utf-8');
  console.log('  ✓ Updated routes/index.ts with route registration');
}
```

### Shared Types Index Update

[Source: packages/shared/src/index.ts pattern]

**Current Shared Index:**

```typescript
// packages/shared/src/index.ts
// Form types
export type { FormSchema, FormField, FieldPosition } from './types/forms.types';
export type { FormTheme, ThemeProperties } from './types/theme.types';

// Auth types
export type { User, UserRole } from './types/auth.types';

// Tool registry types
export type { ToolRegistryRecord, CreateToolInput } from './types/tool-registry.types';
```

**After Tool Generation:**

```typescript
// packages/shared/src/index.ts
// ... existing exports

// Tool types
export type {
  InventoryTrackerRecord,
  CreateInventoryTrackerInput,
  UpdateInventoryTrackerInput,
} from './types/inventory-tracker.types';
```

**Updater Implementation:**

```typescript
async function updateSharedIndex(toolId: string, className: string): Promise<void> {
  const indexPath = path.join(workspaceRoot, 'packages/shared/src/index.ts');
  const content = await fs.readFile(indexPath, 'utf-8');

  const newExport = `export type { ${className}Record, Create${className}Input, Update${className}Input } from './types/${toolId}.types';`;

  const updated = appendExport(content, newExport);
  await fs.writeFile(indexPath, updated, 'utf-8');
  console.log('  ✓ Updated packages/shared/src/index.ts');
}
```

### Database Migration Template

[Source: architecture/database-schema.md + existing migrations]

**Migration Template Pattern:**

```sql
-- Migration: <%= toolId %> table
-- Description: Create table for <%= toolName %> tool
-- Date: <%= new Date().toISOString().split('T')[0] %>
--
-- DRAFT: This is a template migration. Review and customize before running.
-- To use: Remove .draft suffix and run: npm --workspace=apps/api run db:migrate

CREATE TABLE IF NOT EXISTS <%= tableName %> (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),

  -- Core fields
  name VARCHAR(255) NOT NULL,
  description TEXT,

  -- Metadata
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_by UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,

  -- Indexes for common queries
  CONSTRAINT <%= tableName %>_name_length CHECK (char_length(name) >= 3)
);

-- Indexes
CREATE INDEX idx_<%= tableName %>_created_by ON <%= tableName %>(created_by);
CREATE INDEX idx_<%= tableName %>_created_at ON <%= tableName %>(created_at DESC);

-- Updated timestamp trigger
CREATE TRIGGER update_<%= tableName %>_updated_at
  BEFORE UPDATE ON <%= tableName %>
  FOR EACH ROW
  EXECUTE FUNCTION update_updated_at_column();

-- Comments
COMMENT ON TABLE <%= tableName %> IS '<%= toolName %> data table';
COMMENT ON COLUMN <%= tableName %>.id IS 'Unique identifier (UUID)';
COMMENT ON COLUMN <%= tableName %>.name IS '<%= toolName %> name (3-255 chars)';
COMMENT ON COLUMN <%= tableName %>.description IS 'Optional description';
COMMENT ON COLUMN <%= tableName %>.created_by IS 'User who created this record';
```

**File Naming:**

```typescript
// Generate with .draft suffix
const timestamp = Date.now();
const fileName = `${timestamp}_${toolId}_table.sql.draft`;
const filePath = path.join(workspaceRoot, 'apps/api/database/migrations', fileName);
```

### Express App Integration Helper

[Source: architecture/backend-architecture.md]

**Integration Guide Template:**

````markdown
# <%= toolName %> API Integration

## Route Registration

The <%= toolName %> routes are automatically registered in the Express app.

**File:** `apps/api/src/routes/index.ts`

```typescript
import <%= camelCaseName %>Routes from './<%= toolId %>.routes';

export function setupRoutes(app: Express): void {
  // ...
  app.use('<%= apiBase %>', <%= camelCaseName %>Routes);
}
```
````

## Middleware Stack

Each request flows through:

1. **CORS** - Allow cross-origin requests
2. **Body Parser** - Parse JSON request bodies
3. **Auth Middleware** - Verify JWT token
4. **Validation Middleware** - Validate request data
5. **Controller** - Execute business logic
6. **Error Handler** - Catch and format errors

## API Endpoints

| Method | Endpoint             | Description                     | Auth Required |
| ------ | -------------------- | ------------------------------- | ------------- |
| GET    | `<%= apiBase %>`     | Get all <%= toolName %> records | ✅ Yes        |
| GET    | `<%= apiBase %>/:id` | Get <%= toolName %> by ID       | ✅ Yes        |
| POST   | `<%= apiBase %>`     | Create new <%= toolName %>      | ✅ Yes        |
| PUT    | `<%= apiBase %>/:id` | Update <%= toolName %>          | ✅ Yes        |
| DELETE | `<%= apiBase %>/:id` | Delete <%= toolName %>          | ✅ Yes        |

## Testing

```bash
# Get auth token
TOKEN=$(curl -s -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@example.com","password":"Admin123!@#"}' \
  | jq -r '.accessToken')

# Test GET all
curl -X GET http://localhost:3000<%= apiBase %> \
  -H "Authorization: Bearer $TOKEN"

# Test POST create
curl -X POST http://localhost:3000<%= apiBase %> \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Test Item",
    "description": "Test description"
  }'
```

````

### Error Handling Strategy

[Source: architecture/error-handling-strategy.md]

**Safe Index Updates:**
```typescript
async function updateAllIndexFiles(metadata: ToolMetadata): Promise<void> {
  const errors: string[] = [];

  try {
    await updateControllersIndex(metadata.toolId, metadata.className);
  } catch (error) {
    errors.push(`Controllers index: ${error.message}`);
    console.warn('  ⚠️  Failed to update controllers/index.ts');
  }

  try {
    await updateServicesIndex(metadata.toolId, metadata.className);
  } catch (error) {
    errors.push(`Services index: ${error.message}`);
    console.warn('  ⚠️  Failed to update services/index.ts');
  }

  // ... continue for all index files

  if (errors.length > 0) {
    console.log('\n⚠️  Some index files could not be updated automatically:');
    errors.forEach(err => console.log(`  - ${err}`));
    console.log('\nPlease update these files manually.');
  }
}
````

### Dependencies on Previous Stories

**Story 31.2.1 Required:**

- File generation orchestrator exists
- Directory structure created
- File writer utilities available

**Story 31.2.2 Required:**

- Frontend components generated
- Route configuration created

**Story 31.1.3 Required:**

- Templates exist for all backend files

### JSDoc Documentation

[Source: architecture/coding-standards.md]

**Module Documentation:**

````typescript
/**
 * Index File Updater
 *
 * Utilities for updating index.ts files with new exports.
 * Automatically adds new tool exports to backend and shared package index files.
 *
 * Features:
 * - Alphabetical export insertion
 * - Preserve existing imports and comments
 * - Safe error handling (warns but doesn't fail)
 * - Route registration in Express app
 *
 * @module utils/index-updater
 * @example
 * ```typescript
 * import { updateControllersIndex } from './utils/index-updater';
 *
 * await updateControllersIndex('inventory-tracker', 'InventoryTracker');
 * // Updates apps/api/src/controllers/index.ts with new export
 * ```
 */
````

## Testing

### Manual Testing

**Test Index File Updates:**

```bash
# 1. Generate sample tool
node packages/create-tool/dist/index.js test-backend-tool

# 2. Verify index files updated
echo "=== Controllers Index ==="
grep "test-backend-tool" apps/api/src/controllers/index.ts

echo "=== Services Index ==="
grep "test-backend-tool" apps/api/src/services/index.ts

echo "=== Repositories Index ==="
grep "test-backend-tool" apps/api/src/repositories/index.ts

echo "=== Validators Index ==="
grep "test-backend-tool" apps/api/src/validators/index.ts

echo "=== Routes Index ==="
grep "test-backend-tool" apps/api/src/routes/index.ts

echo "=== Shared Types Index ==="
grep "test-backend-tool" packages/shared/src/index.ts

# 3. Verify alphabetical ordering maintained
cat apps/api/src/services/index.ts | grep "export {" | sort -c
# Should not error if properly sorted

# 4. Build backend (verify no import errors)
npm run build --workspace=apps/api

# 5. Build shared types
npm run build:shared

# 6. Import in TypeScript (verify exports work)
cat > /tmp/test-imports.ts << 'EOF'
import { TestBackendToolService } from './apps/api/src/services';
import { TestBackendToolRecord } from '@nodeangularfullstack/shared';
EOF
npx tsc --noEmit /tmp/test-imports.ts

# 7. Verify migration file created
ls -la apps/api/database/migrations/*test-backend-tool*.draft

# 8. Clean up
rm apps/api/src/controllers/test-backend-tool.*
rm apps/api/src/services/test-backend-tool.*
# ... etc
```

### Verification Checklist

After implementation:

- [ ] Index updater module created
- [ ] All 6 index files updated correctly
- [ ] Alphabetical ordering preserved
- [ ] Existing imports/exports preserved
- [ ] Comments and blank lines preserved
- [ ] Route registration added to routes/index.ts
- [ ] Migration template generated with .draft suffix
- [ ] Integration guide generated
- [ ] Backend builds without errors
- [ ] Shared types build without errors
- [ ] New exports can be imported

### Known Issues & Solutions

**Issue: Index file has different format**

```typescript
// Solution: Detect format and use appropriate pattern
const isSingleLineExport = /export \{ .+ \} from/;
const isMultiLineExport = /export \{[\s\S]+?\} from/;
```

**Issue: Duplicate exports added**

```typescript
// Solution: Check if export already exists
if (content.includes(newExport)) {
  console.log('  ⊘ Export already exists, skipping');
  return;
}
```

**Issue: Routes function has different signature**

```typescript
// Solution: Use flexible regex to find function body
const setupFunctionRegex = /export function setupRoutes\([^)]+\)[^{]*\{/;
```

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-10-24 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent after story completion)
