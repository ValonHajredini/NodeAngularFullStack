# Story 31.2.4: Tool Registration API Integration

## Status

Approved

## Story

**As a** developer, **I want** the CLI to automatically register generated tools with the Tool
Registry API, **so that** new tools are immediately discoverable in the platform without manual
registration.

## Acceptance Criteria

1. ✅ HTTP client module for API calls (axios or native fetch)
2. ✅ Tool registration API call after successful file generation
3. ✅ Automatic JWT token acquisition (admin credentials from env)
4. ✅ Retry logic with exponential backoff for network errors
5. ✅ Tool manifest JSON generation from metadata
6. ✅ Success/failure feedback with registration details
7. ✅ `--skip-registration` flag to disable auto-registration
8. ✅ Registration status saved to local cache

## Tasks / Subtasks

- [ ] **Task 1: Install HTTP client** (AC: 1)
  - [ ] Install axios: `npm install axios --workspace=packages/create-tool`
  - [ ] Install TypeScript types:
        `npm install @types/axios --save-dev --workspace=packages/create-tool`
  - [ ] Verify version ≥1.6.0
  - [ ] Update package.json dependencies

- [ ] **Task 2: Create API client module** (AC: 1, 4)
  - [ ] Create file: `packages/create-tool/src/api/registry-client.ts`
  - [ ] Import axios for HTTP requests
  - [ ] Implement `RegistryApiClient` class
  - [ ] Configure base URL from environment or default
  - [ ] Add retry logic with axios-retry or custom implementation
  - [ ] Add timeout configuration (30s default)
  - [ ] Add JSDoc documentation

- [ ] **Task 3: Implement authentication** (AC: 3)
  - [ ] Create method: `authenticate(): Promise<string>`
  - [ ] Read admin credentials from environment variables:
    - [ ] `API_ADMIN_EMAIL` or default to 'admin@example.com'
    - [ ] `API_ADMIN_PASSWORD` or prompt user
  - [ ] POST to `/api/auth/login` with credentials
  - [ ] Extract JWT token from response
  - [ ] Cache token for subsequent requests
  - [ ] Return access token

- [ ] **Task 4: Generate tool manifest JSON** (AC: 5)
  - [ ] Create function: `generateManifest(metadata): ToolManifest`
  - [ ] Build manifest object:
    - [ ] `id`: Tool ID
    - [ ] `name`: Tool name
    - [ ] `version`: "1.0.0"
    - [ ] `description`: Tool description
    - [ ] `icon`: PrimeNG icon name
    - [ ] `permissions`: Required permissions array
    - [ ] `features`: Selected features object
    - [ ] `routes`: Frontend and API routes
  - [ ] Return manifest JSON

- [ ] **Task 5: Implement tool registration** (AC: 2, 5)
  - [ ] Create method: `registerTool(metadata): Promise<RegistrationResult>`
  - [ ] Get authentication token
  - [ ] Generate tool manifest
  - [ ] Build registration payload matching API spec:
    - [ ] `toolId`: Kebab-case ID
    - [ ] `name`: Display name
    - [ ] `version`: "1.0.0"
    - [ ] `route`: Frontend route path
    - [ ] `apiBase`: Backend API base path
    - [ ] `permissions`: Permissions array
    - [ ] `manifestJson`: Tool manifest object
    - [ ] `createdBy`: Admin user ID (from JWT)
  - [ ] POST to `/api/tools/register`
  - [ ] Return registration result with tool ID

- [ ] **Task 6: Implement retry logic** (AC: 4)
  - [ ] Add axios interceptor for retry
  - [ ] Configure retry attempts: 3 max
  - [ ] Exponential backoff: 1s, 2s, 4s
  - [ ] Retry on network errors (ECONNREFUSED, ETIMEDOUT)
  - [ ] Retry on 5xx server errors
  - [ ] Do NOT retry on 4xx client errors
  - [ ] Log each retry attempt

- [ ] **Task 7: Handle API errors** (AC: 6)
  - [ ] Catch authentication errors (401, 403)
  - [ ] Catch validation errors (400) with field details
  - [ ] Catch duplicate tool errors (409 or 400)
  - [ ] Catch server errors (500, 503)
  - [ ] Format error messages for CLI output
  - [ ] Provide actionable error messages

- [ ] **Task 8: Integrate with file generator** (AC: 2, 7)
  - [ ] Import registry client in file-generator.ts
  - [ ] After successful file generation, attempt registration
  - [ ] Check `--skip-registration` flag
  - [ ] If flag set, skip registration and log message
  - [ ] If flag not set, call `registerTool(metadata)`
  - [ ] Handle registration success/failure
  - [ ] Continue CLI execution regardless of registration outcome

- [ ] **Task 9: Implement local registration cache** (AC: 8)
  - [ ] Create file: `packages/create-tool/src/utils/registration-cache.ts`
  - [ ] Cache file location: `~/.create-tool/registrations.json`
  - [ ] Implement `saveRegistration(toolId, status, details)`
  - [ ] Implement `getRegistration(toolId)`
  - [ ] Store: tool ID, registration status, timestamp, API response
  - [ ] Used for debugging and `--list` command

- [ ] **Task 10: Add CLI flags** (AC: 7)
  - [ ] Add option in Commander.js: `--skip-registration`
  - [ ] Add option: `--api-url <url>` to override API base URL
  - [ ] Add option: `--admin-email <email>` for authentication
  - [ ] Pass options to file generator
  - [ ] Document flags in `--help` output

- [ ] **Task 11: Print registration feedback** (AC: 6)
  - [ ] On registration success:
    - [ ] "✅ Tool registered with platform"
    - [ ] " Tool ID: {toolId}"
    - [ ] " Version: 1.0.0"
    - [ ] " API: {apiBase}"
  - [ ] On registration failure:
    - [ ] "⚠️ Tool generation successful, but registration failed"
    - [ ] " Error: {error message}"
    - [ ] " You can manually register later:"
    - [ ] " curl -X POST {url} ..."
  - [ ] On skip:
    - [ ] "⊘ Tool registration skipped (--skip-registration)"
    - [ ] " Register manually: POST /api/tools/register"

- [ ] **Task 12: Add environment variable support** (AC: 3)
  - [ ] Read from `.env` file if exists
  - [ ] Support variables:
    - [ ] `CREATE_TOOL_API_URL` - API base URL
    - [ ] `CREATE_TOOL_ADMIN_EMAIL` - Admin email
    - [ ] `CREATE_TOOL_ADMIN_PASSWORD` - Admin password (optional)
  - [ ] Fall back to defaults if not set
  - [ ] Document in CLI README

- [ ] **Task 13: Test API integration** (AC: 1-8)
  - [ ] Start backend API: `npm --workspace=apps/api run dev`
  - [ ] Ensure admin user exists in database
  - [ ] Generate tool with registration: `node packages/create-tool/dist/index.js test-api-tool`
  - [ ] Verify authentication successful
  - [ ] Verify tool registered in database:
    ```bash
    psql -d nodeangularfullstack -c "SELECT * FROM tool_registry WHERE tool_id = 'test-api-tool';"
    ```
  - [ ] Test with invalid credentials (should fail gracefully)
  - [ ] Test with API down (should retry and fail gracefully)
  - [ ] Test with `--skip-registration` flag
  - [ ] Verify registration cache created: `cat ~/.create-tool/registrations.json`

## Dev Notes

### Previous Story Insights

[Source: Story 31.2.3 Dev Agent Record]

- Index files automatically updated
- File generation orchestrator robust
- Backend boilerplate fully generated
- Migration helper created

### Tool Registry API Specification

[Source: Story 30.2.2 REST API Endpoints]

**Registration Endpoint:**

```
POST /api/tools/register
Content-Type: application/json
Authorization: Bearer {JWT_TOKEN}

Request Body:
{
  "toolId": "inventory-tracker",
  "name": "Inventory Tracker",
  "version": "1.0.0",
  "description": "Track inventory items",
  "route": "/tools/inventory-tracker",
  "apiBase": "/api/tools/inventory-tracker",
  "permissions": ["user"],
  "status": "alpha",
  "manifestJson": {
    "id": "inventory-tracker",
    "name": "Inventory Tracker",
    "version": "1.0.0",
    "description": "Track inventory items",
    "icon": "pi-box",
    "features": ["backend", "database", "service", "component"],
    "routes": {
      "frontend": "/tools/inventory-tracker",
      "api": "/api/tools/inventory-tracker"
    }
  }
}

Success Response (201):
{
  "message": "Tool registered successfully",
  "data": {
    "id": "uuid",
    "toolId": "inventory-tracker",
    "name": "Inventory Tracker",
    "version": "1.0.0",
    "createdAt": "2025-10-24T...",
    ...
  }
}

Error Response (400):
{
  "error": "Validation failed",
  "details": [
    {
      "field": "toolId",
      "message": "Tool ID must be kebab-case"
    }
  ]
}
```

### Axios HTTP Client Configuration

[Source: axios documentation + best practices]

**Client Setup:**

```typescript
import axios, { AxiosInstance, AxiosError } from 'axios';

export class RegistryApiClient {
  private client: AxiosInstance;
  private token: string | null = null;

  constructor(private baseURL: string = 'http://localhost:3000') {
    this.client = axios.create({
      baseURL,
      timeout: 30000, // 30 seconds
      headers: {
        'Content-Type': 'application/json',
      },
    });

    // Add retry interceptor
    this.setupRetryInterceptor();
  }

  /**
   * Setup retry logic for network errors.
   */
  private setupRetryInterceptor(): void {
    this.client.interceptors.response.use(
      (response) => response,
      async (error: AxiosError) => {
        const config = error.config as any;

        // Initialize retry count
        config.retryCount = config.retryCount || 0;

        // Only retry on network errors or 5xx errors
        const shouldRetry =
          !error.response || // Network error
          error.response.status >= 500; // Server error

        if (shouldRetry && config.retryCount < 3) {
          config.retryCount++;

          // Exponential backoff: 1s, 2s, 4s
          const delay = Math.pow(2, config.retryCount - 1) * 1000;
          console.log(`  ⟲ Retry ${config.retryCount}/3 in ${delay}ms...`);

          await new Promise((resolve) => setTimeout(resolve, delay));
          return this.client(config);
        }

        throw error;
      }
    );
  }
}
```

### Authentication Flow

[Source: Story 30.2.2 + JWT auth patterns]

**Login Implementation:**

```typescript
/**
 * Authenticate with admin credentials and get JWT token.
 * @returns Promise containing access token
 * @throws {Error} When authentication fails
 */
async authenticate(
  email?: string,
  password?: string
): Promise<string> {
  // Use provided credentials or environment variables
  const adminEmail = email || process.env.CREATE_TOOL_ADMIN_EMAIL || 'admin@example.com';
  const adminPassword = password || process.env.CREATE_TOOL_ADMIN_PASSWORD;

  // If no password provided, prompt user
  if (!adminPassword) {
    throw new Error(
      'Admin password not provided. Set CREATE_TOOL_ADMIN_PASSWORD environment variable or use --admin-password flag'
    );
  }

  try {
    const response = await this.client.post('/api/auth/login', {
      email: adminEmail,
      password: adminPassword,
    });

    this.token = response.data.accessToken;
    return this.token;
  } catch (error) {
    if (axios.isAxiosError(error)) {
      if (error.response?.status === 401) {
        throw new Error('Authentication failed: Invalid credentials');
      }
      if (error.response?.status === 403) {
        throw new Error('Authentication failed: Account locked or disabled');
      }
    }
    throw new Error(`Authentication failed: ${error.message}`);
  }
}
```

### Tool Manifest Generation

[Source: Story 31.1.2 metadata + Tool Registry types]

**Manifest Builder:**

```typescript
interface ToolManifest {
  id: string;
  name: string;
  version: string;
  description: string;
  icon: string;
  features: string[];
  routes: {
    frontend: string;
    api: string;
  };
  permissions: string[];
}

/**
 * Generate tool manifest JSON from CLI metadata.
 * @param metadata - Tool metadata from prompts
 * @returns Tool manifest object
 */
function generateManifest(metadata: ToolMetadata): ToolManifest {
  return {
    id: metadata.toolId,
    name: metadata.toolName,
    version: metadata.version || '1.0.0',
    description: metadata.description || '',
    icon: metadata.icon,
    features: Object.keys(metadata.features).filter((key) => metadata.features[key]),
    routes: {
      frontend: metadata.route,
      api: metadata.apiBase,
    },
    permissions: metadata.permissions,
  };
}
```

### Registration API Call

[Source: Tool Registry API spec]

**Registration Implementation:**

```typescript
/**
 * Register tool with platform.
 * @param metadata - Tool metadata
 * @returns Promise containing registration result
 */
async registerTool(metadata: ToolMetadata): Promise<RegistrationResult> {
  // Ensure authenticated
  if (!this.token) {
    await this.authenticate();
  }

  const manifest = generateManifest(metadata);

  const payload = {
    toolId: metadata.toolId,
    name: metadata.toolName,
    version: '1.0.0',
    description: metadata.description,
    route: metadata.route,
    apiBase: metadata.apiBase,
    permissions: metadata.permissions,
    status: 'alpha', // New tools start in alpha
    manifestJson: manifest,
  };

  try {
    const response = await this.client.post('/api/tools/register', payload, {
      headers: {
        Authorization: `Bearer ${this.token}`,
      },
    });

    return {
      success: true,
      toolId: response.data.data.toolId,
      registeredAt: response.data.data.createdAt,
      message: response.data.message,
    };
  } catch (error) {
    if (axios.isAxiosError(error)) {
      if (error.response?.status === 400) {
        const details = error.response.data.details || [];
        const fieldErrors = details.map((d: any) => `${d.field}: ${d.message}`).join(', ');
        throw new Error(`Validation failed: ${fieldErrors}`);
      }
      if (error.response?.status === 409) {
        throw new Error(`Tool '${metadata.toolId}' already registered`);
      }
    }
    throw new Error(`Registration failed: ${error.message}`);
  }
}
```

### Local Registration Cache

[Source: CLI best practices + Node.js fs]

**Cache Implementation:**

```typescript
// packages/create-tool/src/utils/registration-cache.ts
import fs from 'fs/promises';
import path from 'path';
import os from 'os';

interface RegistrationRecord {
  toolId: string;
  status: 'success' | 'failed' | 'skipped';
  timestamp: string;
  details?: any;
  error?: string;
}

/**
 * Get cache file path in user's home directory.
 */
function getCachePath(): string {
  const homeDir = os.homedir();
  const cacheDir = path.join(homeDir, '.create-tool');
  return path.join(cacheDir, 'registrations.json');
}

/**
 * Save registration result to cache.
 */
export async function saveRegistration(
  toolId: string,
  status: 'success' | 'failed' | 'skipped',
  details?: any,
  error?: string
): Promise<void> {
  const cachePath = getCachePath();
  const cacheDir = path.dirname(cachePath);

  // Ensure cache directory exists
  await fs.mkdir(cacheDir, { recursive: true });

  // Read existing cache
  let cache: Record<string, RegistrationRecord> = {};
  try {
    const content = await fs.readFile(cachePath, 'utf-8');
    cache = JSON.parse(content);
  } catch {
    // Cache doesn't exist yet, use empty object
  }

  // Add new entry
  cache[toolId] = {
    toolId,
    status,
    timestamp: new Date().toISOString(),
    details,
    error,
  };

  // Write cache
  await fs.writeFile(cachePath, JSON.stringify(cache, null, 2), 'utf-8');
}

/**
 * Get registration record from cache.
 */
export async function getRegistration(toolId: string): Promise<RegistrationRecord | null> {
  try {
    const cachePath = getCachePath();
    const content = await fs.readFile(cachePath, 'utf-8');
    const cache = JSON.parse(content);
    return cache[toolId] || null;
  } catch {
    return null;
  }
}
```

### CLI Integration

[Source: Story 31.2.1 file generator]

**Updated File Generator:**

```typescript
// In src/generator/file-generator.ts
import { RegistryApiClient } from '../api/registry-client';
import { saveRegistration } from '../utils/registration-cache';

export async function generateToolFiles(
  metadata: ToolMetadata,
  options: GenerationOptions = {}
): Promise<GenerationResult> {
  const result = /* ... file generation ... */;

  // After successful file generation
  if (result.success && !options.skipRegistration) {
    console.log('\n📡 Registering tool with platform...');

    try {
      const apiClient = new RegistryApiClient(options.apiUrl);
      const registrationResult = await apiClient.registerTool(metadata);

      console.log(chalk.green('✅ Tool registered with platform'));
      console.log(chalk.gray(`   Tool ID: ${registrationResult.toolId}`));
      console.log(chalk.gray(`   Version: 1.0.0`));
      console.log(chalk.gray(`   API: ${metadata.apiBase}`));

      await saveRegistration(metadata.toolId, 'success', registrationResult);
    } catch (error) {
      console.log(chalk.yellow('\n⚠️  Tool generation successful, but registration failed'));
      console.log(chalk.gray(`   Error: ${error.message}`));
      console.log(chalk.gray('\n   You can manually register later:'));
      console.log(chalk.gray(`   curl -X POST http://localhost:3000/api/tools/register \\ `));
      console.log(chalk.gray(`     -H "Authorization: Bearer YOUR_TOKEN" \\ `));
      console.log(chalk.gray(`     -d '{"toolId":"${metadata.toolId}", ...}'`));

      await saveRegistration(metadata.toolId, 'failed', null, error.message);

      // Don't fail the entire generation on registration error
      console.log(chalk.blue('\n✅ Files generated successfully (registration can be done later)'));
    }
  } else if (options.skipRegistration) {
    console.log(chalk.gray('\n⊘ Tool registration skipped (--skip-registration)'));
    console.log(chalk.gray('   Register manually: POST /api/tools/register'));
    await saveRegistration(metadata.toolId, 'skipped');
  }

  return result;
}
```

### Environment Variables

[Source: Node.js environment patterns]

**Environment Configuration:**

```bash
# .env (project root)
CREATE_TOOL_API_URL=http://localhost:3000
CREATE_TOOL_ADMIN_EMAIL=admin@example.com
CREATE_TOOL_ADMIN_PASSWORD=Admin123!@#
```

**Loading Environment:**

```typescript
// Load .env file if exists
import dotenv from 'dotenv';
dotenv.config();

// Access in code
const apiUrl = process.env.CREATE_TOOL_API_URL || 'http://localhost:3000';
const adminEmail = process.env.CREATE_TOOL_ADMIN_EMAIL || 'admin@example.com';
```

### Error Handling Strategy

[Source: architecture/error-handling-strategy.md]

**Graceful Error Handling:**

```typescript
try {
  await apiClient.registerTool(metadata);
} catch (error) {
  // Log error but don't fail the entire CLI
  console.error('Registration failed:', error.message);

  // Provide helpful next steps
  if (error.message.includes('ECONNREFUSED')) {
    console.log('\nTroubleshooting:');
    console.log('1. Ensure API server is running: npm --workspace=apps/api run dev');
    console.log('2. Check API_URL is correct: ' + apiUrl);
  }

  if (error.message.includes('Invalid credentials')) {
    console.log('\nTroubleshooting:');
    console.log('1. Check admin credentials in .env file');
    console.log('2. Verify admin user exists in database');
  }

  // Save failure to cache for debugging
  await saveRegistration(toolId, 'failed', null, error.message);
}
```

### Dependencies on Previous Stories

**Story 31.2.1-31.2.3 Required:**

- File generation complete
- Backend files created
- Index files updated

**Story 31.1.2 Required:**

- Tool metadata structure defined
- Validation utilities available

**Epic 30.2 Required:**

- Tool Registry API endpoints exist (`/api/tools/register`)
- Authentication API available (`/api/auth/login`)
- Database schema for tool_registry table

### JSDoc Documentation

[Source: architecture/coding-standards.md]

**Module Documentation:**

````typescript
/**
 * Tool Registry API Client
 *
 * HTTP client for communicating with Tool Registry API.
 * Handles authentication, registration, and error handling.
 *
 * Features:
 * - JWT authentication with admin credentials
 * - Retry logic with exponential backoff
 * - Tool registration via POST /api/tools/register
 * - Registration caching for debugging
 *
 * @module api/registry-client
 * @example
 * ```typescript
 * import { RegistryApiClient } from './api/registry-client';
 *
 * const client = new RegistryApiClient('http://localhost:3000');
 * const result = await client.registerTool(metadata);
 * console.log('Registered:', result.toolId);
 * ```
 */
````

## Testing

### Manual Testing

**Test API Integration:**

```bash
# 1. Start backend API
npm --workspace=apps/api run dev

# 2. Verify admin user exists
psql -d nodeangularfullstack -c "SELECT email, role FROM users WHERE role = 'admin';"

# 3. Set environment variables
export CREATE_TOOL_API_URL=http://localhost:3000
export CREATE_TOOL_ADMIN_EMAIL=admin@example.com
export CREATE_TOOL_ADMIN_PASSWORD=Admin123!@#

# 4. Generate tool with registration
node packages/create-tool/dist/index.js test-registration-tool

# Expected output:
# ...
# ✅ Generated 12 files in 5 directories
# 📡 Registering tool with platform...
# ✅ Tool registered with platform
#    Tool ID: test-registration-tool
#    Version: 1.0.0
#    API: /api/tools/test-registration-tool

# 5. Verify tool in database
psql -d nodeangularfullstack -c "SELECT tool_id, name, version FROM tool_registry WHERE tool_id = 'test-registration-tool';"

# 6. Check registration cache
cat ~/.create-tool/registrations.json

# 7. Test with --skip-registration
node packages/create-tool/dist/index.js another-tool --skip-registration

# Expected:
# ⊘ Tool registration skipped (--skip-registration)

# 8. Test with API down
# Stop API server
pkill -f "npm --workspace=apps/api"

# Try generation
node packages/create-tool/dist/index.js offline-tool

# Expected:
# ...
# 📡 Registering tool with platform...
#   ⟲ Retry 1/3 in 1000ms...
#   ⟲ Retry 2/3 in 2000ms...
#   ⟲ Retry 3/3 in 4000ms...
# ⚠️  Tool generation successful, but registration failed
#    Error: connect ECONNREFUSED ...

# 9. Test with invalid credentials
export CREATE_TOOL_ADMIN_PASSWORD=wrong

node packages/create-tool/dist/index.js auth-fail-tool

# Expected:
# ⚠️  Tool generation successful, but registration failed
#    Error: Authentication failed: Invalid credentials
```

### Verification Checklist

After implementation:

- [ ] Axios installed and configured
- [ ] API client module created
- [ ] Authentication with JWT working
- [ ] Tool registration successful
- [ ] Retry logic works (test with network interruption)
- [ ] Tool manifest generated correctly
- [ ] Registration cache saved
- [ ] CLI flags work (--skip-registration, --api-url)
- [ ] Environment variables loaded
- [ ] Error handling graceful (doesn't fail generation)
- [ ] Tool appears in database after registration
- [ ] Manual registration instructions provided on failure

### Known Issues & Solutions

**Issue: ECONNREFUSED errors**

```typescript
// Solution: Check API server is running
if (error.code === 'ECONNREFUSED') {
  console.log('Cannot connect to API server.');
  console.log('Ensure API is running: npm --workspace=apps/api run dev');
}
```

**Issue: Self-signed certificate errors**

```typescript
// Solution: Configure axios to accept self-signed certs (dev only)
const client = axios.create({
  httpsAgent: new https.Agent({
    rejectUnauthorized: false, // Only for development
  }),
});
```

**Issue: Token expiration during long operations**

```typescript
// Solution: Refresh token if 401 received
if (error.response?.status === 401) {
  this.token = null; // Clear expired token
  await this.authenticate(); // Re-authenticate
  return this.client(config); // Retry request
}
```

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-10-24 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent after story completion)
