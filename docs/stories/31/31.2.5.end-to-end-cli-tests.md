# Story 31.2.5: End-to-End CLI Tests

**Epic:** 31.2 - Code Generation & Registration **Story Points:** 5 **Priority:** P1 **Assignee:**
Backend Developer **Status:** Draft

---

## Description

Create comprehensive end-to-end (E2E) tests for the CLI tool generation workflow. These tests
validate the complete user journey from CLI invocation through file generation, backend index
updates, API registration, and smoke testing of generated tool functionality.

**Context:**

- Stories 31.2.1-31.2.4 implemented CLI file generation, component integration, backend boilerplate,
  and API registration
- E2E tests ensure all pieces work together in realistic scenarios
- Tests use real file system operations and live API endpoints (not mocks)
- Tests validate generated tools can actually start and respond to requests

---

## Acceptance Criteria

**AC1: E2E Test Framework Setup**

- ✅ E2E test directory created at `packages/create-tool/tests/e2e/`
- ✅ Jest E2E configuration with increased timeout (60s per test)
- ✅ Setup/teardown utilities for test workspace creation and cleanup
- ✅ Test database seeding with admin user for authentication
- ✅ Environment variables configured for E2E tests (.env.e2e)

**AC2: Full CLI Workflow Test**

- ✅ Test creates tool using CLI with all prompts answered programmatically
- ✅ Verifies 9 files generated in correct directory structure
- ✅ Validates file contents match expected patterns (imports, exports, class names)
- ✅ Checks file permissions (644 for files, 755 for directories)
- ✅ Verifies backend index files updated with new exports

**AC3: API Registration Integration Test**

- ✅ Test invokes CLI with `--register` flag
- ✅ Verifies tool registered in database via API
- ✅ Validates registration cache updated (~/.create-tool/registrations.json)
- ✅ Checks manifest JSON saved correctly in tool_registry table
- ✅ Verifies authentication token handling

**AC4: Conflict Handling Tests**

- ✅ Test runs CLI twice with same tool ID
- ✅ Verifies error message on second run
- ✅ Test `--force` flag overwrites existing files
- ✅ Test `--skip-existing` flag skips conflicting files
- ✅ Validates backup creation when using `--force`

**AC5: Generated Tool Smoke Tests**

- ✅ Test builds shared package (`npm run build:shared`)
- ✅ Test runs backend typecheck on generated tool files
- ✅ Test runs frontend typecheck on generated tool files
- ✅ Test runs backend lint on generated tool files
- ✅ Verifies no compilation or linting errors

**AC6: Error Scenario Tests**

- ✅ Test invalid tool ID format (uppercase, underscores)
- ✅ Test missing environment variables (no admin credentials)
- ✅ Test network failure during API registration (offline mode)
- ✅ Test database connection failure
- ✅ Test file system permission errors

**AC7: CI/CD Pipeline Integration**

- ✅ E2E tests run in GitHub Actions workflow
- ✅ Test database seeded before E2E tests
- ✅ Test workspace cleaned up after tests
- ✅ Test artifacts (logs, generated files) uploaded on failure
- ✅ E2E tests required for PR merge

**AC8: Test Coverage & Documentation**

- ✅ Test coverage ≥80% for E2E test utilities
- ✅ Test execution time ≤5 minutes for full suite
- ✅ README.md documents how to run E2E tests locally
- ✅ Troubleshooting guide for common E2E test failures

---

## Tasks

### Task 1: E2E Test Infrastructure Setup

**Subtasks:**

1. Create `packages/create-tool/tests/e2e/` directory
2. Create `packages/create-tool/tests/e2e/setup.ts` for global setup
3. Create `packages/create-tool/tests/e2e/teardown.ts` for global teardown
4. Create `packages/create-tool/tests/e2e/utils/` directory
5. Create `packages/create-tool/tests/e2e/utils/test-workspace.ts` utility
6. Create `packages/create-tool/tests/e2e/utils/cli-runner.ts` utility
7. Create `packages/create-tool/tests/e2e/utils/database.ts` utility
8. Create `packages/create-tool/jest.e2e.config.js` configuration
9. Add E2E test scripts to package.json
10. Create `.env.e2e` environment file
11. Document E2E test setup in README.md

### Task 2: Test Workspace Manager

**Subtasks:**

1. Implement `TestWorkspace` class with `create()` method
2. Implement `getPath()` to get workspace absolute path
3. Implement `writeFile()` helper for creating test files
4. Implement `readFile()` helper for reading generated files
5. Implement `listFiles()` to get all generated files
6. Implement `checkFileExists()` validation method
7. Implement `cleanup()` method to remove workspace
8. Add `createBackup()` method for force flag tests
9. Add error handling for file system operations
10. Add tests for TestWorkspace utility (≥85% coverage)

### Task 3: CLI Runner Utility

**Subtasks:**

1. Create `CliRunner` class to execute CLI commands
2. Implement `run()` method using `child_process.spawn()`
3. Add `withAnswers()` to provide Inquirer prompt answers
4. Add `withFlags()` to pass CLI flags (--force, --skip-existing, etc.)
5. Add `captureOutput()` to collect stdout/stderr
6. Add `expectSuccess()` assertion helper
7. Add `expectError()` assertion helper
8. Add `getExitCode()` to validate exit codes
9. Implement timeout handling (default 30s)
10. Add tests for CliRunner utility (≥85% coverage)

### Task 4: Database Seeding Utility

**Subtasks:**

1. Create `DatabaseSeeder` class for test data
2. Implement `seedAdminUser()` to create admin test user
3. Implement `clearToolRegistry()` to remove test tools
4. Implement `getAuthToken()` to authenticate as admin
5. Add `verifyToolRegistered()` to check tool in database
6. Add `getToolById()` helper for assertions
7. Implement connection health check
8. Add retry logic for database operations (3 attempts)
9. Add cleanup method to remove test data
10. Add tests for DatabaseSeeder utility (≥80% coverage)

### Task 5: Full CLI Workflow E2E Test

**Subtasks:**

1. Create `packages/create-tool/tests/e2e/full-workflow.e2e.test.ts`
2. Write test: "should generate tool with all files"
3. Use CliRunner to execute CLI with test answers
4. Verify 9 files created (component, service, routes, controller, etc.)
5. Assert file contents match expected patterns
6. Check file permissions (644 files, 755 dirs)
7. Verify backend index files updated (services/index.ts, etc.)
8. Assert no compilation errors with `npm run typecheck`
9. Measure test execution time (should be <60s)
10. Add test cleanup in afterEach hook

### Task 6: API Registration E2E Test

**Subtasks:**

1. Create `packages/create-tool/tests/e2e/registration.e2e.test.ts`
2. Write test: "should register tool with API"
3. Seed database with admin user
4. Run CLI with `--register` flag
5. Verify tool exists in database via query
6. Assert manifest JSON saved correctly
7. Check registration cache updated
8. Verify tool status is "registered"
9. Test authentication token handling
10. Test registration with existing tool (409 conflict)

### Task 7: Conflict Handling E2E Tests

**Subtasks:**

1. Create `packages/create-tool/tests/e2e/conflict-handling.e2e.test.ts`
2. Write test: "should error on duplicate tool ID"
3. Generate tool, then attempt to generate again
4. Assert error message contains "already exists"
5. Write test: "should overwrite with --force flag"
6. Verify backup created before overwriting
7. Assert all files regenerated
8. Write test: "should skip existing files with --skip-existing"
9. Verify only new files created
10. Test conflict detection for each file type

### Task 8: Generated Tool Smoke Tests

**Subtasks:**

1. Create `packages/create-tool/tests/e2e/smoke-tests.e2e.test.ts`
2. Write test: "should build shared package successfully"
3. Run `npm run build:shared` and assert exit code 0
4. Write test: "should typecheck backend files"
5. Run `npm --workspace=apps/api run typecheck` on generated files
6. Write test: "should typecheck frontend files"
7. Run `npm --workspace=apps/web run typecheck` on generated files
8. Write test: "should lint backend files without errors"
9. Write test: "should lint frontend files without errors"
10. Verify no compilation or linting errors in output

### Task 9: Error Scenario E2E Tests

**Subtasks:**

1. Create `packages/create-tool/tests/e2e/error-scenarios.e2e.test.ts`
2. Write test: "should reject invalid tool ID format"
3. Test uppercase tool ID (e.g., "MyTool")
4. Test tool ID with underscores (e.g., "my_tool")
5. Write test: "should handle missing admin credentials"
6. Unset environment variables and assert error
7. Write test: "should handle network failure gracefully"
8. Mock API server offline, verify retry logic
9. Write test: "should handle file permission errors"
10. Create read-only directory, attempt generation, assert error

### Task 10: CI/CD Pipeline Integration

**Subtasks:**

1. Create `.github/workflows/e2e-tests.yml` workflow file
2. Add job: "e2e-tests" with Node.js 18 setup
3. Add PostgreSQL service container (port 5432)
4. Add step to seed test database
5. Add step to run E2E tests (`npm run test:e2e`)
6. Add step to upload test artifacts on failure
7. Add step to clean up test workspace
8. Set timeout to 15 minutes for full workflow
9. Make E2E tests required for PR merge (branch protection)
10. Test workflow in feature branch

### Task 11: Test Artifacts & Debugging

**Subtasks:**

1. Create `packages/create-tool/tests/e2e/utils/artifacts.ts`
2. Implement `saveArtifact()` to save test logs
3. Implement `captureScreenshot()` for debug snapshots
4. Implement `saveDatabaseDump()` for state inspection
5. Implement `saveGeneratedFiles()` to zip generated code
6. Add artifact collection to GitHub Actions workflow
7. Configure artifact retention (7 days)
8. Add artifact download instructions to README
9. Implement `compareArtifacts()` for regression testing
10. Add tests for artifact utilities (≥75% coverage)

### Task 12: Performance & Reliability Testing

**Subtasks:**

1. Create `packages/create-tool/tests/e2e/performance.e2e.test.ts`
2. Write test: "should complete workflow within 60s"
3. Measure total execution time from CLI start to registration
4. Write test: "should handle concurrent generations"
5. Run 3 CLI generations in parallel, verify no race conditions
6. Write test: "should retry on transient API failures"
7. Mock 500 errors, verify retry with exponential backoff
8. Write test: "should clean up on SIGINT (Ctrl+C)"
9. Send SIGINT during generation, verify cleanup
10. Add performance benchmarks to CI logs

### Task 13: Documentation & Troubleshooting Guide

**Subtasks:**

1. Create `packages/create-tool/tests/e2e/README.md`
2. Document how to run E2E tests locally
3. Document environment variable requirements
4. Add section: "Prerequisites" (PostgreSQL, seeded database)
5. Add section: "Running Tests" (npm commands)
6. Add section: "Debugging Failed Tests" (logs, artifacts)
7. Add section: "Common Failures" with solutions
8. Document CI/CD pipeline integration
9. Add examples of successful test output
10. Link to main project README for context

---

## Dev Notes

### E2E Testing Architecture

**Test Isolation Strategy:**

```typescript
// packages/create-tool/tests/e2e/utils/test-workspace.ts
import * as fs from 'fs/promises';
import * as path from 'path';
import { randomUUID } from 'crypto';

export class TestWorkspace {
  private workspaceDir: string;

  constructor(private baseDir: string = '/tmp/create-tool-e2e') {
    const testId = randomUUID();
    this.workspaceDir = path.join(this.baseDir, testId);
  }

  async create(): Promise<void> {
    await fs.mkdir(this.workspaceDir, { recursive: true });
    console.log(`✓ Test workspace created: ${this.workspaceDir}`);
  }

  getPath(relativePath: string = ''): string {
    return path.join(this.workspaceDir, relativePath);
  }

  async writeFile(relativePath: string, content: string): Promise<void> {
    const filePath = this.getPath(relativePath);
    await fs.mkdir(path.dirname(filePath), { recursive: true });
    await fs.writeFile(filePath, content, 'utf-8');
  }

  async readFile(relativePath: string): Promise<string> {
    const filePath = this.getPath(relativePath);
    return await fs.readFile(filePath, 'utf-8');
  }

  async listFiles(relativePath: string = ''): Promise<string[]> {
    const dirPath = this.getPath(relativePath);
    const entries = await fs.readdir(dirPath, { withFileTypes: true });

    const files: string[] = [];
    for (const entry of entries) {
      const fullPath = path.join(relativePath, entry.name);
      if (entry.isDirectory()) {
        const subFiles = await this.listFiles(fullPath);
        files.push(...subFiles);
      } else {
        files.push(fullPath);
      }
    }

    return files;
  }

  async checkFileExists(relativePath: string): Promise<boolean> {
    try {
      const filePath = this.getPath(relativePath);
      await fs.access(filePath);
      return true;
    } catch {
      return false;
    }
  }

  async createBackup(suffix: string = 'backup'): Promise<string> {
    const backupDir = `${this.workspaceDir}-${suffix}`;
    await fs.cp(this.workspaceDir, backupDir, { recursive: true });
    console.log(`✓ Backup created: ${backupDir}`);
    return backupDir;
  }

  async cleanup(): Promise<void> {
    try {
      await fs.rm(this.workspaceDir, { recursive: true, force: true });
      console.log(`✓ Test workspace cleaned: ${this.workspaceDir}`);
    } catch (error) {
      console.warn(`Warning: Failed to cleanup workspace: ${error}`);
    }
  }
}
```

**CLI Runner Utility:**

```typescript
// packages/create-tool/tests/e2e/utils/cli-runner.ts
import { spawn, ChildProcess } from 'child_process';
import * as path from 'path';

export interface CliOptions {
  answers?: Record<string, string | string[]>;
  flags?: string[];
  timeout?: number;
  cwd?: string;
}

export interface CliResult {
  exitCode: number | null;
  stdout: string;
  stderr: string;
  duration: number;
}

export class CliRunner {
  private cliPath: string;

  constructor(cliPath: string = './bin/create-tool') {
    this.cliPath = path.resolve(cliPath);
  }

  async run(options: CliOptions = {}): Promise<CliResult> {
    const { answers = {}, flags = [], timeout = 30000, cwd = process.cwd() } = options;

    const startTime = Date.now();

    return new Promise((resolve, reject) => {
      const args = ['create', ...flags];
      const child = spawn('node', [this.cliPath, ...args], {
        cwd,
        env: { ...process.env },
      });

      let stdout = '';
      let stderr = '';

      // Provide answers to Inquirer prompts
      this.provideAnswers(child, answers);

      child.stdout?.on('data', (data) => {
        stdout += data.toString();
      });

      child.stderr?.on('data', (data) => {
        stderr += data.toString();
      });

      child.on('close', (exitCode) => {
        const duration = Date.now() - startTime;
        resolve({ exitCode, stdout, stderr, duration });
      });

      child.on('error', (error) => {
        reject(new Error(`CLI process error: ${error.message}`));
      });

      // Timeout handling
      const timer = setTimeout(() => {
        child.kill();
        reject(new Error(`CLI execution timeout after ${timeout}ms`));
      }, timeout);

      child.on('close', () => clearTimeout(timer));
    });
  }

  private provideAnswers(child: ChildProcess, answers: Record<string, string | string[]>): void {
    // Listen for Inquirer prompts and provide answers
    child.stdout?.on('data', (data) => {
      const output = data.toString();

      // Detect prompt questions and provide answers
      if (output.includes('What is your tool name?')) {
        child.stdin?.write(`${answers.toolName || 'Test Tool'}\n`);
      } else if (output.includes('Tool ID (kebab-case):')) {
        child.stdin?.write(`${answers.toolId || 'test-tool'}\n`);
      } else if (output.includes('Tool description:')) {
        child.stdin?.write(`${answers.description || 'A test tool'}\n`);
      } else if (output.includes('Select an icon:')) {
        child.stdin?.write('\n'); // Use default
      } else if (output.includes('Select features:')) {
        // Handle checkbox prompt (space to select, enter to confirm)
        const features = (answers.features as string[]) || [];
        features.forEach(() => child.stdin?.write(' ')); // Select features
        child.stdin?.write('\n'); // Confirm
      } else if (output.includes('Select permissions:')) {
        const permissions = (answers.permissions as string[]) || [];
        permissions.forEach(() => child.stdin?.write(' '));
        child.stdin?.write('\n');
      }
    });
  }

  expectSuccess(result: CliResult): void {
    if (result.exitCode !== 0) {
      throw new Error(
        `Expected CLI success but got exit code ${result.exitCode}\n` +
          `Stdout: ${result.stdout}\n` +
          `Stderr: ${result.stderr}`
      );
    }
  }

  expectError(result: CliResult, expectedMessage?: string): void {
    if (result.exitCode === 0) {
      throw new Error('Expected CLI error but got success');
    }

    if (expectedMessage && !result.stderr.includes(expectedMessage)) {
      throw new Error(
        `Expected error message "${expectedMessage}" not found in stderr:\n${result.stderr}`
      );
    }
  }
}
```

**Database Seeding Utility:**

```typescript
// packages/create-tool/tests/e2e/utils/database.ts
import { Pool } from 'pg';
import * as bcrypt from 'bcrypt';
import axios from 'axios';

export class DatabaseSeeder {
  private pool: Pool;
  private apiBaseUrl: string;

  constructor(
    connectionString: string = process.env.DATABASE_URL || '',
    apiBaseUrl: string = process.env.API_BASE_URL || 'http://localhost:3000'
  ) {
    this.pool = new Pool({ connectionString });
    this.apiBaseUrl = apiBaseUrl;
  }

  async seedAdminUser(): Promise<{ email: string; password: string }> {
    const email = 'e2e-admin@example.com';
    const password = 'E2eAdmin123!@#';
    const hashedPassword = await bcrypt.hash(password, 10);

    const query = `
      INSERT INTO users (email, password_hash, role, is_verified)
      VALUES ($1, $2, 'admin', true)
      ON CONFLICT (email) DO UPDATE SET
        password_hash = $2,
        role = 'admin',
        is_verified = true
      RETURNING id
    `;

    await this.pool.query(query, [email, hashedPassword]);
    console.log(`✓ Admin user seeded: ${email}`);

    return { email, password };
  }

  async clearToolRegistry(): Promise<void> {
    await this.pool.query('DELETE FROM tool_registry WHERE tool_id LIKE $1', ['e2e-test-%']);
    console.log('✓ Test tools cleared from registry');
  }

  async getAuthToken(email: string, password: string): Promise<string> {
    const response = await axios.post(`${this.apiBaseUrl}/api/auth/login`, {
      email,
      password,
    });

    return response.data.accessToken;
  }

  async verifyToolRegistered(toolId: string): Promise<boolean> {
    const query = 'SELECT * FROM tool_registry WHERE tool_id = $1';
    const result = await this.pool.query(query, [toolId]);
    return result.rows.length > 0;
  }

  async getToolById(toolId: string): Promise<any | null> {
    const query = 'SELECT * FROM tool_registry WHERE tool_id = $1';
    const result = await this.pool.query(query, [toolId]);
    return result.rows[0] || null;
  }

  async checkConnection(): Promise<boolean> {
    try {
      await this.pool.query('SELECT 1');
      return true;
    } catch (error) {
      console.error('Database connection failed:', error);
      return false;
    }
  }

  async cleanup(): Promise<void> {
    await this.clearToolRegistry();
    await this.pool.query('DELETE FROM users WHERE email LIKE $1', ['e2e-%@%']);
    console.log('✓ Test data cleaned up');
  }

  async close(): Promise<void> {
    await this.pool.end();
  }
}
```

**Jest E2E Configuration:**

```javascript
// packages/create-tool/jest.e2e.config.js
module.exports = {
  displayName: 'create-tool-e2e',
  preset: 'ts-jest',
  testEnvironment: 'node',
  roots: ['<rootDir>/tests/e2e'],
  testMatch: ['**/*.e2e.test.ts'],

  // E2E tests need more time
  testTimeout: 60000, // 60 seconds per test

  // Global setup/teardown
  globalSetup: '<rootDir>/tests/e2e/setup.ts',
  globalTeardown: '<rootDir>/tests/e2e/teardown.ts',

  // Coverage configuration
  collectCoverageFrom: ['tests/e2e/utils/**/*.ts', '!tests/e2e/utils/**/*.test.ts'],
  coverageThreshold: {
    global: {
      statements: 80,
      branches: 75,
      functions: 80,
      lines: 80,
    },
  },

  // Verbose output for debugging
  verbose: true,

  // Environment variables
  setupFiles: ['<rootDir>/tests/e2e/setup-env.ts'],
};
```

**Global Setup:**

```typescript
// packages/create-tool/tests/e2e/setup.ts
import { DatabaseSeeder } from './utils/database';

export default async function globalSetup() {
  console.log('\n🧪 E2E Test Suite Setup\n');

  // Check database connection
  const seeder = new DatabaseSeeder();
  const isConnected = await seeder.checkConnection();

  if (!isConnected) {
    throw new Error('Database connection failed. Ensure PostgreSQL is running.');
  }

  // Seed admin user
  await seeder.seedAdminUser();

  // Clear old test data
  await seeder.clearToolRegistry();

  await seeder.close();

  console.log('✓ E2E setup complete\n');
}
```

**Global Teardown:**

```typescript
// packages/create-tool/tests/e2e/teardown.ts
import { DatabaseSeeder } from './utils/database';
import * as fs from 'fs/promises';

export default async function globalTeardown() {
  console.log('\n🧹 E2E Test Suite Teardown\n');

  // Clean up test data
  const seeder = new DatabaseSeeder();
  await seeder.cleanup();
  await seeder.close();

  // Clean up test workspaces
  try {
    await fs.rm('/tmp/create-tool-e2e', { recursive: true, force: true });
    console.log('✓ Test workspaces cleaned');
  } catch (error) {
    console.warn('Warning: Failed to clean test workspaces:', error);
  }

  console.log('✓ E2E teardown complete\n');
}
```

### Full Workflow E2E Test Example

```typescript
// packages/create-tool/tests/e2e/full-workflow.e2e.test.ts
import { TestWorkspace } from './utils/test-workspace';
import { CliRunner } from './utils/cli-runner';
import { DatabaseSeeder } from './utils/database';
import * as fs from 'fs/promises';
import * as path from 'path';

describe('Full CLI Workflow E2E', () => {
  let workspace: TestWorkspace;
  let cli: CliRunner;
  let seeder: DatabaseSeeder;

  beforeEach(async () => {
    workspace = new TestWorkspace();
    await workspace.create();

    cli = new CliRunner();
    seeder = new DatabaseSeeder();
  });

  afterEach(async () => {
    await workspace.cleanup();
  });

  it('should generate tool with all files', async () => {
    // Arrange
    const answers = {
      toolName: 'E2E Test Tool',
      toolId: 'e2e-test-tool',
      description: 'A tool for E2E testing',
      features: ['list', 'create', 'detail'],
      permissions: ['read', 'write'],
    };

    // Act
    const result = await cli.run({
      answers,
      cwd: workspace.getPath(),
      timeout: 60000,
    });

    // Assert - CLI success
    cli.expectSuccess(result);
    expect(result.duration).toBeLessThan(60000); // < 60s

    // Assert - Files generated
    const expectedFiles = [
      'apps/web/src/app/features/e2e-test-tool/e2e-test-tool.component.ts',
      'apps/web/src/app/features/e2e-test-tool/e2e-test-tool.component.html',
      'apps/web/src/app/features/e2e-test-tool/e2e-test-tool.service.ts',
      'apps/web/src/app/features/e2e-test-tool/e2e-test-tool.routes.ts',
      'apps/api/src/controllers/e2e-test-tool.controller.ts',
      'apps/api/src/services/e2e-test-tool.service.ts',
      'apps/api/src/repositories/e2e-test-tool.repository.ts',
      'apps/api/src/validators/e2e-test-tool.validator.ts',
      'apps/api/src/routes/e2e-test-tool.routes.ts',
    ];

    for (const file of expectedFiles) {
      const exists = await workspace.checkFileExists(file);
      expect(exists).toBe(true);
    }

    // Assert - File contents
    const componentContent = await workspace.readFile(
      'apps/web/src/app/features/e2e-test-tool/e2e-test-tool.component.ts'
    );
    expect(componentContent).toContain('export class E2eTestToolComponent');
    expect(componentContent).toContain('standalone: true');
    expect(componentContent).toContain('import { CommonModule }');

    const serviceContent = await workspace.readFile(
      'apps/api/src/services/e2e-test-tool.service.ts'
    );
    expect(serviceContent).toContain('export class E2eTestToolService');
    expect(serviceContent).toContain('constructor(private repository:');

    // Assert - Backend index files updated
    const servicesIndex = await workspace.readFile('apps/api/src/services/index.ts');
    expect(servicesIndex).toContain(
      "export { E2eTestToolService } from './e2e-test-tool.service';"
    );

    const controllersIndex = await workspace.readFile('apps/api/src/controllers/index.ts');
    expect(controllersIndex).toContain(
      "export { E2eTestToolController } from './e2e-test-tool.controller';"
    );
  }, 120000); // 2 minute timeout

  it('should register tool with API', async () => {
    // Arrange
    const { email, password } = await seeder.seedAdminUser();
    process.env.CREATE_TOOL_ADMIN_EMAIL = email;
    process.env.CREATE_TOOL_ADMIN_PASSWORD = password;

    const answers = {
      toolName: 'Registered Tool',
      toolId: 'e2e-registered-tool',
      description: 'Tool with API registration',
    };

    // Act
    const result = await cli.run({
      answers,
      flags: ['--register'],
      cwd: workspace.getPath(),
    });

    // Assert
    cli.expectSuccess(result);
    expect(result.stdout).toContain('✓ Tool registered with platform');

    // Verify in database
    const isRegistered = await seeder.verifyToolRegistered('e2e-registered-tool');
    expect(isRegistered).toBe(true);

    const tool = await seeder.getToolById('e2e-registered-tool');
    expect(tool.name).toBe('Registered Tool');
    expect(tool.status).toBe('registered');
    expect(tool.manifest_json).toBeDefined();
  }, 90000); // 90s timeout

  it('should error on duplicate tool ID', async () => {
    // Arrange
    const answers = {
      toolName: 'Duplicate Tool',
      toolId: 'e2e-duplicate',
    };

    // Act - First generation
    const result1 = await cli.run({ answers, cwd: workspace.getPath() });
    cli.expectSuccess(result1);

    // Act - Second generation (should fail)
    const result2 = await cli.run({ answers, cwd: workspace.getPath() });

    // Assert
    cli.expectError(result2, 'Tool already exists');
    expect(result2.stderr).toContain('Use --force to overwrite');
  });

  it('should overwrite with --force flag', async () => {
    // Arrange
    const answers = { toolName: 'Force Tool', toolId: 'e2e-force' };

    // Act - First generation
    await cli.run({ answers, cwd: workspace.getPath() });

    // Modify file to test overwrite
    const componentPath = 'apps/web/src/app/features/e2e-force/e2e-force.component.ts';
    await workspace.writeFile(componentPath, '// Modified content');

    // Act - Second generation with --force
    const result = await cli.run({
      answers,
      flags: ['--force'],
      cwd: workspace.getPath(),
    });

    // Assert
    cli.expectSuccess(result);
    expect(result.stdout).toContain('Backup created');

    const content = await workspace.readFile(componentPath);
    expect(content).not.toContain('// Modified content');
    expect(content).toContain('export class E2eForceComponent');
  });
});
```

### CI/CD Workflow Integration

```yaml
# .github/workflows/e2e-tests.yml
name: E2E Tests

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready --health-interval 10s --health-timeout 5s --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build shared package
        run: npm run build:shared

      - name: Run database migrations
        run: npm --workspace=apps/api run db:migrate
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db

      - name: Start backend API (background)
        run: |
          npm --workspace=apps/api run dev &
          sleep 10 # Wait for API to start
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          NODE_ENV: test

      - name: Run E2E tests
        run: npm --workspace=packages/create-tool run test:e2e
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          API_BASE_URL: http://localhost:3000

      - name: Upload test artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: e2e-test-artifacts
          path: |
            /tmp/create-tool-e2e/**/*
            packages/create-tool/coverage/
          retention-days: 7

      - name: Clean up test workspace
        if: always()
        run: rm -rf /tmp/create-tool-e2e
```

### Package.json Scripts

```json
{
  "scripts": {
    "test:e2e": "jest --config jest.e2e.config.js",
    "test:e2e:watch": "jest --config jest.e2e.config.js --watch",
    "test:e2e:coverage": "jest --config jest.e2e.config.js --coverage",
    "test:e2e:debug": "node --inspect-brk node_modules/.bin/jest --config jest.e2e.config.js --runInBand"
  }
}
```

### Environment Variables (.env.e2e)

```bash
# Database
DATABASE_URL=postgresql://test_user:test_password@localhost:5432/test_db

# API
API_BASE_URL=http://localhost:3000

# Admin credentials for registration
CREATE_TOOL_ADMIN_EMAIL=e2e-admin@example.com
CREATE_TOOL_ADMIN_PASSWORD=E2eAdmin123!@#

# CLI options
CREATE_TOOL_WORKSPACE=/tmp/create-tool-e2e

# Timeouts
CLI_TIMEOUT=60000
API_TIMEOUT=30000
```

---

## Testing

### Manual Testing

**Test 1: Run E2E Tests Locally**

```bash
# 1. Ensure PostgreSQL running
brew services start postgresql@14

# 2. Set environment variables
export DATABASE_URL="postgresql://user:password@localhost:5432/nodeangular_db"
export API_BASE_URL="http://localhost:3000"

# 3. Start backend API
npm --workspace=apps/api run dev

# 4. Run E2E tests (in new terminal)
cd packages/create-tool
npm run test:e2e

# Expected output:
# 🧪 E2E Test Suite Setup
# ✓ Admin user seeded: e2e-admin@example.com
# ✓ Test tools cleared from registry
# ✓ E2E setup complete
#
# PASS tests/e2e/full-workflow.e2e.test.ts
#   ✓ should generate tool with all files (45s)
#   ✓ should register tool with API (30s)
#   ✓ should error on duplicate tool ID (25s)
#   ✓ should overwrite with --force flag (28s)
#
# Test Suites: 1 passed, 1 total
# Tests:       4 passed, 4 total
# Time:        130s
```

**Test 2: Run Single E2E Test**

```bash
npm run test:e2e -- --testNamePattern="should generate tool with all files"

# Expected output:
# PASS tests/e2e/full-workflow.e2e.test.ts
#   ✓ should generate tool with all files (42s)
#
# Tests: 1 passed, 1 total
```

**Test 3: Debug E2E Test with Inspector**

```bash
npm run test:e2e:debug -- --testNamePattern="should register tool with API"

# Chrome DevTools opens
# Set breakpoints in test file or utilities
# Step through CLI execution
```

**Test 4: Verify Artifacts After Failure**

```bash
# 1. Force a test failure (modify test to expect wrong value)
# 2. Run E2E tests
npm run test:e2e

# 3. Check generated artifacts
ls -la /tmp/create-tool-e2e/
# Should see test workspace directories with generated files

# 4. Inspect generated files
cat /tmp/create-tool-e2e/<uuid>/apps/web/src/app/features/test-tool/test-tool.component.ts
```

### Automated Testing (in CI)

**GitHub Actions Workflow:**

1. E2E tests run automatically on every PR
2. Tests must pass for PR to be merged
3. Test artifacts uploaded on failure (logs, generated files)
4. Artifacts retained for 7 days for debugging

**Monitoring E2E Test Duration:**

- Target: Full E2E suite completes in ≤5 minutes
- Individual tests: ≤60 seconds
- If tests exceed threshold, investigate performance bottlenecks

---

## Dependencies

**Depends On:**

- Story 31.2.1: Directory Structure Generation (file generation)
- Story 31.2.2: Frontend Component Integration (Angular components)
- Story 31.2.3: Backend Boilerplate Enhancement (index file updates)
- Story 31.2.4: Tool Registration API Integration (API registration)
- Epic 30.2: Tool Registry Backend (API endpoints, database schema)

**Blocks:**

- Epic 32.1: UI Components & Tool Discovery (need registered tools for testing)
- Epic 33: Export Automation (CLI must be stable before export)

**Related Stories:**

- Story 31.1.4: CLI Unit Testing Framework (unit tests vs E2E tests)

---

## QA Gate

**Quality Score Target:** ≥90/100

**Criteria:**

| Criterion                     | Weight | Target          |
| ----------------------------- | ------ | --------------- |
| E2E test coverage (utilities) | 15%    | ≥80%            |
| Full workflow test passes     | 20%    | 100% pass rate  |
| API registration test passes  | 15%    | 100% pass rate  |
| Error scenario tests pass     | 15%    | 100% pass rate  |
| CI/CD integration functional  | 15%    | Tests run in CI |
| Test execution time           | 10%    | ≤5 minutes      |
| Documentation completeness    | 10%    | README + guide  |

**Exit Criteria:**

- All E2E tests pass locally and in CI
- Test suite completes in ≤5 minutes
- CI/CD workflow functional with artifact uploads
- README documents how to run and debug E2E tests
- No flaky tests (tests must be deterministic)

---

## Notes

- E2E tests use real file system and real database (not mocks)
- Test isolation is critical - use unique test IDs and cleanup
- CI/CD pipeline seeds database and starts API before tests
- Test artifacts help debug failures in CI
- Performance monitoring ensures tests remain fast as project grows
