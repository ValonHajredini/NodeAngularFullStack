# Story 20.2: Theme API Endpoints and Validation

## Status

Draft

## Story

**As a** backend developer, **I want** to create REST API endpoints for theme management, **so
that** the frontend can fetch, create, and apply themes.

## Acceptance Criteria

1. Implement `GET /api/themes` to list active themes sorted by usage count descending
2. Implement `GET /api/themes/:id` to retrieve a single theme by ID
3. Implement `POST /api/themes` (admin only) to create new themes with validation
4. Implement `PUT /api/themes/:id` (admin only) to update existing themes
5. Implement `DELETE /api/themes/:id` (admin only) to soft-delete themes (set is_active = false)
6. Implement `POST /api/themes/:id/apply` to increment theme usage count
7. Add Swagger/OpenAPI documentation for all theme endpoints
8. Write integration tests with authentication and authorization scenarios

**Integration Verification:**

- IV1: Verify existing `/api/forms` endpoints remain functional and unaffected
- IV2: Verify authentication middleware (JWT) applies correctly to all theme routes
- IV3: Verify rate limiting allows legitimate requests without blocking theme operations

## Tasks / Subtasks

- [ ] Task 1: Create ThemesController with route handlers (AC: 1, 2, 6)
  - [ ] Create file `apps/api/src/controllers/themes.controller.ts`
  - [ ] Inject `ThemesService` dependency using constructor injection pattern [Source:
        backend-architecture.md#controller-template]
  - [ ] Implement `getThemes` handler: GET /api/themes, calls service.findAll(activeOnly=true),
        returns 200 with array
  - [ ] Implement `getThemeById` handler: GET /api/themes/:id, validates UUID param, returns 200 or
        404
  - [ ] Implement `applyTheme` handler: POST /api/themes/:id/apply, calls service.incrementUsage(),
        returns 200
  - [ ] Use `AsyncHandler` wrapper for async error handling [Source:
        backend-architecture.md#controller-template]
  - [ ] Add JSDoc comments to all controller methods with HTTP method, path, permissions,
        request/response formats [Source: coding-standards.md#documentation-standards]

- [ ] Task 2: Create admin-only theme management handlers (AC: 3, 4, 5)
  - [ ] Implement `createTheme` handler: POST /api/themes, requires admin role, validates request
        body
  - [ ] Implement `updateTheme` handler: PUT /api/themes/:id, requires admin role, validates partial
        updates
  - [ ] Implement `deleteTheme` handler: DELETE /api/themes/:id, requires admin role, performs soft
        delete
  - [ ] Apply `authorize(['admin'])` middleware to admin routes [Source:
        backend-architecture.md#middlewareguards]
  - [ ] Return appropriate error codes: 400 (validation), 401 (auth), 403 (forbidden), 404 (not
        found)

- [ ] Task 3: Create ThemesValidator for request validation (AC: 3, 4)
  - [ ] Create file `apps/api/src/validators/themes.validator.ts`
  - [ ] Implement `validateCreateTheme` using express-validator with rules:
    - name: required, string, min 3 max 100 characters
    - description: optional, string, max 500 characters
    - thumbnailUrl: required, string, valid URL format, max 500 characters
    - themeConfig: required, object, validate ResponsiveThemeConfig structure
    - themeConfig.desktop: required, validate ThemeProperties fields
    - themeConfig.mobile: optional, validate partial ThemeProperties fields
  - [ ] Implement `validateUpdateTheme` with same rules but all fields optional except id
  - [ ] Implement `validateThemeConfig` to validate JSONB structure (color hex codes, valid enum
        values, numeric ranges)
  - [ ] Use express-validator middleware pattern: `body('field').isString().notEmpty()` [Source:
        existing validators pattern]

- [ ] Task 4: Create ThemesService business logic layer (AC: All)
  - [ ] Create file `apps/api/src/services/themes.service.ts`
  - [ ] Inject `ThemesRepository` dependency
  - [ ] Implement `findAll(activeOnly?: boolean)` method calling repository.findAll()
  - [ ] Implement `findById(id: string)` method with error handling for not found
  - [ ] Implement `create(themeData, userId)` method validating config, calling repository.create(),
        returning created theme
  - [ ] Implement `update(id, updates, userId)` method checking existence, validating partial
        config, calling repository.update()
  - [ ] Implement `softDelete(id)` method checking existence, calling repository.softDelete()
  - [ ] Implement `incrementUsage(id)` method calling repository.incrementUsageCount()
  - [ ] Add JSDoc comments to all service methods [Source:
        coding-standards.md#documentation-standards]

- [ ] Task 5: Create routes configuration (AC: All)
  - [ ] Create file `apps/api/src/routes/themes.routes.ts`
  - [ ] Define Express router with theme endpoints following RESTful conventions [Source:
        backend-architecture.md#controller/route-organization]
  - [ ] Apply authentication middleware to all routes: `router.use(authenticate)`
  - [ ] Apply admin authorization to POST/PUT/DELETE routes: `authorize(['admin'])`
  - [ ] Apply validation middleware before handlers: `validateCreateTheme, validationMiddleware`
  - [ ] Register routes in `apps/api/src/routes/index.ts` main router:
        `app.use('/api/themes', themesRoutes)`
  - [ ] Route mappings:
    ```
    GET    /api/themes              → themesController.getThemes
    GET    /api/themes/:id          → themesController.getThemeById
    POST   /api/themes              → [admin] themesController.createTheme
    PUT    /api/themes/:id          → [admin] themesController.updateTheme
    DELETE /api/themes/:id          → [admin] themesController.deleteTheme
    POST   /api/themes/:id/apply    → themesController.applyTheme
    ```

- [ ] Task 6: Add Swagger/OpenAPI documentation (AC: 7)
  - [ ] Add JSDoc comments with OpenAPI tags to all controller methods:
    ```typescript
    /**
     * @swagger
     * /api/themes:
     *   get:
     *     summary: List all active themes
     *     tags: [Themes]
     *     security:
     *       - bearerAuth: []
     *     responses:
     *       200:
     *         description: List of themes sorted by usage count
     *         content:
     *           application/json:
     *             schema:
     *               type: array
     *               items:
     *                 $ref: '#/components/schemas/FormTheme'
     */
    ```
  - [ ] Define `FormTheme` schema in Swagger components
  - [ ] Define `ResponsiveThemeConfig` and `ThemeProperties` schemas
  - [ ] Test Swagger UI at `http://localhost:3000/api-docs` shows theme endpoints
  - [ ] Verify "Try it out" functionality works with sample theme data

- [ ] Task 7: Write integration tests (AC: 8, IV1, IV2, IV3)
  - [ ] Create file `apps/api/tests/integration/themes.test.ts` [Source:
        testing-strategy.md#backend-tests]
  - [ ] Set up test database with seed data (admin user, test themes)
  - [ ] Test GET /api/themes: should return active themes sorted by usage_count DESC
  - [ ] Test GET /api/themes: should require authentication (401 without JWT)
  - [ ] Test GET /api/themes/:id: should return theme by id, 404 if not found
  - [ ] Test POST /api/themes: should create theme with valid admin JWT (201 response)
  - [ ] Test POST /api/themes: should reject non-admin users (403 forbidden)
  - [ ] Test POST /api/themes: should validate required fields (400 with validation errors)
  - [ ] Test POST /api/themes: should validate themeConfig JSONB structure (400 for invalid
        colors/enums)
  - [ ] Test PUT /api/themes/:id: should update theme with admin JWT
  - [ ] Test PUT /api/themes/:id: should reject non-admin users (403)
  - [ ] Test DELETE /api/themes/:id: should soft-delete theme (is_active = false)
  - [ ] Test DELETE /api/themes/:id: should reject non-admin users (403)
  - [ ] Test POST /api/themes/:id/apply: should increment usage_count by 1
  - [ ] Test POST /api/themes/:id/apply: should work for authenticated users (not just admin)
  - [ ] Test IV1: Run existing forms endpoint tests, verify all pass unaffected
  - [ ] Test IV2: Verify JWT authentication middleware applies to theme routes
  - [ ] Test IV3: Make 100 rapid requests to /api/themes, verify rate limiting allows legitimate
        traffic
  - [ ] Run `npm --workspace=apps/api run test:integration` to verify all tests pass

- [ ] Task 8: Write unit tests for service and validator
  - [ ] Create file `apps/api/tests/unit/services/themes.service.test.ts`
  - [ ] Mock ThemesRepository methods using Jest spies
  - [ ] Test findAll, findById, create, update, softDelete, incrementUsage methods
  - [ ] Test error handling: service throws appropriate errors for not found, validation failures
  - [ ] Create file `apps/api/tests/unit/validators/themes.validator.test.ts`
  - [ ] Test validateCreateTheme: accept valid theme data, reject invalid fields
  - [ ] Test validateUpdateTheme: accept partial updates, reject invalid types
  - [ ] Test validateThemeConfig: reject invalid color hex codes, invalid enum values
  - [ ] Run `npm --workspace=apps/api run test:unit` to verify all unit tests pass

## Dev Notes

### Previous Story Insights

**Story 20.1 Completion Notes:**

- Created `form_themes` table with JSONB `theme_config` column
- Created `ThemesRepository` with CRUD methods using parameterized queries
- Added `theme_id` column to `form_schemas` with foreign key constraint
- All migrations tested and reversible
- Repository extends `BaseRepository<FormTheme>` pattern

**Key Learnings from Story 20.1:**

- JSONB column usage for flexible schema storage (theme_config)
- Soft delete pattern (is_active flag) instead of hard deletes
- Usage count tracking for sorting (indexed on usage_count DESC)
- Parameterized queries prevent SQL injection

### Data Models

**FormTheme Interface** (from Story 20.1, Story 20.3 will formalize in shared types):

```typescript
export interface FormTheme {
  id: string;
  name: string;
  description?: string;
  thumbnailUrl: string;
  themeConfig: ResponsiveThemeConfig;
  usageCount: number;
  isActive: boolean;
  createdBy?: string;
  createdAt: Date;
  updatedAt: Date;
}

export interface ResponsiveThemeConfig {
  desktop: ThemeProperties;
  mobile?: Partial<ThemeProperties>;
}

export interface ThemeProperties {
  primaryColor: string; // Hex color code (e.g., "#FF5733")
  secondaryColor: string; // Hex color code
  backgroundColor: string; // Hex color code or gradient
  textColorPrimary: string; // Hex color code
  textColorSecondary: string; // Hex color code
  fontFamilyHeading: string; // Font name (e.g., "Roboto")
  fontFamilyBody: string; // Font name
  fieldBorderRadius: string; // CSS value (e.g., "8px")
  fieldSpacing: string; // CSS value (e.g., "16px")
  containerBackground: string; // Hex color code
  containerOpacity: number; // 0.0 to 1.0
  containerPosition: 'center' | 'top' | 'left' | 'full-width';
  backgroundImageUrl?: string; // Optional DigitalOcean Spaces URL
  backgroundImagePosition?: 'cover' | 'contain' | 'repeat';
}
```

[Source: docs/prd/epic-20-form-styling-theme-system.md#type-definitions]

### API Specifications

**Theme API Endpoints:**

```yaml
GET /api/themes
  Summary: List all active themes sorted by usage count
  Authentication: Required (JWT)
  Authorization: Any authenticated user
  Query Parameters: None
  Response 200:
    {
      "success": true,
      "data": [
        {
          "id": "uuid",
          "name": "Neon",
          "description": "Vibrant neon-style theme",
          "thumbnailUrl": "https://spaces.digitalocean.com/.../neon-thumb.png",
          "themeConfig": { ... },
          "usageCount": 1234,
          "isActive": true,
          "createdAt": "2025-01-15T10:00:00Z",
          "updatedAt": "2025-01-15T10:00:00Z"
        }
      ]
    }

GET /api/themes/:id
  Summary: Get single theme by ID
  Authentication: Required (JWT)
  Path Parameters: id (UUID)
  Response 200: Theme object
  Response 404: Theme not found

POST /api/themes
  Summary: Create new theme (admin only)
  Authentication: Required (JWT)
  Authorization: Admin role only
  Request Body:
    {
      "name": "Custom Theme",
      "description": "Optional description",
      "thumbnailUrl": "https://...",
      "themeConfig": {
        "desktop": { ... },
        "mobile": { ... }  // optional
      }
    }
  Validation:
    - name: required, 3-100 chars
    - thumbnailUrl: required, valid URL
    - themeConfig.desktop: required, all ThemeProperties fields
    - Colors: valid hex codes (#RRGGBB)
    - containerOpacity: 0.0-1.0
    - containerPosition: enum validation
  Response 201: Created theme object
  Response 400: Validation errors
  Response 403: Non-admin user

PUT /api/themes/:id
  Summary: Update existing theme (admin only)
  Authentication: Required (JWT)
  Authorization: Admin role only
  Path Parameters: id (UUID)
  Request Body: Partial theme object (only fields to update)
  Response 200: Updated theme object
  Response 404: Theme not found
  Response 403: Non-admin user

DELETE /api/themes/:id
  Summary: Soft-delete theme (admin only)
  Authentication: Required (JWT)
  Authorization: Admin role only
  Path Parameters: id (UUID)
  Response 200: { "success": true, "message": "Theme deleted" }
  Response 404: Theme not found
  Response 403: Non-admin user

POST /api/themes/:id/apply
  Summary: Track theme application (increment usage count)
  Authentication: Required (JWT)
  Authorization: Any authenticated user
  Path Parameters: id (UUID)
  Response 200: { "success": true, "usageCount": 1235 }
  Response 404: Theme not found
```

[Source: docs/prd/epic-20-form-styling-theme-system.md#api-integration]

**Standard Error Response Format:**

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Invalid theme configuration",
    "details": {
      "themeConfig.desktop.primaryColor": "Must be valid hex color code"
    },
    "timestamp": "2025-01-15T10:00:00Z",
    "requestId": "uuid"
  }
}
```

[Source: api-specification.md#error-response-format]

### Component Specifications

Not applicable (backend story, no frontend components).

### File Locations

**Controller:**

- File: `apps/api/src/controllers/themes.controller.ts`
- Pattern: Class with async handler methods using AsyncHandler wrapper
- Exports: `ThemesController` class

**Service:**

- File: `apps/api/src/services/themes.service.ts`
- Pattern: Class with business logic methods
- Exports: `ThemesService` class

**Validator:**

- File: `apps/api/src/validators/themes.validator.ts`
- Pattern: Express-validator middleware functions
- Exports: `validateCreateTheme`, `validateUpdateTheme`, `validateThemeConfig`

**Routes:**

- File: `apps/api/src/routes/themes.routes.ts`
- Pattern: Express Router with middleware chain
- Exports: `themesRoutes` router
- Integration: Register in `apps/api/src/routes/index.ts`

**Test Files:**

- Integration: `apps/api/tests/integration/themes.test.ts`
- Unit: `apps/api/tests/unit/services/themes.service.test.ts`
- Unit: `apps/api/tests/unit/validators/themes.validator.test.ts`

[Source: unified-project-structure.md, backend-architecture.md#controller/route-organization]

### Testing Requirements

**Testing Framework:**

- Jest 29+ with TypeScript support [Source: tech-stack.md]
- Supertest 6+ for HTTP integration tests
- Test database: PostgreSQL with test seed data

**Integration Test Pattern:**

```typescript
import request from 'supertest';
import { app } from '../../src/server';

describe('Theme API Endpoints', () => {
  let adminToken: string;
  let userToken: string;

  beforeEach(async () => {
    await pool.query('DELETE FROM form_themes');
    // Login as admin to get JWT
    const adminRes = await request(app)
      .post('/api/auth/login')
      .send({ email: 'admin@example.com', password: 'Admin123!@#' });
    adminToken = adminRes.body.accessToken;

    // Login as regular user
    const userRes = await request(app)
      .post('/api/auth/login')
      .send({ email: 'user@example.com', password: 'User123!@#' });
    userToken = userRes.body.accessToken;
  });

  describe('GET /api/themes', () => {
    it('should return active themes sorted by usage count', async () => {
      const response = await request(app)
        .get('/api/themes')
        .set('Authorization', `Bearer ${userToken}`);

      expect(response.status).toBe(200);
      expect(response.body.success).toBe(true);
      expect(response.body.data).toBeInstanceOf(Array);
    });

    it('should require authentication', async () => {
      const response = await request(app).get('/api/themes');
      expect(response.status).toBe(401);
    });
  });

  describe('POST /api/themes', () => {
    it('should create theme with admin JWT', async () => {
      const themeData = {
        name: 'Test Theme',
        thumbnailUrl: 'https://example.com/thumb.png',
        themeConfig: {
          desktop: {
            primaryColor: '#FF5733',
            // ... all required fields
          },
        },
      };

      const response = await request(app)
        .post('/api/themes')
        .set('Authorization', `Bearer ${adminToken}`)
        .send(themeData);

      expect(response.status).toBe(201);
      expect(response.body.data.name).toBe('Test Theme');
    });

    it('should reject non-admin users', async () => {
      const response = await request(app)
        .post('/api/themes')
        .set('Authorization', `Bearer ${userToken}`)
        .send({ name: 'Test' });

      expect(response.status).toBe(403);
    });
  });
});
```

[Source: testing-strategy.md#backend-api-test]

**Validation Test Requirements:**

- Test all required field validations (name, thumbnailUrl, themeConfig)
- Test string length constraints (min/max)
- Test color hex code format validation (regex `/^#[0-9A-Fa-f]{6}$/`)
- Test enum value validation (containerPosition)
- Test numeric range validation (containerOpacity 0.0-1.0)
- Test nested object validation (themeConfig.desktop required, mobile optional)

### Technical Constraints

**Authentication & Authorization:**

- All endpoints require JWT authentication via `authenticate` middleware [Source:
  backend-architecture.md#authentication-and-authorization]
- Admin routes (POST, PUT, DELETE) require `authorize(['admin'])` middleware
- Apply route must be accessible to any authenticated user
- JWT validation includes signature verification, expiration check, and user active status [Source:
  backend-architecture.md#auth-flow]

**Request Validation:**

- Use express-validator for all input validation
- Validation errors return 400 status with structured error details
- JSONB themeConfig must validate all required fields in desktop, optional fields in mobile
- Color codes must match hex format: `#RRGGBB` (6 hex digits)
- URLs must be valid format and HTTPS for thumbnailUrl

**Error Handling:**

- All async routes wrapped in AsyncHandler for automatic error catching
- ApiError class for structured error responses with status codes
- Standard error format: `{ error: { code, message, details, timestamp, requestId } }`
- 400: Validation errors, 401: Authentication required, 403: Forbidden, 404: Not found
- 500: Internal server errors with sanitized messages (no sensitive data exposure)

**Rate Limiting:**

- Rate limiting middleware already configured for all `/api/*` routes
- Theme endpoints inherit existing rate limiting (no special configuration needed)
- Verify rate limiting doesn't block legitimate theme browsing (IV3)

**Performance:**

- GET /api/themes uses database index on `usage_count DESC` for fast sorting
- Soft delete (is_active) allows quick filtering with indexed WHERE clause
- JSONB column parsing happens at database level (PostgreSQL native support)

### Project Structure Notes

**Service Layer Pattern:** Controllers delegate business logic to service layer, services use
repositories for data access:

```
Request → Controller (HTTP handling)
           ↓
        Service (business logic)
           ↓
        Repository (data access)
           ↓
        Database
```

[Source: backend-architecture.md#service-architecture]

**Middleware Chain Order:**

1. Authentication middleware (verify JWT, attach user to request)
2. Authorization middleware (check user role)
3. Validation middleware (validate request body/params)
4. Controller handler (business logic via service)
5. Error handling middleware (catch errors, format response)

**Alignment with Existing Architecture:**

- Theme endpoints follow same pattern as `/api/users`, `/api/forms` routes
- Uses existing auth middleware and error handling
- Follows repository pattern established in Story 20.1
- Swagger documentation matches existing API docs structure
- No new middleware/infrastructure needed (reuses existing stack)

**No Structural Conflicts Detected:** Theme API integrates seamlessly with existing route structure.
No breaking changes to existing endpoints.

## Testing

### Testing Standards

- **Test file location:** `apps/api/tests/integration/themes.test.ts` for integration,
  `apps/api/tests/unit/services/themes.service.test.ts` and
  `apps/api/tests/unit/validators/themes.validator.test.ts` for unit tests [Source:
  testing-strategy.md#test-organization]
- **Test standards:** Use Supertest for HTTP integration tests, Jest mocks for unit tests, real
  PostgreSQL for integration tests [Source: testing-strategy.md#backend-api-test]
- **Testing frameworks:** Jest 29+, Supertest 6+ [Source: tech-stack.md]
- **Specific testing requirements:**
  - Integration tests: Test full HTTP request/response cycle with authentication
  - Test both admin and non-admin users for authorization scenarios
  - Test validation with invalid data (missing fields, wrong types, invalid formats)
  - Test backward compatibility (IV1): existing forms endpoints still work
  - Test rate limiting (IV3): 100 rapid requests don't get blocked
  - Unit tests: Mock ThemesRepository and test service logic isolation
  - Validation tests: Test express-validator rules with edge cases

### Test Execution Commands

```bash
# All integration tests
npm --workspace=apps/api run test:integration

# Single integration test file
npm --workspace=apps/api run test -- --testPathPatterns="themes.test.ts"

# All unit tests
npm --workspace=apps/api run test:unit

# With coverage
npm --workspace=apps/api run test -- --coverage

# Watch mode for development
npm --workspace=apps/api run test -- --watch --testPathPatterns="themes"
```

[Source: CLAUDE.md#testing-commands]

## Change Log

| Date       | Version | Description         | Author       |
| ---------- | ------- | ------------------- | ------------ |
| 2025-10-15 | 1.0     | Story draft created | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be filled by dev agent during implementation_

### Debug Log References

_To be filled by dev agent during implementation_

### Completion Notes List

_To be filled by dev agent during implementation_

### File List

_To be filled by dev agent during implementation_

## QA Results

_To be filled by QA agent after implementation review_
