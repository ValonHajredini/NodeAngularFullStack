# Story 3.3: Tenant Management Interface

## Status

Draft

## Story

**As an** administrator, **I want** to manage tenant configurations and settings, **so that** I can
control multi-tenant operations through a web interface.

## Acceptance Criteria

1. Admin interface for creating, configuring, and managing tenant accounts
2. Tenant-specific settings include branding, feature toggles, and user limits
3. Tenant isolation validation ensures data separation between tenant accounts
4. Admin dashboard shows tenant usage statistics and system health metrics
5. Tenant onboarding process includes setup wizard and validation steps

## Tasks / Subtasks

- [ ] Task 1: Create tenant management backend API endpoints (AC: 1)
  - [ ] Implement GET /api/v1/admin/tenants for listing tenants with pagination
  - [ ] Create POST /api/v1/admin/tenants for tenant creation
  - [ ] Add PATCH /api/v1/admin/tenants/:id for tenant updates
  - [ ] Implement DELETE /api/v1/admin/tenants/:id for tenant deactivation
  - [ ] Create GET /api/v1/admin/tenants/:id for detailed tenant information
- [ ] Task 2: Build tenant configuration management API (AC: 2)
  - [ ] Create PUT /api/v1/admin/tenants/:id/settings for settings updates
  - [ ] Implement GET /api/v1/admin/tenants/:id/features for feature toggle management
  - [ ] Add POST /api/v1/admin/tenants/:id/branding for branding configuration
  - [ ] Create PATCH /api/v1/admin/tenants/:id/limits for user limit adjustments
  - [ ] Implement tenant settings validation and constraints
- [ ] Task 3: Develop tenant isolation validation system (AC: 3)
  - [ ] Create tenant data isolation verification endpoints
  - [ ] Implement cross-tenant access prevention testing
  - [ ] Add tenant data integrity validation tools
  - [ ] Create tenant security audit functionality
  - [ ] Implement tenant boundary verification reports
- [ ] Task 4: Build admin dashboard with tenant metrics (AC: 4)
  - [ ] Create tenant usage statistics collection
  - [ ] Implement system health monitoring for multi-tenant operations
  - [ ] Add tenant performance metrics and analytics
  - [ ] Create tenant billing and usage reporting
  - [ ] Implement real-time tenant status monitoring
- [ ] Task 5: Create tenant onboarding wizard frontend (AC: 5)
  - [ ] Build step-by-step tenant creation wizard
  - [ ] Implement tenant configuration validation forms
  - [ ] Add tenant setup progress tracking
  - [ ] Create tenant verification and testing workflows
  - [ ] Implement tenant activation and welcome process
- [ ] Task 6: Build tenant management frontend interface (AC: 1, 2, 4)
  - [ ] Create tenant list view with search and filtering
  - [ ] Build tenant details view with editable settings
  - [ ] Implement tenant configuration forms with validation
  - [ ] Add tenant metrics dashboard with charts and analytics
  - [ ] Create tenant action controls (activate, deactivate, suspend)

## Dev Notes

### Previous Story Insights

[Source: Story 3.1 completion notes (anticipated)]

- Enhanced tenant table with configuration and isolation settings
- Tenant-aware repository pattern with automatic filtering
- Row-Level Security policies for database-level tenant isolation

[Source: Story 3.2 completion notes (anticipated)]

- Environment configuration system with multi-tenancy controls
- Configuration validation and consistency checking
- Single-tenant and multi-tenant mode support

### Technology Stack for Tenant Management

[Source: architecture/tech-stack.md]

- **Frontend Framework**: Angular 20+ with standalone components
- **UI Component Library**: PrimeNG 17+ for professional admin interfaces
- **State Management**: NgRx Signals 17+ for reactive tenant state
- **Backend Framework**: Express.js 4.19+ with TypeScript
- **Authentication**: JWT + Passport.js with admin role authorization
- **Database**: PostgreSQL 15+ with JSONB for tenant settings

### Frontend Architecture for Admin Interface

[Source: architecture/frontend-architecture.md] **Component Organization:**

```text
src/app/features/admin/
├── tenants/
│   ├── tenant-list/
│   │   ├── tenant-list.component.ts
│   │   └── tenant-list.component.html
│   ├── tenant-details/
│   │   ├── tenant-details.component.ts
│   │   └── tenant-details.component.html
│   ├── tenant-wizard/
│   │   ├── tenant-wizard.component.ts
│   │   └── tenant-wizard.component.html
│   └── tenant-dashboard/
│       ├── tenant-dashboard.component.ts
│       └── tenant-dashboard.component.html
├── services/
│   ├── tenant.service.ts
│   └── tenant-admin.service.ts
└── models/
    ├── tenant.interface.ts
    └── tenant-metrics.interface.ts
```

**Angular Component Template:**

```typescript
// features/admin/tenants/tenant-list/tenant-list.component.ts
import { Component, ChangeDetectionStrategy, signal, computed, inject } from '@angular/core';
import { CommonModule } from '@angular/common';
import { RouterModule } from '@angular/router';
import { TableModule } from 'primeng/table';
import { ButtonModule } from 'primeng/button';
import { TenantAdminService } from '../services/tenant-admin.service';

@Component({
  selector: 'app-tenant-list',
  standalone: true,
  imports: [CommonModule, RouterModule, TableModule, ButtonModule],
  template: `
    <div class="tenant-list-container">
      <div class="page-header">
        <h1>Tenant Management</h1>
        <p-button
          label="Create New Tenant"
          icon="pi pi-plus"
          routerLink="/admin/tenants/new"
        ></p-button>
      </div>

      <p-table [value]="tenants()" [loading]="loading()" [paginator]="true" [rows]="20">
        <ng-template pTemplate="header">
          <tr>
            <th>Name</th>
            <th>Slug</th>
            <th>Plan</th>
            <th>Users</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-tenant>
          <tr>
            <td>{{ tenant.name }}</td>
            <td>{{ tenant.slug }}</td>
            <td>{{ tenant.plan }}</td>
            <td>{{ tenant.userCount }}/{{ tenant.maxUsers }}</td>
            <td>
              <span
                class="status-badge"
                [class.active]="tenant.isActive"
                [class.inactive]="!tenant.isActive"
              >
                {{ tenant.isActive ? 'Active' : 'Inactive' }}
              </span>
            </td>
            <td>
              <p-button
                icon="pi pi-eye"
                [routerLink]="['/admin/tenants', tenant.id]"
                pTooltip="View Details"
              ></p-button>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  `,
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class TenantListComponent {
  private readonly tenantAdminService = inject(TenantAdminService);

  protected readonly tenants = signal<TenantWithMetrics[]>([]);
  protected readonly loading = signal(false);

  constructor() {
    this.loadTenants();
  }

  private async loadTenants(): Promise<void> {
    this.loading.set(true);
    try {
      const response = await this.tenantAdminService.getTenants();
      this.tenants.set(response.data);
    } finally {
      this.loading.set(false);
    }
  }
}
```

### Backend API Architecture for Tenant Management

[Source: architecture/backend-architecture.md] **API Endpoint Organization:**

```text
src/routes/admin/
├── tenant.routes.ts        # Tenant CRUD operations
├── tenant-settings.routes.ts  # Tenant configuration
├── tenant-metrics.routes.ts   # Analytics and monitoring
└── index.ts               # Admin routes aggregation

src/controllers/admin/
├── tenant.controller.ts   # Tenant management logic
└── tenant-metrics.controller.ts  # Dashboard analytics

src/services/admin/
├── tenant-admin.service.ts    # Admin tenant operations
└── tenant-metrics.service.ts  # Metrics collection
```

**Tenant Admin Controller Template:**

```typescript
// controllers/admin/tenant.controller.ts
import { Request, Response, NextFunction } from 'express';
import { TenantAdminService } from '../services/tenant-admin.service';
import { AsyncHandler } from '../utils/async-handler';
import { ApiError } from '../utils/api-error';

export class TenantController {
  constructor(private tenantAdminService: TenantAdminService) {}

  getTenants = AsyncHandler(async (req: Request, res: Response, next: NextFunction) => {
    const { page = 1, limit = 20, search, status } = req.query;

    const tenants = await this.tenantAdminService.getTenants({
      page: Number(page),
      limit: Number(limit),
      search: search as string,
      status: status as string,
    });

    res.json({
      success: true,
      data: tenants.data,
      pagination: tenants.pagination,
    });
  });

  createTenant = AsyncHandler(async (req: Request, res: Response, next: NextFunction) => {
    const tenantData = req.body;

    const tenant = await this.tenantAdminService.createTenant(tenantData);

    res.status(201).json({
      success: true,
      data: tenant,
      message: 'Tenant created successfully',
    });
  });

  updateTenantSettings = AsyncHandler(async (req: Request, res: Response, next: NextFunction) => {
    const { tenantId } = req.params;
    const settings = req.body;

    const updatedTenant = await this.tenantAdminService.updateSettings(tenantId, settings);

    res.json({
      success: true,
      data: updatedTenant,
      message: 'Tenant settings updated successfully',
    });
  });
}
```

### Project Structure for Tenant Management

[Source: architecture/unified-project-structure.md] **Frontend Files:**

- Admin feature module: `apps/web/src/app/features/admin/`
- Tenant components: `apps/web/src/app/features/admin/tenants/`
- Admin services: `apps/web/src/app/features/admin/services/`
- Admin routing: `apps/web/src/app/features/admin/admin.routes.ts`

**Backend Files:**

- Admin routes: `apps/api/src/routes/admin/`
- Admin controllers: `apps/api/src/controllers/admin/`
- Admin services: `apps/api/src/services/admin/`
- Admin middleware: `apps/api/src/middleware/admin.middleware.ts`

### Data Models for Tenant Management

[Source: architecture/data-models.md] **Extended Tenant Interface:**

```typescript
interface TenantWithMetrics extends Tenant {
  userCount: number;
  storageUsed: number;
  lastActivity: Date;
  billingStatus: 'active' | 'past_due' | 'canceled';
  features: {
    enabled: string[];
    limits: Record<string, number>;
  };
}

interface TenantMetrics {
  totalUsers: number;
  activeUsers: number;
  storageUsed: number;
  apiCalls: number;
  lastActivity: Date;
  performance: {
    averageResponseTime: number;
    errorRate: number;
  };
}

interface TenantSettings {
  branding: {
    primaryColor: string;
    logo: string;
    favicon: string;
  };
  features: Record<string, boolean>;
  limits: {
    maxUsers: number;
    maxStorage: number;
    maxApiCalls: number;
  };
  security: {
    requireMFA: boolean;
    sessionTimeout: number;
    passwordPolicy: object;
  };
}
```

### Tenant Management Service Implementation

**Frontend Service:**

```typescript
// features/admin/services/tenant-admin.service.ts
import { Injectable, inject } from '@angular/core';
import { ApiClient } from '@core/api/api.client';
import { Observable } from 'rxjs';

@Injectable({ providedIn: 'root' })
export class TenantAdminService {
  private readonly api = inject(ApiClient);

  getTenants(params: TenantQueryParams): Observable<PaginatedResponse<TenantWithMetrics>> {
    const queryParams = new URLSearchParams(params as any).toString();
    return this.api.get<PaginatedResponse<TenantWithMetrics>>(`/admin/tenants?${queryParams}`);
  }

  createTenant(tenantData: CreateTenantRequest): Observable<Tenant> {
    return this.api.post<Tenant>('/admin/tenants', tenantData);
  }

  updateTenantSettings(tenantId: string, settings: TenantSettings): Observable<Tenant> {
    return this.api.put<Tenant>(`/admin/tenants/${tenantId}/settings`, settings);
  }

  getTenantMetrics(tenantId: string): Observable<TenantMetrics> {
    return this.api.get<TenantMetrics>(`/admin/tenants/${tenantId}/metrics`);
  }

  validateTenantIsolation(tenantId: string): Observable<ValidationResult> {
    return this.api.post<ValidationResult>(`/admin/tenants/${tenantId}/validate-isolation`);
  }
}
```

### Tenant Onboarding Wizard

**Multi-step Wizard Component:**

```typescript
// features/admin/tenants/tenant-wizard/tenant-wizard.component.ts
import { Component, signal } from '@angular/core';
import { StepsModule } from 'primeng/steps';
import { MenuItem } from 'primeng/api';

@Component({
  selector: 'app-tenant-wizard',
  template: `
    <div class="tenant-wizard">
      <p-steps [model]="wizardSteps" [activeIndex]="currentStep()"></p-steps>

      <div class="wizard-content">
        @switch (currentStep()) {
          @case (0) {
            <app-tenant-basic-info />
          }
          @case (1) {
            <app-tenant-configuration />
          }
          @case (2) {
            <app-tenant-branding />
          }
          @case (3) {
            <app-tenant-review />
          }
        }
      </div>

      <div class="wizard-actions">
        <p-button
          label="Previous"
          (onClick)="previousStep()"
          [disabled]="currentStep() === 0"
        ></p-button>
        <p-button
          label="Next"
          (onClick)="nextStep()"
          [disabled]="currentStep() === wizardSteps.length - 1"
        ></p-button>
        @if (currentStep() === wizardSteps.length - 1) {
          <p-button label="Create Tenant" (onClick)="createTenant()" severity="success"></p-button>
        }
      </div>
    </div>
  `,
})
export class TenantWizardComponent {
  protected readonly currentStep = signal(0);
  protected readonly wizardSteps: MenuItem[] = [
    { label: 'Basic Information' },
    { label: 'Configuration' },
    { label: 'Branding' },
    { label: 'Review & Create' },
  ];

  nextStep(): void {
    if (this.currentStep() < this.wizardSteps.length - 1) {
      this.currentStep.update((step) => step + 1);
    }
  }

  previousStep(): void {
    if (this.currentStep() > 0) {
      this.currentStep.update((step) => step - 1);
    }
  }
}
```

### Authorization and Security

**Admin Authorization Middleware:**

```typescript
// middleware/admin.middleware.ts
export const requireAdminRole = (req: AuthRequest, res: Response, next: NextFunction) => {
  if (!req.user) {
    throw new ApiError(401, 'Authentication required');
  }

  if (req.user.role !== 'admin') {
    throw new ApiError(403, 'Admin access required');
  }

  next();
};

export const requireSuperAdmin = (req: AuthRequest, res: Response, next: NextFunction) => {
  if (!req.user || !['admin', 'super_admin'].includes(req.user.role)) {
    throw new ApiError(403, 'Super admin access required');
  }

  next();
};
```

## Testing

### Test File Locations

[Source: architecture/testing-strategy.md]

- **Frontend Tests**: `apps/web/src/app/features/admin/tenants/**/*.spec.ts`
- **Backend API Tests**: `apps/api/tests/integration/admin/`
- **E2E Tests**: `e2e/specs/admin/tenant-management.spec.ts`

### Testing Requirements

- Tenant CRUD operations testing
- Tenant isolation validation testing
- Admin authorization and role-based access testing
- Tenant configuration validation testing
- Onboarding wizard flow testing
- Tenant metrics and dashboard functionality testing
- Cross-tenant security boundary testing

### Test Examples Pattern

```typescript
// Tenant management testing
describe('Tenant Admin API', () => {
  it('should create tenant with admin authorization', async () => {
    const adminToken = await getAdminToken();

    const response = await request(app)
      .post('/api/v1/admin/tenants')
      .set('Authorization', `Bearer ${adminToken}`)
      .send({
        name: 'Test Company',
        slug: 'test-company',
        plan: 'professional',
      });

    expect(response.status).toBe(201);
    expect(response.body.data.name).toBe('Test Company');
  });

  it('should prevent non-admin access to tenant management', async () => {
    const userToken = await getUserToken();

    const response = await request(app)
      .get('/api/v1/admin/tenants')
      .set('Authorization', `Bearer ${userToken}`);

    expect(response.status).toBe(403);
  });

  it('should validate tenant isolation', async () => {
    const adminToken = await getAdminToken();
    const tenantId = await createTestTenant();

    const response = await request(app)
      .post(`/api/v1/admin/tenants/${tenantId}/validate-isolation`)
      .set('Authorization', `Bearer ${adminToken}`);

    expect(response.status).toBe(200);
    expect(response.body.data.isolationValid).toBe(true);
  });
});
```

## Change Log

| Date       | Version | Description                                            | Author             |
| ---------- | ------- | ------------------------------------------------------ | ------------------ |
| 2025-09-21 | 1.0     | Initial story creation for tenant management interface | Bob (Scrum Master) |
