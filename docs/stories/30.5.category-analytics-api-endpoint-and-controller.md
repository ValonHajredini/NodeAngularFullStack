# Story 30.5: Category Analytics API Endpoint and Controller

## Status

Draft

## Story

**As a** backend developer, **I want** a REST API endpoint for category-specific analytics, **so
that** frontend can fetch aggregated metrics.

## Acceptance Criteria

1. `CategoryAnalyticsController` created
2. `GET /api/analytics/:formId/category-metrics` endpoint implemented
3. Authentication and validation middleware
4. JSDoc for Swagger documentation
5. Routes registered
6. Error handling with `ApiError`
7. Integration tests (all categories + auth)

## Tasks / Subtasks

- [ ] **Task 1: Implement `CategoryAnalyticsController`** (AC: 1, 2, 6)
  - [ ] Create `apps/api/src/controllers/category-analytics.controller.ts` with a
        `getCategoryMetrics` handler that accepts `{ formId }`, resolves tenant/user context, and
        delegates to the analytics service/registry.
        `[Source: docs/architecture/backend-architecture.md#service-architecture]`
  - [ ] Wrap handler logic with the shared `AsyncHandler` pattern and throw `ApiError` for
        unauthorized access or missing forms, following the documented error flow.
        `[Source: docs/architecture/error-handling-strategy.md#error-flow]`

- [ ] **Task 2: Add analytics service method** (AC: 2)
  - [ ] Introduce `apps/api/src/services/analytics/category-analytics.service.ts` that calls the
        strategy registry, passes through tenant metadata, and normalizes responses into
        `CategoryMetrics`.
        `[Source: docs/architecture/backend-architecture.md#service-architecture]`
  - [ ] Verify service imports shared DTOs from `@nodeangularfullstack/shared` to honor the
        type-sharing rule.
        `[Source: docs/architecture/coding-standards.md#critical-fullstack-rules]`

- [ ] **Task 3: Wire Express route + middleware** (AC: 2, 3, 5)
  - [ ] Add `apps/api/src/routes/analytics.routes.ts` registering
        `GET /api/analytics/:formId/category-metrics`, applying authentication (`authenticate`),
        tenant resolution, and request validation middleware.
        `[Source: docs/architecture/backend-architecture.md#authentication-and-authorization]`
  - [ ] Mount the route in `apps/api/src/routes/index.ts`, ensuring versioned prefixes align with
        the shared API specification.
        `[Source: docs/architecture/api-specification.md#rest-api-specification]`

- [ ] **Task 4: Input validation + DTOs** (AC: 3)
  - [ ] Create `analytics.validator.ts` using Joi/class-validator to ensure `formId` is
        UUID/kebab-case and that optional query parameters (date range) conform to allowed formats.
        `[Source: docs/architecture/backend-architecture.md#service-architecture]`
  - [ ] Reuse shared enums (TemplateCategory) from Story 30.1, keeping the validation logic in sync
        with type definitions. `[Source: docs/architecture/source-tree.md#packagesshared]`

- [ ] **Task 5: Document endpoint (Swagger)** (AC: 4)
  - [ ] Annotate controller methods with JSDoc that describe request path, auth requirements,
        success payload (CategoryMetrics union), and error responses, aligning with the OpenAPI
        style in the architecture spec.
        `[Source: docs/architecture/api-specification.md#rest-api-specification]`

- [ ] **Task 6: Harden error handling** (AC: 6)
  - [ ] Ensure controller raises `ApiError` with codes like `ANALYTICS_NOT_FOUND` or `UNAUTHORIZED`
        so middleware can emit the standardized JSON error format.
        `[Source: docs/architecture/error-handling-strategy.md#error-response-format]`
  - [ ] Include logging hooks consistent with the backend error strategy for observability.
        `[Source: docs/architecture/error-handling-strategy.md#error-flow]`

- [ ] **Task 7: Integration tests covering categories + auth** (AC: 7)
  - [ ] Write Supertest specs under
        `apps/api/tests/integration/analytics/category-analytics.test.ts` that seed poll, quiz,
        product, appointment, restaurant, and services forms, then assert category-specific payloads
        and fallback behavior. `[Source: docs/architecture/testing-strategy.md#backend-api-test]`
  - [ ] Add tests for authentication failure, invalid formId, and missing category metadata to
        ensure middleware + ApiError flow behave per spec.
        `[Source: docs/architecture/backend-architecture.md#authentication-and-authorization]`

## Dev Notes

### Previous Story Insights

- No specific guidance found in architecture docs.

### Data Models

- Analytics data originates from the FORMS database tables (`forms`, `form_schemas`,
  `form_submissions`), so the endpoint must pass tenant/form context down to repositories that query
  those tables.
  `[Source: docs/architecture/database-separation-implementation-summary.md#forms-database-nodeangularfullstack_forms]`
- JSONB storage for submissions, as highlighted in the architecture diagrams, means controller DTOs
  should accept string identifiers while repositories handle JSON parsing.
  `[Source: docs/architecture/epic-18-architecture-diagram.md#storage--database]`

### API Specifications

- The REST API spec establishes JWT bearer authentication, `/api/v1` prefixing, and standardized
  response payloads, all of which must be reflected in the new analytics endpoint.
  `[Source: docs/architecture/api-specification.md#rest-api-specification]`

### Component Specifications

- No specific guidance found in architecture docs.

### File Locations

- Controllers reside under `apps/api/src/controllers`, routes under `apps/api/src/routes`,
  middleware under `apps/api/src/middleware`, and validators under `apps/api/src/validators`, so the
  analytics endpoint must follow that folder structure.
  `[Source: docs/architecture/source-tree.md#backend-structure-appsapi]`
- Shared DTOs consumed by the endpoint live in `packages/shared/src/types`, honoring the monorepoâ€™s
  type-sharing discipline. `[Source: docs/architecture/source-tree.md#packagesshared]`

### Testing Requirements

- Integration tests for Express controllers belong under `apps/api/tests/integration` and should use
  Supertest + Jest as documented in the backend testing guide.
  `[Source: docs/architecture/testing-strategy.md#backend-api-test]`
- Additional unit tests for validators/middleware can live under `apps/api/tests/unit` to ensure
  parameter parsing is reliable. `[Source: docs/architecture/testing-strategy.md#backend-tests]`

### Technical Constraints

- Authentication/authorization middleware defined in the backend architecture (JWT validation,
  tenant loading) must wrap this endpoint to keep analytics secure.
  `[Source: docs/architecture/backend-architecture.md#authentication-and-authorization]`
- Error handling needs to emit the centralized ApiError JSON payload for all failure modes to stay
  consistent with the global strategy.
  `[Source: docs/architecture/error-handling-strategy.md#error-response-format]`
- Backend performance targets still apply, so controller/service logic should remain thin and
  delegate heavy work to optimized strategies/repositories.
  `[Source: docs/architecture/security-and-performance.md#performance-optimization]`

## Testing

- Follow the documented Supertest workflow to hit `/api/analytics/:formId/category-metrics` with and
  without auth headers, ensuring strategy outputs match seeded data.
  `[Source: docs/architecture/testing-strategy.md#backend-api-test]`
- Supplement integration coverage with validator/service unit tests located in the backend unit test
  folders for deterministic failure modes.
  `[Source: docs/architecture/testing-strategy.md#backend-tests]`

## Change Log

| Date       | Version | Description                          | Author             |
| ---------- | ------- | ------------------------------------ | ------------------ |
| 2025-01-27 | 1.0     | Initial story draft and task outline | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be populated by the development agent._

### Debug Log References

_To be populated by the development agent._

### Completion Notes List

_To be populated by the development agent._

### File List

_To be populated by the development agent._

## QA Results

_QA review not yet executed for this draft._
