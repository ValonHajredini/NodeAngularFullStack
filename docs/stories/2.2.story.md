# Story 2.2: Database Management Interface

## Status
Draft

## Story
**As a** developer,
**I want** browser-based database management tools,
**so that** I can inspect and modify data during development without command-line tools.

## Acceptance Criteria
1. pgWeb interface integrated into Docker environment with secure access
2. Database tables, relationships, and indexes visible through web interface
3. Ability to execute SQL queries and view results within the management interface
4. Data export and import capabilities for backup and testing scenarios
5. User management interface shows seed users and allows role modifications

## Tasks / Subtasks
- [ ] Task 1: Setup pgWeb container in Docker environment (AC: 1)
  - [ ] Add pgWeb service to docker-compose.yml configuration
  - [ ] Configure secure connection to PostgreSQL database
  - [ ] Set up environment variables for database connection
  - [ ] Configure port mapping and network access
- [ ] Task 2: Configure pgWeb security and access control (AC: 1)
  - [ ] Set up authentication for pgWeb interface
  - [ ] Configure database connection permissions
  - [ ] Implement secure session management
  - [ ] Add development-only access restrictions
- [ ] Task 3: Integrate database schema visualization (AC: 2)
  - [ ] Verify all existing tables are visible (users, tenants, sessions)
  - [ ] Display table relationships and foreign key constraints
  - [ ] Show database indexes and performance information
  - [ ] Add schema documentation integration
- [ ] Task 4: Implement SQL query interface (AC: 3)
  - [ ] Enable SQL query execution with syntax highlighting
  - [ ] Add query result display with pagination
  - [ ] Implement query history and saved queries
  - [ ] Add query performance analysis tools
- [ ] Task 5: Setup data export and import functionality (AC: 4)
  - [ ] Configure CSV/JSON export capabilities
  - [ ] Add database backup and restore functions
  - [ ] Implement selective table data export
  - [ ] Set up data import validation and error handling
- [ ] Task 6: Create user management interface integration (AC: 5)
  - [ ] Display all seed users with roles and status
  - [ ] Enable user role modification through interface
  - [ ] Add user account activation/deactivation controls
  - [ ] Implement user data editing with validation
- [ ] Task 7: Implement comprehensive testing (AC: 1-5)
  - [ ] Test pgWeb container startup and connectivity
  - [ ] Verify database schema visualization accuracy
  - [ ] Test SQL query execution and result display
  - [ ] Validate data export/import functionality
  - [ ] Test user management operations

## Dev Notes

### Previous Story Insights
[Source: Story 1.7 completion notes]
- PostgreSQL database fully configured with users, tenants, and sessions tables
- Database seed data includes test users: admin@example.com, user@example.com, readonly@example.com
- Multi-tenancy support implemented with tenant_id relationships
- Database connection established through Docker environment
- Password hashing and validation implemented for user accounts

### Technology Stack for Database Management
[Source: architecture/tech-stack.md]
- **Database**: PostgreSQL 15+ with ACID compliance and JSON support
- **Container Orchestration**: Docker Compose 2.23+ for infrastructure management
- **Database Administration**: pgWeb for browser-based database management
- **Environment Configuration**: Docker environment variables for secure connections

### Docker Infrastructure Integration
[Source: architecture/unified-project-structure.md]
**Docker Compose Structure:**
```yaml
# infrastructure/docker-compose.yml
services:
  pgweb:
    image: sosedoff/pgweb:latest
    container_name: pgweb
    ports:
      - "8081:8081"
    environment:
      - PGWEB_DATABASE_URL=postgresql://user:password@postgres:5432/database
      - PGWEB_AUTH_USER=admin
      - PGWEB_AUTH_PASS=secure_password
    depends_on:
      - postgres
    networks:
      - app-network
```

**File Locations:**
- **Docker Configuration**: `infrastructure/docker-compose.yml`
- **Environment Variables**: `.env` file with database credentials
- **Setup Scripts**: `scripts/setup-pgweb.sh`
- **Documentation**: `docs/development-workflow.md`

### Database Schema Integration
[Source: architecture/data-models.md]
**Existing Database Tables to Manage:**
```sql
-- Core tables that pgWeb will visualize
users (
  id UUID PRIMARY KEY,
  email VARCHAR UNIQUE,
  password_hash VARCHAR,
  first_name VARCHAR,
  last_name VARCHAR,
  role user_role_enum,
  tenant_id UUID REFERENCES tenants(id),
  created_at TIMESTAMP,
  updated_at TIMESTAMP,
  last_login TIMESTAMP,
  is_active BOOLEAN,
  email_verified BOOLEAN
)

tenants (
  id UUID PRIMARY KEY,
  name VARCHAR,
  slug VARCHAR UNIQUE,
  settings JSONB,
  plan plan_enum,
  max_users INTEGER,
  created_at TIMESTAMP,
  is_active BOOLEAN
)

sessions (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  refresh_token VARCHAR,
  expires_at TIMESTAMP,
  ip_address INET,
  user_agent TEXT,
  created_at TIMESTAMP
)
```

### pgWeb Configuration Requirements
[Source: architecture/backend-architecture.md]
**Security Configuration:**
- Authentication required for production environments
- Read-only access for production databases
- Full access allowed only in development environment
- Connection pooling and timeout configuration
- SSL encryption for database connections

**Access Control Pattern:**
```bash
# Environment-specific access
PGWEB_AUTH_USER=admin
PGWEB_AUTH_PASS=development_password
PGWEB_READ_ONLY=false  # Development only
PGWEB_SESSIONS=true
PGWEB_CORS_ORIGIN=http://localhost:4200
```

### Development Workflow Integration
[Source: architecture/development-workflow.md]
**Database Development Commands:**
```bash
# Start pgWeb with database
docker-compose up postgres pgweb

# Access pgWeb interface
open http://localhost:8081

# Execute database migrations
npm run migrate

# Seed database with test data
npm run seed
```

**Required Environment Variables:**
- `DATABASE_URL`: PostgreSQL connection string
- `PGWEB_AUTH_USER`: pgWeb authentication username
- `PGWEB_AUTH_PASS`: pgWeb authentication password
- `PGWEB_DATABASE_URL`: Database connection for pgWeb

### Data Export/Import Specifications
[Source: architecture/backend-architecture.md]
**Export Formats Supported:**
- CSV: For spreadsheet compatibility
- JSON: For application data exchange
- SQL: For database backup and migration
- TSV: For tab-separated value files

**Import Validation Requirements:**
- Data type validation for all columns
- Foreign key constraint verification
- Duplicate detection and handling
- Error logging and rollback capabilities

### User Management Interface Requirements
[Source: architecture/data-models.md]
**User Management Operations:**
- View all users with role, status, and tenant information
- Modify user roles: admin, user, readonly
- Activate/deactivate user accounts (is_active field)
- Edit user profile information (first_name, last_name)
- View user session history and login activity
- Manage tenant associations for multi-tenancy

**Seed User Data Display:**
```
Admin User: admin@example.com (role: admin, active: true)
Regular User: user@example.com (role: user, active: true)
Read-Only User: readonly@example.com (role: readonly, active: true)
```

### Security and Performance Considerations
[Source: architecture/backend-architecture.md]
**Security Measures:**
- Authentication required for all access
- Database connection encryption (SSL)
- Query execution logging for audit trails
- Rate limiting for query execution
- Development-only deployment restrictions

**Performance Configuration:**
- Connection pooling for database efficiency
- Query timeout limits to prevent long-running queries
- Result set pagination for large datasets
- Index utilization analysis tools

### Testing Standards
[Source: architecture/testing-strategy.md]
**Test File Location**: `apps/api/tests/integration/pgweb.test.ts`

**Required Test Cases:**
- pgWeb container startup and health checks
- Database connection and authentication
- Table schema visualization accuracy
- SQL query execution and result formatting
- Data export functionality in multiple formats
- User management interface operations
- Security access controls and authentication

**Testing Framework**: Jest + Docker test containers for integration testing

### Docker Networking Configuration
[Source: architecture/unified-project-structure.md]
**Network Setup:**
```yaml
networks:
  app-network:
    driver: bridge

services:
  postgres:
    networks:
      - app-network

  pgweb:
    networks:
      - app-network
```

**Service Dependencies:**
- pgWeb depends on PostgreSQL container
- Shared network for secure inter-container communication
- Port exposure only for development environment
- Health checks for service availability

## Testing

### Test File Locations
[Source: architecture/testing-strategy.md]
- **Integration Tests**: `apps/api/tests/integration/pgweb.test.ts`
- **Docker Tests**: `infrastructure/tests/docker-compose.test.ts`

### Testing Requirements
- Test Docker container startup and connectivity
- Verify pgWeb authentication and security
- Test database schema visualization and relationships
- Validate SQL query execution and result display
- Test data export/import functionality
- Verify user management interface operations
- Test performance and connection pooling

### Test Examples Pattern
```typescript
// pgweb.test.ts
describe('pgWeb Database Management', () => {
  it('should start pgWeb container successfully', async () => {
    // Test container startup and health
  });

  it('should authenticate and connect to database', async () => {
    // Test authentication flow
  });

  it('should display all database tables and relationships', async () => {
    // Test schema visualization
  });

  it('should execute SQL queries and return results', async () => {
    // Test query execution
  });
});
```

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-20 | 1.0 | Initial story creation for pgWeb database management interface | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
- (To be filled by Dev Agent)

### Debug Log References
- (To be filled by Dev Agent)

### Completion Notes
- (To be filled by Dev Agent)

### File List
- (To be filled by Dev Agent)

## QA Results
- (To be filled by QA Agent)