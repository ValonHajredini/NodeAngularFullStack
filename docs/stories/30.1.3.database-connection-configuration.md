# Story 30.1.3: Database Connection Configuration

## Status

Draft

## Story

**As a** backend developer, **I want** centralized database configuration, **so that** connection
management is consistent across the app.

## Acceptance Criteria

1. ✅ Database config in `src/config/database.config.ts`
2. ✅ Connection pooling configured (max 20 connections)
3. ✅ Health check query support
4. ✅ Environment variable support
5. ✅ Error handling for connection failures

## Tasks / Subtasks

- [ ] **Task 1: Create database configuration module** (AC: 1, 2, 4)
  - [ ] Create `database.config.ts` in `apps/api/src/config/`
  - [ ] Import Pool and PoolConfig from pg
  - [ ] Load dotenv for environment variables
  - [ ] Configure poolConfig with environment variables (DB_HOST, DB_PORT, DB_USER, DB_PASSWORD,
        DB_NAME)
  - [ ] Set max pool size to 20 connections
  - [ ] Set idleTimeoutMillis to 30000 (30 seconds)
  - [ ] Set connectionTimeoutMillis to 2000 (2 seconds)
  - [ ] Export pool instance for use across application

- [ ] **Task 2: Implement health check function** (AC: 3)
  - [ ] Create `checkDatabaseConnection()` async function
  - [ ] Execute `SELECT 1` query to verify connectivity
  - [ ] Return `true` if successful, `false` if error
  - [ ] Log errors with descriptive context (do NOT throw, just log and return false)
  - [ ] Export function for use in health check endpoints

- [ ] **Task 3: Implement graceful shutdown** (AC: 5)
  - [ ] Create `closeDatabaseConnection()` async function
  - [ ] Call `pool.end()` to close all connections gracefully
  - [ ] Export function for server shutdown hooks
  - [ ] Add error event handler: `pool.on('error', callback)` for unexpected errors

- [ ] **Task 4: Add JSDoc documentation** (AC: 1-5)
  - [ ] Document database.config.ts module purpose
  - [ ] Document pool configuration options
  - [ ] Document health check function usage
  - [ ] Document graceful shutdown function
  - [ ] Include examples for common use cases

- [ ] **Task 5: Create .env.example updates** (AC: 4)
  - [ ] Add database connection variables to `.env.example` at project root
  - [ ] Document each variable with inline comments
  - [ ] Provide sensible default values for local development

- [ ] **Task 6: Write configuration tests** (AC: 2, 3, 5)
  - [ ] Create `database.config.test.ts` in `apps/api/tests/unit/config/`
  - [ ] Test: Pool created with correct configuration
  - [ ] Test: Health check returns true with valid connection
  - [ ] Test: Health check returns false with invalid credentials (mock failure)
  - [ ] Test: Graceful shutdown closes pool without errors
  - [ ] Test: Error event handler logs errors

## Dev Notes

### Database Connection Pattern

[Source: architecture/backend-architecture.md#data-access-layer]

The codebase uses `pg` (node-postgres) with connection pooling. The Pool should be created once and
shared across all repositories:

```typescript
import { Pool, PoolConfig } from 'pg';

const pool = new Pool(poolConfig);

export { pool }; // Export singleton instance
```

### Pool Configuration Best Practices

**Connection Limits:**

- `max: 20` - Maximum 20 connections in pool (prevents overwhelming PostgreSQL)
- `idleTimeoutMillis: 30000` - Close idle connections after 30 seconds
- `connectionTimeoutMillis: 2000` - Fail fast if connection takes > 2 seconds

**Why these limits?**

- PostgreSQL default max_connections = 100
- Leave headroom for other services and admin connections
- 20 connections sufficient for moderate API load

### Environment Variable Pattern

[Source: architecture/coding-standards.md#critical-fullstack-rules]

**CRITICAL:** Access environment variables only through config objects, never `process.env`
directly:

```typescript
// ✅ CORRECT - Centralized config
import { config } from 'dotenv';
config();

const poolConfig: PoolConfig = {
  host: process.env.DB_HOST || 'localhost',
  port: parseInt(process.env.DB_PORT || '5432'),
  // ...
};

// ❌ WRONG - Direct process.env access in service layer
const dbHost = process.env.DB_HOST; // Don't do this outside config files
```

### Project Structure

[Source: architecture/unified-project-structure.md]

```
apps/api/
├── src/
│   ├── config/
│   │   ├── database.config.ts   # <-- New file
│   │   └── app.config.ts        # Existing pattern
│   ├── repositories/
│   │   └── tool-registry.repository.ts  # Will import pool from database.config
│   └── server.ts                # Will use health check and graceful shutdown
├── tests/
│   └── unit/
│       └── config/
│           └── database.config.test.ts  # <-- New test file
├── .env.example                 # <-- Update with DB variables
└── package.json
```

### Health Check Integration

The health check function will be used in API health check endpoints (Epic 30.2):

```typescript
// Future usage in Epic 30.2
app.get('/health', async (req, res) => {
  const dbHealthy = await checkDatabaseConnection();

  res.status(dbHealthy ? 200 : 503).json({
    status: dbHealthy ? 'healthy' : 'unhealthy',
    database: dbHealthy ? 'connected' : 'disconnected',
    timestamp: new Date().toISOString(),
  });
});
```

### Graceful Shutdown Pattern

The graceful shutdown function should be called when the server receives termination signals:

```typescript
// Future usage in server.ts
process.on('SIGTERM', async () => {
  console.log('SIGTERM received, closing database connections...');
  await closeDatabaseConnection();
  process.exit(0);
});

process.on('SIGINT', async () => {
  console.log('SIGINT received, closing database connections...');
  await closeDatabaseConnection();
  process.exit(0);
});
```

### Error Event Handler

PostgreSQL connections can error unexpectedly (network issues, server restart). Log these for
monitoring:

```typescript
pool.on('error', (err) => {
  console.error('Unexpected database error:', err);
  // Don't exit process - let reconnection logic handle it
});
```

### Database Configuration Example from PRD

```typescript
// src/config/database.config.ts
import { Pool, PoolConfig } from 'pg';
import { config } from 'dotenv';

config();

const poolConfig: PoolConfig = {
  host: process.env.DB_HOST || 'localhost',
  port: parseInt(process.env.DB_PORT || '5432'),
  user: process.env.DB_USER || 'dbuser',
  password: process.env.DB_PASSWORD || 'dbpassword',
  database: process.env.DB_NAME || 'nodeangularfullstack',
  max: 20, // Maximum pool size
  idleTimeoutMillis: 30000,
  connectionTimeoutMillis: 2000,
};

export const pool = new Pool(poolConfig);

// Health check
export async function checkDatabaseConnection(): Promise<boolean> {
  try {
    await pool.query('SELECT 1');
    return true;
  } catch (error) {
    console.error('Database connection failed:', error);
    return false;
  }
}

// Graceful shutdown
export async function closeDatabaseConnection(): Promise<void> {
  await pool.end();
}

// Error handling
pool.on('error', (err) => {
  console.error('Unexpected database error:', err);
});
```

### Environment Variables

Add to `.env.example`:

```bash
# Database Configuration
DB_HOST=localhost           # PostgreSQL host
DB_PORT=5432               # PostgreSQL port
DB_USER=dbuser             # Database user
DB_PASSWORD=dbpassword     # Database password
DB_NAME=nodeangularfullstack  # Database name
```

Add to `.env.development` (should already exist):

```bash
DB_HOST=localhost
DB_PORT=5432
DB_USER=dbuser
DB_PASSWORD=dbpassword
DB_NAME=nodeangularfullstack
```

### Technology Stack

[Source: architecture/tech-stack.md]

- **Database:** PostgreSQL 15+
- **Connection Library:** pg (node-postgres) v8.11+
- **Configuration:** dotenv v16.3+ for environment variables

### Testing

[Source: architecture/testing-strategy.md#backend-tests]

**Unit Test Pattern:**

```typescript
import { pool, checkDatabaseConnection, closeDatabaseConnection } from '../../../src/config/database.config';

describe('Database Configuration', () => {
  describe('Pool Configuration', () => {
    it('should create pool with correct settings', () => {
      expect(pool).toBeDefined();
      // Note: Cannot test internal pool settings directly, verify via behavior
    });
  });

  describe('checkDatabaseConnection', () => {
    it('should return true when connection succeeds', async () => {
      // Mock successful query
      jest.spyOn(pool, 'query').mockResolvedValue({ rows: [{ ?column?: 1 }] } as any);

      const result = await checkDatabaseConnection();

      expect(result).toBe(true);
      expect(pool.query).toHaveBeenCalledWith('SELECT 1');
    });

    it('should return false when connection fails', async () => {
      // Mock failed query
      jest.spyOn(pool, 'query').mockRejectedValue(new Error('Connection failed'));

      const result = await checkDatabaseConnection();

      expect(result).toBe(false);
    });
  });

  describe('closeDatabaseConnection', () => {
    it('should close pool without errors', async () => {
      jest.spyOn(pool, 'end').mockResolvedValue();

      await expect(closeDatabaseConnection()).resolves.not.toThrow();
      expect(pool.end).toHaveBeenCalled();
    });
  });

  describe('Error Event Handler', () => {
    it('should log unexpected errors', () => {
      const consoleErrorSpy = jest.spyOn(console, 'error').mockImplementation();

      // Trigger error event
      pool.emit('error', new Error('Unexpected error'));

      expect(consoleErrorSpy).toHaveBeenCalledWith(
        'Unexpected database error:',
        expect.any(Error)
      );

      consoleErrorSpy.mockRestore();
    });
  });
});
```

**Integration Test Note:** Integration tests will be in Story 30.1.4 and will use the real database
configuration.

### Documentation Standards

[Source: architecture/coding-standards.md#documentation-standards]

**JSDoc Example:**

```typescript
/**
 * Database connection pool configuration.
 * Provides centralized PostgreSQL connection management with pooling.
 *
 * @module database.config
 *
 * @example
 * import { pool } from './config/database.config';
 *
 * const result = await pool.query('SELECT * FROM users');
 */

/**
 * Checks database connectivity by executing a simple query.
 * Does not throw errors - returns false on failure for graceful degradation.
 *
 * @returns Promise resolving to true if connected, false otherwise
 *
 * @example
 * const isHealthy = await checkDatabaseConnection();
 * if (!isHealthy) {
 *   console.warn('Database unavailable, using cache');
 * }
 */
export async function checkDatabaseConnection(): Promise<boolean> {
  // Implementation
}
```

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-10-23 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be completed by dev agent_

### Debug Log References

_To be completed by dev agent_

### Completion Notes List

_To be completed by dev agent_

### File List

_To be completed by dev agent_

## QA Results

_To be completed by QA agent_
