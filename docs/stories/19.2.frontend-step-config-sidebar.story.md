# Story 19.2: Frontend - Step Configuration UI in Sidebar

## Status

Draft

## Story

**As a** form builder user, **I want** to enable step form mode and configure steps via the right
sidebar, **so that** I can create multi-step forms with custom step titles and descriptions.

## Acceptance Criteria

1. User can toggle step form mode on/off
2. Enabling step form creates default first step and migrates existing fields
3. User can add up to 10 steps total
4. User can reorder steps via drag-and-drop
5. User can edit step title and description via modal dialog
6. User can delete steps (except when only 1 step remains)
7. Step configuration persists when saving form
8. Component tests achieve >80% coverage

## Tasks / Subtasks

- [ ] **Task 1: Create StepFormSidebarComponent** (AC: 1, 2, 3, 6, 7)
  - [ ] Create
        `apps/web/src/app/features/tools/components/form-builder/step-form-sidebar/step-form-sidebar.component.ts`
  - [ ] Make component standalone with required Angular imports:
    - `CommonModule`, `FormsModule`, `ReactiveFormsModule`
    - PrimeNG: `ButtonModule`, `ToggleButtonModule`, `PanelModule`, `DialogModule`,
      `InputTextModule`, `InputTextareaModule`, `DragDropModule`
  - [ ] Add component selector: `app-step-form-sidebar`
  - [ ] Use OnPush change detection strategy
  - [ ] Inject `FormBuilderService` for state management
  - [ ] Add template with three main sections:
    - Toggle switch: "Enable Step Form" with p-toggleButton
    - Step list: Display all steps with drag handles
    - Add button: "Add Step" with p-button (primary style)
  - [ ] Add JSDoc documentation for component class

- [ ] **Task 2: Implement step form toggle with confirmation** (AC: 1, 2)
  - [ ] Add `showStepModeWarning` boolean signal for confirmation dialog
  - [ ] Create confirmation dialog template using p-dialog:
    - Title: "Enable Step Form?"
    - Message: "This will convert your form to step mode. All existing fields will be moved to
      Step 1. You can move them later."
    - Buttons: "Cancel" (secondary), "Enable" (primary)
  - [ ] On "Enable" clicked:
    - Call `formBuilderService.enableStepForm()` method
    - Create default first step: `{ id: uuid(), title: 'Step 1', description: '', order: 0 }`
    - Assign all existing fields to step 1 via `position.stepId`
    - Update form schema with `stepForm.enabled = true`
    - Close dialog
  - [ ] On toggle off: show similar confirmation for disabling (optional enhancement)
  - [ ] Add visual feedback during operation (loading indicator)

- [ ] **Task 3: Display step list with drag-to-reorder** (AC: 3, 4)
  - [ ] Use Angular CDK `cdkDropList` for step list container
  - [ ] Render each step as draggable item with `cdkDrag` directive
  - [ ] Display step information:
    - Drag handle icon (pi-bars from PrimeIcons)
    - Step order badge ("1", "2", "3", ...)
    - Step title (truncated if > 50 characters)
    - Edit button (pi-pencil icon)
    - Delete button (pi-trash icon, disabled when only 1 step)
  - [ ] Implement `onStepDrop(event: CdkDragDrop)`:
    - Update step order indices based on new position
    - Call `formBuilderService.reorderSteps(newOrder)`
    - Emit change event to trigger autosave
  - [ ] Style step list with Tailwind classes:
    - Each step: border, padding, hover effect, cursor-move
    - Active step: highlighted with primary color border

- [ ] **Task 4: Add step creation button** (AC: 3)
  - [ ] Add "Add Step" button at bottom of step list
  - [ ] Disable button when step count >= 10 (show tooltip: "Maximum 10 steps reached")
  - [ ] On click:
    - Generate new step:
      `{ id: uuid(), title: 'Step ${count + 1}', description: '', order: stepCount }`
    - Call `formBuilderService.addStep(newStep)`
    - Automatically open edit dialog for new step
    - Focus on title input in dialog

- [ ] **Task 5: Create step edit dialog** (AC: 5)
  - [ ] Create edit dialog template with p-dialog component
  - [ ] Dialog header: "Edit Step"
  - [ ] Form fields using reactive forms:
    - Step title: text input with validation (1-100 characters, required)
    - Step description: textarea with validation (max 500 characters, optional)
  - [ ] Dialog footer buttons:
    - "Cancel" (secondary) - close without saving
    - "Save" (primary) - validate and save changes
  - [ ] On save:
    - Validate form inputs
    - Call `formBuilderService.updateStep(stepId, updates)`
    - Show success toast notification
    - Close dialog
  - [ ] Handle validation errors inline with PrimeNG message component

- [ ] **Task 6: Implement step deletion** (AC: 6)
  - [ ] Add delete button for each step (pi-trash icon)
  - [ ] Disable delete when step count === 1 (tooltip: "Cannot delete last step")
  - [ ] On delete click:
    - Show confirmation dialog: "Delete step '{title}'? Fields in this step will be removed."
    - Buttons: "Cancel", "Delete" (danger style)
  - [ ] On confirm:
    - Remove all fields assigned to this step (update field positions)
    - Call `formBuilderService.removeStep(stepId)`
    - Reassign order indices for remaining steps
    - Show success toast: "Step deleted"

- [ ] **Task 7: Update FormBuilderService with step management methods** (AC: 1, 2, 3, 4, 5, 6, 7)
  - [ ] Add to `apps/web/src/app/features/tools/components/form-builder/form-builder.service.ts`:
  - [ ] Add signal: `stepFormEnabled = signal<boolean>(false)`
  - [ ] Add signal: `steps = signal<FormStep[]>([])`
  - [ ] Add signal: `activeStepId = signal<string | null>(null)`
  - [ ] Implement methods:
    - `enableStepForm(): void` - Enable step mode, create default step, migrate fields
    - `disableStepForm(): void` - Disable step mode, clear step assignments
    - `addStep(step: FormStep): void` - Add new step to array
    - `removeStep(stepId: string): void` - Remove step and reassign fields
    - `updateStep(stepId: string, updates: Partial<FormStep>): void` - Update step properties
    - `reorderSteps(newOrder: FormStep[]): void` - Update step order indices
    - `getStepById(stepId: string): FormStep | undefined` - Helper to retrieve step
  - [ ] Update `saveForm()` method to persist step configuration in schema
  - [ ] Add JSDoc comments for all new methods
  - [ ] Emit change events to trigger autosave

- [ ] **Task 8: Integrate sidebar component into FormBuilderComponent** (AC: 1, 7)
  - [ ] Add `<app-step-form-sidebar>` to right sidebar in `form-builder.component.html`
  - [ ] Place after existing sidebar tabs (Field Properties, Row Layout)
  - [ ] Add "Step Form" tab in sidebar navigation (p-tabMenu or custom tabs)
  - [ ] Show/hide based on active tab selection
  - [ ] Ensure sidebar responsive layout works on mobile (vertical stacking)

- [ ] **Task 9: Unit tests for StepFormSidebarComponent** (AC: 8)
  - [ ] Create
        `apps/web/src/app/features/tools/components/form-builder/step-form-sidebar/step-form-sidebar.component.spec.ts`
  - [ ] Test setup:
    - Mock FormBuilderService with spy methods
    - Configure TestBed with required modules
  - [ ] Test cases:
    - Should render component
    - Should show confirmation dialog when enabling step mode
    - Should call enableStepForm() on confirmation
    - Should display all steps from service
    - Should allow adding steps (up to 10)
    - Should disable "Add Step" button when count >= 10
    - Should open edit dialog on edit button click
    - Should update step on save in edit dialog
    - Should show confirmation before deleting step
    - Should prevent deleting last step
    - Should reorder steps on drag-drop
  - [ ] Run tests:
        `npm --workspace=apps/web run test -- --include="**/step-form-sidebar.component.spec.ts" --watch=false`
  - [ ] Verify >80% coverage for component

- [ ] **Task 10: Unit tests for FormBuilderService step methods** (AC: 8)
  - [ ] Update
        `apps/web/src/app/features/tools/components/form-builder/form-builder.service.spec.ts`
  - [ ] Add test suite: "Step Form Management"
  - [ ] Test cases:
    - `enableStepForm()` creates default step and migrates fields
    - `addStep()` adds step to array and updates order
    - `removeStep()` removes step and reassigns field positions
    - `updateStep()` updates step properties
    - `reorderSteps()` updates order indices correctly
    - `getStepById()` returns correct step or undefined
    - Step configuration persists in schema on save
  - [ ] Run tests and verify >80% coverage for new methods

- [ ] **Task 11: Integration testing** (AC: 7, 8)
  - [ ] Run all frontend tests: `npm --workspace=apps/web run test -- --watch=false`
  - [ ] Verify no regressions in existing form builder functionality
  - [ ] Test manual workflow:
    - Open form builder
    - Enable step form mode
    - Add 3 steps
    - Edit step titles and descriptions
    - Reorder steps via drag-drop
    - Delete a step
    - Save form
    - Reload form and verify step configuration persists
  - [ ] Fix any failing tests

## Dev Notes

### Previous Story Context

[Source: Story 19.1 completion notes - to be updated after Story 19.1 implementation]

**Key Takeaways from Story 19.1:**

- `FormStep` and `StepFormConfig` interfaces added to `@nodeangularfullstack/shared`
- `FormSettings.stepForm` property available for step configuration
- `FieldPosition.stepId` property available for field-step assignment
- Backend validation supports 2-10 steps and validates step IDs
- Migration helper function available: `convertSinglePageToStepForm()`
- All existing backend tests passing with new types

### Testing Standards

[Source: docs/architecture/testing-strategy.md]

**Frontend Test Location:**

- Component tests: Co-located with components as `*.spec.ts` files
- Use Karma + Jasmine for unit tests
- Angular Testing Library pattern with TestBed

**Test Framework:**

- Jasmine test framework with Angular testing utilities
- Mock services using `jasmine.createSpyObj()`
- Component fixture for DOM testing
- Coverage reports: `npm --workspace=apps/web run test:coverage`
- Minimum 80% coverage requirement for new code

**Component Test Pattern:**

```typescript
describe('StepFormSidebarComponent', () => {
  let component: StepFormSidebarComponent;
  let fixture: ComponentFixture<StepFormSidebarComponent>;
  let mockFormBuilderService: jasmine.SpyObj<FormBuilderService>;

  beforeEach(() => {
    mockFormBuilderService = jasmine.createSpyObj('FormBuilderService', [
      'enableStepForm',
      'addStep',
      'removeStep',
      'updateStep',
      'reorderSteps',
    ]);

    TestBed.configureTestingModule({
      imports: [StepFormSidebarComponent],
      providers: [{ provide: FormBuilderService, useValue: mockFormBuilderService }],
    });

    fixture = TestBed.createComponent(StepFormSidebarComponent);
    component = fixture.componentInstance;
  });

  it('should enable step form on confirmation', () => {
    component.confirmEnableStepForm();
    expect(mockFormBuilderService.enableStepForm).toHaveBeenCalled();
  });
});
```

### Frontend Architecture Patterns

[Source: docs/architecture/frontend-architecture.md]

**Component Organization:**

```
apps/web/src/app/features/tools/components/form-builder/
├── form-builder.component.ts               # Main form builder container
├── form-builder.service.ts                  # State management service
├── step-form-sidebar/                       # NEW: Step configuration sidebar
│   ├── step-form-sidebar.component.ts
│   ├── step-form-sidebar.component.html
│   ├── step-form-sidebar.component.scss
│   └── step-form-sidebar.component.spec.ts
├── field-palette/                           # Existing: Field type palette
├── form-canvas/                             # Existing: Canvas for field layout
└── row-layout-sidebar/                      # Existing: Row layout config
```

**Angular 20+ Patterns:**

- Standalone components (no NgModules)
- OnPush change detection for performance
- Signals for reactive state management
- Inject function for dependency injection
- Computed signals for derived state

**Component Template:**

```typescript
import { Component, ChangeDetectionStrategy, inject, signal } from '@angular/core';
import { CommonModule } from '@angular/common';
import { FormBuilderService } from '../form-builder.service';

@Component({
  selector: 'app-step-form-sidebar',
  standalone: true,
  imports: [CommonModule /* PrimeNG modules */],
  templateUrl: './step-form-sidebar.component.html',
  styleUrls: ['./step-form-sidebar.component.scss'],
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class StepFormSidebarComponent {
  private readonly formBuilderService = inject(FormBuilderService);

  protected readonly steps = this.formBuilderService.steps;
  protected readonly stepFormEnabled = this.formBuilderService.stepFormEnabled;
  protected showEnableDialog = signal(false);

  onEnableStepForm(): void {
    this.showEnableDialog.set(true);
  }

  confirmEnableStepForm(): void {
    this.formBuilderService.enableStepForm();
    this.showEnableDialog.set(false);
  }
}
```

### State Management with Signals

[Source: docs/architecture/frontend-architecture.md#state-management-architecture]

**NgRx Signals Pattern:**

- Use `signal<T>()` for mutable state
- Use `computed(() => ...)` for derived state
- Call `.set()` or `.update()` to modify signal values
- Access signal values with `signal()` (call as function)
- Signals automatically track dependencies and trigger updates

**Service State Example:**

```typescript
export class FormBuilderService {
  // State signals
  private readonly _stepFormEnabled = signal<boolean>(false);
  private readonly _steps = signal<FormStep[]>([]);
  private readonly _activeStepId = signal<string | null>(null);

  // Public readonly signals (expose state)
  readonly stepFormEnabled = this._stepFormEnabled.asReadonly();
  readonly steps = this._steps.asReadonly();
  readonly activeStepId = this._activeStepId.asReadonly();

  // Computed signals (derived state)
  readonly canAddStep = computed(() => this._steps().length < 10);
  readonly canDeleteStep = computed(() => this._steps().length > 1);
  readonly activeStep = computed(() => this._steps().find((s) => s.id === this._activeStepId()));

  // Methods to update state
  enableStepForm(): void {
    const defaultStep: FormStep = {
      id: this.generateUuid(),
      title: 'Step 1',
      description: '',
      order: 0,
    };
    this._steps.set([defaultStep]);
    this._stepFormEnabled.set(true);
    this._activeStepId.set(defaultStep.id);
    this.migrateFieldsToStep(defaultStep.id);
  }
}
```

### PrimeNG Component Usage

[Source: docs/architecture/tech-stack.md, Epic 19 context]

**Required PrimeNG 17+ Modules:**

- `ButtonModule` - Action buttons
- `ToggleButtonModule` - Step mode toggle switch
- `PanelModule` - Step list container
- `DialogModule` - Confirmation and edit dialogs
- `InputTextModule` - Step title input
- `InputTextareaModule` - Step description input
- `DragDropModule` - Angular CDK for drag-drop (not PrimeNG)

**Dialog Pattern:**

```typescript
<p-dialog
  [(visible)]="showDialog()"
  header="Edit Step"
  [modal]="true"
  [style]="{width: '450px'}">
  <ng-template pTemplate="content">
    <!-- Dialog content -->
  </ng-template>
  <ng-template pTemplate="footer">
    <p-button label="Cancel" (onClick)="closeDialog()" />
    <p-button label="Save" (onClick)="saveStep()" [disabled]="!form.valid" />
  </ng-template>
</p-dialog>
```

### Angular CDK Drag-Drop

[Source: Angular CDK Documentation, Epic 19 context]

**Setup:**

```typescript
// Import in component
import { CdkDragDrop, DragDropModule, moveItemInArray } from '@angular/cdk/drag-drop';

// Template usage
<div cdkDropList (cdkDropListDropped)="onStepDrop($event)">
  @for (step of steps(); track step.id) {
    <div cdkDrag class="step-item">
      <div cdkDragHandle class="drag-handle">
        <i class="pi pi-bars"></i>
      </div>
      <span>{{ step.title }}</span>
    </div>
  }
</div>

// Component method
onStepDrop(event: CdkDragDrop<FormStep[]>): void {
  const steps = [...this.steps()];
  moveItemInArray(steps, event.previousIndex, event.currentIndex);

  // Update order indices
  steps.forEach((step, index) => step.order = index);

  this.formBuilderService.reorderSteps(steps);
}
```

### Form Builder Integration

[Source: Existing form builder implementation, Epic 19 context]

**Current Right Sidebar Tabs:**

1. Field Properties - Configure selected field (existing)
2. Row Layout - Configure row-column layout (existing)
3. **Step Form** - Configure step mode and steps (NEW - this story)

**Sidebar Navigation Pattern:**

```typescript
// form-builder.component.ts
protected readonly sidebarTabs = [
  { label: 'Field Properties', icon: 'pi-cog' },
  { label: 'Row Layout', icon: 'pi-th-large' },
  { label: 'Step Form', icon: 'pi-list' } // NEW
];

protected activeSidebarTab = signal<number>(0);

// Template conditional rendering
@if (activeSidebarTab() === 0) {
  <app-field-properties-sidebar />
}
@if (activeSidebarTab() === 1) {
  <app-row-layout-sidebar />
}
@if (activeSidebarTab() === 2) {
  <app-step-form-sidebar />  // NEW
}
```

### Styling with Tailwind CSS

[Source: docs/architecture/tech-stack.md]

**Tailwind Utility Classes:**

- Layout: `flex`, `flex-col`, `gap-4`, `p-4`, `space-y-2`
- Borders: `border`, `border-gray-300`, `rounded-md`
- Colors: `bg-white`, `text-gray-700`, `hover:bg-gray-50`
- Interactive: `cursor-move`, `cursor-pointer`, `disabled:opacity-50`

**Step Item Styling Example:**

```html
<div
  class="border border-gray-300 rounded-md p-3 flex items-center gap-3 hover:border-primary-500 transition-colors"
>
  <i class="pi pi-bars cursor-move text-gray-400"></i>
  <span class="badge">{{ step.order + 1 }}</span>
  <span class="flex-1 truncate">{{ step.title }}</span>
  <button class="icon-button" (click)="editStep(step)">
    <i class="pi pi-pencil"></i>
  </button>
  <button class="icon-button" (click)="deleteStep(step)" [disabled]="steps().length === 1">
    <i class="pi pi-trash"></i>
  </button>
</div>
```

### Validation and Error Handling

[Source: docs/architecture/coding-standards.md]

**Reactive Forms Validation:**

```typescript
this.stepForm = this.fb.group({
  title: ['', [Validators.required, Validators.minLength(1), Validators.maxLength(100)]],
  description: ['', [Validators.maxLength(500)]]
});

// Template error display
@if (stepForm.get('title')?.invalid && stepForm.get('title')?.touched) {
  <small class="p-error">Title is required (1-100 characters)</small>
}
```

**Toast Notifications:**

```typescript
// Inject MessageService (PrimeNG)
private readonly messageService = inject(MessageService);

// Show success toast
this.messageService.add({
  severity: 'success',
  summary: 'Step Added',
  detail: 'New step created successfully',
  life: 3000
});

// Show error toast
this.messageService.add({
  severity: 'error',
  summary: 'Error',
  detail: 'Failed to delete step',
  life: 3000
});
```

### Accessibility Requirements

[Source: Epic 19 context, WCAG AA compliance]

**ARIA Attributes:**

- Dialog: `role="dialog"`, `aria-labelledby`, `aria-modal="true"`
- Buttons: `aria-label` for icon-only buttons
- Drag handles: `aria-label="Drag to reorder"`
- Disabled buttons: `aria-disabled="true"`

**Keyboard Navigation:**

- Tab through interactive elements
- Enter to activate buttons
- Escape to close dialogs
- Space to toggle switches

### Project Structure

[Source: docs/architecture/unified-project-structure.md]

**File Locations:**

```
apps/web/src/app/features/tools/components/form-builder/
├── step-form-sidebar/
│   ├── step-form-sidebar.component.ts      # Component class
│   ├── step-form-sidebar.component.html    # Template
│   ├── step-form-sidebar.component.scss    # Styles
│   └── step-form-sidebar.component.spec.ts # Unit tests
└── form-builder.service.ts                  # Update with step methods
```

### Tech Stack

[Source: docs/architecture/tech-stack.md]

- **Frontend Framework:** Angular 20+ with standalone components
- **UI Library:** PrimeNG 17+ with Tailwind CSS 3.4+
- **State Management:** NgRx Signals 17+
- **Drag-Drop:** Angular CDK Drag-Drop module
- **Testing:** Jest 29+ with Angular Testing Library
- **TypeScript:** 5.3+ with strict mode

### Backward Compatibility

[Source: Epic 19 context]

**Critical Considerations:**

1. Step configuration is optional - forms without `stepForm` property continue to work
2. When step mode is disabled, fields render in global layout (existing behavior)
3. Existing forms load without step configuration (no breaking changes)
4. Step mode can be enabled/disabled without data loss (fields retain positions)

## Change Log

| Date       | Version | Description         | Author       |
| ---------- | ------- | ------------------- | ------------ |
| 2025-10-13 | 1.0     | Initial story draft | Scrum Master |

## Dev Agent Record

### Agent Model Used

_To be populated by Dev Agent during implementation_

### Debug Log References

_To be populated by Dev Agent during implementation_

### Completion Notes List

_To be populated by Dev Agent during implementation_

### File List

_To be populated by Dev Agent during implementation_

## QA Results

_To be populated by QA Agent after review_
