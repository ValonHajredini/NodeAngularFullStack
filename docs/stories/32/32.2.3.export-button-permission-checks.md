# Story 32.2.3: Export Button & Permission Checks

**Epic:** 32.2 - Dynamic Routing & Export UI **Story Points:** 6 **Priority:** P1 **Assignee:**
Frontend Developer **Status:** Draft

---

## Description

Implement permission checking for export functionality on tool detail pages. Only users with
appropriate permissions (admin role or explicit export permission) can trigger tool export. Export
button shows enabled/disabled states with tooltips explaining permission requirements. Lays
groundwork for actual export functionality in Epic 33.

**Context:**

- Story 32.2.2 created tool detail page with export button
- This story adds permission checking to enable/disable export button
- Uses AuthService to get current user and permissions
- Integrates with Tool Registry permissions
- Export action itself implemented in Epic 33

---

## Acceptance Criteria

**AC1: Permission Service Integration**

- ✅ Injects AuthService to get current user
- ✅ Checks user role: admin can always export
- ✅ Checks tool-specific permissions
- ✅ Export permission stored in user permissions array
- ✅ Permission check performed on component init

**AC2: Export Button States**

- ✅ Button enabled for admin users
- ✅ Button enabled for users with "export" permission
- ✅ Button disabled for users without permission
- ✅ Disabled state shows tooltip: "You don't have permission to export this tool"
- ✅ Button style reflects enabled/disabled state

**AC3: Permission Checking Logic**

- ✅ Method `canExportTool(): boolean` checks permissions
- ✅ Checks user role === 'admin'
- ✅ Checks user permissions includes 'export'
- ✅ Checks tool-specific permissions (if applicable)
- ✅ Returns true if any check passes

**AC4: User Feedback**

- ✅ Tooltip on disabled button explains why
- ✅ Toast message if user clicks disabled button
- ✅ Clear visual distinction between enabled/disabled
- ✅ Loading state while checking permissions
- ✅ Error state if permission check fails

**AC5: Permission Guard (Optional)**

- ✅ Create `ExportGuard` to prevent unauthorized access
- ✅ Guard checks permissions before allowing export action
- ✅ Redirects or shows error if unauthorized
- ✅ Used in export route or modal (Epic 33)
- ✅ Integrated with AuthService

**AC6: Role-Based Display**

- ✅ Admin users see "Export Tool" button enabled
- ✅ Non-admin with export permission see button enabled
- ✅ Users without permission see button disabled + tooltip
- ✅ Unauthenticated users redirected to login
- ✅ Different UI for different roles (optional)

**AC7: Component Tests**

- ✅ Unit tests with ≥90% coverage
- ✅ Test: admin user can export
- ✅ Test: user with export permission can export
- ✅ Test: user without permission cannot export
- ✅ Test: unauthenticated user redirected
- ✅ Test: canExportTool() logic correct

---

## Tasks

### Task 1: Permission Checking Method

**Subtasks:**

1. Create `canExportTool(): boolean` method in ToolDetailComponent
2. Inject AuthService in constructor
3. Get current user from AuthService
4. Check if user is null (unauthenticated)
5. Check if user role === 'admin'
6. Check if user permissions includes 'export'
7. Check tool-specific permissions (if any)
8. Return true if admin OR has export permission
9. Add JSDoc documentation
10. Add console logging for debugging

### Task 2: User Permissions Signal

**Subtasks:**

1. Create `userPermissions = signal<string[]>([])` in component
2. Create `userRole = signal<string | null>(null)` in component
3. Fetch user permissions on init
4. Subscribe to AuthService.currentUser
5. Update signals when user changes
6. Handle null user (not authenticated)
7. Create `canExport = computed<boolean>()` from permissions
8. Update canExport when permissions change
9. Test permission signal updates
10. Verify computed signal reactivity

### Task 3: Export Button State Binding

**Subtasks:**

1. Update export button in template
2. Bind `[disabled]="!canExport()"`
3. Add `pTooltip` attribute
4. Show tooltip on disabled: "You don't have permission to export"
5. Show tooltip on enabled: "Export this tool as independent service"
6. Add conditional styling for disabled state
7. Use computed signal for tooltip text
8. Test button enabled/disabled states
9. Verify tooltip displays correctly
10. Test with different user roles

### Task 4: Permission Loading State

**Subtasks:**

1. Create `checkingPermissions = signal<boolean>(true)` signal
2. Set true on component init
3. Fetch user permissions async
4. Set false when permissions loaded
5. Show loading skeleton for action buttons while checking
6. Disable all action buttons during loading
7. Show spinner on export button (optional)
8. Handle permission check timeout (10s)
9. Test loading state appearance
10. Verify smooth transition to loaded state

### Task 5: Unauthorized User Handling

**Subtasks:**

1. Check if user is authenticated on init
2. Redirect to login if not authenticated
3. Store intended URL for redirect after login
4. Show message: "Please log in to export tools"
5. Use AuthService.redirectToLogin() method
6. Preserve tool detail URL for return
7. Test unauthenticated user flow
8. Verify redirect happens
9. Verify return to tool detail after login
10. Handle edge cases (expired session)

### Task 6: Toast Messages for Permissions

**Subtasks:**

1. Import MessageService from PrimeNG
2. Show toast when user clicks disabled export button
3. Toast message: "You don't have permission to export"
4. Toast severity: 'warn' or 'info'
5. Toast duration: 5000ms
6. Add icon to toast (pi-lock)
7. Link to help page or admin contact (optional)
8. Test toast display
9. Verify toast auto-closes
10. Ensure toast doesn't spam on multiple clicks

### Task 7: Admin Role Check

**Subtasks:**

1. Get user role from AuthService.currentUser
2. Check if role === 'admin'
3. Admin users always have export permission
4. Bypass tool-specific permission checks for admin
5. Log admin access for audit (optional)
6. Show "Admin" badge next to export button (optional)
7. Test admin user export access
8. Verify non-admin users blocked
9. Test role change (admin → user)
10. Handle missing role field

### Task 8: Tool-Specific Permissions (Optional)

**Subtasks:**

1. Check if tool has permissions field
2. Match user permissions with tool.permissions
3. User must have ALL tool permissions to export
4. Example: tool.permissions = ['read', 'write', 'export']
5. User needs all three to export
6. Show missing permissions in tooltip
7. Test with various permission combinations
8. Verify permission matching logic
9. Handle empty tool.permissions array
10. Document permission matching rules

### Task 9: ExportGuard Implementation (Optional)

**Subtasks:**

1. Create `export.guard.ts` in core/guards
2. Implement `CanActivateFn` functional guard
3. Inject AuthService and ToolRegistryService
4. Get current user and check permissions
5. Return true if user can export
6. Return false and show error if not
7. Redirect to tool detail page (no export)
8. Add JSDoc documentation
9. Export from core barrel exports
10. Add guard to export route (Epic 33)

### Task 10: Visual Distinction for States

**Subtasks:**

1. Style enabled export button (primary color)
2. Style disabled export button (muted, gray)
3. Add cursor: not-allowed for disabled
4. Reduce opacity for disabled (0.5)
5. Remove hover effects for disabled
6. Add lock icon to disabled button (optional)
7. Test visual appearance of both states
8. Verify accessibility (color contrast)
9. Ensure disabled state obvious
10. Match PrimeNG button disabled styles

### Task 11: Unit Tests - Permission Logic

**Subtasks:**

1. Mock AuthService in tests
2. Write test: "admin user can export"
3. Mock user with role = 'admin'
4. Verify canExportTool() returns true
5. Write test: "user with export permission can export"
6. Mock user with permissions = ['export']
7. Verify canExportTool() returns true
8. Write test: "user without permission cannot export"
9. Mock user with permissions = ['read']
10. Verify canExportTool() returns false

### Task 12: Unit Tests - Button States

**Subtasks:**

1. Write test: "export button enabled for admin"
2. Verify button not disabled
3. Write test: "export button disabled for non-admin"
4. Verify button disabled attribute true
5. Write test: "tooltip shows on disabled button"
6. Query tooltip element
7. Verify tooltip text correct
8. Write test: "toast shows when disabled button clicked"
9. Spy on MessageService.add
10. Verify toast called with correct message

### Task 13: Integration Testing

**Subtasks:**

1. Create E2E test: "admin exports tool"
2. Login as admin user
3. Navigate to tool detail page
4. Verify export button enabled
5. Click export button (stubbed action for now)
6. Create E2E test: "non-admin cannot export"
7. Login as regular user
8. Navigate to tool detail
9. Verify export button disabled
10. Verify tooltip appears

### Task 14: Documentation

**Subtasks:**

1. Document permission model
2. Explain role-based access control
3. List required permissions for export
4. Document how to grant export permission
5. Add troubleshooting guide
6. Explain admin override
7. Document AuthService integration
8. Add examples to README
9. Create permission matrix table
10. Link to backend RBAC documentation

---

## Dev Notes

### Permission Checking Implementation

**TypeScript (tool-detail.component.ts - Permission Enhancement):**

```typescript
import { Component, OnInit, signal, computed } from '@angular/core';
import { AuthService } from '@app/core/services/auth.service';
import { User } from '@nodeangularfullstack/shared';

@Component({
  selector: 'app-tool-detail',
  // ... other config
})
export class ToolDetailComponent implements OnInit {
  // Existing signals
  tool = signal<ToolRegistryRecord | null>(null);
  loading = signal<boolean>(true);

  // Permission signals
  currentUser = signal<User | null>(null);
  userRole = signal<string | null>(null);
  userPermissions = signal<string[]>([]);
  checkingPermissions = signal<boolean>(true);

  // Computed permissions
  canExport = computed<boolean>(() => {
    const user = this.currentUser();
    const role = this.userRole();
    const permissions = this.userPermissions();

    // Not authenticated
    if (!user) return false;

    // Admin can always export
    if (role === 'admin') return true;

    // Check if user has export permission
    if (permissions.includes('export')) return true;

    // No permission
    return false;
  });

  exportButtonTooltip = computed<string>(() => {
    if (this.canExport()) {
      return 'Export this tool as an independent service';
    } else {
      return "You don't have permission to export this tool";
    }
  });

  constructor(
    private authService: AuthService,
    private messageService: MessageService
    // ... other services
  ) {}

  ngOnInit(): void {
    this.loadTool();
    this.loadUserPermissions();
  }

  /**
   * Loads current user and their permissions.
   */
  private loadUserPermissions(): void {
    this.checkingPermissions.set(true);

    this.authService.currentUser$.subscribe({
      next: (user) => {
        if (!user) {
          console.warn('[ToolDetailComponent] No authenticated user');
          this.currentUser.set(null);
          this.userRole.set(null);
          this.userPermissions.set([]);
          this.checkingPermissions.set(false);
          return;
        }

        console.log('[ToolDetailComponent] User loaded:', user.email);
        this.currentUser.set(user);
        this.userRole.set(user.role);
        this.userPermissions.set(user.permissions || []);
        this.checkingPermissions.set(false);

        console.log(`[ToolDetailComponent] Can export: ${this.canExport()}`);
      },
      error: (err) => {
        console.error('[ToolDetailComponent] Failed to load user:', err);
        this.checkingPermissions.set(false);
      },
    });
  }

  /**
   * Handles export button click.
   * Checks permissions before proceeding.
   */
  exportTool(): void {
    if (!this.canExport()) {
      this.messageService.add({
        severity: 'warn',
        summary: 'Permission Denied',
        detail: "You don't have permission to export this tool",
        life: 5000,
      });
      return;
    }

    // Check if user is authenticated
    if (!this.currentUser()) {
      this.messageService.add({
        severity: 'info',
        summary: 'Login Required',
        detail: 'Please log in to export tools',
        life: 5000,
      });
      this.authService.redirectToLogin();
      return;
    }

    // Placeholder for actual export logic (Epic 33)
    this.messageService.add({
      severity: 'info',
      summary: 'Coming Soon',
      detail: 'Export functionality will be available in Epic 33',
      life: 5000,
    });
  }

  /**
   * Checks if current user can export tools.
   *
   * @returns true if user is admin or has export permission
   */
  canExportTool(): boolean {
    return this.canExport();
  }
}
```

**Template (tool-detail.component.html - Export Button Enhancement):**

```html
<div class="action-buttons">
  <!-- Export Button with Permission Check -->
  <p-button
    label="Export"
    icon="pi pi-download"
    severity="primary"
    [disabled]="!canExport() || checkingPermissions()"
    [loading]="checkingPermissions()"
    (onClick)="exportTool()"
    [pTooltip]="exportButtonTooltip()"
    tooltipPosition="bottom"
  ></p-button>

  <!-- Edit Button -->
  <p-button
    label="Edit"
    icon="pi pi-pencil"
    severity="secondary"
    [outlined]="true"
    [disabled]="checkingPermissions()"
    (onClick)="editTool()"
    pTooltip="Edit tool configuration"
  ></p-button>

  <!-- Delete Button -->
  <p-button
    icon="pi pi-trash"
    severity="danger"
    [outlined]="true"
    [disabled]="checkingPermissions()"
    (onClick)="deleteTool()"
    pTooltip="Delete this tool"
  ></p-button>
</div>

<!-- Permission Denied Message (Optional) -->
<div *ngIf="!canExport() && !checkingPermissions()" class="permission-message">
  <i class="pi pi-lock"></i>
  <span>You need export permission to export this tool. Contact your administrator.</span>
</div>
```

**Styles (tool-detail.component.scss - Permission Styling):**

```scss
.action-buttons {
  p-button {
    &[disabled] {
      opacity: 0.5;
      cursor: not-allowed;

      &:hover {
        transform: none;
      }
    }
  }
}

.permission-message {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: var(--yellow-50);
  border: 1px solid var(--yellow-200);
  border-radius: 6px;
  color: var(--yellow-900);
  font-size: 0.875rem;
  margin-top: 16px;

  i {
    font-size: 1.25rem;
    color: var(--yellow-600);
  }
}
```

### ExportGuard Implementation (Optional)

**TypeScript (export.guard.ts):**

````typescript
import { inject } from '@angular/core';
import { CanActivateFn, Router } from '@angular/router';
import { map } from 'rxjs/operators';
import { AuthService } from '../services/auth.service';

/**
 * Route guard that checks export permission.
 *
 * Prevents unauthorized users from accessing export functionality.
 * Redirects to tool detail page if permission denied.
 *
 * @example
 * ```typescript
 * const routes: Routes = [
 *   {
 *     path: 'tools/:toolId/export',
 *     canActivate: [exportGuard],
 *     loadComponent: () => import('./export-modal.component').then(m => m.ExportModalComponent)
 *   }
 * ];
 * ```
 */
export const exportGuard: CanActivateFn = (route) => {
  const authService = inject(AuthService);
  const router = inject(Router);

  return authService.currentUser$.pipe(
    map((user) => {
      if (!user) {
        console.warn('[ExportGuard] No authenticated user');
        router.navigate(['/auth/login']);
        return false;
      }

      const isAdmin = user.role === 'admin';
      const hasExportPermission = user.permissions?.includes('export') ?? false;

      if (isAdmin || hasExportPermission) {
        console.log('[ExportGuard] Access granted');
        return true;
      }

      console.warn('[ExportGuard] User lacks export permission:', user.email);

      const toolId = route.paramMap.get('toolId');
      router.navigate(['/tools', toolId]);
      return false;
    })
  );
};
````

### Unit Tests

```typescript
// tool-detail.component.spec.ts (Permission Tests)
describe('ToolDetailComponent - Permissions', () => {
  let component: ToolDetailComponent;
  let fixture: ComponentFixture<ToolDetailComponent>;
  let mockAuthService: jasmine.SpyObj<AuthService>;

  const mockAdminUser: User = {
    id: '1',
    email: 'admin@example.com',
    role: 'admin',
    permissions: ['read', 'write', 'export', 'admin'],
  };

  const mockRegularUser: User = {
    id: '2',
    email: 'user@example.com',
    role: 'user',
    permissions: ['read'],
  };

  beforeEach(() => {
    mockAuthService = jasmine.createSpyObj('AuthService', ['redirectToLogin']);
    mockAuthService.currentUser$ = of(mockAdminUser);

    TestBed.configureTestingModule({
      imports: [ToolDetailComponent],
      providers: [{ provide: AuthService, useValue: mockAuthService }],
    });

    fixture = TestBed.createComponent(ToolDetailComponent);
    component = fixture.componentInstance;
  });

  it('should allow admin to export', () => {
    mockAuthService.currentUser$ = of(mockAdminUser);
    fixture.detectChanges();

    expect(component.canExport()).toBe(true);
  });

  it('should allow user with export permission', () => {
    const userWithExport = { ...mockRegularUser, permissions: ['export'] };
    mockAuthService.currentUser$ = of(userWithExport);
    fixture.detectChanges();

    expect(component.canExport()).toBe(true);
  });

  it('should deny user without export permission', () => {
    mockAuthService.currentUser$ = of(mockRegularUser);
    fixture.detectChanges();

    expect(component.canExport()).toBe(false);
  });

  it('should disable export button for unauthorized user', () => {
    mockAuthService.currentUser$ = of(mockRegularUser);
    fixture.detectChanges();

    const button = fixture.debugElement.query(By.css('p-button[label="Export"]'));
    expect(button.componentInstance.disabled).toBe(true);
  });

  it('should show permission denied toast', () => {
    mockAuthService.currentUser$ = of(mockRegularUser);
    fixture.detectChanges();

    spyOn(component['messageService'], 'add');

    component.exportTool();

    expect(component['messageService'].add).toHaveBeenCalledWith(
      jasmine.objectContaining({
        severity: 'warn',
        summary: 'Permission Denied',
      })
    );
  });
});
```

---

## Testing

### Manual Testing

**Test 1: Admin User Export**

```bash
# 1. Login as admin user
# 2. Navigate to tool detail page
# Expected: Export button enabled, no disabled styling
# 3. Hover over export button
# Expected: Tooltip shows "Export this tool..."
```

**Test 2: Regular User Export**

```bash
# 1. Login as regular user (no export permission)
# 2. Navigate to tool detail page
# Expected: Export button disabled, grayed out
# 3. Hover over disabled button
# Expected: Tooltip shows "You don't have permission..."
# 4. Click disabled button
# Expected: Toast message "Permission Denied"
```

**Test 3: User with Export Permission**

```bash
# 1. Login as user with "export" permission
# 2. Navigate to tool detail page
# Expected: Export button enabled
# 3. Click export button
# Expected: Success (or "Coming Soon" message for now)
```

**Test 4: Unauthenticated User**

```bash
# 1. Logout
# 2. Navigate directly to tool detail page
# Expected: Redirect to login page
# 3. Login
# Expected: Return to tool detail page
```

**Test 5: Permission Loading State**

```bash
# 1. Throttle network to "Slow 3G"
# 2. Login and navigate to tool detail
# Expected: Action buttons disabled while loading
# 3. Wait for permissions to load
# Expected: Export button enabled/disabled based on permissions
```

### Automated Testing

```bash
# Run permission tests
npm --workspace=apps/web run test -- --include="**/tool-detail.component.spec.ts" --watch=false

# Expected output:
# PASS src/app/features/tools/pages/tool-detail/tool-detail.component.spec.ts
#   ToolDetailComponent - Permissions
#     ✓ should allow admin to export (30ms)
#     ✓ should allow user with export permission (28ms)
#     ✓ should deny user without export permission (25ms)
#     ✓ should disable export button for unauthorized user (32ms)
#     ✓ should show permission denied toast (27ms)
#
# Tests: 5 passed, 5 total
# Coverage: Statements 93%, Branches 90%, Functions 91%, Lines 93%
```

---

## Dependencies

**Depends On:**

- Story 32.2.2: Tool Detail Pages (export button exists)
- AuthService (user permissions and role)

**Blocks:**

- Epic 33: Export Automation (permission check required before export)

**Related Stories:**

- None

---

## QA Gate

**Quality Score Target:** ≥90/100

| Criterion                | Weight | Target                   |
| ------------------------ | ------ | ------------------------ |
| Unit test coverage       | 20%    | ≥90%                     |
| All tests passing        | 15%    | 100%                     |
| Permission logic correct | 20%    | Verified manually        |
| Button states visual     | 15%    | Clear enabled/disabled   |
| Tooltips helpful         | 10%    | Explain permission needs |
| User feedback clear      | 10%    | Toast messages work      |
| Accessibility            | 10%    | ARIA, keyboard nav       |

**Exit Criteria:**

- All unit tests pass with ≥90% coverage
- Admin users see enabled export button
- Non-admin without export permission see disabled button
- Tooltip explains permission requirements
- Toast shows when permission lacking
- Permission check happens on init
- Loading state while checking permissions
- Unauthenticated users redirected to login

---

## Notes

- Permission checking happens client-side for UX (hide/disable)
- Backend must ALWAYS enforce permissions (Epic 33)
- Admin role bypasses all permission checks
- Export permission can be granted per user
- Tool-specific permissions optional (future enhancement)
- ExportGuard optional for Epic 33 implementation
- Clear visual distinction between enabled/disabled states critical
- Toast feedback helps users understand why action unavailable
