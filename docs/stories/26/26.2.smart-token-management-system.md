# Story 26.2: Smart Token Management System - Brownfield Enhancement

**Story Status:** Draft  
**Story Owner:** Product Manager  
**Developer:** TBD  
**QA Engineer:** TBD  
**Epic:** 26 - Enhanced Form Publishing System

## User Story

As a **form creator**,  
I want **to be prompted about reusing existing valid tokens when republishing forms**,  
So that **I can avoid generating unnecessary tokens and maintain consistent form URLs while having
control over when to create new tokens**.

## Story Context

**Existing System Integration:**

- Integrates with: `PublishDialogComponent`, `forms.service.ts` token management, and
  `FormsController.publishForm()`
- Technology: Angular 20+ with PrimeNG dialogs, Express.js backend with JWT token validation
- Follows pattern: Existing modal confirmation dialogs and service-based token operations
- Touch points: Token generation service, form metadata storage, publishing workflow

**Current System Behavior:**

- Each publish action generates a new token regardless of existing valid tokens
- Forms can have multiple active tokens pointing to the same content
- No visibility into existing token status during publishing
- Token invalidation only occurs through explicit unpublish action

## Acceptance Criteria

### Functional Requirements:

1. **Existing Token Detection**
   - System checks for existing valid tokens before initiating publish process
   - Valid tokens are those that are unexpired and currently active
   - Detection includes both permanent tokens (no expiration) and future-dated tokens

2. **Token Reuse Confirmation Dialog**
   - When valid token exists, show confirmation dialog with token details
   - Display token expiration status ("No expiration" or specific date)
   - Present clear options: "Use existing token" vs "Generate new token"
   - Include form URL preview for existing token

3. **Smart Publishing Workflow**
   - "Use existing token" skips token generation and returns existing form URL
   - "Generate new token" proceeds with normal token generation process
   - No prompt appears when no valid tokens exist (proceeds directly to publishing)

### Integration Requirements:

4. **Backend Token Query Enhancement**
   - Add `getActiveTokensForForm()` method to forms service
   - Token status checking API endpoint for frontend validation
   - Existing token generation and validation logic preserved unchanged

5. **Frontend Service Integration**
   - `FormsApiService` method to check existing token status
   - Token reuse confirmation component integrated with publishing workflow
   - Publishing service handles both token reuse and generation paths

6. **Token Management Consistency**
   - Token reuse maintains existing security and access control patterns
   - Ownership validation ensures users can only reuse their own form tokens
   - Audit trail preserved for both token reuse and generation events

### Quality Requirements:

7. **User Experience Optimization**
   - Token checking occurs in background without blocking publishing UI
   - Confirmation dialog loads instantly with token information
   - Clear visual indication of token status and recommended action

8. **Performance and Security**
   - Token status queries optimized for minimal latency
   - No sensitive token information exposed in frontend confirmation
   - Token reuse validation maintains existing security standards

9. **Error Handling and Edge Cases**
   - Graceful handling when token status query fails
   - Fallback to normal publishing when token checking is unavailable
   - Clear error messages for token-related issues

## Technical Notes

### Implementation Approach:

- Create `TokenReuseConfirmationComponent` as reusable dialog component
- Extend `FormsService` with `checkExistingTokens()` method
- Modify publishing workflow to include token status check step
- Add backend endpoint for token status queries

### API Enhancement:

```typescript
// New endpoint: GET /api/forms/:id/tokens/status
interface TokenStatusResponse {
  hasValidToken: boolean;
  tokenExpiration: Date | null;
  tokenCreatedAt: Date;
  formUrl: string;
}
```

### Component Integration:

```typescript
// Publishing workflow enhancement
async onPublish() {
  const tokenStatus = await this.checkExistingTokens();
  if (tokenStatus.hasValidToken) {
    this.showTokenReuseDialog(tokenStatus);
  } else {
    this.proceedWithPublishing();
  }
}
```

### Key Constraints:

- Token checking must not delay publishing for forms without existing tokens
- Security validation required to prevent token information leakage
- Backward compatibility with existing token generation workflow
- No changes to existing token storage or validation mechanisms

## Definition of Done

- [ ] **Token status checking** implemented and optimized for performance
- [ ] **Confirmation dialog component** created with proper UX patterns
- [ ] **Token reuse workflow** integrated with existing publishing process
- [ ] **Backend API endpoint** for token status queries implemented
- [ ] **Security validation** ensures token ownership and access control
- [ ] **Error handling** covers all edge cases and failure scenarios
- [ ] **Performance benchmarks** met (token checking < 200ms)
- [ ] **Existing publishing workflow** unchanged for new forms
- [ ] **Integration tests** cover token reuse and generation scenarios
- [ ] **User acceptance testing** confirms improved token management

## Risk and Compatibility Assessment

### Primary Risk:

Token status checking could introduce latency or failure points in publishing workflow

### Mitigation:

- Implement token checking as non-blocking background operation
- Fallback to standard publishing if token checking fails
- Comprehensive error handling with graceful degradation

### Rollback Plan:

- Feature flag allows disabling token reuse checking
- Component-level rollback for confirmation dialog
- Backend endpoint can be disabled without affecting existing functionality

## Dependencies and Integration Points

### Frontend Dependencies:

- `TokenReuseConfirmationComponent` (new)
- `PublishDialogComponent` integration
- `FormsApiService` enhancement
- PrimeNG dialog and button components

### Backend Dependencies:

- `FormsService.checkExistingTokens()` method (new)
- Token status API endpoint (new)
- Existing token validation and security middleware
- Forms repository for token queries

### Database Dependencies:

- No schema changes required (uses existing token storage)
- Query optimization for token status checking
- Proper indexing on form_id and expiration columns

## Acceptance Testing Scenarios

### Scenario 1: Form with Valid Existing Token

- **Given:** Form has unexpired active token
- **When:** User clicks "Publish"
- **Then:** Confirmation dialog shows with token details and reuse options

### Scenario 2: Form with Expired Token

- **Given:** Form has expired token
- **When:** User clicks "Publish"
- **Then:** Normal publishing proceeds (no confirmation dialog)

### Scenario 3: Form with No Previous Tokens

- **Given:** Form has never been published
- **When:** User clicks "Publish"
- **Then:** Normal publishing proceeds directly

### Scenario 4: User Chooses Token Reuse

- **Given:** Confirmation dialog displayed
- **When:** User selects "Use existing token"
- **Then:** Existing form URL returned immediately

### Scenario 5: User Chooses New Token Generation

- **Given:** Confirmation dialog displayed
- **When:** User selects "Generate new token"
- **Then:** Normal token generation process proceeds

---

**Story Acceptance:** This story reduces token proliferation and improves user control over form
URLs while maintaining security and performance standards.

**Development Estimate:** 8-10 hours  
**QA Estimate:** 6-8 hours  
**Story Points:** 8
