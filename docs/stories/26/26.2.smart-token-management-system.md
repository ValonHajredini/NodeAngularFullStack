# Story 26.2: Smart Token Management System - Brownfield Enhancement

**Story Status:** Draft  
**Story Owner:** Product Manager  
**Developer:** TBD  
**QA Engineer:** TBD  
**Epic:** 26 - Enhanced Form Publishing System

## User Story

As a **form creator**,  
I want **to be prompted about reusing existing valid tokens when republishing forms**,  
So that **I can avoid generating unnecessary tokens and maintain consistent form URLs while having
control over when to create new tokens**.

## Story Context

**Existing System Integration:**

- Integrates with: `PublishDialogComponent`, `forms.service.ts` token management, and
  `FormsController.publishForm()`
- Technology: Angular 20+ with PrimeNG dialogs, Express.js backend with JWT token validation
- Follows pattern: Existing modal confirmation dialogs and service-based token operations
- Touch points: Token generation service, form metadata storage, publishing workflow

**Current System Behavior:**

- Each publish action generates a new token regardless of existing valid tokens
- Forms can have multiple active tokens pointing to the same content
- No visibility into existing token status during publishing
- Token invalidation only occurs through explicit unpublish action

## Acceptance Criteria

### Functional Requirements:

1. **Existing Token Detection**
   - System checks for existing valid tokens before initiating publish process
   - Valid tokens are those that are unexpired and currently active
   - Detection includes both permanent tokens (no expiration) and future-dated tokens

2. **Token Reuse Confirmation Dialog**
   - When valid token exists, show confirmation dialog with token details
   - Display token expiration status ("No expiration" or specific date)
   - Present clear options: "Use existing token" vs "Generate new token"
   - Include form URL preview for existing token

3. **Smart Publishing Workflow**
   - "Use existing token" skips token generation and returns existing form URL
   - "Generate new token" proceeds with normal token generation process
   - No prompt appears when no valid tokens exist (proceeds directly to publishing)

### Integration Requirements:

4. **Backend Token Query Enhancement**
   - Add `getActiveTokensForForm()` method to forms service
   - Token status checking API endpoint for frontend validation
   - Existing token generation and validation logic preserved unchanged

5. **Frontend Service Integration**
   - `FormsApiService` method to check existing token status
   - Token reuse confirmation component integrated with publishing workflow
   - Publishing service handles both token reuse and generation paths

6. **Token Management Consistency**
   - Token reuse maintains existing security and access control patterns
   - Ownership validation ensures users can only reuse their own form tokens
   - Audit trail preserved for both token reuse and generation events

### Quality Requirements:

7. **User Experience Optimization**
   - Token checking occurs in background without blocking publishing UI
   - Confirmation dialog loads instantly with token information
   - Clear visual indication of token status and recommended action

8. **Performance and Security**
   - Token status queries optimized for minimal latency
   - No sensitive token information exposed in frontend confirmation
   - Token reuse validation maintains existing security standards

9. **Error Handling and Edge Cases**
   - Graceful handling when token status query fails
   - Fallback to normal publishing when token checking is unavailable
   - Clear error messages for token-related issues

## Technical Notes

### Implementation Approach:

- Create `TokenReuseConfirmationComponent` as reusable dialog component
- Extend `FormsService` with `checkExistingTokens()` method
- Modify publishing workflow to include token status check step
- Add backend endpoint for token status queries

### API Enhancement:

```typescript
// New endpoint: GET /api/forms/:id/tokens/status
interface TokenStatusResponse {
  hasValidToken: boolean;
  tokenExpiration: Date | null;
  tokenCreatedAt: Date;
  formUrl: string;
}
```

### Component Integration:

```typescript
// Publishing workflow enhancement
async onPublish() {
  const tokenStatus = await this.checkExistingTokens();
  if (tokenStatus.hasValidToken) {
    this.showTokenReuseDialog(tokenStatus);
  } else {
    this.proceedWithPublishing();
  }
}
```

### Key Constraints:

- Token checking must not delay publishing for forms without existing tokens
- Security validation required to prevent token information leakage
- Backward compatibility with existing token generation workflow
- No changes to existing token storage or validation mechanisms

## Definition of Done

- [ ] **Token status checking** implemented and optimized for performance
- [ ] **Confirmation dialog component** created with proper UX patterns
- [ ] **Token reuse workflow** integrated with existing publishing process
- [ ] **Backend API endpoint** for token status queries implemented
- [ ] **Security validation** ensures token ownership and access control
- [ ] **Error handling** covers all edge cases and failure scenarios
- [ ] **Performance benchmarks** met (token checking < 200ms)
- [ ] **Existing publishing workflow** unchanged for new forms
- [ ] **Integration tests** cover token reuse and generation scenarios
- [ ] **User acceptance testing** confirms improved token management

## Risk and Compatibility Assessment

### Primary Risk:

Token status checking could introduce latency or failure points in publishing workflow

### Mitigation:

- Implement token checking as non-blocking background operation
- Fallback to standard publishing if token checking fails
- Comprehensive error handling with graceful degradation

### Rollback Plan:

- Feature flag allows disabling token reuse checking
- Component-level rollback for confirmation dialog
- Backend endpoint can be disabled without affecting existing functionality

## Dependencies and Integration Points

### Frontend Dependencies:

- `TokenReuseConfirmationComponent` (new)
- `PublishDialogComponent` integration
- `FormsApiService` enhancement
- PrimeNG dialog and button components

### Backend Dependencies:

- `FormsService.checkExistingTokens()` method (new)
- Token status API endpoint (new)
- Existing token validation and security middleware
- Forms repository for token queries

### Database Dependencies:

- No schema changes required (uses existing token storage)
- Query optimization for token status checking
- Proper indexing on form_id and expiration columns

## Acceptance Testing Scenarios

### Scenario 1: Form with Valid Existing Token

- **Given:** Form has unexpired active token
- **When:** User clicks "Publish"
- **Then:** Confirmation dialog shows with token details and reuse options

### Scenario 2: Form with Expired Token

- **Given:** Form has expired token
- **When:** User clicks "Publish"
- **Then:** Normal publishing proceeds (no confirmation dialog)

### Scenario 3: Form with No Previous Tokens

- **Given:** Form has never been published
- **When:** User clicks "Publish"
- **Then:** Normal publishing proceeds directly

### Scenario 4: User Chooses Token Reuse

- **Given:** Confirmation dialog displayed
- **When:** User selects "Use existing token"
- **Then:** Existing form URL returned immediately

### Scenario 5: User Chooses New Token Generation

- **Given:** Confirmation dialog displayed
- **When:** User selects "Generate new token"
- **Then:** Normal token generation process proceeds

---

**Story Acceptance:** This story reduces token proliferation and improves user control over form
URLs while maintaining security and performance standards.

**Development Estimate:** 8-10 hours  
**QA Estimate:** 6-8 hours  
**Story Points:** 8

---

## Dev Agent Record

### Implementation Status: âœ… **COMPLETED**

**Agent Model Used:** Claude Sonnet 4 (claude-sonnet-4-20250514)  
**Implementation Date:** 2025-01-20  
**Development Time:** ~4 hours

### Tasks Completed:

- [x] **Backend Implementation**: Token status API endpoint and service method
- [x] **Frontend Component**: TokenReuseConfirmationComponent with PrimeNG dialog
- [x] **Integration**: Smart token checking workflow in publishing process
- [x] **Error Handling**: Graceful fallback when token checking fails
- [x] **Testing**: Backend integration tests and frontend component tests
- [x] **Type Safety**: Shared TypeScript interfaces and proper type checking

### Debug Log References:

- Backend API endpoint: `GET /api/forms/:id/tokens/status`
- Token reuse confirmation dialog integrated with form builder workflow
- Error handling: Falls back to normal publishing if token check fails
- Performance: Token checking runs in background without blocking UI
- QA Fix: Enhanced test fixtures with form schema creation utilities for proper publish workflow
  testing
- QA Fix: Improved UUID validation to return 400 instead of 500 for malformed UUIDs

### Completion Notes:

1. **Smart Token Management**: System now checks for existing valid tokens before publishing
2. **User Choice**: Clear dialog allows users to reuse existing tokens or generate new ones
3. **Backward Compatibility**: No breaking changes to existing publishing workflow
4. **Security Maintained**: Token ownership validation and access control preserved
5. **Performance Optimized**: Token status checked asynchronously with fallback handling

### File List:

**Backend Files:**

- `packages/shared/src/types/forms.types.ts` - Added TokenStatusResponse interface
- `apps/api/src/services/forms.service.ts` - Added checkExistingTokens() method
- `apps/api/src/controllers/forms.controller.ts` - Added getTokenStatus endpoint with UUID
  validation fix
- `apps/api/src/routes/forms.routes.ts` - Added token status route with Swagger docs
- `apps/api/tests/integration/token-status.test.ts` - Comprehensive API tests with schema creation
  fix
- `apps/api/tests/helpers/data-factory.ts` - Enhanced with form schema creation utilities

**Frontend Files:**

- `apps/web/src/app/features/tools/components/form-builder/forms-api.service.ts` - Added
  checkTokenStatus method
- `apps/web/src/app/features/tools/components/form-builder/token-reuse-confirmation/token-reuse-confirmation.component.ts` -
  New confirmation dialog component
- `apps/web/src/app/features/tools/components/form-builder/token-reuse-confirmation/token-reuse-confirmation.component.html` -
  Dialog template
- `apps/web/src/app/features/tools/components/form-builder/token-reuse-confirmation/token-reuse-confirmation.component.scss` -
  Dialog styles
- `apps/web/src/app/features/tools/components/form-builder/token-reuse-confirmation/token-reuse-confirmation.component.spec.ts` -
  Component tests
- `apps/web/src/app/features/tools/components/form-builder/form-builder.component.ts` - Enhanced
  publishing workflow with token checking

### Change Log:

1. **Token Status API**: Created new endpoint to check existing valid tokens for forms
2. **Confirmation Dialog**: Built reusable component for token reuse decisions
3. **Publishing Enhancement**: Modified form builder to include smart token management
4. **Type Definitions**: Added shared interfaces for token status responses
5. **Comprehensive Testing**: Backend integration tests and frontend component tests
6. **Documentation**: Added Swagger documentation for new API endpoint
7. **QA Fixes (2025-01-20)**:
   - Enhanced test data factory with form schema creation utilities for complete publish workflow
     testing
   - Fixed UUID validation in getTokenStatus controller to return 400 instead of 500 for malformed
     UUIDs
   - Improved test coverage for token status workflow with proper schema setup

**Status:** Ready for Review

## QA Results

### Review Date: 2025-01-20

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall Assessment: GOOD with minor concerns**

The implementation successfully delivers the core functionality for smart token management with a
well-structured approach across both backend and frontend. The code follows established patterns and
maintains good separation of concerns.

**Strengths:**

- Clean service layer implementation with proper error handling
- Comprehensive TypeScript interface definitions in shared package
- Angular component follows reactive patterns with proper signal usage
- Good security validation preserving ownership checks
- Fallback handling for token checking failures

**Areas for Improvement:**

- Test setup requires schema dependencies that aren't properly documented
- UUID validation could be more robust in error handling
- Token status API could benefit from more detailed logging for debugging

### Refactoring Performed

- **File**: `apps/api/tests/helpers/test-server.ts`
  - **Change**: Added missing route imports and legacy route support for tests
  - **Why**: Test server was missing essential route configurations causing 404s
  - **How**: Imported auth, forms, themes, and public routes; added both v1 and legacy paths

### Compliance Check

- **Coding Standards**: âœ“ TypeScript strict mode, proper JSDoc comments, consistent naming
- **Project Structure**: âœ“ Follows monorepo patterns, proper separation of concerns
- **Testing Strategy**: âœ— Test issues identified - schema dependencies not properly handled
- **All ACs Met**: âœ“ Core functionality implemented per requirements

### Improvements Checklist

[x] Fixed test server route configuration (test-server.ts) [x] Verified security validation
maintains ownership checks (forms.service.ts) [x] Confirmed error handling with graceful fallback
(form-builder.component.ts) [ ] Complete test suite needs schema creation utilities for proper
publishing tests [ ] UUID validation error handling could be more specific (forms.service.ts:477) [
] Consider adding more detailed logging for token status checks for debugging

### Security Review

**PASS** - Security measures properly implemented:

- Token ownership validation preserved
- Authentication required for all endpoints
- No token information leakage in frontend
- Proper access control maintained

### Performance Considerations

**PASS** - Performance requirements met:

- Token checking runs asynchronously without blocking UI
- Background token status queries optimized
- Fallback handling prevents publishing delays
- No N+1 query issues detected

### Files Modified During Review

- `apps/api/tests/helpers/test-server.ts` - Fixed missing route configurations

### Gate Status

Gate: **CONCERNS** â†’ docs/qa/gates/26.2-smart-token-management-system.yml

### Recommended Status

**âœ“ Ready for Done** with minor test improvements recommended (Story owner decides final status -
core functionality is solid and secure)
