# Story 7.3: Tool: Short Link (UI + API + Redirect)

## Status

Draft

## Story

**As a** user, **I want** to create shortened URLs with optional expiration dates and easily copy
them, **so that** I can share compact links that optionally expire after a specified time.

## Acceptance Criteria

1. Short Link component created as standalone Angular component
2. Component includes: URL input field, optional expiration datetime picker, "Shorten" button,
   result display with copy button
3. API endpoints created: POST /api/tools/short-links (create), GET /api/tools/short-links/:code
   (resolve)
4. Database table `short_links` created with columns: `id` (UUID), `code` (unique, 6-8 chars),
   `original_url`, `expires_at` (nullable), `created_by` (nullable), `created_at`, `updated_at`
5. Public redirect route `/s/:code` implemented that resolves and redirects to original URL
6. Expired links return 410 Gone status, invalid codes return 404
7. URL validation ensures only safe URLs are shortened (no javascript:, data:, etc.)
8. Component only renders when "short-link" tool is enabled in tools registry
9. Copy-to-clipboard functionality with success feedback
10. Analytics tracking: click count and last accessed timestamp

## Tasks / Subtasks

- [ ] Create database migration for short_links table (AC: 4, 10)
  - [ ] Create migration file:
        apps/api/database/migrations/[timestamp]\_create_short_links_table.sql
  - [ ] Define table schema with UUID primary key
  - [ ] Add unique constraint on `code` column
  - [ ] Add indexes on code and expires_at for query performance
  - [ ] Add click_count and last_accessed columns for analytics
- [ ] Create shared types for short links (AC: 2, 3)
  - [ ] Update packages/shared/src/types/tools.types.ts
  - [ ] Define ShortLink interface
  - [ ] Define CreateShortLinkRequest and ShortLinkResponse interfaces
- [ ] Implement backend repository layer (AC: 3, 4)
  - [ ] Create apps/api/src/repositories/short-links.repository.ts
  - [ ] Implement create() method with code generation
  - [ ] Implement findByCode() method
  - [ ] Implement incrementClickCount() method
  - [ ] Handle expired link queries
- [ ] Implement backend service layer (AC: 3, 6, 7, 8)
  - [ ] Create apps/api/src/services/short-links.service.ts
  - [ ] Implement createShortLink() with URL validation
  - [ ] Implement resolveShortLink() with expiration check
  - [ ] Check tool enabled status before operations
  - [ ] Generate unique short codes (6-8 alphanumeric)
  - [ ] Validate URL scheme and domain safety
- [ ] Create API controllers and routes (AC: 3, 6)
  - [ ] Create apps/api/src/controllers/short-links.controller.ts
  - [ ] Implement POST endpoint for creating short links
  - [ ] Implement GET endpoint for resolving codes
  - [ ] Add input validation middleware
  - [ ] Return appropriate status codes (410 for expired, 404 for not found)
  - [ ] Create apps/api/src/routes/short-links.routes.ts
- [ ] Implement public redirect route (AC: 5, 6)
  - [ ] Add route handler in apps/api/src/routes/public.routes.ts
  - [ ] Implement /s/:code endpoint
  - [ ] Perform 302 redirect for valid links
  - [ ] Return 410 for expired links
  - [ ] Return 404 for invalid codes
  - [ ] Track analytics on redirect
- [ ] Create Angular short link service (AC: 1, 2)
  - [ ] Create apps/web/src/app/features/tools/services/short-link.service.ts
  - [ ] Implement createShortLink() method
  - [ ] Handle API responses and errors
  - [ ] Generate full short URL with domain
- [ ] Create Short Link component (AC: 1, 2, 8, 9)
  - [ ] Create apps/web/src/app/features/tools/components/short-link/short-link.component.ts
  - [ ] Add URL input field with validation
  - [ ] Add PrimeNG Calendar for expiration date/time
  - [ ] Implement "Shorten" button with loading state
  - [ ] Display shortened URL result
  - [ ] Add copy-to-clipboard button with feedback
  - [ ] Apply \*appToolGate="'short-link'" directive
  - [ ] Style with Tailwind CSS
- [ ] Implement URL validation (AC: 7)
  - [ ] Create apps/api/src/validators/url.validators.ts
  - [ ] Validate URL format and structure
  - [ ] Block dangerous schemes (javascript:, data:, file:, etc.)
  - [ ] Ensure HTTP/HTTPS only
  - [ ] Add maximum URL length validation
- [ ] Add clipboard functionality (AC: 9)
  - [ ] Implement copy-to-clipboard in component
  - [ ] Show PrimeNG Toast notification on copy
  - [ ] Handle clipboard API permissions
  - [ ] Provide fallback for older browsers
- [ ] Create tool page and routing (AC: 1)
  - [ ] Create apps/web/src/app/features/tools/pages/short-link/short-link.page.ts
  - [ ] Add to tools routing module
  - [ ] Add navigation menu item (when tool enabled)
  - [ ] Apply tool guard to route
- [ ] Add unit tests
  - [ ] Test short-links repository
        (apps/api/tests/unit/repositories/short-links.repository.test.ts)
  - [ ] Test short-links service (apps/api/tests/unit/services/short-links.service.test.ts)
  - [ ] Test URL validation (apps/api/tests/unit/validators/url.validators.test.ts)
  - [ ] Test API endpoints (apps/api/tests/integration/short-links.test.ts)
  - [ ] Test Angular service (apps/web/src/app/features/tools/services/short-link.service.spec.ts)
  - [ ] Test Short Link component
        (apps/web/src/app/features/tools/components/short-link/short-link.component.spec.ts)
- [ ] Add integration tests for redirect flow
  - [ ] Test successful redirect
  - [ ] Test expired link handling
  - [ ] Test invalid code handling
  - [ ] Test analytics tracking

## Dev Notes

### Testing Standards

[Source: architecture/testing-strategy.md#Test Organization]

- Backend unit tests: apps/api/tests/unit/
- Backend integration tests: apps/api/tests/integration/
- Frontend tests: alongside source files with .spec.ts
- Use Jest for backend, Karma/Jasmine for frontend
- Mock external dependencies in unit tests

### Database Schema

[Source: architecture/database-schema.md#Database Schema]

- Use UUID for primary keys
- Add appropriate indexes for query performance
- Include created_at and updated_at timestamps
- Consider adding click_count for analytics
- Use nullable expires_at for optional expiration

### Backend Architecture

[Source: architecture/backend-architecture.md#Service Architecture]

- Repository: Data access and queries
- Service: Business logic, validation, code generation
- Controller: HTTP handling, status codes
- Use AsyncHandler wrapper for controllers
- Follow existing error handling patterns

### Short Code Generation

- Use nanoid or similar for URL-safe codes
- Length: 6-8 characters for balance of brevity and uniqueness
- Retry on collision (though unlikely with proper length)
- Consider custom alphabet to avoid ambiguous characters

### URL Validation Rules

[Source: architecture/coding-standards.md#Input Validation]

- Allow only HTTP and HTTPS schemes
- Block dangerous protocols (javascript:, data:, file:, etc.)
- Validate URL structure with URL constructor
- Set maximum URL length (e.g., 2048 characters)
- Consider domain whitelist/blacklist if needed

### Frontend Component Structure

[Source: architecture/frontend-architecture.md#Component Architecture]

- Standalone component with PrimeNG imports
- Use signals for reactive state
- ChangeDetectionStrategy.OnPush for performance
- Proper form validation with reactive forms
- Loading states for async operations

### PrimeNG Components

[Source: architecture/tech-stack.md#Technology Stack Table]

- InputText for URL input
- Calendar for datetime selection
- Button with loading state
- Toast for notifications
- Card or Panel for layout

### Clipboard Implementation

- Use navigator.clipboard API
- Fallback to document.execCommand for older browsers
- Show success feedback via Toast
- Handle permissions and errors gracefully

### Public Route Implementation

- Must work without authentication
- Efficient lookup by code with index
- Proper HTTP status codes (302, 404, 410)
- No sensitive information in responses
- Consider rate limiting for abuse prevention

### Tool Integration

[Source: Epic 7 requirements]

- Component must check tool enabled status
- Use ToolsService from Story 7.2
- Apply \*appToolGate directive
- Handle disabled state gracefully

### Coding Standards

[Source: architecture/coding-standards.md#Critical Fullstack Rules]

- Types in packages/shared/src/types/
- JSDoc comments for all public methods
- Parameterized queries for database
- Validate input on frontend and backend
- Use proper error handling patterns

### File Locations

[Source: architecture/source-tree.md#Architecture Principles]

- Backend repository: apps/api/src/repositories/
- Backend service: apps/api/src/services/
- Backend controller: apps/api/src/controllers/
- Backend routes: apps/api/src/routes/
- Frontend feature: apps/web/src/app/features/tools/
- Shared types: packages/shared/src/types/

### Security Considerations

- Validate and sanitize all URLs
- Rate limit creation endpoint
- Consider CAPTCHA for public creation
- Log suspicious activity
- Implement proper CORS headers

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-09-26 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

(To be filled by dev agent)

### Debug Log References

(To be filled by dev agent)

### Completion Notes List

(To be filled by dev agent)

### File List

(To be filled by dev agent)

## QA Results

(To be filled by QA agent)
