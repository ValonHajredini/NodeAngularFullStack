# Story 30.3: Poll and Quiz Analytics Strategies (Backend)

## Status

Draft

## Story

**As a** backend developer, **I want** analytics strategies for Poll and Quiz templates, **so that**
vote distributions and score distributions can be computed.

## Acceptance Criteria

1. `PollAnalyticsStrategy` implements vote aggregation with percentages
2. `QuizAnalyticsStrategy` implements score distribution histogram
3. Queries use PostgreSQL JSONB operators efficiently (<300 ms)
4. Edge cases handled (zero votes, missing scores)
5. Unit tests for both strategies
6. Integration tests with test data

## Tasks / Subtasks

- [ ] **Task 1: Extend repository with poll + quiz helpers** (AC: 1, 2, 3)
  - [ ] Add methods such as `getPollOptionCounts(formId, tenantId)` and
        `getQuizScoreBuckets(formId, tenantId)` in the analytics repository that leverage JSONB
        operators on `form_submissions.values`.
        `[Source: docs/architecture/epic-18-architecture-diagram.md#storage--database]`
  - [ ] Use prepared statements and indexes aligned with the FORMS database tables to keep query
        latency under the documented performance targets.
        `[Source: docs/architecture/database-separation-implementation-summary.md#forms-database-nodeangularfullstack_forms]`

- [ ] **Task 2: Implement `PollAnalyticsStrategy`** (AC: 1, 3, 4)
  - [ ] Create `apps/api/src/services/analytics/strategies/poll-analytics.strategy.ts` that composes
        repository helpers to calculate absolute counts, total votes, and normalized percentages for
        each option. `[Source: docs/architecture/backend-architecture.md#service-architecture]`
  - [ ] Cover fallback paths: return zeroed metrics when submissions are absent and support
        `showResultsAfterVote` flags coming from shared config.
        `[Source: docs/architecture/security-and-performance.md#performance-optimization]`
  - [ ] Emit strongly typed `CategoryMetrics` for Polls to keep parity with shared DTOs from Story
        30.1. `[Source: docs/architecture/source-tree.md#packagesshared]`

- [ ] **Task 3: Implement `QuizAnalyticsStrategy`** (AC: 2, 3, 4)
  - [ ] Create `apps/api/src/services/analytics/strategies/quiz-analytics.strategy.ts` that groups
        scores into histogram buckets (e.g., 0-10, 11-20, …) using SQL windowing or CASE
        expressions. `[Source: docs/architecture/backend-architecture.md#service-architecture]`
  - [ ] Handle missing or malformed score values by filtering them out and surfacing them via
        `CategoryMetrics` diagnostics so analytics UI can present an empty state.
        `[Source: docs/architecture/security-and-performance.md#performance-optimization]`

- [ ] **Task 4: Optimize JSONB queries for <300 ms** (AC: 3)
  - [ ] Profile the new SQL statements with EXPLAIN ANALYZE against sample data to ensure they meet
        the backend performance targets (P95 <200 ms, P99 <500 ms) even when forms have thousands of
        submissions.
        `[Source: docs/architecture/security-and-performance.md#performance-optimization]`
  - [ ] Add any missing partial indexes or materialized helpers in migrations if profiling shows
        slow scans.
        `[Source: docs/architecture/database-separation-implementation-summary.md#forms-database-nodeangularfullstack_forms]`

- [ ] **Task 5: Add Jest unit tests for both strategies** (AC: 5)
  - [ ] Place specs under `apps/api/tests/unit/services/analytics` mocking repository responses to
        cover edge cases (zero votes, null scores, invalid metadata) with ≥90% coverage.
        `[Source: docs/architecture/testing-strategy.md#backend-tests]`

- [ ] **Task 6: Create integration tests with seeded data** (AC: 6)
  - [ ] Seed representative poll and quiz submissions in the FORMS database fixture, then add
        Supertest-based specs that call the analytics service/endpoint to verify JSON output matches
        expectations. `[Source: docs/architecture/testing-strategy.md#backend-api-test]`
  - [ ] Exercise failure paths (invalid formId, unauthorized access) to ensure error responses
        follow the shared ApiError contract.
        `[Source: docs/architecture/error-handling-strategy.md#error-flow]`

## Dev Notes

### Previous Story Insights

- No specific guidance found in architecture docs.

### Data Models

- Poll and quiz submissions are stored in the FORMS database, with responses serialized as JSONB in
  `form_submissions`, so repository helpers must query those columns efficiently.
  `[Source: docs/architecture/database-separation-implementation-summary.md#forms-database-nodeangularfullstack_forms]`
- The architecture diagram highlights the JSONB metadata/value columns used throughout the template
  system, reinforcing the need to use JSON operators for option counts and score aggregation.
  `[Source: docs/architecture/epic-18-architecture-diagram.md#storage--database]`

### API Specifications

- Analytics responses must align with the OpenAPI-described error format and authentication scheme
  to integrate cleanly once the category endpoint is added in Story 30.5.
  `[Source: docs/architecture/api-specification.md#rest-api-specification]`

### Component Specifications

- No specific guidance found in architecture docs.

### File Locations

- Strategy implementations live in the service layer under `apps/api/src/services`, mirroring other
  domain-specific strategies shown in the backend structure guide.
  `[Source: docs/architecture/source-tree.md#backend-structure-appsapi]`
- Shared DTOs consumed (PollMetrics, QuizMetrics) continue to reside in `packages/shared/src/types`.
  `[Source: docs/architecture/source-tree.md#packagesshared]`

### Testing Requirements

- Jest unit tests belong alongside other service specs in `apps/api/tests/unit/services`, ensuring
  deterministic coverage for each strategy path.
  `[Source: docs/architecture/testing-strategy.md#backend-tests]`
- Integration tests should follow the documented Supertest pattern to exercise Express routes
  against a real test database when verifying aggregated payloads.
  `[Source: docs/architecture/testing-strategy.md#backend-api-test]`

### Technical Constraints

- Backend response targets (P95 <200 ms) apply to analytics queries, so SQL and transformation code
  must be optimized for large submission sets.
  `[Source: docs/architecture/security-and-performance.md#performance-optimization]`
- Clean architecture layering requires strategies to delegate I/O to repositories while keeping
  business logic (percent normalization, histogram binning) inside services.
  `[Source: docs/architecture/backend-architecture.md#service-architecture]`
- All TypeScript artifacts should maintain JSDoc comments and strict typing guidance per coding
  standards. `[Source: docs/architecture/coding-standards.md#documentation-standards]`

## Testing

- Unit test each strategy with mocked repository outputs covering success paths plus
  zero-vote/zero-score scenarios following the backend unit testing layout.
  `[Source: docs/architecture/testing-strategy.md#backend-tests]`
- Run Supertest integration scenarios after seeding poll and quiz submissions to validate JSON
  responses and ApiError handling.
  `[Source: docs/architecture/testing-strategy.md#backend-api-test]`

## Change Log

| Date       | Version | Description                          | Author             |
| ---------- | ------- | ------------------------------------ | ------------------ |
| 2025-01-27 | 1.0     | Initial story draft and task outline | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be populated by the development agent._

### Debug Log References

_To be populated by the development agent._

### Completion Notes List

_To be populated by the development agent._

### File List

_To be populated by the development agent._

## QA Results

_QA review not yet executed for this draft._
