# Story 10.9: Public Form Renderer with Dynamic Form Generation

## Status

Draft

## Story

**As a** form respondent, **I want** to access a published form via tokenized URL and fill it out,
**so that** I can submit my responses to the form creator.

## Acceptance Criteria

1. **AC1**: Public route `/forms/render/:token` accessible without authentication
2. **AC2**: `GET /api/public/forms/render/:token` endpoint validates token, checks expiration, and
   returns form schema
3. **AC3**: Invalid/expired token shows error page with message
4. **AC4**: Form renderer component dynamically builds Angular Reactive FormGroup from schema JSON
5. **AC5**: All field types render correctly: text inputs, selects, checkboxes, radio groups, date
   pickers, file uploads
6. **AC6**: Validators applied based on schema: required, min/max, email, pattern
7. **AC7**: Conditional visibility rules evaluated reactively (fields show/hide based on form
   values)
8. **AC8**: Hidden fields have values cleared automatically
9. **AC9**: Inline validation messages display below fields on blur
10. **AC10**: Submit button disabled while form invalid or submitting
11. **AC11**: Column layout (1-3 columns) rendered based on form settings
12. **AC12**: Form styling matches published form's configured theme

## Tasks / Subtasks

- [ ] Create public form render API endpoint (AC: 2, 3)
  - [ ] Create `/apps/api/src/routes/public.routes.ts` (if not exists)
  - [ ] Add GET `/api/public/forms/render/:token` route (no auth middleware)
  - [ ] Create PublicFormsController.renderForm method
  - [ ] Validate JWT token using jsonwebtoken.verify() with FORM_RENDER_TOKEN_SECRET
  - [ ] Check token expiration (expiresAt field)
  - [ ] If invalid/expired: return 404 with error message
  - [ ] Find form_schema by formSchemaId from token payload
  - [ ] Verify is_published=true
  - [ ] Return form schema JSON with form settings
  - [ ] Apply rate limiting: 10 requests per minute per IP
  - [ ] Add OpenAPI/Swagger annotations (public endpoint)

- [ ] Create form renderer component (AC: 1, 4, 11, 12)
  - [ ] Create `/apps/web/src/app/features/public/form-renderer/form-renderer.component.ts`
  - [ ] Make standalone component (no auth required)
  - [ ] Import ReactiveFormsModule, CommonModule, PrimeNG modules
  - [ ] Configure public route: `{ path: 'forms/render/:token', component: FormRendererComponent }`
  - [ ] Route does NOT use authGuard (public access)
  - [ ] Inject ActivatedRoute to get token from params
  - [ ] Inject FormRendererService (new service for API calls)
  - [ ] On init: call formRendererService.getFormSchema(token)
  - [ ] Build dynamic FormGroup from schema using FormBuilder
  - [ ] Render form layout based on columnLayout setting (1-3 columns CSS grid)
  - [ ] Apply form theme/styling from schema settings

- [ ] Implement dynamic FormGroup generation (AC: 4, 5, 6)
  - [ ] Create buildFormGroup(schema: FormSchema): FormGroup method
  - [ ] Loop through schema.fields array
  - [ ] For each field, create FormControl with:
    - Default value from field.defaultValue
    - Validators array based on field validation rules
  - [ ] Validators mapping:
    - required: Validators.required
    - minLength/maxLength: Validators.minLength(n), Validators.maxLength(n)
    - min/max (numbers): Validators.min(n), Validators.max(n)
    - pattern: Validators.pattern(regex)
    - email: Validators.email
  - [ ] Add FormControl to FormGroup with field.fieldName as key
  - [ ] Return completed FormGroup

- [ ] Implement field type rendering (AC: 5)
  - [ ] Create field renderer switch based on field.type:
    - text/email/number: PrimeNG InputText/InputNumber
    - textarea: PrimeNG Textarea
    - select: PrimeNG Dropdown (options from field.options)
    - radio: PrimeNG RadioButton group
    - checkbox: PrimeNG Checkbox
    - toggle: PrimeNG InputSwitch
    - date: PrimeNG Calendar (date only)
    - datetime: PrimeNG Calendar (showTime=true)
    - file: PrimeNG FileUpload
    - divider: Simple HR or styled divider
  - [ ] Bind FormControl to each field component
  - [ ] Display field label, placeholder, help text
  - [ ] Apply disabled/readOnly from field properties

- [ ] Implement conditional visibility (AC: 7, 8)
  - [ ] Create isFieldVisible(field: FormField): boolean method
  - [ ] Check if field has showIf rule
  - [ ] If no rule: return true (always visible)
  - [ ] If rule exists:
    - Get showIfField FormControl value
    - Compare using operator (equals, not-equals, contains)
    - Return true/false based on condition
  - [ ] Use @if directive to show/hide fields reactively
  - [ ] Subscribe to formGroup.valueChanges
  - [ ] When values change, re-evaluate visibility for all fields
  - [ ] Clear values of hidden fields automatically using patchValue({ [fieldName]: null })

- [ ] Implement inline validation (AC: 9, 10)
  - [ ] Display validation errors below each field
  - [ ] Show errors only on blur or touched state
  - [ ] Error messages:
    - required: "This field is required"
    - minLength: "Minimum length is {n} characters"
    - maxLength: "Maximum length is {n} characters"
    - min/max: "Value must be between {min} and {max}"
    - pattern: "Invalid format" (or custom message from schema)
    - email: "Invalid email address"
  - [ ] Use PrimeNG Message component for error display
  - [ ] Disable submit button when formGroup.invalid or submitting
  - [ ] Add visual indicator (spinner) during submission

- [ ] Implement responsive column layout (AC: 11)
  - [ ] Read columnLayout from form settings (1, 2, or 3)
  - [ ] Apply CSS Grid:
    - 1 column: `grid-template-columns: 1fr`
    - 2 columns: `grid-template-columns: repeat(2, 1fr)`
    - 3 columns: `grid-template-columns: repeat(3, 1fr)`
  - [ ] Responsive breakpoints:
    - Mobile (<768px): Always 1 column
    - Tablet (768-1024px): Max 2 columns
    - Desktop (>1024px): Use configured layout
  - [ ] Apply field spacing from settings (compact/normal/relaxed)

- [ ] Create FormRendererService for API calls (AC: 2)
  - [ ] Create `/apps/web/src/app/features/public/form-renderer/form-renderer.service.ts`
  - [ ] Inject HttpClient
  - [ ] Implement
        `getFormSchema(token: string): Observable<{ schema: FormSchema, settings: FormSettings }>`
        method
  - [ ] GET /api/public/forms/render/:token
  - [ ] Handle errors: 404 (invalid token), 410 (expired token)
  - [ ] Return schema and settings

- [ ] Implement error page for invalid tokens (AC: 3)
  - [ ] Create error state component or section
  - [ ] Display user-friendly messages:
    - "Form not found" (404)
    - "This form has expired" (410/expired token)
    - "Invalid form link" (invalid token)
  - [ ] Show icon and helpful text
  - [ ] Optional: "Contact form creator" message
  - [ ] Handle loading states and network errors

- [ ] Apply rate limiting and security (IV: 1, 2)
  - [ ] Backend: Use express-rate-limit on render endpoint
  - [ ] Limit: 10 requests per minute per IP
  - [ ] Frontend: Handle 429 Too Many Requests
  - [ ] Show "Too many requests, please try again later" message
  - [ ] No authentication required (bypass AuthGuard)

- [ ] Write tests for form renderer (IV: 3, 4, 5)
  - [ ] Backend tests:
    - Test GET /api/public/forms/render/:token with valid token
    - Test invalid token returns 404
    - Test expired token returns 410
    - Test rate limiting (10/min per IP)
  - [ ] Frontend tests:
    - Test FormGroup generation from schema
    - Test all field types render correctly
    - Test validators applied from schema
    - Test conditional visibility rules
    - Test hidden field value clearing
    - Test submit button disabled when invalid
    - Mock FormRendererService
  - [ ] Cross-browser testing: Chrome, Firefox, Safari, Edge
  - [ ] Mobile responsive testing: phone and tablet
  - [ ] Accessibility testing: keyboard navigation, screen reader

## Dev Notes

### Previous Story Insights

Story 10.8 implemented form publishing and token generation. This story creates the public-facing
renderer that consumes those tokens.

### Data Models

**Form Schema Response:** [Source: docs/prd-form-builder/epic-10#Story-1.9-AC2]

```typescript
{
  schema: FormSchema {
    id: string,
    formId: string,
    version: number,
    fields: FormField[],
    settings: {
      columnLayout: 1 | 2 | 3,
      fieldSpacing: 'compact' | 'normal' | 'relaxed',
      successMessage: string,
      redirectUrl?: string
    }
  }
}
```

**Dynamic FormGroup Structure:**

- Keys: field.fieldName (kebab-case)
- Values: FormControl with validators
- Example: `{ 'first-name': FormControl, 'email': FormControl }`

### API Specifications

**Public Render Endpoint:** [Source: docs/prd-form-builder/epic-10#Story-1.9-AC2]

- GET /api/public/forms/render/:token
- No authentication required
- Rate limited: 10 requests per minute per IP
- Response: `{ success: true, data: { schema, settings } }`
- Errors:
  - 404: Invalid token or form not found
  - 410: Token expired
  - 429: Too many requests

### Component Specifications

**Public Route Configuration:** [Source:
docs/architecture/frontend-architecture.md#Routing-Architecture]

- Route: `/forms/render/:token`
- No authGuard (public access)
- Standalone component
- Lazy loaded

**Dynamic Form Generation:** [Source: docs/prd-form-builder/epic-10#Story-1.9-AC4]

- Use FormBuilder.group() to create dynamic FormGroup
- Map schema fields to FormControls
- Apply validators based on validation rules
- Reactive form pattern with valueChanges for conditional visibility

**Field Type Mapping:** [Source: docs/prd-form-builder/epic-10#Story-1.9-AC5]

- text → InputText
- email → InputText with email validator
- number → InputNumber
- select → Dropdown
- textarea → Textarea
- checkbox → Checkbox
- radio → RadioButton group
- toggle → InputSwitch
- date → Calendar
- datetime → Calendar with showTime
- file → FileUpload
- divider → HR element

### File Locations

**Backend:** [Source: docs/architecture/unified-project-structure.md#apps/api]

- Create: `/apps/api/src/routes/public.routes.ts` (if not exists)
- Create: `/apps/api/src/controllers/public-forms.controller.ts`
- Register in: `/apps/api/src/index.ts` with `app.use('/api/public', publicRouter)`

**Frontend:** [Source: docs/architecture/unified-project-structure.md#apps/web]

- Create: `/apps/web/src/app/features/public/form-renderer/form-renderer.component.ts`
- Create: `/apps/web/src/app/features/public/form-renderer/form-renderer.service.ts`
- Update: App routes (add public route without authGuard)

**Tests:** [Source: docs/architecture/testing-strategy.md]

- Create: `/apps/api/tests/integration/public-forms.test.ts`
- Create: `/apps/web/src/app/features/public/form-renderer/form-renderer.component.spec.ts`

### Testing Requirements

**Backend Tests:** [Source: docs/architecture/testing-strategy.md#Backend-API-Test]

- Test token validation (valid, invalid, expired)
- Test rate limiting enforcement
- Test published form retrieval
- Test 404 for non-existent forms
- Test security: no SQL injection via token

**Frontend Tests:** [Source: docs/architecture/testing-strategy.md#Frontend-Component-Test]

- Test dynamic FormGroup creation
- Test all field types render with correct components
- Test validators applied correctly
- Test conditional visibility logic
- Test value clearing on field hide
- Test submit button disabled states
- Mock HTTP calls with test schemas

**Cross-Browser Testing:** [Source: docs/prd-form-builder/epic-10#Story-1.9-IV3]

- Chrome, Firefox, Safari, Edge
- Test all field types render correctly
- Test date pickers work in all browsers
- Test file upload works

**Responsive Testing:** [Source: docs/prd-form-builder/epic-10#Story-1.9-IV4]

- Phone (375px, 414px)
- Tablet (768px, 1024px)
- Desktop (1920px)
- Test column layout adapts correctly

**Accessibility Testing:** [Source: docs/prd-form-builder/epic-10#Story-1.9-IV5]

- All fields have labels (from schema)
- Keyboard navigation works (Tab, Enter)
- Screen reader announces field labels and errors
- WCAG 2.1 AA compliance

**Test Commands:** [Source: docs/CLAUDE.md#Testing-Commands]

- Backend: `npm --workspace=apps/api run test -- --testPathPattern="public-forms.test.ts"`
- Frontend:
  `npm --workspace=apps/web run test -- --include="**/form-renderer.component.spec.ts" --watch=false`

### Technical Constraints

**Public Route Security:** [Source:
docs/architecture/frontend-architecture.md#Protected-Route-Pattern]

- Route does NOT use authGuard
- Token validation happens on API call
- No user session required
- Rate limiting on API for DDoS protection

**Dynamic Form Validation:** [Source:
docs/architecture/frontend-architecture.md#State-Management-Patterns]

- Use Angular Validators API
- Map schema validation to Angular validators
- Custom validators for complex rules (regex patterns)
- Real-time validation on blur

**Conditional Visibility Logic:** [Source: docs/prd-form-builder/epic-10#Story-1.9-AC7-AC8]

- Subscribe to formGroup.valueChanges
- Re-evaluate all showIf rules on value change
- Use computed signals or observables for reactive visibility
- Clear hidden field values immediately (patchValue)

**Responsive Layout:** [Source: docs/prd-form-builder/epic-10#Story-1.9-AC11]

- CSS Grid for column layout
- Breakpoints: mobile (<768px), tablet (768-1024px), desktop (>1024px)
- Always 1 column on mobile
- Respect columnLayout setting on larger screens

**PrimeNG Components:** [Source: docs/architecture/tech-stack.md]

- PrimeNG 17+ for all form controls
- Consistent styling with Tailwind
- Use PrimeNG validation display (Message component)

### Testing

**Test File Location:** [Source: docs/architecture/testing-strategy.md]

- `/apps/api/tests/integration/public-forms.test.ts`
- `/apps/web/src/app/features/public/form-renderer/form-renderer.component.spec.ts`

**Testing Standards:** [Source: docs/architecture/testing-strategy.md]

- Test token validation edge cases
- Test all 12 field types render correctly
- Test validator mappings are correct
- Test conditional visibility with various rules
- Test responsive layout at different breakpoints
- Mock API responses with test schemas

**Testing Frameworks:** [Source: docs/architecture/tech-stack.md]

- Jest + Supertest for backend
- Karma + Jasmine for Angular
- Playwright for E2E cross-browser testing

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-04 | 1.0     | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
