# Story 30.1.1: Tool Registry Database Schema

## Status

Approved

## Story

**As a** backend developer, **I want** a database schema for storing tool metadata, **so that**
tools can be registered and discovered in the system.

## Acceptance Criteria

1. ✅ `tool_registry` table created with all required fields
2. ✅ Indexes on `tool_id`, `status`, `is_exported`
3. ✅ Migration script in `database/migrations/`
4. ✅ Schema documented in code comments

## Tasks / Subtasks

- [ ] **Task 1: Create migration file for tool_registry table** (AC: 1, 3)
  - [ ] Create new migration file in `apps/api/database/migrations/` with timestamp prefix
  - [ ] Add CREATE TABLE statement with all fields per PRD specification
  - [ ] Include UUID extension if not already enabled
  - [ ] Add `created_by` foreign key to users table
  - [ ] Implement updated_at trigger using existing `update_updated_at_column()` function
  - [ ] Add DOWN migration (DROP TABLE) for rollback support

- [ ] **Task 2: Create indexes for performance** (AC: 2)
  - [ ] Create index on `tool_id` column
  - [ ] Create index on `status` column
  - [ ] Create index on `is_exported` column
  - [ ] Create index on `created_at DESC` for chronological queries

- [ ] **Task 3: Add TypeScript interface to shared package** (AC: 4)
  - [ ] Create `tool-registry.types.ts` in `packages/shared/src/types/`
  - [ ] Define `ToolRegistryRecord` interface matching database schema
  - [ ] Define `CreateToolInput` interface (omit auto-generated fields)
  - [ ] Define `UpdateToolInput` interface (all fields optional)
  - [ ] Define `ToolManifest` interface for JSONB field structure
  - [ ] Add comprehensive JSDoc comments per coding standards
  - [ ] Export types from `packages/shared/src/types/index.ts`

- [ ] **Task 4: Run migration and verify schema** (AC: 1, 2)
  - [ ] Execute migration: `npm --workspace=apps/api run db:migrate`
  - [ ] Verify table exists: `\d tool_registry` in psql
  - [ ] Verify all indexes created: `\d tool_registry` shows indexes
  - [ ] Verify trigger attached for updated_at

- [ ] **Task 5: Write migration tests** (AC: 1, 2, 3)
  - [ ] Create test file: `apps/api/tests/integration/migrations/tool-registry-migration.test.ts`
  - [ ] Test: Migration runs successfully
  - [ ] Test: Rollback migration succeeds
  - [ ] Test: All indexes exist after migration
  - [ ] Test: Constraints enforced (unique tool_id, NOT NULL fields)
  - [ ] Test: Updated_at trigger fires on UPDATE

## Dev Notes

### Database Architecture Context

[Source: architecture/database-schema.md]

**Migration Pattern:**

- All migrations live in `apps/api/database/migrations/` (not `apps/api/migrations/`)
- Migration files use timestamp prefix: `YYYYMMDDHHMMSS-description.sql`
- Include both UP (create) and DOWN (rollback) migrations
- Use existing UUID extension: `CREATE EXTENSION IF NOT EXISTS "uuid-ossp"`

**Trigger Pattern:** The project already has a `update_updated_at_column()` function for
automatically updating `updated_at` timestamps:

```sql
CREATE TRIGGER update_tool_registry_updated_at BEFORE UPDATE ON tool_registry
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

[Source: architecture/backend-architecture.md#data-access-layer]

**Repository Pattern:**

- Repositories live in `apps/api/src/repositories/`
- Use Pool from pg library for database connections
- Follow BaseRepository pattern for common CRUD operations

### Technology Stack

[Source: architecture/tech-stack.md]

- **Database:** PostgreSQL 15+ with ACID compliance and JSON support
- **Connection Library:** pg (node-postgres) with connection pooling
- **Migration Tool:** Plain SQL migrations (no ORM)

### Project Structure

[Source: architecture/unified-project-structure.md]

```
apps/api/
├── database/
│   ├── migrations/        # <-- Migration files go here
│   └── seeds/             # Seed data (not used in this story)
├── src/
│   ├── repositories/      # Data access layer
│   ├── services/          # Business logic (Epic 30.2)
│   └── routes/            # API routes (Epic 30.2)
└── tests/
    ├── unit/              # Unit tests
    └── integration/       # Integration tests (including migration tests)

packages/shared/
└── src/
    └── types/             # <-- Shared TypeScript interfaces
```

### Schema Design Considerations

**JSONB Column (`manifest_json`):** The `manifest_json` JSONB column will store the complete tool
manifest including:

- Tool metadata (name, description, version)
- Frontend route configuration
- API endpoint mappings
- Database schema dependencies (for Epic 33 export)
- UI component references

This JSONB approach provides flexibility for tool-specific metadata without requiring schema
changes.

**Indexes Strategy:**

- `tool_id` (unique): Primary lookup field for tool discovery
- `status`: Filter by lifecycle stage (beta, active, deprecated)
- `is_exported`: Separate monolith tools from exported microservices
- `created_at DESC`: Chronological queries (recent tools first)

### Foreign Key Considerations

- `created_by UUID REFERENCES users(id)`: Tracks which admin created the tool registration
- Consider `ON DELETE SET NULL` instead of `ON DELETE CASCADE` to preserve tool history even if user
  deleted

### Database Schema from PRD

```sql
CREATE TABLE tool_registry (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tool_id VARCHAR(100) UNIQUE NOT NULL,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    version VARCHAR(20) NOT NULL,
    icon VARCHAR(50),
    route VARCHAR(255) NOT NULL,
    api_base VARCHAR(255) NOT NULL,
    permissions TEXT[],
    status VARCHAR(20) DEFAULT 'beta',
    is_exported BOOLEAN DEFAULT false,
    exported_at TIMESTAMP,
    service_url VARCHAR(255),
    database_name VARCHAR(100),
    manifest_json JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by UUID REFERENCES users(id)
);

CREATE INDEX idx_tool_registry_tool_id ON tool_registry(tool_id);
CREATE INDEX idx_tool_registry_status ON tool_registry(status);
CREATE INDEX idx_tool_registry_is_exported ON tool_registry(is_exported);
CREATE INDEX idx_tool_registry_created_at ON tool_registry(created_at DESC);
```

### Testing

[Source: architecture/testing-strategy.md#backend-tests]

**Test Organization:**

- Integration tests: `apps/api/tests/integration/`
- Use Jest + Supertest for API testing
- Clean database state: Use `beforeEach` to clear test data

**Migration Test Pattern:**

```typescript
// apps/api/tests/integration/migrations/tool-registry-migration.test.ts
import { pool } from '../../../src/config/database.config';

describe('Tool Registry Migration', () => {
  beforeAll(async () => {
    // Run migration
    await runMigration('YYYYMMDDHHMMSS-create-tool-registry.sql');
  });

  afterAll(async () => {
    // Rollback migration
    await rollbackMigration('YYYYMMDDHHMMSS-create-tool-registry.sql');
    await pool.end();
  });

  it('should create tool_registry table', async () => {
    const result = await pool.query(`
      SELECT table_name FROM information_schema.tables
      WHERE table_name = 'tool_registry'
    `);
    expect(result.rows.length).toBe(1);
  });

  it('should create all indexes', async () => {
    const result = await pool.query(`
      SELECT indexname FROM pg_indexes
      WHERE tablename = 'tool_registry'
    `);
    const indexNames = result.rows.map((r) => r.indexname);
    expect(indexNames).toContain('idx_tool_registry_tool_id');
    expect(indexNames).toContain('idx_tool_registry_status');
    expect(indexNames).toContain('idx_tool_registry_is_exported');
  });
});
```

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-10-23 | 1.0     | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

_To be completed by dev agent_

### Debug Log References

_To be completed by dev agent_

### Completion Notes List

_To be completed by dev agent_

### File List

_To be completed by dev agent_

## QA Results

_To be completed by QA agent_
