# Story 33.2.3: Export History & Re-download

**Epic:** 33.2 Export Package Distribution (18 pts) **Story Points:** 6 **Priority:** Medium
**Status:** Draft **Created:** 2025-10-24

---

## Description

Implement export history UI to display user's past exports with status, timestamps, download counts,
and package details. Enable re-download of existing packages and re-export of expired packages.
Provide filtering, sorting, and pagination for export management.

---

## Acceptance Criteria

### Export History Page

- [ ] Create `ExportHistoryComponent` page in tools feature
- [ ] Display table/list of user's export jobs (most recent first)
- [ ] Show job status with color-coded badges (completed, failed, in_progress, expired)
- [ ] Show tool name, export date, package size, download count
- [ ] Show "Download" button for completed exports with valid packages
- [ ] Show "Re-export" button for expired or failed exports
- [ ] Show "View Details" button to expand job information

### Export List API Endpoint

- [ ] Create `GET /api/tool-registry/export-jobs` endpoint (list user's jobs)
- [ ] Support pagination (limit, offset parameters)
- [ ] Support sorting (created_at, completed_at, download_count)
- [ ] Support filtering (status, tool_type, date_range)
- [ ] Return total count for pagination
- [ ] Include tool metadata in response (tool name, type)
- [ ] Limit to user's jobs (or all if admin)

### Re-download Functionality

- [ ] "Download" button calls existing download endpoint (Story 33.2.1)
- [ ] Button disabled if package expired
- [ ] Show checksum on click (copy to clipboard)
- [ ] Track download from history (increment download_count)
- [ ] Show success toast notification after download
- [ ] Handle download errors gracefully

### Re-export Functionality

- [ ] "Re-export" button creates new export job for same tool
- [ ] Confirmation dialog before starting re-export
- [ ] Opens export progress modal with new job
- [ ] Old expired job remains in history (not deleted)
- [ ] Links old job to new job (optional: `re_export_of_job_id` column)
- [ ] Show warning if tool data changed since original export

### Job Details Expansion

- [ ] Expand row to show full job details
- [ ] Display all export steps with status (completed, failed, skipped)
- [ ] Show error message if export failed
- [ ] Display package checksum for verification
- [ ] Show package expiration date
- [ ] Display download history (count, last downloaded timestamp)
- [ ] Show export duration (completed_at - started_at)

### Filtering and Sorting

- [ ] Filter by status dropdown (All, Completed, Failed, In Progress, Expired)
- [ ] Filter by tool type dropdown (All, Forms, Workflows, Themes)
- [ ] Filter by date range (date pickers for start and end)
- [ ] Sort by created date (ascending/descending)
- [ ] Sort by download count (ascending/descending)
- [ ] Sort by package size (ascending/descending)
- [ ] Save filter/sort preferences in localStorage

### Pagination

- [ ] Display 20 exports per page (configurable)
- [ ] Show pagination controls (Previous, Next, Page Numbers)
- [ ] Display total count (e.g., "Showing 1-20 of 150")
- [ ] Navigate between pages without losing filters
- [ ] URL includes page number (e.g., `/exports?page=2`)
- [ ] Scroll to top when changing pages

### Delete/Archive Exports

- [ ] "Delete" button for old exports (admin only)
- [ ] Confirmation dialog before deletion
- [ ] Soft delete (set deleted_at timestamp, keep record)
- [ ] Hard delete removes package file and database record
- [ ] Show deleted exports in admin view (with restore option)
- [ ] Filter to hide deleted exports for regular users

### Frontend Components

- [ ] `ExportHistoryComponent` - Main history page
- [ ] `ExportHistoryTableComponent` - Table display (presentational)
- [ ] `ExportJobRowComponent` - Single job row with actions
- [ ] `ExportFiltersComponent` - Filter controls
- [ ] `ExportHistoryService` - API integration service

### Testing

- [ ] Unit tests for all components (≥85% coverage)
- [ ] Integration tests for list API endpoint
- [ ] Test filtering and sorting logic
- [ ] Test pagination calculations
- [ ] Test re-download and re-export flows
- [ ] Test responsive design (mobile, tablet, desktop)

---

## Tasks

### 1. Create Export History API Endpoint

**Estimated:** 4 hours **Dependencies:** Story 33.1.3 (Export Job Status Tracking) **Description:**
Implement endpoint to list user's export jobs.

**Subtasks:**

1. Add route `GET /api/tool-registry/export-jobs` to export routes
2. Create `listExportJobs()` method in ExportController
3. Extract query parameters: limit, offset, sort_by, sort_order, status_filter, tool_type_filter
4. Default values: limit=20, offset=0, sort_by=created_at, sort_order=desc
5. Query ExportJobRepository with filters and sorting
6. Filter by userId (unless user is admin)
7. Include tool metadata (JOIN with tool_registry table)
8. Return paginated response with total count
9. Add authentication middleware
10. Add Swagger documentation

### 2. Implement ExportJobRepository List Method

**Estimated:** 3 hours **Dependencies:** Task 1 **Description:** Add repository method for paginated
job listing.

**Subtasks:**

1. Add `list(userId, options)` method to ExportJobRepository
2. Build SQL query with WHERE clauses for filters
3. Support status filter (IN clause for multiple statuses)
4. Support tool_type filter (JOIN with tool_registry)
5. Support date_range filter (BETWEEN clause)
6. Add ORDER BY clause for sorting
7. Add LIMIT and OFFSET for pagination
8. Return { jobs, total } object
9. Add unit tests for repository method
10. Test with various filter combinations

### 3. Create ExportHistoryComponent (Container)

**Estimated:** 3 hours **Dependencies:** Task 1 **Description:** Main component for export history
page.

**Subtasks:**

1. Create `apps/web/src/app/features/tools/pages/export-history/export-history.component.ts`
2. Create matching .html and .scss files
3. Inject ExportHistoryService
4. Initialize component state signals (jobs, loading, error, totalCount, currentPage)
5. Call ExportHistoryService.listExportJobs() on init
6. Handle pagination (nextPage, previousPage methods)
7. Handle filtering (onFilterChange method)
8. Handle sorting (onSortChange method)
9. Add route in tools.routes.ts (path: 'exports')
10. Add navigation link in tools layout

### 4. Create ExportHistoryService

**Estimated:** 2 hours **Dependencies:** Task 1 **Description:** Service to interact with export
history API.

**Subtasks:**

1. Create `apps/web/src/app/features/tools/services/export-history.service.ts`
2. Inject HttpClient
3. Implement `listExportJobs(options)` method
4. Return Observable of paginated response
5. Build query parameters from options
6. Handle API errors (catch and transform)
7. Add caching for recent queries (optional: 30 second cache)
8. Implement `deleteExportJob(jobId)` method
9. Add unit tests for service
10. Export service from feature module

### 5. Create ExportHistoryTableComponent (Presentational)

**Estimated:** 4 hours **Dependencies:** Task 3 **Description:** Table component to display export
jobs.

**Subtasks:**

1. Create
   `apps/web/src/app/features/tools/components/export-history-table/export-history-table.component.ts`
2. Accept @Input() jobs signal
3. Accept @Output() onDownload, onReExport, onDelete event emitters
4. Create table with columns: Tool Name, Status, Created, Size, Downloads, Actions
5. Use PrimeNG Table component (p-table)
6. Add status badge with colors (green=completed, red=failed, blue=in_progress, gray=expired)
7. Format dates with DatePipe (relative: "2 days ago")
8. Format file sizes (bytes → MB/GB)
9. Add action buttons (Download, Re-export, Delete)
10. Add hover effects and responsive design

### 6. Implement ExportJobRowComponent

**Estimated:** 3 hours **Dependencies:** Task 5 **Description:** Single row component with
expandable details.

**Subtasks:**

1. Create `apps/web/src/app/features/tools/components/export-job-row/export-job-row.component.ts`
2. Accept @Input() job signal
3. Add expand/collapse toggle button
4. Show summary in collapsed state (tool name, status, date)
5. Show full details in expanded state (steps, checksum, error message)
6. Use PrimeNG Accordion or custom expansion logic
7. Add animations for smooth expand/collapse
8. Display checksum with "Copy" button
9. Show download history (count, last downloaded)
10. Add unit tests for component

### 7. Create ExportFiltersComponent

**Estimated:** 3 hours **Dependencies:** Task 3 **Description:** Filter controls for export history.

**Subtasks:**

1. Create `apps/web/src/app/features/tools/components/export-filters/export-filters.component.ts`
2. Accept @Output() onFilterChange event emitter
3. Add status filter dropdown (PrimeNG Dropdown)
4. Add tool type filter dropdown
5. Add date range filter (PrimeNG Calendar with range mode)
6. Add sort by dropdown (Created Date, Download Count, Package Size)
7. Add sort order toggle (Ascending/Descending)
8. Emit filter changes on input change (debounced 300ms)
9. Add "Clear Filters" button
10. Save filter state to localStorage

### 8. Implement Pagination Controls

**Estimated:** 2 hours **Dependencies:** Task 3 **Description:** Pagination UI for export history.

**Subtasks:**

1. Use PrimeNG Paginator component
2. Display current page, total pages, total count
3. Show "Showing X-Y of Z" text
4. Add Previous and Next buttons
5. Add page number buttons (show 5 pages at a time)
6. Emit pageChange event on navigation
7. Disable Previous on first page
8. Disable Next on last page
9. Update URL with page parameter (ActivatedRoute)
10. Scroll to top when page changes

### 9. Implement Re-download Functionality

**Estimated:** 2 hours **Dependencies:** Task 5, Story 33.2.1 **Description:** Download button
integration.

**Subtasks:**

1. Add "Download" button to ExportHistoryTableComponent
2. Button enabled only if status=completed and package exists
3. On click, call ExportHistoryService.downloadPackage(jobId)
4. Use window.open() or fetch with blob for download
5. Show success toast notification after download
6. Update download_count in UI (increment locally)
7. Show error toast if download fails
8. Add loading spinner during download
9. Test download with large files
10. Add unit tests for download logic

### 10. Implement Re-export Functionality

**Estimated:** 3 hours **Dependencies:** Task 5 **Description:** Re-export button to create new
export for same tool.

**Subtasks:**

1. Add "Re-export" button to ExportHistoryTableComponent
2. Button visible for expired, failed, or cancelled exports
3. On click, show confirmation dialog (PrimeNG ConfirmDialog)
4. Confirmation message: "Re-export {toolName}? This will create a new export job."
5. On confirm, call ExportJobService.startExport(toolId)
6. Open ExportProgressModalComponent with new jobId
7. Optionally link new job to old job (re_export_of_job_id)
8. Show warning if tool data changed since original export
9. Add unit tests for re-export logic
10. Test re-export for various job statuses

### 11. Implement Export Deletion (Admin Only)

**Estimated:** 2 hours **Dependencies:** Task 5 **Description:** Delete button for admins to remove
old exports.

**Subtasks:**

1. Add "Delete" button to ExportHistoryTableComponent
2. Button visible only if user is admin
3. On click, show confirmation dialog with warning
4. On confirm, call ExportHistoryService.deleteExportJob(jobId)
5. API endpoint: DELETE /export-jobs/:jobId (soft delete)
6. Update job record: set deleted_at timestamp
7. Remove job from UI list after deletion
8. Show success toast notification
9. Add restore functionality for soft-deleted jobs (optional)
10. Test deletion with various job statuses

### 12. Add Responsive Design

**Estimated:** 2 hours **Dependencies:** Task 5 **Description:** Mobile-friendly export history UI.

**Subtasks:**

1. Use CSS Grid or Flexbox for responsive layout
2. Desktop: Table with all columns
3. Tablet: Hide download count and size columns
4. Mobile: Switch to card layout (no table)
5. Add hamburger menu for actions on mobile
6. Test on various screen sizes (320px, 768px, 1024px, 1920px)
7. Use PrimeNG responsive utilities
8. Add media queries in SCSS
9. Test with Chrome DevTools device emulation
10. Ensure touch targets are ≥44px (accessibility)

### 13. Integration Tests for List Endpoint

**Estimated:** 3 hours **Dependencies:** Task 1 **Description:** Test export history API endpoint.

**Subtasks:**

1. Create `apps/api/tests/integration/export-history.test.ts`
2. Setup test database with multiple export jobs
3. Test list endpoint returns user's jobs (200 OK)
4. Test pagination (limit=10, offset=10)
5. Test sorting (sort_by=created_at, sort_order=asc)
6. Test filtering (status_filter=completed)
7. Test filtering (tool_type_filter=forms)
8. Test date_range filter (start_date, end_date)
9. Test admin can see all jobs, user sees only own
10. Test total count matches filtered results

### 14. Frontend Unit Tests

**Estimated:** 4 hours **Dependencies:** Tasks 3-8 **Description:** Comprehensive tests for all
components.

**Subtasks:**

1. Test ExportHistoryComponent loads jobs on init
2. Test pagination works (nextPage, previousPage)
3. Test filtering updates job list
4. Test sorting updates job list
5. Test download button calls service method
6. Test re-export button opens modal
7. Test delete button shows confirmation dialog
8. Test expandable row shows job details
9. Test filters persist in localStorage
10. Achieve ≥85% test coverage for all components

### 15. E2E Test: Complete History Workflow

**Estimated:** 3 hours **Dependencies:** All previous tasks **Description:** Test full user journey
through export history.

**Subtasks:**

1. Create `tests/e2e/export-history.spec.ts`
2. Login as user and navigate to export history page
3. Verify page displays list of exports
4. Click filter dropdown and select "Completed"
5. Verify only completed exports shown
6. Click sort dropdown and select "Download Count"
7. Verify exports sorted correctly
8. Click "Download" button for first export
9. Verify file downloads successfully
10. Click "Re-export" button for expired export and verify modal opens

---

## Dev Notes

### Export History API Response

```json
// GET /api/tool-registry/export-jobs?limit=20&offset=0&sort_by=created_at&sort_order=desc

{
  "jobs": [
    {
      "jobId": "job-abc-123",
      "toolId": "tool-forms-456",
      "toolName": "Customer Registration Form",
      "toolType": "forms",
      "status": "completed",
      "stepsCompleted": 8,
      "stepsTotal": 8,
      "progressPercentage": 100,
      "packagePath": "/tmp/exports/job-abc-123/export.tar.gz",
      "packageSizeBytes": 12582912,
      "packageSizeMB": "12.0 MB",
      "packageChecksum": "a3f5b1c2...",
      "downloadCount": 5,
      "lastDownloadedAt": "2025-10-24T15:00:00Z",
      "createdAt": "2025-10-24T10:00:00Z",
      "startedAt": "2025-10-24T10:00:05Z",
      "completedAt": "2025-10-24T10:02:30Z",
      "packageExpiresAt": "2025-11-23T10:02:30Z"
    },
    {
      "jobId": "job-def-789",
      "toolId": "tool-workflows-101",
      "toolName": "Approval Workflow",
      "toolType": "workflows",
      "status": "failed",
      "stepsCompleted": 3,
      "stepsTotal": 7,
      "progressPercentage": 42,
      "errorMessage": "Failed to generate Docker configuration",
      "createdAt": "2025-10-23T14:00:00Z",
      "startedAt": "2025-10-23T14:00:05Z",
      "completedAt": null
    }
  ],
  "total": 45,
  "limit": 20,
  "offset": 0,
  "page": 1,
  "totalPages": 3
}
```

### ExportHistoryComponent Implementation

```typescript
// apps/web/src/app/features/tools/pages/export-history/export-history.component.ts
import { Component, OnInit, signal, computed } from '@angular/core';
import { ExportHistoryService } from '../../services/export-history.service';
import { ExportJob } from '@nodeangularfullstack/shared';

@Component({
  selector: 'app-export-history',
  standalone: true,
  templateUrl: './export-history.component.html',
  styleUrls: ['./export-history.component.scss'],
  imports: [
    /* PrimeNG imports */
  ],
})
export class ExportHistoryComponent implements OnInit {
  jobs = signal<ExportJob[]>([]);
  loading = signal<boolean>(false);
  error = signal<string | null>(null);
  totalCount = signal<number>(0);
  currentPage = signal<number>(1);
  pageSize = signal<number>(20);

  // Computed
  totalPages = computed(() => Math.ceil(this.totalCount() / this.pageSize()));

  // Filters
  statusFilter = signal<string | null>(null);
  toolTypeFilter = signal<string | null>(null);
  sortBy = signal<string>('created_at');
  sortOrder = signal<'asc' | 'desc'>('desc');

  constructor(private exportHistoryService: ExportHistoryService) {}

  ngOnInit(): void {
    this.loadExportHistory();
  }

  loadExportHistory(): void {
    this.loading.set(true);
    this.error.set(null);

    const options = {
      limit: this.pageSize(),
      offset: (this.currentPage() - 1) * this.pageSize(),
      sortBy: this.sortBy(),
      sortOrder: this.sortOrder(),
      statusFilter: this.statusFilter(),
      toolTypeFilter: this.toolTypeFilter(),
    };

    this.exportHistoryService.listExportJobs(options).subscribe({
      next: (response) => {
        this.jobs.set(response.jobs);
        this.totalCount.set(response.total);
        this.loading.set(false);
      },
      error: (err) => {
        this.error.set(err.message);
        this.loading.set(false);
      },
    });
  }

  onFilterChange(filters: any): void {
    this.statusFilter.set(filters.status);
    this.toolTypeFilter.set(filters.toolType);
    this.currentPage.set(1); // Reset to first page
    this.loadExportHistory();
  }

  onSortChange(sortOptions: any): void {
    this.sortBy.set(sortOptions.field);
    this.sortOrder.set(sortOptions.order);
    this.loadExportHistory();
  }

  onPageChange(page: number): void {
    this.currentPage.set(page);
    this.loadExportHistory();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  onDownload(jobId: string): void {
    // Trigger download via service
    this.exportHistoryService.downloadPackage(jobId).subscribe({
      next: () => {
        this.messageService.add({
          severity: 'success',
          summary: 'Download Started',
          detail: 'Export package download started',
        });
      },
      error: (err) => {
        this.messageService.add({
          severity: 'error',
          summary: 'Download Failed',
          detail: err.message,
        });
      },
    });
  }

  onReExport(job: ExportJob): void {
    // Open export progress modal with new job
    this.exportJobService.startExport(job.toolId).subscribe({
      next: (newJob) => {
        this.openExportProgressModal(newJob.jobId);
      },
      error: (err) => {
        this.messageService.add({
          severity: 'error',
          summary: 'Re-export Failed',
          detail: err.message,
        });
      },
    });
  }

  onDelete(jobId: string): void {
    this.confirmationService.confirm({
      message: 'Are you sure you want to delete this export? This action cannot be undone.',
      header: 'Delete Export',
      icon: 'pi pi-exclamation-triangle',
      accept: () => {
        this.exportHistoryService.deleteExportJob(jobId).subscribe({
          next: () => {
            // Remove from list
            this.jobs.update((jobs) => jobs.filter((j) => j.jobId !== jobId));
            this.messageService.add({
              severity: 'success',
              summary: 'Export Deleted',
              detail: 'Export has been deleted successfully',
            });
          },
          error: (err) => {
            this.messageService.add({
              severity: 'error',
              summary: 'Delete Failed',
              detail: err.message,
            });
          },
        });
      },
    });
  }
}
```

**Why This Implementation:**

- **Signals:** Reactive state management with Angular 20+ signals
- **Computed:** Derived state (totalPages) updates automatically
- **Pagination:** Offset-based pagination with page size control
- **Filtering:** Client stores filter state, server applies filters
- **Error Handling:** Displays user-friendly error messages

### Export History Table Template

```html
<!-- apps/web/src/app/features/tools/pages/export-history/export-history.component.html -->
<div class="export-history-container">
  <h1>Export History</h1>

  <app-export-filters
    (filterChange)="onFilterChange($event)"
    (sortChange)="onSortChange($event)"
  ></app-export-filters>

  @if (loading()) {
  <p-progressSpinner></p-progressSpinner>
  } @if (error()) {
  <p-message severity="error" [text]="error()"></p-message>
  } @if (!loading() && !error() && jobs().length > 0) {
  <app-export-history-table
    [jobs]="jobs()"
    (download)="onDownload($event)"
    (reExport)="onReExport($event)"
    (delete)="onDelete($event)"
  ></app-export-history-table>

  <p-paginator
    [rows]="pageSize()"
    [totalRecords]="totalCount()"
    [first]="(currentPage() - 1) * pageSize()"
    (onPageChange)="onPageChange($event.page + 1)"
  ></p-paginator>
  } @if (!loading() && !error() && jobs().length === 0) {
  <div class="empty-state">
    <i class="pi pi-inbox" style="font-size: 3rem; color: #ccc;"></i>
    <p>No exports found</p>
    <p-button label="Create New Export" (click)="navigateToTools()"></p-button>
  </div>
  }
</div>
```

---

## Testing

### Integration Test Example

```typescript
// apps/api/tests/integration/export-history.test.ts
import request from 'supertest';
import app from '../../src/app';

describe('Export History API', () => {
  let adminToken: string;
  let userToken: string;

  beforeAll(async () => {
    adminToken = await getTestJWT('admin@example.com', 'Admin123!@#');
    userToken = await getTestJWT('user@example.com', 'User123!@#');

    // Create test export jobs
    await createTestExportJobs();
  });

  it('should list user exports with pagination', async () => {
    const response = await request(app)
      .get('/api/tool-registry/export-jobs?limit=10&offset=0')
      .set('Authorization', `Bearer ${userToken}`)
      .expect(200);

    expect(response.body).toHaveProperty('jobs');
    expect(response.body).toHaveProperty('total');
    expect(response.body.jobs).toBeInstanceOf(Array);
    expect(response.body.jobs.length).toBeLessThanOrEqual(10);
  });

  it('should filter exports by status', async () => {
    const response = await request(app)
      .get('/api/tool-registry/export-jobs?status_filter=completed')
      .set('Authorization', `Bearer ${userToken}`)
      .expect(200);

    expect(response.body.jobs.every((job: any) => job.status === 'completed')).toBe(true);
  });

  it('should sort exports by created_at descending', async () => {
    const response = await request(app)
      .get('/api/tool-registry/export-jobs?sort_by=created_at&sort_order=desc')
      .set('Authorization', `Bearer ${userToken}`)
      .expect(200);

    const jobs = response.body.jobs;
    for (let i = 0; i < jobs.length - 1; i++) {
      const current = new Date(jobs[i].createdAt);
      const next = new Date(jobs[i + 1].createdAt);
      expect(current.getTime()).toBeGreaterThanOrEqual(next.getTime());
    }
  });
});
```

---

## Dependencies

### Blocked By:

- Story 33.2.1: Export Package Download (download endpoint)
- Story 33.1.3: Export Job Status Tracking (job status API)

### Blocks:

- None (final story of Epic 33.2)

### Related:

- Story 32.2.4: Export Progress Modal (modal integration for re-export)

---

## QA Gate

**Gate File:** `docs/qa/gates/33.2.3-export-history-redownload.yml`

### Quality Criteria (Weighted):

| Criterion              | Weight | Target                   | Validation Method  |
| ---------------------- | ------ | ------------------------ | ------------------ |
| Frontend Test Coverage | 30%    | ≥85% components/services | Jest coverage      |
| API Integration Tests  | 25%    | All endpoints tested     | Manual testing     |
| Responsive Design      | 20%    | Mobile/tablet/desktop    | Visual testing     |
| Filtering/Sorting      | 15%    | All combinations work    | Functional testing |
| Documentation          | 10%    | User guide complete      | Code review        |

**Minimum Score:** 90/100 to pass gate

---

## Notes

### ★ Insight ─────────────────────────────────────

**Why Pagination:**

- Users may have hundreds of exports over time
- Loading all exports at once is slow and memory-intensive
- Offset-based pagination is simple and sufficient (not real-time)

**Re-export vs Re-download:**

- **Re-download:** Get existing package (fast, no computation)
- **Re-export:** Create new package (slow, fresh data)
- **Use Re-export:** When package expired or tool data updated

**Filter State Management:**

- Filters stored in component signals (reactive)
- Filters persisted to localStorage (survives page refresh)
- Filters included in URL (shareable, bookmarkable)

─────────────────────────────────────────────────

**Story State:** Draft **Last Updated:** 2025-10-24 **Next Review:** After implementation completion
