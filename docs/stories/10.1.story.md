# Story 10.1: Form Builder Shared Types and Database Schema

## Status

Draft

## Story

**As a** backend developer, **I want** to define shared TypeScript types and create database tables
for forms, form schemas, and submissions, **so that** both frontend and backend have type-safe
interfaces and persistent storage for form data.

## Acceptance Criteria

1. **AC1**: Shared types package includes `FormField`, `FormSchema`, `FormMetadata`,
   `FormSubmission` interfaces in `/packages/shared/src/types/forms.types.ts`
2. **AC2**: Database migration creates `forms` table with columns: id (UUID), user_id (FK),
   tenant_id (FK nullable), title (varchar), description (text), status (enum: draft/published),
   created_at, updated_at
3. **AC3**: Database migration creates `form_schemas` table with columns: id (UUID), form_id (FK),
   schema_version (int), schema_json (JSONB), is_published (boolean), render_token (varchar unique
   nullable), expires_at (timestamp nullable), created_at, updated_at
4. **AC4**: Database migration creates `form_submissions` table with columns: id (UUID),
   form_schema_id (FK), values_json (JSONB), submitted_at (timestamp), submitter_ip (inet), user_id
   (FK nullable), metadata (JSONB nullable)
5. **AC5**: Migration includes proper indexes on foreign keys, render_token, and expires_at columns
6. **AC6**: Migration includes `up()` and `down()` scripts for rollback capability
7. **AC7**: Shared types built successfully with `npm run build:shared`
8. **AC8**: TypeScript strict mode passes for all shared types (no `any` types)

## Tasks / Subtasks

- [ ] Create shared TypeScript types in packages/shared (AC: 1, 8)
  - [ ] Create `/packages/shared/src/types/forms.types.ts` file
  - [ ] Define `FormFieldType` enum (text, email, number, select, textarea, file, checkbox, radio,
        date, datetime, toggle, divider)
  - [ ] Define `FormField` interface with properties: id, type, label, fieldName, placeholder,
        helpText, required, validation rules, default value, conditional visibility
  - [ ] Define `FormSchema` interface with properties: id, formId, version, fields array, settings
        (layout, spacing, submission config)
  - [ ] Define `FormMetadata` interface with properties: id, userId, tenantId, title, description,
        status (draft/published)
  - [ ] Define `FormSubmission` interface with properties: id, formSchemaId, values (key-value
        pairs), submittedAt, submitterIp, userId, metadata
  - [ ] Add JSDoc comments to all interfaces and important properties
  - [ ] Export all types from `/packages/shared/src/types/index.ts`

- [ ] Create database migration for forms tables (AC: 2, 3, 4, 5, 6)
  - [ ] Create migration file in `/apps/api/migrations/` following naming convention
        (timestamp_create_forms_tables.ts)
  - [ ] Implement `up()` function to create `forms` table with all required columns and constraints
  - [ ] Add foreign key constraint for user_id referencing users(id) with ON DELETE CASCADE
  - [ ] Add conditional foreign key for tenant_id (only when multi-tenancy enabled)
  - [ ] Add status ENUM type ('draft', 'published') or use CHECK constraint
  - [ ] Implement `up()` function to create `form_schemas` table with JSONB schema_json column
  - [ ] Add unique constraint on render_token where not null
  - [ ] Add foreign key for form_id referencing forms(id) with ON DELETE CASCADE
  - [ ] Implement `up()` function to create `form_submissions` table with JSONB values_json column
  - [ ] Add foreign key for form_schema_id referencing form_schemas(id) with ON DELETE CASCADE
  - [ ] Add optional foreign key for user_id (nullable, for authenticated submissions)
  - [ ] Create indexes: idx_forms_user_id, idx_forms_tenant_id, idx_form_schemas_form_id,
        idx_form_schemas_render_token, idx_form_schemas_expires_at,
        idx_form_submissions_form_schema_id
  - [ ] Add updated_at triggers for forms and form_schemas tables (reuse existing
        update_updated_at_column function)
  - [ ] Implement `down()` function to drop all tables and indexes in reverse order

- [ ] Build and validate shared types (AC: 7, 8)
  - [ ] Run `npm run build:shared` and verify successful build
  - [ ] Run `npm run typecheck` on shared package to ensure strict mode compliance
  - [ ] Verify no `any` types are used in forms.types.ts
  - [ ] Test import in both apps/api and apps/web to verify no circular dependencies

- [ ] Run and test migration (IV: 1, 2, 3, 4, 5)
  - [ ] Run `npm --workspace=apps/api run db:migrate` to apply migration
  - [ ] Verify all three tables created successfully with correct schema
  - [ ] Verify existing tables (users, tenants, tools) remain unchanged
  - [ ] Test tenant_id constraint is only applied when ENABLE_MULTI_TENANCY=true
  - [ ] Test rollback with migration down() script
  - [ ] Re-apply migration and verify idempotency

## Dev Notes

### Previous Story Insights

No previous Form Builder stories exist. This is the foundational story for the Form Builder epic.

### Data Models

**Form Entity** [Source: docs/prd-form-builder/epic-10#Story-1.1]

- Primary table for form metadata
- Links to user (creator) and optional tenant
- Status tracking: draft vs published
- Timestamps for audit trail

**Form Schema Entity** [Source: docs/prd-form-builder/epic-10#Story-1.1]

- Versioned schema storage using JSONB
- Supports schema evolution and rollback
- Render token for public access (JWT-based)
- Expiration handling for temporary forms

**Form Submission Entity** [Source: docs/prd-form-builder/epic-10#Story-1.1]

- Stores submitted form data as JSONB
- Tracks submitter (IP and optional user_id)
- Metadata field for extensibility

### API Specifications

No API endpoints in this story. Database schema and types only.

### Component Specifications

No frontend components in this story. Shared types will be consumed by both backend and frontend in
subsequent stories.

### File Locations

**Shared Types:** [Source: docs/architecture/unified-project-structure.md#packages]

- Create: `/packages/shared/src/types/forms.types.ts`
- Export from: `/packages/shared/src/types/index.ts`
- Build target: CommonJS for backend, ES modules for frontend

**Database Migration:** [Source: docs/architecture/unified-project-structure.md#apps/api]

- Create: `/apps/api/migrations/{timestamp}_create_forms_tables.ts`
- Migration naming follows existing pattern (e.g., `20250104120000_create_forms_tables.ts`)
- Must include both up() and down() functions

### Testing Requirements

**Shared Types Testing:** [Source: docs/architecture/testing-strategy.md#Backend-Tests]

- TypeScript strict mode validation (no runtime tests needed for types)
- Import verification from both apps/api and apps/web
- Build success with `npm run build:shared`

**Migration Testing:** [Source: docs/architecture/testing-strategy.md#Backend-Tests]

- Manual migration test: run up() and verify schema
- Rollback test: run down() and verify clean removal
- Integration test: verify foreign key constraints work correctly
- Multi-tenancy test: verify tenant_id constraint behavior

### Technical Constraints

**Type Safety:** [Source: docs/architecture/coding-standards.md#Critical-Fullstack-Rules]

- NO `any` types allowed - use proper TypeScript strict mode
- All shared types MUST have JSDoc comments
- Interfaces should be exported from /packages/shared/src/types/index.ts

**Database Standards:** [Source: docs/architecture/database-schema.md]

- Use uuid-ossp extension for UUID generation
- Follow snake_case naming for database columns
- Use camelCase in TypeScript interfaces (transformation happens in repository layer)
- Include created_at and updated_at timestamps with automatic triggers
- Foreign keys must have ON DELETE CASCADE or ON DELETE SET NULL as appropriate

**Migration Standards:** [Source: docs/architecture/coding-standards.md]

- Migration files named with timestamp prefix: `{timestamp}_migration_name.ts`
- Must include both up() and down() functions for rollback
- Use parameterized queries to prevent SQL injection
- Test migration rollback before committing

**Multi-Tenancy:** [Source: docs/architecture/backend-architecture.md]

- tenant_id foreign key constraint only applied when ENABLE_MULTI_TENANCY=true
- Forms table includes tenant_id (nullable) for multi-tenant isolation
- Indexes should include tenant_id for query performance

### Testing

**Test File Location:** [Source: docs/architecture/testing-strategy.md#Backend-Tests]

- No unit tests required for type definitions
- Migration testing done manually via `npm --workspace=apps/api run db:migrate`
- Integration tests will be added in Story 10.2 for repositories

**Testing Standards:** [Source: docs/architecture/testing-strategy.md]

- TypeScript compilation is the test for type definitions
- Migration success/failure is verified via PostgreSQL schema inspection
- Foreign key constraints tested by attempting invalid inserts
- Index creation verified with PostgreSQL \d commands

**Testing Frameworks:** [Source: docs/architecture/tech-stack.md]

- TypeScript 5.3+ for type checking
- PostgreSQL 15+ for database
- Migration framework: Custom TypeScript-based migrations

## Change Log

| Date       | Version | Description            | Author             |
| ---------- | ------- | ---------------------- | ------------------ |
| 2025-01-04 | 1.0     | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used

_To be filled by Dev Agent_

### Debug Log References

_To be filled by Dev Agent_

### Completion Notes List

_To be filled by Dev Agent_

### File List

_To be filled by Dev Agent_

## QA Results

_To be filled by QA Agent_
